# 知识星图分级优化方案 (Tiered Galaxy Optimization)

根据设备性能差异，我们将星图体验划分为三个等级：**Lite (基础版)**、**Standard (标准版)** 和 **Ultra (极致版)**。

| 优化维度 | Lite (基础版) | Standard (标准版) | Ultra (极致版) |
| :--- | :--- | :--- | :--- |
| **判定标准** | RAM < 4GB, CPU < 6核, 低端 GPU | RAM 4-8GB, 中端芯片 | RAM > 8GB, 旗舰芯片, 120Hz |
| **渲染引擎** | **Shader**: 关闭 (使用纯色/图片替代)<br>**Glow**: 关闭<br>**Blur**: 关闭<br>**FPS目标**: 30 | **Shader**: 开启 (简化版)<br>**Glow**: 仅高亮节点开启<br>**Blur**: 仅静态层开启<br>**FPS目标**: 60 | **Shader**: 全特效 (流体/噪点)<br>**Glow**: 全局动态辉光<br>**Blur**: 全局高斯模糊<br>**FPS目标**: 60/120 |
| **LOD 策略** | **全局统一**：<br>**L0 (<0.2)**: 仅质心光晕 + 星域标签<br>**L1 (0.2-0.4)**: 大节点 + 关键标签<br>**L2 (0.4-0.6)**: 全节点 + 父子连线<br>**L3 (0.6-0.8)**: 关联连线 + Glow<br>**L4 (>0.8)**: 全文本 + 动态粒子 | **全局统一**：<br>**L0 (<0.2)**: 仅质心光晕 + 星域标签<br>**L1 (0.2-0.4)**: 大节点 + 关键标签<br>**L2 (0.4-0.6)**: 全节点 + 父子连线<br>**L3 (0.6-0.8)**: 关联连线 + Glow<br>**L4 (>0.8)**: 全文本 + 动态粒子 | **全局统一**：<br>**L0 (<0.2)**: 仅质心光晕 + 星域标签<br>**L1 (0.2-0.4)**: 大节点 + 关键标签<br>**L2 (0.4-0.6)**: 全节点 + 父子连线<br>**L3 (0.6-0.8)**: 关联连线 + Glow<br>**L4 (>0.8)**: 全文本 + 动态粒子 |
| **动画效果** | **Bloom**: 无 (直接显示)<br>**粒子系统**: 关闭<br>**过渡动画**: 缩短 (150ms) | **Bloom**: 简单透明度渐变<br>**粒子系统**: 开启 (上限 20)<br>**过渡动画**: 标准 (300ms) | **Bloom**: 复杂 (缩放+发光+拖尾)<br>**粒子系统**: 开启 (上限 100+)<br>**过渡动画**: 物理弹簧效果 |
| **布局引擎** | **力导向**: 仅初始化计算 1 次<br>**碰撞检测**: 仅根节点<br>**更新频率**: 停止时更新 | **力导向**: 迭代 50 次 (Isolate)<br>**碰撞检测**: 标准四叉树<br>**更新频率**: 节流实时更新 | **力导向**: 持续迭代 (Isolate)<br>**碰撞检测**: 高精度四叉树 (带位移阈值)<br>**更新频率**: 实时平滑插值 |
| **连线渲染** | **策略**: 仅显示 Parent-Child<br>**样式**: 实线 (无渐变)<br>**数量**: 限制视口内 < 50 | **策略**: Parent-Child + 选中关联<br>**样式**: 线性渐变<br>**数量**: 动态裁剪 | **策略**: 全量关联 (智能透明度)<br>**样式**: 流光特效 (Shader)<br>**数量**: 完整显示 |
| **背景装饰** | **星空**: 静态图片<br>**视差**: 关闭<br>**星云**: 无 | **星空**: 动态 Canvas 绘制<br>**视差**: 2 层视差<br>**星云**: 静态贴图 | **星空**: 3D 粒子星空<br>**视差**: 3-4 层多维视差<br>**星云**: 动态 Shader 生成 |

## 实施细节

### 1. 性能检测与分级 (Performance Detection)

在 `GalaxyProvider` 初始化时，通过启发式规则获取当前设备评分，自动设置默认 Tier。同时提供设置选项允许用户手动覆盖。

```dart
enum GalaxyPerformanceTier { lite, standard, ultra }

class GalaxyConfig {
  final GalaxyPerformanceTier tier;
  // ... 具体配置项 getter
}
```

**自适应降级/升级 (Hysteresis):**
系统监控**过去 1 秒**的平均 FPS，执行顺序固定为 **DPR 降采样 → 特效降级 → Tier 降级**，升级顺序反向执行：
- **降级**: 
  - 触发：FPS < 80 (120Hz设备) 或 < 35 (60Hz设备) 或 < 20 (30Hz设备)。
  - 冷却：10s。
- **升级**: 
  - 触发：FPS > 115 (120Hz设备) 或 > 58 (60Hz设备) 持续 **5秒**。
  - 冷却：20s。

### 2. 渲染层优化 (`StarMapPainter`)

- **Lite**: 
  - 跳过 `MaskFilter.blur` 和 `ui.Gradient`，使用纯色 `Paint`。
  - 对于背景，直接绘制单一图片 (`drawImage`) 而非多层 Canvas 操作。
  - 碰撞检测仅针对一级根节点，完全忽略子节点重叠。
- **Standard/Ultra**: 
  - 复用现有的 Shader 和 Gradient 逻辑。
  - Ultra 模式下，对背景层启用 `RepaintBoundary` 并限制 `toImage` 的 DPR 不超过 2.0。

### 3. 布局计算 (`GalaxyLayoutEngine`)

- **Lite**: `optimizeLayoutAsync` 仅执行一次初始布局。当用户拖拽节点时，不触发物理模拟，仅更新该节点位置。
- **Standard**: 保持当前 `Isolate` 异步计算逻辑，四叉树每 3-5 帧重建一次。
- **Ultra**: 允许更长时间的迭代，或者在交互过程中持续微调位置。**四叉树重建必须遵守位移阈值**（如 2.0px），防止每帧强制重建导致抖动。

### 4. 动画控制

- **Lite**: 将 `_animationDuration` 设为 0 或极短，移除 `Timer.periodic` 驱动的粒子系统。
- **Ultra**: 使用 `SpringSimulation` 替代简单的 `Curves.easeOutBack`，获得更自然的物理手感。粒子系统使用独立的对象池 (`ParticlePool`) 以减少 GC。
