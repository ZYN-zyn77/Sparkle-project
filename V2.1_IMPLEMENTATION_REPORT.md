# Sparkle (星火) - v2.1 Implementation Report

> **Generated Date**: 2025-12-15
> **Project Version**: v2.1 (Hardened MVP)
> **Status**: Implementation Completed

## 1. Project Overview

**Sparkle** is an AI-powered intelligent learning assistant designed for university students. Its core philosophy is "AI Time Director," helping students efficiently manage fragmented learning time through features like task decomposition, sprint planning, error analysis, and emotional companionship.

### Core Technology Stack
- **Frontend**: Flutter 3.x (Riverpod, Dio, GoRouter)
- **Backend**: FastAPI (Python 3.11+, SQLAlchemy, AsyncPG)
- **Database**: PostgreSQL
- **AI/LLM**: Integration with OpenAI/Qwen models via streaming APIs.

---

## 2. v2.1 Implementation Details

This version focuses on system reliability, idempotency, data standardization, and enhanced user experience (Optimistic UI). Below is a detailed breakdown of the implemented features.

### 2.1 Backend Implementation

#### A. Database Schema & Models
New models were introduced to support v2.1 features:
- **Job (`app/models/job.py`)**: Stores asynchronous background tasks. Added `timeout_at` to detect hung tasks.
- **Subject (`app/models/subject.py`)**: Standardized dictionary for school subjects (e.g., "Data Structures", "Calculus") to prevent data pollution in error records.
- **IdempotencyKey (`app/models/idempotency_key.py`)**: Stores keys and cached responses to prevent duplicate request processing.
- **Updates**:
  - `ChatMessage`: Added `message_id` (unique client-gen ID) and `parse_degraded` (flag for partial AI failures).
  - `ErrorRecord`: Added `subject_id` foreign key linking to the new Subject table.

#### B. Core Infrastructure
- **Idempotency Middleware (`app/api/middleware.py`)**:
  - Intercepts `POST`, `PUT`, `PATCH` requests on critical paths.
  - Checks `X-Idempotency-Key` header.
  - Returns cached responses for duplicate keys using `IdempotencyStore`.
  - Implemented an in-memory store (`app/core/idempotency.py`) for MVP (extensible to Redis).
- **Startup Recovery (`app/main.py`)**:
  - Implemented `lifespan` handler.
  - On startup, scans for "Running" jobs and resets them to "Failed" to prevent them from being stuck forever (`JobService.startup_recovery`).
  - Pre-loads standard subjects into memory cache.

#### C. Business Services
- **Job Service (`app/services/job_service.py`)**:
  - Handles async job creation.
  - Implemented timeout detection logic during status checks.
- **Subject Service (`app/services/subject_service.py`)**:
  - Provides fuzzy matching/normalization for subject names (e.g., mapping "DS" -> "Data Structures & Algorithms").
- **LLM Parser (`app/services/llm/parser.py`)**:
  - Implemented **Pydantic Tolerant Mode**: Automatically fixes type errors in AI JSON output (e.g., converts "15" string to integer).
  - Implemented **Explicit Degradation**: If JSON parsing fails completely, returns the raw text with a `parse_degraded` flag instead of crashing or hallucinating success.
- **Chat Service (`app/services/chat_service.py`)**:
  - Updated to support SSE (Server-Sent Events).
  - Pushes specific events: `token` (text), `actions` (JSON), `parse_status` (degradation warning), and `done`.

#### D. API Endpoints
- **Chat (`/api/v1/chat/stream`)**: Now supports `X-Idempotency-Key` and returns the new SSE event types.
- **Tasks (`/api/v1/tasks/{id}/complete`)**: 
  - Returns a `retry_token` (idempotency key) in the response.
  - Supports optimistic updates by confirming completion quality and notes.
- **Subjects (`/api/v1/subjects`)**: New endpoint to fetch standard subject list for UI dropdowns.
- **Errors (`/api/v1/errors`)**: New endpoint to create error records, validating against the `Subject` table.

### 2.2 Frontend (Mobile) Implementation

#### A. Network Layer
- **Idempotency Interceptor (`core/network/idempotency_interceptor.dart`)**:
  - Automatically generates and injects a UUID `X-Idempotency-Key` for all state-changing requests (`POST`, `PUT`, `PATCH`).
  - Logs replay detections.

#### B. State Management (Riverpod)
- **Task Model (`data/models/task_model.dart`)**:
  - Added ephemeral local state fields: `syncStatus` (synced, pending, failed), `syncError`, and `retryToken`.
- **Task Notifier (`presentation/providers/task_provider.dart`)**:
  - **Optimistic UI**: When completing a task, immediately updates the UI to "Completed".
  - **Failure Handling**: If the API call fails, the task state transitions to "Failed" (visually distinct) instead of reverting. This prevents the "zombie task" effect where a user thinks they finished a task, but it silently reappears.
  - **Retry Logic**: Implemented `retryCompleteTask` to allow users to manually re-trigger the failed API call.

#### C. UI Components
- **Task Card (`presentation/widgets/task/task_card.dart`)**:
  - Added a visual overlay for tasks in `TaskSyncStatus.failed` state.
  - Provides **Retry** and **Discard** buttons directly on the card.
  - Shows a loading spinner for `pending` (syncing) state.
- **Degradation Notice (`presentation/widgets/parse_degraded_notice.dart`)**:
  - A warning widget displayed in the chat interface when the AI responds with text but fails to execute the requested command (e.g., "I created the task" but no JSON action was generated).

---

## 3. Key Feature Deep Dive

### 3.1 Idempotency & Reliability
Network instability is common on mobile devices. v2.1 ensures that if a user clicks "Create Task" and the network drops the response:
1. The App retries with the **same** `X-Idempotency-Key`.
2. The Backend detects the key.
3. Instead of creating a duplicate task, the Backend returns the **cached response** from the first successful attempt.

### 3.2 "Honest" AI Parsing
Previously, if the AI output malformed JSON, the system might crash or show nothing. Now:
1. **Level 1**: Tries to parse directly.
2. **Level 2**: Uses `json_repair` to fix common syntax errors.
3. **Level 3**: Uses Regex to extract JSON from text.
4. **Level 4 (Degradation)**: If all fails, it shows the raw text and explicitly tells the user: *"Operation might not have succeeded. AI format error."* This maintains trust.

### 3.3 Optimistic Updates with Safety
We moved away from "Silent Rollback" (which confuses users) to "Explicit Failure State".
- **Old Behavior**: User checks task -> API fails -> Checkbox silently unchecks.
- **New Behavior**: User checks task -> API fails -> Task stays checked but turns red with a "Retry" button.

---

## 4. Summary of File Changes

### Created Files
- `backend/app/models/job.py`, `subject.py`, `idempotency_key.py`
- `backend/app/core/idempotency.py`
- `backend/app/api/middleware.py`
- `backend/app/services/job_service.py`, `subject_service.py`
- `backend/app/services/llm/parser.py`
- `backend/app/api/v1/subjects.py`, `errors.py`
- `mobile/lib/core/network/idempotency_interceptor.dart`
- `mobile/lib/presentation/widgets/parse_degraded_notice.dart`

### Key Modified Files
- `backend/app/models/chat.py` (Added `message_id`)
- `backend/app/main.py` (Added Startup Recovery)
- `backend/app/api/v1/chat.py` (Added SSE logic)
- `mobile/lib/presentation/providers/task_provider.dart` (Optimistic logic)
- `mobile/lib/presentation/widgets/task/task_card.dart` (Sync status UI)
