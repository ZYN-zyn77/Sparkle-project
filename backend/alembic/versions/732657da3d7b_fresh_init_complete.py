"""fresh_init_complete

Revision ID: 732657da3d7b
Revises: 
Create Date: 2026-01-13 12:24:27.200699

"""
from typing import Sequence, Union
import os

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql
import app.models.base
import pgvector

# Migration Contract:
#   type: reversible|forward_only|destructive
#   rollback_plan: "alembic downgrade -1" | "forward_fix_only"
#   verification_query: "SELECT 1;"
#   backfill_plan: "n/a"
#   owner: "team-name"
#   ticket: "n/a"

# revision identifiers, used by Alembic.
revision: str = '732657da3d7b'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    if os.getenv("SKIP_VECTOR_EXTENSION", "").lower() not in ("1", "true", "yes"):
        op.execute("CREATE EXTENSION IF NOT EXISTS vector")
    op.create_table('dictionary_entries',
    sa.Column('word', sa.String(length=100), nullable=False),
    sa.Column('phonetic', sa.String(length=100), nullable=True),
    sa.Column('pos', sa.String(length=50), nullable=True),
    sa.Column('definitions', sa.JSON(), nullable=False),
    sa.Column('examples', sa.JSON(), nullable=True),
    sa.Column('source', sa.String(length=50), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('dictionary_entries', schema=None) as batch_op:
        batch_op.create_index('idx_dict_word', ['word'], unique=False)
        batch_op.create_index(batch_op.f('ix_dictionary_entries_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_dictionary_entries_word'), ['word'], unique=True)

    op.create_table('groups',
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('avatar_url', sa.String(length=500), nullable=True),
    sa.Column('type', sa.Enum('SQUAD', 'SPRINT', 'OFFICIAL', name='grouptype'), nullable=False),
    sa.Column('focus_tags', sa.JSON(), nullable=False),
    sa.Column('deadline', sa.DateTime(), nullable=True),
    sa.Column('sprint_goal', sa.Text(), nullable=True),
    sa.Column('max_members', sa.Integer(), nullable=False),
    sa.Column('is_public', sa.Boolean(), nullable=False),
    sa.Column('join_requires_approval', sa.Boolean(), nullable=False),
    sa.Column('total_flame_power', sa.Integer(), nullable=False),
    sa.Column('today_checkin_count', sa.Integer(), nullable=False),
    sa.Column('total_tasks_completed', sa.Integer(), nullable=False),
    sa.Column('announcement', sa.Text(), nullable=True),
    sa.Column('announcement_updated_at', sa.DateTime(), nullable=True),
    sa.Column('keyword_filters', sa.JSON(), nullable=True),
    sa.Column('mute_all', sa.Boolean(), nullable=False),
    sa.Column('slow_mode_seconds', sa.Integer(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('groups', schema=None) as batch_op:
        batch_op.create_index('idx_group_public', ['is_public'], unique=False)
        batch_op.create_index('idx_group_type', ['type'], unique=False)
        batch_op.create_index(batch_op.f('ix_groups_deleted_at'), ['deleted_at'], unique=False)

    op.create_table('irt_item_parameters',
    sa.Column('question_id', app.models.base.GUID(), nullable=False),
    sa.Column('subject_id', sa.String(length=32), nullable=True),
    sa.Column('a', sa.Float(), nullable=False),
    sa.Column('b', sa.Float(), nullable=False),
    sa.Column('c', sa.Float(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('irt_item_parameters', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_irt_item_parameters_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_irt_item_parameters_question_id'), ['question_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_irt_item_parameters_subject_id'), ['subject_id'], unique=False)

    op.create_table('semantic_links',
    sa.Column('source_type', sa.String(length=30), nullable=False),
    sa.Column('source_id', sa.String(length=64), nullable=False),
    sa.Column('target_type', sa.String(length=30), nullable=False),
    sa.Column('target_id', sa.String(length=64), nullable=False),
    sa.Column('relation_type', sa.String(length=40), nullable=False),
    sa.Column('strength', sa.Float(), nullable=False),
    sa.Column('created_by', sa.String(length=20), nullable=False),
    sa.Column('evidence_refs', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('semantic_links', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_semantic_links_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_semantic_links_relation_type'), ['relation_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_semantic_links_source_id'), ['source_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_semantic_links_source_type'), ['source_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_semantic_links_target_id'), ['target_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_semantic_links_target_type'), ['target_type'], unique=False)

    op.create_table('subjects',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False),
    sa.Column('aliases', sa.JSON(), nullable=True),
    sa.Column('category', sa.String(length=50), nullable=True),
    sa.Column('sector_code', sa.String(length=20), server_default='VOID', nullable=False),
    sa.Column('hex_color', sa.String(length=7), nullable=True),
    sa.Column('glow_color', sa.String(length=7), nullable=True),
    sa.Column('position_angle', sa.Float(), nullable=True),
    sa.Column('icon_name', sa.String(length=50), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.Column('sort_order', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('subjects', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_subjects_category'), ['category'], unique=False)
        batch_op.create_index(batch_op.f('ix_subjects_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_subjects_name'), ['name'], unique=True)

    op.create_table('users',
    sa.Column('username', sa.String(length=100), nullable=False),
    sa.Column('email', sa.String(length=255), nullable=False),
    sa.Column('hashed_password', sa.String(length=255), nullable=False),
    sa.Column('full_name', sa.String(length=100), nullable=True),
    sa.Column('nickname', sa.String(length=100), nullable=True),
    sa.Column('avatar_url', sa.String(length=500), nullable=True),
    sa.Column('avatar_status', sa.Enum('APPROVED', 'PENDING', 'REJECTED', name='avatarstatus'), nullable=False),
    sa.Column('pending_avatar_url', sa.String(length=500), nullable=True),
    sa.Column('flame_level', sa.Integer(), nullable=False),
    sa.Column('flame_brightness', sa.Float(), nullable=False),
    sa.Column('depth_preference', sa.Float(), nullable=False),
    sa.Column('curiosity_preference', sa.Float(), nullable=False),
    sa.Column('schedule_preferences', sa.JSON(), nullable=True),
    sa.Column('weather_preferences', sa.JSON(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('is_superuser', sa.Boolean(), nullable=False),
    sa.Column('status', sa.Enum('ONLINE', 'OFFLINE', 'INVISIBLE', name='userstatus'), nullable=False),
    sa.Column('google_id', sa.String(length=255), nullable=True),
    sa.Column('apple_id', sa.String(length=255), nullable=True),
    sa.Column('wechat_unionid', sa.String(length=255), nullable=True),
    sa.Column('registration_source', sa.String(length=50), nullable=False),
    sa.Column('last_login_at', sa.DateTime(), nullable=True),
    sa.Column('is_minor', sa.Boolean(), nullable=True),
    sa.Column('age_verified', sa.Boolean(), nullable=False),
    sa.Column('age_verification_source', sa.String(length=50), nullable=True),
    sa.Column('age_verified_at', sa.DateTime(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('email'),
    sa.UniqueConstraint('username')
    )
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.create_index('idx_users_email', ['email'], unique=False)
        batch_op.create_index('idx_users_username', ['username'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_apple_id'), ['apple_id'], unique=True)
        batch_op.create_index(batch_op.f('ix_users_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_users_google_id'), ['google_id'], unique=True)
        batch_op.create_index(batch_op.f('ix_users_wechat_unionid'), ['wechat_unionid'], unique=True)

    op.create_table('behavior_patterns',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('pattern_name', sa.String(length=100), nullable=False),
    sa.Column('pattern_type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('solution_text', sa.Text(), nullable=True),
    sa.Column('evidence_ids', sa.JSON(), nullable=True),
    sa.Column('confidence_score', sa.Float(), nullable=True),
    sa.Column('frequency', sa.Integer(), nullable=True),
    sa.Column('is_archived', sa.Boolean(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('behavior_patterns', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_behavior_patterns_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_behavior_patterns_user_id'), ['user_id'], unique=False)

    op.create_table('broadcast_messages',
    sa.Column('sender_id', app.models.base.GUID(), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('content_data', sa.JSON(), nullable=True),
    sa.Column('target_group_ids', sa.JSON(), nullable=False),
    sa.Column('delivered_count', sa.Integer(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['sender_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('broadcast_messages', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_broadcast_messages_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_broadcast_messages_sender_id'), ['sender_id'], unique=False)

    op.create_table('collaborative_galaxies',
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_by', app.models.base.GUID(), nullable=False),
    sa.Column('visibility', sa.String(length=20), nullable=False),
    sa.Column('subject_id', sa.Integer(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['subject_id'], ['subjects.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('collaborative_galaxies', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_collaborative_galaxies_deleted_at'), ['deleted_at'], unique=False)

    op.create_table('compliance_check_logs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('check_type', sa.String(length=100), nullable=False),
    sa.Column('check_name', sa.String(length=200), nullable=False),
    sa.Column('standard', sa.String(length=100), nullable=True),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('details', sa.JSON(), nullable=True),
    sa.Column('findings', sa.JSON(), nullable=True),
    sa.Column('executed_by', sa.UUID(), nullable=True),
    sa.Column('automated', sa.String(length=10), nullable=False),
    sa.Column('executed_at', sa.DateTime(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['executed_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('compliance_check_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_compliance_check_logs_check_type'), ['check_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_compliance_check_logs_executed_at'), ['executed_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_compliance_check_logs_executed_by'), ['executed_by'], unique=False)
        batch_op.create_index(batch_op.f('ix_compliance_check_logs_id'), ['id'], unique=False)

    op.create_table('crypto_shredding_certificates',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('key_id', sa.String(length=128), nullable=False),
    sa.Column('destruction_time', sa.DateTime(), nullable=False),
    sa.Column('cloud_provider_ack', sa.Text(), nullable=True),
    sa.Column('certificate_data', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('crypto_shredding_certificates', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_crypto_shredding_certificates_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_crypto_shredding_certificates_user_id'), ['user_id'], unique=False)

    op.create_table('data_access_logs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('ip_address', sa.String(length=45), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('resource_type', sa.String(length=100), nullable=False),
    sa.Column('resource_id', sa.String(length=100), nullable=False),
    sa.Column('action', sa.String(length=50), nullable=False),
    sa.Column('request_method', sa.String(length=10), nullable=True),
    sa.Column('request_path', sa.String(length=500), nullable=True),
    sa.Column('request_params', sa.JSON(), nullable=True),
    sa.Column('response_status', sa.String(length=10), nullable=True),
    sa.Column('accessed_at', sa.DateTime(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('data_access_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_data_access_logs_accessed_at'), ['accessed_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_access_logs_action'), ['action'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_access_logs_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_access_logs_ip_address'), ['ip_address'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_access_logs_resource_id'), ['resource_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_access_logs_resource_type'), ['resource_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_access_logs_user_id'), ['user_id'], unique=False)

    op.create_table('dlq_replay_audit_logs',
    sa.Column('message_id', sa.String(length=128), nullable=False),
    sa.Column('admin_id', app.models.base.GUID(), nullable=False),
    sa.Column('approver_id', app.models.base.GUID(), nullable=False),
    sa.Column('reason_code', sa.String(length=64), nullable=False),
    sa.Column('payload_hash', sa.String(length=128), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['admin_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['approver_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('dlq_replay_audit_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_dlq_replay_audit_logs_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_dlq_replay_audit_logs_message_id'), ['message_id'], unique=False)

    op.create_table('error_records',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('subject_code', sa.String(length=50), nullable=False),
    sa.Column('chapter', sa.String(length=100), nullable=True),
    sa.Column('question_text', sa.Text(), nullable=True),
    sa.Column('question_image_url', sa.String(length=500), nullable=True),
    sa.Column('user_answer', sa.Text(), nullable=True),
    sa.Column('correct_answer', sa.Text(), nullable=True),
    sa.Column('mastery_level', sa.Float(), nullable=True),
    sa.Column('easiness_factor', sa.Float(), nullable=True),
    sa.Column('review_count', sa.Integer(), nullable=True),
    sa.Column('interval_days', sa.Float(), nullable=True),
    sa.Column('next_review_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('last_reviewed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('latest_analysis', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('cognitive_tags', postgresql.ARRAY(sa.String()), nullable=True),
    sa.Column('ai_analysis_summary', sa.Text(), nullable=True),
    sa.Column('linked_knowledge_node_ids', postgresql.ARRAY(sa.UUID()), nullable=True),
    sa.Column('suggested_concepts', postgresql.ARRAY(sa.Text()), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('is_deleted', sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('error_records', schema=None) as batch_op:
        batch_op.create_index('idx_error_records_cognitive_tags', ['cognitive_tags'], unique=False, postgresql_using='gin')
        batch_op.create_index('idx_errors_subject', ['subject_code'], unique=False)
        batch_op.create_index('idx_errors_user_review', ['user_id', 'next_review_at'], unique=False, postgresql_where=sa.text('mastery_level < 1.0'))

    op.create_table('friendships',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('friend_id', app.models.base.GUID(), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'ACCEPTED', 'BLOCKED', name='friendshipstatus'), nullable=False),
    sa.Column('initiated_by', app.models.base.GUID(), nullable=False),
    sa.Column('match_reason', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['friend_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['initiated_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'friend_id', name='uq_friendship')
    )
    with op.batch_alter_table('friendships', schema=None) as batch_op:
        batch_op.create_index('idx_friendship_friend', ['friend_id'], unique=False)
        batch_op.create_index('idx_friendship_status', ['status'], unique=False)
        batch_op.create_index('idx_friendship_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_friendships_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_friendships_friend_id'), ['friend_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_friendships_user_id'), ['user_id'], unique=False)

    op.create_table('group_members',
    sa.Column('group_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('role', sa.Enum('OWNER', 'ADMIN', 'MEMBER', name='grouprole'), nullable=False),
    sa.Column('is_muted', sa.Boolean(), nullable=False),
    sa.Column('mute_until', sa.DateTime(), nullable=True),
    sa.Column('warn_count', sa.Integer(), nullable=False),
    sa.Column('notifications_enabled', sa.Boolean(), nullable=False),
    sa.Column('flame_contribution', sa.Integer(), nullable=False),
    sa.Column('tasks_completed', sa.Integer(), nullable=False),
    sa.Column('checkin_streak', sa.Integer(), nullable=False),
    sa.Column('last_checkin_date', sa.DateTime(), nullable=True),
    sa.Column('joined_at', sa.DateTime(), nullable=False),
    sa.Column('last_active_at', sa.DateTime(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['group_id'], ['groups.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('group_id', 'user_id', name='uq_group_member')
    )
    with op.batch_alter_table('group_members', schema=None) as batch_op:
        batch_op.create_index('idx_member_group', ['group_id'], unique=False)
        batch_op.create_index('idx_member_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_members_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_members_group_id'), ['group_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_members_user_id'), ['user_id'], unique=False)

    op.create_table('group_messages',
    sa.Column('group_id', app.models.base.GUID(), nullable=False),
    sa.Column('sender_id', app.models.base.GUID(), nullable=True),
    sa.Column('message_type', sa.Enum('TEXT', 'TASK_SHARE', 'PLAN_SHARE', 'FRAGMENT_SHARE', 'CAPSULE_SHARE', 'PRISM_SHARE', 'FILE_SHARE', 'PROGRESS', 'ACHIEVEMENT', 'CHECKIN', 'SYSTEM', 'BROADCAST', name='messagetype'), nullable=False),
    sa.Column('content', sa.Text(), nullable=True),
    sa.Column('content_data', sa.JSON(), nullable=True),
    sa.Column('reply_to_id', app.models.base.GUID(), nullable=True),
    sa.Column('thread_root_id', app.models.base.GUID(), nullable=True),
    sa.Column('is_revoked', sa.Boolean(), nullable=False),
    sa.Column('revoked_at', sa.DateTime(), nullable=True),
    sa.Column('edited_at', sa.DateTime(), nullable=True),
    sa.Column('reactions', sa.JSON(), nullable=True),
    sa.Column('mention_user_ids', sa.JSON(), nullable=True),
    sa.Column('encrypted_content', sa.Text(), nullable=True),
    sa.Column('content_signature', sa.String(length=512), nullable=True),
    sa.Column('encryption_version', sa.Integer(), nullable=True),
    sa.Column('topic', sa.String(length=100), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('forwarded_from_id', app.models.base.GUID(), nullable=True),
    sa.Column('forward_count', sa.Integer(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['forwarded_from_id'], ['group_messages.id'], ),
    sa.ForeignKeyConstraint(['group_id'], ['groups.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['reply_to_id'], ['group_messages.id'], ),
    sa.ForeignKeyConstraint(['sender_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['thread_root_id'], ['group_messages.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('group_messages', schema=None) as batch_op:
        batch_op.create_index('idx_message_group_thread', ['group_id', 'thread_root_id', 'created_at'], unique=False)
        batch_op.create_index('idx_message_group_time', ['group_id', 'created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_messages_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_messages_group_id'), ['group_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_messages_thread_root_id'), ['thread_root_id'], unique=False)

    op.create_table('group_tasks',
    sa.Column('group_id', app.models.base.GUID(), nullable=False),
    sa.Column('created_by', app.models.base.GUID(), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=False),
    sa.Column('estimated_minutes', sa.Integer(), nullable=False),
    sa.Column('difficulty', sa.Integer(), nullable=False),
    sa.Column('total_claims', sa.Integer(), nullable=False),
    sa.Column('total_completions', sa.Integer(), nullable=False),
    sa.Column('due_date', sa.DateTime(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['group_id'], ['groups.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('group_tasks', schema=None) as batch_op:
        batch_op.create_index('idx_group_task_group', ['group_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_tasks_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_tasks_group_id'), ['group_id'], unique=False)

    op.create_table('idempotency_keys',
    sa.Column('key', sa.String(length=64), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('response', sa.JSON(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=True),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('key')
    )
    with op.batch_alter_table('idempotency_keys', schema=None) as batch_op:
        batch_op.create_index('idx_idempotency_expires', ['expires_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_idempotency_keys_expires_at'), ['expires_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_idempotency_keys_user_id'), ['user_id'], unique=False)

    op.create_table('intervention_requests',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('dedupe_key', sa.String(length=200), nullable=True),
    sa.Column('topic', sa.String(length=120), nullable=True),
    sa.Column('requested_level', sa.String(length=40), nullable=False),
    sa.Column('final_level', sa.String(length=40), nullable=False),
    sa.Column('status', sa.String(length=40), nullable=False),
    sa.Column('reason', sa.JSON(), nullable=True),
    sa.Column('content', sa.JSON(), nullable=True),
    sa.Column('cooldown_policy', sa.JSON(), nullable=True),
    sa.Column('schema_version', sa.String(length=50), nullable=False),
    sa.Column('policy_version', sa.String(length=50), nullable=True),
    sa.Column('model_version', sa.String(length=80), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('is_retractable', sa.Boolean(), nullable=False),
    sa.Column('supersedes_id', app.models.base.GUID(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('intervention_requests', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_intervention_requests_dedupe_key'), ['dedupe_key'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_requests_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_requests_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_requests_topic'), ['topic'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_requests_user_id'), ['user_id'], unique=False)

    op.create_table('jobs',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('type', sa.String(length=50), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('params', sa.JSON(), nullable=True),
    sa.Column('result', sa.JSON(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('progress', sa.Integer(), nullable=True),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('timeout_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('jobs', schema=None) as batch_op:
        batch_op.create_index('idx_jobs_status', ['status'], unique=False)
        batch_op.create_index('idx_jobs_status_timeout', ['status', 'timeout_at'], unique=False, postgresql_where=sa.text("status = 'running'"))
        batch_op.create_index('idx_jobs_user_id', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_jobs_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_jobs_user_id'), ['user_id'], unique=False)

    op.create_table('knowledge_nodes',
    sa.Column('subject_id', sa.Integer(), nullable=True),
    sa.Column('parent_id', app.models.base.GUID(), nullable=True),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('name_en', sa.String(length=255), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('keywords', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('importance_level', sa.Integer(), nullable=False),
    sa.Column('is_seed', sa.Boolean(), nullable=True),
    sa.Column('source_type', sa.String(length=20), nullable=True),
    sa.Column('source_task_id', app.models.base.GUID(), nullable=True),
    sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True),
    sa.Column('position_x', sa.Float(), nullable=True),
    sa.Column('position_y', sa.Float(), nullable=True),
    sa.Column('global_spark_count', sa.Integer(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['parent_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['subject_id'], ['subjects.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('knowledge_nodes', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_knowledge_nodes_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_knowledge_nodes_parent_id'), ['parent_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_knowledge_nodes_position_x'), ['position_x'], unique=False)
        batch_op.create_index(batch_op.f('ix_knowledge_nodes_position_y'), ['position_y'], unique=False)
        batch_op.create_index(batch_op.f('ix_knowledge_nodes_subject_id'), ['subject_id'], unique=False)

    op.create_table('legal_holds',
    sa.Column('user_id', app.models.base.GUID(), nullable=True),
    sa.Column('device_id', sa.String(length=128), nullable=True),
    sa.Column('case_ref', sa.String(length=120), nullable=False),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.Column('admin_id', app.models.base.GUID(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('released_at', sa.DateTime(), nullable=True),
    sa.Column('released_by', app.models.base.GUID(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['admin_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['released_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('legal_holds', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_legal_holds_case_ref'), ['case_ref'], unique=False)
        batch_op.create_index(batch_op.f('ix_legal_holds_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_legal_holds_device_id'), ['device_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_legal_holds_user_id'), ['user_id'], unique=False)

    op.create_table('login_attempts',
    sa.Column('user_id', app.models.base.GUID(), nullable=True),
    sa.Column('username', sa.String(length=100), nullable=False),
    sa.Column('ip_address', sa.String(length=45), nullable=False),
    sa.Column('user_agent', sa.String(length=500), nullable=True),
    sa.Column('success', sa.Boolean(), nullable=False),
    sa.Column('attempted_at', sa.DateTime(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('login_attempts', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_login_attempts_attempted_at'), ['attempted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_login_attempts_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_login_attempts_ip_address'), ['ip_address'], unique=False)
        batch_op.create_index(batch_op.f('ix_login_attempts_success'), ['success'], unique=False)
        batch_op.create_index(batch_op.f('ix_login_attempts_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_login_attempts_username'), ['username'], unique=False)

    op.create_table('nightly_reviews',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('review_date', sa.Date(), nullable=False),
    sa.Column('summary_text', sa.String(length=2000), nullable=True),
    sa.Column('todo_items', sa.JSON(), nullable=True),
    sa.Column('evidence_refs', sa.JSON(), nullable=True),
    sa.Column('model_version', sa.String(length=50), nullable=True),
    sa.Column('status', sa.String(length=30), nullable=False),
    sa.Column('reviewed_at', sa.DateTime(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('nightly_reviews', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_nightly_reviews_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_nightly_reviews_review_date'), ['review_date'], unique=False)
        batch_op.create_index(batch_op.f('ix_nightly_reviews_user_id'), ['user_id'], unique=False)

    op.create_table('notifications',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('content', sa.String(length=1000), nullable=False),
    sa.Column('type', sa.String(length=50), nullable=False),
    sa.Column('is_read', sa.Boolean(), nullable=False),
    sa.Column('read_at', sa.DateTime(), nullable=True),
    sa.Column('data', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('notifications', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_notifications_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_notifications_user_id'), ['user_id'], unique=False)

    op.create_table('offline_message_queue',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('client_nonce', sa.String(length=100), nullable=False),
    sa.Column('message_type', sa.String(length=50), nullable=False),
    sa.Column('target_id', app.models.base.GUID(), nullable=False),
    sa.Column('payload', sa.JSON(), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'SENT', 'FAILED', 'EXPIRED', name='offlinemessagestatus'), nullable=False),
    sa.Column('retry_count', sa.Integer(), nullable=False),
    sa.Column('last_retry_at', sa.DateTime(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'client_nonce', name='uq_offline_queue_nonce')
    )
    with op.batch_alter_table('offline_message_queue', schema=None) as batch_op:
        batch_op.create_index('idx_offline_queue_user_status', ['user_id', 'status'], unique=False)
        batch_op.create_index(batch_op.f('ix_offline_message_queue_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_offline_message_queue_user_id'), ['user_id'], unique=False)

    op.create_table('persona_snapshots',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('persona_version', sa.String(length=50), nullable=False),
    sa.Column('audit_token', sa.String(length=128), nullable=True),
    sa.Column('source_event_id', sa.String(length=64), nullable=True),
    sa.Column('snapshot_data', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('persona_snapshots', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_persona_snapshots_audit_token'), ['audit_token'], unique=False)
        batch_op.create_index(batch_op.f('ix_persona_snapshots_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_persona_snapshots_persona_version'), ['persona_version'], unique=False)
        batch_op.create_index(batch_op.f('ix_persona_snapshots_source_event_id'), ['source_event_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_persona_snapshots_user_id'), ['user_id'], unique=False)

    op.create_table('plans',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('type', sa.Enum('SPRINT', 'GROWTH', name='plantype'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('target_date', sa.Date(), nullable=True),
    sa.Column('daily_available_minutes', sa.Integer(), nullable=False),
    sa.Column('total_estimated_hours', sa.Float(), nullable=True),
    sa.Column('subject', sa.String(length=100), nullable=True),
    sa.Column('mastery_level', sa.Float(), nullable=False),
    sa.Column('progress', sa.Float(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('plans', schema=None) as batch_op:
        batch_op.create_index('idx_plans_is_active', ['is_active'], unique=False)
        batch_op.create_index('idx_plans_target_date', ['target_date'], unique=False)
        batch_op.create_index('idx_plans_type', ['type'], unique=False)
        batch_op.create_index('idx_plans_user_id', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_plans_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_plans_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_plans_user_id'), ['user_id'], unique=False)

    op.create_table('posts',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('content', sa.Text(), nullable=True),
    sa.Column('image_urls', sa.JSON(), nullable=True),
    sa.Column('topic', sa.String(length=100), nullable=True),
    sa.Column('visibility', sa.String(length=20), nullable=False),
    sa.Column('like_count', sa.Integer(), nullable=True),
    sa.Column('comment_count', sa.Integer(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('posts', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_posts_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_posts_user_id'), ['user_id'], unique=False)

    op.create_table('private_messages',
    sa.Column('sender_id', app.models.base.GUID(), nullable=False),
    sa.Column('receiver_id', app.models.base.GUID(), nullable=False),
    sa.Column('message_type', sa.Enum('TEXT', 'TASK_SHARE', 'PLAN_SHARE', 'FRAGMENT_SHARE', 'CAPSULE_SHARE', 'PRISM_SHARE', 'FILE_SHARE', 'PROGRESS', 'ACHIEVEMENT', 'CHECKIN', 'SYSTEM', 'BROADCAST', name='messagetype'), nullable=False),
    sa.Column('content', sa.Text(), nullable=True),
    sa.Column('content_data', sa.JSON(), nullable=True),
    sa.Column('reply_to_id', app.models.base.GUID(), nullable=True),
    sa.Column('thread_root_id', app.models.base.GUID(), nullable=True),
    sa.Column('is_read', sa.Boolean(), nullable=False),
    sa.Column('read_at', sa.DateTime(), nullable=True),
    sa.Column('is_revoked', sa.Boolean(), nullable=False),
    sa.Column('revoked_at', sa.DateTime(), nullable=True),
    sa.Column('edited_at', sa.DateTime(), nullable=True),
    sa.Column('reactions', sa.JSON(), nullable=True),
    sa.Column('mention_user_ids', sa.JSON(), nullable=True),
    sa.Column('encrypted_content', sa.Text(), nullable=True),
    sa.Column('content_signature', sa.String(length=512), nullable=True),
    sa.Column('encryption_version', sa.Integer(), nullable=True),
    sa.Column('topic', sa.String(length=100), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('forwarded_from_id', app.models.base.GUID(), nullable=True),
    sa.Column('forward_count', sa.Integer(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['forwarded_from_id'], ['private_messages.id'], ),
    sa.ForeignKeyConstraint(['receiver_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['reply_to_id'], ['private_messages.id'], ),
    sa.ForeignKeyConstraint(['sender_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['thread_root_id'], ['private_messages.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('private_messages', schema=None) as batch_op:
        batch_op.create_index('idx_private_message_conversation', ['sender_id', 'receiver_id', 'created_at'], unique=False)
        batch_op.create_index('idx_private_message_receiver_unread', ['receiver_id', 'is_read'], unique=False)
        batch_op.create_index('idx_private_message_thread', ['sender_id', 'receiver_id', 'thread_root_id', 'created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_private_messages_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_private_messages_receiver_id'), ['receiver_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_private_messages_sender_id'), ['sender_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_private_messages_thread_root_id'), ['thread_root_id'], unique=False)

    op.create_table('push_histories',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('trigger_type', sa.String(length=50), nullable=False),
    sa.Column('content_hash', sa.String(length=64), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('push_histories', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_push_histories_content_hash'), ['content_hash'], unique=False)
        batch_op.create_index(batch_op.f('ix_push_histories_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_push_histories_user_id'), ['user_id'], unique=False)

    op.create_table('push_preferences',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('active_slots', sa.JSON(), nullable=True),
    sa.Column('timezone', sa.String(length=50), nullable=False),
    sa.Column('enable_curiosity', sa.Boolean(), nullable=False),
    sa.Column('persona_type', sa.String(length=50), nullable=False),
    sa.Column('daily_cap', sa.Integer(), nullable=False),
    sa.Column('last_push_time', sa.DateTime(), nullable=True),
    sa.Column('consecutive_ignores', sa.Integer(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('push_preferences', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_push_preferences_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_push_preferences_user_id'), ['user_id'], unique=True)

    op.create_table('security_audit_logs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('threat_level', sa.String(length=20), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=True),
    sa.Column('ip_address', sa.String(length=45), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('resource', sa.String(length=500), nullable=True),
    sa.Column('action', sa.String(length=100), nullable=True),
    sa.Column('details', sa.JSON(), nullable=True),
    sa.Column('timestamp', sa.DateTime(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('security_audit_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_security_audit_logs_event_type'), ['event_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_audit_logs_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_audit_logs_ip_address'), ['ip_address'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_audit_logs_resource'), ['resource'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_audit_logs_threat_level'), ['threat_level'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_audit_logs_timestamp'), ['timestamp'], unique=False)
        batch_op.create_index(batch_op.f('ix_security_audit_logs_user_id'), ['user_id'], unique=False)

    op.create_table('stored_files',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('file_name', sa.String(length=255), nullable=False),
    sa.Column('mime_type', sa.String(length=150), nullable=False),
    sa.Column('file_size', sa.BigInteger(), nullable=False),
    sa.Column('bucket', sa.String(length=128), nullable=False),
    sa.Column('object_key', sa.String(length=512), nullable=False),
    sa.Column('status', sa.String(length=32), nullable=False),
    sa.Column('visibility', sa.String(length=32), nullable=False),
    sa.Column('error_message', sa.String(length=255), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('object_key')
    )
    with op.batch_alter_table('stored_files', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_stored_files_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_stored_files_user_id'), ['user_id'], unique=False)

    op.create_table('strategy_nodes',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('description', sa.String(length=2000), nullable=True),
    sa.Column('subject_code', sa.String(length=50), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('content_hash', sa.String(length=64), nullable=True),
    sa.Column('source_type', sa.String(length=20), nullable=False),
    sa.Column('evidence_refs', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('strategy_nodes', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_strategy_nodes_content_hash'), ['content_hash'], unique=False)
        batch_op.create_index(batch_op.f('ix_strategy_nodes_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_strategy_nodes_user_id'), ['user_id'], unique=False)

    op.create_table('system_config_change_logs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('config_key', sa.String(length=200), nullable=False),
    sa.Column('old_value', sa.JSON(), nullable=True),
    sa.Column('new_value', sa.JSON(), nullable=False),
    sa.Column('change_type', sa.String(length=50), nullable=False),
    sa.Column('changed_by', sa.UUID(), nullable=False),
    sa.Column('ip_address', sa.String(length=45), nullable=True),
    sa.Column('user_agent', sa.Text(), nullable=True),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.Column('impact_level', sa.String(length=20), nullable=True),
    sa.Column('changed_at', sa.DateTime(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['changed_by'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('system_config_change_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_system_config_change_logs_changed_at'), ['changed_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_config_change_logs_changed_by'), ['changed_by'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_config_change_logs_config_key'), ['config_key'], unique=False)
        batch_op.create_index(batch_op.f('ix_system_config_change_logs_id'), ['id'], unique=False)

    op.create_table('token_usage',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('session_id', sa.String(length=100), nullable=False),
    sa.Column('request_id', sa.String(length=100), nullable=False),
    sa.Column('prompt_tokens', sa.Integer(), nullable=False),
    sa.Column('completion_tokens', sa.Integer(), nullable=False),
    sa.Column('total_tokens', sa.Integer(), nullable=False),
    sa.Column('model', sa.String(length=100), nullable=False),
    sa.Column('cost', sa.Float(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('request_id')
    )
    with op.batch_alter_table('token_usage', schema=None) as batch_op:
        batch_op.create_index('idx_token_usage_created_at', ['created_at'], unique=False)
        batch_op.create_index('idx_token_usage_session_id', ['session_id'], unique=False)
        batch_op.create_index('idx_token_usage_user_id', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_token_usage_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_token_usage_session_id'), ['session_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_token_usage_user_id'), ['user_id'], unique=False)

    op.create_table('tracking_events',
    sa.Column('event_id', sa.String(length=64), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('event_type', sa.String(length=120), nullable=False),
    sa.Column('schema_version', sa.String(length=50), nullable=False),
    sa.Column('source', sa.String(length=50), nullable=False),
    sa.Column('ts_ms', sa.BigInteger(), nullable=False),
    sa.Column('entities', sa.JSON(), nullable=True),
    sa.Column('payload', sa.JSON(), nullable=True),
    sa.Column('received_at', sa.DateTime(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('tracking_events', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_tracking_events_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_tracking_events_event_id'), ['event_id'], unique=True)
        batch_op.create_index(batch_op.f('ix_tracking_events_event_type'), ['event_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_tracking_events_ts_ms'), ['ts_ms'], unique=False)
        batch_op.create_index(batch_op.f('ix_tracking_events_user_id'), ['user_id'], unique=False)

    op.create_table('user_daily_metrics',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('date', sa.Date(), nullable=False),
    sa.Column('total_focus_minutes', sa.Integer(), nullable=True),
    sa.Column('tasks_completed', sa.Integer(), nullable=True),
    sa.Column('tasks_created', sa.Integer(), nullable=True),
    sa.Column('nodes_studied', sa.Integer(), nullable=True),
    sa.Column('mastery_gained', sa.Float(), nullable=True),
    sa.Column('review_count', sa.Integer(), nullable=True),
    sa.Column('average_mood', sa.Float(), nullable=True),
    sa.Column('anxiety_score', sa.Float(), nullable=True),
    sa.Column('chat_messages_count', sa.Integer(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'date', name='uq_user_daily_metric')
    )
    with op.batch_alter_table('user_daily_metrics', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_user_daily_metrics_date'), ['date'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_daily_metrics_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_daily_metrics_user_id'), ['user_id'], unique=False)

    op.create_table('user_encryption_keys',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('public_key', sa.Text(), nullable=False),
    sa.Column('key_type', sa.String(length=50), nullable=False),
    sa.Column('device_id', sa.String(length=100), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('user_encryption_keys', schema=None) as batch_op:
        batch_op.create_index('idx_user_encryption_keys_user', ['user_id', 'is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_encryption_keys_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_encryption_keys_user_id'), ['user_id'], unique=False)

    op.create_table('user_intervention_settings',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('interrupt_threshold', sa.Float(), nullable=False),
    sa.Column('daily_interrupt_budget', sa.Integer(), nullable=False),
    sa.Column('cooldown_minutes', sa.Integer(), nullable=False),
    sa.Column('quiet_hours', sa.JSON(), nullable=True),
    sa.Column('topic_allowlist', sa.JSON(), nullable=True),
    sa.Column('topic_blocklist', sa.JSON(), nullable=True),
    sa.Column('do_not_disturb', sa.Boolean(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('user_intervention_settings', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_user_intervention_settings_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_intervention_settings_user_id'), ['user_id'], unique=True)

    op.create_table('user_irt_ability',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('subject_id', sa.String(length=32), nullable=True),
    sa.Column('theta', sa.Float(), nullable=False),
    sa.Column('last_updated_at', sa.DateTime(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('user_irt_ability', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_user_irt_ability_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_irt_ability_subject_id'), ['subject_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_irt_ability_user_id'), ['user_id'], unique=False)

    op.create_table('user_persona_keys',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('key_id', sa.String(length=128), nullable=False),
    sa.Column('encrypted_key', sa.Text(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('destroyed_at', sa.DateTime(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('user_persona_keys', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_user_persona_keys_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_persona_keys_key_id'), ['key_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_persona_keys_user_id'), ['user_id'], unique=False)

    op.create_table('user_state_snapshots',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('snapshot_at', sa.DateTime(), nullable=False),
    sa.Column('window_start', sa.DateTime(), nullable=False),
    sa.Column('window_end', sa.DateTime(), nullable=False),
    sa.Column('cognitive_load', sa.Float(), nullable=False),
    sa.Column('interruptibility', sa.Float(), nullable=False),
    sa.Column('strain_index', sa.Float(), nullable=False),
    sa.Column('focus_mode', sa.Boolean(), nullable=False),
    sa.Column('sprint_mode', sa.Boolean(), nullable=False),
    sa.Column('knowledge_state', sa.JSON(), nullable=True),
    sa.Column('time_context', sa.JSON(), nullable=True),
    sa.Column('derived_event_ids', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('user_state_snapshots', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_user_state_snapshots_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_state_snapshots_snapshot_at'), ['snapshot_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_user_state_snapshots_user_id'), ['user_id'], unique=False)

    op.create_table('crdt_operation_log',
    sa.Column('id', sa.BigInteger(), autoincrement=True, nullable=False),
    sa.Column('galaxy_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('operation_type', sa.String(length=50), nullable=True),
    sa.Column('operation_data', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('timestamp', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['galaxy_id'], ['collaborative_galaxies.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('crdt_operation_log', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_crdt_operation_log_galaxy_id'), ['galaxy_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_crdt_operation_log_timestamp'), ['timestamp'], unique=False)

    op.create_table('crdt_snapshots',
    sa.Column('galaxy_id', app.models.base.GUID(), nullable=False),
    sa.Column('state_data', sa.LargeBinary(), nullable=False),
    sa.Column('operation_count', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['galaxy_id'], ['collaborative_galaxies.id'], ),
    sa.PrimaryKeyConstraint('galaxy_id')
    )
    op.create_table('document_chunks',
    sa.Column('file_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('chunk_index', sa.Integer(), nullable=False),
    sa.Column('page_number', sa.Integer(), nullable=True),
    sa.Column('section_title', sa.String(length=255), nullable=True),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['file_id'], ['stored_files.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('document_chunks', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_document_chunks_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_document_chunks_file_id'), ['file_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_document_chunks_user_id'), ['user_id'], unique=False)

    op.create_table('galaxy_user_permissions',
    sa.Column('galaxy_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('permission_level', sa.String(length=20), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['galaxy_id'], ['collaborative_galaxies.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('galaxy_id', 'user_id')
    )
    op.create_table('group_files',
    sa.Column('group_id', app.models.base.GUID(), nullable=False),
    sa.Column('file_id', app.models.base.GUID(), nullable=False),
    sa.Column('shared_by_id', app.models.base.GUID(), nullable=False),
    sa.Column('category', sa.String(length=64), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=False),
    sa.Column('view_role', sa.Enum('OWNER', 'ADMIN', 'MEMBER', name='grouprole'), nullable=False),
    sa.Column('download_role', sa.Enum('OWNER', 'ADMIN', 'MEMBER', name='grouprole'), nullable=False),
    sa.Column('manage_role', sa.Enum('OWNER', 'ADMIN', 'MEMBER', name='grouprole'), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['file_id'], ['stored_files.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['group_id'], ['groups.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['shared_by_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('group_id', 'file_id', name='uq_group_files_group_file')
    )
    with op.batch_alter_table('group_files', schema=None) as batch_op:
        batch_op.create_index('idx_group_files_category', ['category'], unique=False)
        batch_op.create_index('idx_group_files_file', ['file_id'], unique=False)
        batch_op.create_index('idx_group_files_group', ['group_id'], unique=False)
        batch_op.create_index('idx_group_files_shared_by', ['shared_by_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_files_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_files_file_id'), ['file_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_files_group_id'), ['group_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_files_shared_by_id'), ['shared_by_id'], unique=False)

    op.create_table('intervention_audit_logs',
    sa.Column('request_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('action', sa.String(length=40), nullable=False),
    sa.Column('guardrail_result', sa.JSON(), nullable=True),
    sa.Column('decision_trace', sa.JSON(), nullable=True),
    sa.Column('evidence_refs', sa.JSON(), nullable=True),
    sa.Column('requested_level', sa.String(length=40), nullable=False),
    sa.Column('final_level', sa.String(length=40), nullable=False),
    sa.Column('policy_version', sa.String(length=50), nullable=True),
    sa.Column('model_version', sa.String(length=80), nullable=True),
    sa.Column('schema_version', sa.String(length=50), nullable=True),
    sa.Column('occurred_at', sa.DateTime(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['request_id'], ['intervention_requests.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('intervention_audit_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_intervention_audit_logs_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_audit_logs_occurred_at'), ['occurred_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_audit_logs_request_id'), ['request_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_audit_logs_user_id'), ['user_id'], unique=False)

    op.create_table('intervention_feedback',
    sa.Column('request_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('feedback_type', sa.String(length=40), nullable=False),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['request_id'], ['intervention_requests.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('intervention_feedback', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_intervention_feedback_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_feedback_feedback_type'), ['feedback_type'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_feedback_request_id'), ['request_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_intervention_feedback_user_id'), ['user_id'], unique=False)

    op.create_table('message_favorites',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('group_message_id', app.models.base.GUID(), nullable=True),
    sa.Column('private_message_id', app.models.base.GUID(), nullable=True),
    sa.Column('note', sa.Text(), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['group_message_id'], ['group_messages.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['private_message_id'], ['private_messages.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('message_favorites', schema=None) as batch_op:
        batch_op.create_index('idx_message_favorites_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_message_favorites_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_message_favorites_user_id'), ['user_id'], unique=False)

    op.create_table('message_reports',
    sa.Column('reporter_id', app.models.base.GUID(), nullable=False),
    sa.Column('group_message_id', app.models.base.GUID(), nullable=True),
    sa.Column('private_message_id', app.models.base.GUID(), nullable=True),
    sa.Column('reason', sa.Enum('SPAM', 'HARASSMENT', 'VIOLENCE', 'MISINFORMATION', 'INAPPROPRIATE', 'OTHER', name='reportreason'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'REVIEWED', 'DISMISSED', 'ACTIONED', name='reportstatus'), nullable=False),
    sa.Column('reviewed_by', app.models.base.GUID(), nullable=True),
    sa.Column('reviewed_at', sa.DateTime(), nullable=True),
    sa.Column('action_taken', sa.Enum('WARN', 'MUTE', 'KICK', 'BAN', name='moderationaction'), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['group_message_id'], ['group_messages.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['private_message_id'], ['private_messages.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['reporter_id'], ['users.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['reviewed_by'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('message_reports', schema=None) as batch_op:
        batch_op.create_index('idx_message_reports_group_msg', ['group_message_id'], unique=False)
        batch_op.create_index('idx_message_reports_status', ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_message_reports_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_message_reports_reporter_id'), ['reporter_id'], unique=False)

    op.create_table('node_relations',
    sa.Column('source_node_id', app.models.base.GUID(), nullable=False),
    sa.Column('target_node_id', app.models.base.GUID(), nullable=False),
    sa.Column('relation_type', sa.String(length=30), nullable=False),
    sa.Column('strength', sa.Float(), nullable=True),
    sa.Column('created_by', sa.String(length=20), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['source_node_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['target_node_id'], ['knowledge_nodes.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('node_relations', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_node_relations_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_node_relations_source_node_id'), ['source_node_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_node_relations_target_node_id'), ['target_node_id'], unique=False)

    op.create_table('post_likes',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('post_id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['post_id'], ['posts.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'post_id', name='uq_post_like')
    )
    with op.batch_alter_table('post_likes', schema=None) as batch_op:
        batch_op.create_index('idx_post_like_post', ['post_id'], unique=False)
        batch_op.create_index('idx_post_like_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_post_likes_deleted_at'), ['deleted_at'], unique=False)

    op.create_table('tasks',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('plan_id', app.models.base.GUID(), nullable=True),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('type', sa.Enum('LEARNING', 'TRAINING', 'ERROR_FIX', 'REFLECTION', 'SOCIAL', 'PLANNING', name='tasktype'), nullable=False),
    sa.Column('tags', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('estimated_minutes', sa.Integer(), nullable=False),
    sa.Column('difficulty', sa.Integer(), nullable=False),
    sa.Column('energy_cost', sa.Integer(), nullable=False),
    sa.Column('guide_content', sa.Text(), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'IN_PROGRESS', 'COMPLETED', 'ABANDONED', name='taskstatus'), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('confirmed_at', sa.DateTime(), nullable=True),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('tool_result_id', sa.String(length=50), nullable=True),
    sa.Column('actual_minutes', sa.Integer(), nullable=True),
    sa.Column('user_note', sa.Text(), nullable=True),
    sa.Column('priority', sa.Integer(), nullable=False),
    sa.Column('due_date', sa.Date(), nullable=True),
    sa.Column('knowledge_node_id', app.models.base.GUID(), nullable=True),
    sa.Column('auto_expand_enabled', sa.Boolean(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['knowledge_node_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['plan_id'], ['plans.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('tasks', schema=None) as batch_op:
        batch_op.create_index('idx_tasks_created_at', ['created_at'], unique=False)
        batch_op.create_index('idx_tasks_due_date', ['due_date'], unique=False)
        batch_op.create_index('idx_tasks_plan_id', ['plan_id'], unique=False)
        batch_op.create_index('idx_tasks_status', ['status'], unique=False)
        batch_op.create_index('idx_tasks_user_id', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_tasks_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_tasks_plan_id'), ['plan_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_tasks_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_tasks_tool_result_id'), ['tool_result_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_tasks_user_id'), ['user_id'], unique=False)

    op.create_table('user_node_status',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('node_id', app.models.base.GUID(), nullable=False),
    sa.Column('mastery_score', sa.Float(), nullable=False),
    sa.Column('bkt_mastery_prob', sa.Float(), nullable=False),
    sa.Column('bkt_last_updated_at', sa.DateTime(), nullable=True),
    sa.Column('total_minutes', sa.Integer(), nullable=False),
    sa.Column('total_study_minutes', sa.Integer(), nullable=False),
    sa.Column('study_count', sa.Integer(), nullable=True),
    sa.Column('is_unlocked', sa.Boolean(), nullable=False),
    sa.Column('is_collapsed', sa.Boolean(), nullable=True),
    sa.Column('is_favorite', sa.Boolean(), nullable=True),
    sa.Column('last_study_at', sa.DateTime(), nullable=True),
    sa.Column('last_interacted_at', sa.DateTime(), nullable=False),
    sa.Column('decay_paused', sa.Boolean(), nullable=True),
    sa.Column('next_review_at', sa.DateTime(), nullable=True),
    sa.Column('revision', sa.Integer(), nullable=False),
    sa.Column('first_unlock_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['node_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('user_id', 'node_id')
    )
    with op.batch_alter_table('user_node_status', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_user_node_status_next_review_at'), ['next_review_at'], unique=False)

    op.create_table('chat_messages',
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('task_id', app.models.base.GUID(), nullable=True),
    sa.Column('session_id', app.models.base.GUID(), nullable=False),
    sa.Column('message_id', sa.String(length=36), nullable=True),
    sa.Column('role', sa.Enum('USER', 'ASSISTANT', 'SYSTEM', name='messagerole'), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('actions', sa.JSON(), nullable=True),
    sa.Column('parse_degraded', sa.Boolean(), nullable=True),
    sa.Column('tokens_used', sa.Integer(), nullable=True),
    sa.Column('model_name', sa.String(length=100), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id', 'created_at')
    )
    with op.batch_alter_table('chat_messages', schema=None) as batch_op:
        batch_op.create_index('idx_chat_created_at', ['created_at'], unique=False)
        batch_op.create_index('idx_chat_role', ['role'], unique=False)
        batch_op.create_index('idx_chat_session_id', ['session_id'], unique=False)
        batch_op.create_index('idx_chat_task_id', ['task_id'], unique=False)
        batch_op.create_index('idx_chat_user_id', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_chat_messages_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_chat_messages_session_id'), ['session_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_chat_messages_user_id'), ['user_id'], unique=False)

    op.create_table('cognitive_fragments',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('task_id', app.models.base.GUID(), nullable=True),
    sa.Column('analysis_status', sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', name='analysisstatus'), nullable=False),
    sa.Column('error_message', sa.String(length=500), nullable=True),
    sa.Column('source_type', sa.String(length=20), nullable=False),
    sa.Column('resource_type', sa.String(length=20), nullable=False),
    sa.Column('resource_url', sa.String(length=512), nullable=True),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('sentiment', sa.String(length=20), nullable=True),
    sa.Column('persona_version', sa.String(length=50), nullable=True),
    sa.Column('source_event_id', sa.String(length=64), nullable=True),
    sa.Column('sensitive_tags_encrypted', sa.Text(), nullable=True),
    sa.Column('sensitive_tags_version', sa.Integer(), nullable=True),
    sa.Column('sensitive_tags_key_id', sa.String(length=100), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('error_tags', sa.JSON(), nullable=True),
    sa.Column('context_tags', sa.JSON(), nullable=True),
    sa.Column('severity', sa.Integer(), nullable=False),
    sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('cognitive_fragments', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_cognitive_fragments_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_cognitive_fragments_source_event_id'), ['source_event_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_cognitive_fragments_user_id'), ['user_id'], unique=False)

    op.create_table('curiosity_capsules',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('related_subject', sa.String(length=255), nullable=True),
    sa.Column('related_task_id', app.models.base.GUID(), nullable=True),
    sa.Column('is_read', sa.Boolean(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['related_task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('curiosity_capsules', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_curiosity_capsules_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_curiosity_capsules_related_task_id'), ['related_task_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_curiosity_capsules_user_id'), ['user_id'], unique=False)

    op.create_table('focus_sessions',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('task_id', app.models.base.GUID(), nullable=True),
    sa.Column('start_time', sa.DateTime(), nullable=False),
    sa.Column('end_time', sa.DateTime(), nullable=False),
    sa.Column('duration_minutes', sa.Integer(), nullable=False),
    sa.Column('focus_type', sa.Enum('POMODORO', 'STOPWATCH', name='focustype'), nullable=False),
    sa.Column('status', sa.Enum('COMPLETED', 'INTERRUPTED', name='focusstatus'), nullable=False),
    sa.Column('white_noise_type', sa.Integer(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('focus_sessions', schema=None) as batch_op:
        batch_op.create_index('idx_focus_user_time', ['user_id', 'start_time'], unique=False)
        batch_op.create_index(batch_op.f('ix_focus_sessions_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_focus_sessions_task_id'), ['task_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_focus_sessions_user_id'), ['user_id'], unique=False)

    op.create_table('group_task_claims',
    sa.Column('group_task_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('personal_task_id', app.models.base.GUID(), nullable=True),
    sa.Column('is_completed', sa.Boolean(), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('claimed_at', sa.DateTime(), nullable=False),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['group_task_id'], ['group_tasks.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['personal_task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('group_task_id', 'user_id', name='uq_task_claim')
    )
    with op.batch_alter_table('group_task_claims', schema=None) as batch_op:
        batch_op.create_index('idx_claim_task', ['group_task_id'], unique=False)
        batch_op.create_index('idx_claim_user', ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_task_claims_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_task_claims_group_task_id'), ['group_task_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_group_task_claims_user_id'), ['user_id'], unique=False)

    op.create_table('node_expansion_queue',
    sa.Column('trigger_node_id', app.models.base.GUID(), nullable=False),
    sa.Column('trigger_task_id', app.models.base.GUID(), nullable=True),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('expansion_context', sa.Text(), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=True),
    sa.Column('expanded_nodes', sa.JSON(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('prompt_version', sa.String(length=50), nullable=True),
    sa.Column('model_name', sa.String(length=50), nullable=True),
    sa.Column('processed_at', sa.DateTime(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['trigger_node_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['trigger_task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('node_expansion_queue', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_node_expansion_queue_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_node_expansion_queue_status'), ['status'], unique=False)
        batch_op.create_index(batch_op.f('ix_node_expansion_queue_user_id'), ['user_id'], unique=False)

    op.create_table('study_records',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('node_id', app.models.base.GUID(), nullable=False),
    sa.Column('task_id', app.models.base.GUID(), nullable=True),
    sa.Column('study_minutes', sa.Integer(), nullable=False),
    sa.Column('mastery_delta', sa.Float(), nullable=False),
    sa.Column('initial_mastery', sa.Float(), nullable=True),
    sa.Column('record_type', sa.String(length=20), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['node_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('study_records', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_study_records_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_study_records_node_id'), ['node_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_study_records_user_id'), ['user_id'], unique=False)

    op.create_table('word_books',
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('word', sa.String(length=100), nullable=False),
    sa.Column('phonetic', sa.String(length=100), nullable=True),
    sa.Column('definition', sa.Text(), nullable=False),
    sa.Column('mastery_level', sa.Integer(), nullable=True),
    sa.Column('next_review_at', sa.DateTime(), nullable=True),
    sa.Column('last_review_at', sa.DateTime(), nullable=True),
    sa.Column('review_count', sa.Integer(), nullable=True),
    sa.Column('context_sentence', sa.Text(), nullable=True),
    sa.Column('source_task_id', app.models.base.GUID(), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['source_task_id'], ['tasks.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'word', name='uq_user_word')
    )
    with op.batch_alter_table('word_books', schema=None) as batch_op:
        batch_op.create_index('idx_wordbook_review', ['user_id', 'next_review_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_word_books_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_word_books_user_id'), ['user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_word_books_word'), ['word'], unique=False)

    op.create_table('expansion_feedback',
    sa.Column('expansion_queue_id', app.models.base.GUID(), nullable=True),
    sa.Column('trigger_node_id', app.models.base.GUID(), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('rating', sa.Integer(), nullable=True),
    sa.Column('implicit_score', sa.Float(), nullable=True),
    sa.Column('feedback_type', sa.String(length=20), nullable=True),
    sa.Column('prompt_version', sa.String(length=50), nullable=True),
    sa.Column('model_name', sa.String(length=50), nullable=True),
    sa.Column('meta_data', sa.JSON(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['expansion_queue_id'], ['node_expansion_queue.id'], ),
    sa.ForeignKeyConstraint(['trigger_node_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('expansion_feedback', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_expansion_feedback_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_expansion_feedback_expansion_queue_id'), ['expansion_queue_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_expansion_feedback_trigger_node_id'), ['trigger_node_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_expansion_feedback_user_id'), ['user_id'], unique=False)

    op.create_table('shared_resources',
    sa.Column('group_id', app.models.base.GUID(), nullable=True),
    sa.Column('target_user_id', app.models.base.GUID(), nullable=True),
    sa.Column('shared_by', app.models.base.GUID(), nullable=False),
    sa.Column('plan_id', app.models.base.GUID(), nullable=True),
    sa.Column('task_id', app.models.base.GUID(), nullable=True),
    sa.Column('cognitive_fragment_id', app.models.base.GUID(), nullable=True),
    sa.Column('curiosity_capsule_id', app.models.base.GUID(), nullable=True),
    sa.Column('behavior_pattern_id', app.models.base.GUID(), nullable=True),
    sa.Column('permission', sa.String(length=20), nullable=False),
    sa.Column('comment', sa.Text(), nullable=True),
    sa.Column('view_count', sa.Integer(), nullable=True),
    sa.Column('save_count', sa.Integer(), nullable=True),
    sa.Column('id', app.models.base.GUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['behavior_pattern_id'], ['behavior_patterns.id'], ),
    sa.ForeignKeyConstraint(['cognitive_fragment_id'], ['cognitive_fragments.id'], ),
    sa.ForeignKeyConstraint(['curiosity_capsule_id'], ['curiosity_capsules.id'], ),
    sa.ForeignKeyConstraint(['group_id'], ['groups.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['plan_id'], ['plans.id'], ),
    sa.ForeignKeyConstraint(['shared_by'], ['users.id'], ),
    sa.ForeignKeyConstraint(['target_user_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['task_id'], ['tasks.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('shared_resources', schema=None) as batch_op:
        batch_op.create_index('idx_share_group', ['group_id'], unique=False)
        batch_op.create_index('idx_share_resource_capsule', ['curiosity_capsule_id'], unique=False)
        batch_op.create_index('idx_share_resource_pattern', ['behavior_pattern_id'], unique=False)
        batch_op.create_index('idx_share_resource_plan', ['plan_id'], unique=False)
        batch_op.create_index('idx_share_target_user', ['target_user_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_shared_resources_deleted_at'), ['deleted_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_shared_resources_group_id'), ['group_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_shared_resources_target_user_id'), ['target_user_id'], unique=False)

    # ### CQRS Infrastructure Tables ###
    op.create_table('event_outbox',
    sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
    sa.Column('aggregate_type', sa.String(length=100), nullable=False),
    sa.Column('aggregate_id', sa.String(length=100), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('event_version', sa.Integer(), nullable=False),
    sa.Column('payload', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('sequence_number', sa.BigInteger(), sa.Identity(always=False), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('published_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_outbox_aggregate', 'event_outbox', ['aggregate_type', 'aggregate_id'])
    op.create_index('idx_outbox_published', 'event_outbox', ['published_at'])

    op.create_table('event_store',
    sa.Column('id', sa.BigInteger(), sa.Identity(always=False), nullable=False),
    sa.Column('aggregate_type', sa.String(length=100), nullable=False),
    sa.Column('aggregate_id', sa.String(length=100), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('event_version', sa.Integer(), nullable=False),
    sa.Column('sequence_number', sa.BigInteger(), nullable=False),
    sa.Column('payload', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('idx_store_aggregate', 'event_store', ['aggregate_type', 'aggregate_id'])
    op.create_index('idx_store_aggregate_seq', 'event_store', ['aggregate_type', 'aggregate_id', 'sequence_number'], unique=True)

    op.create_table('processed_events',
    sa.Column('event_id', postgresql.UUID(as_uuid=True), nullable=False),
    sa.Column('consumer_group', sa.String(length=100), nullable=False),
    sa.Column('processed_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('event_id', 'consumer_group')
    )

    op.create_table('projection_metadata',
    sa.Column('projection_name', sa.String(length=100), nullable=False),
    sa.Column('status', sa.String(length=20), nullable=False),
    sa.Column('last_processed_position', sa.BigInteger(), server_default='0', nullable=False),
    sa.Column('last_processed_at', sa.DateTime(), nullable=True),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('projection_name')
    )

    op.create_table('projection_snapshots',
    sa.Column('id', postgresql.UUID(as_uuid=True), nullable=False),
    sa.Column('projection_name', sa.String(length=100), nullable=False),
    sa.Column('aggregate_id', sa.String(length=100), nullable=True),
    sa.Column('snapshot_data', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('stream_position', sa.BigInteger(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('projection_name', 'aggregate_id', name='uq_projection_snapshot')
    )
    op.create_index('idx_snapshot_projection_aggregate', 'projection_snapshots', ['projection_name', 'aggregate_id'])

    op.create_table('outbox_events',
    sa.Column('id', sa.Integer(), sa.Identity(always=False), nullable=False),
    sa.Column('event_type', sa.String(length=100), nullable=False),
    sa.Column('payload', sa.JSON(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('processed', sa.Boolean(), server_default='false', nullable=True),
    sa.PrimaryKeyConstraint('id')
    )

    op.create_table('mastery_audit_log',
    sa.Column('id', sa.Integer(), sa.Identity(always=False), nullable=False),
    sa.Column('user_id', app.models.base.GUID(), nullable=False),
    sa.Column('node_id', app.models.base.GUID(), nullable=False),
    sa.Column('old_mastery', sa.Float(), nullable=False),
    sa.Column('new_mastery', sa.Float(), nullable=False),
    sa.Column('change_reason', sa.String(length=100), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['node_id'], ['knowledge_nodes.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )

    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('mastery_audit_log')
    op.drop_table('outbox_events')
    op.drop_table('projection_snapshots')
    op.drop_table('projection_metadata')
    op.drop_table('processed_events')
    op.drop_table('event_store')
    op.drop_table('event_outbox')

    with op.batch_alter_table('shared_resources', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_shared_resources_target_user_id'))
        batch_op.drop_index(batch_op.f('ix_shared_resources_group_id'))
        batch_op.drop_index(batch_op.f('ix_shared_resources_deleted_at'))
        batch_op.drop_index('idx_share_target_user')
        batch_op.drop_index('idx_share_resource_plan')
        batch_op.drop_index('idx_share_resource_pattern')
        batch_op.drop_index('idx_share_resource_capsule')
        batch_op.drop_index('idx_share_group')

    op.drop_table('shared_resources')
    with op.batch_alter_table('expansion_feedback', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_expansion_feedback_user_id'))
        batch_op.drop_index(batch_op.f('ix_expansion_feedback_trigger_node_id'))
        batch_op.drop_index(batch_op.f('ix_expansion_feedback_expansion_queue_id'))
        batch_op.drop_index(batch_op.f('ix_expansion_feedback_deleted_at'))

    op.drop_table('expansion_feedback')
    with op.batch_alter_table('word_books', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_word_books_word'))
        batch_op.drop_index(batch_op.f('ix_word_books_user_id'))
        batch_op.drop_index(batch_op.f('ix_word_books_deleted_at'))
        batch_op.drop_index('idx_wordbook_review')

    op.drop_table('word_books')
    with op.batch_alter_table('study_records', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_study_records_user_id'))
        batch_op.drop_index(batch_op.f('ix_study_records_node_id'))
        batch_op.drop_index(batch_op.f('ix_study_records_deleted_at'))

    op.drop_table('study_records')
    with op.batch_alter_table('node_expansion_queue', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_node_expansion_queue_user_id'))
        batch_op.drop_index(batch_op.f('ix_node_expansion_queue_status'))
        batch_op.drop_index(batch_op.f('ix_node_expansion_queue_deleted_at'))

    op.drop_table('node_expansion_queue')
    with op.batch_alter_table('group_task_claims', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_group_task_claims_user_id'))
        batch_op.drop_index(batch_op.f('ix_group_task_claims_group_task_id'))
        batch_op.drop_index(batch_op.f('ix_group_task_claims_deleted_at'))
        batch_op.drop_index('idx_claim_user')
        batch_op.drop_index('idx_claim_task')

    op.drop_table('group_task_claims')
    with op.batch_alter_table('focus_sessions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_focus_sessions_user_id'))
        batch_op.drop_index(batch_op.f('ix_focus_sessions_task_id'))
        batch_op.drop_index(batch_op.f('ix_focus_sessions_deleted_at'))
        batch_op.drop_index('idx_focus_user_time')

    op.drop_table('focus_sessions')
    with op.batch_alter_table('curiosity_capsules', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_curiosity_capsules_user_id'))
        batch_op.drop_index(batch_op.f('ix_curiosity_capsules_related_task_id'))
        batch_op.drop_index(batch_op.f('ix_curiosity_capsules_deleted_at'))

    op.drop_table('curiosity_capsules')
    with op.batch_alter_table('cognitive_fragments', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_cognitive_fragments_user_id'))
        batch_op.drop_index(batch_op.f('ix_cognitive_fragments_source_event_id'))
        batch_op.drop_index(batch_op.f('ix_cognitive_fragments_deleted_at'))

    op.drop_table('cognitive_fragments')
    with op.batch_alter_table('chat_messages', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_chat_messages_user_id'))
        batch_op.drop_index(batch_op.f('ix_chat_messages_session_id'))
        batch_op.drop_index(batch_op.f('ix_chat_messages_deleted_at'))
        batch_op.drop_index('idx_chat_user_id')
        batch_op.drop_index('idx_chat_task_id')
        batch_op.drop_index('idx_chat_session_id')
        batch_op.drop_index('idx_chat_role')
        batch_op.drop_index('idx_chat_created_at')

    op.drop_table('chat_messages')
    with op.batch_alter_table('user_node_status', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_node_status_next_review_at'))

    op.drop_table('user_node_status')
    with op.batch_alter_table('tasks', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_tasks_user_id'))
        batch_op.drop_index(batch_op.f('ix_tasks_tool_result_id'))
        batch_op.drop_index(batch_op.f('ix_tasks_status'))
        batch_op.drop_index(batch_op.f('ix_tasks_plan_id'))
        batch_op.drop_index(batch_op.f('ix_tasks_deleted_at'))
        batch_op.drop_index('idx_tasks_user_id')
        batch_op.drop_index('idx_tasks_status')
        batch_op.drop_index('idx_tasks_plan_id')
        batch_op.drop_index('idx_tasks_due_date')
        batch_op.drop_index('idx_tasks_created_at')

    op.drop_table('tasks')
    with op.batch_alter_table('post_likes', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_post_likes_deleted_at'))
        batch_op.drop_index('idx_post_like_user')
        batch_op.drop_index('idx_post_like_post')

    op.drop_table('post_likes')
    with op.batch_alter_table('node_relations', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_node_relations_target_node_id'))
        batch_op.drop_index(batch_op.f('ix_node_relations_source_node_id'))
        batch_op.drop_index(batch_op.f('ix_node_relations_deleted_at'))

    op.drop_table('node_relations')
    with op.batch_alter_table('message_reports', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_message_reports_reporter_id'))
        batch_op.drop_index(batch_op.f('ix_message_reports_deleted_at'))
        batch_op.drop_index('idx_message_reports_status')
        batch_op.drop_index('idx_message_reports_group_msg')

    op.drop_table('message_reports')
    with op.batch_alter_table('message_favorites', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_message_favorites_user_id'))
        batch_op.drop_index(batch_op.f('ix_message_favorites_deleted_at'))
        batch_op.drop_index('idx_message_favorites_user')

    op.drop_table('message_favorites')
    with op.batch_alter_table('intervention_feedback', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_intervention_feedback_user_id'))
        batch_op.drop_index(batch_op.f('ix_intervention_feedback_request_id'))
        batch_op.drop_index(batch_op.f('ix_intervention_feedback_feedback_type'))
        batch_op.drop_index(batch_op.f('ix_intervention_feedback_deleted_at'))

    op.drop_table('intervention_feedback')
    with op.batch_alter_table('intervention_audit_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_intervention_audit_logs_user_id'))
        batch_op.drop_index(batch_op.f('ix_intervention_audit_logs_request_id'))
        batch_op.drop_index(batch_op.f('ix_intervention_audit_logs_occurred_at'))
        batch_op.drop_index(batch_op.f('ix_intervention_audit_logs_deleted_at'))

    op.drop_table('intervention_audit_logs')
    with op.batch_alter_table('group_files', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_group_files_shared_by_id'))
        batch_op.drop_index(batch_op.f('ix_group_files_group_id'))
        batch_op.drop_index(batch_op.f('ix_group_files_file_id'))
        batch_op.drop_index(batch_op.f('ix_group_files_deleted_at'))
        batch_op.drop_index('idx_group_files_shared_by')
        batch_op.drop_index('idx_group_files_group')
        batch_op.drop_index('idx_group_files_file')
        batch_op.drop_index('idx_group_files_category')

    op.drop_table('group_files')
    op.drop_table('galaxy_user_permissions')
    with op.batch_alter_table('document_chunks', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_document_chunks_user_id'))
        batch_op.drop_index(batch_op.f('ix_document_chunks_file_id'))
        batch_op.drop_index(batch_op.f('ix_document_chunks_deleted_at'))

    op.drop_table('document_chunks')
    op.drop_table('crdt_snapshots')
    with op.batch_alter_table('crdt_operation_log', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_crdt_operation_log_timestamp'))
        batch_op.drop_index(batch_op.f('ix_crdt_operation_log_galaxy_id'))

    op.drop_table('crdt_operation_log')
    with op.batch_alter_table('user_state_snapshots', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_state_snapshots_user_id'))
        batch_op.drop_index(batch_op.f('ix_user_state_snapshots_snapshot_at'))
        batch_op.drop_index(batch_op.f('ix_user_state_snapshots_deleted_at'))

    op.drop_table('user_state_snapshots')
    with op.batch_alter_table('user_persona_keys', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_persona_keys_user_id'))
        batch_op.drop_index(batch_op.f('ix_user_persona_keys_key_id'))
        batch_op.drop_index(batch_op.f('ix_user_persona_keys_deleted_at'))

    op.drop_table('user_persona_keys')
    with op.batch_alter_table('user_irt_ability', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_irt_ability_user_id'))
        batch_op.drop_index(batch_op.f('ix_user_irt_ability_subject_id'))
        batch_op.drop_index(batch_op.f('ix_user_irt_ability_deleted_at'))

    op.drop_table('user_irt_ability')
    with op.batch_alter_table('user_intervention_settings', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_intervention_settings_user_id'))
        batch_op.drop_index(batch_op.f('ix_user_intervention_settings_deleted_at'))

    op.drop_table('user_intervention_settings')
    with op.batch_alter_table('user_encryption_keys', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_encryption_keys_user_id'))
        batch_op.drop_index(batch_op.f('ix_user_encryption_keys_deleted_at'))
        batch_op.drop_index('idx_user_encryption_keys_user')

    op.drop_table('user_encryption_keys')
    with op.batch_alter_table('user_daily_metrics', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_user_daily_metrics_user_id'))
        batch_op.drop_index(batch_op.f('ix_user_daily_metrics_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_user_daily_metrics_date'))

    op.drop_table('user_daily_metrics')
    with op.batch_alter_table('tracking_events', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_tracking_events_user_id'))
        batch_op.drop_index(batch_op.f('ix_tracking_events_ts_ms'))
        batch_op.drop_index(batch_op.f('ix_tracking_events_event_type'))
        batch_op.drop_index(batch_op.f('ix_tracking_events_event_id'))
        batch_op.drop_index(batch_op.f('ix_tracking_events_deleted_at'))

    op.drop_table('tracking_events')
    with op.batch_alter_table('token_usage', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_token_usage_user_id'))
        batch_op.drop_index(batch_op.f('ix_token_usage_session_id'))
        batch_op.drop_index(batch_op.f('ix_token_usage_deleted_at'))
        batch_op.drop_index('idx_token_usage_user_id')
        batch_op.drop_index('idx_token_usage_session_id')
        batch_op.drop_index('idx_token_usage_created_at')

    op.drop_table('token_usage')
    with op.batch_alter_table('system_config_change_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_system_config_change_logs_id'))
        batch_op.drop_index(batch_op.f('ix_system_config_change_logs_config_key'))
        batch_op.drop_index(batch_op.f('ix_system_config_change_logs_changed_by'))
        batch_op.drop_index(batch_op.f('ix_system_config_change_logs_changed_at'))

    op.drop_table('system_config_change_logs')
    with op.batch_alter_table('strategy_nodes', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_strategy_nodes_user_id'))
        batch_op.drop_index(batch_op.f('ix_strategy_nodes_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_strategy_nodes_content_hash'))

    op.drop_table('strategy_nodes')
    with op.batch_alter_table('stored_files', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_stored_files_user_id'))
        batch_op.drop_index(batch_op.f('ix_stored_files_deleted_at'))

    op.drop_table('stored_files')
    with op.batch_alter_table('security_audit_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_security_audit_logs_user_id'))
        batch_op.drop_index(batch_op.f('ix_security_audit_logs_timestamp'))
        batch_op.drop_index(batch_op.f('ix_security_audit_logs_threat_level'))
        batch_op.drop_index(batch_op.f('ix_security_audit_logs_resource'))
        batch_op.drop_index(batch_op.f('ix_security_audit_logs_ip_address'))
        batch_op.drop_index(batch_op.f('ix_security_audit_logs_id'))
        batch_op.drop_index(batch_op.f('ix_security_audit_logs_event_type'))

    op.drop_table('security_audit_logs')
    with op.batch_alter_table('push_preferences', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_push_preferences_user_id'))
        batch_op.drop_index(batch_op.f('ix_push_preferences_deleted_at'))

    op.drop_table('push_preferences')
    with op.batch_alter_table('push_histories', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_push_histories_user_id'))
        batch_op.drop_index(batch_op.f('ix_push_histories_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_push_histories_content_hash'))

    op.drop_table('push_histories')
    with op.batch_alter_table('private_messages', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_private_messages_thread_root_id'))
        batch_op.drop_index(batch_op.f('ix_private_messages_sender_id'))
        batch_op.drop_index(batch_op.f('ix_private_messages_receiver_id'))
        batch_op.drop_index(batch_op.f('ix_private_messages_deleted_at'))
        batch_op.drop_index('idx_private_message_thread')
        batch_op.drop_index('idx_private_message_receiver_unread')
        batch_op.drop_index('idx_private_message_conversation')

    op.drop_table('private_messages')
    with op.batch_alter_table('posts', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_posts_user_id'))
        batch_op.drop_index(batch_op.f('ix_posts_deleted_at'))

    op.drop_table('posts')
    with op.batch_alter_table('plans', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_plans_user_id'))
        batch_op.drop_index(batch_op.f('ix_plans_is_active'))
        batch_op.drop_index(batch_op.f('ix_plans_deleted_at'))
        batch_op.drop_index('idx_plans_user_id')
        batch_op.drop_index('idx_plans_type')
        batch_op.drop_index('idx_plans_target_date')
        batch_op.drop_index('idx_plans_is_active')

    op.drop_table('plans')
    with op.batch_alter_table('persona_snapshots', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_persona_snapshots_user_id'))
        batch_op.drop_index(batch_op.f('ix_persona_snapshots_source_event_id'))
        batch_op.drop_index(batch_op.f('ix_persona_snapshots_persona_version'))
        batch_op.drop_index(batch_op.f('ix_persona_snapshots_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_persona_snapshots_audit_token'))

    op.drop_table('persona_snapshots')
    with op.batch_alter_table('offline_message_queue', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_offline_message_queue_user_id'))
        batch_op.drop_index(batch_op.f('ix_offline_message_queue_deleted_at'))
        batch_op.drop_index('idx_offline_queue_user_status')

    op.drop_table('offline_message_queue')
    with op.batch_alter_table('notifications', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_notifications_user_id'))
        batch_op.drop_index(batch_op.f('ix_notifications_deleted_at'))

    op.drop_table('notifications')
    with op.batch_alter_table('nightly_reviews', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_nightly_reviews_user_id'))
        batch_op.drop_index(batch_op.f('ix_nightly_reviews_review_date'))
        batch_op.drop_index(batch_op.f('ix_nightly_reviews_deleted_at'))

    op.drop_table('nightly_reviews')
    with op.batch_alter_table('login_attempts', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_login_attempts_username'))
        batch_op.drop_index(batch_op.f('ix_login_attempts_user_id'))
        batch_op.drop_index(batch_op.f('ix_login_attempts_success'))
        batch_op.drop_index(batch_op.f('ix_login_attempts_ip_address'))
        batch_op.drop_index(batch_op.f('ix_login_attempts_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_login_attempts_attempted_at'))

    op.drop_table('login_attempts')
    with op.batch_alter_table('legal_holds', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_legal_holds_user_id'))
        batch_op.drop_index(batch_op.f('ix_legal_holds_device_id'))
        batch_op.drop_index(batch_op.f('ix_legal_holds_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_legal_holds_case_ref'))

    op.drop_table('legal_holds')
    with op.batch_alter_table('knowledge_nodes', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_knowledge_nodes_subject_id'))
        batch_op.drop_index(batch_op.f('ix_knowledge_nodes_position_y'))
        batch_op.drop_index(batch_op.f('ix_knowledge_nodes_position_x'))
        batch_op.drop_index(batch_op.f('ix_knowledge_nodes_parent_id'))
        batch_op.drop_index(batch_op.f('ix_knowledge_nodes_deleted_at'))

    op.drop_table('knowledge_nodes')
    with op.batch_alter_table('jobs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_jobs_user_id'))
        batch_op.drop_index(batch_op.f('ix_jobs_deleted_at'))
        batch_op.drop_index('idx_jobs_user_id')
        batch_op.drop_index('idx_jobs_status_timeout', postgresql_where=sa.text("status = 'running'"))
        batch_op.drop_index('idx_jobs_status')

    op.drop_table('jobs')
    with op.batch_alter_table('intervention_requests', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_intervention_requests_user_id'))
        batch_op.drop_index(batch_op.f('ix_intervention_requests_topic'))
        batch_op.drop_index(batch_op.f('ix_intervention_requests_status'))
        batch_op.drop_index(batch_op.f('ix_intervention_requests_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_intervention_requests_dedupe_key'))

    op.drop_table('intervention_requests')
    with op.batch_alter_table('idempotency_keys', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_idempotency_keys_user_id'))
        batch_op.drop_index(batch_op.f('ix_idempotency_keys_expires_at'))
        batch_op.drop_index('idx_idempotency_expires')

    op.drop_table('idempotency_keys')
    with op.batch_alter_table('group_tasks', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_group_tasks_group_id'))
        batch_op.drop_index(batch_op.f('ix_group_tasks_deleted_at'))
        batch_op.drop_index('idx_group_task_group')

    op.drop_table('group_tasks')
    with op.batch_alter_table('group_messages', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_group_messages_thread_root_id'))
        batch_op.drop_index(batch_op.f('ix_group_messages_group_id'))
        batch_op.drop_index(batch_op.f('ix_group_messages_deleted_at'))
        batch_op.drop_index('idx_message_group_time')
        batch_op.drop_index('idx_message_group_thread')

    op.drop_table('group_messages')
    with op.batch_alter_table('group_members', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_group_members_user_id'))
        batch_op.drop_index(batch_op.f('ix_group_members_group_id'))
        batch_op.drop_index(batch_op.f('ix_group_members_deleted_at'))
        batch_op.drop_index('idx_member_user')
        batch_op.drop_index('idx_member_group')

    op.drop_table('group_members')
    with op.batch_alter_table('friendships', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_friendships_user_id'))
        batch_op.drop_index(batch_op.f('ix_friendships_friend_id'))
        batch_op.drop_index(batch_op.f('ix_friendships_deleted_at'))
        batch_op.drop_index('idx_friendship_user')
        batch_op.drop_index('idx_friendship_status')
        batch_op.drop_index('idx_friendship_friend')

    op.drop_table('friendships')
    with op.batch_alter_table('error_records', schema=None) as batch_op:
        batch_op.drop_index('idx_errors_user_review', postgresql_where=sa.text('mastery_level < 1.0'))
        batch_op.drop_index('idx_errors_subject')
        batch_op.drop_index('idx_error_records_cognitive_tags', postgresql_using='gin')

    op.drop_table('error_records')
    with op.batch_alter_table('dlq_replay_audit_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_dlq_replay_audit_logs_message_id'))
        batch_op.drop_index(batch_op.f('ix_dlq_replay_audit_logs_deleted_at'))

    op.drop_table('dlq_replay_audit_logs')
    with op.batch_alter_table('data_access_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_data_access_logs_user_id'))
        batch_op.drop_index(batch_op.f('ix_data_access_logs_resource_type'))
        batch_op.drop_index(batch_op.f('ix_data_access_logs_resource_id'))
        batch_op.drop_index(batch_op.f('ix_data_access_logs_ip_address'))
        batch_op.drop_index(batch_op.f('ix_data_access_logs_id'))
        batch_op.drop_index(batch_op.f('ix_data_access_logs_action'))
        batch_op.drop_index(batch_op.f('ix_data_access_logs_accessed_at'))

    op.drop_table('data_access_logs')
    with op.batch_alter_table('crypto_shredding_certificates', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_crypto_shredding_certificates_user_id'))
        batch_op.drop_index(batch_op.f('ix_crypto_shredding_certificates_deleted_at'))

    op.drop_table('crypto_shredding_certificates')
    with op.batch_alter_table('compliance_check_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_compliance_check_logs_id'))
        batch_op.drop_index(batch_op.f('ix_compliance_check_logs_executed_by'))
        batch_op.drop_index(batch_op.f('ix_compliance_check_logs_executed_at'))
        batch_op.drop_index(batch_op.f('ix_compliance_check_logs_check_type'))

    op.drop_table('compliance_check_logs')
    with op.batch_alter_table('collaborative_galaxies', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_collaborative_galaxies_deleted_at'))

    op.drop_table('collaborative_galaxies')
    with op.batch_alter_table('broadcast_messages', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_broadcast_messages_sender_id'))
        batch_op.drop_index(batch_op.f('ix_broadcast_messages_deleted_at'))

    op.drop_table('broadcast_messages')
    with op.batch_alter_table('behavior_patterns', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_behavior_patterns_user_id'))
        batch_op.drop_index(batch_op.f('ix_behavior_patterns_deleted_at'))

    op.drop_table('behavior_patterns')
    with op.batch_alter_table('users', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_users_wechat_unionid'))
        batch_op.drop_index(batch_op.f('ix_users_google_id'))
        batch_op.drop_index(batch_op.f('ix_users_deleted_at'))
        batch_op.drop_index(batch_op.f('ix_users_apple_id'))
        batch_op.drop_index('idx_users_username')
        batch_op.drop_index('idx_users_email')

    op.drop_table('users')
    with op.batch_alter_table('subjects', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_subjects_name'))
        batch_op.drop_index(batch_op.f('ix_subjects_is_active'))
        batch_op.drop_index(batch_op.f('ix_subjects_category'))

    op.drop_table('subjects')
    with op.batch_alter_table('semantic_links', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_semantic_links_target_type'))
        batch_op.drop_index(batch_op.f('ix_semantic_links_target_id'))
        batch_op.drop_index(batch_op.f('ix_semantic_links_source_type'))
        batch_op.drop_index(batch_op.f('ix_semantic_links_source_id'))
        batch_op.drop_index(batch_op.f('ix_semantic_links_relation_type'))
        batch_op.drop_index(batch_op.f('ix_semantic_links_deleted_at'))

    op.drop_table('semantic_links')
    with op.batch_alter_table('irt_item_parameters', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_irt_item_parameters_subject_id'))
        batch_op.drop_index(batch_op.f('ix_irt_item_parameters_question_id'))
        batch_op.drop_index(batch_op.f('ix_irt_item_parameters_deleted_at'))

    op.drop_table('irt_item_parameters')
    with op.batch_alter_table('groups', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_groups_deleted_at'))
        batch_op.drop_index('idx_group_type')
        batch_op.drop_index('idx_group_public')

    op.drop_table('groups')
    with op.batch_alter_table('dictionary_entries', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_dictionary_entries_word'))
        batch_op.drop_index(batch_op.f('ix_dictionary_entries_deleted_at'))
        batch_op.drop_index('idx_dict_word')

    op.drop_table('dictionary_entries')
    # ### end Alembic commands ###
