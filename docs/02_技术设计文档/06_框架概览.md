# Sparkle项目框架概览与模块关系

## 项目整体架构

Sparkle项目采用前后端分离的微服务架构，后端使用FastAPI框架构建RESTful API，前端使用Flutter框架构建跨平台移动应用。项目围绕AI驱动的学习助手概念，构建了一个完整的学习生态系统。

## 后端架构设计

### 核心服务层
- **UserService**: 用户认证与管理 (基础实现)
- **GalaxyService**: 知识星图核心服务 (完整实现)
- **TaskService**: 任务管理服务 (完整实现)
- **PlanService**: 计划管理服务 (API定义完整，实现有限)
- **LLMService**: 大语言模型服务 (完整实现)
- **PushService**: 智能推送服务 (完整实现)

### 数据访问层
- **Models**: SQLAlchemy数据模型定义
- **Schemas**: Pydantic数据验证模型
- **Database**: 异步数据库操作 (PostgreSQL/SQLite)

### 业务逻辑层
- **Orchestration**: 响应编排与工具执行
- **Tools**: AI工具系统
- **Workers**: 后台任务处理

## 前端架构设计

### UI层
- **Screens**: 页面组件 (登录、任务、星图、聊天等)
- **Widgets**: 可复用UI组件
- **Animations**: 交互动画 (星图、火焰效果等)

### 业务逻辑层
- **Providers**: Riverpod状态管理
- **Repositories**: 数据访问层
- **Models**: 数据模型定义

## 模块功能与关系

### 1. 用户模块 (User Module)
- **功能**: 认证、授权、用户资料管理
- **依赖**: 独立模块，为其他模块提供用户上下文
- **API端点**: `/api/v1/auth/`
- **前端组件**: AuthScreen, ProfileScreen

### 2. 知识星图模块 (Galaxy Module)
- **功能**: 知识点管理、学习进度跟踪、语义搜索
- **依赖**: 用户模块、AI模块
- **API端点**: `/api/v1/galaxy/`
- **前端组件**: GalaxyScreen, 星图可视化组件
- **核心逻辑**: 
  - 星图数据获取与渲染
  - 节点点亮与学习进度更新
  - 知识点扩展与遗忘曲线

### 3. 任务模块 (Task Module)
- **功能**: 任务创建、执行、状态管理
- **依赖**: 用户模块、知识星图模块
- **API端点**: `/api/v1/tasks/`
- **前端组件**: TaskListScreen, TaskDetailScreen, TaskExecutionScreen
- **核心逻辑**:
  - 任务生命周期管理
  - 任务与知识点关联

### 4. 计划模块 (Plan Module)
- **功能**: 冲刺计划、成长计划管理
- **依赖**: 用户模块、任务模块
- **API端点**: `/api/v1/plans/`
- **前端组件**: SprintScreen, GrowthScreen
- **注**: 前端实现完整，后端API实现有限

### 5. AI对话模块 (Chat Module)
- **功能**: 智能对话、工具调用、内容生成
- **依赖**: 所有其他模块
- **API端点**: `/api/v1/chat/`
- **前端组件**: ChatScreen
- **核心逻辑**:
  - 工具调用系统
  - 流式响应处理
  - 对话上下文管理

### 6. 推送模块 (Push Module)
- **功能**: 智能个性化推送
- **依赖**: 用户模块、知识星图模块、计划模块
- **API端点**: `/api/v1/notifications/`, `/api/v1/push/`
- **核心逻辑**:
  - 多策略推送评估
  - 个性化内容生成
  - 频率控制机制

## 数据流与交互关系

### 用户认证流程
```
客户端 → Auth API → UserService → JWT Token → 客户端
```

### 学习流程
```
用户 → GalaxyScreen → Spark Node → Galaxy API → GalaxyService → 更新学习进度
```

### AI交互流程
```
用户输入 → Chat API → LLMService → ToolExecutor → 工具调用 → 响应返回
```

### 推送流程
```
SchedulerService → PushService → 推送策略评估 → LLM生成内容 → 通知发送
```

## 技术亮点

### 后端亮点
- **异步处理**: 全面采用异步操作提升性能
- **向量搜索**: 基于pgvector的语义搜索
- **工具系统**: 可扩展的AI工具调用机制
- **SSE推送**: 实时事件推送机制

### 前端亮点
- **可视化星图**: 基于Shader的动态星图渲染
- **状态管理**: Riverpod驱动的状态管理
- **响应式设计**: 适配不同屏幕尺寸
- **动画效果**: 流畅的交互动画

## 模块间依赖关系

```
        +------------------+
        |   用户模块       |
        |   (核心依赖)     |
        +--------+---------+
                 |
        +--------v---------+
        |   知识星图模块    |
        +--------+---------+
                 |
        +--------v---------+
        |   任务模块       |
        +--------+---------+
                 |
        +--------v---------+
        |   计划模块       |
        +--------+---------+
                 |
        +--------v---------+
        |   AI对话模块     |
        +--------+---------+
                 |
        +--------v---------+
        |   推送模块       |
        +------------------+
```

## 扩展性与维护性

### 模块化设计
- 各模块职责明确，低耦合
- API接口标准化
- 易于独立开发和测试

### 可扩展性
- 插件式工具系统
- 可配置的推送策略
- 支持多AI提供商

### 维护性
- 统一的错误处理机制
- 详细的日志记录
- 标准化的数据验证

## 当前实现状态

- **完整实现**: 用户、知识星图、任务、AI对话、推送模块
- **部分实现**: 计划模块(前端完整，后端API实现有限)
- **待完善**: 计划模块后端业务逻辑
