# Sparkle 数据库设计文档

> **版本**: v2.0
> **日期**: 2026-01-10
> **数据库**: PostgreSQL 16 + pgvector

## 概述

本文档描述了 Sparkle 应用的核心数据库模型设计。我们使用 PostgreSQL 作为主数据库，并启用 `pgvector` 扩展来存储和检索高维向量。

## 核心表结构

### 1. 知识体系 (Galaxy System)

#### `knowledge_nodes` (知识节点表)
核心表，存储知识图谱的节点。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | PK |
| name | VARCHAR(255) | 节点名称 |
| description | TEXT | 详细描述 |
| keywords | JSONB | 关键词列表 |
| embedding | VECTOR(1536) | 语义向量 (OpenAI ada-002) |
| parent_id | UUID | 父节点 ID (树状结构) |
| layer | INTEGER | 层级 (0=Root, 1=Subject, etc.) |
| is_active | BOOLEAN | 是否可见 |
| created_at | TIMESTAMP | |

#### `node_relations` (节点关系表)
定义节点之间的网状关系。

| 字段 | 类型 | 说明 |
|------|------|------|
| source_id | UUID | 源节点 |
| target_id | UUID | 目标节点 |
| relation_type | VARCHAR(50) | 关系类型 (requires, related_to) |
| strength | FLOAT | 关联强度 (0.0 - 1.0) |

#### `user_node_status` (用户学习状态)
记录用户对每个节点的掌握情况。

| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | UUID | 用户 ID |
| node_id | UUID | 节点 ID |
| mastery_level | INTEGER | 掌握度 (0-100) |
| last_reviewed_at | TIMESTAMP | 上次复习时间 |
| next_review_at | TIMESTAMP | 下次复习时间 (基于遗忘曲线) |
| is_unlocked | BOOLEAN | 是否已解锁 |

### 2. 用户体系 (User System)

#### `users` (用户表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | PK |
| username | VARCHAR | |
| email | VARCHAR | |
| password_hash | VARCHAR | |
| flame_level | INTEGER | 火花等级 |
| settings | JSONB | 用户偏好设置 |

### 3. 任务与计划 (Task & Plan)

#### `tasks` (任务表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | PK |
| user_id | UUID | FK |
| title | VARCHAR | |
| status | VARCHAR | pending, in_progress, completed |
| type | VARCHAR | learning, practice, exam |
| node_id | UUID | 关联的知识节点 (可选) |
| start_time | TIMESTAMP | |
| end_time | TIMESTAMP | |

### 4. 聊天记录 (Chat)

#### `chat_sessions` (会话表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | PK |
| user_id | UUID | |
| title | VARCHAR | 会话标题 |
| created_at | TIMESTAMP | |

#### `chat_messages` (消息表)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | PK |
| session_id | UUID | FK |
| role | VARCHAR | user, assistant, system |
| content | TEXT | 消息内容 |
| tool_calls | JSONB | 工具调用详情 |
| created_at | TIMESTAMP | |

## 索引设计 (Indexes)

### 向量索引 (Vector Index)
为了加速语义搜索，我们使用 HNSW 索引。

```sql
CREATE INDEX ON knowledge_nodes USING hnsw (embedding vector_cosine_ops);
```

### 常规索引
- `users`: (email), (username)
- `user_node_status`: (user_id, node_id), (user_id, next_review_at)
- `tasks`: (user_id, status), (user_id, start_time)
- `chat_messages`: (session_id, created_at)

## 数据迁移 (Migration)

使用 Alembic (Python) 管理数据库版本控制。

```bash
# 生成迁移
alembic revision --autogenerate -m "add_vector_index"

# 执行迁移
alembic upgrade head
```