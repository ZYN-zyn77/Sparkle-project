# Sparkle é¡¹ç›®æŠ€æœ¯ç™½çš®ä¹¦

> **ç‰ˆæœ¬**: v2.0
> **æ—¥æœŸ**: 2026-01-10
> **æ¶æ„**: æ··åˆå¾®æœåŠ¡ (Flutter + Go Gateway + Python Engine)

## 1. ğŸ—ï¸ ç³»ç»Ÿæ¶æ„ä¸é…ç½®è¯¦æƒ… (System Architecture & Configuration)

Sparkle é‡‡ç”¨é«˜æ€§èƒ½çš„æ··åˆå¾®æœåŠ¡æ¶æ„ï¼Œæ—¨åœ¨å¹³è¡¡å®æ—¶äº¤äº’çš„é«˜å¹¶å‘éœ€æ±‚ä¸ AI æ¨ç†çš„å¤æ‚è®¡ç®—éœ€æ±‚ã€‚

### 1.1 æ¶æ„æ¦‚è§ˆ

```mermaid
graph TD
    User[ç”¨æˆ· (Flutter App)] <-->|WebSocket / HTTPS| Gateway[Go Gateway]
    
    subgraph Infrastructure
        DB[(PostgreSQL + pgvector)]
        Redis[(Redis)]
        MinIO[(MinIO Object Storage)]
    end

    subgraph Backend_Services
        Gateway <-->|gRPC / Stream| Engine[Python AI Engine]
        Gateway <-->|SQL| DB
        Gateway <-->|Command| Redis
        Engine <-->|SQL| DB
        Engine <-->|Task Queue| Redis
    end
```

### 1.2 ä¾èµ–çŸ©é˜µ (Dependency Matrix)

#### ç§»åŠ¨ç«¯ (Flutter)
- **Framework**: Flutter 3.24+
- **Language**: Dart 3.5+
- **State Management**: `flutter_riverpod` (v2.0+)
- **Networking**: `dio` (HTTP), `web_socket_channel` (WS), `grpc`
- **Local Storage**: `hive`, `shared_preferences`
- **UI Components**: Custom Design System V2 (SparkleMaterial, NeoGlass)

#### ç½‘å…³å±‚ (Go Gateway)
- **Language**: Go 1.24+
- **Web Framework**: `gin-gonic/gin`
- **WebSocket**: `gorilla/websocket` (Optimized for high concurrency)
- **Database**: `jackc/pgx` (Driver), `kyleconroy/sqlc` (Type-safe SQL)
- **RPC**: `grpc-go`, `protobuf`
- **Config**: `spf13/viper`
- **Observability**: `prometheus/client_golang`, `opentelemetry-go`

#### æ™ºèƒ½å¼•æ“å±‚ (Python AI Engine)
- **Language**: Python 3.11+
- **Framework**: FastAPI (Management API), gRPC (Internal API)
- **AI/LLM**: `langchain`, `openai`, `numpy`
- **Database**: `sqlalchemy` (Async), `alembic` (Migrations), `pgvector`
- **Task Queue**: `celery` + `redis`
- **WSGI/ASGI**: `uvicorn`, `gunicorn`

### 1.3 æ ¸å¿ƒé…ç½®

é…ç½®ç®¡ç†é‡‡ç”¨åˆ†å±‚ç­–ç•¥ï¼š
1.  **åŸºç¡€è®¾æ–½**: `docker-compose.yml` å®šä¹‰å®¹å™¨ç¼–æ’ã€‚
2.  **Go Gateway**: `config.yaml` æˆ–ç¯å¢ƒå˜é‡ï¼Œæ§åˆ¶ç«¯å£ã€æ•°æ®åº“è¿æ¥ã€JWT å¯†é’¥ã€‚
3.  **Python Engine**: `.env` æ–‡ä»¶ï¼Œç®¡ç† LLM Keyã€Celery é…ç½®ã€Prompts æ¨¡æ¿ã€‚

#### å…³é”®ç¯å¢ƒå˜é‡
- `DATABASE_URL`: PostgreSQL è¿æ¥ä¸² (e.g., `postgres://user:pass@db:5432/sparkle`)
- `REDIS_URL`: Redis è¿æ¥ä¸²
- `INTERNAL_API_KEY`: Gateway ä¸ Engine ä¹‹é—´çš„é‰´æƒå¯†é’¥
- `JWT_SECRET`: ç”¨æˆ·è®¤è¯å¯†é’¥
- `OPENAI_API_KEY`: LLM æœåŠ¡å•†å¯†é’¥

## 2. ğŸ”Œ åç«¯æ·±åº¦è§£æ (Backend Deep Dive)

### 2.1 åè®®åˆ†å·¥

| åè®® | ç”¨é€” | æ¶‰åŠç»„ä»¶ |
| :--- | :--- | :--- |
| **WebSocket** | å®æ—¶èŠå¤©ã€çŠ¶æ€åŒæ­¥ã€æ‰“å­—æœºæ•ˆæœ | Mobile <-> Gateway |
| **HTTPS (REST)** | ç™»å½•æ³¨å†Œã€æ–‡ä»¶ä¸Šä¼ ã€é™æ€èµ„æº | Mobile <-> Gateway |
| **gRPC** | å¤æ‚ä¸šåŠ¡é€»è¾‘ã€LLM æ¨ç†ã€æµå¼å“åº” | Gateway <-> Engine |
| **Redis Protocol** | ç¼“å­˜ã€Pub/Subã€ä»»åŠ¡é˜Ÿåˆ— | Gateway/Engine <-> Redis |

### 2.2 å¯åŠ¨æµç¨‹

#### Go Gateway å¯åŠ¨
1.  **Config Load**: åŠ è½½é…ç½®ä¸ç¯å¢ƒå˜é‡ã€‚
2.  **DB Init**: åˆå§‹åŒ– PostgreSQL è¿æ¥æ± ä¸ Redis å®¢æˆ·ç«¯ã€‚
3.  **gRPC Client**: å»ºç«‹ä¸ Python Engine çš„é•¿è¿æ¥ (Lazy connection)ã€‚
4.  **Router**: æ³¨å†Œ Gin è·¯ç”±ä¸ WebSocket å‡çº§å¤„ç†å™¨ã€‚
5.  **Server**: ç›‘å¬ 8080 ç«¯å£ï¼Œå¼€å§‹æœåŠ¡ã€‚

#### Python Engine å¯åŠ¨
1.  **Pre-start**: è¿è¡Œ Alembic æ•°æ®åº“è¿ç§» (`alembic upgrade head`)ã€‚
2.  **App Init**: åˆå§‹åŒ– FastAPI åº”ç”¨ä¸ Celery Workerã€‚
3.  **gRPC Server**: å¯åŠ¨ gRPC æœåŠ¡ç›‘å¬ 50051 ç«¯å£ã€‚
4.  **Worker**: å¯åŠ¨ Celery Worker ç›‘å¬ Redis é˜Ÿåˆ—ã€‚

## 3. ğŸ§  æ ¸å¿ƒä¸šåŠ¡æµ (Critical Business Flows)

### 3.1 å®æ—¶å¯¹è¯æµ (The Chat Flow)
1.  **ç”¨æˆ·** å‘é€ WebSocket æ¶ˆæ¯ã€‚
2.  **Gateway** æ¥æ”¶æ¶ˆæ¯ï¼ŒéªŒè¯ Tokenï¼Œå°è£…ä¸º gRPC `StreamChatRequest`ã€‚
3.  **Gateway** è°ƒç”¨ `StreamChat` gRPC æ¥å£ã€‚
4.  **Engine** æ¥æ”¶è¯·æ±‚ï¼Œé€šè¿‡ LangChain ç¼–æ’ Agentã€‚
5.  **Engine** ç”Ÿæˆ `ReasoningStep` (æ€è€ƒæ­¥éª¤) å’Œ `Delta` (æ–‡æœ¬)ï¼Œå†™å…¥ gRPC æµã€‚
6.  **Gateway** è¯»å–æµï¼Œè½¬æ¢ä¸º WebSocket JSON äº‹ä»¶ (`status_update`, `delta`) æ¨é€ç»™ç”¨æˆ·ã€‚

### 3.2 çŸ¥è¯†ç‚¹å‘é‡æ£€ç´¢ (Vector Search)
1.  **Engine** å®šæœŸæˆ–è§¦å‘å¼å°† `KnowledgeNode` çš„æ–‡æœ¬å†…å®¹è½¬æ¢ä¸º Embeddingã€‚
2.  **Engine** å°† Embedding å­˜å…¥ PostgreSQL `embedding` å­—æ®µ (vector ç±»å‹)ã€‚
3.  **Gateway** (æˆ– Engine) æ‰§è¡Œ SQL æŸ¥è¯¢ï¼Œä½¿ç”¨ `<->` (æ¬§æ°è·ç¦») æˆ– `<=>` (ä½™å¼¦ç›¸ä¼¼åº¦) æ“ä½œç¬¦è¿›è¡Œ HNSW ç´¢å¼•æ£€ç´¢ã€‚

## 4. ğŸ“‚ ç›®å½•ç»“æ„æ˜ å°„

```
sparkle/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ gateway/          # Go ç½‘å…³ (å…¥å£)
â”‚   â”‚   â”œâ”€â”€ cmd/server/   # main.go
â”‚   â”‚   â”œâ”€â”€ internal/     # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ api/          # è·¯ç”±å®šä¹‰
â”‚   â””â”€â”€ app/              # Python å¼•æ“ (æ ¸å¿ƒ)
â”‚       â”œâ”€â”€ core/         # æ ¸å¿ƒé…ç½® (Celery, Config)
â”‚       â”œâ”€â”€ services/     # ä¸šåŠ¡æœåŠ¡ (LLM, Galaxy)
â”‚       â””â”€â”€ grpc/         # gRPC æœåŠ¡å®ç°
â”œâ”€â”€ mobile/               # Flutter å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ lib/features/     # ä¸šåŠ¡æ¨¡å— (Chat, Galaxy)
â”‚   â””â”€â”€ lib/core/         # æ ¸å¿ƒç»„ä»¶ (Network, Design)
â”œâ”€â”€ proto/                # Protobuf å®šä¹‰
â””â”€â”€ docs/                 # é¡¹ç›®æ–‡æ¡£
```

## 5. âš ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥

### 5.1 ç†”æ–­ä¸é™çº§
- **Gateway**: å½“ Python Engine æ— å“åº”æ—¶ï¼ŒGateway ä¼šè§¦å‘ç†”æ–­ï¼Œç›´æ¥è¿”å› "æœåŠ¡ç¹å¿™" ç»™å®¢æˆ·ç«¯ï¼Œé¿å…ç§¯å‹ Goroutineã€‚
- **Mobile**: å½“ WebSocket æ–­å¼€æ—¶ï¼Œå¯ç”¨æŒ‡æ•°é€€é¿é‡è¿æœºåˆ¶ã€‚

### 5.2 é”™è¯¯ä¼ æ’­
- **Python**: æŠ›å‡º gRPC Status Code (e.g., `RESOURCE_EXHAUSTED` for quota limit).
- **Gateway**: æ•è· gRPC é”™è¯¯ï¼Œè½¬æ¢ä¸º HTTP çŠ¶æ€ç æˆ– WebSocket `error` äº‹ä»¶ã€‚
- **Mobile**: è§£æé”™è¯¯ç ï¼Œå±•ç¤ºæœ¬åœ°åŒ–çš„ç”¨æˆ·å‹å¥½æç¤º (e.g., "æ‚¨çš„ä»Šæ—¥é¢åº¦å·²ç”¨å®Œ").