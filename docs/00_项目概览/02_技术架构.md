# 技术架构文档 (Technical Architecture)

## 1. 架构总览 (System Overview)

Sparkle 采用高性能的**混合微服务架构**，旨在提供流畅的移动端体验和强大的 AI 处理能力。系统分为三层：移动客户端（Mobile）、高性能网关（Gateway）和智能计算引擎（AI Engine）。

### 1.1 核心三层架构

```mermaid
graph TD
    User[用户 (Mobile App)] <-->|WebSocket / HTTP| Gateway[Go Gateway (接入层)]
    Gateway <-->|gRPC / Stream| AIEngine[Python AI Engine (智能层)]
    
    subgraph Mobile [Flutter Client]
        UI[UI Layer (Design System V2)]
        Logic[Logic Layer (Riverpod)]
        Repo[Data Layer (Repositories)]
    end

    subgraph Backend_Gateway [Go Gateway]
        WS[WebSocket Manager]
        Auth[Auth Middleware]
        Router[Request Router]
    end

    subgraph Backend_AI [Python AI Engine]
        LLM[LLM Orchestrator]
        RAG[RAG Engine]
        FSM[Finite State Machine]
    end

    Gateway -.->|Cache| Redis
    AIEngine -.->|Vector/Relational| DB[(PostgreSQL + pgvector)]
    AIEngine -.->|Cache| Redis
```

| 层级 | 技术栈 | 主要职责 |
| :--- | :--- | :--- |
| **Mobile (客户端)** | Flutter, Riverpod, Hive | 用户交互、本地状态管理、离线缓存、实时渲染 (Design System V2) |
| **Gateway (接入层)** | Go, Gin, Gorilla WebSocket | 连接管理、鉴权、请求路由、负载均衡、协议转换 (HTTP/WS <-> gRPC) |
| **AI Engine (核心层)** | Python, FastAPI, gRPC | 业务逻辑、LLM 编排、RAG 检索、状态机 (FSM) 管理 |

---

## 2. 核心组件详解 (Component Details)

### 2.1 移动端 (Mobile - Flutter)
基于 **Feature-First** 架构，采用 **Riverpod** 进行状态管理。
- **Design System V2**: 基于 Material 3 的定制设计系统，包含 `SparkleMaterial`, `NeoGlass`, `Ceramic` 等高级材质渲染。
- **PerformanceService**: 动态性能监控服务，根据设备负载自动调节渲染质量 (Focus Mode)。
- **SyncCognitiveRepository**: 统一的数据同步层，处理在线/离线模式切换。

### 2.2 网关层 (Gateway - Go)
系统的统一入口，处理高并发连接。
- **WebSocket Manager**: 管理长连接，处理心跳、重连和消息广播。
- **gRPC Client**: 作为 gRPC 客户端调用 Python 服务，支持双向流 (Bi-directional Streaming)。
- **Security**: 实现 JWT 鉴权、速率限制 (Rate Limiting) 和输入清洗。

### 2.3 智能引擎 (AI Engine - Python)
处理复杂的 AI 业务逻辑。
- **Service Layer**: 定义 gRPC 服务接口 (CognitiveService, GalaxyService)。
- **FSM (有限状态机)**: 管理复杂的任务流程和对话状态。
- **RAG Engine**: 基于 pgvector 的知识检索增强生成。
- **Background Tasks**: 异步处理耗时任务 (如文档解析、摘要生成)。

---

## 3. 通信与数据流 (Communication & Data Flow)

### 3.1 实时对话流 (WebSocket + gRPC Stream)
实现低延迟的 AI 响应流。

1.  **Mobile**: 用户发送消息 -> `WebSocketService` 封装消息 -> 发送至网关。
2.  **Gateway**: 接收 WS 消息 -> 解析协议 -> 通过 gRPC Stream 转发给 AI Engine。
3.  **AI Engine**: LLM 生成 token -> 写入 gRPC 响应流。
4.  **Gateway**: 读取 gRPC 流 -> 封装为 WS 消息 -> 推送回 Mobile。
5.  **Mobile**: 接收 WS 消息 -> 更新 UI (流式打字机效果)。

### 3.2 请求响应流 (HTTP/REST)
用于非实时的常规操作 (如登录、获取配置)。

1.  **Mobile**: 发送 HTTP Request (Dio)。
2.  **Gateway**: Gin Router 拦截 -> 验证 Token -> 处理或转发。
3.  **Response**: JSON 格式返回。

---

## 4. 基础设施与存储 (Infrastructure)

- **Database**: PostgreSQL 15+
    - `users`, `tasks`: 关系型数据。
    - `vectors`: `pgvector` 存储知识库向量。
- **Cache**: Redis 7+
    - 会话缓存、频率限制计数器、热点数据。
- **Object Storage**: MinIO (本地开发) / S3 (生产)
    - 存储用户上传的文件、头像等。

## 5. 性能优化 (Performance Optimization)

### 5.1 移动端
- **对象池 (Object Pooling)**: 复用高频创建的对象 (如动画控制器)。
- **Shader 预热**: 提前编译 Galaxy 视图所需的 Shader 程序。
- **分级渲染**: 低端机型自动降级特效 (关闭模糊、减少粒子数)。

### 5.2 后端
- **Go并发模型**: 利用 Goroutines 处理高并发 WebSocket 连接。
- **连接复用**: Gateway 与 AI Engine 之间维护 gRPC 长连接池。
- **异步处理**: 耗时操作 (文件分析) 放入任务队列 (Celery/BackgroundTasks) 异步执行。

## 6. 安全架构 (Security)

- **传输层**: 全链路 TLS/SSL 加密。
- **认证**: JWT (JSON Web Token) 双令牌机制 (Access + Refresh)。
- **数据隐私**: 敏感字段加密存储，日志脱敏处理。
- **网关防护**: 防止 DDoS，实现 IP 频率限制。