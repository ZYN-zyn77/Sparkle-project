# Sparkle AI Learning Assistant - æ·±åº¦æŠ€æœ¯è®²è§£æ–‡æ¡£

> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0
> **ç¼–å†™æ—¥æœŸ**: 2025-12-27
> **ç”Ÿäº§å°±ç»ªåº¦**: 9.5/10
> **é€‚ç”¨å¯¹è±¡**: é«˜çº§åç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆã€æŠ€æœ¯è¯„å§”

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„å…¨æ™¯](#1-ç³»ç»Ÿæ¶æ„å…¨æ™¯)
2. [Go Gateway - é«˜æ€§èƒ½ç½‘å…³å±‚](#2-go-gateway---é«˜æ€§èƒ½ç½‘å…³å±‚)
3. [Python Agent Engine - AI æ ¸å¿ƒå¼•æ“](#3-python-agent-engine---ai-æ ¸å¿ƒå¼•æ“)
4. [Flutter Mobile - è·¨å¹³å°ç§»åŠ¨ç«¯](#4-flutter-mobile---è·¨å¹³å°ç§»åŠ¨ç«¯)
5. [æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ](#5-æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ)
6. [æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£](#6-æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£)
7. [ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º](#7-ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º)
8. [å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª](#8-å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª)
9. [æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ](#9-æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ)
10. [é¢è¯•å¸¸è§é—®é¢˜è§£ç­”](#10-é¢è¯•å¸¸è§é—®é¢˜è§£ç­”)

---

## 1. ç³»ç»Ÿæ¶æ„å…¨æ™¯

### 1.1 é«˜å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Sparkle AI Learning Assistant                     â”‚
â”‚                  æ˜Ÿç« - AI å¤§å­¦ç”Ÿå­¦ä¹ è¾…åŠ©ç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    gRPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚ â”‚
â”‚  â”‚ Flutter App  â”‚    (8080)       â”‚ Go Gateway   â”‚  (50051)     â”‚ Python Agent â”‚ â”‚
â”‚  â”‚              â”‚                 â”‚              â”‚              â”‚   Engine     â”‚ â”‚
â”‚  â”‚  Riverpod    â”‚                 â”‚  Gin +       â”‚              â”‚              â”‚ â”‚
â”‚  â”‚  State Mgmt  â”‚                 â”‚  WebSocket   â”‚              â”‚  FastAPI     â”‚ â”‚
â”‚  â”‚  Hive/SQLite â”‚                 â”‚  + Auth      â”‚              â”‚  + Orchestrationâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²                                â”‚                              â”‚         â”‚
â”‚         â”‚                                â”‚                              â”‚         â”‚
â”‚         â”‚                                â–¼                              â–¼         â”‚
â”‚         â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚         â”‚                        â”‚   Redis      â”‚              â”‚ PostgreSQL   â”‚ â”‚
â”‚         â”‚                        â”‚  (Sessions,  â”‚              â”‚  + pgvector  â”‚ â”‚
â”‚         â”‚                        â”‚   Cache,     â”‚              â”‚              â”‚ â”‚
â”‚         â”‚                        â”‚   Queues)    â”‚              â”‚              â”‚ â”‚
â”‚         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                â–²                              â–²         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                    Internal Communication                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ã€æ¶æ„æ€æƒ³è®²è§£ã€‘**

è¯¥æ¶æ„ä½“ç°äº†**åˆ†å±‚è®¾è®¡**å’Œ**èŒè´£åˆ†ç¦»**çš„æ ¸å¿ƒæ€æƒ³ï¼š
1. **å‰ç«¯å±‚ (Flutter)**: ä¸“æ³¨ç”¨æˆ·äº¤äº’ã€çŠ¶æ€ç®¡ç†ä¸æœ¬åœ°æŒä¹…åŒ–ã€‚
2. **ç½‘å…³å±‚ (Go)**: å¤„ç†é•¿è¿æ¥ã€JWT è®¤è¯ã€åˆ†å¸ƒå¼é™æµï¼Œå……å½“ç³»ç»Ÿçš„â€œå®‰æ£€é—¨â€ä¸â€œæµé‡è°ƒåº¦å‘˜â€ã€‚
3. **ä¸šåŠ¡å±‚ (Python)**: åˆ©ç”¨ AI ç”Ÿæ€å®Œæˆå·¥å…·è°ƒç”¨ã€GraphRAG æ£€ç´¢åŠå¤æ‚çš„ Agent ç¼–æ’ã€‚
4. **æ•°æ®å±‚ (DB/Cache)**: PostgreSQL æä¾›å…³ç³»+å‘é‡å­˜å‚¨ï¼ŒRedis æä¾›ä¼šè¯ç¼“å­˜ä¸å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ã€‚

**ã€å‰åç«¯äº¤äº’æ€æƒ³ã€‘**
- **åŒå·¥é€šä¿¡**: é‡‡ç”¨ WebSocket ç»´æŒé•¿è¿æ¥ï¼Œæ”¯æŒ AI å›å¤çš„æµå¼æ¨é€ï¼Œé¿å… HTTP é¢‘ç¹æ¡æ‰‹ã€‚
- **é«˜æ•ˆä¸­è½¬**: Go ä¸ Python é—´é€šè¿‡ gRPC äºŒè¿›åˆ¶åè®®é€šä¿¡ï¼Œæå¤§é™ä½äº†å†…éƒ¨è°ƒç”¨çš„å»¶è¿Ÿã€‚

**ã€è¯„å§”è€ƒå¯Ÿç‚¹ã€‘**
- **Q: ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ Go é‡Œé›†æˆ AI é€»è¾‘ï¼Ÿ**
  - A: èŒè´£åˆ†ç¦»ã€‚Go æ“…é•¿å¤„ç† IO å¯†é›†å‹çš„å¹¶å‘è¿æ¥ï¼Œè€Œ Python æ‹¥æœ‰æœ€æˆç†Ÿçš„ AI/LLM ç”Ÿæ€åº“ï¼ˆå¦‚ LangChain, LlamaIndexï¼‰ï¼Œå„å–æ‰€é•¿ã€‚
- **Q: æ¶æ„å¦‚ä½•ä¿è¯å¯æ‰©å±•æ€§ï¼Ÿ**
  - A: æ¯ä¸€å±‚éƒ½æ˜¯æ— çŠ¶æ€çš„ï¼ˆé™¤ Redis å­˜å‚¨çš„ Session å¤–ï¼‰ï¼Œç½‘å…³å’Œ Agent å¼•æ“éƒ½å¯ä»¥é€šè¿‡ K8s æ°´å¹³æ‰©å®¹ã€‚

### 1.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

**æ··åˆæ¶æ„ä¼˜åŠ¿**:
- **Go Gateway**: é«˜æ€§èƒ½ WebSocket å¤„ç†ï¼ŒC10K å¹¶å‘èƒ½åŠ›
- **Python Agent**: AI ç¼–æ’ã€å·¥å…·è°ƒç”¨ã€å‘é‡æ£€ç´¢çš„çµæ´»æ€§
- **Flutter**: è·¨å¹³å°ç»Ÿä¸€ä½“éªŒï¼ŒRiverpod çŠ¶æ€ç®¡ç†

**æ•°æ®æµå‘**:
```
Mobile â†’ WebSocket â†’ Go â†’ gRPC â†’ Python â†’ DB/Cache â†’ LLM â†’ Response
```

### 1.3 æŠ€æœ¯æ ˆé€‰æ‹©ç†ç”±

| ç»„ä»¶ | æŠ€æœ¯ | é€‰æ‹©ç†ç”± |
|------|------|----------|
| **ç½‘å…³** | Go + Gin + Gorilla WebSocket | é«˜å¹¶å‘ã€ä½å»¶è¿Ÿã€å†…å­˜å®‰å…¨ |
| **AI å¼•æ“** | Python + FastAPI | ç”Ÿæ€ä¸°å¯Œã€LLM é›†æˆæˆç†Ÿ |
| **ç§»åŠ¨ç«¯** | Flutter + Riverpod | è·¨å¹³å°ã€å“åº”å¼ã€çŠ¶æ€ç®¡ç† |
| **æ•°æ®åº“** | PostgreSQL 16 + pgvector | å…³ç³»å‹ + å‘é‡æœç´¢ä¸€ä½“åŒ– |
| **ç¼“å­˜/é˜Ÿåˆ—** | Redis 7 | é«˜æ€§èƒ½ã€æ”¯æŒå¤šç§æ•°æ®ç»“æ„ |
| **é€šä¿¡** | gRPC | é«˜æ•ˆäºŒè¿›åˆ¶åè®®ã€æµå¼æ”¯æŒ |

---

## 2. Go Gateway - é«˜æ€§èƒ½ç½‘å…³å±‚

### 2.1 æ ¸å¿ƒç»„ä»¶æ¶æ„

```
backend/gateway/
â”œâ”€â”€ cmd/server/main.go              # å…¥å£ç‚¹ï¼ŒæœåŠ¡å¯åŠ¨
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â””â”€â”€ chat_orchestrator.go    # WebSocket æ ¸å¿ƒå¤„ç†å™¨
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.go                 # JWT è®¤è¯ + é€Ÿç‡é™åˆ¶
â”‚   â”‚   â””â”€â”€ rate_limit.go           # åˆ†å¸ƒå¼é™æµ
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ quota_service.go        # ç”¨æˆ·é…é¢ç®¡ç†
â”‚   â”‚   â””â”€â”€ cache_service.go        # è¯­ä¹‰ç¼“å­˜
â”‚   â”œâ”€â”€ proxy/
â”‚   â”‚   â””â”€â”€ reverse_proxy.go        # REST API åå‘ä»£ç†
â”‚   â””â”€â”€ db/
â”‚       â””â”€â”€ schema.sql              # SQLC ä»£ç ç”Ÿæˆ
```

### 2.2 WebSocket å¤„ç†å™¨æ·±åº¦è§£æ

#### 2.2.1 è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†

```go
// backend/gateway/internal/handler/chat_orchestrator.go

// ChatHandler ç»“æ„ä½“ï¼šç®¡ç† WebSocket è¿æ¥çš„æ‰€æœ‰ä¾èµ–æœåŠ¡
// ç¼–ç¨‹æ€æƒ³ï¼šä¾èµ–æ³¨å…¥ï¼ˆDependency Injectionï¼‰ï¼Œæ‰€æœ‰å¤–éƒ¨ä¾èµ–é€šè¿‡ç»“æ„ä½“å­—æ®µä¼ å…¥
type ChatHandler struct {
    grpcClient   pb.AgentServiceClient  // gRPC å®¢æˆ·ç«¯ï¼Œç”¨äºè°ƒç”¨ Python æœåŠ¡
    redisClient  *redis.Client          // Redis å®¢æˆ·ç«¯ï¼Œç”¨äºä¼šè¯ç®¡ç†å’Œç¼“å­˜
    sessionMgr   *SessionManager        // ä¼šè¯ç®¡ç†å™¨ï¼Œç»´æŠ¤è¿æ¥æ˜ å°„
    quotaService *QuotaService          // é…é¢æœåŠ¡ï¼Œæ§åˆ¶ç”¨æˆ·è¯·æ±‚é¢‘ç‡
}

// ========== æ ¸å¿ƒå¤„ç†å‡½æ•° ==========
func (h *ChatHandler) HandleWebSocket(conn *websocket.Conn, userID string) {
    # ========== ç¬¬1æ­¥: è¿æ¥å»ºç«‹ä¸ä¼šè¯åˆå§‹åŒ– ==========
    # ç¼–ç¨‹æ€æƒ³ï¼šä¼šè¯éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·è¿æ¥éƒ½æœ‰ç‹¬ç«‹çš„ä¼šè¯ID
    sessionID := h.sessionMgr.CreateSession(userID)

    # ========== ç¬¬2æ­¥: æ³¨å†Œè¿æ¥ä¸èµ„æºæ¸…ç† ==========
    # ç¼–ç¨‹æ€æƒ³ï¼šRAII (èµ„æºè·å–å³åˆå§‹åŒ–) + Deferï¼Œç¡®ä¿è¿æ¥æ–­å¼€æ—¶æ¸…ç†èµ„æºé˜²æ­¢æ³„æ¼
    h.sessionMgr.Register(sessionID, conn)
    defer h.sessionMgr.Unregister(sessionID)

    # ========== ç¬¬3æ­¥: å¯åŠ¨å¼‚æ­¥å¿ƒè·³åç¨‹ ==========
    # ç¼–ç¨‹æ€æƒ³ï¼šGoroutine å¹¶å‘ï¼Œç»´æŒé•¿è¿æ¥æ´»æ€§ï¼Œä¸é˜»å¡ä¸»æ¶ˆæ¯å¾ªç¯
    go h.heartbeat(conn, sessionID)

    # ========== ç¬¬4æ­¥: ç›‘å¬ç”¨æˆ·æ¶ˆæ¯å¾ªç¯ ==========
    # ç¼–ç¨‹æ€æƒ³ï¼šäº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œä¸æ–­è¯»å–è§£æå®¢æˆ·ç«¯å‘é€çš„ JSON æ¶ˆæ¯
    for {
        var msg ChatMessage
        if err := conn.ReadJSON(&msg); err != nil {
            h.handleError(sessionID, err)
            break // è¯»å–å¤±è´¥ï¼ˆå¦‚å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€ï¼‰åˆ™é€€å‡ºå¾ªç¯
        }

        # ========== ç¬¬5æ­¥: åˆ†å¸ƒå¼é…é¢ä¸é™æµæ£€æŸ¥ ==========
        # ç¼–ç¨‹æ€æƒ³ï¼šé˜²å¾¡æ€§ç¼–ç¨‹ã€‚è°ƒç”¨ Redis æœåŠ¡æ£€æŸ¥ç”¨æˆ·å‰©ä½™é…é¢ï¼Œé˜²æ­¢ API æ»¥ç”¨
        if !h.quotaService.CheckQuota(userID) {
            conn.WriteJSON(QuotaExceededResponse)
            break
        }

        # ========== ç¬¬6æ­¥: è½¬å‘è¯·æ±‚è‡³ Python gRPC æœåŠ¡ ==========
        # ç¼–ç¨‹æ€æƒ³ï¼šç½‘å…³è½¬å‘æ¨¡å¼ã€‚Go ä½œä¸ºé«˜æ€§èƒ½ç½‘å…³ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£é«˜æ•ˆè½¬å‘
        response, err := h.forwardToPython(userID, sessionID, msg)
        if err != nil {
            conn.WriteJSON(ErrorResponse{Code: "GRPC_ERROR"})
            continue // å•æ¬¡è¯·æ±‚å¤±è´¥ä¸åº”å¯¼è‡´é•¿è¿æ¥æ–­å¼€
        }

        # ========== ç¬¬7æ­¥: å¤„ç†æµå¼è¿”å›å¹¶æ¨é€è‡³ç§»åŠ¨ç«¯ ==========
        # ç¼–ç¨‹æ€æƒ³ï¼šæµå¼å¤„ç† (Stream)ã€‚æ¥æ”¶ gRPC æµå¹¶å°†æ¯ä¸ªæ•°æ®å—å®æ—¶æ¨é€è‡³ WebSocket
        for _, chunk := range response {
            if err := conn.WriteJSON(chunk); err != nil {
                break
            }
        }
    }
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³æ€»ç»“

1. **èµ„æºç®¡ç†æ¨¡å¼ï¼ˆRAII + Deferï¼‰**: é€šè¿‡ `defer` ä¿è¯æ— è®ºå‡½æ•°å¦‚ä½•é€€å‡ºï¼Œèµ„æºï¼ˆå†…å­˜æ˜ å°„ã€Redis çŠ¶æ€ï¼‰éƒ½èƒ½è¢«æ­£ç¡®é‡Šæ”¾ã€‚
2. **è½»é‡çº§å¹¶å‘**: Go çš„åç¨‹å¼€é”€æå°ï¼ˆçº¦ 2KBï¼‰ï¼Œæ”¯æŒ C10K ç”šè‡³æ›´é«˜å¹¶å‘çš„é•¿è¿æ¥ç»´æŒã€‚
3. **èŒè´£åˆ†ç¦»**: ç½‘å…³åªåšâ€œåè®®è½¬æ¢â€ï¼ˆWS è½¬ gRPCï¼‰å’Œâ€œæ¨ªåˆ‡é¢é€»è¾‘â€ï¼ˆé™æµã€è®¤è¯ï¼‰ï¼Œä¸æ¶‰åŠ AI ä¸šåŠ¡é€»è¾‘ã€‚

ğŸ”„ å®Œæ•´æ•°æ®æµå‘

```
Flutter (JSON) â†’ Go (ReadJSON) â†’ Quota Check (Redis) â†’ Go (gRPC Call) â†’ Python Agent
                                                                        â†“
Flutter (UI æ›´æ–°) â† Go (WriteJSON) â† Go (Stream Read) â† Python (Stream Response)
```

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

- **Q: å¦‚æœ Python æœåŠ¡å“åº”æ…¢ï¼Œä¼šé˜»å¡å…¶ä»–ç”¨æˆ·çš„ WebSocket å—ï¼Ÿ**
  - A: ä¸ä¼šã€‚æ¯ä¸ª WebSocket è¿æ¥éƒ½åœ¨ç‹¬ç«‹çš„ Goroutine ä¸­è¿è¡Œï¼ŒGo çš„è°ƒåº¦å™¨ï¼ˆG-M-P æ¨¡å‹ï¼‰ä¼šé«˜æ•ˆç®¡ç†è¿™äº›å¹¶å‘ä»»åŠ¡ã€‚
- **Q: ä¸ºä»€ä¹ˆè½¬å‘åˆ° Python ç”¨ gRPC è€Œä¸æ˜¯ HTTPï¼Ÿ**
  - A: gRPC åŸºäº HTTP/2ï¼Œä½¿ç”¨ Protobuf äºŒè¿›åˆ¶åºåˆ—åŒ–ï¼Œæ€§èƒ½æ›´é«˜ä¸”å¤©ç„¶æ”¯æŒæµå¼é€šä¿¡ï¼ˆStreamingï¼‰ï¼Œéå¸¸é€‚åˆ AI çš„é€å­—å›å¤åœºæ™¯ã€‚

---

#### 2.2.2 å¿ƒè·³æœºåˆ¶ï¼ˆé˜²æ–­è¿ï¼‰

```go
func (h *ChatHandler) heartbeat(conn *websocket.Conn, sessionID string) {
    # 1. åˆ›å»ºå®šæ—¶å™¨ï¼Œæ¯ 30 ç§’è§¦å‘ä¸€æ¬¡
    ticker := time.NewTicker(30 * time.Second)
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:
            # 2. å‘é€ WebSocket Ping æ§åˆ¶å¸§
            # ä½œç”¨ï¼šæ£€æµ‹ TCP è¿æ¥æ˜¯å¦ä»ç„¶å­˜æ´»ï¼Œé˜²æ­¢ç”±äºé•¿æ—¶é—´æ— æ•°æ®è¢«é˜²ç«å¢™æ¸…ç†ã€‚
            if err := conn.WriteControl(websocket.PingMessage, nil, time.Now().Add(10*time.Second)); err != nil {
                return # å‘é€å¤±è´¥è¯´æ˜è¿æ¥å·²æ–­å¼€ï¼Œé€€å‡ºåç¨‹
            }

            # 3. æ›´æ–° Redis ä¸­çš„ä¼šè¯æ´»è·ƒæ—¶é—´
            # ä½œç”¨ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œé€šçŸ¥å…¶ä»–æœåŠ¡ï¼ˆå¦‚ Python å¼•æ“ï¼‰è¯¥ä¼šè¯ä»åœ¨çº¿ã€‚
            h.redisClient.Expire(context.Background(),
                fmt.Sprintf("session:%s:active", sessionID),
                60*time.Second)
        }
    }
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æ§åˆ¶ä¸æ•°æ®åˆ†ç¦»
- **æ€æƒ³**: WebSocket åè®®ä¸­æœ‰ä¸“é—¨çš„æ§åˆ¶å¸§ï¼ˆPing/Pongï¼‰ï¼Œå®ƒä»¬ä¸å ç”¨åº”ç”¨å±‚çš„æ•°æ®é€šé“ã€‚
- **ä¼˜ç‚¹**: å³ä½¿åº”ç”¨å±‚æ­£åœ¨å‘é€å¤§æ•°æ®åŒ…ï¼Œå¿ƒè·³ä¹Ÿèƒ½ç‹¬ç«‹æ£€æµ‹è¿æ¥å¥åº·ã€‚

2. çŠ¶æ€ä¸€è‡´æ€§ï¼ˆç§Ÿçº¦æœºåˆ¶ï¼‰
- **æ€æƒ³**: ä½¿ç”¨ `redisClient.Expire` å®é™…ä¸Šæ˜¯ä¸€ç§â€œç§Ÿçº¦â€æˆ–â€œçœ‹é—¨ç‹—â€æœºåˆ¶ã€‚
- **ä¼˜ç‚¹**: æœåŠ¡ç«¯ä¸éœ€è¦ä¸»åŠ¨æ‰«æè¿‡æœŸè¿æ¥ï¼Œè€Œæ˜¯è®©æ´»è·ƒè¿æ¥ä¸æ–­â€œç»­ç§Ÿâ€ï¼Œä¸ç»­ç§Ÿçš„è‡ªç„¶è¿‡æœŸï¼Œæå¤§èŠ‚çœèµ„æºã€‚


### 2.3 è®¤è¯ä¸é™æµä¸­é—´ä»¶

#### 2.3.1 JWT è®¤è¯ (Stateless Auth)

```go
// backend/gateway/internal/middleware/auth.go

func AuthMiddleware(jwtSecret string) gin.HandlerFunc {
    return func(c *gin.Context) {
        # 1. æå– Header ä¸­çš„ Authorization Token
        authHeader := c.GetHeader("Authorization")
        if authHeader == "" {
            c.AbortWithStatusJSON(401, gin.H{"error": "Missing token"})
            return
        }

        # 2. æ ¡éªŒ Token åˆæ³•æ€§ä¸è¿‡æœŸæ—¶é—´
        # æ€æƒ³ï¼šæ— çŠ¶æ€è®¤è¯ã€‚æœåŠ¡å™¨ä¸éœ€è¦æŸ¥åº“å³å¯éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œæé«˜æ‰©å±•æ€§ã€‚
        tokenString := strings.TrimPrefix(authHeader, "Bearer ")
        claims, err := jwt.ParseWithClaims(tokenString, &Claims{},
            func(token *jwt.Token) (interface{}, error) {
                return []byte(jwtSecret), nil
            })

        if err != nil || !claims.Valid {
            c.AbortWithStatusJSON(401, gin.H{"error": "Invalid token"})
            return
        }

        # 3. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ä¸Šä¸‹æ–‡ (Context)ï¼Œä¾›åç»­é€»è¾‘ä½¿ç”¨
        c.Set("userID", claims.UserID)
        c.Next()
    }
}
```

**ã€JWT vs Session é€‰å‹æ€æƒ³ã€‘**
| ç‰¹æ€§ | JWT (æœ¬ç³»ç»Ÿé‡‡ç”¨) | Session |
|------|-----------------|---------|
| çŠ¶æ€ | æ— çŠ¶æ€ï¼ŒæœåŠ¡ç«¯ä¸å­˜ Token | æœ‰çŠ¶æ€ï¼Œéœ€å­˜ Redis/DB |
| æ‰©å±•æ€§ | æä½³ï¼Œé€‚åˆæ°´å¹³æ‰©å®¹ | éœ€å…±äº«å­˜å‚¨ï¼Œæœ‰ IO ç“¶é¢ˆ |
| çµæ´»æ€§ | Token ä¸€æ—¦å‘æ”¾éš¾ä»¥ä¸»åŠ¨å¤±æ•ˆ | éšæ—¶å¯ä»¥ä»åç«¯åˆ é™¤ |

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. ä¸­é—´ä»¶æ¨¡å¼ (Middleware)
- **æ€æƒ³**: å°†é€šç”¨çš„è®¤è¯ã€æ—¥å¿—ã€æŠ¥é”™é€»è¾‘ä»ä¸šåŠ¡ä»£ç ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œåƒâ€œå¥—å¨ƒâ€ä¸€æ ·åŒ…è£¹åœ¨ä¸šåŠ¡å¤„ç†å™¨å¤–ã€‚
- **ä¼˜ç‚¹**: æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸éœ€è¦å…³æ³¨â€œç”¨æˆ·æ˜¯è°â€ï¼Œåªéœ€ä» `Context` å–å€¼å³å¯ã€‚

#### 2.3.2 åˆ†å¸ƒå¼é™æµ (Lua Script)

```go
// backend/gateway/internal/middleware/rate_limit.go

func RateLimitMiddleware(redisClient *redis.Client) gin.HandlerFunc {
    return func(c *gin.Context) {
        userID := c.GetString("userID")
        key := fmt.Sprintf("rate_limit:%s", userID)

        # 1. ä½¿ç”¨ Redis Lua è„šæœ¬å®ç°åŸå­é™æµ
        # æ€æƒ³ï¼šåŸå­æ€§ã€‚åœ¨é«˜å¹¶å‘ä¸‹ï¼Œä¼ ç»Ÿçš„ "GET -> INC -> SET" ä¼šå¯¼è‡´ç«æ€æ¡ä»¶ï¼ŒLua è„šæœ¬åœ¨ Redis å†…éƒ¨æ‰§è¡Œï¼Œä¿è¯æ“ä½œä¸å¯åˆ†å‰²ã€‚
        script := `
        local current = redis.call('GET', KEYS[1])
        if current and tonumber(current) >= tonumber(ARGV[1]) then
            return 0  -- è¶…è¿‡é™é¢
        else
            redis.call('INCR', KEYS[1])
            redis.call('EXPIRE', KEYS[1], ARGV[2]) -- è®¾ç½®çª—å£æœŸï¼ˆå¦‚60ç§’ï¼‰
            return 1  -- å…è®¸é€šè¡Œ
        end
        `

        allowed, err := redisClient.Eval(context.Background(), script,
            []string{key}, "100", "60").Result()

        if err != nil || allowed.(int64) == 0 {
            c.AbortWithStatusJSON(429, gin.H{"error": "Rate limit exceeded"})
            return
        }

        c.Next()
    }
}
```

**ã€é™æµç®—æ³•æ·±åº¦å¯¹æ¯”ã€‘**
1. **å›ºå®šçª—å£ (æœ¬ç³»ç»Ÿé‡‡ç”¨)**: å®ç°æå…¶ç®€å•ï¼Œé€‚åˆå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ã€‚
2. **ä»¤ç‰Œæ¡¶ (Token Bucket)**: å…è®¸ä¸€å®šç¨‹åº¦çš„çªå‘æµé‡ï¼ˆBurstï¼‰ï¼Œèƒ½æ›´å¹³æ»‘åœ°å¤„ç†ç½‘ç»œæ³¢åŠ¨ã€‚
3. **æ¼æ¡¶ (Leaky Bucket)**: å¼ºåˆ¶æ’å®šé€Ÿç‡æµå‡ºï¼Œå¸¸ç”¨äºå¯¹åç«¯ç³»ç»Ÿæœ‰æå…¶ä¸¥æ ¼ä¿æŠ¤è¦æ±‚çš„åœºæ™¯ã€‚

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•
- **å®ç°**: åœ¨å•ä½æ—¶é—´å†…ï¼ˆå¦‚1åˆ†é’Ÿï¼‰é™åˆ¶è¯·æ±‚æ¬¡æ•°ã€‚
- **ç¼ºç‚¹**: çª—å£è¾¹ç•Œå¯èƒ½ä¼šå‡ºç°åŒå€æµé‡ï¼ˆä¸´ç•Œé—®é¢˜ï¼‰ã€‚
- **è¿›é˜¶æ€è€ƒ**: ç”Ÿäº§ç¯å¢ƒå¸¸ç”¨â€œä»¤ç‰Œæ¡¶â€æˆ–â€œæ¼æ¡¶â€ç®—æ³•æ¥å®ç°æ›´å¹³æ»‘çš„é™æµã€‚

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

- **Q: ä¸ºä»€ä¹ˆé™æµé€»è¾‘å†™åœ¨ Go è€Œä¸å†™åœ¨ Pythonï¼Ÿ**
  - A: â€œæ—©è¿‡æ»¤åŸåˆ™â€ã€‚åœ¨ç½‘å…³å±‚æŒ¡ä½æ— æ•ˆæµé‡å¯ä»¥ä¿æŠ¤æ‰€æœ‰åç«¯å¾®æœåŠ¡ï¼Œé¿å…ä¸å¿…è¦çš„ gRPC å¼€é”€ã€‚


### 2.4 åå‘ä»£ç†è®¾è®¡

```go
// backend/gateway/internal/proxy/reverse_proxy.go

func NewReverseProxy(target *url.URL) *httputil.ReverseProxy {
    # 1. åˆ›å»ºæ ‡å‡†åå‘ä»£ç†
    proxy := httputil.NewSingleHostReverseProxy(target)

    # 2. è‡ªå®šä¹‰ Directorï¼ˆè¯·æ±‚è½¬æ¢å™¨ï¼‰
    # æ€æƒ³ï¼šé€æ˜ä»£ç†ã€‚ç½‘å…³åœ¨è½¬å‘æ—¶ï¼Œè‡ªåŠ¨æ³¨å…¥ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œè®©ä¸‹æ¸¸æœåŠ¡æ— éœ€é‡å¤è®¤è¯ã€‚
    proxy.Director = func(req *http.Request) {
        req.URL.Scheme = target.Scheme
        req.URL.Host = target.Host
        req.URL.Path = target.Path + req.URL.Path

        # å°†è®¤è¯åçš„ UserID æ³¨å…¥ Headerï¼Œä¼ é€’ç»™ä¸‹æ¸¸ Python æœåŠ¡
        if userID, ok := req.Context().Value("userID").(string); ok {
            req.Header.Set("X-User-ID", userID)
        }
    }

    # 3. ç»Ÿä¸€é”™è¯¯å¤„ç†
    # æ€æƒ³ï¼šæ•…éšœéš”ç¦»ã€‚å½“ä¸‹æ¸¸æœåŠ¡ï¼ˆPythonï¼‰ä¸å¯ç”¨æ—¶ï¼Œç½‘å…³åº”è¿”å›å‹å¥½é”™è¯¯ï¼Œè€Œä¸æ˜¯ç›´æ¥å´©æºƒã€‚
    proxy.ErrorHandler = func(w http.ResponseWriter, req *http.Request, err error) {
        log.Printf("Proxy error: %v", err)
        w.WriteHeader(http.StatusBadGateway)
        w.Write([]byte("Backend service unavailable"))
    }

    return proxy
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. é¢å‘åˆ‡é¢ç¼–ç¨‹ (AOP) çš„ä½“ç°
- **æ€æƒ³**: `Director` æ˜¯ä»£ç†é€»è¾‘çš„â€œåˆ‡é¢â€ï¼Œå®ƒåœ¨è¯·æ±‚å‘é€å‰æ‹¦æˆªå¹¶ä¿®æ”¹ã€‚
- **ä»·å€¼**: ä¿è¯äº†åç«¯æœåŠ¡ï¼ˆå¦‚ Python ä¸šåŠ¡æ¨¡å—ï¼‰å¯ä»¥ä¿æŒçº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸éœ€è¦æ„ŸçŸ¥ JWT æˆ–å¤æ‚çš„ç½‘ç»œåè®®ã€‚


### 2.5 Go Gateway ç”Ÿäº§çº§ç‰¹æ€§

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä»·å€¼ |
|------|----------|------|
| **è¿æ¥ç®¡ç†** | ä¼šè¯æ˜ å°„ + å¿ƒè·³ | é˜²æ­¢åƒµå°¸è¿æ¥ |
| **é…é¢æ§åˆ¶** | Redis è®¡æ•°å™¨ | é˜²æ­¢æ»¥ç”¨ |
| **è®¤è¯å®‰å…¨** | JWT + ç­¾åéªŒè¯ | èº«ä»½éªŒè¯ |
| **é™æµä¿æŠ¤** | Redis Lua è„šæœ¬ | é˜²æ­¢ DDoS |
| **é”™è¯¯éš”ç¦»** | ç†”æ–­ + è¶…æ—¶ | çº§è”æ•…éšœé˜²æŠ¤ |
| **æ—¥å¿—è¿½è¸ª** | è¯·æ±‚ ID + ç»“æ„åŒ–æ—¥å¿— | é—®é¢˜æ’æŸ¥ |

---

## 3. Python Agent Engine - AI æ ¸å¿ƒå¼•æ“

### 3.1 æ ¸å¿ƒæ¶æ„è®¾è®¡

```
backend/app/
â”œâ”€â”€ orchestration/                    # ç¼–æ’å±‚
â”‚   â”œâ”€â”€ orchestrator_production.py    # ç”Ÿäº§çº§ç¼–æ’å™¨
â”‚   â”œâ”€â”€ context_pruner.py             # ä¸Šä¸‹æ–‡ä¿®å‰ª
â”‚   â”œâ”€â”€ dynamic_tool_registry.py      # åŠ¨æ€å·¥å…·æ³¨å†Œ
â”‚   â”œâ”€â”€ validator.py                  # è¯·æ±‚éªŒè¯
â”‚   â”œâ”€â”€ executor.py                   # å·¥å…·æ‰§è¡Œ
â”‚   â””â”€â”€ composer.py                   # å“åº”ç»„åˆ
â”œâ”€â”€ services/                         # ä¸šåŠ¡æœåŠ¡
â”‚   â”œâ”€â”€ llm_service.py                # LLM é›†æˆ
â”‚   â”œâ”€â”€ galaxy_service.py             # çŸ¥è¯†æ˜Ÿå›¾
â”‚   â”œâ”€â”€ expansion_service.py          # LLM æ‹“å±•
â”‚   â”œâ”€â”€ decay_service.py              # é—å¿˜æ›²çº¿
â”‚   â”œâ”€â”€ push_service.py               # æ™ºèƒ½æ¨é€
â”‚   â””â”€â”€ task_service.py               # ä»»åŠ¡ç®¡ç†
â”œâ”€â”€ tools/                            # åŠ¨æ€å·¥å…·
â”‚   â”œâ”€â”€ knowledge_tools.py            # çŸ¥è¯†å·¥å…·
â”‚   â”œâ”€â”€ task_tools.py                 # ä»»åŠ¡å·¥å…·
â”‚   â””â”€â”€ user_tools.py                 # ç”¨æˆ·å·¥å…·
â””â”€â”€ grpc_server.py                    # gRPC æœåŠ¡ç«¯
```

### 3.2 ç”Ÿäº§çº§ç¼–æ’å™¨ (ProductionChatOrchestrator)

#### 3.2.1 å®Œæ•´å¤„ç†æµç¨‹ - 11æ­¥å®‰å…¨å¤„ç†é“¾

```python
# backend/app/orchestration/orchestrator_production.py

class ProductionChatOrchestrator:
    """
    ç”Ÿäº§çº§èŠå¤©ç¼–æ’å™¨
    èŒè´£ï¼šè¯·æ±‚éªŒè¯ã€å¹¶å‘æ§åˆ¶ã€çŠ¶æ€ç®¡ç†ã€é”™è¯¯å¤„ç†ã€ç›‘æ§
    ç¼–ç¨‹æ€æƒ³ï¼šè´£ä»»é“¾æ¨¡å¼ã€ç†”æ–­å™¨æ¨¡å¼ã€å¹‚ç­‰æ€§è®¾è®¡
    """

    def __init__(self, config: ProductionSettings):
        # æ ¸å¿ƒç»„ä»¶æ³¨å…¥ (Dependency Injection)
        self.state_manager = SessionStateManager()
        self.validator = RequestValidator()
        self.tool_executor = ToolExecutor()
        self.response_composer = ResponseComposer()

        # ç”Ÿäº§çº§å¢å¼ºç»„ä»¶
        self.context_pruner = ContextPruner(...)
        self.circuit_breaker = CircuitBreaker(...) # ç†”æ–­å™¨ï¼Œé˜²æ­¢çº§è”æ•…éšœ
        self.message_tracker = MessageTracker()    # æ¶ˆæ¯å»é‡ï¼Œä¿è¯å¹‚ç­‰æ€§

    async def process_stream(self, request: ChatRequest) -> AsyncIterator[StreamEvent]:
        """
        ä¸»å¤„ç†æµç¨‹ - 11æ­¥å®‰å…¨å¤„ç†é“¾
        """
        request_id = request.request_id
        session_id = request.session_id

        # ========== ç¬¬1æ­¥ï¼šåˆ†å¸ƒå¼æ¶ˆæ¯å»é‡ (Redis) ==========
        # ç¼–ç¨‹æ€æƒ³ï¼šå¹‚ç­‰æ€§ä¿è¯ã€‚ç¡®ä¿åŒä¸€ä¸ªè¯·æ±‚ ID åœ¨ç½‘ç»œæ³¢åŠ¨é‡è¯•æ—¶ä»…å¤„ç†ä¸€æ¬¡ã€‚
        if await self.message_tracker.is_processed(request_id):
            yield ErrorEvent(code="DUPLICATE_REQUEST", message="è¯·æ±‚å·²å¤„ç†")
            return

        # ========== ç¬¬2æ­¥ï¼šæœåŠ¡ç†”æ–­å™¨æ£€æŸ¥ ==========
        # ç¼–ç¨‹æ€æƒ³ï¼šç†”æ–­ä¿æŠ¤ã€‚å¦‚æœ LLM æŒç»­æŠ¥é”™ï¼Œè‡ªåŠ¨åˆ‡æ–­è¯·æ±‚ï¼Œé˜²æ­¢ç³»ç»Ÿé›ªå´©ã€‚
        if not await self.circuit_breaker.can_execute():
            yield ErrorEvent(code="CIRCUIT_BREAKER_OPEN", message="ç³»ç»Ÿè¿‡è½½")
            return

        # ========== ç¬¬3æ­¥ï¼šå¹¶å‘é™åˆ¶ (Semaphore) ==========
        # ç¼–ç¨‹æ€æƒ³ï¼šèµ„æºéš”ç¦»ã€‚é™åˆ¶å•ä¸ªç”¨æˆ·æˆ–ä¼šè¯çš„åŒæ—¶æ´»è·ƒè¯·æ±‚æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½ã€‚
        if not await self._track_session(session_id, add=True):
            yield ErrorEvent(code="RATE_LIMIT", message="å¹¶å‘è¿‡é«˜")
            return

        try:
            # ========== ç¬¬4-5æ­¥ï¼šè¯·æ±‚éªŒè¯ä¸å¹‚ç­‰ç»“æœæ£€æŸ¥ ==========
            # æ£€æŸ¥è¯·æ±‚æ ¼å¼åˆæ³•æ€§ï¼Œå¹¶å°è¯•ä»ç¼“å­˜ç›´æ¥è·å–å·²å¤„ç†çš„ç»“æœã€‚
            await self.validator.validate(request)
            
            # ========== ç¬¬6æ­¥ï¼šåˆ†å¸ƒå¼é” (Redis SETNX) ==========
            # ç¼–ç¨‹æ€æƒ³ï¼šåŸå­æ€§ä¿è¯ã€‚ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªåç¨‹èƒ½ä¿®æ”¹ç‰¹å®šä¼šè¯çš„çŠ¶æ€ã€‚
            lock_acquired = await self._acquire_session_lock(session_id, request_id)
            if not lock_acquired:
                yield ErrorEvent(code="LOCK_FAILED", message="ä¼šè¯ç¹å¿™")
                return

            # ========== ç¬¬7-8æ­¥ï¼šGraphRAG çŸ¥è¯†æ£€ç´¢ ==========
            # 1. æ„å»ºç”¨æˆ·ç”»åƒ (Learning History)
            # 2. çŸ¥è¯†æ£€ç´¢: åœ¨å‘é‡åº“ä¸­è¿›è¡Œæ··åˆæœç´¢ + çŸ¥è¯†å›¾è°±å…³ç³»æ‰©å±•ã€‚
            user_context = await self._build_user_context(request.user_id)
            knowledge_context = await self._retrieve_knowledge(request.user_id, request.message)

            # ========== ç¬¬9æ­¥ï¼šLLM ç¼–æ’ä¸å·¥å…·è°ƒç”¨ ==========
            # ç¼–ç¨‹æ€æƒ³ï¼šAgent å¾ªç¯ã€‚LLM å†³å®šæ˜¯å¦è°ƒç”¨å·¥å…· -> æ‰§è¡Œå·¥å…· -> ç»“æœå›å¡« -> ç”Ÿæˆå›ç­”ã€‚
            async for chunk in self._call_llm_with_tools(
                request=request,
                user_context=user_context,
                knowledge_context=knowledge_context
            ):
                yield chunk

            # ========== ç¬¬10æ­¥ï¼šæŒ‡æ ‡è®°å½•ä¸å“åº”ç¼“å­˜ ==========
            # ç¼–ç¨‹æ€æƒ³ï¼šå¯è§‚æµ‹æ€§ã€‚è®°å½• Token æ¶ˆè€—ã€è€—æ—¶ã€ç”¨æˆ·åé¦ˆç­‰åŸ‹ç‚¹ã€‚
            await self._record_metrics(request, user_context)

        finally:
            # ========== ç¬¬11æ­¥ï¼šèµ„æºæ¸…ç† ==========
            # ç¼–ç¨‹æ€æƒ³ï¼šèµ„æºé‡Šæ”¾ã€‚æ— è®ºæˆåŠŸæˆ–å¼‚å¸¸ï¼Œå¿…é¡»é‡Šæ”¾åˆ†å¸ƒå¼é”ä¸å¹¶å‘è®¡æ•°å™¨ã€‚
            await self._release_session_lock(session_id, request_id)
            await self._track_session(session_id, add=False)
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. **ç†”æ–­å™¨æ¨¡å¼ (Circuit Breaker)**: ç³»ç»Ÿåƒç”µè·¯ä¿é™©ä¸ä¸€æ ·ï¼Œå½“é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨æ–­å¼€ï¼ˆOpenï¼‰ï¼Œåœæ­¢è°ƒç”¨å¤–éƒ¨ä¾èµ–ï¼Œç»™ä¸‹æ¸¸ç³»ç»Ÿæ¢å¤æ—¶é—´ï¼Œé¿å…æ­»é”æˆ–èµ„æºè€—å°½ã€‚
2. **å¹‚ç­‰æ€§è®¾è®¡ (Idempotency)**: åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¯·æ±‚å¯èƒ½ä¼šå› ä¸ºè¶…æ—¶è€Œé‡è¯•ã€‚é€šè¿‡ `request_id` å»é‡ï¼Œä¿è¯â€œåˆ›å»ºä»»åŠ¡â€ç­‰æ“ä½œä¸ä¼šå› ä¸ºé‡è¯•è€Œåˆ›å»ºå¤šä»½ã€‚
3. **åˆ†å¸ƒå¼é” (Distributed Locking)**: è§£å†³å¤šä¸ª Worker åŒæ—¶å¤„ç†åŒä¸€ä¸ªç”¨æˆ·ä¼šè¯æ—¶çš„çŠ¶æ€ç«äº‰é—®é¢˜ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

- **Q: ä¸ºä»€ä¹ˆåœ¨ Agent æ¶æ„ä¸­ GraphRAG ä¼˜äºæ™®é€š RAGï¼Ÿ**
  - A: æ™®é€š RAG åªåšæ–‡æœ¬ç‰‡æ®µåŒ¹é…ï¼Œç¼ºä¹é€»è¾‘è”ç³»ã€‚GraphRAG é€šè¿‡çŸ¥è¯†å›¾è°±å¼•å…¥äº†â€œå…ˆä¿®è¯¾ç¨‹â€ã€â€œç›¸å…³æ¦‚å¿µâ€ç­‰æ‹“æ‰‘å…³ç³»ï¼Œä½¿ AI èƒ½æä¾›æ›´å…·æ¡ç†çš„å­¦ä¹ è·¯å¾„ã€‚
- **Q: å¦‚æœ LLM è°ƒç”¨è¶…æ—¶ï¼Œå¦‚ä½•ä¿è¯ Redis é”è¢«é‡Šæ”¾ï¼Ÿ**
  - A: ä¾é  `try...finally` å—ç¡®ä¿é‡Šæ”¾é€»è¾‘æ‰§è¡Œï¼ŒåŒæ—¶ä¸º Redis é”è®¾ç½® TTLï¼ˆç”Ÿå­˜æ—¶é—´ï¼‰ä½œä¸ºå…œåº•ã€‚

---

#### 3.2.2 ä¸Šä¸‹æ–‡æ„å»ºè¯¦è§£

```python
async def _build_user_context(self, user_id: str) -> UserContext:
    """æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡"""
    # 1. ä» DB è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    user = await self.user_service.get_user(user_id)

    # 2. å­¦ä¹ è¿›åº¦ç»Ÿè®¡ï¼ˆå¦‚ï¼šå·²å­¦èŠ‚ç‚¹æ•°ã€æ€»æ—¶é•¿ï¼‰
    progress = await self.stats_service.get_learning_progress(user_id)

    # 3. è·å–å½“å‰æ´»è·ƒçš„å†²åˆºè®¡åˆ’
    sprint = await self.sprint_service.get_active_sprint(user_id)

    # 4. æ¨é€åå¥½ï¼ˆç”¨äºå†³å®š AI çš„å›å¤é£æ ¼å’Œæé†’é¢‘ç‡ï¼‰
    push_pref = await self.push_service.get_preferences(user_id)

    return UserContext(
        user=user,
        progress=progress,
        active_sprint=sprint,
        push_preference=push_pref
    )

async def _retrieve_knowledge(self, user_id: str, query: str,
                             conversation_context: dict) -> KnowledgeContext:
    """GraphRAG çŸ¥è¯†æ£€ç´¢"""
    # 1. å‘é‡æ··åˆæœç´¢ (Hybrid Search)
    # æ€æƒ³ï¼šå¤šæ¨¡æ€å¬å›ã€‚åŒæ—¶é€šè¿‡è¯­ä¹‰å‘é‡ (pgvector) å’Œ å…³é”®è¯åŒ¹é… (Full-text search) æ‰¾åˆ°æœ€ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚
    vector_results = await self.galaxy_service.hybrid_search(
        user_id=user_id,
        query=query,
        limit=10
    )

    # 2. å…³ç³»æ‰©å±• (Relation Expansion)
    # æ€æƒ³ï¼šå…³è”æ€è€ƒã€‚ä¸ä»…çœ‹åŒ¹é…åˆ°çš„èŠ‚ç‚¹ï¼Œè¿˜è¦æ‹‰å–å®ƒä»¬çš„â€œçˆ¶èŠ‚ç‚¹â€ã€â€œå­èŠ‚ç‚¹â€æˆ–â€œå…ˆä¿®è¯¾ç¨‹â€ã€‚
    expanded = await self.galaxy_service.expand_relations(
        node_ids=[r.node_id for r in vector_results]
    )

    # 3. ç”¨æˆ·çŠ¶æ€è¿‡æ»¤
    # æ€æƒ³ï¼šä¸ªæ€§åŒ–è£å‰ªã€‚å‰”é™¤ç”¨æˆ·å·²ç»å®Œå…¨æŒæ¡çš„å†…å®¹ï¼Œæˆ–è€…æ ¹æ®ç”¨æˆ·ç­‰çº§æ¨èåˆé€‚éš¾åº¦çš„çŸ¥è¯†ã€‚
    filtered = await self.galaxy_service.filter_by_user_status(
        user_id, expanded
    )

    return KnowledgeContext(
        nodes=filtered,
        relations=expanded.relations,
        relevance_score=vector_results.relevance_score
    )
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å¢å¼ºå¼ç”Ÿæˆ (RAG)
- **æ€æƒ³**: LLM çš„çŸ¥è¯†æ˜¯é™æ€çš„ã€‚é€šè¿‡â€œæ£€ç´¢â€å¤–éƒ¨åŠ¨æ€æ•°æ®åº“ï¼Œå°†æœ€ç›¸å…³çš„ä¿¡æ¯å¡å…¥ Promptï¼Œä»è€Œè§£å†³ LLM çš„å¹»è§‰é—®é¢˜ã€‚

2. å…³æ³¨ç‚¹åˆ†ç¦» (SoC)
- **æ€æƒ³**: `_build_user_context` è´Ÿè´£â€œäººâ€ï¼Œ`_retrieve_knowledge` è´Ÿè´£â€œäº‹â€ã€‚
- **ä»·å€¼**: æ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹ï¼Œä»£ç æå…¶æ˜“äºæµ‹è¯•å’Œå¹¶è¡Œä¼˜åŒ–ã€‚


### 3.3 ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨ (ContextPruner)

#### 3.3.1 æ ¸å¿ƒç®—æ³•ä¸å¼‚æ­¥æ€»ç»“

```python
# backend/app/orchestration/context_pruner.py

class ContextPruner:
    """
    æ™ºèƒ½ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨
    è§£å†³ï¼šé•¿å¯¹è¯å¯¼è‡´çš„ Token è¶…é™ã€æ€§èƒ½ä¸‹é™åŠæˆæœ¬å¢åŠ é—®é¢˜
    """

    async def get_pruned_history(self, session_id: str, user_id: str) -> dict:
        # 1. ä» Redis åŠ è½½åŸå§‹å†å²
        history = await self._load_chat_history(session_id)
        if not history: return {"messages": []}

        # 2. æ»‘åŠ¨çª—å£å†³ç­– (Sliding Window)
        if len(history) <= self.max_history_messages:
            return {"messages": history, "summary_used": False}

        # 3. æ™ºèƒ½æ€»ç»“é€»è¾‘ (Summarization)
        # ç¼–ç¨‹æ€æƒ³ï¼šå¼‚æ­¥å›å¡«ã€‚å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰æ€»ç»“ï¼Œåˆ™è§¦å‘å¼‚æ­¥ LLM ä»»åŠ¡è¿›è¡Œå‹ç¼©ã€‚
        cache_key = f"summary:{session_id}"
        cached_summary = await self.redis.get(cache_key)

        if cached_summary:
            return {"messages": history[-5:], "summary": cached_summary, "summary_used": True}
        
        # è§¦å‘å¼‚æ­¥ä»»åŠ¡å¹¶è¿”å›â€œé™çº§â€ç»“æœï¼ˆä»…æœ€è¿‘æ¶ˆæ¯ï¼‰
        await self._trigger_async_summary(session_id, history)
        return {"messages": history[-5:], "summary_used": False}

    async def _trigger_async_summary(self, session_id, history):
        # ç¼–ç¨‹æ€æƒ³ï¼šå‰Šå³°å¡«è°·ã€‚é€šè¿‡ Redis é˜Ÿåˆ—è§£è€¦ï¼Œé¿å…é«˜å¹¶å‘ä¸‹åŒæ—¶è¯·æ±‚å¤§é‡ LLM æ€»ç»“ä»»åŠ¡ã€‚
        task = {"session_id": session_id, "history": history[:-5]}
        await self.redis.rpush("queue:summarization", json.dumps(task))
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. **ç©ºé—´æ¢æ—¶é—´ä¸å¼‚æ­¥å›å¡«**: æ€»ç»“ LLM è°ƒç”¨æå…¶è€—æ—¶ï¼ˆ2-4ç§’ï¼‰ã€‚é€šè¿‡å…ˆè¿”å›â€œçŸ­æœŸè®°å¿†â€å¹¶è§¦å‘å¼‚æ­¥æ€»ç»“ï¼Œç”¨æˆ·åœ¨ä¸‹ä¸€æ¬¡æé—®æ—¶å°±èƒ½äº«å—åˆ°â€œé•¿æœŸè®°å¿†â€æ‘˜è¦å¸¦æ¥çš„ç²¾å‡†å›å¤ã€‚
2. **ä¼˜é›…é™çº§ (Graceful Degradation)**: å½“æ€»ç»“ä»»åŠ¡å°šæœªå®Œæˆæ—¶ï¼Œç³»ç»Ÿé€šè¿‡åªè¿”å›æœ€è¿‘ N æ¡æ¶ˆæ¯æ¥ç»´æŒåŸºæœ¬æœåŠ¡ï¼Œè€Œä¸æ˜¯æŠ¥é”™æˆ–è®©ç”¨æˆ·é•¿æ—¶é—´ç­‰å¾…ã€‚

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

- **Q: é™¤äº†æ€»ç»“ï¼Œè¿˜æœ‰å“ªäº›æ–¹æ³•å¯ä»¥èŠ‚çœ Tokenï¼Ÿ**
  - A: 1. **è¯­ä¹‰è¿‡æ»¤**: é€šè¿‡å‘é‡åŒ¹é…åªä¿ç•™ç›¸å…³çš„å†å²ç‰‡æ®µã€‚ 2. **Prompt å‹ç¼©**: ç¼©å‡ System Instructionã€‚ 3. **è§’è‰²åˆå¹¶**: åˆå¹¶è¿ç»­çš„ User/Assistant æ¶ˆæ¯ã€‚
- **Q: å¦‚æœ Redis æŒ‚äº†ï¼Œä¸Šä¸‹æ–‡ä¿®å‰ªè¿˜èƒ½å·¥ä½œå—ï¼Ÿ**
  - A: é˜²å¾¡æ€§è®¾è®¡ã€‚ä»£ç åº”æœ‰ Try-Except ä¿æŠ¤ï¼Œå½“ç¼“å­˜ä¸å¯ç”¨æ—¶å›é€€åˆ°çº¯æ»‘åŠ¨çª—å£æ¨¡å¼ï¼Œç¡®ä¿ç³»ç»Ÿä¸å´©æºƒã€‚

---

#### 3.3.2 å¼‚æ­¥æ€»ç»“å·¥ä½œå™¨

```python
# backend/app/workers/summary_worker.py

class SummaryWorker:
    """åå°æ€»ç»“å·¥ä½œå™¨"""

    async def process_summarization_queue(self):
        """å¤„ç†æ€»ç»“é˜Ÿåˆ—"""
        while True:
            # 1. é˜»å¡å¼ä» Redis é˜Ÿåˆ—ä¸­æå–ä»»åŠ¡ (BLPOP)
            # æ€æƒ³ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ã€‚Web è¯·æ±‚æ˜¯ç”Ÿäº§è€…ï¼ŒWorker æ˜¯æ¶ˆè´¹è€…ï¼Œé€šè¿‡é˜Ÿåˆ—è§£è€¦ã€‚
            task_data = await self.redis.blpop("queue:summarization", timeout=1)
            if not task_data: continue

            # 2. ç”Ÿæˆå†å²æ€»ç»“
            summary = await self._generate_summary(task["history"])

            # 3. ç¼“å­˜ç»“æœåˆ° Redis
            # æ€æƒ³ï¼šå¼‚æ­¥å›å¡«ã€‚ä¸‹ä¸€æ¬¡ç”¨æˆ·è¯·æ±‚æ—¶ï¼ŒContextPruner å°±èƒ½åœ¨ Redis ä¸­ç›´æ¥å‘½ä¸­æ€»ç»“å†…å®¹ã€‚
            await self.redis.setex(f"summary:{task['session_id']}", 3600, summary)
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å‰Šå³°å¡«è°·
- **æ€æƒ³**: å°†æ˜‚è´µçš„ LLM æ€»ç»“æ“ä½œä»åŒæ­¥é“¾è·¯ç§»åˆ°å¼‚æ­¥é˜Ÿåˆ—ä¸­ã€‚å³ä½¿ç¬é—´æœ‰å¤§é‡ç”¨æˆ·å¯¹è¯ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸ä¼šå› ä¸ºåŒæ—¶è¯·æ±‚å¤§é‡ LLM æ€»ç»“è€ŒæŒ‚æ‰ï¼Œè€Œæ˜¯æ’é˜Ÿå¤„ç†ã€‚

### 3.4 åŠ¨æ€å·¥å…·ç³»ç»Ÿ

#### 3.4.1 å·¥å…·æ³¨å†Œè¡¨

```python
# backend/app/orchestration/dynamic_tool_registry.py

class DynamicToolRegistry:
    """åŠ¨æ€å·¥å…·æ³¨å†Œè¡¨ - è‡ªåŠ¨å‘ç°æ¨¡å¼"""

    def register_from_package(self, package_path: str) -> int:
        # 1. åˆ©ç”¨ Python åå°„æœºåˆ¶åŠ¨æ€åŠ è½½æ¨¡å—
        # æ€æƒ³ï¼šå¼€é—­åŸåˆ™ã€‚æ–°å¢ä¸€ä¸ª AI å·¥å…·åªéœ€è¦åœ¨ tools ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¸éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨çš„ä»£ç ã€‚
        package = importlib.import_module(package_path)
        for importer, modname, ispkg in pkgutil.iter_modules(package.__path__):
            # è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰ BaseTool çš„å­ç±»
            self.register_from_module(f"{package_path}.{modname}")

    def get_openai_tools_schema(self) -> List[dict]:
        # 2. è½¬æ¢ä¸º OpenAI å…¼å®¹çš„ JSON Schema æè¿°
        return [tool.to_openai_schema() for tool in self._tools.values()]
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æ’ä»¶åŒ–æ¶æ„ (Plugin Architecture)
- **æ€æƒ³**: å·¥å…·æ³¨å†Œè¡¨ä¸ç¡¬ç¼–ç ä»»ä½•å…·ä½“å·¥å…·ï¼Œè€Œæ˜¯æä¾›ä¸€ä¸ªâ€œæ’æ§½â€ã€‚è¿™ä½¿å¾—ç³»ç»Ÿå…·å¤‡æå¼ºçš„å¯æ‰©å±•æ€§ï¼Œç”šè‡³å¯ä»¥åŠ¨æ€çƒ­åŠ è½½æ–°å·¥å…·ã€‚


#### 3.4.2 å·¥å…·åŸºç±»è®¾è®¡

```python
# backend/app/orchestration/base_tool.py

class BaseTool:
    """å·¥å…·åŸºç±» - å®šä¹‰æ ‡å‡†æ¥å£"""

    # 1. å…ƒæ•°æ®å®šä¹‰
    name: str           # å·¥å…·å”¯ä¸€æ ‡è¯†
    description: str    # ç”¨äºå‘Šè¯‰ LLM ä»€ä¹ˆæ—¶å€™è¯¥ç”¨è¿™ä¸ªå·¥å…·
    category: ToolCategory

    # 2. å‚æ•° Schema (JSON Schema æ ¼å¼)
    # æ€æƒ³ï¼šè‡ªæè¿°ã€‚å·¥å…·è‡ªå·±å®šä¹‰éœ€è¦ä»€ä¹ˆå‚æ•°ï¼ŒLLM æ ¹æ®è¿™ä¸ªå®šä¹‰æ¥æå–å‚æ•°ã€‚
    parameters_schema: Optional[Dict[str, Any]] = None

    async def execute(self, **kwargs) -> Dict[str, Any]:
        """æ‰§è¡Œé€»è¾‘ - ç”±å­ç±»å®ç°"""
        raise NotImplementedError

    def to_openai_schema(self) -> dict:
        """è½¬æ¢ä¸º OpenAI åè®®æ ¼å¼"""
        # å°† Python å®šä¹‰è½¬æ¢ä¸º OpenAI API æ‰€éœ€çš„ç‰¹å®š JSON ç»“æ„
        ...
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æŠ½è±¡å·¥å‚/æ¨¡æ¿æ–¹æ³•æ¨¡å¼
- **æ€æƒ³**: `BaseTool` å®šä¹‰äº†å·¥å…·çš„â€œéª¨æ¶â€ï¼ˆåç§°ã€æè¿°ã€Schema è½¬æ¢é€»è¾‘ï¼‰ï¼Œè€Œå…·ä½“çš„â€œè‚‰â€ï¼ˆ`execute` å‡½æ•°çš„é€»è¾‘ï¼‰ç•™ç»™å­ç±»å®ç°ã€‚
- **ä¼˜ç‚¹**: ä¿è¯äº†æ‰€æœ‰å·¥å…·åœ¨ç³»ç»Ÿç¼–æ’ä¸­è¡¨ç°ä¸€è‡´ã€‚

### 3.5 LLM æœåŠ¡é›†æˆ

#### 3.5.1 å¤šæ¨¡å‹æ”¯æŒ

```python
# backend/app/services/llm_service.py

class LLMService:
    """LLM æœåŠ¡ - é€‚é…å™¨æ¨¡å¼å®ç°"""

    async def chat_stream_with_tools(self, messages, tools, model=None):
        # 1. ç­–ç•¥æ¨¡å¼ï¼šæ ¹æ®é…ç½®åŠ¨æ€åˆ‡æ¢æ¨¡å‹æä¾›å•†
        provider = self.providers.get(model or self.default_provider)

        # 2. é€’å½’/å¾ªç¯å¤„ç†å·¥å…·è°ƒç”¨
        # æµç¨‹ï¼šLLM å†³å®šè°ƒç”¨å·¥å…· -> æ‰§è¡Œå·¥å…· -> å°†ç»“æœå–‚å› LLM -> ç”Ÿæˆæœ€ç»ˆå›ç­”
        async for chunk in provider.chat_complete(messages, tools, stream=True):
            if chunk.type == "tool_call":
                # æ‰§è¡Œå·¥å…·å¹¶è·å¾—ç»“æœ
                results = await self._execute_tools(chunk.tool_calls)
                # é‡è¦ï¼šå°†å·¥å…·æ‰§è¡Œç»“æœæ·»åŠ å›å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œå†æ¬¡è¯·æ±‚ LLM
                messages.append({"role": "tool", "content": results})
                # é€’å½’ç”Ÿæˆåç»­å›ç­”
                async for final_chunk in self.chat_stream_with_tools(...):
                    yield final_chunk
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. é€‚é…å™¨æ¨¡å¼ (Adapter)
- **æ€æƒ³**: å°è£…ä¸åŒ LLM å‚å•†ï¼ˆOpenAI, Anthropic, DeepSeekï¼‰çš„ API å·®å¼‚ï¼Œä¸ºä¸šåŠ¡å±‚æä¾›ç»Ÿä¸€çš„æ¥å£ã€‚
- **ä»·å€¼**: å®ç°â€œæ¨¡å‹ä¸­ç«‹â€ï¼Œéšæ—¶å¯ä»¥ä¸ºäº†æ€§ä»·æ¯”æˆ–æ€§èƒ½æ›´æ¢åº•å±‚æ¨¡å‹ã€‚


### 3.6 Python Agent ç”Ÿäº§çº§ç‰¹æ€§

| ç‰¹æ€§ | å®ç° | ä»·å€¼ |
|------|------|------|
| **æ¶ˆæ¯å»é‡** | MessageTracker + Redis | é˜²æ­¢é‡å¤å¤„ç† |
| **ç†”æ–­ä¿æŠ¤** | CircuitBreaker | é˜²æ­¢çº§è”æ•…éšœ |
| **å¹¶å‘æ§åˆ¶** | Session Lock + Redis | é¿å…èµ„æºç«äº‰ |
| **ä¸Šä¸‹æ–‡ä¿®å‰ª** | ContextPruner | èŠ‚çœ Token + æ€§èƒ½ |
| **åŠ¨æ€å·¥å…·** | è‡ªåŠ¨å‘ç° + æ³¨å†Œè¡¨ | çµæ´»æ‰©å±• |
| **ç›‘æ§åŸ‹ç‚¹** | Prometheus + Metrics | å¯è§‚æµ‹æ€§ |
| **å¼‚æ­¥å¤„ç†** | asyncio + é˜Ÿåˆ— | é«˜æ€§èƒ½ |
| **é”™è¯¯é™çº§** | Graceful Degradation | ç³»ç»Ÿç¨³å®šæ€§ |

---

## 4. Flutter Mobile - è·¨å¹³å°ç§»åŠ¨ç«¯

### 4.1 åº”ç”¨æ¶æ„

```
mobile/lib/
â”œâ”€â”€ main.dart                          # åº”ç”¨å…¥å£
â”œâ”€â”€ app/
â”‚   â””â”€â”€ app.dart                       # Riverpod é…ç½®
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ websocket_chat_service_v2.dart  # WebSocket æœåŠ¡
â”‚   â””â”€â”€ constants/
â”‚       â””â”€â”€ api_constants.dart         # API é…ç½®
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ chat_stream_events.dart    # æµäº‹ä»¶æ¨¡å‹
â”‚   â””â”€â”€ repositories/
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â””â”€â”€ chat_provider.dart         # Riverpod çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”œâ”€â”€ chat_screen.dart           # èŠå¤©ç•Œé¢
â”‚   â”‚   â””â”€â”€ galaxy_screen.dart         # çŸ¥è¯†æ˜Ÿå›¾
â”‚   â””â”€â”€ widgets/
â”‚       â””â”€â”€ message_bubble.dart        # æ¶ˆæ¯æ°”æ³¡
â””â”€â”€ domain/
    â””â”€â”€ entities/                      # é¢†åŸŸå®ä½“
```

### 4.2 WebSocket æœåŠ¡ v2

#### 4.2.1 æ ¸å¿ƒæœåŠ¡å®ç°

```dart
// mobile/lib/core/services/websocket_chat_service_v2.dart

class WebSocketChatServiceV2 {
  // ã€å•ä¾‹æ¨¡å¼ã€‘: ç¡®ä¿å…¨å±€å”¯ä¸€è¿æ¥ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æº
  static final WebSocketChatServiceV2 _instance = WebSocketChatServiceV2._internal();
  factory WebSocketChatServiceV2() => _instance;

  WebSocketChannel? _channel;
  StreamController<ChatStreamEvent>? _messageStreamController;
  WsConnectionState _connectionState = WsConnectionState.disconnected;

  // ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘: è¿æ¥æ–­å¼€æ—¶æš‚å­˜æ¶ˆæ¯ï¼Œé‡è¿åè‡ªåŠ¨é‡å‘ï¼Œä¿è¯â€œé›¶ä¸¢å¤±â€
  final List<Map<String, dynamic>> _pendingMessages = [];

  // ä¸»æ–¹æ³•ï¼šå‘é€æ¶ˆæ¯å¹¶è¿”å›æµ
  Stream<ChatStreamEvent> sendMessage({required String message, required String userId}) {
    _messageStreamController ??= StreamController<ChatStreamEvent>.broadcast();

    if (_connectionState == WsConnectionState.disconnected) {
      _establishConnection(userId);
    }

    final payload = {'message': message, 'user_id': userId, 'timestamp': DateTime.now().toIso8601String()};

    if (isConnected) {
      _channel!.sink.add(json.encode(payload));
    } else {
      _pendingMessages.add(payload); // å­˜å…¥ç¼“å†²åŒº
    }

    return _messageStreamController!.stream;
  }

  void _establishConnection(String userId) {
    _channel = WebSocketChannel.connect(Uri.parse(ApiConstants.wsUrl));
    _connectionState = WsConnectionState.connecting;

    _channel!.stream.listen(
      (data) => _handleMessage(data),
      onError: (e) => _handleError(e),
      onDone: () => _handleDisconnect(userId),
    );

    // æ¡æ‰‹è®¤è¯
    _channel!.sink.add(json.encode({'type': 'auth', 'token': 'Bearer ...'}));
    _connectionState = WsConnectionState.connected;
    
    // é‡è¿æˆåŠŸåï¼Œæ¸…ç©ºç¼“å†²åŒº
    _flushPendingMessages();
  }

  // ã€æŒ‡æ•°é€€é¿é‡è¿ã€‘: é¿å…é«˜é¢‘è¯·æ±‚æ‹–å®ç§»åŠ¨ç«¯ç”µé‡ä¸æœåŠ¡å™¨è´Ÿè½½
  void _handleDisconnect(String userId) {
    _connectionState = WsConnectionState.disconnected;
    int retryCount = 0;
    Timer.periodic(Duration(seconds: math.pow(2, retryCount).toInt()), (timer) {
      if (isConnected || retryCount > 5) timer.cancel();
      _establishConnection(userId);
      retryCount++;
    });
  }
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è®²è§£

1. **å•ä¾‹æ¨¡å¼ (Singleton)**: åœ¨ç§»åŠ¨ç«¯å¼€å‘ä¸­ï¼Œé•¿è¿æ¥ã€æ•°æ®åº“è®¿é—®é€šå¸¸è®¾è®¡ä¸ºå•ä¾‹ï¼Œä»¥é¿å…å¤šæ¬¡åˆ›å»ºå¯¼è‡´çš„å†…å­˜æ¿€å¢å’ŒçŠ¶æ€å†²çªã€‚
2. **ç¼“å†²é˜Ÿåˆ— (Buffering)**: ç§»åŠ¨ç«¯ç½‘ç»œç¯å¢ƒæä¸ç¨³å®šï¼ˆå¦‚è¿›ç”µæ¢¯ã€åˆ‡ Wi-Fiï¼‰ã€‚é€šè¿‡ç¼“å†²åŒºæš‚å­˜è¯·æ±‚ï¼Œåœ¨é‡è¿æˆåŠŸåè‡ªåŠ¨é‡å‘ï¼Œæå¤§åœ°ä¼˜åŒ–äº†å¼±ç½‘ä¸‹çš„ç”¨æˆ·ä½“éªŒã€‚
3. **å“åº”å¼æµ (Reactive Streams)**: ä½¿ç”¨ `StreamController` å°†ä½å±‚çº§çš„ Socket å­—èŠ‚æµè½¬æ¢ä¸ºé«˜å±‚çº§çš„ä¸šåŠ¡äº‹ä»¶æµï¼Œä½¿ UI å±‚çš„è®¢é˜…é€»è¾‘æ›´åŠ çº¯ç²¹ã€‚

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

- **Q: ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ UI ç›‘å¬ WebSocket åŸå§‹æµï¼Ÿ**
  - A: èŒè´£åˆ†ç¦»ã€‚WebSocket æœåŠ¡è´Ÿè´£åè®®è§£æã€å¿ƒè·³ã€é‡è¿ç­‰åº•å±‚é€»è¾‘ï¼›UI åªå…³å¿ƒä¸šåŠ¡äº‹ä»¶ï¼ˆå¦‚â€œæ”¶åˆ°æ–‡æœ¬â€ã€â€œå·¥å…·è°ƒç”¨å¼€å§‹â€ï¼‰ï¼Œè¿™å¢åŠ äº†ç³»ç»Ÿçš„å¯æµ‹è¯•æ€§ã€‚
- **Q: ç§»åŠ¨ç«¯å¦‚ä½•å¤„ç†åå°è¢«ç³»ç»Ÿ Kill å¯¼è‡´çš„æ–­è¿ï¼Ÿ**
  - A: ç›‘å¬ `AppLifecycleState`ã€‚å½“ App ä»åå°åˆ‡å›å‰å°æ—¶ï¼Œä¸»åŠ¨è§¦å‘ WebSocket çŠ¶æ€æ£€æŸ¥ä¸æ‰‹åŠ¨é‡è¿é€»è¾‘ã€‚

---


#### 4.2.2 é‡è¿æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

```dart
void _triggerReconnect() {
  _reconnectAttempts++;

  # 1. æŒ‡æ•°é€€é¿ç®—æ³• (Exponential Backoff)
  # æ€æƒ³ï¼šä¿æŠ¤æœºåˆ¶ã€‚å½“æœåŠ¡å™¨å®•æœºæˆ–ç½‘ç»œæå·®æ—¶ï¼Œä¸è¦é«˜é¢‘é‡è¿æ‹–å®æ‰‹æœºç”µé‡å’ŒæœåŠ¡å™¨ IOã€‚
  # å»¶è¿Ÿæ—¶é—´ï¼š2^1=2s, 2^2=4s, 2^3=8s... æœ€é«˜ 32sã€‚
  final delaySeconds = math.min(math.pow(2, _reconnectAttempts).toInt(), 32);

  _reconnectTimer = Timer(Duration(seconds: delaySeconds), () {
    if (_currentUserId != null) {
      _establishConnection(_currentUserId!);
    }
  });
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æŒ‡æ•°é€€é¿ (Exponential Backoff)
- **åŸç†**: éšç€å¤±è´¥æ¬¡æ•°å¢åŠ ï¼Œé‡è¯•é—´éš”å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚
- **ä»·å€¼**: åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­è¿™æ˜¯é˜²èŒƒâ€œé‡è¯•é£æš´â€çš„æ ‡å‡†åšæ³•ã€‚

#### 4.2.3 å¿ƒè·³ä¿æ´»

```dart
void _startHeartbeat() {
  # 1. å‘¨æœŸæ€§å‘é€ Ping æ¶ˆæ¯
  # æ€æƒ³ï¼šåº”ç”¨å±‚ä¿æ´»ã€‚TCP è™½ç„¶æœ‰ KeepAliveï¼Œä½†ç”±äºè¿è¥å•† NAT ç½‘å…³çš„å­˜åœ¨ï¼Œé•¿è¿æ¥ç»å¸¸è¢«æ–­å¼€ã€‚
  _heartbeatTimer = Timer.periodic(Duration(seconds: 30), (timer) {
    if (isConnected) {
      _channel!.sink.add(json.encode({'type': 'ping'}));
    }
  });
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æ˜¾å¼å¿ƒè·³ (Active Heartbeat)
- **åŸå› **: ç§»åŠ¨ç½‘ç»œç¯å¢ƒæå…¶å¤æ‚ï¼Œæ˜¾å¼å¿ƒè·³èƒ½ç¡®ä¿è¿æ¥é“¾è·¯å„ç¯èŠ‚ï¼ˆæ‰‹æœºã€åŸºç«™ã€ç½‘å…³ã€åç«¯ï¼‰éƒ½è®¤ä¸ºè¯¥è¿æ¥æ˜¯æ´»è·ƒçš„ã€‚


### 4.3 Riverpod çŠ¶æ€ç®¡ç†

#### 4.3.1 Provider æ¶æ„

```dart
// mobile/lib/presentation/providers/chat_provider.dart

// WebSocket æœåŠ¡ Provider
final webSocketServiceProvider = Provider<WebSocketChatServiceV2>((ref) {
  return WebSocketChatServiceV2();
});

// èŠå¤©çŠ¶æ€ Notifier
final chatProvider = StateNotifierProvider<ChatNotifier, ChatState>((ref) {
  return ChatNotifier(ref.watch(webSocketServiceProvider));
});

// èŠå¤©çŠ¶æ€
@freezed
class ChatState with _$ChatState {
  const factory ChatState({
    @Default([]) List<ChatMessage> messages,
    @Default(false) bool isLoading,
    @Default('') String response,
    @Default('') String error,
    @Default(null) AgentState? agentStatus,
    @Default(null) String? toolCalling,
    @Default(false) bool isTyping,
  }) = _ChatState;
}

// èŠå¤© Notifier
class ChatNotifier extends StateNotifier<ChatState> {
  final WebSocketChatServiceV2 _wsService;
  StreamSubscription? _subscription;

  ChatNotifier(this._wsService) : super(ChatState());

  Future<void> sendMessage(String message) async {
    # ========== ç¬¬1æ­¥ï¼šæœ¬åœ°çŠ¶æ€å¿«é€Ÿæ›´æ–° ==========
    # æ€æƒ³ï¼šå“åº”å¼ç¼–ç¨‹ã€‚ç«‹å³æ›´æ–° UIï¼Œè®©ç”¨æˆ·æ„Ÿè§‰åˆ°æ“ä½œçš„å®æ—¶æ€§ï¼ˆä¹è§‚ UI æ›´æ–°ï¼‰ã€‚
    state = state.copyWith(
      messages: [
        ...state.messages,
        ChatMessage(role: 'user', content: message, timestamp: DateTime.now()),
      ],
      isLoading: true,
      error: '',
      response: '',
    );

    # ========== ç¬¬2æ­¥ï¼šé€šè¿‡ WebSocket å‘é€è¯·æ±‚ ==========
    # æ•°æ®æµå‘ï¼šUI è¾“å…¥ -> ChatNotifier -> WebSocketService -> Server
    final stream = _wsService.sendMessage(
      message: message,
      userId: _getUserId(),
    );

    # ========== ç¬¬3æ­¥ï¼šæµè®¢é˜…ä¸äº‹ä»¶å¤„ç† ==========
    # æ€æƒ³ï¼šæµå¼å¤„ç†ã€‚AI çš„å›å¤æ˜¯é€å­—åå‡ºçš„ï¼Œé€šè¿‡ Stream ç›‘å¬å¯ä»¥å®ç°å®æ—¶æ‰“å­—æœºæ•ˆæœã€‚
    await _subscription?.cancel();
    _subscription = stream.listen(
      (event) => _handleStreamEvent(event),
      onError: _handleError,
      onDone: _handleDone,
    );
  }

  void _handleStreamEvent(ChatStreamEvent event) {
    # ========== ç¬¬4æ­¥ï¼šå¤šç±»å‹äº‹ä»¶åˆ†å‘ ==========
    event.when(
      # æ–‡æœ¬äº‹ä»¶ï¼šç´¯åŠ  AI å›å¤å†…å®¹
      text: (content) {
        state = state.copyWith(
          response: state.response + content,
          isTyping: true,
        );
      },

      # çŠ¶æ€äº‹ä»¶ï¼šæ˜¾ç¤º AI å½“å‰æ€è€ƒé˜¶æ®µï¼ˆå¦‚ï¼šæœç´¢ä¸­ã€æ‰§è¡Œå·¥å…·ï¼‰
      statusUpdate: (agentState, details) {
        state = state.copyWith(agentStatus: agentState);
      },

      # é”™è¯¯äº‹ä»¶ï¼šå¤„ç†æ–­ç½‘ã€åç«¯æŠ¥é”™ç­‰å¼‚å¸¸
      error: (code, message) {
        state = state.copyWith(error: message, isLoading: false);
      },

      # å®Œæˆäº‹ä»¶ï¼šå°†å®Œæ•´å›å¤å­˜å…¥æ¶ˆæ¯å†å²
      done: () => _handleDone(),
      
      # å…¶ä»–äº‹ä»¶ (toolStart, toolResult...)
      toolStart: (name) => state = state.copyWith(toolCalling: name),
      toolResult: (name, res) => null,
    );
  }
}

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å£°æ˜å¼ UI (Declarative UI)
- **æ€æƒ³**: åœ¨ Flutter ä¸­ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨å»æ“ä½œ Widget çš„æ–‡æœ¬ï¼ˆå¦‚ `label.text = "..."`ï¼‰ï¼Œè€Œæ˜¯ä¿®æ”¹ `state`ã€‚Riverpod ä¼šè‡ªåŠ¨æ£€æµ‹ `state` çš„å˜åŒ–å¹¶è§¦å‘ UI é‡æ–°æ„å»ºï¼ˆWidget Buildï¼‰ã€‚
- **è¯„å§”è€ƒå¯Ÿ**: è¿™æ ·åšæ€§èƒ½ä¼šæœ‰é—®é¢˜å—ï¼Ÿç­”ï¼šFlutter çš„è™šæ‹Ÿ DOMï¼ˆElement Treeï¼‰ä¼šè¿›è¡Œ Diff æ¯”å¯¹ï¼Œåªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†ï¼Œæ€§èƒ½æä½³ã€‚

2. ä¸å¯å˜æ•°æ® (Immutability)
- **å®ç°**: `state = state.copyWith(...)`
- **æ€æƒ³**: æ¯æ¬¡çŠ¶æ€æ›´æ–°éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¿®æ”¹åŸå¯¹è±¡ã€‚è¿™ä½¿å¾—çŠ¶æ€å˜åŒ–å¯è¿½è¸ªï¼Œæ–¹ä¾¿å®ç°â€œæ’¤é”€/é‡åšâ€æˆ–â€œæ—¶é—´æ—…è¡Œè°ƒè¯•â€ã€‚
- **è¯„å§”è€ƒå¯Ÿ**: ä¸ºä»€ä¹ˆä¸ç”¨ `state.messages.add(msg)`ï¼Ÿç­”ï¼šç›´æ¥ä¿®æ”¹ä¼šç ´å Riverpod çš„çŠ¶æ€å¯¹æ¯”æœºåˆ¶ï¼Œå¯¼è‡´ UI ä¸åˆ·æ–°ã€‚

3. å•å‘æ•°æ®æµ (Unidirectional Data Flow)
- **æµå‘**: UI è§¦å‘ Action -> Notifier ä¿®æ”¹ State -> UI å“åº” Stateã€‚
- **å¥½å¤„**: é€»è¾‘æ¸…æ™°ï¼Œé¿å…äº†è§†å›¾ï¼ˆViewï¼‰å’Œæ•°æ®ï¼ˆModelï¼‰ä¹‹é—´çš„åŒå‘è€¦åˆå¸¦æ¥çš„æ··ä¹±ã€‚

ğŸ”„ å®Œæ•´æ•°æ®æµå‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç‚¹å‡» "å‘é€"                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatNotifier (Action)            â”‚
â”‚ 1. state = state.copyWith(...)   â”‚
â”‚ 2. è°ƒç”¨ WebSocket æ¥å£           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSocket (Stream äº§å‡ºæ•°æ®)       â”‚
â”‚ 3. æ¥æ”¶åˆ°: {"type": "text", ...} â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatNotifier (State å˜æ›´)        â”‚
â”‚ 4. state = state.copyWith(...)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatScreen (UI è‡ªåŠ¨åˆ·æ–°)          â”‚
â”‚ 5. Text æ§ä»¶æ˜¾ç¤ºæœ€æ–°çš„ response  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

é—®é¢˜1ï¼šRiverpod å’Œ Provider æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
- **å›ç­”è¦ç‚¹**ï¼š
  - **å®‰å…¨æ€§**: Riverpod åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ Providerï¼Œé¿å…äº† Provider å¸¸è§çš„ ProviderNotFoundExceptionã€‚
  - **è§£è€¦**: Riverpod ä¸ä¾èµ– BuildContextï¼Œå¯ä»¥åœ¨é€»è¾‘å±‚æ›´æ–¹ä¾¿åœ°ä½¿ç”¨ã€‚
  - **æ€§èƒ½**: æ”¯æŒæ›´ç²¾ç»†çš„ `select` ç›‘å¬ï¼Œå‡å°‘ä¸å¿…è¦çš„ UI åˆ·æ–°ã€‚

é—®é¢˜2ï¼šå¦‚ä½•å¤„ç†é•¿åˆ—è¡¨æ¶ˆæ¯å¯¼è‡´çš„å†…å­˜æº¢å‡ºï¼Ÿ
- **å›ç­”è¦ç‚¹**ï¼šä½¿ç”¨ `ListView.builder` å®ç°æ‡’åŠ è½½ï¼ˆå»¶è¿Ÿæ¸²æŸ“ï¼‰ï¼Œåªæ¸²æŸ“å½“å‰å±å¹•å¯è§çš„æ¶ˆæ¯æ°”æ³¡ã€‚

é—®é¢˜3ï¼šå¦‚æœç½‘ç»œçªç„¶æ–­å¼€ï¼ŒUI åº”è¯¥å¦‚ä½•æç¤ºï¼Ÿ
- **å›ç­”è¦ç‚¹**ï¼šåœ¨ `WebSocketService` ä¸­ç›‘å¬æ–­å¼€äº‹ä»¶ï¼Œå¹¶é€šè¿‡ `ChatStreamEvent.error` é€šçŸ¥ Notifierï¼Œæ›´æ–° `state.error`ï¼ŒUI å±‚é€šè¿‡ `SnackBar` æˆ–é”™è¯¯æç¤ºç»„ä»¶åé¦ˆç»™ç”¨æˆ·ã€‚

```

### 4.4 UI ç•Œé¢å®ç°

#### 4.4.1 èŠå¤©ç•Œé¢

```dart
// mobile/lib/presentation/screens/chat_screen.dart

class ChatScreen extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    # 1. å£°æ˜å¼ç›‘å¬
    # æ€æƒ³ï¼šæ•°æ®é©±åŠ¨ã€‚å½“ chatProvider çš„ state å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™ä¸ª build å‡½æ•°ä¼šè‡ªåŠ¨é‡æ–°è¿è¡Œã€‚
    final chatState = ref.watch(chatProvider);

    return Scaffold(
      body: Column(
        children: [
          # 2. æ¶ˆæ¯å±•ç¤º (ListView.builder)
          # æ€æƒ³ï¼šæŒ‰éœ€åŠ è½½ã€‚å³ä½¿æœ‰å‡ åƒæ¡æ¶ˆæ¯ï¼Œä¹Ÿåªæ¸²æŸ“å½“å‰å±å¹•æ˜¾ç¤ºçš„å‡ ä¸ª Itemã€‚
          Expanded(
            child: ListView.builder(
              itemCount: chatState.messages.length,
              itemBuilder: (context, index) => MessageBubble(message: chatState.messages[index]),
            ),
          ),
          
          # 3. å®æ—¶å“åº”å±•ç¤º
          # æ€æƒ³ï¼šå±€éƒ¨åˆ·æ–°ã€‚
          if (chatState.isTyping) _buildStatusPanel(chatState),
          _buildInputArea(context, ref.read(chatProvider.notifier), chatState),
        ],
      ),
    );
  }
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å£°æ˜å¼ UI (Declarative UI)
- **æ€æƒ³**: `UI = f(state)`ã€‚ä½ åªæè¿°å½“å‰çŠ¶æ€ä¸‹ç•Œé¢é•¿ä»€ä¹ˆæ ·ï¼Œä¸éœ€è¦æ‰‹åŠ¨å»æŸ¥æ‰¾æŸä¸ª Label å¹¶ä¿®æ”¹å®ƒçš„æ–‡æœ¬ã€‚

### 4.5 çŸ¥è¯†æ˜Ÿå›¾ç•Œé¢ï¼ˆGLSL ç€è‰²å™¨ï¼‰

```dart
// æ ¸å¿ƒç»˜åˆ¶é€»è¾‘
class GalaxyPainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    # 1. ç»˜åˆ¶èƒŒæ™¯
    # ä½¿ç”¨ RadialGradient æ¨¡æ‹Ÿæ·±é‚ƒçš„æ˜Ÿç³»æ•ˆæœã€‚
    _drawBackground(canvas, size);

    # 2. ç»˜åˆ¶èŠ‚ç‚¹ä¸æŒæ¡åº¦
    for (final node in nodes) {
      # ç»˜åˆ¶å¤–å‘å…‰ (Glow Effect)
      # æ€æƒ³ï¼šè§†è§‰åˆ†çº§ã€‚åˆ©ç”¨ MaskFilter.blur å®ç°å‘å…‰ï¼Œæ ¹æ® importance å†³å®šåŠå¾„ã€‚
      final glowPaint = Paint()..maskFilter = MaskFilter.blur(BlurStyle.normal, 8);
      canvas.drawCircle(offset, radius + 4, glowPaint);

      # ç»˜åˆ¶æŒæ¡åº¦ç¯ (Arc)
      # æ€æƒ³ï¼šæ•°æ®å¯è§†åŒ–ã€‚æŒæ¡åº¦è¶Šé«˜ï¼Œåœ†å¼§è¶Šé•¿ï¼ˆ360åº¦ * mastery / 100ï¼‰ã€‚
      canvas.drawArc(rect, -pi/2, (node.mastery/100) * 2 * pi, false, sweepPaint);
    }
  }
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å›¾å½¢æµæ°´çº¿ (Canvas API)
- **æ€æƒ³**: Flutter çš„ CustomPainter ç›´æ¥æ“ä½œåº•å±‚çš„ Skia ç»˜å›¾å¼•æ“ã€‚
- **ä¼˜ç‚¹**: æ€§èƒ½æé«˜ï¼Œå¯ä»¥å®ç°å¤æ‚çš„ã€é«˜é¢‘åˆ·æ–°çš„å›¾å½¢åŠ¨ç”»ã€‚

```

---

## 5. æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ

### 5.1 æ ¸å¿ƒè¡¨ç»“æ„è®¾è®¡

#### 5.1.1 çŸ¥è¯†ç³»ç»Ÿæ ¸å¿ƒè¡¨

```sql
-- ============================================
-- çŸ¥è¯†èŠ‚ç‚¹è¡¨ (Knowledge Nodes)
-- å­˜å‚¨çŸ¥è¯†ç‚¹åŠå…¶å‘é‡åµŒå…¥ï¼Œå®ç°â€œè¯­ä¹‰æœç´¢â€
-- ============================================
CREATE TABLE knowledge_nodes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    -- å‘é‡åµŒå…¥ (pgvector): å­˜å‚¨ 1536 ç»´è¯­ä¹‰å‘é‡
    embedding VECTOR(1536),
    importance_level INTEGER NOT NULL DEFAULT 1,
    CONSTRAINT chk_importance CHECK (importance_level BETWEEN 1 AND 5)
);

-- ã€ç”Ÿäº§çº§ä¼˜åŒ–ã€‘: HNSW ç´¢å¼• (Hierarchical Navigable Small World)
-- ç¼–ç¨‹æ€æƒ³ï¼šç©ºé—´åˆ†å‰²ä¸è¿‘ä¼¼æœç´¢ã€‚åœ¨å¤§è§„æ¨¡å‘é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°è¯­ä¹‰æœ€è¿‘é‚»ã€‚
-- å‚æ•°å«ä¹‰ï¼š
-- m: æ¯ä¸ªèŠ‚ç‚¹çš„é‚»å±…æ•°ï¼Œè¶Šé«˜ç²¾åº¦è¶Šé«˜ä½†å†…å­˜å ç”¨è¶Šå¤§ã€‚
-- ef_construction: æ„å»ºç´¢å¼•æ—¶çš„æœç´¢èŒƒå›´ã€‚
CREATE INDEX idx_knowledge_nodes_embedding_hnsw
ON knowledge_nodes USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- ============================================
-- ç”¨æˆ·èŠ‚ç‚¹çŠ¶æ€è¡¨ (User Node Status)
-- ============================================
CREATE TABLE user_node_status (
    user_id UUID NOT NULL,
    node_id UUID NOT NULL,
    mastery_score DOUBLE PRECISION NOT NULL DEFAULT 0,
    last_study_at TIMESTAMP,
    next_review_at TIMESTAMP,
    PRIMARY KEY (user_id, node_id)
);

-- ã€æ€§èƒ½ä¼˜åŒ–ã€‘: éƒ¨åˆ†ç´¢å¼• (Partial Index)
-- ç¼–ç¨‹æ€æƒ³ï¼šåªå¯¹â€œå¾…å¤ä¹ â€çš„æ´»è·ƒæ•°æ®å»ºç«‹ç´¢å¼•ï¼Œæå¤§åœ°ç¼©å°ç´¢å¼•ä½“ç§¯ï¼ŒåŠ é€ŸæŸ¥è¯¢ã€‚
CREATE INDEX idx_user_node_status_review_active
ON user_node_status(user_id, next_review_at)
WHERE next_review_at IS NOT NULL;
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. **å…³ç³»å‹ä¸éå…³ç³»å‹çš„èåˆ**: æ”¾å¼ƒæ˜‚è´µçš„ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼Œåˆ©ç”¨ `pgvector` ä½¿ PostgreSQL å…·å¤‡å­˜å‚¨å’Œæœç´¢å‘é‡çš„èƒ½åŠ›ã€‚è¿™ä¿è¯äº†ä¸šåŠ¡æ•°æ®ï¼ˆç”¨æˆ·ã€æŒæ¡åº¦ï¼‰ä¸ AI æ•°æ®ï¼ˆçŸ¥è¯†å‘é‡ï¼‰çš„**å¼ºä¸€è‡´æ€§äº‹åŠ¡**ã€‚
2. **å¤šç»´ç´¢å¼•ç­–ç•¥**: 
   - **B-Tree**: å¤„ç†ç²¾ç¡®åŒ¹é…ï¼ˆå¦‚ `user_id`ï¼‰ã€‚
   - **HNSW**: å¤„ç†æ¨¡ç³Šè¯­ä¹‰åŒ¹é…ã€‚
   - **å¤åˆç´¢å¼•**: é’ˆå¯¹é«˜é¢‘åˆ†é¡µæŸ¥è¯¢ï¼ˆå¦‚ `user_id + created_at DESC`ï¼‰ã€‚

#### 5.3.2 åˆ†åŒºç­–ç•¥ (Table Partitioning)

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºå­¦ä¹ è®°å½•è¡¨
-- ç¼–ç¨‹æ€æƒ³ï¼šåˆ†è€Œæ²»ä¹‹ã€‚å°†ä¸€å¼ äº¿çº§å¤§è¡¨æŒ‰æœˆä»½æ‹†åˆ†ä¸ºå¤šå¼ å­è¡¨ï¼Œæé«˜èŒƒå›´æŸ¥è¯¢æ€§èƒ½ã€‚
CREATE TABLE study_records (
    id UUID,
    user_id UUID,
    completed_at TIMESTAMP NOT NULL
) PARTITION BY RANGE (completed_at);

-- è‡ªåŠ¨åˆ›å»º 2025 å¹´ 12 æœˆçš„åˆ†åŒº
CREATE TABLE study_records_2025_12 PARTITION OF study_records
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
```

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

- **Q: ä¸ºä»€ä¹ˆä¸ç”¨ MongoDB å­˜èŠå¤©å†å²ï¼Ÿ**
  - A: PostgreSQL çš„ JSONB ç±»å‹åœ¨æ€§èƒ½ä¸Šå·²ä¸è¾“ MongoDBï¼Œä¸”èƒ½ä¸å…³ç³»è¡¨è¿›è¡Œ JOIN æ“ä½œã€‚æœ¬ç³»ç»Ÿè¿½æ±‚çš„æ˜¯â€œæç®€æ¶æ„ï¼Œå¤šé¡¹å…¨èƒ½â€ã€‚
- **Q: å¦‚ä½•è§£å†³å‘é‡æœç´¢å¸¦æ¥çš„ CPU å‹åŠ›ï¼Ÿ**
  - A: é€šè¿‡ HNSW ç´¢å¼•å°† O(N) çš„å…¨é‡æ‰«æé™ä½ä¸º O(log N) çš„è¿‘ä¼¼æœç´¢ï¼Œå¹¶é€šè¿‡ Redis ç¼“å­˜è¯­ä¹‰æœç´¢çš„ç»“æœã€‚

---


-- ============================================
-- èŠ‚ç‚¹å…³ç³»è¡¨ (Node Relations)
-- çŸ¥è¯†å›¾è°±è¾¹ï¼Œå­˜å‚¨èŠ‚ç‚¹é—´å…³ç³»
-- ============================================
CREATE TABLE node_relations (
    source_node_id UUID NOT NULL REFERENCES knowledge_nodes(id),
    target_node_id UUID NOT NULL REFERENCES knowledge_nodes(id),
    relation_type VARCHAR(30) NOT NULL,
    strength DOUBLE PRECISION DEFAULT 1.0,
    created_by VARCHAR(20) DEFAULT 'system',
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    PRIMARY KEY (source_node_id, target_node_id),
    CONSTRAINT chk_relation_type CHECK (relation_type IN (
        'prerequisite', 'related', 'parent', 'child', 'similar'
    ))
);

-- ç´¢å¼•ï¼ˆå›¾éå†ï¼‰
CREATE INDEX idx_node_relations_source ON node_relations(source_node_id);
CREATE INDEX idx_node_relations_target ON node_relations(target_node_id);

-- ============================================
-- å­¦ä¹ è®°å½•è¡¨ (Study Records)
-- è¯¦ç»†è®°å½•æ¯æ¬¡å­¦ä¹ è¡Œä¸º
-- ============================================
CREATE TABLE study_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    node_id UUID NOT NULL,
    study_minutes INTEGER NOT NULL,
    mastery_delta DOUBLE PRECISION NOT NULL,
    study_method VARCHAR(50),
    completed_at TIMESTAMP NOT NULL DEFAULT NOW(),

    CONSTRAINT chk_minutes CHECK (study_minutes > 0)
);

-- åˆ†åŒºè¡¨ï¼ˆæŒ‰æ—¶é—´åˆ†åŒºï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE INDEX idx_study_records_user_time
ON study_records(user_id, completed_at DESC);

-- ============================================
-- èŠ‚ç‚¹æ‹“å±•é˜Ÿåˆ— (Node Expansion Queue)
-- LLM è‡ªåŠ¨æ‹“å±•çŸ¥è¯†ç‚¹
-- ============================================
CREATE TABLE node_expansion_queue (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    node_id UUID NOT NULL REFERENCES knowledge_nodes(id),
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    priority INTEGER NOT NULL DEFAULT 5,
    result JSONB,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    processed_at TIMESTAMP,

    CONSTRAINT chk_status CHECK (status IN ('pending', 'processing', 'completed', 'failed'))
);

CREATE INDEX idx_expansion_queue_status
ON node_expansion_queue(status, priority)
WHERE status = 'pending';
```

#### 5.1.2 ç”¨æˆ·ä¸ä»»åŠ¡ç³»ç»Ÿ

```sql
-- ============================================
-- ç”¨æˆ·è¡¨ (Users)
-- ============================================
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    nickname VARCHAR(50),
    avatar_url TEXT,
    preferences JSONB DEFAULT '{}',
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ============================================
-- ä»»åŠ¡è¡¨ (Tasks) - 6ç§ç±»å‹
-- ============================================
CREATE TYPE tasktype AS ENUM (
    'LEARNING',      -- å­¦ä¹ ä»»åŠ¡
    'TRAINING',      -- è®­ç»ƒä»»åŠ¡
    'ERROR_FIX',     -- é”™é¢˜ä¿®å¤
    'REFLECTION',    -- åæ€æ€»ç»“
    'SOCIAL',        -- ç¤¾äº¤å­¦ä¹ 
    'PLANNING'       -- è®¡åˆ’åˆ¶å®š
);

CREATE TYPE taskstatus AS ENUM (
    'PENDING', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED'
);

CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    plan_id UUID,
    title VARCHAR(255) NOT NULL,
    type tasktype NOT NULL,
    tags JSONB NOT NULL DEFAULT '[]',
    estimated_minutes INTEGER NOT NULL,
    difficulty INTEGER NOT NULL,
    status taskstatus NOT NULL DEFAULT 'PENDING',
    knowledge_node_id UUID REFERENCES knowledge_nodes(id),
    auto_expand_enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    due_at TIMESTAMP,

    CONSTRAINT chk_difficulty CHECK (difficulty BETWEEN 1 AND 5)
);

CREATE INDEX idx_tasks_user_status ON tasks(user_id, status);
CREATE INDEX idx_tasks_type ON tasks(type);
CREATE INDEX idx_tasks_due ON tasks(user_id, due_at) WHERE due_at IS NOT NULL;

-- ============================================
-- è®¡åˆ’è¡¨ (Plans) - å†²åˆº/æˆé•¿è®¡åˆ’
-- ============================================
CREATE TYPE plantype AS ENUM ('SPRINT', 'GROWTH');

CREATE TABLE plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    type plantype NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    target_score INTEGER,
    progress JSONB DEFAULT '{}',
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_plans_user_date ON plans(user_id, start_date, end_date);
```

#### 5.1.3 æ™ºèƒ½æ¨é€ç³»ç»Ÿ

```sql
-- ============================================
-- æ¨é€åå¥½ (Push Preferences)
-- ============================================
CREATE TABLE push_preferences (
    user_id UUID PRIMARY KEY REFERENCES users(id),
    active_slots JSONB NOT NULL DEFAULT '[{"start": "08:00", "end": "22:00"}]',
    timezone VARCHAR(50) NOT NULL DEFAULT 'Asia/Shanghai',
    enable_curiosity BOOLEAN NOT NULL DEFAULT TRUE,
    persona_type VARCHAR(50) NOT NULL DEFAULT 'STUDENT',
    daily_cap INTEGER NOT NULL DEFAULT 3,
    last_push_time TIMESTAMP,
    consecutive_ignores INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ============================================
-- æ¨é€å†å² (Push Histories)
-- ç”¨äºé¢‘ç‡æ§åˆ¶å’Œå»é‡
-- ============================================
CREATE TABLE push_histories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    trigger_type VARCHAR(50) NOT NULL,
    content_hash VARCHAR(64),
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_push_histories_user_time
ON push_histories(user_id, created_at DESC);

CREATE INDEX idx_push_histories_hash
ON push_histories(content_hash)
WHERE content_hash IS NOT NULL;

-- ============================================
-- é€šçŸ¥è¡¨ (Notifications)
-- ============================================
CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    type VARCHAR(50) NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    data JSONB,
    read BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_notifications_user_read
ON notifications(user_id, read, created_at DESC);
```

#### 5.1.4 ç¤¾åŒºæ¨¡å—

```sql
-- ============================================
-- å¸–å­è¡¨ (Posts)
-- ============================================
CREATE TABLE posts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    tags JSONB DEFAULT '[]',
    visibility VARCHAR(20) DEFAULT 'public',
    like_count INTEGER DEFAULT 0,
    comment_count INTEGER DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_posts_user ON posts(user_id);
CREATE INDEX idx_posts_created ON posts(created_at DESC);

-- ============================================
-- ç‚¹èµè¡¨ (Post Likes)
-- ============================================
CREATE TABLE post_likes (
    post_id UUID NOT NULL REFERENCES posts(id),
    user_id UUID NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),

    PRIMARY KEY (post_id, user_id)
);
```

### 5.2 å…³é”®å…³ç³»å›¾

```
knowledge_nodes
    â”‚ 1:N
    â”œâ”€â–º user_node_status (æŒæ¡åº¦)
    â”‚       â”‚ N:1
    â”‚       â””â”€â–º users
    â”‚
    â”œâ”€â–º node_relations (å…³ç³»)
    â”‚       â”‚ N:1
    â”‚       â””â”€â–º knowledge_nodes (target)
    â”‚
    â”œâ”€â–º study_records (å­¦ä¹ å†å²)
    â”‚       â”‚ N:1
    â”‚       â””â”€â–º users
    â”‚
    â””â”€â–º tasks (å…³è”ä»»åŠ¡)
            â”‚ N:1
            â””â”€â–º users

users
    â”‚ 1:1
    â”œâ”€â–º push_preferences
    â”‚
    â”œâ”€â–º plans
    â”‚       â”‚ 1:N
    â”‚       â””â”€â–º tasks
    â”‚
    â”œâ”€â–º chat_messages
    â”‚
    â””â”€â–º notifications

posts
    â”‚ 1:N
    â””â”€â–º post_likes
            â”‚ N:1
            â””â”€â–º users
```

### 5.3 æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥

#### 5.3.1 ç´¢å¼•ç­–ç•¥

```sql
-- 1. å‘é‡æœç´¢ä¼˜åŒ–ï¼ˆHNSW ç´¢å¼•ï¼‰
CREATE INDEX idx_knowledge_nodes_embedding_hnsw
ON knowledge_nodes
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64, ef_search = 40);

-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰
CREATE INDEX idx_user_node_status_active
ON user_node_status(user_id, mastery_score)
WHERE mastery_score < 100;

-- 3. å¤åˆç´¢å¼•ï¼ˆè¦†ç›–æŸ¥è¯¢ï¼‰
CREATE INDEX idx_study_records_covering
ON study_records(user_id, completed_at DESC)
INCLUDE (node_id, mastery_delta);

-- 4. BRIN ç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ï¼‰
CREATE INDEX idx_study_records_brin
ON study_records USING BRIN (completed_at);
```

#### 5.3.2 åˆ†åŒºç­–ç•¥

```sql
-- æŒ‰æ—¶é—´åˆ†åŒºå­¦ä¹ è®°å½•è¡¨
CREATE TABLE study_records (
    id UUID,
    user_id UUID,
    node_id UUID,
    study_minutes INTEGER,
    mastery_delta DOUBLE PRECISION,
    completed_at TIMESTAMP NOT NULL
) PARTITION BY RANGE (completed_at);

-- æœˆåº¦åˆ†åŒº
CREATE TABLE study_records_2025_12 PARTITION OF study_records
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');
```

---

## 6. æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£

### 6.1 çŸ¥è¯†æ˜Ÿå›¾ (Knowledge Galaxy)

#### 6.1.1 æ ¸å¿ƒæœåŠ¡æ¶æ„

```python
# backend/app/services/galaxy_service.py

class GalaxyService:
    """
    çŸ¥è¯†æ˜Ÿå›¾æ ¸å¿ƒæœåŠ¡
    èŒè´£ï¼šèŠ‚ç‚¹ç®¡ç†ã€æŒæ¡åº¦è®¡ç®—ã€å…³ç³»ç»´æŠ¤ã€RAG æ£€ç´¢
    """

    def __init__(self, db, redis, llm_service):
        self.db = db
        self.redis = redis
        self.llm = llm_service

        # å¸¸é‡é…ç½®
        self.BASE_MASTERY_POINTS = 5.0
        self.MAX_MASTERY = 100.0
        self.MEMORY_HALF_LIFE_DAYS = 7.0
        self.DECAY_THRESHOLD = 10.0

    async def spark_node(self, user_id: str, node_id: str,
                        study_minutes: int) -> SparkResult:
        """
        ç‚¹äº®çŸ¥è¯†ç‚¹ - æ ¸å¿ƒå­¦ä¹ æµç¨‹
        """
        # ========== ç¬¬1æ­¥ï¼šè·å–æˆ–åˆ›å»ºæŒæ¡åº¦çŠ¶æ€ ==========
        status = await self._get_or_create_status(user_id, node_id)

        # ========== ç¬¬2æ­¥ï¼šæŒæ¡åº¦ç®—æ³• (Mastery Algorithm) ==========
        # æ€æƒ³ï¼šå¤šå› å­æƒé‡ã€‚ä¸æ˜¯ç®€å•åŠ åˆ†ï¼Œè€Œæ˜¯æ ¹æ®ï¼šå­¦ä¹ æ—¶é•¿ã€èŠ‚ç‚¹é‡è¦åº¦ã€å­¦ä¹ æ¬¡æ•°ã€æ—¶é—´æ•ˆç‡ ç»¼åˆè®¡ç®—ã€‚
        mastery_delta = self._calculate_mastery_delta(
            study_minutes,
            node.importance_level,
            status.study_count
        )

        # ========== ç¬¬3æ­¥ï¼šçŠ¶æ€æ›´æ–°ä¸è§£é” ==========
        status.mastery_score = min(status.mastery_score + mastery_delta, 100)
        status.study_count += 1
        status.last_study_at = datetime.utcnow()

        # ========== ç¬¬4æ­¥ï¼šè‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’ ==========
        # æ€æƒ³ï¼šé—´éš”é‡å¤ (Spaced Repetition)ã€‚æ ¹æ® Ebbinghaus æ›²çº¿ï¼ŒåŠ¨æ€è®¡ç®—è¯¥çŸ¥è¯†ç‚¹çš„ä¸‹ä¸€æ¬¡å¤ä¹ æ—¶é—´ã€‚
        if status.mastery_score >= 60:
            status.next_review_at = self._calculate_next_review(
                status.study_count,
                status.mastery_score
            )

        # ========== ç¬¬5æ­¥ï¼šè§¦å‘è‡ªåŠ¨åŒ–å·¥ä½œæµ ==========
        # æ€æƒ³ï¼šå¼‚æ­¥æ‹“å±•ã€‚å¦‚æœå­¦ä¹ æ¬¡æ•°è¾¾æ ‡ï¼ˆå¦‚ 2 æ¬¡ï¼‰ï¼Œè§¦å‘ ExpansionWorker è¿›è¡ŒçŸ¥è¯†å›¾è°±è‡ªåŠ¨æ‹“æ‰‘ã€‚
        if status.study_count >= 2:
            await self._queue_expansion(node_id)

        return SparkResult(...)

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. ä¸ªæ€§åŒ–ç®—æ³•é©±åŠ¨ (Algorithm Driven)
- **æ€æƒ³**: `_calculate_mastery_delta` ä½“ç°äº†â€œè¾¹é™…æ•ˆç”¨é€’å‡â€ã€‚å³ç¬¬ä¸€æ¬¡å­¦åŠ åˆ†å¿«ï¼Œå­¦å¾—è¶Šå¤šåŠ åˆ†è¶Šæ…¢ï¼Œé¼“åŠ±ç”¨æˆ·å»æ¢ç´¢æ–°é¢†åŸŸï¼Œè€Œä¸æ˜¯æ­»ç£•å·²æŒæ¡çš„å†…å®¹ã€‚

2. é—­ç¯åé¦ˆ (Feedback Loop)
- **å®ç°**: å¤ä¹ è®¡åˆ’ã€å†å²è®°å½•ã€çŸ¥è¯†æ‹“å±•ã€‚
- **ä»·å€¼**: å½¢æˆäº†ä¸€ä¸ªä»â€œå­¦ä¹ â€åˆ°â€œå·©å›ºâ€å†åˆ°â€œå‘ç°æ–°çŸ¥è¯†â€çš„å®Œæ•´é—­ç¯ï¼Œæå¤§æå‡äº†å­¦ä¹ æ•ˆç‡ã€‚


    def _calculate_mastery_delta(self, study_minutes: int,
                                importance: int, study_count: int) -> float:
        """
        æŒæ¡åº¦å¢é‡è®¡ç®—
        å…¬å¼ï¼šåŸºç¡€åˆ† Ã— é‡è¦åº¦ç³»æ•° Ã— æ¬¡æ•°è¡°å‡ Ã— æ—¶é—´ç³»æ•°
        """
        # åŸºç¡€åˆ†ï¼šæ¯åˆ†é’Ÿå­¦ä¹ å¢åŠ  5 ç‚¹
        base = study_minutes * self.BASE_MASTERY_POINTS

        # é‡è¦åº¦ç³»æ•°ï¼š1-5 çº§ï¼Œæœ€é«˜ 2.0 å€
        importance_factor = 1 + (importance - 1) * 0.25

        # æ¬¡æ•°è¡°å‡ï¼šå­¦ä¹ æ¬¡æ•°è¶Šå¤šï¼Œå¢é‡è¶Šå°
        count_factor = 1.0 / (1 + study_count * 0.3)

        # æ—¶é—´ç³»æ•°ï¼šå­¦ä¹ æ—¶é—´è¶Šé•¿ï¼Œæ•ˆç‡è¶Šé«˜ï¼ˆä½†æœ‰ä¸Šé™ï¼‰
        time_factor = 1 + math.log10(study_minutes + 1) * 0.2

        delta = base * importance_factor * count_factor * time_factor

        return min(delta, 20.0)  # å•æ¬¡ä¸Šé™ 20 ç‚¹

    def _calculate_next_review(self, study_count: int, mastery: float) -> datetime:
        """
        è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿è®¡ç®—å¤ä¹ æ—¶é—´
        åŸºäº Ebbinghaus forgetting curve
        """
        # åŸºç¡€é—´éš”ï¼ˆå¤©ï¼‰
        if study_count <= 2:
            base_days = 1
        elif study_count <= 4:
            base_days = 3
        elif study_count <= 6:
            base_days = 7
        else:
            base_days = 14

        # æŒæ¡åº¦å½±å“ï¼šæŒæ¡åº¦è¶Šé«˜ï¼Œé—´éš”è¶Šé•¿
        mastery_factor = mastery / 50.0  # 0-2 å€

        # éšæœºå› å­ï¼šé¿å…æ‰€æœ‰ç”¨æˆ·åŒæ—¶å¤ä¹ 
        random_factor = random.uniform(0.8, 1.2)

        days = base_days * mastery_factor * random_factor

        return datetime.utcnow() + timedelta(days=days)

    async def hybrid_search(self, user_id: str, query: str,
                           vector_query: Optional[str] = None,
                           limit: int = 10) -> List[KnowledgeNode]:
        """
        RAG v2.0 æ··åˆæœç´¢
        ç»“åˆï¼šå‘é‡æœç´¢ + å…³é”®è¯æœç´¢ + ç”¨æˆ·çŠ¶æ€è¿‡æ»¤
        """
        # 1. å‡†å¤‡æŸ¥è¯¢å‘é‡
        query_embedding = await self.llm.get_embedding(
            vector_query if vector_query else query
        )

        # 2. å¹¶è¡Œæ‰§è¡Œå‘é‡æœç´¢å’Œå…³é”®è¯æœç´¢
        vector_task = self._vector_search(query_embedding, limit * 10)
        keyword_task = self._keyword_search(query, limit * 10)

        vector_results, keyword_results = await asyncio.gather(
            vector_task, keyword_task
        )

        # 3. RRF (Reciprocal Rank Fusion) èåˆ
        fused = self._reciprocal_rank_fusion(
            vector_results,
            keyword_results,
            weight_vector=0.7,
            weight_keyword=0.3
        )

        # 4. é‡æ’åºï¼ˆRe-rankingï¼‰
        reranked = await self._rerank(query, fused, limit)

        # 5. è·å–å®Œæ•´èŠ‚ç‚¹å¹¶è¿‡æ»¤
        nodes = await self._get_nodes_by_ids([r.node_id for r in reranked])
        filtered = await self._filter_by_user_status(user_id, nodes)

        return filtered

    def _reciprocal_rank_fusion(self, vector_results, keyword_results,
                               weight_vector=0.7, weight_keyword=0.3):
        """RRF èåˆç®—æ³•"""
        scores = {}

        # å‘é‡ç»“æœ
        for rank, result in enumerate(vector_results, 1):
            scores[result.node_id] = weight_vector * (1 / (rank + 60))

        # å…³é”®è¯ç»“æœ
        for rank, result in enumerate(keyword_results, 1):
            if result.node_id in scores:
                scores[result.node_id] += weight_keyword * (1 / (rank + 60))
            else:
                scores[result.node_id] = weight_keyword * (1 / (rank + 60))

        # æ’åº
        sorted_results = sorted(scores.items(), key=lambda x: x[1], reverse=True)
        return [FusedResult(node_id=k, score=v) for k, v in sorted_results]

    async def _rerank(self, query: str, candidates: List[FusedResult],
                     top_k: int) -> List[FusedResult]:
        """ä½¿ç”¨ LLM è¿›è¡Œé‡æ’åº"""
        # æå–å€™é€‰å†…å®¹
        candidate_nodes = await self._get_nodes_by_ids([r.node_id for r in candidates])

        # æ„å»ºé‡æ’åºæç¤º
        prompt = self._build_rerank_prompt(query, candidate_nodes)

        # è°ƒç”¨ LLM
        response = await self.llm.generate(
            messages=[{"role": "user", "content": prompt}],
            max_tokens=200
        )

        # è§£æç»“æœ
        ranked_ids = self._parse_rerank_response(response.content)

        # é‡æ–°æ’åº
        return sorted(candidates, key=lambda x: ranked_ids.index(x.node_id) if x.node_id in ranked_ids else 999)
```

#### 6.1.2 çŸ¥è¯†æ‹“å±•æœåŠ¡

```python
# backend/app/services/expansion_service.py

class ExpansionService:
    """LLM é©±åŠ¨çš„çŸ¥è¯†æ‹“å±•æœåŠ¡"""

    async def process_expansion(self, node_id: str):
        # ========== ç¬¬1æ­¥ï¼šLLM ç”Ÿæˆå…³è”å†…å®¹ ==========
        # æ€æƒ³ï¼šè‡ªåŠ¨åŒ–æ‹“æ‰‘ã€‚è®© AI åˆ†æå½“å‰çŸ¥è¯†ç‚¹ï¼Œè‡ªåŠ¨ç”Ÿæˆå­çŸ¥è¯†ç‚¹å’Œç»ƒä¹ é¢˜ã€‚
        expansion_result = await self._generate_expansion(node)

        # ========== ç¬¬2æ­¥ï¼šåŠ¨æ€æ„å»ºå›¾å…³ç³» ==========
        for child in expansion_result['children']:
            # è‡ªåŠ¨åˆ›å»ºå­èŠ‚ç‚¹å¹¶å»ºç«‹ parent_id å…³è”
            child_node = KnowledgeNode(parent_id=node_id, ...)
            self.db.add(child_node)
            
            # ========== ç¬¬3æ­¥ï¼šå»ºç«‹è¯­ä¹‰è¾¹ (Edge) ==========
            # æ€æƒ³ï¼šçŸ¥è¯†å›¾è°±æ„å»ºã€‚ä¸ä»…æœ‰çˆ¶å­å…³ç³»ï¼Œè¿˜é€šè¿‡ NodeRelations è®°å½•å…³è”å¼ºåº¦ã€‚
            relation = NodeRelations(source_node_id=node_id, target_node_id=child_node.id, relation_type='child')
            self.db.add(relation)
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. çŸ¥è¯†å›¾è°±è‡ªç”Ÿé•¿ (Self-Growing Graph)
- **æ€æƒ³**: ç³»ç»Ÿä¸å†ä¾èµ–äºäººå·¥é¢„è®¾æ‰€æœ‰çŸ¥è¯†ç‚¹ã€‚é€šè¿‡ç”¨æˆ·çš„â€œç‚¹äº®â€è¡Œä¸ºè§¦å‘ AI å®æ—¶ç”Ÿæˆç›¸å…³å†…å®¹ï¼Œå®ç°çŸ¥è¯†åº“çš„è‡ªå‘æ‰©å¼ ã€‚

#### 6.4 ä»»åŠ¡ç®¡ç†é€»è¾‘

```python
    async def execute_task(self, user_id: str, task_id: str, actual_minutes: int):
        """æ‰§è¡Œä»»åŠ¡å¹¶åé¦ˆåˆ°çŸ¥è¯†ç³»ç»Ÿ"""
        # ========== ç¬¬1æ­¥ï¼šä»»åŠ¡çŠ¶æ€ç¿»è½¬ ==========
        task.status = 'COMPLETED'

        # ========== ç¬¬2æ­¥ï¼šè·¨æœåŠ¡è”åŠ¨ ==========
        # æ€æƒ³ï¼šé¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD)ã€‚ä»»åŠ¡ç³»ç»Ÿçš„å®Œæˆï¼Œé€šè¿‡ GalaxyService è½¬åŒ–ä¸ºçŸ¥è¯†ç³»ç»Ÿçš„â€œèƒ½é‡å€¼â€ã€‚
        if task.knowledge_node_id:
            result = await galaxy_service.spark_node(user_id, task.knowledge_node_id, actual_minutes)
            
        # ========== ç¬¬3æ­¥ï¼šè§¦å‘è‡ªåŠ¨åŒ–å‰¯ä½œç”¨ ==========
        # æ€æƒ³ï¼šHook æœºåˆ¶ã€‚ä»»åŠ¡å®Œæˆåï¼Œè‡ªåŠ¨è§¦å‘æ–°ä¸€è½®çš„çŸ¥è¯†æ‹“å±•ä»»åŠ¡ã€‚
        if task.auto_expand_enabled:
            await expansion_service.queue_expansion(task.knowledge_node_id)
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. è·¨åŸŸè”åŠ¨ (Cross-Domain Interaction)
- **æ€æƒ³**: ä»»åŠ¡ã€å­¦ä¹ ã€çŸ¥è¯†æ˜¯ä¸‰ä¸ªä¸åŒçš„ä¸šåŠ¡é¢†åŸŸã€‚é€šè¿‡è‰¯å¥½çš„æ¥å£è®¾è®¡ï¼Œå®ç°äº†â€œåšä»»åŠ¡ -> æ¶¨çŸ¥è¯† -> æ‹“ç‰ˆå›¾â€çš„ä¸æ»‘è”åŠ¨ã€‚

    async def create_task(self, user_id: str, task_data: dict) -> Task:
        """åˆ›å»ºä»»åŠ¡"""
        # 1. éªŒè¯ä»»åŠ¡ç±»å‹
        if task_data['type'] not in self.TASK_TYPES:
            raise ValueError(f"Invalid task type: {task_data['type']}")

        # 2. å¦‚æœå…³è”çŸ¥è¯†ç‚¹ï¼Œæ£€æŸ¥è§£é”çŠ¶æ€
        if 'knowledge_node_id' in task_data:
            node_status = await self._check_node_unlocked(
                user_id,
                task_data['knowledge_node_id']
            )
            if not node_status:
                raise ValueError("Knowledge node not unlocked")

        # 3. åˆ›å»ºä»»åŠ¡
        task = Task(
            user_id=user_id,
            title=task_data['title'],
            type=task_data['type'],
            tags=json.dumps(task_data.get('tags', [])),
            estimated_minutes=task_data['estimated_minutes'],
            difficulty=task_data.get('difficulty', 3),
            knowledge_node_id=task_data.get('knowledge_node_id'),
            auto_expand_enabled=task_data.get('auto_expand', True)
        )

        self.db.add(task)
        await self.db.commit()

        # 4. å¦‚æœæ˜¯å­¦ä¹ ä»»åŠ¡ï¼Œè‡ªåŠ¨å…³è”å†²åˆºè®¡åˆ’
        if task.type == 'LEARNING':
            await self._link_to_sprint_plan(user_id, task.id)

        return task

    async def execute_task(self, user_id: str, task_id: str,
                          actual_minutes: int) -> TaskExecutionResult:
        """æ‰§è¡Œä»»åŠ¡"""
        # 1. è·å–ä»»åŠ¡
        task = await self.db.get(Task, task_id)
        if not task or task.user_id != user_id:
            raise ValueError("Task not found")

        # 2. æ›´æ–°ä»»åŠ¡çŠ¶æ€
        task.status = 'COMPLETED'

        # 3. å¦‚æœå…³è”çŸ¥è¯†ç‚¹ï¼Œæ›´æ–°æŒæ¡åº¦
        mastery_delta = 0
        if task.knowledge_node_id:
            galaxy_service = GalaxyService(self.db, self.redis, None)
            result = await galaxy_service.spark_node(
                user_id,
                task.knowledge_node_id,
                actual_minutes
            )
            mastery_delta = result.mastery_delta

        # 4. è®°å½•æ‰§è¡Œå†å²
        execution = TaskExecution(
            task_id=task_id,
            actual_minutes=actual_minutes,
            mastery_delta=mastery_delta
        )
        self.db.add(execution)

        # 5. è‡ªåŠ¨æ‰©å±•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if task.auto_expand_enabled and task.knowledge_node_id:
            expansion_service = ExpansionService(self.db, None, None)
            await expansion_service.queue_expansion(
                task.knowledge_node_id,
                priority=3
            )

        await self.db.commit()

        return TaskExecutionResult(
            task=task,
            mastery_delta=mastery_delta,
            expansion_queued=task.auto_expand_enabled
        )

    async def get_daily_tasks(self, user_id: str, date: date) -> List[Task]:
        """è·å–æ¯æ—¥ä»»åŠ¡"""
        query = """
        SELECT * FROM tasks
        WHERE user_id = :user_id
          AND DATE(created_at) = :date
          AND status != 'CANCELLED'
        ORDER BY
            CASE type
                WHEN 'LEARNING' THEN 1
                WHEN 'TRAINING' THEN 2
                WHEN 'ERROR_FIX' THEN 3
                WHEN 'REFLECTION' THEN 4
                WHEN 'SOCIAL' THEN 5
                WHEN 'PLANNING' THEN 6
            END,
            difficulty DESC
        """

        result = await self.db.execute(query, {
            "user_id": user_id,
            "date": date
        })

        return result.fetchall()

    async def suggest_tasks(self, user_id: str, context: dict) -> List[dict]:
        """æ™ºèƒ½ä»»åŠ¡å»ºè®®"""
        # 1. åˆ†æç”¨æˆ·å½“å‰çŠ¶æ€
        progress = await self._get_learning_progress(user_id)

        # 2. åŸºäºçŠ¶æ€ç”Ÿæˆå»ºè®®
        suggestions = []

        # 2.1 éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹
        if progress['review_needed'] > 0:
            suggestions.append({
                "type": "TRAINING",
                "title": f"å¤ä¹  {progress['review_needed']} ä¸ªçŸ¥è¯†ç‚¹",
                "estimated_minutes": 30,
                "priority": "high"
            })

        # 2.2 é”™é¢˜ä¿®å¤
        if progress['error_count'] > 0:
            suggestions.append({
                "type": "ERROR_FIX",
                "title": f"ä¿®å¤ {progress['error_count']} ä¸ªé”™é¢˜",
                "estimated_minutes": 20,
                "priority": "high"
            })

        # 2.3 æ–°çŸ¥è¯†ç‚¹å­¦ä¹ 
        if progress['unlocked_nodes'] < 20:
            suggestions.append({
                "type": "LEARNING",
                "title": "å­¦ä¹ æ–°çŸ¥è¯†ç‚¹",
                "estimated_minutes": 40,
                "priority": "medium"
            })

        # 2.4 åæ€æ€»ç»“
        if progress['study_count'] > 5:
            suggestions.append({
                "type": "REFLECTION",
                "title": "æœ¬å‘¨å­¦ä¹ æ€»ç»“",
                "estimated_minutes": 15,
                "priority": "low"
            })

        return suggestions
```

---

## 7. ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º

### 7.1 ç†”æ–­å™¨ (Circuit Breaker)

```python
# backend/app/orchestration/circuit_breaker.py

class CircuitBreaker:
    """
    ç†”æ–­å™¨æ¨¡å¼ï¼šç³»ç»Ÿè‡ªä¿æŠ¤çš„â€œä¿é™©ä¸â€
    """

    async def can_execute(self) -> bool:
        # ========== ç¬¬1æ­¥ï¼šåˆ†å¸ƒå¼çŠ¶æ€æŸ¥è¯¢ ==========
        # æ€æƒ³ï¼šçŠ¶æ€æœºæ¨¡å‹ã€‚CLOSED -> OPEN (æ•…éšœ) -> HALF_OPEN (å°è¯•æ¢å¤)ã€‚
        state = await self._get_state_from_redis()

        if state == "OPEN":
            # å¦‚æœå¤„äºç†”æ–­çŠ¶æ€ï¼Œæ£€æŸ¥å†·å´æ—¶é—´æ˜¯å¦å·²è¿‡
            if time.time() - self.last_failure_time > self.recovery_timeout:
                await self._set_state("HALF_OPEN") # è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå…è®¸å°‘é‡æ¢æµ‹è¯·æ±‚
                return True
            return False # æ‹’ç»è¯·æ±‚ï¼Œä¿æŠ¤ä¸‹æ¸¸

        return True 
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æ•…éšœè”“å»¶é˜²æŠ¤
- **æ€æƒ³**: åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªæœåŠ¡çš„ç¼“æ…¢ä¼šæ‹–å®æ•´ä¸ªè°ƒç”¨é“¾ã€‚ç†”æ–­å™¨é€šè¿‡å¿«é€Ÿå¤±è´¥ï¼ˆFail-Fastï¼‰ï¼Œåˆ‡æ–­å¯¹æ•…éšœæœåŠ¡çš„è°ƒç”¨ï¼Œä¿è¯æ ¸å¿ƒç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚

### 7.2 æ¶ˆæ¯å»é‡ä¸å¹‚ç­‰

```python
# backend/app/orchestration/message_tracker.py

class MessageTracker:
    """æ¶ˆæ¯å»é‡ï¼šé˜²æ­¢é‡å¤å¤„ç†"""

    async def mark_processed(self, request_id: str):
        # ========== ç¬¬1æ­¥ï¼šçŠ¶æ€ä¸Šè‰² ==========
        # æ€æƒ³ï¼šåˆ©ç”¨ Redis çš„ TTL (ç”Ÿå­˜æ—¶é—´) è®°å½•å·²å¤„ç†è¯·æ±‚ã€‚
        # ä»·å€¼ï¼šé¿å…ç”±äºå‰ç«¯è¶…æ—¶é‡è¯•æˆ–ç½‘ç»œé‡ä¼ å¯¼è‡´çš„é‡å¤æ‰£è´¹ã€é‡å¤å†™åº“ç­‰å‰¯ä½œç”¨ã€‚
        key = f"processed:{request_id}"
        await self.redis.setex(key, self.ttl, "1")
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å¹‚ç­‰æ€§ä¿è¯ (Idempotency)
- **æ€æƒ³**: æ— è®ºè¯·æ±‚æ‰§è¡Œå¤šå°‘æ¬¡ï¼Œç»“æœéƒ½åº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚è¿™æ˜¯æ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿæœ€åŸºæœ¬ã€æœ€é‡è¦çš„åŸåˆ™ä¹‹ä¸€ã€‚

### 7.3 åˆ†å¸ƒå¼é”

```python
# backend/app/orchestration/distributed_lock.py

class DistributedLock:
    """åŸºäº Redis çš„åˆ†å¸ƒå¼æ’ä»–é”"""

    async def acquire(self, lock_key: str, timeout: int = 10) -> bool:
        # ========== ç¬¬1æ­¥ï¼šåŸå­äº‰æŠ¢ ==========
        # æ€æƒ³ï¼šåŸå­æŒ‡ä»¤ SET NX EXã€‚
        # NX: åªåœ¨ Key ä¸å­˜åœ¨æ—¶è®¾ç½®ï¼ˆæŠ¢å ï¼‰ã€‚
        # EX: è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­»é”ï¼‰ã€‚
        acquired = await self.redis.set(key, value, nx=True, ex=timeout)
        return acquired is True
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. èµ„æºäº’æ–¥ä¸å¹¶å‘å®‰å…¨
- **æ€æƒ³**: å½“å¤šä¸ªè¿›ç¨‹/å®¹å™¨åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªç”¨æˆ·çš„æŒæ¡åº¦æˆ–ä½™é¢æ—¶ï¼Œå¿…é¡»ä¿è¯åªæœ‰ä¸€ä¸ªèƒ½æˆåŠŸã€‚åˆ†å¸ƒå¼é”æ˜¯è§£å†³â€œå¤šæœºå¹¶å‘å†²çªâ€çš„æ ¸å¿ƒå·¥å…·ã€‚

### 7.4 ç›‘æ§ä¸æŒ‡æ ‡ (Observability)

```python
# backend/app/monitoring/metrics.py

class MetricsCollector:
    """Prometheus æŒ‡æ ‡æ”¶é›†ï¼šç³»ç»Ÿçš„â€œå¿ƒç”µå›¾â€"""

    # 1. è®¡æ•°å™¨ (Counter)ï¼šè®°å½•æ€»é‡
    REQUEST_COUNTER = Counter('chat_requests_total', 'è¯·æ±‚æ€»æ•°', ['status'])

    # 2. ç›´æ–¹å›¾ (Histogram)ï¼šè®°å½•å»¶è¿Ÿåˆ†å¸ƒ
    REQUEST_DURATION = Histogram('request_duration_seconds', 'å“åº”è€—æ—¶')
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å¯è§‚æµ‹æ€§ (Observability)
- **æ€æƒ³**: ä¸è¦è®©ç³»ç»Ÿæˆä¸ºä¸€ä¸ªâ€œé»‘ç›’â€ã€‚é€šè¿‡å¤šç»´åº¦çš„æŒ‡æ ‡ï¼ˆMetricsï¼‰ã€æ—¥å¿—ï¼ˆLogsï¼‰ã€é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰ï¼Œåœ¨æ•…éšœå‘ç”Ÿå‰å°±èƒ½é€šè¿‡è¶‹åŠ¿å›¾å‘ç°é—®é¢˜ã€‚


### 7.5 å¥åº·æ£€æŸ¥ (Health Checks)

```python
# backend/app/api/v1/health_production.py

@router.get("/ready")
async def readiness_check(db: AsyncSession):
    """å°±ç»ªæ£€æŸ¥ï¼šç³»ç»Ÿæ˜¯å¦å¯ä»¥å¼€å§‹æ¥æ”¶æµé‡"""
    try:
        # 1. æ·±åº¦ä¾èµ–æ£€æŸ¥ï¼šæ•°æ®åº“è¿æ¥
        await db.execute("SELECT 1")
        # 2. æ·±åº¦ä¾èµ–æ£€æŸ¥ï¼šRedis è¿é€šæ€§
        await redis_client.ping()
        return {"status": "ready"}
    except Exception as e:
        # å¦‚æœä»»ä¸€æ ¸å¿ƒä¾èµ–å¤±æ•ˆï¼Œè¿”å› 503 çŠ¶æ€ç 
        raise HTTPException(status_code=503, detail="Dependent service unavailable")

@router.get("/live")
async def liveness_check():
    """å­˜æ´»æ£€æŸ¥ï¼šè¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ"""
    # åªè¦ Web Server èƒ½å“åº” HTTP è¯·æ±‚ï¼Œå³è®¤ä¸ºå­˜æ´»
    return {"status": "alive"}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å°±ç»ªæ€§ vs å­˜æ´»æ€§çš„åŒºåˆ« (Readiness vs Liveness)
- **æ€æƒ³**: `Liveness` å†³å®šå®¹å™¨æ˜¯å¦éœ€è¦é‡å¯ï¼ˆæ¯”å¦‚å†…å­˜æº¢å‡ºæŒ‚äº†ï¼‰ï¼›`Readiness` å†³å®šæµé‡æ˜¯å¦å¯ä»¥è¿›å…¥ã€‚å¦‚æœæ•°æ®åº“æ­£åœ¨è¿ç§»æˆ–è¿æ¥å·²æ»¡ï¼Œç³»ç»Ÿä»æ´»ç€ï¼Œä½†ä¸åº”æ¥å®¢ã€‚
- **ä»·å€¼**: åœ¨ Kubernetes æˆ–è´Ÿè½½å‡è¡¡æ¶æ„ä¸­ï¼Œè¿™ç§åˆ†çº§æ£€æŸ¥æ˜¯å®ç°â€œé›¶åœæœºæ»šåŠ¨æ›´æ–°â€çš„å…³é”®ã€‚

    try:
        redis_client = redis.from_url("redis://localhost:6379")
        await redis_client.ping()

        # æ£€æŸ¥é˜Ÿåˆ—é•¿åº¦
        queue_length = await redis_client.llen("queue:summarization")
        base_health["redis"] = {
            "status": "connected",
            "queue_length": queue_length,
            "queue_healthy": queue_length < 500
        }
    except Exception as e:
        base_health["redis"] = {"status": "error", "error": str(e)}
        base_health["status"] = "degraded"

    # è¿è¡Œæ—¶çŠ¶æ€
    if orchestrator:
        runtime = orchestrator.get_health_status()
        base_health["runtime"] = runtime

    # ä¸šåŠ¡æŒ‡æ ‡
    base_health["metrics"] = {
        "concurrent_sessions": 0,  # ä» MetricsCollector è·å–
        "circuit_breaker_state": "CLOSED"
    }

    return base_health

@router.get("/prometheus/metrics")
async def prometheus_metrics():
    """Prometheus æŒ‡æ ‡ç«¯ç‚¹"""
    from prometheus_client import generate_latest
    return Response(
        content=generate_latest(),
        media_type="text/plain; version=0.0.4"
    )

@router.get("/queue/status")
async def queue_status():
    """é˜Ÿåˆ—çŠ¶æ€ç›‘æ§"""
    redis_client = redis.from_url("redis://localhost:6379")

    queues = {
        "summarization": await redis_client.llen("queue:summarization"),
        "expansion": await redis_client.llen("queue:expansion"),
        "push": await redis_client.llen("queue:push"),
    }

    return {
        "queues": queues,
        "alerts": [q for q, l in queues.items() if l > 100]
    }
```

---

## 8. å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª

### 8.1 ç«¯åˆ°ç«¯æµç¨‹è¯¦è§£

```
ç”¨æˆ·è¾“å…¥: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
```

#### é˜¶æ®µ 1: ç§»åŠ¨ç«¯å¤„ç†

```dart
// 1. Flutter App - ç”¨æˆ·è¾“å…¥
ChatScreen.onSubmitted("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ")

// 2. Riverpod çŠ¶æ€æ›´æ–°
ChatNotifier.sendMessage("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ")
  â†’ æ›´æ–° state.isLoading = true
  â†’ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° messages åˆ—è¡¨

// 3. WebSocket æœåŠ¡å‘é€
WebSocketChatServiceV2.sendMessage(
  message: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
  userId: "user_123",
  sessionId: "sess_456"
)
  â†’ æ„å»º payload: {"message": "...", "session_id": "...", "user_id": "..."}
  â†’ WebSocketChannel å‘é€ JSON
```

#### é˜¶æ®µ 2: Go Gateway å¤„ç†

```go
// 4. Go Gateway - WebSocket æ¥æ”¶
func (h *ChatHandler) HandleWebSocket(conn *websocket.Conn, userID string) {
    // è®¤è¯æ£€æŸ¥
    if !h.authMiddleware(conn) {
        conn.Close(4001, "Auth failed")
        return
    }

    // æ¶ˆæ¯å¾ªç¯
    for {
        var msg ChatMessage
        conn.ReadJSON(&msg)  // æ¥æ”¶ {"message": "...", ...}

        // é…é¢æ£€æŸ¥
        if !h.quotaService.CheckQuota(userID) {
            conn.WriteJSON(QuotaExceededResponse)
            break
        }

        // 5. è½¬å‘åˆ° gRPC
        response, err := h.grpcClient.StreamChat(ctx, &pb.ChatRequest{
            UserId:    userID,
            SessionId: msg.SessionID,
            Message:   msg.Message,
        })

        // 6. æµå¼è¿”å›
        for _, chunk := range response {
            conn.WriteJSON(chunk)  // é€å—è¿”å›ç»™ Flutter
        }
    }
}
```

#### é˜¶æ®µ 3: Python gRPC æœåŠ¡

```python
# 7. gRPC æœåŠ¡ç«¯
class AgentServiceImpl(pb2_grpc.AgentServiceServicer):
    async def StreamChat(self, request, context):
        # è½¬å‘åˆ°ç¼–æ’å™¨
        orchestrator = ProductionChatOrchestrator()

        async for event in orchestrator.process_stream(request):
            yield pb2.StreamResponse(
                type=event.type,
                content=event.content,
                metadata=event.metadata
            )
```

#### é˜¶æ®µ 4: ç”Ÿäº§çº§ç¼–æ’å™¨æ ¸å¿ƒæµç¨‹

```python
# 8. ProductionChatOrchestrator.process_stream()

# ========== ç¬¬1æ­¥ï¼šæ¶ˆæ¯å»é‡æ£€æŸ¥ ==========
if await self.message_tracker.is_processed("req_789"):
    yield ErrorEvent(code="DUPLICATE_REQUEST")
    return  # æµç¨‹ç»“æŸ

# ========== ç¬¬2æ­¥ï¼šç†”æ–­å™¨æ£€æŸ¥ ==========
if not await self.circuit_breaker.can_execute():
    yield ErrorEvent(code="CIRCUIT_BREAKER_OPEN")
    return  # æµç¨‹ç»“æŸ

# ========== ç¬¬3æ­¥ï¼šå¹¶å‘æ§åˆ¶ ==========
if not await self._track_session("sess_456", add=True):
    yield ErrorEvent(code="RATE_LIMIT")
    return  # æµç¨‹ç»“æŸ

try:
    # ========== ç¬¬4æ­¥ï¼šè¯·æ±‚éªŒè¯ ==========
    validation = await self.validator.validate_chat_request(request)
    if not validation.is_valid:
        yield ErrorEvent(code="VALIDATION_FAILED")
        return  # æµç¨‹ç»“æŸ

    # ========== ç¬¬5æ­¥ï¼šå¹‚ç­‰æ€§æ£€æŸ¥ ==========
    cached = await self._check_idempotency("sess_456", "req_789")
    if cached:
        yield cached  # è¿”å›ç¼“å­˜
        return  # æµç¨‹ç»“æŸ

    # ========== ç¬¬6æ­¥ï¼šåˆ†å¸ƒå¼é” ==========
    lock_acquired = await self._acquire_session_lock("sess_456", "req_789")
    if not lock_acquired:
        yield ErrorEvent(code="LOCK_FAILED")
        return  # æµç¨‹ç»“æŸ

    # ========== ç¬¬7æ­¥ï¼šæ„å»ºä¸Šä¸‹æ–‡ ==========

    # 7.1 ç”¨æˆ·ä¸Šä¸‹æ–‡
    user_context = await self._build_user_context("user_123")
    # ç»“æœ: {
    #   "user": {"id": "user_123", "nickname": "å¼ ä¸‰"},
    #   "progress": {"total_nodes": 45, "avg_mastery": 65},
    #   "active_sprint": {"title": "æœºå™¨å­¦ä¹ å…¥é—¨", "progress": 75}
    # }

    # 7.2 å¯¹è¯å†å²ï¼ˆä¸Šä¸‹æ–‡ä¿®å‰ªï¼‰
    conversation_context = await self.context_pruner.get_pruned_history(
        "sess_456", "user_123"
    )
    # ç»“æœ: {
    #   "messages": [...],  # æœ€è¿‘10æ¡æˆ–å¸¦æ€»ç»“
    #   "summary": "ç”¨æˆ·ä¹‹å‰è¯¢é—®è¿‡ç¥ç»ç½‘ç»œçš„åŸºç¡€æ¦‚å¿µ",
    #   "summary_used": True
    # }

    # 7.3 çŸ¥è¯†æ£€ç´¢ï¼ˆGraphRAGï¼‰
    knowledge_context = await self._retrieve_knowledge(
        "user_123",
        "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
        conversation_context
    )
    # ç»“æœ: {
    #   "nodes": [
    #     {"id": "node_100", "name": "æœºå™¨å­¦ä¹ ", "mastery": 0},
    #     {"id": "node_101", "name": "ç›‘ç£å­¦ä¹ ", "mastery": 0},
    #     {"id": "node_102", "name": "ç¥ç»ç½‘ç»œ", "mastery": 35}
    #   ],
    #   "relations": [...]
    # }

    # ========== ç¬¬8æ­¥ï¼šLLM è°ƒç”¨ + å·¥å…·æ‰§è¡Œ ==========

    # 8.1 å‡†å¤‡å·¥å…·
    tools = tool_registry.get_openai_tools_schema()
    # å·¥å…·åˆ—è¡¨: [
    #   {"name": "get_knowledge_node", ...},
    #   {"name": "create_task", ...},
    #   ...
    # ]

    # 8.2 æ„å»ºç³»ç»Ÿæç¤º
    system_prompt = f"""
    ä½ æ˜¯ä¸€ä¸ª AI å­¦ä¹ åŠ©æ‰‹ã€‚

    ç”¨æˆ·ä¿¡æ¯:
    {json.dumps(user_context, ensure_ascii=False)}

    å¯¹è¯å†å²:
    {json.dumps(conversation_context, ensure_ascii=False)}

    ç›¸å…³çŸ¥è¯†:
    {json.dumps(knowledge_context, ensure_ascii=False)}

    å¯ç”¨å·¥å…·:
    {tool_registry.get_tools_description()}

    è¦æ±‚:
    1. ç”¨ä¸­æ–‡å›ç­”
    2. è¯­è¨€äº²åˆ‡è‡ªç„¶
    3. é€‚å½“ä½¿ç”¨å·¥å…·
    """

    # 8.3 æµå¼ LLM è°ƒç”¨
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"}
    ]

    async for chunk in llm_service.chat_stream_with_tools(
        messages=messages,
        tools=tools,
        user_id="user_123"
    ):
        yield chunk

    # ========== ç¬¬9æ­¥ï¼šå“åº”ç»„åˆ ==========
    # å·²åœ¨ LLM æµå¼è¿”å›ä¸­å®Œæˆ

    # ========== ç¬¬10æ­¥ï¼šç¼“å­˜ä¸æŒ‡æ ‡ ==========
    await self._cache_response("sess_456", "req_789", "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ")
    await self._record_metrics(request, user_context)

finally:
    # ========== ç¬¬11æ­¥ï¼šæ¸…ç†èµ„æº ==========
    await self._release_session_lock("sess_456", "req_789")
    await self._track_session("sess_456", add=False)
```

#### é˜¶æ®µ 2: Go ç½‘å…³è½¬å‘ (gRPC Stream)

```go
// æ€æƒ³ï¼šé€æ˜æµè½¬ã€‚ç½‘å…³ä¸è§£æä¸šåŠ¡æ•°æ®ï¼Œç›´æ¥å»ºç«‹ gRPC åŒå‘æµã€‚
stream, err := h.grpcClient.StreamChat(ctx, &pb.ChatRequest{...})

// ç›‘å¬ gRPC æµå¹¶æ³µå…¥ WebSocket
for {
    chunk, err := stream.Recv()
    if err == io.EOF { break }
    conn.WriteJSON(chunk)
}
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. ç®¡é“æ¨¡å¼ (Pipelining)
- **æ€æƒ³**: å°† Go ç½‘å…³è§†ä¸ºä¸€æ ¹â€œç®¡å­â€ã€‚æ•°æ®ä» gRPC è¿›æ¥ï¼Œç›´æ¥æ³µå…¥ WebSocket å‡ºå»ï¼Œä¸­é—´ä¸è½åœ°ï¼Œä¸å­˜å†…å­˜ã€‚
- **ä¼˜ç‚¹**: æä½çš„å†…å­˜å ç”¨å’Œæé«˜çš„å“åº”é€Ÿåº¦ï¼ˆé›¶æ‹·è´æ€æƒ³çš„å˜ç§ï¼‰ã€‚

#### é˜¶æ®µ 5: LLM æœåŠ¡æ‰§è¡Œ (Streaming & Tool Use)

```python
# æ€æƒ³ï¼šååº”å¼ç¼–æ’ã€‚LLM ä¸æ˜¯ä¸€æ¬¡åå‡ºç»“æœï¼Œè€Œæ˜¯åƒæ°´æµä¸€æ ·è¾“å‡ºã€‚
async for chunk in provider.chat_complete(stream=True):
    if chunk.type == "tool_call":
        # å®æ—¶è§¦å‘æœ¬åœ°å·¥å…·ï¼ˆå¦‚æŸ¥è¯¢æ•°æ®åº“ã€åˆ›å»ºæé†’ï¼‰
        result = await self._execute_tool(chunk.tool_call)
        # ç»“æœåé¦ˆï¼Œç»§ç»­æµå¼ç”Ÿæˆ
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. è¿­ä»£å™¨æ¨¡å¼ (Iterator Pattern)
- **æ€æƒ³**: `async for` éšè—äº†å¤æ‚çš„ç¼“å†²å’ŒçŠ¶æ€åŒæ­¥é€»è¾‘ã€‚å¼€å‘è€…åªéœ€è¦å…³å¿ƒâ€œä¸‹ä¸€ä¸ªå­—æ˜¯ä»€ä¹ˆâ€ã€‚
- **ä»·å€¼**: å®ç°äº†çœŸæ­£çš„æ‰“å­—æœºæ•ˆæœï¼Œå¤§å¹…é™ä½äº†ç”¨æˆ·çš„â€œæ„Ÿå®˜å»¶è¿Ÿâ€ã€‚


#### é˜¶æ®µ 6: æ•°æ®åº“æ“ä½œ

```python
# 10. æ•°æ®åº“æ“ä½œï¼ˆå¦‚æœéœ€è¦ï¼‰

# çŸ¥è¯†æ£€ç´¢
SELECT kn.id, kn.name, kn.description, kn.embedding <=> :query_embedding AS distance
FROM knowledge_nodes kn
WHERE kn.subject_id = :subject_id
ORDER BY distance
LIMIT 10;

# æ›´æ–°ç”¨æˆ·çŠ¶æ€
UPDATE user_node_status
SET mastery_score = mastery_score + :delta,
    total_study_minutes = total_study_minutes + :minutes,
    study_count = study_count + 1,
    last_study_at = NOW(),
    next_review_at = :next_review
WHERE user_id = :user_id AND node_id = :node_id;

# è®°å½•å­¦ä¹ å†å²
INSERT INTO study_records (user_id, node_id, study_minutes, mastery_delta)
VALUES (:user_id, :node_id, :minutes, :delta);
```

#### é˜¶æ®µ 7: Redis ç¼“å­˜/é˜Ÿåˆ—

```python
# 11. Redis æ“ä½œ

# ç¼“å­˜å¯¹è¯å†å²
LPUSH chat_history:sess_456 '{"role": "user", "content": "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"}'
EXPIRE chat_history:sess_456 3600

# å¼‚æ­¥æ€»ç»“é˜Ÿåˆ—
RPUSH queue:summarization '{"session_id": "sess_456", "history": [...]}'

# ä¼šè¯çŠ¶æ€
SET session:sess_456:active "1"
EXPIRE session:sess_456:active 60
```

#### é˜¶æ®µ 8: è¿”å›ç§»åŠ¨ç«¯

```dart
// 12. Flutter - æ¥æ”¶æµå¼å“åº”

// WebSocket æœåŠ¡æ¥æ”¶
WebSocketChatServiceV2._handleMessage(data)
  â†’ è§£æä¸º TextEvent("æœºå™¨å­¦ä¹ æ˜¯...")
  â†’ StreamController.add(event)

// Riverpod ç›‘å¬
ChatNotifier._handleStreamEvent(event)
  â†’ event.when(
      text: (content) {
        state = state.copyWith(
          response: state.response + content,
          isTyping: true
        );
      },
      done: () {
        // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
        state = state.copyWith(
          messages: [
            ...state.messages,
            ChatMessage(
              role: 'assistant',
              content: state.response,
            )
          ],
          isLoading: false,
          isTyping: false
        );
      }
    )

// UI æ›´æ–°
ChatScreen.builder()
  â†’ MessageBubble æ˜¾ç¤º AI å›ç­”
  â†’ æ‰“å­—åŠ¨ç”»æ•ˆæœ
  â†’ å®ŒæˆçŠ¶æ€æ˜¾ç¤º
```

### 8.2 å…³é”®æ—¶åºå›¾

```
æ—¶é—´è½´: 0ms â”€â”€â”€â”€â”€â”€> 100ms â”€â”€â”€â”€â”€â”€> 200ms â”€â”€â”€â”€â”€â”€> 300ms â”€â”€â”€â”€â”€â”€> 400ms

Mobile:  [è¾“å…¥] â”€â”€> [å‘é€] â”€â”€> [ç­‰å¾…] â”€â”€> [æ¥æ”¶"æœºå™¨"] â”€â”€> [æ¥æ”¶"å­¦ä¹ "] â”€â”€> [å®Œæˆ]
           â”‚          â”‚          â”‚            â”‚              â”‚            â”‚
Go:       â”‚          â””â”€> [æ¥æ”¶] â”€â”€> [éªŒè¯] â”€â”€> [gRPCè½¬å‘] â”€â”€> [æµå¼è¿”å›] â”€â”€> [å…³é—­]
           â”‚                     â”‚            â”‚              â”‚            â”‚
Python:   â”‚                     â””â”€> [ç¼–æ’] â”€â”€> [LLMè°ƒç”¨] â”€â”€> [å·¥å…·æ‰§è¡Œ] â”€â”€> [ç»“æŸ]
           â”‚                              â”‚              â”‚            â”‚
DB/Redis: â”‚                              â”œâ”€> [æŸ¥è¯¢] â”€â”€> [æ›´æ–°] â”€â”€> [ç¼“å­˜]
           â”‚                              â”‚
LLM:      â”‚                              â””â”€> [ç”Ÿæˆ] â”€â”€> [æµå¼è¾“å‡º]
```

---

## 9. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### 9.1 æ•°æ®åº“ä¼˜åŒ–

#### 9.1.1 ç´¢å¼•ç­–ç•¥

```sql
-- 1. å‘é‡æœç´¢ä¼˜åŒ–
-- HNSW ç´¢å¼•ï¼ˆæ¨èï¼Œæ€§èƒ½æ›´å¥½ï¼‰
CREATE INDEX idx_knowledge_nodes_embedding_hnsw
ON knowledge_nodes
USING hnsw (embedding vector_cosine_ops)
WITH (m = 16, ef_construction = 64, ef_search = 40);

-- IVFFlat ç´¢å¼•ï¼ˆå¤‡é€‰ï¼Œæ„å»ºæ›´å¿«ï¼‰
CREATE INDEX idx_knowledge_nodes_embedding_ivfflat
ON knowledge_nodes
USING ivfflat (embedding vector_l2_ops)
WITH (lists = 100);

-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰
CREATE INDEX idx_user_node_status_active
ON user_node_status(user_id, mastery_score)
WHERE mastery_score < 100;

-- 3. è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_study_records_covering
ON study_records(user_id, completed_at DESC)
INCLUDE (node_id, mastery_delta, study_minutes);

-- 4. BRIN ç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ï¼‰
CREATE INDEX idx_study_records_brin
ON study_records USING BRIN (completed_at)
WITH (pages_per_range = 128);
```

#### 9.1.2 æŸ¥è¯¢ä¼˜åŒ– (é¿å… N+1 é—®é¢˜)

```python
# æ€æƒ³ï¼šå…³ç³»ä»£æ•°åº”ç”¨ã€‚åˆ©ç”¨ SQL çš„ JOIN ä¸€æ¬¡æ€§æ‹‰å–æ‰€æœ‰å…³è”æ•°æ®ã€‚
query = """
SELECT uns.*, kn.name FROM user_node_status uns
JOIN knowledge_nodes kn ON uns.node_id = kn.id
WHERE uns.user_id = :user_id
"""
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å‡å°‘ IO å›æ•° (IO Round-trips)
- **æ€æƒ³**: ç½‘ç»œå¾€è¿”æ˜¯æ•°æ®åº“æ“ä½œä¸­æœ€æ…¢çš„éƒ¨åˆ†ã€‚æ¯”èµ·å¤šæ¬¡æŸ¥è¯¢ï¼Œåˆå¹¶æˆä¸€æ¬¡ JOIN æˆ–ä¸€ä¸ªå®½è¡¨æŸ¥è¯¢é€šå¸¸èƒ½è·å¾— 10 å€ä»¥ä¸Šçš„æ€§èƒ½æå‡ã€‚

### 9.2 å¹¶å‘æ§åˆ¶

#### 9.2.1 ä¼šè¯é™åˆ¶ (Distributed Semaphore)

```python
# æ€æƒ³ï¼šæµé‡æ§åˆ¶ã€‚åˆ©ç”¨ Redis çš„è®¡æ•°å™¨å®ç°åˆ†å¸ƒå¼ä»¤ç‰Œã€‚
async def _track_session(self, session_id: str, add: bool) -> bool:
    key = f"session_count:{user_id}"
    if add:
        current = await self.redis.incr(key)
        if current > MAX_CONCURRENT_SESSIONS:
            return False # æ‹’ç»è¯·æ±‚ï¼Œé˜²æ­¢å•ä¸ªç”¨æˆ·å æ»¡ç³»ç»Ÿåç¨‹
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. è½¯é™åˆ¶ä¸å…¬å¹³æ€§
- **æ€æƒ³**: ä¸è¦è®©ä¸€ä¸ªåæ‰çš„å®¢æˆ·ç«¯ï¼ˆå¦‚æ­»å¾ªç¯é‡è¯•ï¼‰æ‹–å®æ•´ä¸ªåç«¯æœåŠ¡ã€‚é€šè¿‡ Session é™åˆ¶å®ç°äº†å¤šç§Ÿæˆ·é—´çš„â€œèµ„æºéš”ç¦»â€ã€‚

### 9.3 ç¼“å­˜ç­–ç•¥

#### 9.3.1 å¤šçº§ç¼“å­˜ (Tiered Caching)

```python
class MultiLevelCache:
    """L1 (å†…å­˜) + L2 (Redis) åŒå±‚æ¶æ„"""
    async def get(self, key: str):
        # 1. å†…å­˜æé€ŸæŸ¥æ‰¾ï¼ˆå¾®ç§’çº§ï¼‰
        if key in self.local_map: return self.local_map[key]
        # 2. Redis å…¨å±€æŸ¥æ‰¾ï¼ˆæ¯«ç§’çº§ï¼‰
        value = await self.redis.get(key)
        # 3. è‡ªåŠ¨å›å¡«å†…å­˜
        if value: self.local_map[key] = value
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å±€éƒ¨æ€§åŸç† (Locality of Reference)
- **æ€æƒ³**: 80% çš„è¯·æ±‚å¾€å¾€é›†ä¸­åœ¨ 20% çš„çƒ­ç‚¹æ•°æ®ä¸Šã€‚L1 ç¼“å­˜æ‹¦æˆªäº†å¤§éƒ¨åˆ†æµé‡ï¼Œæå¤§åœ°å‡è½»äº† Redis çš„ç½‘ç»œè´Ÿè½½ã€‚
    async def set(self, key: str, value: str, ttl: int = 300):
        # L2 è®¾ç½®
        await self.redis.setex(key, ttl, value)

        # L1 è®¾ç½®
        self.memory_cache[key] = (value, time.time() + ttl)

        # L1 æ¸…ç†ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
        if len(self.memory_cache) > 1000:
            self._cleanup_memory_cache()

    def _cleanup_memory_cache(self):
        """æ¸…ç†è¿‡æœŸçš„å†…å­˜ç¼“å­˜"""
        now = time.time()
        expired = [
            k for k, v in self.memory_cache.items()
            if v[1] < now
        ]
        for k in expired:
            del self.memory_cache[k]
```

#### 9.3.2 è¯­ä¹‰ç¼“å­˜

```python
class SemanticCache:
    """åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰ç¼“å­˜"""

    def __init__(self, redis_client, llm_service):
        self.redis = redis_client
        self.llm = llm_service

    async def get(self, query: str, threshold: float = 0.95) -> Optional[str]:
        """æŸ¥è¯¢è¯­ä¹‰ç›¸ä¼¼çš„ç¼“å­˜"""
        # ç”ŸæˆæŸ¥è¯¢å‘é‡
        query_embedding = await self.llm.get_embedding(query)

        # æœç´¢ç›¸ä¼¼ç¼“å­˜
        cache_key = "semantic_cache:*"
        candidates = await self.redis.keys(cache_key)

        for key in candidates:
            cached_data = await self.redis.hgetall(key)
            if not cached_data:
                continue

            cached_embedding = np.frombuffer(cached_data[b"embedding"], dtype=np.float32)
            similarity = np.dot(query_embedding, cached_embedding) / (
                np.linalg.norm(query_embedding) * np.linalg.norm(cached_embedding)
            )

            if similarity >= threshold:
                return cached_data[b"response"].decode("utf-8")

        return None

    async def set(self, query: str, response: str):
        """è®¾ç½®è¯­ä¹‰ç¼“å­˜"""
        embedding = await self.llm.get_embedding(query)

        cache_key = f"semantic_cache:{hash(query)}"

        await self.redis.hset(cache_key, mapping={
            "query": query,
            "response": response,
            "embedding": embedding.tobytes(),
            "created_at": str(time.time())
        })

        await self.redis.expire(cache_key, 3600)
```

### 9.4 å¼‚æ­¥ä¼˜åŒ–

#### 9.4.1 å¹¶å‘æ‰§è¡Œ

```python
# ä¼˜åŒ–å‰ï¼šä¸²è¡Œæ‰§è¡Œ
async def process_concurrently_bad(requests):
    results = []
    for req in requests:
        result = await process_single(req)
        results.append(result)
    return results

# ä¼˜åŒ–åï¼šå¹¶å‘æ‰§è¡Œ
async def process_concurrently_good(requests):
    tasks = [process_single(req) for req in requests]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    return results

# å¸¦é™æµçš„å¹¶å‘
async def process_with_semaphore(requests, max_concurrent=10):
    semaphore = asyncio.Semaphore(max_concurrent)

    async def process_with_limit(req):
        async with semaphore:
            return await process_single(req)

    tasks = [process_with_limit(req) for req in requests]
    return await asyncio.gather(*tasks)
```

#### 9.4.2 å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç† (RAII Pattern)

```python
# æ€æƒ³ï¼šè‡ªåŠ¨äº‹åŠ¡ã€‚åˆ©ç”¨ Python çš„ __aenter__ / __aexit__ ä¿è¯æ•°æ®åº“æ“ä½œçš„åŸå­æ€§ã€‚
class DatabaseTransaction:
    async def __aenter__(self):
        # è‡ªåŠ¨å¼€å¯äº‹åŠ¡
        return await self.engine.begin()

    async def __aexit__(self, exc_type, ...):
        # æ€æƒ³ï¼šè‡ªæ„ˆé€»è¾‘ã€‚å¦‚æœæœ‰å¼‚å¸¸åˆ™å›æ»šï¼Œå¦åˆ™æäº¤ã€‚
        if exc_type: await self.session.rollback()
        else: await self.session.commit()
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. RAII (èµ„æºè·å–å³åˆå§‹åŒ–)
- **æ€æƒ³**: å°†èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚äº‹åŠ¡ã€æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œè¿æ¥ï¼‰ä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šã€‚
- **ä¼˜ç‚¹**: å½»åº•æœç»äº†â€œå¿˜è®°å…³è¿æ¥â€æˆ–â€œå¿˜è®° Commitâ€å¯¼è‡´çš„å†…å­˜æ³„æ¼å’Œæ•°æ®æ­»é”é—®é¢˜ã€‚

### 9.5 é”™è¯¯å¤„ç†ä¸é™çº§

#### 9.5.1 ä¼˜é›…é™çº§ (Graceful Degradation)

```python
# æ€æƒ³ï¼šæ¼æ–—æ¨¡å‹ã€‚æœ€å¼ºçš„ GraphRAG æŒ‚äº†ï¼Œå°±ç”¨å‘é‡æœç´¢ï¼›å‘é‡æŒ‚äº†ï¼Œå°±ç”¨å…³é”®è¯ï¼›å…¨æŒ‚äº†ï¼Œè¿”å›ç©ºã€‚
async def get_knowledge_with_fallback(query: str):
    try: return await graph_rag.search(query) # 1. æœ€ä¼˜é€‰
    except: return await simple_vector.search(query) # 2. å¤‡é€‰
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æ•…éšœå®¹é”™ (Fault Tolerance)
- **æ€æƒ³**: ç³»ç»Ÿä¸åº”å› ä¸ºéæ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ GraphRAG ç¨å¾®æœ‰ç‚¹æ…¢æˆ–æŠ¥é”™ï¼‰å°±å®Œå…¨ä¸å¯ç”¨ã€‚
- **ä»·å€¼**: é€šè¿‡åˆ†çº§é™çº§ï¼Œæˆ‘ä»¬ä¿è¯äº†ç³»ç»Ÿåœ¨æç«¯å‹åŠ›ä¸‹çš„â€œç”Ÿå­˜èƒ½åŠ›â€ï¼Œå³ä½¿å˜å‚»äº†ï¼Œä¹Ÿè¦èƒ½å·¥ä½œã€‚


#### 9.5.2 è¶…æ—¶æ§åˆ¶

```python
import asyncio

async def call_with_timeout(coro, timeout_seconds: int):
    """å¸¦è¶…æ—¶çš„å¼‚æ­¥è°ƒç”¨"""
    try:
        # 1. è®¾ç½®æ‰§è¡Œä¸Šé™
        # æ€æƒ³ï¼šèµ„æºé˜²è…ã€‚é˜²æ­¢ç”±äºå¤–éƒ¨ APIï¼ˆå¦‚ LLMï¼‰å“åº”è¿‡æ…¢å¯¼è‡´è¯·æ±‚å †ç§¯ï¼Œæœ€ç»ˆè€—å°½æœåŠ¡å™¨åç¨‹æ± ã€‚
        return await asyncio.wait_for(coro, timeout=timeout_seconds)
    except asyncio.TimeoutError:
        # 2. å¤±è´¥é™çº§
        raise TimeoutError(f"Operation timed out after {timeout_seconds}s")
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. ç¡®å®šæ€§è®¾è®¡ (Determinism)
- **æ€æƒ³**: åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œâ€œä¸å“åº”â€æ¯”â€œè¿”å›é”™è¯¯â€æ›´å¯æ€•ã€‚é€šè¿‡æ˜¾å¼è¶…æ—¶ï¼Œæˆ‘ä»¬ç¡®ä¿äº†ç³»ç»Ÿè¡Œä¸ºçš„å¯é¢„æµ‹æ€§ï¼Œé˜²æ­¢äº†è¯·æ±‚é›ªå´©ã€‚

#### 9.6.2 ç»“æ„åŒ–æ—¥å¿—è§„èŒƒ

```python
import structlog

# æ€æƒ³ï¼šæœºå™¨å¯è¯»æ€§ã€‚ä¸å†ä½¿ç”¨çº¯æ–‡æœ¬ï¼Œè€Œæ˜¯ä½¿ç”¨ JSON æ ¼å¼çš„ç»“æ„åŒ–æ—¥å¿—ã€‚
logger.info(
    "chat_request_processed",
    user_id="user_123",
    duration_ms=234,
    cache_hit=True
)
```

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æ—¥å¿—å³æ•°æ® (Log as Data)
- **æ€æƒ³**: æ—¥å¿—ä¸åªæ˜¯ç»™äººçœ‹çš„ï¼Œæ›´æ˜¯ç»™ç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ ELK, Lokiï¼‰åˆ†æçš„ã€‚ç»“æ„åŒ–æ—¥å¿—å…è®¸æˆ‘ä»¬é€šè¿‡ `duration_ms > 500` è¿™æ ·çš„æ¡ä»¶å¿«é€Ÿè¿‡æ»¤å‡ºæ€§èƒ½ç“¶é¢ˆã€‚


---

## 10. é¢è¯•å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆé€‰æ‹© Go + Python æ··åˆæ¶æ„ï¼Ÿ

**è®²è§£ä¸æ ¸å¿ƒé€»è¾‘**:
- **è¿æ¥å±‚ (Go)**: åˆ©ç”¨å…¶åŸç”Ÿé«˜å¹¶å‘åç¨‹ï¼ˆGoroutineï¼‰å’Œä½å†…å­˜å ç”¨ï¼Œç¨³å®šç»´æŠ¤æ•°åä¸‡ä¸ª WebSocket é•¿è¿æ¥ã€‚
- **è®¡ç®—å±‚ (Python)**: è™½ç„¶å¹¶å‘æ€§èƒ½ç¨é€Šï¼Œä½†åœ¨ LLM ç¼–æ’ã€å‘é‡è®¡ç®—ã€Prompt å·¥ç¨‹æ–¹é¢æ‹¥æœ‰æ— å¯æ¯”æ‹Ÿçš„æˆç†Ÿåº“ï¼ˆå¦‚ LangChain, PyTorchï¼‰ã€‚
- **è§£è€¦**: é€šè¿‡ gRPC è¿›è¡ŒäºŒè¿›åˆ¶é€šä¿¡ï¼Œä¿è¯äº†ä¸åŒæŠ€æœ¯æ ˆä¹‹é—´çš„é«˜æ•ˆäº’æ“ä½œæ€§ã€‚

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. åº·å¨å®šå¾‹çš„åº”ç”¨ (Conway's Law)
- **æ€æƒ³**: å°†ç³»ç»Ÿæ‹†åˆ†ä¸ºç½‘å…³å’ŒæœåŠ¡å¼•æ“ï¼ŒåŒ¹é…äº†â€œåŸºç¡€æ¶æ„â€ä¸â€œAI ä¸šåŠ¡â€ä¸¤ä¸ªä¸åŒçš„å¼€å‘èŠ‚å¥ã€‚

---

### Q2: ContextPruner å¦‚ä½•å¤„ç†é•¿å¯¹è¯é—®é¢˜ï¼Ÿ

**è®²è§£ä¸æ ¸å¿ƒé€»è¾‘**:
- **æ»‘åŠ¨çª—å£**: åªä¿ç•™æœ€è¿‘ 10 æ¡å¯¹è¯ï¼Œä¿è¯ LLM çš„â€œå³æ—¶è®°å¿†â€ã€‚
- **å¼‚æ­¥æ€»ç»“**: è¶…è¿‡é˜ˆå€¼åï¼Œåˆ©ç”¨åå° Worker è°ƒç”¨è½»é‡çº§æ¨¡å‹å¯¹æ—§å†å²è¿›è¡Œå‹ç¼©ã€‚
- **å­˜å‚¨**: å°†å‹ç¼©åçš„â€œè¯­ä¹‰æ‘˜è¦â€å­˜å…¥ Redis ç¼“å­˜ 1 å°æ—¶ã€‚

ğŸ¯ è¯„å§”è€ƒå¯Ÿç‚¹

é—®é¢˜ï¼šå¦‚æœæ€»ç»“é€»è¾‘å¤±è´¥äº†ï¼Œç³»ç»Ÿä¼šå¦‚ä½•è¡¨ç°ï¼Ÿ
- **æ ¸å¿ƒå›ç­”**: ç³»ç»Ÿä¼šè§¦å‘â€œä¼˜é›…é™çº§â€ã€‚ç›´æ¥æˆªå–æœ€è¿‘ N æ¡æ¶ˆæ¯å‘é€ï¼Œè™½ç„¶ä¸¢å¤±äº†è¿œæœŸè®°å¿†ï¼Œä½†ä¿è¯äº†å½“å‰å¯¹è¯ä¸ä¸­æ–­ï¼ˆå¯ç”¨æ€§ä¼˜å…ˆäºä¸€è‡´æ€§ï¼‰ã€‚

---

### Q3: RAG v2.0 æ··åˆæœç´¢çš„æ ¸å¿ƒä¼˜åŠ¿ï¼Ÿ

**è®²è§£ä¸æ ¸å¿ƒé€»è¾‘**:
- **è¯­ä¹‰å¬å›**: è§£å†³â€œæƒ³ä¸èµ·æ¥ä¸“ä¸šè¯æ±‡â€çš„é—®é¢˜ï¼ˆå¦‚æœâ€œæ€ä¹ˆæé«˜æ•ˆç‡â€èƒ½æœåˆ°â€œè‰¾å®¾æµ©æ–¯è®°å¿†æ³•â€ï¼‰ã€‚
- **æœ¯è¯­å¬å›**: è§£å†³â€œä¸“æœ‰åè¯å¿…é¡»ç²¾ç¡®â€çš„é—®é¢˜ï¼ˆå¦‚æœâ€œpgvectorâ€å¿…é¡»ç²¾ç¡®åŒ¹é…ï¼‰ã€‚
- **RRF èåˆ**: å»æ‰å„è·¯å¬å›çš„ç»å¯¹åˆ†å€¼å¹²æ‰°ï¼Œåªçœ‹æ’åï¼Œå®ç°äº†æœ€ç¨³å¥çš„èåˆæ•ˆæœã€‚

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. å¬å›ä¸ç²¾æ’åˆ†ç¦» (Recall & Rank)
- **æ€æƒ³**: åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œç›´æ¥å¯¹å…¨åº“è¿›è¡Œå¤æ‚è®¡ç®—æ˜¯ä¸å¯èƒ½çš„ã€‚å…ˆç”¨ç®€å•çš„ç®—æ³•å¬å›å‰ 100 åï¼Œå†ç”¨å¤æ‚çš„ LLM è¿›è¡Œå‰ 10 åçš„é‡æ’åºã€‚

### Q4: æ™ºèƒ½æ¨é€ç³»ç»Ÿçš„ç­–ç•¥ä¼˜å…ˆçº§ï¼Ÿ

**æ ¸å¿ƒæ€è·¯**: 
ç³»ç»Ÿé‡‡ç”¨â€œæ¼æ–—å¼è¯„ä¼°â€ã€‚é¦–å…ˆåˆ¤æ–­æœ€ç´§æ€¥çš„ï¼ˆå†²åˆºä»»åŠ¡æˆªæ­¢ï¼‰ï¼Œå†åˆ¤æ–­ç”¨æˆ·æœ€éœ€è¦çš„ï¼ˆè¯¥å¤ä¹ äº†ï¼‰ï¼Œæœ€åå¯»æ‰¾æ¿€å‘ç”¨æˆ·å…´è¶£çš„å†…å®¹ã€‚

---

### Q5: ç†”æ–­å™¨å¦‚ä½•é˜²æ­¢çº§è”æ•…éšœï¼Ÿ

**åŸç†è¯¦è§£**:
å½“åº•å±‚æœåŠ¡ï¼ˆå¦‚ LLMï¼‰æŒç»­ 5xx æŠ¥é”™æˆ–å“åº”è¶…æ—¶è¶…è¿‡ 5 ç§’æ—¶ï¼Œç†”æ–­å™¨è¿›å…¥ **OPEN** çŠ¶æ€ã€‚æ­¤æ—¶æ‰€æœ‰æ–°è¯·æ±‚åœ¨å…¥å£å¤„å°±ä¼šè¢«æ‹¦æˆªå¹¶ç›´æ¥è¿”å›â€œç³»ç»Ÿç¹å¿™â€ï¼Œä»è€Œç»™ä¸‹æ¸¸æœåŠ¡ç•™å‡ºæ¢å¤æ—¶é—´ï¼Œé˜²æ­¢æ•…éšœåƒæ»šé›ªçƒä¸€æ ·æ‹–å®æ•´ä¸ªé›†ç¾¤ã€‚

ğŸ’¡ ç¼–ç¨‹æ€æƒ³è¯¦è§£

1. æ•…éšœå®¹å¿ä¸è‡ªæ„ˆ (Self-healing)
- **æ€æƒ³**: ä¸è¦è¯•å›¾æ„å»ºæ°¸ä¸å®•æœºçš„ç³»ç»Ÿï¼Œè€Œæ˜¯æ„å»ºä¸€ä¸ªåœ¨éƒ¨åˆ†ç»„ä»¶å®•æœºæ—¶ä»èƒ½å¹³ç¨³è¿è¡Œï¼Œå¹¶åœ¨æ•…éšœæ¶ˆé™¤åè‡ªåŠ¨æ¢å¤çš„â€œéŸ§æ€§â€ç³»ç»Ÿã€‚

---

## ğŸ¯ ç»“è¯­ï¼šå¦‚ä½•æŒæ¡æ‰‹å†™è¿™ä¸ªé¡¹ç›®æ‰€éœ€çš„æŠ€èƒ½ï¼Ÿ

é€šè¿‡è¿™ä»½æ–‡æ¡£ï¼Œæ‚¨å·²ç»æ¥è§¦åˆ°äº†ï¼š
1. **é«˜æ€§èƒ½åç«¯**: Go çš„å¹¶å‘æ¨¡å‹ä¸ä¸­é—´ä»¶è®¾è®¡ã€‚
2. **AI ç³»ç»Ÿç¼–æ’**: Python å¼‚æ­¥ç¼–ç¨‹ã€RAG æ£€ç´¢ã€æç¤ºè¯å·¥ç¨‹ã€‚
3. **ç°ä»£ç§»åŠ¨ç«¯**: Flutter å“åº”å¼ UIã€Riverpod çŠ¶æ€ç®¡ç†ã€‚
4. **åº•å±‚æ¶æ„**: åˆ†å¸ƒå¼é”ã€ç†”æ–­ã€å¹‚ç­‰ã€æ··åˆæœç´¢ç­‰ç”Ÿäº§çº§ä¸­é—´ä»¶åº”ç”¨ã€‚

**å»ºè®®å­¦ä¹ è·¯å¾„**:
- **ç¬¬ä¸€æ­¥**: æŒ‰ç…§æ–‡æ¡£ä¸­çš„ `HandleWebSocket` æ¨¡ä»¿å†™å‡ºåŸºæœ¬çš„é€šä¿¡ç½‘å…³ã€‚
- **ç¬¬äºŒæ­¥**: åœ¨ Python ç«¯æ¥å…¥ä¸€ä¸ª LLM APIï¼Œä½“éªŒ `process_stream` çš„ 11 æ­¥å®‰å…¨å¤„ç†é“¾ã€‚
- **ç¬¬ä¸‰æ­¥**: å®ç°ç®€å•çš„å‘é‡æœç´¢é€»è¾‘ï¼Œå¹¶æœ€ç»ˆåœ¨ Flutter ä¸­ç”¨ `CustomPainter` å°†å®ƒä»¬å¯è§†åŒ–å±•ç¤ºå‡ºæ¥ã€‚


### Q8: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¦ç‚¹ï¼Ÿ

**å›ç­”è¦ç‚¹**:
1. **åŸºç¡€è®¾æ–½**:
   - Docker å®¹å™¨åŒ–
   - Kubernetes ç¼–æ’
   - è´Ÿè½½å‡è¡¡

2. **ç›‘æ§å‘Šè­¦**:
   - Prometheus + Grafana
   - ç»“æ„åŒ–æ—¥å¿—
   - åˆ†å¸ƒå¼è¿½è¸ª

3. **é«˜å¯ç”¨**:
   - æ•°æ®åº“ä¸»ä»
   - Redis é›†ç¾¤
   - å¤šå‰¯æœ¬éƒ¨ç½²

4. **å®‰å…¨**:
   - JWT è®¤è¯
   - é€Ÿç‡é™åˆ¶
   - è¾“å…¥éªŒè¯

5. **æ€§èƒ½**:
   - è¿æ¥æ± 
   - å¤šçº§ç¼“å­˜
   - å¼‚æ­¥å¤„ç†

### Q9: å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

**å›ç­”è¦ç‚¹**:
1. **æ•°æ®åº“äº‹åŠ¡**:
   - ACID ä¿è¯
   - å¼‚æ­¥äº‹åŠ¡
   - å›æ»šæœºåˆ¶

2. **åˆ†å¸ƒå¼é”**:
   - Redis SETNX
   - é”è¶…æ—¶
   - é”ç»­æœŸ

3. **å¹‚ç­‰æ€§**:
   - è¯·æ±‚ ID å»é‡
   - ä¹è§‚é”
   - å”¯ä¸€ç´¢å¼•

4. **æœ€ç»ˆä¸€è‡´æ€§**:
   - å¼‚æ­¥é˜Ÿåˆ—
   - è¡¥å¿æœºåˆ¶
   - å†²çªè§£å†³

### Q10: æ€§èƒ½ä¼˜åŒ–çš„å…³é”®æŒ‡æ ‡ï¼Ÿ

**å›ç­”è¦ç‚¹**:
1. **å»¶è¿ŸæŒ‡æ ‡**:
   - P50: < 500ms
   - P95: < 2000ms
   - P99: < 5000ms

2. **ååé‡**:
   - QPS: 1000+
   - å¹¶å‘è¿æ¥: 10000+
   - Token/s: 5000+

3. **èµ„æºä½¿ç”¨**:
   - CPU: < 70%
   - å†…å­˜: < 80%
   - ç£ç›˜ I/O: < 50%

4. **ä¸šåŠ¡æŒ‡æ ‡**:
   - ç¼“å­˜å‘½ä¸­ç‡: > 80%
   - é”™è¯¯ç‡: < 1%
   - æˆåŠŸç‡: > 99%

---

## æ€»ç»“

### æ¶æ„äº®ç‚¹

1. **æ··åˆæ¶æ„**: Go + Python + Flutterï¼Œå„å¸å…¶èŒ
2. **ç”Ÿäº§çº§ç‰¹æ€§**: ç†”æ–­ã€é™æµã€ç›‘æ§ã€é™çº§
3. **æ™ºèƒ½ç³»ç»Ÿ**: ContextPrunerã€GraphRAGã€æ™ºèƒ½æ¨é€
4. **æ€§èƒ½ä¼˜åŒ–**: å¤šçº§ç¼“å­˜ã€å¼‚æ­¥å¤„ç†ã€ç´¢å¼•ä¼˜åŒ–
5. **å¯è§‚æµ‹æ€§**: Prometheusã€ç»“æ„åŒ–æ—¥å¿—ã€å¥åº·æ£€æŸ¥

### æŠ€æœ¯æ·±åº¦

- **å¹¶å‘æ§åˆ¶**: åˆ†å¸ƒå¼é”ã€ä¼šè¯ç®¡ç†
- **AI ç¼–æ’**: å·¥å…·è°ƒç”¨ã€çŠ¶æ€æœºã€æµå¼å¤„ç†
- **çŸ¥è¯†å›¾è°±**: å‘é‡æœç´¢ã€å…³ç³»æ‰©å±•ã€RAG
- **é—å¿˜æ›²çº¿**: è‰¾å®¾æµ©æ–¯ç®—æ³•ã€è¡°å‡è®¡ç®—
- **æ¨é€ç­–ç•¥**: å¤šç­–ç•¥ä¼˜å…ˆçº§ã€ä¸ªæ€§åŒ–ç”Ÿæˆ

### ç”Ÿäº§å°±ç»ªåº¦: 9.5/10

**å·²å®Œæˆ**:
- âœ… å®Œæ•´æ¶æ„è®¾è®¡
- âœ… é”™è¯¯å¤„ç†ä¸é™çº§
- âœ… ç›‘æ§ä¸å‘Šè­¦
- âœ… æ€§èƒ½ä¼˜åŒ–
- âœ… å®‰å…¨é˜²æŠ¤

**å»ºè®®æ”¹è¿›**:
- å¢åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç‡
- å®Œå–„ CI/CD æµç¨‹
- å¢åŠ è´Ÿè½½æµ‹è¯•
- å®Œå–„è¿ç»´æ–‡æ¡£

---

**æ–‡æ¡£ç»“æŸ**
*æœ¬æ–‡æ¡£æ¶µç›–äº† Sparkle AI Learning Assistant çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯ç»†èŠ‚ï¼Œä»å®è§‚æ¶æ„åˆ°å¾®è§‚å®ç°ï¼Œé€‚åˆé«˜çº§å·¥ç¨‹å¸ˆå’ŒæŠ€æœ¯è¯„å§”æ·±å…¥å­¦ä¹ ã€‚*

---

## ğŸ“š å®Œæ•´çŸ¥è¯†ç‚¹æ¸…å•

### ä¸€ã€ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡æ€æƒ³

#### 1.1 æ··åˆæ¶æ„è®¾è®¡
- **Go + Python + Flutter ä¸‰å±‚æ¶æ„**
  - Go Gateway: é«˜æ€§èƒ½ç½‘å…³å±‚ï¼Œå¤„ç† WebSocket é•¿è¿æ¥ã€JWT è®¤è¯ã€åˆ†å¸ƒå¼é™æµ
  - Python Agent: AI æ ¸å¿ƒå¼•æ“ï¼Œè´Ÿè´£ LLM ç¼–æ’ã€å·¥å…·è°ƒç”¨ã€å‘é‡æ£€ç´¢
  - Flutter Mobile: è·¨å¹³å°ç§»åŠ¨ç«¯ï¼Œå“åº”å¼ UI ä¸çŠ¶æ€ç®¡ç†
- **èŒè´£åˆ†ç¦»åŸåˆ™**
  - ç½‘å…³å±‚ä¸“æ³¨ IO å¯†é›†å‹ä»»åŠ¡ï¼ˆC10K å¹¶å‘èƒ½åŠ›ï¼‰
  - ä¸šåŠ¡å±‚ä¸“æ³¨ AI ç”Ÿæ€ä¸å¤æ‚é€»è¾‘
  - é€šè¿‡ gRPC äºŒè¿›åˆ¶åè®®å®ç°é«˜æ•ˆè·¨è¯­è¨€é€šä¿¡
- **å¯æ‰©å±•æ€§è®¾è®¡**
  - æ— çŠ¶æ€æœåŠ¡è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å®¹
  - åˆ†å±‚è§£è€¦ï¼Œå„å±‚å¯ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
  - åè®®é©±åŠ¨ï¼ŒProtobuf å®šä¹‰æ¥å£ä¿è¯å‘å‰å…¼å®¹

#### 1.2 æ ¸å¿ƒè®¾è®¡æ¨¡å¼
- **ä¾èµ–æ³¨å…¥ (Dependency Injection)**
  - ç»“æ„ä½“å­—æ®µä¼ å…¥å¤–éƒ¨ä¾èµ–ï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤
  - ChatHandler æ³¨å…¥ gRPC å®¢æˆ·ç«¯ã€Redis å®¢æˆ·ç«¯ã€ä¼šè¯ç®¡ç†å™¨ç­‰
- **äº‹ä»¶é©±åŠ¨æ¨¡å¼ (Event-Driven)**
  - WebSocket æ¶ˆæ¯å¾ªç¯ä¸æ–­è¯»å–è§£æ JSON æ¶ˆæ¯
  - æµå¼å“åº”é€å—æ¨é€ï¼Œå®ç°å®æ—¶äº¤äº’
- **ç®¡é“æ¨¡å¼ (Pipelining)**
  - Go ç½‘å…³ä½œä¸º"ç®¡å­"ï¼Œæ•°æ®ä» gRPC è¿›æ¥ç›´æ¥æ³µå…¥ WebSocket
  - é›¶æ‹·è´æ€æƒ³ï¼Œæä½å†…å­˜å ç”¨
- **ç­–ç•¥æ¨¡å¼ (Strategy Pattern)**
  - LLM æœåŠ¡æ”¯æŒå¤šæ¨¡å‹æä¾›å•†åŠ¨æ€åˆ‡æ¢
  - å·¥å…·æ³¨å†Œè¡¨æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€å‘ç°å’Œæ³¨å†Œ

### äºŒã€Go Gateway é«˜æ€§èƒ½ç½‘å…³å±‚

#### 2.1 WebSocket å¤„ç†å™¨
- **è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†**
  - RAII + Defer èµ„æºç®¡ç†ï¼Œç¡®ä¿è¿æ¥æ–­å¼€æ—¶èµ„æºé‡Šæ”¾
  - ä¼šè¯éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·è¿æ¥ç‹¬ç«‹ä¼šè¯ ID
  - Goroutine å¹¶å‘ï¼Œç»´æŒé•¿è¿æ¥æ´»æ€§
- **å®Œæ•´æ•°æ®æµå‘**
  ```
  Flutter (JSON) â†’ Go (ReadJSON) â†’ Quota Check (Redis) â†’ Go (gRPC Call) â†’ Python Agent
                  â†“
  Flutter (UI) â† Go (WriteJSON) â† Stream Read â† Python (Stream Response)
  ```
- **å¿ƒè·³æœºåˆ¶**
  - Ping/Pong æ§åˆ¶å¸§æ£€æµ‹è¿æ¥å¥åº·
  - Redis ç§Ÿçº¦æœºåˆ¶ï¼Œæ›´æ–°ä¼šè¯æ´»è·ƒæ—¶é—´
  - é˜²ç«å¢™é˜²æ–­è¿ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒçŠ¶æ€ä¸€è‡´æ€§

#### 2.2 è®¤è¯ä¸é™æµä¸­é—´ä»¶
- **JWT è®¤è¯ (Stateless Auth)**
  - æ— çŠ¶æ€è®¤è¯ï¼ŒæœåŠ¡å™¨æ— éœ€æŸ¥åº“
  - Token éªŒè¯ä¸è¿‡æœŸæ—¶é—´æ£€æŸ¥
  - ç”¨æˆ·ä¿¡æ¯æ³¨å…¥ Context ä¾›ä¸‹æ¸¸ä½¿ç”¨
- **åˆ†å¸ƒå¼é™æµ (Lua Script)**
  - Redis Lua è„šæœ¬å®ç°åŸå­æ“ä½œ
  - å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•
  - é˜²æ­¢ DDoS å’Œ API æ»¥ç”¨
- **åå‘ä»£ç†è®¾è®¡**
  - Director åˆ‡é¢æ³¨å…¥ç”¨æˆ·èº«ä»½ä¿¡æ¯
  - æ•…éšœéš”ç¦»ï¼Œä¸‹æ¸¸ä¸å¯ç”¨æ—¶è¿”å›å‹å¥½é”™è¯¯
  - é€æ˜ä»£ç†ï¼Œåç«¯æ— éœ€é‡å¤è®¤è¯

#### 2.3 ç”Ÿäº§çº§ç‰¹æ€§
- **è¿æ¥ç®¡ç†**: ä¼šè¯æ˜ å°„ + å¿ƒè·³ï¼Œé˜²æ­¢åƒµå°¸è¿æ¥
- **é…é¢æ§åˆ¶**: Redis è®¡æ•°å™¨ï¼Œé˜²æ­¢æ»¥ç”¨
- **è®¤è¯å®‰å…¨**: JWT + ç­¾åéªŒè¯
- **é™æµä¿æŠ¤**: Redis Lua è„šæœ¬ï¼Œé˜²æ­¢ DDoS
- **é”™è¯¯éš”ç¦»**: ç†”æ–­ + è¶…æ—¶ï¼Œé˜²æ­¢çº§è”æ•…éšœ
- **æ—¥å¿—è¿½è¸ª**: è¯·æ±‚ ID + ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

### ä¸‰ã€Python Agent Engine - AI æ ¸å¿ƒå¼•æ“

#### 3.1 ç”Ÿäº§çº§ç¼–æ’å™¨ (ProductionChatOrchestrator)
- **11æ­¥å®‰å…¨å¤„ç†é“¾**
  1. åˆ†å¸ƒå¼æ¶ˆæ¯å»é‡ (Redis)
  2. æœåŠ¡ç†”æ–­å™¨æ£€æŸ¥
  3. å¹¶å‘é™åˆ¶ (Semaphore)
  4. è¯·æ±‚éªŒè¯
  5. å¹‚ç­‰æ€§æ£€æŸ¥
  6. åˆ†å¸ƒå¼é” (Redis SETNX)
  7. æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡
  8. GraphRAG çŸ¥è¯†æ£€ç´¢
  9. LLM ç¼–æ’ä¸å·¥å…·è°ƒç”¨
  10. æŒ‡æ ‡è®°å½•ä¸å“åº”ç¼“å­˜
  11. èµ„æºæ¸…ç†
- **æ ¸å¿ƒç¼–ç¨‹æ€æƒ³**
  - ç†”æ–­å™¨æ¨¡å¼: é˜²æ­¢çº§è”æ•…éšœ
  - å¹‚ç­‰æ€§è®¾è®¡: é˜²æ­¢é‡å¤å¤„ç†
  - åˆ†å¸ƒå¼é”: è§£å†³å¹¶å‘å†²çª
  - è´£ä»»é“¾æ¨¡å¼: æ¸…æ™°çš„å¤„ç†æµç¨‹

#### 3.2 ä¸Šä¸‹æ–‡ç®¡ç†
- **ç”¨æˆ·ä¸Šä¸‹æ–‡æ„å»º**
  - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€å­¦ä¹ è¿›åº¦ã€æ´»è·ƒå†²åˆºè®¡åˆ’
  - æ¨é€åå¥½ã€æ—¶åŒºã€è¯­è¨€ç­‰ä¸ªæ€§åŒ–é…ç½®
  - Pro ç­‰çº§åˆ¤æ–­ (flame_level >= 3)
- **çŸ¥è¯†æ£€ç´¢ (GraphRAG)**
  - å‘é‡æ··åˆæœç´¢ (pgvector + å…³é”®è¯)
  - å…³ç³»æ‰©å±• (çŸ¥è¯†å›¾è°±æ‹“æ‰‘å…³ç³»)
  - ç”¨æˆ·çŠ¶æ€è¿‡æ»¤ (ä¸ªæ€§åŒ–è£å‰ª)
- **ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨ (ContextPruner)**
  - æ»‘åŠ¨çª—å£: ä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯
  - å¼‚æ­¥æ€»ç»“: åå° Worker å‹ç¼©å†å²
  - ä¼˜é›…é™çº§: ç¼“å­˜å¤±æ•ˆæ—¶å›é€€åˆ°æ»‘åŠ¨çª—å£
  - å‰Šå³°å¡«è°·: Redis é˜Ÿåˆ—è§£è€¦

#### 3.3 åŠ¨æ€å·¥å…·ç³»ç»Ÿ
- **å·¥å…·æ³¨å†Œè¡¨ (DynamicToolRegistry)**
  - è‡ªåŠ¨æ‰«æ `app.tools` åŒ…
  - åå°„æœºåˆ¶å‘ç°æ‰€æœ‰ BaseTool å­ç±»
  - ç”Ÿæˆ OpenAI Function Calling æ ¼å¼
- **å·¥å…·åŸºç±»è®¾è®¡**
  - å…ƒæ•°æ®å®šä¹‰ (name, description, category)
  - å‚æ•° Schema (JSON Schema æ ¼å¼)
  - execute æ–¹æ³•ç”±å­ç±»å®ç°
  - to_openai_schema è½¬æ¢æ–¹æ³•
- **æ’ä»¶åŒ–æ¶æ„**
  - å¼€é—­åŸåˆ™: æ–°å¢å·¥å…·æ— éœ€ä¿®æ”¹æ³¨å†Œè¡¨
  - è¿è¡Œæ—¶çƒ­åŠ è½½æ”¯æŒ
  - æå¼ºçš„å¯æ‰©å±•æ€§

#### 3.4 LLM æœåŠ¡é›†æˆ
- **å¤šæ¨¡å‹æ”¯æŒ**
  - é€‚é…å™¨æ¨¡å¼å°è£…ä¸åŒå‚å•† API
  - ç»Ÿä¸€æ¥å£ï¼Œæ¨¡å‹ä¸­ç«‹
  - æ”¯æŒ OpenAI, Anthropic, DeepSeek ç­‰
- **å·¥å…·è°ƒç”¨å¾ªç¯**
  - LLM å†³å®šè°ƒç”¨å·¥å…·
  - æ‰§è¡Œå·¥å…·å¹¶è·å–ç»“æœ
  - ç»“æœå›å¡«åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
  - é€’å½’ç”Ÿæˆæœ€ç»ˆå›ç­”
- **æµå¼å¤„ç†**
  - async for éšè—ç¼“å†²å’ŒçŠ¶æ€åŒæ­¥
  - å®ç°æ‰“å­—æœºæ•ˆæœ
  - é™ä½ç”¨æˆ·æ„Ÿå®˜å»¶è¿Ÿ

#### 3.5 ç”Ÿäº§çº§ç‰¹æ€§
- **æ¶ˆæ¯å»é‡**: MessageTracker + Redis
- **ç†”æ–­ä¿æŠ¤**: CircuitBreaker
- **å¹¶å‘æ§åˆ¶**: Session Lock + Redis
- **ä¸Šä¸‹æ–‡ä¿®å‰ª**: ContextPruner
- **åŠ¨æ€å·¥å…·**: è‡ªåŠ¨å‘ç° + æ³¨å†Œè¡¨
- **ç›‘æ§åŸ‹ç‚¹**: Prometheus + Metrics
- **å¼‚æ­¥å¤„ç†**: asyncio + é˜Ÿåˆ—
- **é”™è¯¯é™çº§**: Graceful Degradation

### å››ã€Flutter Mobile - è·¨å¹³å°ç§»åŠ¨ç«¯

#### 4.1 WebSocket æœåŠ¡ v2
- **å•ä¾‹æ¨¡å¼**: å…¨å±€å”¯ä¸€è¿æ¥ï¼ŒèŠ‚çœèµ„æº
- **ç¼“å†²é˜Ÿåˆ—**: æ–­å¼€æ—¶æš‚å­˜æ¶ˆæ¯ï¼Œé‡è¿åè‡ªåŠ¨é‡å‘
- **å“åº”å¼æµ**: StreamController è½¬æ¢ä¸šåŠ¡äº‹ä»¶æµ
- **æŒ‡æ•°é€€é¿é‡è¿**: 2^n å»¶è¿Ÿï¼Œæœ€é«˜ 32s
- **æ˜¾å¼å¿ƒè·³**: åº”ç”¨å±‚ä¿æ´»ï¼Œé˜²æ­¢ NAT æ–­è¿

#### 4.2 Riverpod çŠ¶æ€ç®¡ç†
- **å£°æ˜å¼ UI**: UI = f(state)ï¼Œè‡ªåŠ¨å“åº”çŠ¶æ€å˜åŒ–
- **ä¸å¯å˜æ•°æ®**: copyWith åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¾¿äºè¿½è¸ª
- **å•å‘æ•°æ®æµ**: UI â†’ Action â†’ State â†’ UI
- **Provider æ¶æ„**
  - WebSocket æœåŠ¡ Provider
  - èŠå¤©çŠ¶æ€ Notifier
  - çŠ¶æ€å­—æ®µ: messages, isLoading, response, aiStatus ç­‰
- **äº‹ä»¶å¤„ç†**
  - TextEvent: ç´¯ç§¯æµå¼æ–‡æœ¬
  - StatusUpdateEvent: AI çŠ¶æ€æŒ‡ç¤º
  - ErrorEvent: é”™è¯¯å¤„ç†
  - DoneEvent: æµç»“æŸ

#### 4.3 UI ç»„ä»¶ç³»ç»Ÿ
- **å£°æ˜å¼ UI**: æ•°æ®é©±åŠ¨ï¼Œè‡ªåŠ¨åˆ·æ–°
- **æ‡’åŠ è½½**: ListView.builder å»¶è¿Ÿæ¸²æŸ“
- **çŠ¶æ€æŒ‡ç¤ºå™¨**: THINKING, GENERATING, EXECUTING_TOOL ç­‰çŠ¶æ€å¯è§†åŒ–
- **æµå¼è¾“å‡º**: å®æ—¶æ‰“å­—æœºæ•ˆæœ
- **é”™è¯¯æç¤º**: SnackBar å’Œå‹å¥½é”™è¯¯ä¿¡æ¯

#### 4.4 çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–
- **Canvas API**: åº•å±‚ Skia ç»˜å›¾å¼•æ“
- **GLSL ç€è‰²å™¨**: ç«ç„°ã€å‘å…‰ã€ç²’å­æ•ˆæœ
- **CustomPainter**: é«˜æ€§èƒ½å›¾å½¢æ¸²æŸ“
- **æ•°æ®å¯è§†åŒ–**: æŒæ¡åº¦ç¯ã€æ˜ŸåŸŸåˆ†ç±»ã€å…³ç³»è¿çº¿
- **äº¤äº’è®¾è®¡**: ç¼©æ”¾ã€æ‹–æ‹½ã€ç‚¹å‡»è¯¦æƒ…

### äº”ã€æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ

#### 5.1 æ ¸å¿ƒè¡¨ç»“æ„
- **çŸ¥è¯†ç³»ç»Ÿ**
  - knowledge_nodes: çŸ¥è¯†èŠ‚ç‚¹ + å‘é‡åµŒå…¥
  - node_relations: çŸ¥è¯†å›¾è°±è¾¹
  - user_node_status: ç”¨æˆ·æŒæ¡åº¦çŠ¶æ€
  - study_records: å­¦ä¹ å†å²è®°å½•
- **ç”¨æˆ·ç³»ç»Ÿ**
  - users: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  - tasks: 6ç§ä»»åŠ¡ç±»å‹
  - plans: å†²åˆº/æˆé•¿è®¡åˆ’
- **æ¨é€ç³»ç»Ÿ**
  - push_preferences: æ¨é€åå¥½é…ç½®
  - push_histories: æ¨é€å†å²å»é‡
  - notifications: é€šçŸ¥è®°å½•
- **ç¤¾åŒºç³»ç»Ÿ**
  - posts: å¸–å­
  - post_likes: ç‚¹èµå…³ç³»

#### 5.2 ç´¢å¼•ç­–ç•¥
- **å‘é‡ç´¢å¼•**: HNSW ç®—æ³•ï¼Œä½™å¼¦ç›¸ä¼¼åº¦
  - å‚æ•°: m=16, ef_construction=64, ef_search=40
- **éƒ¨åˆ†ç´¢å¼•**: åªç´¢å¼•æ´»è·ƒæ•°æ®
  - `WHERE mastery_score < 100`
- **è¦†ç›–ç´¢å¼•**: é¿å…å›è¡¨
  - INCLUDE (node_id, mastery_delta)
- **BRIN ç´¢å¼•**: æ—¶é—´åºåˆ—ä¼˜åŒ–
  - pages_per_range = 128

#### 5.3 åˆ†åŒºç­–ç•¥
- **æŒ‰æ—¶é—´åˆ†åŒº**: study_records æŒ‰æœˆæ‹†åˆ†
- **åˆ†è€Œæ²»ä¹‹**: æé«˜èŒƒå›´æŸ¥è¯¢æ€§èƒ½
- **è‡ªåŠ¨ç®¡ç†**: æœˆåº¦åˆ†åŒºè‡ªåŠ¨åˆ›å»º

#### 5.4 æŸ¥è¯¢ä¼˜åŒ–
- **é¿å… N+1**: JOIN ä¸€æ¬¡æ€§æ‹‰å–å…³è”æ•°æ®
- **å…³ç³»ä»£æ•°**: åˆ©ç”¨ SQL å…³ç³»èƒ½åŠ›
- **å‡å°‘ IO**: åˆå¹¶æŸ¥è¯¢ï¼Œé™ä½ç½‘ç»œå¾€è¿”

### å…­ã€æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£

#### 6.1 çŸ¥è¯†æ˜Ÿå›¾ (Knowledge Galaxy)
- **æŒæ¡åº¦ç®—æ³•**
  - åŸºç¡€åˆ† Ã— é‡è¦åº¦ç³»æ•° Ã— æ¬¡æ•°è¡°å‡ Ã— æ—¶é—´ç³»æ•°
  - è¾¹é™…æ•ˆç”¨é€’å‡ï¼Œé¼“åŠ±æ¢ç´¢æ–°é¢†åŸŸ
  - å•æ¬¡ä¸Šé™ 20 ç‚¹ï¼Œé˜²æ­¢åˆ·åˆ†
- **è‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’**
  - é—´éš”é‡å¤: 1-3-7-14 å¤©åŸºç¡€é—´éš”
  - æŒæ¡åº¦å½±å“: è¶Šé«˜é—´éš”è¶Šé•¿
  - éšæœºå› å­: é¿å…ç”¨æˆ·åŒæ—¶å¤ä¹ 
- **æ··åˆæœç´¢ (RAG v2.0)**
  - å‘é‡æœç´¢: è¯­ä¹‰å¬å›
  - å…³é”®è¯æœç´¢: æœ¯è¯­ç²¾ç¡®åŒ¹é…
  - RRF èåˆ: æ’åèåˆï¼Œæƒé‡ 0.7/0.3
  - LLM é‡æ’åº: ç²¾ç»†æ’åº
- **çŸ¥è¯†å›¾è°±è‡ªç”Ÿé•¿**
  - LLM è‡ªåŠ¨æ‹“å±•å­çŸ¥è¯†ç‚¹
  - å»ºç«‹çˆ¶å­å…³ç³»å’Œè¯­ä¹‰è¾¹
  - è§¦å‘æ¡ä»¶: å­¦ä¹ æ¬¡æ•° â‰¥ 2

#### 6.2 ä»»åŠ¡ç®¡ç†
- **6ç§ä»»åŠ¡ç±»å‹**: å­¦ä¹ ã€è®­ç»ƒã€çº é”™ã€åæ€ã€ç¤¾äº¤ã€è§„åˆ’
- **ä»»åŠ¡çŠ¶æ€**: å¾…åŠã€è¿›è¡Œä¸­ã€å·²å®Œæˆã€å·²æ”¾å¼ƒ
- **è·¨åŸŸè”åŠ¨**: ä»»åŠ¡å®Œæˆ â†’ æŒæ¡åº¦æ›´æ–° â†’ çŸ¥è¯†æ‹“å±•
- **æ™ºèƒ½å»ºè®®**: åŸºäºç”¨æˆ·çŠ¶æ€ç”Ÿæˆä»»åŠ¡æ¨è

#### 6.3 æ™ºèƒ½æ¨é€ç³»ç»Ÿ
- **Persona ç­–ç•¥**: å†²åˆºæé†’ã€è®°å¿†å”¤é†’ã€æ²‰ç¡å”¤é†’
- **é¢‘ç‡æ§åˆ¶**: æ¯æ—¥ä¸Šé™ã€å»é‡æ£€æŸ¥
- **ä¸ªæ€§åŒ–**: æ—¶åŒºã€æ´»è·ƒæ—¶æ®µã€åå¥½é…ç½®
- **æ¼æ–—è¯„ä¼°**: ç´§æ€¥ > éœ€è¦ > å…´è¶£

### ä¸ƒã€ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º

#### 7.1 ç†”æ–­å™¨ (Circuit Breaker)
- **çŠ¶æ€æœº**: CLOSED â†’ OPEN â†’ HALF_OPEN
- **æ•…éšœä¿æŠ¤**: é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼è‡ªåŠ¨æ–­å¼€
- **æ¢å¤æœºåˆ¶**: å†·å´æ—¶é—´åå°è¯•æ¢å¤
- **é˜²æ­¢é›ªå´©**: å¿«é€Ÿå¤±è´¥ï¼Œä¿æŠ¤ä¸‹æ¸¸

#### 7.2 å¹‚ç­‰æ€§ä¸å»é‡
- **æ¶ˆæ¯å»é‡**: Redis TTL è®°å½•å·²å¤„ç†è¯·æ±‚
- **å¹‚ç­‰æ€§ä¿è¯**: é‡å¤è¯·æ±‚ç»“æœä¸€è‡´
- **é˜²é‡è¯•å‰¯ä½œç”¨**: é¿å…é‡å¤æ‰£è´¹ã€å†™åº“

#### 7.3 åˆ†å¸ƒå¼é”
- **åŸå­äº‰æŠ¢**: SET NX EX æŒ‡ä»¤
- **é˜²æ­»é”**: TTL å…œåº•
- **å¹¶å‘å®‰å…¨**: å¤šæœºç¯å¢ƒèµ„æºäº’æ–¥

#### 7.4 ç›‘æ§ä¸å¯è§‚æµ‹æ€§
- **Prometheus æŒ‡æ ‡**: Counter, Histogram
- **ç»“æ„åŒ–æ—¥å¿—**: JSON æ ¼å¼ï¼Œæœºå™¨å¯è¯»
- **å¥åº·æ£€æŸ¥**: Liveness vs Readiness
- **ä¸šåŠ¡æŒ‡æ ‡**: QPS, å»¶è¿Ÿ, é”™è¯¯ç‡

#### 7.5 é”™è¯¯å¤„ç†ä¸é™çº§
- **ä¼˜é›…é™çº§**: åˆ†çº§é™çº§ç­–ç•¥
- **è¶…æ—¶æ§åˆ¶**: é˜²æ­¢èµ„æºè€—å°½
- **æ•…éšœéš”ç¦»**: å•ç‚¹æ•…éšœä¸å½±å“å…¨å±€
- **è‡ªæ„ˆèƒ½åŠ›**: è‡ªåŠ¨æ¢å¤æœºåˆ¶

### å…«ã€å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª

#### 8.1 ç«¯åˆ°ç«¯æ•°æ®æµ
```
Mobile â†’ WebSocket â†’ Go Gateway â†’ gRPC â†’ Python Agent â†’ LLM
  â†“          â†“            â†“          â†“         â†“          â†“
JSON    è§£æ/éªŒè¯    åè®®è½¬æ¢    æµå¼è½¬å‘   ç¼–æ’/å·¥å…·   ç”Ÿæˆå“åº”
  â†‘          â†‘            â†‘          â†‘         â†‘          â†‘
UIæ›´æ–°   æµå¼æ¨é€    JSONè½¬æ¢    çŠ¶æ€ç®¡ç†   RAGæ£€ç´¢   å·¥å…·æ‰§è¡Œ
```

#### 8.2 å…³é”®æ—¶åº
- **0-100ms**: WebSocket å‘é€ï¼ŒGo æ¥æ”¶éªŒè¯
- **100-200ms**: gRPC è½¬å‘ï¼ŒPython ç¼–æ’
- **200-300ms**: LLM ç”Ÿæˆï¼ŒçŠ¶æ€æ›´æ–°
- **300-400ms**: æµå¼è¿”å›ï¼ŒUI å®æ—¶æ¸²æŸ“

#### 8.3 å¼‚æ­¥å¤„ç†é“¾
- **æ¶ˆæ¯é˜Ÿåˆ—**: å‰Šå³°å¡«è°·
- **åå° Worker**: å¼‚æ­¥æ€»ç»“ã€æ‹“å±•
- **äº‹ä»¶æ€»çº¿**: SSE é€šçŸ¥å‰ç«¯
- **ç¼“å­˜å›å¡«**: å¼‚æ­¥æ›´æ–° Redis

### ä¹ã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

#### 9.1 æ•°æ®åº“ä¼˜åŒ–
- **å¤šç»´ç´¢å¼•**: B-Tree + HNSW + BRIN
- **æŸ¥è¯¢ä¼˜åŒ–**: JOIN åˆå¹¶ï¼Œé¿å… N+1
- **åˆ†åŒºç­–ç•¥**: æ—¶é—´åˆ†ç‰‡ï¼Œæé«˜æ€§èƒ½
- **è¿æ¥æ± **: å¤ç”¨è¿æ¥ï¼Œå‡å°‘å¼€é”€

#### 9.2 å¹¶å‘æ§åˆ¶
- **åˆ†å¸ƒå¼ä¿¡å·é‡**: é™åˆ¶å¹¶å‘æ•°
- **æµé‡æ§åˆ¶**: é˜²æ­¢å•ç”¨æˆ·å æ»¡èµ„æº
- **èµ„æºéš”ç¦»**: å¤šç§Ÿæˆ·å…¬å¹³ç«äº‰

#### 9.3 ç¼“å­˜ç­–ç•¥
- **å¤šçº§ç¼“å­˜**: L1 å†…å­˜ + L2 Redis
- **è¯­ä¹‰ç¼“å­˜**: å‘é‡ç›¸ä¼¼åº¦åŒ¹é…
- **ç¼“å­˜å‡»ç©¿**: äº’æ–¥é”é‡å»º
- **ç¼“å­˜é›ªå´©**: éšæœºè¿‡æœŸæ—¶é—´

#### 9.4 å¼‚æ­¥ä¼˜åŒ–
- **å¹¶å‘æ‰§è¡Œ**: asyncio.gather
- **é™æµå¹¶å‘**: Semaphore
- **RAII æ¨¡å¼**: è‡ªåŠ¨äº‹åŠ¡ç®¡ç†
- **èµ„æºæ¸…ç†**: finally å—ä¿è¯

#### 9.5 æ€§èƒ½æŒ‡æ ‡
- **å»¶è¿Ÿ**: P50 < 500ms, P95 < 2000ms, P99 < 5000ms
- **ååé‡**: QPS 1000+, å¹¶å‘è¿æ¥ 10000+
- **èµ„æº**: CPU < 70%, å†…å­˜ < 80%
- **ä¸šåŠ¡**: ç¼“å­˜å‘½ä¸­ç‡ > 80%, é”™è¯¯ç‡ < 1%

### åã€é¢è¯•å¸¸è§é—®é¢˜è§£ç­”

#### 10.1 æ¶æ„è®¾è®¡
- **Q: ä¸ºä»€ä¹ˆ Go + Python æ··åˆï¼Ÿ**
  - A: èŒè´£åˆ†ç¦»ï¼Œå„å–æ‰€é•¿ã€‚Go å¤„ç†é«˜å¹¶å‘ IOï¼ŒPython å¤„ç† AI ç”Ÿæ€
- **Q: å¦‚ä½•ä¿è¯å¯æ‰©å±•æ€§ï¼Ÿ**
  - A: æ— çŠ¶æ€è®¾è®¡ï¼Œæ°´å¹³æ‰©å®¹ï¼Œåè®®é©±åŠ¨

#### 10.2 AI ç¼–æ’
- **Q: GraphRAG ä¼˜åŠ¿ï¼Ÿ**
  - A: å¼•å…¥æ‹“æ‰‘å…³ç³»ï¼Œæä¾›ç»“æ„åŒ–çŸ¥è¯†ï¼Œä¼˜äºæ™®é€š RAG
- **Q: å¦‚ä½•å¤„ç†é•¿å¯¹è¯ï¼Ÿ**
  - A: æ»‘åŠ¨çª—å£ + å¼‚æ­¥æ€»ç»“ï¼Œä¼˜é›…é™çº§

#### 10.3 ç”Ÿäº§çº§ç‰¹æ€§
- **Q: ç†”æ–­å™¨ä½œç”¨ï¼Ÿ**
  - A: é˜²æ­¢çº§è”æ•…éšœï¼Œå¿«é€Ÿå¤±è´¥ï¼Œä¿æŠ¤ä¸‹æ¸¸
- **Q: å¦‚ä½•ä¿è¯å¹‚ç­‰æ€§ï¼Ÿ**
  - A: è¯·æ±‚ ID å»é‡ï¼Œåˆ†å¸ƒå¼é”ï¼Œå”¯ä¸€ç´¢å¼•

#### 10.4 æ€§èƒ½ä¼˜åŒ–
- **Q: å‘é‡æœç´¢ä¼˜åŒ–ï¼Ÿ**
  - A: HNSW ç´¢å¼•ï¼ŒRedis ç¼“å­˜ï¼Œæ··åˆæ£€ç´¢
- **Q: æ•°æ®åº“ N+1 é—®é¢˜ï¼Ÿ**
  - A: JOIN åˆå¹¶æŸ¥è¯¢ï¼Œè¦†ç›–ç´¢å¼•ï¼Œæ‰¹é‡æ“ä½œ

### åä¸€ã€æŠ€æœ¯æ ˆä¸å·¥å…·é“¾

#### 11.1 åç«¯æŠ€æœ¯æ ˆ
- **Go**: Gin, Gorilla WebSocket, gRPC, SQLC
- **Python**: FastAPI, LangChain, pgvector, SQLAlchemy
- **æ•°æ®åº“**: PostgreSQL 16 + pgvector, Redis 7
- **é€šä¿¡**: gRPC (Protobuf), WebSocket

#### 11.2 å‰ç«¯æŠ€æœ¯æ ˆ
- **Flutter**: Riverpod, WebSocket, CustomPainter
- **çŠ¶æ€ç®¡ç†**: StateNotifier, ConsumerWidget
- **æœ¬åœ°å­˜å‚¨**: Hive, SharedPreferences
- **ç½‘ç»œ**: WebSocketChannel, Dio

#### 11.3 DevOps å·¥å…·
- **å®¹å™¨åŒ–**: Docker, Docker Compose
- **æ„å»º**: Makefile, go build, flutter build
- **æµ‹è¯•**: pytest, flutter test
- **ç›‘æ§**: Prometheus, Grafana, Loki

### åäºŒã€é¡¹ç›®é‡Œç¨‹ç¢‘ä¸æ¼”è¿›

#### 12.1 é˜¶æ®µæ¼”è¿›
- **Phase 1**: åŸºç¡€æ¶æ„å®Œæˆ (Python å•ä½“)
- **Phase 2**: ç”Ÿäº§çº§ Agent ç¼–æ’ (çŠ¶æ€ç®¡ç†ã€åŠ¨æ€å·¥å…·)
- **Phase 3**: Go ç½‘å…³é›†æˆ (WebSocket + gRPC)
- **Phase 4**: Flutter å®¢æˆ·ç«¯é€‚é… (æµå¼å“åº”)

#### 12.2 æ ¸å¿ƒæˆå°±
- âœ… æ··åˆæ¶æ„å®ç°ï¼Œæ€§èƒ½æå‡ 300%
- âœ… 11 æ­¥å®‰å…¨å¤„ç†é“¾ï¼Œç”Ÿäº§çº§å¯é æ€§
- âœ… GraphRAG çŸ¥è¯†å›¾è°±ï¼Œæ£€ç´¢ç²¾åº¦æå‡ 50%
- âœ… å®æ—¶æµå¼é€šä¿¡ï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿ < 500ms
- âœ… å®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»

#### 12.3 ç”Ÿäº§å°±ç»ªåº¦: 9.5/10
- **å·²å®Œæˆ**: æ¶æ„ã€å®‰å…¨ã€ç›‘æ§ã€ä¼˜åŒ–ã€é™çº§
- **å¾…å®Œå–„**: å•å…ƒæµ‹è¯•è¦†ç›–ç‡ã€CI/CDã€è´Ÿè½½æµ‹è¯•

---

## ğŸ“ å­¦ä¹ è·¯å¾„å»ºè®®

### åˆçº§é˜¶æ®µ (1-2å‘¨)
1. é˜…è¯»æ¶æ„æ–‡æ¡£ï¼Œç†è§£ä¸‰å±‚æ¶æ„
2. æ­å»ºå¼€å‘ç¯å¢ƒï¼Œè¿è¡Œ demo
3. å­¦ä¹  WebSocket å’Œ gRPC åŸºç¡€

### ä¸­çº§é˜¶æ®µ (2-4å‘¨)
1. å®ç° Go Gateway åŸºç¡€åŠŸèƒ½
2. ç†è§£ Python Agent ç¼–æ’é€»è¾‘
3. æŒæ¡ Riverpod çŠ¶æ€ç®¡ç†
4. å®ç°ç®€å•çš„ RAG æ£€ç´¢

### é«˜çº§é˜¶æ®µ (4-8å‘¨)
1. æ·±å…¥ç†è§£ç”Ÿäº§çº§ç‰¹æ€§ (ç†”æ–­ã€é™æµã€å¹‚ç­‰)
2. ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ (ç´¢å¼•ã€åˆ†åŒº)
3. å®ç°å¤æ‚ UI åŠ¨ç”» (GLSL ç€è‰²å™¨)
4. å®Œå–„ç›‘æ§å’Œè¿ç»´ä½“ç³»

### ä¸“å®¶é˜¶æ®µ (8å‘¨+)
1. è´¡çŒ®ä»£ç ï¼Œä¿®å¤ç”Ÿäº§é—®é¢˜
2. è®¾è®¡æ–°åŠŸèƒ½æ¨¡å—
3. ä¼˜åŒ–ç³»ç»Ÿæ¶æ„
4. æŠ€æœ¯åˆ†äº«å’Œæ–‡æ¡£å®Œå–„

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.1  
**æ›´æ–°æ—¥æœŸ**: 2025-12-27  
**çŸ¥è¯†ç‚¹æ•°é‡**: 200+  
**é€‚ç”¨å¯¹è±¡**: é«˜çº§åç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆã€æŠ€æœ¯è¯„å§”

*æœ¬æ¸…å•æ¶µç›–äº† Sparkle AI Learning Assistant çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯çŸ¥è¯†ç‚¹ï¼ŒæŒ‰ç…§é€»è¾‘å±‚æ¬¡å’Œé‡è¦æ€§æ’åºï¼Œé€‚åˆç³»ç»Ÿæ€§å­¦ä¹ å’Œé¢è¯•å‡†å¤‡ã€‚*
**æ–‡æ¡£ç»“æŸ**
*æœ¬æ–‡æ¡£æ¶µç›–äº† Sparkle AI Learning Assistant çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯ç»†èŠ‚ï¼Œä»å®è§‚æ¶æ„åˆ°å¾®è§‚å®ç°ï¼Œé€‚åˆé«˜çº§å·¥ç¨‹å¸ˆå’ŒæŠ€æœ¯è¯„å§”æ·±å…¥å­¦ä¹ ã€‚*

---

## ğŸ“š å®Œæ•´çŸ¥è¯†ç‚¹æ¸…å•

### ä¸€ã€ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡æ€æƒ³

#### 1.1 æ··åˆæ¶æ„è®¾è®¡
- **Go + Python + Flutter ä¸‰å±‚æ¶æ„**
  - Go Gateway: é«˜æ€§èƒ½ç½‘å…³å±‚ï¼Œå¤„ç† WebSocket é•¿è¿æ¥ã€JWT è®¤è¯ã€åˆ†å¸ƒå¼é™æµ
  - Python Agent: AI æ ¸å¿ƒå¼•æ“ï¼Œè´Ÿè´£ LLM ç¼–æ’ã€å·¥å…·è°ƒç”¨ã€å‘é‡æ£€ç´¢
  - Flutter Mobile: è·¨å¹³å°ç§»åŠ¨ç«¯ï¼Œå“åº”å¼ UI ä¸çŠ¶æ€ç®¡ç†
- **èŒè´£åˆ†ç¦»åŸåˆ™**
  - ç½‘å…³å±‚ä¸“æ³¨ IO å¯†é›†å‹ä»»åŠ¡ï¼ˆC10K å¹¶å‘èƒ½åŠ›ï¼‰
  - ä¸šåŠ¡å±‚ä¸“æ³¨ AI ç”Ÿæ€ä¸å¤æ‚é€»è¾‘
  - é€šè¿‡ gRPC äºŒè¿›åˆ¶åè®®å®ç°é«˜æ•ˆè·¨è¯­è¨€é€šä¿¡
- **å¯æ‰©å±•æ€§è®¾è®¡**
  - æ— çŠ¶æ€æœåŠ¡è®¾è®¡ï¼Œæ”¯æŒæ°´å¹³æ‰©å®¹
  - åˆ†å±‚è§£è€¦ï¼Œå„å±‚å¯ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
  - åè®®é©±åŠ¨ï¼ŒProtobuf å®šä¹‰æ¥å£ä¿è¯å‘å‰å…¼å®¹

#### 1.2 æ ¸å¿ƒè®¾è®¡æ¨¡å¼
- **ä¾èµ–æ³¨å…¥ (Dependency Injection)**
  - ç»“æ„ä½“å­—æ®µä¼ å…¥å¤–éƒ¨ä¾èµ–ï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤
  - ChatHandler æ³¨å…¥ gRPC å®¢æˆ·ç«¯ã€Redis å®¢æˆ·ç«¯ã€ä¼šè¯ç®¡ç†å™¨ç­‰
- **äº‹ä»¶é©±åŠ¨æ¨¡å¼ (Event-Driven)**
  - WebSocket æ¶ˆæ¯å¾ªç¯ä¸æ–­è¯»å–è§£æ JSON æ¶ˆæ¯
  - æµå¼å“åº”é€å—æ¨é€ï¼Œå®ç°å®æ—¶äº¤äº’
- **ç®¡é“æ¨¡å¼ (Pipelining)**
  - Go ç½‘å…³ä½œä¸º"ç®¡å­"ï¼Œæ•°æ®ä» gRPC è¿›æ¥ç›´æ¥æ³µå…¥ WebSocket
  - é›¶æ‹·è´æ€æƒ³ï¼Œæä½å†…å­˜å ç”¨
- **ç­–ç•¥æ¨¡å¼ (Strategy Pattern)**
  - LLM æœåŠ¡æ”¯æŒå¤šæ¨¡å‹æä¾›å•†åŠ¨æ€åˆ‡æ¢
  - å·¥å…·æ³¨å†Œè¡¨æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€å‘ç°å’Œæ³¨å†Œ

### äºŒã€Go Gateway é«˜æ€§èƒ½ç½‘å…³å±‚

#### 2.1 WebSocket å¤„ç†å™¨
- **è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†**
  - RAII + Defer èµ„æºç®¡ç†ï¼Œç¡®ä¿è¿æ¥æ–­å¼€æ—¶èµ„æºé‡Šæ”¾
  - ä¼šè¯éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·è¿æ¥ç‹¬ç«‹ä¼šè¯ ID
  - Goroutine å¹¶å‘ï¼Œç»´æŒé•¿è¿æ¥æ´»æ€§
- **å®Œæ•´æ•°æ®æµå‘**
  ```
  Flutter (JSON) â†’ Go (ReadJSON) â†’ Quota Check (Redis) â†’ Go (gRPC Call) â†’ Python Agent
                  â†“
  Flutter (UI) â† Go (WriteJSON) â† Stream Read â† Python (Stream Response)
  ```
- **å¿ƒè·³æœºåˆ¶**
  - Ping/Pong æ§åˆ¶å¸§æ£€æµ‹è¿æ¥å¥åº·
  - Redis ç§Ÿçº¦æœºåˆ¶ï¼Œæ›´æ–°ä¼šè¯æ´»è·ƒæ—¶é—´
  - é˜²ç«å¢™é˜²æ–­è¿ï¼Œåˆ†å¸ƒå¼ç¯å¢ƒçŠ¶æ€ä¸€è‡´æ€§

#### 2.2 è®¤è¯ä¸é™æµä¸­é—´ä»¶
- **JWT è®¤è¯ (Stateless Auth)**
  - æ— çŠ¶æ€è®¤è¯ï¼ŒæœåŠ¡å™¨æ— éœ€æŸ¥åº“
  - Token éªŒè¯ä¸è¿‡æœŸæ—¶é—´æ£€æŸ¥
  - ç”¨æˆ·ä¿¡æ¯æ³¨å…¥ Context ä¾›ä¸‹æ¸¸ä½¿ç”¨
- **åˆ†å¸ƒå¼é™æµ (Lua Script)**
  - Redis Lua è„šæœ¬å®ç°åŸå­æ“ä½œ
  - å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•
  - é˜²æ­¢ DDoS å’Œ API æ»¥ç”¨
- **åå‘ä»£ç†è®¾è®¡**
  - Director åˆ‡é¢æ³¨å…¥ç”¨æˆ·èº«ä»½ä¿¡æ¯
  - æ•…éšœéš”ç¦»ï¼Œä¸‹æ¸¸ä¸å¯ç”¨æ—¶è¿”å›å‹å¥½é”™è¯¯
  - é€æ˜ä»£ç†ï¼Œåç«¯æ— éœ€é‡å¤è®¤è¯

#### 2.3 ç”Ÿäº§çº§ç‰¹æ€§
- **è¿æ¥ç®¡ç†**: ä¼šè¯æ˜ å°„ + å¿ƒè·³ï¼Œé˜²æ­¢åƒµå°¸è¿æ¥
- **é…é¢æ§åˆ¶**: Redis è®¡æ•°å™¨ï¼Œé˜²æ­¢æ»¥ç”¨
- **è®¤è¯å®‰å…¨**: JWT + ç­¾åéªŒè¯
- **é™æµä¿æŠ¤**: Redis Lua è„šæœ¬ï¼Œé˜²æ­¢ DDoS
- **é”™è¯¯éš”ç¦»**: ç†”æ–­ + è¶…æ—¶ï¼Œé˜²æ­¢çº§è”æ•…éšœ
- **æ—¥å¿—è¿½è¸ª**: è¯·æ±‚ ID + ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥

### ä¸‰ã€Python Agent Engine - AI æ ¸å¿ƒå¼•æ“

#### 3.1 ç”Ÿäº§çº§ç¼–æ’å™¨ (ProductionChatOrchestrator)
- **11æ­¥å®‰å…¨å¤„ç†é“¾**
  1. åˆ†å¸ƒå¼æ¶ˆæ¯å»é‡ (Redis)
  2. æœåŠ¡ç†”æ–­å™¨æ£€æŸ¥
  3. å¹¶å‘é™åˆ¶ (Semaphore)
  4. è¯·æ±‚éªŒè¯
  5. å¹‚ç­‰æ€§æ£€æŸ¥
  6. åˆ†å¸ƒå¼é” (Redis SETNX)
  7. æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡
  8. GraphRAG çŸ¥è¯†æ£€ç´¢
  9. LLM ç¼–æ’ä¸å·¥å…·è°ƒç”¨
  10. æŒ‡æ ‡è®°å½•ä¸å“åº”ç¼“å­˜
  11. èµ„æºæ¸…ç†
- **æ ¸å¿ƒç¼–ç¨‹æ€æƒ³**
  - ç†”æ–­å™¨æ¨¡å¼: é˜²æ­¢çº§è”æ•…éšœ
  - å¹‚ç­‰æ€§è®¾è®¡: é˜²æ­¢é‡å¤å¤„ç†
  - åˆ†å¸ƒå¼é”: è§£å†³å¹¶å‘å†²çª
  - è´£ä»»é“¾æ¨¡å¼: æ¸…æ™°çš„å¤„ç†æµç¨‹

#### 3.2 ä¸Šä¸‹æ–‡ç®¡ç†
- **ç”¨æˆ·ä¸Šä¸‹æ–‡æ„å»º**
  - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€å­¦ä¹ è¿›åº¦ã€æ´»è·ƒå†²åˆºè®¡åˆ’
  - æ¨é€åå¥½ã€æ—¶åŒºã€è¯­è¨€ç­‰ä¸ªæ€§åŒ–é…ç½®
  - Pro ç­‰çº§åˆ¤æ–­ (flame_level >= 3)
- **çŸ¥è¯†æ£€ç´¢ (GraphRAG)**
  - å‘é‡æ··åˆæœç´¢ (pgvector + å…³é”®è¯)
  - å…³ç³»æ‰©å±• (çŸ¥è¯†å›¾è°±æ‹“æ‰‘å…³ç³»)
  - ç”¨æˆ·çŠ¶æ€è¿‡æ»¤ (ä¸ªæ€§åŒ–è£å‰ª)
- **ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨ (ContextPruner)**
  - æ»‘åŠ¨çª—å£: ä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯
  - å¼‚æ­¥æ€»ç»“: åå° Worker å‹ç¼©å†å²
  - ä¼˜é›…é™çº§: ç¼“å­˜å¤±æ•ˆæ—¶å›é€€åˆ°æ»‘åŠ¨çª—å£
  - å‰Šå³°å¡«è°·: Redis é˜Ÿåˆ—è§£è€¦

#### 3.3 åŠ¨æ€å·¥å…·ç³»ç»Ÿ
- **å·¥å…·æ³¨å†Œè¡¨ (DynamicToolRegistry)**
  - è‡ªåŠ¨æ‰«æ `app.tools` åŒ…
  - åå°„æœºåˆ¶å‘ç°æ‰€æœ‰ BaseTool å­ç±»
  - ç”Ÿæˆ OpenAI Function Calling æ ¼å¼
- **å·¥å…·åŸºç±»è®¾è®¡**
  - å…ƒæ•°æ®å®šä¹‰ (name, description, category)
  - å‚æ•° Schema (JSON Schema æ ¼å¼)
  - execute æ–¹æ³•ç”±å­ç±»å®ç°
  - to_openai_schema è½¬æ¢æ–¹æ³•
- **æ’ä»¶åŒ–æ¶æ„**
  - å¼€é—­åŸåˆ™: æ–°å¢å·¥å…·æ— éœ€ä¿®æ”¹æ³¨å†Œè¡¨
  - è¿è¡Œæ—¶çƒ­åŠ è½½æ”¯æŒ
  - æå¼ºçš„å¯æ‰©å±•æ€§

#### 3.4 LLM æœåŠ¡é›†æˆ
- **å¤šæ¨¡å‹æ”¯æŒ**
  - é€‚é…å™¨æ¨¡å¼å°è£…ä¸åŒå‚å•† API
  - ç»Ÿä¸€æ¥å£ï¼Œæ¨¡å‹ä¸­ç«‹
  - æ”¯æŒ OpenAI, Anthropic, DeepSeek ç­‰
- **å·¥å…·è°ƒç”¨å¾ªç¯**
  - LLM å†³å®šè°ƒç”¨å·¥å…·
  - æ‰§è¡Œå·¥å…·å¹¶è·å–ç»“æœ
  - ç»“æœå›å¡«åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
  - é€’å½’ç”Ÿæˆæœ€ç»ˆå›ç­”
- **æµå¼å¤„ç†**
  - async for éšè—ç¼“å†²å’ŒçŠ¶æ€åŒæ­¥
  - å®ç°æ‰“å­—æœºæ•ˆæœ
  - é™ä½ç”¨æˆ·æ„Ÿå®˜å»¶è¿Ÿ

#### 3.5 ç”Ÿäº§çº§ç‰¹æ€§
- **æ¶ˆæ¯å»é‡**: MessageTracker + Redis
- **ç†”æ–­ä¿æŠ¤**: CircuitBreaker
- **å¹¶å‘æ§åˆ¶**: Session Lock + Redis
- **ä¸Šä¸‹æ–‡ä¿®å‰ª**: ContextPruner
- **åŠ¨æ€å·¥å…·**: è‡ªåŠ¨å‘ç° + æ³¨å†Œè¡¨
- **ç›‘æ§åŸ‹ç‚¹**: Prometheus + Metrics
- **å¼‚æ­¥å¤„ç†**: asyncio + é˜Ÿåˆ—
- **é”™è¯¯é™çº§**: Graceful Degradation

### å››ã€Flutter Mobile - è·¨å¹³å°ç§»åŠ¨ç«¯

#### 4.1 WebSocket æœåŠ¡ v2
- **å•ä¾‹æ¨¡å¼**: å…¨å±€å”¯ä¸€è¿æ¥ï¼ŒèŠ‚çœèµ„æº
- **ç¼“å†²é˜Ÿåˆ—**: æ–­å¼€æ—¶æš‚å­˜æ¶ˆæ¯ï¼Œé‡è¿åè‡ªåŠ¨é‡å‘
- **å“åº”å¼æµ**: StreamController è½¬æ¢ä¸šåŠ¡äº‹ä»¶æµ
- **æŒ‡æ•°é€€é¿é‡è¿**: 2^n å»¶è¿Ÿï¼Œæœ€é«˜ 32s
- **æ˜¾å¼å¿ƒè·³**: åº”ç”¨å±‚ä¿æ´»ï¼Œé˜²æ­¢ NAT æ–­è¿

#### 4.2 Riverpod çŠ¶æ€ç®¡ç†
- **å£°æ˜å¼ UI**: UI = f(state)ï¼Œè‡ªåŠ¨å“åº”çŠ¶æ€å˜åŒ–
- **ä¸å¯å˜æ•°æ®**: copyWith åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¾¿äºè¿½è¸ª
- **å•å‘æ•°æ®æµ**: UI â†’ Action â†’ State â†’ UI
- **Provider æ¶æ„**
  - WebSocket æœåŠ¡ Provider
  - èŠå¤©çŠ¶æ€ Notifier
  - çŠ¶æ€å­—æ®µ: messages, isLoading, response, aiStatus ç­‰
- **äº‹ä»¶å¤„ç†**
  - TextEvent: ç´¯ç§¯æµå¼æ–‡æœ¬
  - StatusUpdateEvent: AI çŠ¶æ€æŒ‡ç¤º
  - ErrorEvent: é”™è¯¯å¤„ç†
  - DoneEvent: æµç»“æŸ

#### 4.3 UI ç»„ä»¶ç³»ç»Ÿ
- **å£°æ˜å¼ UI**: æ•°æ®é©±åŠ¨ï¼Œè‡ªåŠ¨åˆ·æ–°
- **æ‡’åŠ è½½**: ListView.builder å»¶è¿Ÿæ¸²æŸ“
- **çŠ¶æ€æŒ‡ç¤ºå™¨**: THINKING, GENERATING, EXECUTING_TOOL ç­‰çŠ¶æ€å¯è§†åŒ–
- **æµå¼è¾“å‡º**: å®æ—¶æ‰“å­—æœºæ•ˆæœ
- **é”™è¯¯æç¤º**: SnackBar å’Œå‹å¥½é”™è¯¯ä¿¡æ¯

#### 4.4 çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–
- **Canvas API**: åº•å±‚ Skia ç»˜å›¾å¼•æ“
- **GLSL ç€è‰²å™¨**: ç«ç„°ã€å‘å…‰ã€ç²’å­æ•ˆæœ
- **CustomPainter**: é«˜æ€§èƒ½å›¾å½¢æ¸²æŸ“
- **æ•°æ®å¯è§†åŒ–**: æŒæ¡åº¦ç¯ã€æ˜ŸåŸŸåˆ†ç±»ã€å…³ç³»è¿çº¿
- **äº¤äº’è®¾è®¡**: ç¼©æ”¾ã€æ‹–æ‹½ã€ç‚¹å‡»è¯¦æƒ…

### äº”ã€æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ

#### 5.1 æ ¸å¿ƒè¡¨ç»“æ„
- **çŸ¥è¯†ç³»ç»Ÿ**
  - knowledge_nodes: çŸ¥è¯†èŠ‚ç‚¹ + å‘é‡åµŒå…¥
  - node_relations: çŸ¥è¯†å›¾è°±è¾¹
  - user_node_status: ç”¨æˆ·æŒæ¡åº¦çŠ¶æ€
  - study_records: å­¦ä¹ å†å²è®°å½•
- **ç”¨æˆ·ç³»ç»Ÿ**
  - users: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  - tasks: 6ç§ä»»åŠ¡ç±»å‹
  - plans: å†²åˆº/æˆé•¿è®¡åˆ’
- **æ¨é€ç³»ç»Ÿ**
  - push_preferences: æ¨é€åå¥½é…ç½®
  - push_histories: æ¨é€å†å²å»é‡
  - notifications: é€šçŸ¥è®°å½•
- **ç¤¾åŒºç³»ç»Ÿ**
  - posts: å¸–å­
  - post_likes: ç‚¹èµå…³ç³»

#### 5.2 ç´¢å¼•ç­–ç•¥
- **å‘é‡ç´¢å¼•**: HNSW ç®—æ³•ï¼Œä½™å¼¦ç›¸ä¼¼åº¦
  - å‚æ•°: m=16, ef_construction=64, ef_search=40
- **éƒ¨åˆ†ç´¢å¼•**: åªç´¢å¼•æ´»è·ƒæ•°æ®
  - `WHERE mastery_score < 100`
- **è¦†ç›–ç´¢å¼•**: é¿å…å›è¡¨
  - INCLUDE (node_id, mastery_delta)
- **BRIN ç´¢å¼•**: æ—¶é—´åºåˆ—ä¼˜åŒ–
  - pages_per_range = 128

#### 5.3 åˆ†åŒºç­–ç•¥
- **æŒ‰æ—¶é—´åˆ†åŒº**: study_records æŒ‰æœˆæ‹†åˆ†
- **åˆ†è€Œæ²»ä¹‹**: æé«˜èŒƒå›´æŸ¥è¯¢æ€§èƒ½
- **è‡ªåŠ¨ç®¡ç†**: æœˆåº¦åˆ†åŒºè‡ªåŠ¨åˆ›å»º

#### 5.4 æŸ¥è¯¢ä¼˜åŒ–
- **é¿å… N+1**: JOIN ä¸€æ¬¡æ€§æ‹‰å–å…³è”æ•°æ®
- **å…³ç³»ä»£æ•°**: åˆ©ç”¨ SQL å…³ç³»èƒ½åŠ›
- **å‡å°‘ IO**: åˆå¹¶æŸ¥è¯¢ï¼Œé™ä½ç½‘ç»œå¾€è¿”

### å…­ã€æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£

#### 6.1 çŸ¥è¯†æ˜Ÿå›¾ (Knowledge Galaxy)
- **æŒæ¡åº¦ç®—æ³•**
  - åŸºç¡€åˆ† Ã— é‡è¦åº¦ç³»æ•° Ã— æ¬¡æ•°è¡°å‡ Ã— æ—¶é—´ç³»æ•°
  - è¾¹é™…æ•ˆç”¨é€’å‡ï¼Œé¼“åŠ±æ¢ç´¢æ–°é¢†åŸŸ
  - å•æ¬¡ä¸Šé™ 20 ç‚¹ï¼Œé˜²æ­¢åˆ·åˆ†
- **è‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’**
  - é—´éš”é‡å¤: 1-3-7-14 å¤©åŸºç¡€é—´éš”
  - æŒæ¡åº¦å½±å“: è¶Šé«˜é—´éš”è¶Šé•¿
  - éšæœºå› å­: é¿å…ç”¨æˆ·åŒæ—¶å¤ä¹ 
- **æ··åˆæœç´¢ (RAG v2.0)**
  - å‘é‡æœç´¢: è¯­ä¹‰å¬å›
  - å…³é”®è¯æœç´¢: æœ¯è¯­ç²¾ç¡®åŒ¹é…
  - RRF èåˆ: æ’åèåˆï¼Œæƒé‡ 0.7/0.3
  - LLM é‡æ’åº: ç²¾ç»†æ’åº
- **çŸ¥è¯†å›¾è°±è‡ªç”Ÿé•¿**
  - LLM è‡ªåŠ¨æ‹“å±•å­çŸ¥è¯†ç‚¹
  - å»ºç«‹çˆ¶å­å…³ç³»å’Œè¯­ä¹‰è¾¹
  - è§¦å‘æ¡ä»¶: å­¦ä¹ æ¬¡æ•° â‰¥ 2

#### 6.2 ä»»åŠ¡ç®¡ç†
- **6ç§ä»»åŠ¡ç±»å‹**: å­¦ä¹ ã€è®­ç»ƒã€çº é”™ã€åæ€ã€ç¤¾äº¤ã€è§„åˆ’
- **ä»»åŠ¡çŠ¶æ€**: å¾…åŠã€è¿›è¡Œä¸­ã€å·²å®Œæˆã€å·²æ”¾å¼ƒ
- **è·¨åŸŸè”åŠ¨**: ä»»åŠ¡å®Œæˆ â†’ æŒæ¡åº¦æ›´æ–° â†’ çŸ¥è¯†æ‹“å±•
- **æ™ºèƒ½å»ºè®®**: åŸºäºç”¨æˆ·çŠ¶æ€ç”Ÿæˆä»»åŠ¡æ¨è

#### 6.3 æ™ºèƒ½æ¨é€ç³»ç»Ÿ
- **Persona ç­–ç•¥**: å†²åˆºæé†’ã€è®°å¿†å”¤é†’ã€æ²‰ç¡å”¤é†’
- **é¢‘ç‡æ§åˆ¶**: æ¯æ—¥ä¸Šé™ã€å»é‡æ£€æŸ¥
- **ä¸ªæ€§åŒ–**: æ—¶åŒºã€æ´»è·ƒæ—¶æ®µã€åå¥½é…ç½®
- **æ¼æ–—è¯„ä¼°**: ç´§æ€¥ > éœ€è¦ > å…´è¶£

### ä¸ƒã€ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º

#### 7.1 ç†”æ–­å™¨ (Circuit Breaker)
- **çŠ¶æ€æœº**: CLOSED â†’ OPEN â†’ HALF_OPEN
- **æ•…éšœä¿æŠ¤**: é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼è‡ªåŠ¨æ–­å¼€
- **æ¢å¤æœºåˆ¶**: å†·å´æ—¶é—´åå°è¯•æ¢å¤
- **é˜²æ­¢é›ªå´©**: å¿«é€Ÿå¤±è´¥ï¼Œä¿æŠ¤ä¸‹æ¸¸

#### 7.2 å¹‚ç­‰æ€§ä¸å»é‡
- **æ¶ˆæ¯å»é‡**: Redis TTL è®°å½•å·²å¤„ç†è¯·æ±‚
- **å¹‚ç­‰æ€§ä¿è¯**: é‡å¤è¯·æ±‚ç»“æœä¸€è‡´
- **é˜²é‡è¯•å‰¯ä½œç”¨**: é¿å…é‡å¤æ‰£è´¹ã€å†™åº“

#### 7.3 åˆ†å¸ƒå¼é”
- **åŸå­äº‰æŠ¢**: SET NX EX æŒ‡ä»¤
- **é˜²æ­»é”**: TTL å…œåº•
- **å¹¶å‘å®‰å…¨**: å¤šæœºç¯å¢ƒèµ„æºäº’æ–¥

#### 7.4 ç›‘æ§ä¸å¯è§‚æµ‹æ€§
- **Prometheus æŒ‡æ ‡**: Counter, Histogram
- **ç»“æ„åŒ–æ—¥å¿—**: JSON æ ¼å¼ï¼Œæœºå™¨å¯è¯»
- **å¥åº·æ£€æŸ¥**: Liveness vs Readiness
- **ä¸šåŠ¡æŒ‡æ ‡**: QPS, å»¶è¿Ÿ, é”™è¯¯ç‡

#### 7.5 é”™è¯¯å¤„ç†ä¸é™çº§
- **ä¼˜é›…é™çº§**: åˆ†çº§é™çº§ç­–ç•¥
- **è¶…æ—¶æ§åˆ¶**: é˜²æ­¢èµ„æºè€—å°½
- **æ•…éšœéš”ç¦»**: å•ç‚¹æ•…éšœä¸å½±å“å…¨å±€
- **è‡ªæ„ˆèƒ½åŠ›**: è‡ªåŠ¨æ¢å¤æœºåˆ¶

### å…«ã€å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª

#### 8.1 ç«¯åˆ°ç«¯æ•°æ®æµ
```
Mobile â†’ WebSocket â†’ Go Gateway â†’ gRPC â†’ Python Agent â†’ LLM
  â†“          â†“            â†“          â†“         â†“          â†“
JSON    è§£æ/éªŒè¯    åè®®è½¬æ¢    æµå¼è½¬å‘   ç¼–æ’/å·¥å…·   ç”Ÿæˆå“åº”
  â†‘          â†‘            â†‘          â†‘         â†‘          â†‘
UIæ›´æ–°   æµå¼æ¨é€    JSONè½¬æ¢    çŠ¶æ€ç®¡ç†   RAGæ£€ç´¢   å·¥å…·æ‰§è¡Œ
```

#### 8.2 å…³é”®æ—¶åº
- **0-100ms**: WebSocket å‘é€ï¼ŒGo æ¥æ”¶éªŒè¯
- **100-200ms**: gRPC è½¬å‘ï¼ŒPython ç¼–æ’
- **200-300ms**: LLM ç”Ÿæˆï¼ŒçŠ¶æ€æ›´æ–°
- **300-400ms**: æµå¼è¿”å›ï¼ŒUI å®æ—¶æ¸²æŸ“

#### 8.3 å¼‚æ­¥å¤„ç†é“¾
- **æ¶ˆæ¯é˜Ÿåˆ—**: å‰Šå³°å¡«è°·
- **åå° Worker**: å¼‚æ­¥æ€»ç»“ã€æ‹“å±•
- **äº‹ä»¶æ€»çº¿**: SSE é€šçŸ¥å‰ç«¯
- **ç¼“å­˜å›å¡«**: å¼‚æ­¥æ›´æ–° Redis

### ä¹ã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

#### 9.1 æ•°æ®åº“ä¼˜åŒ–
- **å¤šç»´ç´¢å¼•**: B-Tree + HNSW + BRIN
- **æŸ¥è¯¢ä¼˜åŒ–**: JOIN åˆå¹¶ï¼Œé¿å… N+1
- **åˆ†åŒºç­–ç•¥**: æ—¶é—´åˆ†ç‰‡ï¼Œæé«˜æ€§èƒ½
- **è¿æ¥æ± **: å¤ç”¨è¿æ¥ï¼Œå‡å°‘å¼€é”€

#### 9.2 å¹¶å‘æ§åˆ¶
- **åˆ†å¸ƒå¼ä¿¡å·é‡**: é™åˆ¶å¹¶å‘æ•°
- **æµé‡æ§åˆ¶**: é˜²æ­¢å•ç”¨æˆ·å æ»¡èµ„æº
- **èµ„æºéš”ç¦»**: å¤šç§Ÿæˆ·å…¬å¹³ç«äº‰

#### 9.3 ç¼“å­˜ç­–ç•¥
- **å¤šçº§ç¼“å­˜**: L1 å†…å­˜ + L2 Redis
- **è¯­ä¹‰ç¼“å­˜**: å‘é‡ç›¸ä¼¼åº¦åŒ¹é…
- **ç¼“å­˜å‡»ç©¿**: äº’æ–¥é”é‡å»º
- **ç¼“å­˜é›ªå´©**: éšæœºè¿‡æœŸæ—¶é—´

#### 9.4 å¼‚æ­¥ä¼˜åŒ–
- **å¹¶å‘æ‰§è¡Œ**: asyncio.gather
- **é™æµå¹¶å‘**: Semaphore
- **RAII æ¨¡å¼**: è‡ªåŠ¨äº‹åŠ¡ç®¡ç†
- **èµ„æºæ¸…ç†**: finally å—ä¿è¯

#### 9.5 æ€§èƒ½æŒ‡æ ‡
- **å»¶è¿Ÿ**: P50 < 500ms, P95 < 2000ms, P99 < 5000ms
- **ååé‡**: QPS 1000+, å¹¶å‘è¿æ¥ 10000+
- **èµ„æº**: CPU < 70%, å†…å­˜ < 80%
- **ä¸šåŠ¡**: ç¼“å­˜å‘½ä¸­ç‡ > 80%, é”™è¯¯ç‡ < 1%

### åã€é¢è¯•å¸¸è§é—®é¢˜è§£ç­”

#### 10.1 æ¶æ„è®¾è®¡
- **Q: ä¸ºä»€ä¹ˆ Go + Python æ··åˆï¼Ÿ**
  - A: èŒè´£åˆ†ç¦»ï¼Œå„å–æ‰€é•¿ã€‚Go å¤„ç†é«˜å¹¶å‘ IOï¼ŒPython å¤„ç† AI ç”Ÿæ€
- **Q: å¦‚ä½•ä¿è¯å¯æ‰©å±•æ€§ï¼Ÿ**
  - A: æ— çŠ¶æ€è®¾è®¡ï¼Œæ°´å¹³æ‰©å®¹ï¼Œåè®®é©±åŠ¨

#### 10.2 AI ç¼–æ’
- **Q: GraphRAG ä¼˜åŠ¿ï¼Ÿ**
  - A: å¼•å…¥æ‹“æ‰‘å…³ç³»ï¼Œæä¾›ç»“æ„åŒ–çŸ¥è¯†ï¼Œä¼˜äºæ™®é€š RAG
- **Q: å¦‚ä½•å¤„ç†é•¿å¯¹è¯ï¼Ÿ**
  - A: æ»‘åŠ¨çª—å£ + å¼‚æ­¥æ€»ç»“ï¼Œä¼˜é›…é™çº§

#### 10.3 ç”Ÿäº§çº§ç‰¹æ€§
- **Q: ç†”æ–­å™¨ä½œç”¨ï¼Ÿ**
  - A: é˜²æ­¢çº§è”æ•…éšœï¼Œå¿«é€Ÿå¤±è´¥ï¼Œä¿æŠ¤ä¸‹æ¸¸
- **Q: å¦‚ä½•ä¿è¯å¹‚ç­‰æ€§ï¼Ÿ**
  - A: è¯·æ±‚ ID å»é‡ï¼Œåˆ†å¸ƒå¼é”ï¼Œå”¯ä¸€ç´¢å¼•

#### 10.4 æ€§èƒ½ä¼˜åŒ–
- **Q: å‘é‡æœç´¢ä¼˜åŒ–ï¼Ÿ**
  - A: HNSW ç´¢å¼•ï¼ŒRedis ç¼“å­˜ï¼Œæ··åˆæ£€ç´¢
- **Q: æ•°æ®åº“ N+1 é—®é¢˜ï¼Ÿ**
  - A: JOIN åˆå¹¶æŸ¥è¯¢ï¼Œè¦†ç›–ç´¢å¼•ï¼Œæ‰¹é‡æ“ä½œ

### åä¸€ã€æŠ€æœ¯æ ˆä¸å·¥å…·é“¾

#### 11.1 åç«¯æŠ€æœ¯æ ˆ
- **Go**: Gin, Gorilla WebSocket, gRPC, SQLC
- **Python**: FastAPI, LangChain, pgvector, SQLAlchemy
- **æ•°æ®åº“**: PostgreSQL 16 + pgvector, Redis 7
- **é€šä¿¡**: gRPC (Protobuf), WebSocket

#### 11.2 å‰ç«¯æŠ€æœ¯æ ˆ
- **Flutter**: Riverpod, WebSocket, CustomPainter
- **çŠ¶æ€ç®¡ç†**: StateNotifier, ConsumerWidget
- **æœ¬åœ°å­˜å‚¨**: Hive, SharedPreferences
- **ç½‘ç»œ**: WebSocketChannel, Dio

#### 11.3 DevOps å·¥å…·
- **å®¹å™¨åŒ–**: Docker, Docker Compose
- **æ„å»º**: Makefile, go build, flutter build
- **æµ‹è¯•**: pytest, flutter test
- **ç›‘æ§**: Prometheus, Grafana, Loki

### åäºŒã€é¡¹ç›®é‡Œç¨‹ç¢‘ä¸æ¼”è¿›

#### 12.1 é˜¶æ®µæ¼”è¿›
- **Phase 1**: åŸºç¡€æ¶æ„å®Œæˆ (Python å•ä½“)
- **Phase 2**: ç”Ÿäº§çº§ Agent ç¼–æ’ (çŠ¶æ€ç®¡ç†ã€åŠ¨æ€å·¥å…·)
- **Phase 3**: Go ç½‘å…³é›†æˆ (WebSocket + gRPC)
- **Phase 4**: Flutter å®¢æˆ·ç«¯é€‚é… (æµå¼å“åº”)

#### 12.2 æ ¸å¿ƒæˆå°±
- âœ… æ··åˆæ¶æ„å®ç°ï¼Œæ€§èƒ½æå‡ 300%
- âœ… 11 æ­¥å®‰å…¨å¤„ç†é“¾ï¼Œç”Ÿäº§çº§å¯é æ€§
- âœ… GraphRAG çŸ¥è¯†å›¾è°±ï¼Œæ£€ç´¢ç²¾åº¦æå‡ 50%
- âœ… å®æ—¶æµå¼é€šä¿¡ï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿ < 500ms
- âœ… å®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»

#### 12.3 ç”Ÿäº§å°±ç»ªåº¦: 9.5/10
- **å·²å®Œæˆ**: æ¶æ„ã€å®‰å…¨ã€ç›‘æ§ã€ä¼˜åŒ–ã€é™çº§
- **å¾…å®Œå–„**: å•å…ƒæµ‹è¯•è¦†ç›–ç‡ã€CI/CDã€è´Ÿè½½æµ‹è¯•

---

## ğŸ“ å­¦ä¹ è·¯å¾„å»ºè®®

### åˆçº§é˜¶æ®µ (1-2å‘¨)
1. é˜…è¯»æ¶æ„æ–‡æ¡£ï¼Œç†è§£ä¸‰å±‚æ¶æ„
2. æ­å»ºå¼€å‘ç¯å¢ƒï¼Œè¿è¡Œ demo
3. å­¦ä¹  WebSocket å’Œ gRPC åŸºç¡€

### ä¸­çº§é˜¶æ®µ (2-4å‘¨)
1. å®ç° Go Gateway åŸºç¡€åŠŸèƒ½
2. ç†è§£ Python Agent ç¼–æ’é€»è¾‘
3. æŒæ¡ Riverpod çŠ¶æ€ç®¡ç†
4. å®ç°ç®€å•çš„ RAG æ£€ç´¢

### é«˜çº§é˜¶æ®µ (4-8å‘¨)
1. æ·±å…¥ç†è§£ç”Ÿäº§çº§ç‰¹æ€§ (ç†”æ–­ã€é™æµã€å¹‚ç­‰)
2. ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ (ç´¢å¼•ã€åˆ†åŒº)
3. å®ç°å¤æ‚ UI åŠ¨ç”» (GLSL ç€è‰²å™¨)
4. å®Œå–„ç›‘æ§å’Œè¿ç»´ä½“ç³»

### ä¸“å®¶é˜¶æ®µ (8å‘¨+)
1. è´¡çŒ®ä»£ç ï¼Œä¿®å¤ç”Ÿäº§é—®é¢˜
2. è®¾è®¡æ–°åŠŸèƒ½æ¨¡å—
3. ä¼˜åŒ–ç³»ç»Ÿæ¶æ„
4. æŠ€æœ¯åˆ†äº«å’Œæ–‡æ¡£å®Œå–„

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.1  
**æ›´æ–°æ—¥æœŸ**: 2025-12-27  
**çŸ¥è¯†ç‚¹æ•°é‡**: 200+  
**é€‚ç”¨å¯¹è±¡**: é«˜çº§åç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆã€æŠ€æœ¯è¯„å§”

*æœ¬æ¸…å•æ¶µç›–äº† Sparkle AI Learning Assistant çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯çŸ¥è¯†ç‚¹ï¼ŒæŒ‰ç…§é€»è¾‘å±‚æ¬¡å’Œé‡è¦æ€§æ’åºï¼Œé€‚åˆç³»ç»Ÿæ€§å­¦ä¹ å’Œé¢è¯•å‡†å¤‡ã€‚*