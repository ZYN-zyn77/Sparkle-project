# 项目全景技术与需求白皮书（面向 AI Agent 协作者）

## 1. 项目核心概览 (Core Philosophy)

### 项目定义
- Sparkle（星火）是一款面向大学生的“AI 时间导师”型智能学习助手，通过“对话 → 任务卡 → 执行 → 反馈 → 冲刺计划”的闭环提高学习效率，服务目标是在 2025 年 2 月 2 日前完成可参赛的 MVP。【F:README.md†L1-L25】

### 设计哲学
- **学习闭环优先**：所有交互围绕对话、任务卡、专注执行、反馈与计划形成闭环，以保证建议能转化为行动。【F:README.md†L7-L25】
- **高并发实时体验**：采用 Go 网关 + Python Agent 的混合架构，确保 WebSocket 流式对话、状态可视化与移动端实时体验稳定低延迟。【F:README.md†L73-L83】【F:docs/00_项目概览/02_技术架构.md†L9-L88】
- **上下文完整性**：P0 阶段新增 Go 侧用户上下文聚合与 Python 侧合并，确保个性化决策基于最新任务/计划/专注状态。【F:IMPLEMENTATION_PROGRESS.md†L7-L40】
- **安全性硬约束**：WebSocket 令牌从 URL 移至 Header，补齐重连与竞态防护，保证审计最小集通过且不破坏兼容性。【F:WEBSOCKET_SECURITY_FIX_SUMMARY.md†L13-L80】
- **可进化智能体**：Phase 4 将单步工具执行升级为多智能体协作与长期学习路由，强调意图分类、协同编排与工具偏好学习闭环。【F:PHASE4_FINAL_SUMMARY.md†L14-L103】

### 关键术语表
- **AI 时间导师**：面向学生的对话式助手，通过实时指导与计划分解帮助管理学习时间。【F:README.md†L3-L25】
- **任务卡（Task Card）**：六类任务（学习/训练/纠错/反思/社交/规划），具备状态管理与 AI 推荐能力。【F:README.md†L16-L25】
- **冲刺计划（Sprint Plan）/成长计划（Growth Plan）**：短期考试冲刺与长期成长规划，由 AI 协助拆解任务并跟踪进度。【F:README.md†L22-L25】
- **知识星图（Knowledge Map）**：可视化知识图谱，提供向量搜索、遗忘曲线复习与掌握度追踪。【F:README.md†L36-L42】
- **StreamChat**：gRPC 双向流接口，网关与 Python Agent 之间的主要对话通道，支持工具流式调用。【F:proto/agent_service.proto†L10-L144】
- **Extra Context**：Go 网关注入的用户 JSON 状态（待办任务、活跃计划、专注数据等），写入 UserProfile.extra_context 传递给 Python Orchestrator。【F:proto/agent_service.proto†L61-L76】【F:IMPLEMENTATION_PROGRESS.md†L7-L35】
- **协作工作流**：基于意图分类的多智能体协作（任务分解、渐进探索、错题诊断），由标准工作流图路由触发。【F:PHASE4_FINAL_SUMMARY.md†L34-L64】【F:PHASE4_FINAL_SUMMARY.md†L121-L135】
- **工具历史学习**：user_tool_history 表记录工具执行与反馈，驱动 ToolPreferenceRouter 对工具进行成功率排序与偏好学习。【F:PHASE4_FINAL_SUMMARY.md†L65-L103】

## 2. 需求与用户视角 (User Needs & Scenarios)

### 目标用户画像
- 主要用户为大学生（大二/大三计算机专业学生为核心试点），熟悉基础编程与实时通信应用场景。【F:README.md†L200-L207】

### 核心痛点与解决方案
- **痛点：学习计划难落地、易分心。** 解决：AI 微导师结合任务卡与番茄钟专注模式，提供实时建议与专注倒计时执行。【F:README.md†L16-L25】
- **痛点：错题与知识点易遗忘。** 解决：错题档案+遗忘曲线复习提醒+知识星图向量搜索，自动推送复习节奏。【F:README.md†L27-L42】
- **痛点：缺少备考与长期成长规划。** 解决：冲刺计划/成长计划模板，AI 拆解任务并持续跟踪完成率与活跃度（火花等级/亮度）。【F:README.md†L22-L33】
- **痛点：社交学习与激励不足。** 解决：好友、学习小队、冲刺群与火堆系统营造学习氛围，并通过个性化推送激励沉睡用户。【F:README.md†L44-L57】
- **痛点：移动端实时体验与安全。** 解决：Go 网关支撑高并发 WebSocket、实时状态可视化；Flutter 端移除 URL 令牌并使用 Header 鉴权提升安全性与稳定性。【F:README.md†L73-L83】【F:WEBSOCKET_SECURITY_FIX_SUMMARY.md†L13-L80】

### 用户旅程 (Happy Path & 异常流程)
1. **进入与认证**：游客可直接体验核心功能，注册用户完成 JWT 登录，客户端准备 Authorization Header 用于 WebSocket 与 HTTP。【F:README.md†L59-L83】【F:WEBSOCKET_SECURITY_FIX_SUMMARY.md†L13-L35】
2. **对话触达需求**：用户提问（如“我现在应该做什么？”），网关附加 Extra Context（任务、计划、专注统计）并调用 StreamChat。【F:IMPLEMENTATION_PROGRESS.md†L7-L35】【F:proto/agent_service.proto†L26-L144】
3. **AI 决策与反馈**（Happy Path）：Python Orchestrator合并上下文后进行意图分类→（可选）协作工作流→工具规划与执行→生成行动卡/专注建议。【F:IMPLEMENTATION_PROGRESS.md†L26-L35】【F:PHASE4_FINAL_SUMMARY.md†L34-L135】
4. **执行与跟踪**：用户按行动卡执行任务，系统通过工具历史记录成功率、反馈与耗时，优化后续推荐与路由。【F:PHASE4_FINAL_SUMMARY.md†L65-L103】
5. **复习与成长**：知识星图与错题档案驱动遗忘曲线提醒；冲刺/成长计划更新完成率与活跃度（火花等级/亮度）。【F:README.md†L27-L42】
6. **异常与恢复**：WebSocket 出现断线或竞态时，客户端凭 Header 自动重连并带抖动；pending 队列上限 50，超过后清空避免风暴，保证会话安全与稳定。【F:WEBSOCKET_SECURITY_FIX_SUMMARY.md†L30-L80】

## 3. 技术实现架构 (Technical Implementation)

### 技术栈
- **前端/移动端**：Flutter 3.x + Riverpod；Dio/Retrofit + WebSocket；shared_preferences + Hive，本地高性能存储与跨平台一致体验。【F:README.md†L65-L71】【F:docs/00_项目概览/02_技术架构.md†L141-L210】
- **网关后端**：Go（Gin + Gorilla WebSocket）承担高并发连接、鉴权、协议转换与 SQLC/pgx 数据访问。【F:README.md†L73-L79】【F:docs/00_项目概览/02_技术架构.md†L41-L88】
- **Agent 引擎**：Python gRPC + LangChain/LangGraph，SQLAlchemy/Alembic 管理数据库，支持向量检索与工具编排。【F:README.md†L73-L83】【F:docs/00_项目概览/02_技术架构.md†L58-L88】
- **数据与基础设施**：PostgreSQL 16 + pgvector（共享数据模型与向量检索）、Redis 缓存、Docker Compose 开发环境。【F:README.md†L73-L83】【F:docs/00_项目概览/02_技术架构.md†L75-L80】

### 架构设计与数据流
- **端到端链路**：Flutter 通过 WebSocket/HTTP 接入 Go 网关；网关以 gRPC StreamChat 调用 Python Agent；Agent 访问 PostgreSQL/pgvector、LLM 服务与 Redis，结果以流式消息返回前端。【F:docs/00_项目概览/02_技术架构.md†L9-L38】
- **上下文注入流**：Go 网关并行查询待办任务、活跃计划、专注统计与近期进度，序列化为 Extra Context 写入 UserProfile 并随 gRPC 请求下发；Python Orchestrator 解析 JSON，与本地上下文合并并记录日志后用于 Prompt 注入。【F:IMPLEMENTATION_PROGRESS.md†L7-L40】【F:proto/agent_service.proto†L61-L76】
- **多智能体协作**：标准工作流新增意图分类器（6 种）、协作检测与路由，按意图选择 TaskDecomposition/ProgressiveExploration/ErrorDiagnosis 等协作节点，并在图中强制生成行动卡输出。【F:PHASE4_FINAL_SUMMARY.md†L34-L64】【F:PHASE4_FINAL_SUMMARY.md†L121-L135】
- **工具历史学习闭环**：Executor 自动写入 user_tool_history（成功/失败、耗时、错误、上下文、用户反馈），ToolHistoryService 与 ToolPreferenceRouter 计算成功率、排序与推荐，路由决策在 <300ms 内完成优化选择。【F:PHASE4_FINAL_SUMMARY.md†L65-L103】
- **安全与稳定性**：WebSocket 令牌改为 Header，IOWebSocketChannel 支持自定义 headers；重连带抖动与 pending 队列上限 50，避免风暴并清理遗留消息，兼顾向后兼容与审计要求。【F:WEBSOCKET_SECURITY_FIX_SUMMARY.md†L13-L120】

### 关键逻辑与算法（伪代码/步骤）
- **用户上下文合并**  
  1) 网关：并发获取 pending_tasks/active_plans/focus_stats/recent_progress → JSON → 写入 user_profile.extra_context。  
  2) Python：`_merge_user_contexts()` 解析 gRPC extra_context，与 `_build_user_context()` 本地快照合并，gRPC 优先，解析失败则回退本地。  
  3) 结果注入 Prompt/工具路由，确保回复贴合当前任务。  
  （来源：实施进度与 proto 增强）【F:IMPLEMENTATION_PROGRESS.md†L7-L35】【F:proto/agent_service.proto†L61-L76】
- **意图分类与协作路由**  
  1) `tool_planning_node` 存储意图 → `_classify_user_intent()` 识别 6 类意图。  
  2) `_should_use_collaboration()` 判断是否进入协作 → `_select_workflow()` 选择具体协作图。  
  3) `collaboration_node` 协作执行（多 Agent 汇聚）→ `collaboration_post_process_node` 统一产出行动卡。  
  （来源：Phase 4 协作集成）【F:PHASE4_FINAL_SUMMARY.md†L34-L64】【F:PHASE4_FINAL_SUMMARY.md†L121-L135】
- **工具偏好学习与路由优化**  
  1) Executor 写入 user_tool_history（成功率、耗时、错误、反馈）。  
  2) ToolPreferenceRouter 计算成功概率、排序并给出 fallback/重试决策。  
  3) RouterNode 在 <300ms 内重排工具列表，下一轮调用优先高成功率工具。  
  （来源：Phase 4 长期记忆与优化）【F:PHASE4_FINAL_SUMMARY.md†L65-L103】
- **安全连接与恢复策略**  
  1) WebSocket 连接改用 Authorization Header；  
  2) 重连加入随机抖动，超过最大重试清空 pending 队列；  
  3) Dispose 竞态检查 7 处，避免资源泄漏；  
  4) 单元测试覆盖 token 隐藏、重连上限、pending 队列与 Web 平台错误。  
  （来源：安全修复总结）【F:WEBSOCKET_SECURITY_FIX_SUMMARY.md†L13-L120】

### 数据结构（核心实体）
- **ChatRequest / UserProfile / ChatResponse (gRPC)**：包含 user_id、session_id、消息或工具结果、UserProfile（含 extra_context）、历史与配置；响应流支持 delta、tool_call、status_update、tool_result 等，一并标注 finish_reason 与 request_id 追踪。【F:proto/agent_service.proto†L26-L183】
- **AgentStatus & AgentType**：状态枚举（思考/搜索/执行工具/生成）与类型化 Agent（知识/数学/代码/数据分析/翻译/图像/音频/写作/推理），便于 UI 可视化与路由控制。【F:proto/agent_service.proto†L186-L214】
- **MemoryQuery/Result**：支持混合检索（BM25/向量/混合）、标签与时间过滤，供知识星图与 RAG 使用。【F:proto/agent_service.proto†L229-L257】
- **user_tool_history 表**：用户 + 工具复合键；记录成功/失败、耗时、错误、上下文快照、用户反馈，并建立 6 个优化索引用于快速统计与路由学习。【F:PHASE4_FINAL_SUMMARY.md†L65-L103】

## 4. 动态更新与差异说明 (Update Reconciliation)
- **上下文传递升级**：新增 Extra Context 字段与 Go → Python 合并流程，覆盖旧版“本地上下文”模式，确保 AI 回复实时反映任务/计划/专注状态，解决“建议泛化”问题。【F:IMPLEMENTATION_PROGRESS.md†L7-L35】
- **多智能体协作与行动卡强制产出**：由单步工具执行升级为意图驱动的协作工作流，确保复杂需求（考前冲刺、深度学习、错题诊断）得到结构化输出，替代原有单 Agent 流水线。【F:PHASE4_FINAL_SUMMARY.md†L14-L64】【F:PHASE4_FINAL_SUMMARY.md†L121-L135】
- **工具历史学习闭环**：引入 user_tool_history + ToolPreferenceRouter，对工具选择进行基于成功率/反馈的学习，解决旧版“无记忆路由”导致的重复失败与低效率。【F:PHASE4_FINAL_SUMMARY.md†L65-L103】
- **WebSocket 安全与稳定性修复**：令牌移出 URL、支持 Header 鉴权、抖动重连与 pending 队列上限，替换旧版“URL 透传 token + 无抖动”方案，满足审计与兼容需求。【F:WEBSOCKET_SECURITY_FIX_SUMMARY.md†L13-L120】

---

此白皮书面向 AI Agent 协作者，涵盖从产品愿景、用户旅程到核心技术与近期演进的单一事实来源，确保后续协同开发零歧义、可快速落地。
