# 贝叶斯画像技术手册 (Bayesian Learner Technical Manual)

## 1. 数学模型

Sparkle 的个性化引擎核心基于 **贝叶斯推断 (Bayesian Inference)**。我们利用 **Beta 分布** 来建模用户在不同认知路径（Route）上的成功概率。

### 1.1 Beta 分布基础
每个认知路径（如“从理解递归到掌握动态规划”）被赋予两个参数：
- $\alpha$: 成功信号的累积（先验为 1.0）。
- $\beta$: 失败/挫折信号的累积（先验为 1.0）。

概率密度函数为：
$$f(x; \alpha, \beta) = \frac{x^{\alpha-1}(1-x)^{\beta-1}}{B(\alpha, \beta)}$$

### 1.2 期望胜率 (Expectation)
系统通过计算均值来预估用户在当前路径的胜率：
$$P_{success} = \frac{\alpha}{\alpha + \beta}$$

---

## 2. 核心组件

### 2.1 BayesianLearner (`bayesian_learner.py`)
- **职责**: 基础内存演算模块。
- **功能**:
  - `update(source, target, success)`: 根据交互结果更新后验分布。
  - `sample(...)`: 采用 **汤普森采样 (Thompson Sampling)** 进行多臂老虎机（MAB）策略选择，平衡“探索”与“利用”。

### 2.2 PersistentBayesianLearner (`persistent_bayesian_learner.py`)
- **职责**: 实现画像的跨会话持久化。
- **存储方案**: 
  - 采用 **Redis** 作为一级缓存，利用 `setex` 设置 7 天有效期。
  - 支持 **PostgreSQL** 异步落盘，确保长期画像不丢失。
- **加载策略**: 采用 **Lazy Loading (懒加载)** 模式，仅在用户发起对话时从 Redis 恢复状态。

---

## 3. 画像维度 (Cognitive Dimensions)

引擎不仅记录知识点，还抽象出以下元认知维度：

| 维度 | 对应信号 | 影响效果 |
| :--- | :--- | :--- |
| **逻辑偏好** | 公式/代码块的点击率 | 调整 Prompt 中逻辑推导的比例 |
| **好奇心水平** | “为什么”类提问的频率 | 触发更多知识星图的自动拓展 |
| **记忆强度** | 错题本复习的成功率 | 动态调整 SM-2 算法的间隔系数 |
| **语言风格** | 对话语调反馈 | 调整 AI 响应的亲和力等级 |

---

## 4. 典型应用场景

### 4.1 动态路由 (Adaptive Routing)
当编排引擎面临多个可选的“教学流”时，会咨询贝叶斯学习器：
> “对于当前用户，‘类比教学流’和‘形式化证明流’哪个胜率更高？”

### 4.2 难度自适应
如果某个维度的 $\beta$ 值过高（连续失败），`AutoOptimizer` 会自动触发降级策略，降低后续任务的认知负荷。

---
*参考代码*: `backend/app/learning/`
