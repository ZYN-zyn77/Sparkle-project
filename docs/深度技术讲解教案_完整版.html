<!DOCTYPE html><html><head>
      <title>æ·±åº¦æŠ€æœ¯è®²è§£æ•™æ¡ˆ_å®Œæ•´ç‰ˆ</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/a/.vscode/extensions/shd101wyy.markdown-preview-enhanced-0.8.20/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="sparkle-ai-learning-assistant---æ·±åº¦æŠ€æœ¯è®²è§£æ•™æ¡ˆ">Sparkle AI Learning Assistant - æ·±åº¦æŠ€æœ¯è®²è§£æ•™æ¡ˆ </h1>
<blockquote>
<p><strong>æ–‡æ¡£ç‰ˆæœ¬</strong>: v3.0<br>
<strong>ç¼–å†™æ—¥æœŸ</strong>: 2025-12-27<br>
<strong>ç”Ÿäº§å°±ç»ªåº¦</strong>: 9.5/10<br>
<strong>é€‚ç”¨å¯¹è±¡</strong>: é«˜çº§åç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆã€æŠ€æœ¯è¯„å§”ã€AIç³»ç»Ÿå¼€å‘è€…<br>
<strong>æ–‡æ¡£è§„æ¨¡</strong>: 200+ çŸ¥è¯†ç‚¹ | 50,000+ å­— | 100+ ä»£ç ç¤ºä¾‹</p>
</blockquote>
<hr>
<h2 id="-ç›®å½•å¯¼èˆª">ğŸ“‹ ç›®å½•å¯¼èˆª </h2>
<h3 id="ç¬¬ä¸€éƒ¨åˆ†ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡æ€æƒ³">ç¬¬ä¸€éƒ¨åˆ†ï¼šç³»ç»Ÿæ¶æ„ä¸è®¾è®¡æ€æƒ³ </h3>
<ul>
<li><a href="#11-%E6%B7%B7%E5%90%88%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">1.1 æ··åˆæ¶æ„è®¾è®¡</a></li>
<li><a href="#12-%E6%A0%B8%E5%BF%83%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">1.2 æ ¸å¿ƒè®¾è®¡æ¨¡å¼</a></li>
</ul>
<h3 id="ç¬¬äºŒéƒ¨åˆ†go-gateway-é«˜æ€§èƒ½ç½‘å…³å±‚">ç¬¬äºŒéƒ¨åˆ†ï¼šGo Gateway é«˜æ€§èƒ½ç½‘å…³å±‚ </h3>
<ul>
<li><a href="#21-websocket-%E5%A4%84%E7%90%86%E5%99%A8">2.1 WebSocket å¤„ç†å™¨</a></li>
<li><a href="#22-%E8%AE%A4%E8%AF%81%E4%B8%8E%E9%99%90%E6%B5%81%E4%B8%AD%E9%97%B4%E4%BB%B6">2.2 è®¤è¯ä¸é™æµä¸­é—´ä»¶</a></li>
<li><a href="#23-%E7%94%9F%E4%BA%A7%E7%BA%A7%E7%89%B9%E6%80%A7">2.3 ç”Ÿäº§çº§ç‰¹æ€§</a></li>
</ul>
<h3 id="ç¬¬ä¸‰éƒ¨åˆ†python-agent-engine---ai-æ ¸å¿ƒå¼•æ“">ç¬¬ä¸‰éƒ¨åˆ†ï¼šPython Agent Engine - AI æ ¸å¿ƒå¼•æ“ </h3>
<ul>
<li><a href="#31-%E7%94%9F%E4%BA%A7%E7%BA%A7%E7%BC%96%E6%8E%92%E5%99%A8">3.1 ç”Ÿäº§çº§ç¼–æ’å™¨</a></li>
<li><a href="#32-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%AE%A1%E7%90%86">3.2 ä¸Šä¸‹æ–‡ç®¡ç†</a></li>
<li><a href="#33-%E5%8A%A8%E6%80%81%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F">3.3 åŠ¨æ€å·¥å…·ç³»ç»Ÿ</a></li>
<li><a href="#34-llm-%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90">3.4 LLM æœåŠ¡é›†æˆ</a></li>
<li><a href="#35-%E7%94%9F%E4%BA%A7%E7%BA%A7%E7%89%B9%E6%80%A7">3.5 ç”Ÿäº§çº§ç‰¹æ€§</a></li>
</ul>
<h3 id="ç¬¬å››éƒ¨åˆ†flutter-mobile---è·¨å¹³å°ç§»åŠ¨ç«¯">ç¬¬å››éƒ¨åˆ†ï¼šFlutter Mobile - è·¨å¹³å°ç§»åŠ¨ç«¯ </h3>
<ul>
<li><a href="#41-websocket-%E6%9C%8D%E5%8A%A1-v2">4.1 WebSocket æœåŠ¡ v2</a></li>
<li><a href="#42-riverpod-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86">4.2 Riverpod çŠ¶æ€ç®¡ç†</a></li>
<li><a href="#43-ui-%E7%BB%84%E4%BB%B6%E7%B3%BB%E7%BB%9F">4.3 UI ç»„ä»¶ç³»ç»Ÿ</a></li>
<li><a href="#44-%E7%9F%A5%E8%AF%86%E6%98%9F%E5%9B%BE%E5%8F%AF%E8%A7%86%E5%8C%96">4.4 çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–</a></li>
</ul>
<h3 id="ç¬¬äº”éƒ¨åˆ†æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ">ç¬¬äº”éƒ¨åˆ†ï¼šæ•°æ®åº“æ¶æ„æ·±åº¦è§£æ </h3>
<ul>
<li><a href="#51-%E6%A0%B8%E5%BF%83%E8%A1%A8%E7%BB%93%E6%9E%84">5.1 æ ¸å¿ƒè¡¨ç»“æ„</a></li>
<li><a href="#52-%E7%B4%A2%E5%BC%95%E7%AD%96%E7%95%A5">5.2 ç´¢å¼•ç­–ç•¥</a></li>
<li><a href="#53-%E5%88%86%E5%8C%BA%E7%AD%96%E7%95%A5">5.3 åˆ†åŒºç­–ç•¥</a></li>
<li><a href="#54-%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96">5.4 æŸ¥è¯¢ä¼˜åŒ–</a></li>
</ul>
<h3 id="ç¬¬å…­éƒ¨åˆ†æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£">ç¬¬å…­éƒ¨åˆ†ï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£ </h3>
<ul>
<li><a href="#61-%E7%9F%A5%E8%AF%86%E6%98%9F%E5%9B%BE-knowledge-galaxy">6.1 çŸ¥è¯†æ˜Ÿå›¾ (Knowledge Galaxy)</a></li>
<li><a href="#62-%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86">6.2 ä»»åŠ¡ç®¡ç†</a></li>
<li><a href="#63-%E6%99%BA%E8%83%BD%E6%8E%A8%E9%80%81%E7%B3%BB%E7%BB%9F">6.3 æ™ºèƒ½æ¨é€ç³»ç»Ÿ</a></li>
</ul>
<h3 id="ç¬¬ä¸ƒéƒ¨åˆ†ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º">ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º </h3>
<ul>
<li><a href="#71-%E7%86%94%E6%96%AD%E5%99%A8-circuit-breaker">7.1 ç†”æ–­å™¨ (Circuit Breaker)</a></li>
<li><a href="#72-%E5%B9%82%E7%AD%89%E6%80%A7%E4%B8%8E%E5%8E%BB%E9%87%8D">7.2 å¹‚ç­‰æ€§ä¸å»é‡</a></li>
<li><a href="#73-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">7.3 åˆ†å¸ƒå¼é”</a></li>
<li><a href="#74-%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7">7.4 ç›‘æ§ä¸å¯è§‚æµ‹æ€§</a></li>
<li><a href="#75-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E4%B8%8E%E9%99%8D%E7%BA%A7">7.5 é”™è¯¯å¤„ç†ä¸é™çº§</a></li>
</ul>
<h3 id="ç¬¬å…«éƒ¨åˆ†å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª">ç¬¬å…«éƒ¨åˆ†ï¼šå®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª </h3>
<ul>
<li><a href="#81-%E7%AB%AF%E5%88%B0%E7%AB%AF%E6%95%B0%E6%8D%AE%E6%B5%81">8.1 ç«¯åˆ°ç«¯æ•°æ®æµ</a></li>
<li><a href="#82-%E5%85%B3%E9%94%AE%E6%97%B6%E5%BA%8F">8.2 å…³é”®æ—¶åº</a></li>
<li><a href="#83-%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E9%93%BE">8.3 å¼‚æ­¥å¤„ç†é“¾</a></li>
</ul>
<h3 id="ç¬¬ä¹éƒ¨åˆ†æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ">ç¬¬ä¹éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ </h3>
<ul>
<li><a href="#91-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96">9.1 æ•°æ®åº“ä¼˜åŒ–</a></li>
<li><a href="#92-%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6">9.2 å¹¶å‘æ§åˆ¶</a></li>
<li><a href="#93-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5">9.3 ç¼“å­˜ç­–ç•¥</a></li>
<li><a href="#94-%E5%BC%82%E6%AD%A5%E4%BC%98%E5%8C%96">9.4 å¼‚æ­¥ä¼˜åŒ–</a></li>
<li><a href="#95-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87">9.5 æ€§èƒ½æŒ‡æ ‡</a></li>
</ul>
<h3 id="ç¬¬åéƒ¨åˆ†é¢è¯•å¸¸è§é—®é¢˜è§£ç­”">ç¬¬åéƒ¨åˆ†ï¼šé¢è¯•å¸¸è§é—®é¢˜è§£ç­” </h3>
<ul>
<li><a href="#101-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1">10.1 æ¶æ„è®¾è®¡</a></li>
<li><a href="#102-ai-%E7%BC%96%E6%8E%92">10.2 AI ç¼–æ’</a></li>
<li><a href="#103-%E7%94%9F%E4%BA%A7%E7%BA%A7%E7%89%B9%E6%80%A7">10.3 ç”Ÿäº§çº§ç‰¹æ€§</a></li>
<li><a href="#104-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">10.4 æ€§èƒ½ä¼˜åŒ–</a></li>
</ul>
<h3 id="ç¬¬åä¸€éƒ¨åˆ†æŠ€æœ¯æ ˆä¸å·¥å…·é“¾">ç¬¬åä¸€éƒ¨åˆ†ï¼šæŠ€æœ¯æ ˆä¸å·¥å…·é“¾ </h3>
<ul>
<li><a href="#111-%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF%E6%A0%88">11.1 åç«¯æŠ€æœ¯æ ˆ</a></li>
<li><a href="#112-%E5%89%8D%E7%AB%AF%E6%8A%80%E6%9C%AF%E6%A0%88">11.2 å‰ç«¯æŠ€æœ¯æ ˆ</a></li>
<li><a href="#113-devops-%E5%B7%A5%E5%85%B7">11.3 DevOps å·¥å…·</a></li>
</ul>
<h3 id="ç¬¬åäºŒéƒ¨åˆ†é¡¹ç›®é‡Œç¨‹ç¢‘ä¸æ¼”è¿›">ç¬¬åäºŒéƒ¨åˆ†ï¼šé¡¹ç›®é‡Œç¨‹ç¢‘ä¸æ¼”è¿› </h3>
<ul>
<li><a href="#121-%E9%98%B6%E6%AE%B5%E6%BC%94%E8%BF%9B">12.1 é˜¶æ®µæ¼”è¿›</a></li>
<li><a href="#122-%E6%A0%B8%E5%BF%83%E6%88%90%E5%B0%B1">12.2 æ ¸å¿ƒæˆå°±</a></li>
<li><a href="#123-%E7%94%9F%E4%BA%A7%E5%B0%B1%E7%BB%AA%E5%BA%A6">12.3 ç”Ÿäº§å°±ç»ªåº¦</a></li>
</ul>
<hr>
<h2 id="-å­¦ä¹ è·¯å¾„å»ºè®®">ğŸ“ å­¦ä¹ è·¯å¾„å»ºè®® </h2>
<h3 id="åˆçº§é˜¶æ®µ-1-2å‘¨">åˆçº§é˜¶æ®µ (1-2å‘¨) </h3>
<ol>
<li>é˜…è¯»æ¶æ„æ–‡æ¡£ï¼Œç†è§£ä¸‰å±‚æ¶æ„</li>
<li>æ­å»ºå¼€å‘ç¯å¢ƒï¼Œè¿è¡Œ demo</li>
<li>å­¦ä¹  WebSocket å’Œ gRPC åŸºç¡€</li>
</ol>
<h3 id="ä¸­çº§é˜¶æ®µ-2-4å‘¨">ä¸­çº§é˜¶æ®µ (2-4å‘¨) </h3>
<ol>
<li>å®ç° Go Gateway åŸºç¡€åŠŸèƒ½</li>
<li>ç†è§£ Python Agent ç¼–æ’é€»è¾‘</li>
<li>æŒæ¡ Riverpod çŠ¶æ€ç®¡ç†</li>
<li>å®ç°ç®€å•çš„ RAG æ£€ç´¢</li>
</ol>
<h3 id="é«˜çº§é˜¶æ®µ-4-8å‘¨">é«˜çº§é˜¶æ®µ (4-8å‘¨) </h3>
<ol>
<li>æ·±å…¥ç†è§£ç”Ÿäº§çº§ç‰¹æ€§ (ç†”æ–­ã€é™æµã€å¹‚ç­‰)</li>
<li>ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ (ç´¢å¼•ã€åˆ†åŒº)</li>
<li>å®ç°å¤æ‚ UI åŠ¨ç”» (GLSL ç€è‰²å™¨)</li>
<li>å®Œå–„ç›‘æ§å’Œè¿ç»´ä½“ç³»</li>
</ol>
<h3 id="ä¸“å®¶é˜¶æ®µ-8å‘¨">ä¸“å®¶é˜¶æ®µ (8å‘¨+) </h3>
<ol>
<li>è´¡çŒ®ä»£ç ï¼Œä¿®å¤ç”Ÿäº§é—®é¢˜</li>
<li>è®¾è®¡æ–°åŠŸèƒ½æ¨¡å—</li>
<li>ä¼˜åŒ–ç³»ç»Ÿæ¶æ„</li>
<li>æŠ€æœ¯åˆ†äº«å’Œæ–‡æ¡£å®Œå–„</li>
</ol>
<hr>
<h1 id="ä¸€-ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡æ€æƒ³">ä¸€ã€ç³»ç»Ÿæ¶æ„ä¸è®¾è®¡æ€æƒ³ </h1>
<h2 id="11-æ··åˆæ¶æ„è®¾è®¡">1.1 æ··åˆæ¶æ„è®¾è®¡ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle é‡‡ç”¨ <strong>Go + Python + Flutter ä¸‰å±‚æ··åˆæ¶æ„</strong>ï¼Œè¿™æ˜¯ä¸€ç§åŸºäº <strong>åº·å¨å®šå¾‹ (Conway's Law)</strong> çš„æ¶æ„è®¾è®¡ï¼Œå°†ç³»ç»ŸæŒ‰ç…§æŠ€æœ¯æ ˆçš„æœ€ä½³åº”ç”¨åœºæ™¯è¿›è¡Œå‚ç›´åˆ‡åˆ†ï¼š</p>
<ul>
<li><strong>Go Gateway</strong>: ä½œä¸ºé«˜æ€§èƒ½ç½‘å…³å±‚ï¼Œä¸“æ³¨äº <strong>C10K é—®é¢˜</strong> çš„è§£å†³ï¼Œåˆ©ç”¨ Goroutine çš„è½»é‡çº§å¹¶å‘æ¨¡å‹ï¼ˆæ¯ä¸ªåç¨‹ä»…éœ€ 2KB å†…å­˜ï¼‰å¤„ç†æµ·é‡ WebSocket é•¿è¿æ¥</li>
<li><strong>Python Agent</strong>: ä½œä¸º AI ä¸šåŠ¡å¼•æ“ï¼Œåˆ©ç”¨ Python åœ¨ <strong>LLM ç¼–æ’ã€å‘é‡è®¡ç®—ã€Prompt å·¥ç¨‹</strong> æ–¹é¢çš„ç”Ÿæ€ä¼˜åŠ¿</li>
<li><strong>Flutter Mobile</strong>: ä½œä¸ºç»Ÿä¸€å®¢æˆ·ç«¯ï¼Œé€šè¿‡ <strong>å£°æ˜å¼ UI</strong> å’Œ <strong>å“åº”å¼ç¼–ç¨‹</strong> æä¾›è·¨å¹³å°ä½“éªŒ</li>
</ul>
<p>ä¸‰å±‚é—´é€šè¿‡ <strong>gRPC (HTTP/2 + Protobuf)</strong> è¿›è¡Œé«˜æ•ˆäºŒè¿›åˆ¶é€šä¿¡ï¼Œå®ç°äº† <strong>åè®®é©±åŠ¨</strong> çš„æ¥å£è®¾è®¡ã€‚</p>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>æ¶æ„å®ç°ä»£ç ç¤ºä¾‹ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// backend/gateway/internal/handler/chat_orchestrator.go</span>
<span class="token keyword keyword-type">type</span> ChatHandler <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    grpcClient   pb<span class="token punctuation">.</span>AgentServiceClient  <span class="token comment">// gRPC å®¢æˆ·ç«¯</span>
    redisClient  <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client          <span class="token comment">// Redis å®¢æˆ·ç«¯</span>
    sessionMgr   <span class="token operator">*</span>SessionManager        <span class="token comment">// ä¼šè¯ç®¡ç†å™¨</span>
    quotaService <span class="token operator">*</span>QuotaService          <span class="token comment">// é…é¢æœåŠ¡</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ChatHandler<span class="token punctuation">)</span> <span class="token function">HandleWebSocket</span><span class="token punctuation">(</span>conn <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. ä¼šè¯éš”ç¦»ä¸èµ„æºç®¡ç†</span>
    sessionID <span class="token operator">:=</span> h<span class="token punctuation">.</span>sessionMgr<span class="token punctuation">.</span><span class="token function">CreateSession</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span>
    h<span class="token punctuation">.</span>sessionMgr<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>sessionID<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
    <span class="token keyword keyword-defer">defer</span> h<span class="token punctuation">.</span>sessionMgr<span class="token punctuation">.</span><span class="token function">Unregister</span><span class="token punctuation">(</span>sessionID<span class="token punctuation">)</span>  <span class="token comment">// RAII + Defer</span>
    
    <span class="token comment">// 2. å¼‚æ­¥å¿ƒè·³åç¨‹</span>
    <span class="token keyword keyword-go">go</span> h<span class="token punctuation">.</span><span class="token function">heartbeat</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> sessionID<span class="token punctuation">)</span>
    
    <span class="token comment">// 3. æ¶ˆæ¯å¾ªç¯ä¸è½¬å‘</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> msg ChatMessage
        <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">ReadJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-break">break</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 4. é…é¢æ£€æŸ¥</span>
        <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span>quotaService<span class="token punctuation">.</span><span class="token function">CheckQuota</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>QuotaExceededResponse<span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 5. gRPC è½¬å‘</span>
        response<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">forwardToPython</span><span class="token punctuation">(</span>userID<span class="token punctuation">,</span> sessionID<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>ErrorResponse<span class="token punctuation">{</span>Code<span class="token punctuation">:</span> <span class="token string">"GRPC_ERROR"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-continue">continue</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 6. æµå¼è¿”å›</span>
        <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chunk <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> response <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>ğŸ¯ Sparkle é¡¹ç›®å®æˆ˜åˆ†æï¼š</strong></p>
<p>åœ¨ <code>backend/gateway/internal/handler/chat_orchestrator.go</code> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å®Œæ•´çš„ Go Gateway å®ç°ï¼š</p>
<ol>
<li><strong>WebSocket å‡çº§ä¸è®¤è¯</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ChatOrchestrator<span class="token punctuation">)</span> <span class="token function">HandleWebSocket</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> upgrader<span class="token punctuation">.</span><span class="token function">Upgrade</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token comment">// ...</span>
    userID <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span> <span class="token comment">// ä» JWT ä¸­æå–</span>
    <span class="token keyword keyword-if">if</span> userID <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        userID <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span> <span class="token comment">// å¼€å‘ç¯å¢ƒé™çº§</span>
        <span class="token keyword keyword-if">if</span> userID <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            userID <span class="token operator">=</span> <span class="token string">"anonymous"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><ol start="2">
<li><strong>è¾“å…¥å®‰å…¨è¿‡æ»¤</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// Sanitize Input (Security Hygiene)</span>
p <span class="token operator">:=</span> bluemonday<span class="token punctuation">.</span><span class="token function">UGCPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
input<span class="token punctuation">.</span>Message <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">Sanitize</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>Message<span class="token punctuation">)</span>
</code></pre><ol start="3">
<li><strong>gRPC æµå¼è°ƒç”¨</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code>stream<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span>agentClient<span class="token punctuation">.</span><span class="token function">StreamChat</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> stream<span class="token punctuation">.</span><span class="token function">Recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
        <span class="token keyword keyword-break">break</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è½¬å‘åˆ° WebSocket</span>
    conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>jsonResp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><ol start="4">
<li><strong>å¼‚æ­¥æŒä¹…åŒ–ä¸é…é¢æ‰£å‡</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// Persist completed message to database (async)</span>
<span class="token keyword keyword-if">if</span> fullText <span class="token operator">!=</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> input<span class="token punctuation">.</span>SessionID <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-go">go</span> h<span class="token punctuation">.</span><span class="token function">saveMessage</span><span class="token punctuation">(</span>userID<span class="token punctuation">,</span> input<span class="token punctuation">.</span>SessionID<span class="token punctuation">,</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> fullText<span class="token punctuation">)</span>
    <span class="token keyword keyword-go">go</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span>quota<span class="token punctuation">.</span><span class="token function">DecrQuota</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Failed to decrement quota: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>æ¶æ„ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>é›¶æ‹·è´è½¬å‘</strong>: Go ç½‘å…³ä¸è§£æä¸šåŠ¡æ•°æ®ï¼Œåªåšåè®®è½¬æ¢ï¼Œæ€§èƒ½æœ€ä¼˜</li>
<li><strong>å¼‚æ­¥éé˜»å¡</strong>: å¿ƒè·³ã€æŒä¹…åŒ–ã€é…é¢æ‰£å‡å…¨éƒ¨å¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹</li>
<li><strong>å®‰å…¨é˜²æŠ¤</strong>: è¾“å…¥è¿‡æ»¤ã€é…é¢æ£€æŸ¥ã€è®¤è¯æ ¡éªŒï¼Œå±‚å±‚é˜²æŠ¤</li>
</ul>
<p><strong>æ•°æ®æµå‘å®Œæ•´å›¾è§£ï¼š</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Sparkle AI Learning Assistant                     â”‚
â”‚                  æ˜Ÿç« - AI å¤§å­¦ç”Ÿå­¦ä¹ è¾…åŠ©ç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    WebSocket    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    gRPC      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚ â”‚
â”‚  â”‚ Flutter App  â”‚    (8080)       â”‚ Go Gateway   â”‚  (50051)     â”‚ Python Agent â”‚ â”‚
â”‚  â”‚              â”‚                 â”‚              â”‚              â”‚   Engine     â”‚ â”‚
â”‚  â”‚  Riverpod    â”‚                 â”‚  Gin +       â”‚              â”‚              â”‚ â”‚
â”‚  â”‚  State Mgmt  â”‚                 â”‚  WebSocket   â”‚              â”‚  FastAPI     â”‚ â”‚
â”‚  â”‚  Hive/SQLite â”‚                 â”‚  + Auth      â”‚              â”‚  + Orchestrationâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â–²                                â”‚                              â”‚         â”‚
â”‚         â”‚                                â”‚                              â”‚         â”‚
â”‚         â”‚                                â–¼                              â–¼         â”‚
â”‚         â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚         â”‚                        â”‚   Redis      â”‚              â”‚ PostgreSQL   â”‚ â”‚
â”‚         â”‚                        â”‚  (Sessions,  â”‚              â”‚  + pgvector  â”‚ â”‚
â”‚         â”‚                        â”‚   Cache,     â”‚              â”‚              â”‚ â”‚
â”‚         â”‚                        â”‚   Queues)    â”‚              â”‚              â”‚ â”‚
â”‚         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                â–²                              â–²         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                    Internal Communication                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä¸ºä»€ä¹ˆé€‰æ‹©æ··åˆæ¶æ„ï¼Ÿ</strong></p>
<ul>
<li><strong>èŒè´£åˆ†ç¦»åŸåˆ™</strong>: Go æ“…é•¿ IO å¯†é›†å‹ä»»åŠ¡ï¼ˆC10K å¹¶å‘ï¼‰ï¼ŒPython æ“…é•¿ AI ç”Ÿæ€é›†æˆ</li>
<li><strong>æ€§èƒ½æƒè¡¡</strong>: Go çš„å¹¶å‘æ¨¡å‹æ¯” Python çš„å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ›´è½»é‡ï¼Œé€‚åˆç½‘å…³å±‚</li>
<li><strong>ç”Ÿæ€ä¼˜åŠ¿</strong>: Python æ‹¥æœ‰æœ€æˆç†Ÿçš„ LLM åº“ï¼ˆLangChain, LlamaIndex, pgvectorï¼‰</li>
<li><strong>æ‰©å±•æ€§</strong>: å„å±‚å¯ç‹¬ç«‹éƒ¨ç½²å’Œæ°´å¹³æ‰©å®¹ï¼Œç¬¦åˆäº‘åŸç”Ÿç†å¿µ</li>
</ul>
<p><strong>æ¶æ„æƒè¡¡ (Trade-offs):</strong></p>
<ul>
<li>âœ… <strong>ä¼˜åŠ¿</strong>: å„å–æ‰€é•¿ï¼Œæ€§èƒ½æœ€ä¼˜ï¼Œæ‰©å±•æ€§å¼º</li>
<li>âŒ <strong>åŠ£åŠ¿</strong>: è·¨è¯­è¨€è°ƒè¯•å¤æ‚ï¼Œéƒ¨ç½²è¿ç»´æˆæœ¬é«˜ï¼Œéœ€è¦ç»´æŠ¤ä¸¤å¥—ä»£ç åº“</li>
<li><strong>ç¼“è§£æ–¹æ¡ˆ</strong>: é€šè¿‡ Protobuf ç»Ÿä¸€æ¥å£å®šä¹‰ï¼Œå®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ</li>
</ul>
<p><strong>ä½“ç°çš„é«˜çº§ç¼–ç¨‹æ€æƒ³:</strong></p>
<ol>
<li><strong>åˆ†å±‚æ¶æ„ (Layered Architecture)</strong>: æ¸…æ™°çš„è¾¹ç•Œå’ŒèŒè´£åˆ’åˆ†</li>
<li><strong>åè®®é©±åŠ¨ (Protocol-Driven)</strong>: æ¥å£å®šä¹‰å…ˆè¡Œï¼Œä¿è¯å‘å‰å…¼å®¹</li>
<li><strong>æ— çŠ¶æ€è®¾è®¡ (Stateless Design)</strong>: æ”¯æŒæ°´å¹³æ‰©å±•å’Œæ•…éšœè½¬ç§»</li>
<li><strong>å¼‚æ­¥éé˜»å¡ (Async/Non-blocking)</strong>: å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº</li>
</ol>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q1: ä¸ºä»€ä¹ˆä¸åœ¨ Go ä¸­ç›´æ¥é›†æˆ AI é€»è¾‘ï¼Œè€Œè¦å¼•å…¥ Pythonï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æŠ€æœ¯æ ˆåŒ¹é…</strong>: Go çš„ AI ç”Ÿæ€ç›¸å¯¹è–„å¼±ï¼Œè€Œ Python æ‹¥æœ‰æœ€æˆç†Ÿçš„ LLM å·¥å…·é“¾</li>
<li><strong>æ€§èƒ½è€ƒé‡</strong>: Go å¤„ç†é«˜å¹¶å‘è¿æ¥ï¼ŒPython å¤„ç†å¤æ‚è®¡ç®—ï¼Œå„å¸å…¶èŒ</li>
<li><strong>ç»´æŠ¤æˆæœ¬</strong>: å¦‚æœç”¨ Go å®ç° AI é€»è¾‘ï¼Œéœ€è¦é‡å¤é€ è½®å­ï¼Œä¸”éš¾ä»¥è·Ÿä¸Š AI å‘å±•é€Ÿåº¦</li>
<li><strong>å›¢é˜ŸæŠ€èƒ½</strong>: AI å·¥ç¨‹å¸ˆæ›´ç†Ÿæ‚‰ Pythonï¼Œé™ä½å­¦ä¹ æˆæœ¬</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æ¶æ„æƒè¡¡é—®é¢˜ã€‚æˆ‘ä»¬é€‰æ‹© Go+Python æ··åˆæ¶æ„ï¼Œæ˜¯åŸºäº <strong>æŠ€æœ¯æ ˆåŒ¹é…</strong> å’Œ <strong>æ€§èƒ½åˆ†å·¥</strong> çš„è€ƒè™‘ã€‚Go åœ¨å¤„ç†é«˜å¹¶å‘ WebSocket è¿æ¥æ–¹é¢è¡¨ç°å‡ºè‰²ï¼Œæ¯ä¸ª Goroutine ä»…éœ€ 2KB å†…å­˜ï¼Œå¯ä»¥è½»æ¾æ”¯æ’‘æ•°ä¸‡å¹¶å‘ã€‚è€Œ Python åœ¨ AI é¢†åŸŸæ‹¥æœ‰æ— å¯æ¯”æ‹Ÿçš„ç”Ÿæ€ä¼˜åŠ¿ï¼Œä» LangChain åˆ° pgvectorï¼Œéƒ½æ˜¯ç»è¿‡ç”Ÿäº§éªŒè¯çš„å·¥å…·ã€‚é€šè¿‡ gRPC è¿›è¡Œé€šä¿¡ï¼Œå»¶è¿Ÿåœ¨ 1-2ms ä»¥å†…ï¼Œå¯¹æ•´ä½“æ€§èƒ½å½±å“æå°ã€‚è¿™ç§æ¶æ„è®©æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿè¿­ä»£ AI åŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒç½‘å…³å±‚çš„é«˜æ€§èƒ½ã€‚"</p>
</blockquote>
<p><strong>Q2: è¿™ç§æ¶æ„å¦‚ä½•ä¿è¯å¯æ‰©å±•æ€§ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ— çŠ¶æ€è®¾è®¡</strong>: é™¤ Redis å¤–ï¼Œæ‰€æœ‰æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€çš„</li>
<li><strong>æ°´å¹³æ‰©å®¹</strong>: å¯ä»¥é€šè¿‡ K8s è½»æ¾æ‰©å±• Go Gateway æˆ– Python Agent</li>
<li><strong>åè®®é©±åŠ¨</strong>: Protobuf ä¿è¯æ¥å£çš„å‘å‰å…¼å®¹æ€§</li>
<li><strong>åˆ†å±‚è§£è€¦</strong>: å„å±‚å¯ç‹¬ç«‹éƒ¨ç½²å’Œå‡çº§</li>
</ul>
<hr>
<h2 id="12-æ ¸å¿ƒè®¾è®¡æ¨¡å¼">1.2 æ ¸å¿ƒè®¾è®¡æ¨¡å¼ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-1">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle é¡¹ç›®ä¸­åº”ç”¨äº†å¤šç§ç»å…¸è®¾è®¡æ¨¡å¼ï¼Œæ¯ç§æ¨¡å¼éƒ½é’ˆå¯¹ç‰¹å®šçš„æ¶æ„æŒ‘æˆ˜ï¼š</p>
<ol>
<li><strong>ä¾èµ–æ³¨å…¥ (Dependency Injection)</strong>: é€šè¿‡ç»“æ„ä½“å­—æ®µä¼ å…¥å¤–éƒ¨ä¾èµ–ï¼Œå®ç°è§£è€¦å’Œæµ‹è¯•å‹å¥½</li>
<li><strong>äº‹ä»¶é©±åŠ¨ (Event-Driven)</strong>: WebSocket æ¶ˆæ¯å¾ªç¯å’Œæµå¼å“åº”çš„å¼‚æ­¥å¤„ç†</li>
<li><strong>ç®¡é“æ¨¡å¼ (Pipelining)</strong>: Go ç½‘å…³ä½œä¸ºæ•°æ®ç®¡é“ï¼Œå®ç°é›¶æ‹·è´è½¬å‘</li>
<li><strong>ç­–ç•¥æ¨¡å¼ (Strategy Pattern)</strong>: LLM æœåŠ¡æ”¯æŒå¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢</li>
<li><strong>è´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility)</strong>: Python Agent çš„ 11 æ­¥å®‰å…¨å¤„ç†é“¾</li>
<li><strong>æ³¨å†Œè¡¨æ¨¡å¼ (Registry Pattern)</strong>: åŠ¨æ€å·¥å…·ç³»ç»Ÿçš„è‡ªåŠ¨å‘ç°æœºåˆ¶</li>
</ol>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-1">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>ä¾èµ–æ³¨å…¥ç¤ºä¾‹ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// é€šè¿‡ç»“æ„ä½“å­—æ®µæ³¨å…¥ä¾èµ–</span>
<span class="token keyword keyword-type">type</span> ChatHandler <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    grpcClient   pb<span class="token punctuation">.</span>AgentServiceClient  <span class="token comment">// gRPC å®¢æˆ·ç«¯</span>
    redisClient  <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client          <span class="token comment">// Redis å®¢æˆ·ç«¯</span>
    sessionMgr   <span class="token operator">*</span>SessionManager        <span class="token comment">// ä¼šè¯ç®¡ç†å™¨</span>
    quotaService <span class="token operator">*</span>QuotaService          <span class="token comment">// é…é¢æœåŠ¡</span>
<span class="token punctuation">}</span>

<span class="token comment">// ä¾¿äºæµ‹è¯•å’Œç»´æŠ¤</span>
<span class="token keyword keyword-func">func</span> <span class="token function">NewChatHandler</span><span class="token punctuation">(</span>
    client pb<span class="token punctuation">.</span>AgentServiceClient<span class="token punctuation">,</span>
    redis <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client<span class="token punctuation">,</span>
    mgr <span class="token operator">*</span>SessionManager<span class="token punctuation">,</span>
    quota <span class="token operator">*</span>QuotaService<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">*</span>ChatHandler <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token operator">&amp;</span>ChatHandler<span class="token punctuation">{</span>
        grpcClient<span class="token punctuation">:</span>   client<span class="token punctuation">,</span>
        redisClient<span class="token punctuation">:</span>  redis<span class="token punctuation">,</span>
        sessionMgr<span class="token punctuation">:</span>   mgr<span class="token punctuation">,</span>
        quotaService<span class="token punctuation">:</span> quota<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>äº‹ä»¶é©±åŠ¨ä¸æµå¼å¤„ç†ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Python Agent ä¸­çš„å¼‚æ­¥æµå¼å¤„ç†</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncIterator<span class="token punctuation">[</span>StreamEvent<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token comment"># äº‹ä»¶é©±åŠ¨çš„å¤„ç†é“¾</span>
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>_call_llm_with_tools<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> chunk  <span class="token comment"># æµå¼äº§å‡º</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-1">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>è®¾è®¡æ¨¡å¼é€‰æ‹©çš„æ·±å±‚åŸå› :</strong></p>
<ol>
<li>
<p><strong>ä¾èµ–æ³¨å…¥</strong>:</p>
<ul>
<li><strong>ä¸ºä»€ä¹ˆ</strong>: è§£è€¦ç»„ä»¶ï¼Œä¾¿äºå•å…ƒæµ‹è¯•ï¼Œæ”¯æŒè¿è¡Œæ—¶æ›¿æ¢</li>
<li><strong>æƒè¡¡</strong>: å¢åŠ äº†ä»£ç å¤æ‚åº¦ï¼Œéœ€è¦é¢å¤–çš„åˆå§‹åŒ–ä»£ç </li>
<li><strong>Sparkle å®è·µ</strong>: æ‰€æœ‰æ ¸å¿ƒç»„ä»¶éƒ½é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥</li>
</ul>
</li>
<li>
<p><strong>ç®¡é“æ¨¡å¼</strong>:</p>
<ul>
<li><strong>ä¸ºä»€ä¹ˆ</strong>: Go ç½‘å…³ä¸éœ€è¦è§£æä¸šåŠ¡æ•°æ®ï¼Œåªéœ€é«˜æ•ˆè½¬å‘</li>
<li><strong>æƒè¡¡</strong>: é™ä½äº†ä¸šåŠ¡çµæ´»æ€§ï¼Œä½†è·å¾—äº†æè‡´æ€§èƒ½</li>
<li><strong>Sparkle å®è·µ</strong>: æ•°æ®ä» gRPC è¿›æ¥ï¼Œç›´æ¥æ³µå…¥ WebSocket</li>
</ul>
</li>
<li>
<p><strong>è´£ä»»é“¾æ¨¡å¼</strong>:</p>
<ul>
<li><strong>ä¸ºä»€ä¹ˆ</strong>: 11 æ­¥å¤„ç†é€»è¾‘æ¸…æ™°å¯ç»´æŠ¤ï¼Œæ¯æ­¥å¯ç‹¬ç«‹æµ‹è¯•</li>
<li><strong>æƒè¡¡</strong>: å¯èƒ½äº§ç”Ÿä¸­é—´çŠ¶æ€ï¼Œéœ€è¦å®Œå–„çš„é”™è¯¯å¤„ç†</li>
<li><strong>Sparkle å®è·µ</strong>: æ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¡®çš„è¾“å…¥è¾“å‡ºå’Œé”™è¯¯è¾¹ç•Œ</li>
</ul>
</li>
</ol>
<p><strong>é«˜çº§ç¼–ç¨‹æ€æƒ³ä½“ç°:</strong></p>
<ul>
<li><strong>å¼€é—­åŸåˆ™</strong>: åŠ¨æ€å·¥å…·ç³»ç»Ÿæ”¯æŒçƒ­æ’æ‹”</li>
<li><strong>å•ä¸€èŒè´£</strong>: æ¯ä¸ªç»„ä»¶åªåšä¸€ä»¶äº‹</li>
<li><strong>ä¾èµ–å€’ç½®</strong>: é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ç»†èŠ‚</li>
<li><strong>æ¥å£éš”ç¦»</strong>: gRPC å®šä¹‰æ¸…æ™°çš„æ¥å£è¾¹ç•Œ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-1">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: è¯·ä¸¾ä¾‹è¯´æ˜ä½ åœ¨ Sparkle ä¸­å¦‚ä½•åº”ç”¨è®¾è®¡æ¨¡å¼è§£å†³å®é™…é—®é¢˜ï¼Ÿ</strong></p>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"åœ¨ Sparkle çš„ Python Agent ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <strong>è´£ä»»é“¾æ¨¡å¼</strong> è§£å†³äº† AI ç¼–æ’çš„å¤æ‚æ€§é—®é¢˜ã€‚ä¼ ç»Ÿçš„ AI æœåŠ¡å¾€å¾€å°†æ‰€æœ‰é€»è¾‘å†™åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå¯¼è‡´ä»£ç éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•ã€‚æˆ‘ä»¬å°†å¤„ç†æµç¨‹æ‹†åˆ†ä¸º 11 ä¸ªç‹¬ç«‹æ­¥éª¤ï¼šæ¶ˆæ¯å»é‡ã€ç†”æ–­æ£€æŸ¥ã€å¹¶å‘æ§åˆ¶ã€è¯·æ±‚éªŒè¯ã€å¹‚ç­‰æ€§æ£€æŸ¥ã€åˆ†å¸ƒå¼é”ã€ä¸Šä¸‹æ–‡æ„å»ºã€çŸ¥è¯†æ£€ç´¢ã€LLM è°ƒç”¨ã€æŒ‡æ ‡è®°å½•ã€èµ„æºæ¸…ç†ã€‚æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ç‹¬ç«‹çš„ç±»ï¼Œå®ç°äº†ç»Ÿä¸€çš„æ¥å£ã€‚è¿™ç§è®¾è®¡å¸¦æ¥äº†ä¸‰ä¸ªå¥½å¤„ï¼šç¬¬ä¸€ï¼Œæ¯ä¸ªæ­¥éª¤å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼›ç¬¬äºŒï¼Œå¯ä»¥åŠ¨æ€è·³è¿‡æŸäº›æ­¥éª¤ï¼ˆå¦‚ç¼“å­˜å‘½ä¸­æ—¶ï¼‰ï¼›ç¬¬ä¸‰ï¼Œé”™è¯¯éš”ç¦»ï¼ŒæŸä¸€æ­¥å¤±è´¥ä¸ä¼šå½±å“å…¶ä»–æ­¥éª¤ã€‚"</p>
</blockquote>
<hr>
<h1 id="äºŒ-go-gateway-é«˜æ€§èƒ½ç½‘å…³å±‚">äºŒã€Go Gateway é«˜æ€§èƒ½ç½‘å…³å±‚ </h1>
<h2 id="21-websocket-å¤„ç†å™¨">2.1 WebSocket å¤„ç†å™¨ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-2">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>WebSocket å¤„ç†å™¨æ˜¯ Go Gateway çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸã€æ¶ˆæ¯è§£æå’Œåè®®è½¬æ¢ã€‚å®ƒåˆ©ç”¨ Go çš„ <strong>Goroutine å¹¶å‘æ¨¡å‹</strong> å’Œ <strong>Channel é€šä¿¡æœºåˆ¶</strong> å®ç°é«˜å¹¶å‘å¤„ç†ï¼š</p>
<ul>
<li><strong>è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>: RAII + Defer ç¡®ä¿èµ„æºé‡Šæ”¾</li>
<li><strong>ä¼šè¯éš”ç¦»</strong>: æ¯ä¸ªç”¨æˆ·è¿æ¥ç‹¬ç«‹çš„ä¼šè¯ ID</li>
<li><strong>æ¶ˆæ¯å¾ªç¯</strong>: äº‹ä»¶é©±åŠ¨çš„ JSON è§£æå’Œè½¬å‘</li>
<li><strong>å¿ƒè·³æœºåˆ¶</strong>: Ping/Pong æ§åˆ¶å¸§æ£€æµ‹è¿æ¥å¥åº·</li>
<li><strong>æµå¼è½¬å‘</strong>: gRPC æµå¼æ•°æ®å®æ—¶æ¨é€è‡³ WebSocket</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-2">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>å®Œæ•´æ•°æ®æµå‘ï¼š</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Flutter (JSON) â†’ Go (ReadJSON) â†’ Quota Check (Redis) â†’ Go (gRPC Call) â†’ Python Agent
                â†“
Flutter (UI) â† Go (WriteJSON) â† Stream Read â† Python (Stream Response)
</code></pre><p><strong>æ ¸å¿ƒå®ç°ä»£ç ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// backend/gateway/internal/handler/chat_orchestrator.go</span>

<span class="token keyword keyword-type">type</span> ChatHandler <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    grpcClient   pb<span class="token punctuation">.</span>AgentServiceClient
    redisClient  <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client
    sessionMgr   <span class="token operator">*</span>SessionManager
    quotaService <span class="token operator">*</span>QuotaService
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ChatHandler<span class="token punctuation">)</span> <span class="token function">HandleWebSocket</span><span class="token punctuation">(</span>conn <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ========== ç¬¬1æ­¥: è¿æ¥å»ºç«‹ä¸ä¼šè¯åˆå§‹åŒ– ==========</span>
    <span class="token comment">// ç¼–ç¨‹æ€æƒ³ï¼šä¼šè¯éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·è¿æ¥éƒ½æœ‰ç‹¬ç«‹çš„ä¼šè¯ID</span>
    sessionID <span class="token operator">:=</span> h<span class="token punctuation">.</span>sessionMgr<span class="token punctuation">.</span><span class="token function">CreateSession</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span>

    <span class="token comment">// ========== ç¬¬2æ­¥: æ³¨å†Œè¿æ¥ä¸èµ„æºæ¸…ç† ==========</span>
    <span class="token comment">// ç¼–ç¨‹æ€æƒ³ï¼šRAII (èµ„æºè·å–å³åˆå§‹åŒ–) + Deferï¼Œç¡®ä¿è¿æ¥æ–­å¼€æ—¶èµ„æºé‡Šæ”¾</span>
    h<span class="token punctuation">.</span>sessionMgr<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>sessionID<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
    <span class="token keyword keyword-defer">defer</span> h<span class="token punctuation">.</span>sessionMgr<span class="token punctuation">.</span><span class="token function">Unregister</span><span class="token punctuation">(</span>sessionID<span class="token punctuation">)</span>

    <span class="token comment">// ========== ç¬¬3æ­¥: å¯åŠ¨å¼‚æ­¥å¿ƒè·³åç¨‹ ==========</span>
    <span class="token comment">// ç¼–ç¨‹æ€æƒ³ï¼šGoroutine å¹¶å‘ï¼Œç»´æŒé•¿è¿æ¥æ´»æ€§ï¼Œä¸é˜»å¡ä¸»æ¶ˆæ¯å¾ªç¯</span>
    <span class="token keyword keyword-go">go</span> h<span class="token punctuation">.</span><span class="token function">heartbeat</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> sessionID<span class="token punctuation">)</span>

    <span class="token comment">// ========== ç¬¬4æ­¥: ç›‘å¬ç”¨æˆ·æ¶ˆæ¯å¾ªç¯ ==========</span>
    <span class="token comment">// ç¼–ç¨‹æ€æƒ³ï¼šäº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œä¸æ–­è¯»å–è§£æå®¢æˆ·ç«¯å‘é€çš„ JSON æ¶ˆæ¯</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> msg ChatMessage
        <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">ReadJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            h<span class="token punctuation">.</span><span class="token function">handleError</span><span class="token punctuation">(</span>sessionID<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span> <span class="token comment">// è¯»å–å¤±è´¥ï¼ˆå¦‚å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€ï¼‰åˆ™é€€å‡ºå¾ªç¯</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ========== ç¬¬5æ­¥: åˆ†å¸ƒå¼é…é¢ä¸é™æµæ£€æŸ¥ ==========</span>
        <span class="token comment">// ç¼–ç¨‹æ€æƒ³ï¼šé˜²å¾¡æ€§ç¼–ç¨‹ã€‚è°ƒç”¨ Redis æœåŠ¡æ£€æŸ¥ç”¨æˆ·å‰©ä½™é…é¢ï¼Œé˜²æ­¢ API æ»¥ç”¨</span>
        <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span>quotaService<span class="token punctuation">.</span><span class="token function">CheckQuota</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>QuotaExceededResponse<span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ========== ç¬¬6æ­¥: è½¬å‘è¯·æ±‚è‡³ Python gRPC æœåŠ¡ ==========</span>
        <span class="token comment">// ç¼–ç¨‹æ€æƒ³ï¼šç½‘å…³è½¬å‘æ¨¡å¼ã€‚Go ä½œä¸ºé«˜æ€§èƒ½ç½‘å…³ï¼Œä¸å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£é«˜æ•ˆè½¬å‘</span>
        response<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span><span class="token function">forwardToPython</span><span class="token punctuation">(</span>userID<span class="token punctuation">,</span> sessionID<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>ErrorResponse<span class="token punctuation">{</span>Code<span class="token punctuation">:</span> <span class="token string">"GRPC_ERROR"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-continue">continue</span> <span class="token comment">// å•æ¬¡è¯·æ±‚å¤±è´¥ä¸åº”å¯¼è‡´é•¿è¿æ¥æ–­å¼€</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ========== ç¬¬7æ­¥: å¤„ç†æµå¼è¿”å›å¹¶æ¨é€è‡³ç§»åŠ¨ç«¯ ==========</span>
        <span class="token comment">// ç¼–ç¨‹æ€æƒ³ï¼šæµå¼å¤„ç† (Stream)ã€‚æ¥æ”¶ gRPC æµå¹¶å°†æ¯ä¸ªæ•°æ®å—å®æ—¶æ¨é€è‡³ WebSocket</span>
        <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chunk <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> response <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-break">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// å¿ƒè·³æœºåˆ¶å®ç°</span>
<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ChatHandler<span class="token punctuation">)</span> <span class="token function">heartbeat</span><span class="token punctuation">(</span>conn <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> sessionID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword keyword-defer">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-select">select</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-case">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
            <span class="token comment">// å‘é€ Ping æ§åˆ¶å¸§</span>
            <span class="token keyword keyword-if">if</span> err <span class="token operator">:=</span> conn<span class="token punctuation">.</span><span class="token function">WriteControl</span><span class="token punctuation">(</span>websocket<span class="token punctuation">.</span>PingMessage<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ›´æ–° Redis ä¼šè¯æ´»è·ƒæ—¶é—´</span>
            h<span class="token punctuation">.</span>redisClient<span class="token punctuation">.</span><span class="token function">Expire</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"session:%s:active"</span><span class="token punctuation">,</span> sessionID<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">60</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-2">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</strong></p>
<ol>
<li>
<p><strong>RAII + Defer èµ„æºç®¡ç†</strong>:</p>
<ul>
<li><strong>åŸç†</strong>: ä¿è¯èµ„æºè·å–å’Œé‡Šæ”¾æˆå¯¹å‡ºç°ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</li>
<li><strong>Sparkle å®è·µ</strong>: ä¼šè¯æ³¨å†Œ/æ³¨é”€ã€Redis è¿æ¥ã€æ–‡ä»¶å¥æŸ„éƒ½ä½¿ç”¨ defer</li>
<li><strong>æƒè¡¡</strong>: ä»£ç å¯è¯»æ€§ç•¥æœ‰ä¸‹é™ï¼Œä½†å¯é æ€§å¤§å¹…æå‡</li>
</ul>
</li>
<li>
<p><strong>Goroutine å¹¶å‘æ¨¡å‹</strong>:</p>
<ul>
<li><strong>åŸç†</strong>: æ¯ä¸ªè¿æ¥ç‹¬ç«‹åç¨‹ï¼Œå¼€é”€ä»… 2KBï¼Œæ”¯æŒ C10K é—®é¢˜</li>
<li><strong>Sparkle å®è·µ</strong>: å¿ƒè·³ã€æ¶ˆæ¯å¾ªç¯ã€è½¬å‘éƒ½åœ¨ç‹¬ç«‹åç¨‹</li>
<li><strong>ä¼˜åŠ¿</strong>: æ¯” Python çš„å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ›´è½»é‡ï¼Œæ—  GIL é™åˆ¶</li>
</ul>
</li>
<li>
<p><strong>äº‹ä»¶é©±åŠ¨æ¨¡å¼</strong>:</p>
<ul>
<li><strong>åŸç†</strong>: Reactor æ¨¡å¼ï¼Œéé˜»å¡ I/O å¤šè·¯å¤ç”¨</li>
<li><strong>Sparkle å®è·µ</strong>: WebSocket æ¶ˆæ¯å¾ªç¯ä¸æ–­è¯»å–è§£æ JSON</li>
<li><strong>ä¼˜åŠ¿</strong>: å•çº¿ç¨‹å¯å¤„ç†æ•°åƒå¹¶å‘è¿æ¥</li>
</ul>
</li>
<li>
<p><strong>ç®¡é“æ¨¡å¼ (Pipelining)</strong>:</p>
<ul>
<li><strong>åŸç†</strong>: æ•°æ®ä» gRPC è¿›æ¥ï¼Œç›´æ¥æ³µå…¥ WebSocketï¼Œé›¶æ‹·è´</li>
<li><strong>Sparkle å®è·µ</strong>: ç½‘å…³ä¸è§£æä¸šåŠ¡æ•°æ®ï¼Œåªåšåè®®è½¬æ¢</li>
<li><strong>ä¼˜åŠ¿</strong>: æä½å†…å­˜å ç”¨ï¼Œæé«˜è½¬å‘æ€§èƒ½</li>
</ul>
</li>
</ol>
<p><strong>é˜²å¾¡æ€§ç¼–ç¨‹ä½“ç°:</strong></p>
<ul>
<li>æ¯æ¬¡ç½‘ç»œæ“ä½œéƒ½æœ‰è¶…æ—¶æ§åˆ¶</li>
<li>å•æ¬¡è¯·æ±‚å¤±è´¥ä¸å½±å“é•¿è¿æ¥</li>
<li>é…é¢æ£€æŸ¥åœ¨è½¬å‘å‰è¿›è¡Œ</li>
<li>å¿ƒè·³å¤±è´¥è‡ªåŠ¨æ–­å¼€è¿æ¥</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-2">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: Go Gateway å¦‚ä½•å¤„ç† 10 ä¸‡çº§å¹¶å‘è¿æ¥ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>Goroutine è½»é‡</strong>: æ¯ä¸ªè¿æ¥ä»…éœ€ 2KB å†…å­˜</li>
<li><strong>I/O å¤šè·¯å¤ç”¨</strong>: ä½¿ç”¨ epoll/kqueueï¼Œå•çº¿ç¨‹å¤„ç†æ•°åƒè¿æ¥</li>
<li><strong>é›¶æ‹·è´è½¬å‘</strong>: ç®¡é“æ¨¡å¼ï¼Œä¸è§£æä¸šåŠ¡æ•°æ®</li>
<li><strong>èµ„æºéš”ç¦»</strong>: æ¯ä¸ªè¿æ¥ç‹¬ç«‹åç¨‹ï¼Œäº’ä¸å½±å“</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"Go çš„ Goroutine æ¨¡å‹æ˜¯å¤„ç†é«˜å¹¶å‘çš„å…³é”®ã€‚æ¯ä¸ª Goroutine å¼€é”€ä»… 2KBï¼Œ10 ä¸‡è¿æ¥åªéœ€ 200MB å†…å­˜ã€‚æˆ‘ä»¬ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ï¼ˆepollï¼‰åœ¨å•çº¿ç¨‹ä¸­å¤„ç†æ•°åƒè¿æ¥ï¼Œé…åˆç®¡é“æ¨¡å¼å®ç°é›¶æ‹·è´è½¬å‘ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ¯ä¸ªè¿æ¥çš„å¤„ç†é€»è¾‘éƒ½åœ¨ç‹¬ç«‹åç¨‹ä¸­ï¼Œäº’ä¸é˜»å¡ã€‚é…åˆ Redis çš„åˆ†å¸ƒå¼é™æµå’Œé…é¢æ§åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¨³å®šæ”¯æ’‘ 10 ä¸‡+ å¹¶å‘è¿æ¥ã€‚"</p>
</blockquote>
<p><strong>Q: å¿ƒè·³æœºåˆ¶ä¸ºä»€ä¹ˆè¦ç”¨ Redis ç§Ÿçº¦ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>åˆ†å¸ƒå¼ç¯å¢ƒ</strong>: å¤šä¸ª Gateway å®ä¾‹éœ€è¦å…±äº«ä¼šè¯çŠ¶æ€</li>
<li><strong>è‡ªåŠ¨è¿‡æœŸ</strong>: Redis TTL è‡ªåŠ¨æ¸…ç†åƒµå°¸è¿æ¥</li>
<li><strong>çŠ¶æ€ä¸€è‡´æ€§</strong>: é€šçŸ¥ Python Agent ä¼šè¯ä»ç„¶æ´»è·ƒ</li>
<li><strong>é˜² NAT æ–­è¿</strong>: åº”ç”¨å±‚ä¿æ´»ï¼Œé˜²æ­¢è¿è¥å•†æ–­å¼€</li>
</ul>
<hr>
<h2 id="22-è®¤è¯ä¸é™æµä¸­é—´ä»¶">2.2 è®¤è¯ä¸é™æµä¸­é—´ä»¶ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-3">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>è®¤è¯ä¸é™æµæ˜¯ç½‘å…³å±‚çš„ <strong>å®‰å…¨è¾¹ç•Œ</strong>ï¼Œé‡‡ç”¨ <strong>ä¸­é—´ä»¶æ¨¡å¼</strong> å®ç°æ¨ªåˆ‡é¢é€»è¾‘ï¼š</p>
<ul>
<li><strong>JWT è®¤è¯</strong>: æ— çŠ¶æ€è®¤è¯ï¼ŒæœåŠ¡å™¨æ— éœ€æŸ¥åº“</li>
<li><strong>åˆ†å¸ƒå¼é™æµ</strong>: Redis Lua è„šæœ¬å®ç°åŸå­æ“ä½œ</li>
<li><strong>åå‘ä»£ç†</strong>: Director åˆ‡é¢æ³¨å…¥ç”¨æˆ·èº«ä»½</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: ä¸‹æ¸¸ä¸å¯ç”¨æ—¶è¿”å›å‹å¥½é”™è¯¯</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-3">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>JWT è®¤è¯ä¸­é—´ä»¶ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// backend/gateway/internal/middleware/auth.go</span>

<span class="token keyword keyword-func">func</span> <span class="token function">AuthMiddleware</span><span class="token punctuation">(</span>jwtSecret <span class="token builtin">string</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. æå– Header ä¸­çš„ Authorization Token</span>
        authHeader <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">GetHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> authHeader <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Missing token"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. æ ¡éªŒ Token åˆæ³•æ€§ä¸è¿‡æœŸæ—¶é—´</span>
        <span class="token comment">// æ€æƒ³ï¼šæ— çŠ¶æ€è®¤è¯ã€‚æœåŠ¡å™¨ä¸éœ€è¦æŸ¥åº“å³å¯éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œæé«˜æ‰©å±•æ€§ã€‚</span>
        tokenString <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimPrefix</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">,</span> <span class="token string">"Bearer "</span><span class="token punctuation">)</span>
        claims<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>tokenString<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Claims<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword keyword-interface">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>jwtSecret<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> <span class="token operator">!</span>claims<span class="token punctuation">.</span>Valid <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid token"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥ä¸Šä¸‹æ–‡ (Context)ï¼Œä¾›åç»­é€»è¾‘ä½¿ç”¨</span>
        c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"userID"</span><span class="token punctuation">,</span> claims<span class="token punctuation">.</span>UserID<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>åˆ†å¸ƒå¼é™æµä¸­é—´ä»¶ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// backend/gateway/internal/middleware/rate_limit.go</span>

<span class="token keyword keyword-func">func</span> <span class="token function">RateLimitMiddleware</span><span class="token punctuation">(</span>redisClient <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        userID <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"userID"</span><span class="token punctuation">)</span>
        key <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"rate_limit:%s"</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span>

        <span class="token comment">// ä½¿ç”¨ Redis Lua è„šæœ¬å®ç°åŸå­é™æµ</span>
        script <span class="token operator">:=</span> <span class="token string">`
        local current = redis.call('GET', KEYS[1])
        if current and tonumber(current) &gt;= tonumber(ARGV[1]) then
            return 0  -- è¶…è¿‡é™é¢
        else
            redis.call('INCR', KEYS[1])
            redis.call('EXPIRE', KEYS[1], ARGV[2]) -- è®¾ç½®çª—å£æœŸï¼ˆå¦‚60ç§’ï¼‰
            return 1  -- å…è®¸é€šè¡Œ
        end
        `</span>

        allowed<span class="token punctuation">,</span> err <span class="token operator">:=</span> redisClient<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> script<span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>key<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"100"</span><span class="token punctuation">,</span> <span class="token string">"60"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> allowed<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span><span class="token function">AbortWithStatusJSON</span><span class="token punctuation">(</span><span class="token number">429</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Rate limit exceeded"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span>
        <span class="token punctuation">}</span>

        c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>åå‘ä»£ç†è®¾è®¡ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// backend/gateway/internal/proxy/reverse_proxy.go</span>

<span class="token keyword keyword-func">func</span> <span class="token function">NewReverseProxy</span><span class="token punctuation">(</span>target <span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">)</span> <span class="token operator">*</span>httputil<span class="token punctuation">.</span>ReverseProxy <span class="token punctuation">{</span>
    proxy <span class="token operator">:=</span> httputil<span class="token punctuation">.</span><span class="token function">NewSingleHostReverseProxy</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>

    <span class="token comment">// è‡ªå®šä¹‰ Directorï¼ˆè¯·æ±‚è½¬æ¢å™¨ï¼‰</span>
    <span class="token comment">// æ€æƒ³ï¼šé€æ˜ä»£ç†ã€‚ç½‘å…³åœ¨è½¬å‘æ—¶ï¼Œè‡ªåŠ¨æ³¨å…¥ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œè®©ä¸‹æ¸¸æœåŠ¡æ— éœ€é‡å¤è®¤è¯ã€‚</span>
    proxy<span class="token punctuation">.</span>Director <span class="token operator">=</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Scheme <span class="token operator">=</span> target<span class="token punctuation">.</span>Scheme
        req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Host <span class="token operator">=</span> target<span class="token punctuation">.</span>Host
        req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">=</span> target<span class="token punctuation">.</span>Path <span class="token operator">+</span> req<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path

        <span class="token comment">// å°†è®¤è¯åçš„ UserID æ³¨å…¥ Headerï¼Œä¼ é€’ç»™ä¸‹æ¸¸ Python æœåŠ¡</span>
        <span class="token keyword keyword-if">if</span> userID<span class="token punctuation">,</span> ok <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span><span class="token string">"userID"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
            req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"X-User-ID"</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç»Ÿä¸€é”™è¯¯å¤„ç†</span>
    proxy<span class="token punctuation">.</span>ErrorHandler <span class="token operator">=</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Proxy error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusBadGateway<span class="token punctuation">)</span>
        w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"Backend service unavailable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-return">return</span> proxy
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-3">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>JWT vs Session é€‰å‹å¯¹æ¯”ï¼š</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>JWT (æœ¬ç³»ç»Ÿé‡‡ç”¨)</th>
<th>Session</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>çŠ¶æ€</strong></td>
<td>æ— çŠ¶æ€ï¼ŒæœåŠ¡ç«¯ä¸å­˜ Token</td>
<td>æœ‰çŠ¶æ€ï¼Œéœ€å­˜ Redis/DB</td>
</tr>
<tr>
<td><strong>æ‰©å±•æ€§</strong></td>
<td>æä½³ï¼Œé€‚åˆæ°´å¹³æ‰©å®¹</td>
<td>éœ€å…±äº«å­˜å‚¨ï¼Œæœ‰ IO ç“¶é¢ˆ</td>
</tr>
<tr>
<td><strong>çµæ´»æ€§</strong></td>
<td>Token ä¸€æ—¦å‘æ”¾éš¾ä»¥ä¸»åŠ¨å¤±æ•ˆ</td>
<td>éšæ—¶å¯ä»¥ä»åç«¯åˆ é™¤</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>æ— éœ€æŸ¥åº“ï¼ŒéªŒè¯é€Ÿåº¦å¿«</td>
<td>éœ€è¦æŸ¥åº“æˆ–æŸ¥ Redis</td>
</tr>
</tbody>
</table>
<p><strong>Sparkle é€‰æ‹© JWT çš„åŸå› :</strong></p>
<ol>
<li><strong>æ— çŠ¶æ€</strong>: ç½‘å…³å±‚ä¸éœ€è¦å­˜å‚¨ä¼šè¯çŠ¶æ€ï¼Œæ”¯æŒæ°´å¹³æ‰©å®¹</li>
<li><strong>æ€§èƒ½</strong>: éªŒè¯ Token åªéœ€æœ¬åœ°è®¡ç®—ï¼Œæ— ç½‘ç»œ IO</li>
<li><strong>è·¨æœåŠ¡</strong>: Token å¯ä»¥åœ¨ Go Gateway å’Œ Python Agent é—´å…±äº«</li>
<li><strong>å®‰å…¨æ€§</strong>: ä½¿ç”¨ RSA ç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹</li>
</ol>
<p><strong>é™æµç®—æ³•æ·±åº¦å¯¹æ¯”ï¼š</strong></p>
<ol>
<li>
<p><strong>å›ºå®šçª—å£ (æœ¬ç³»ç»Ÿé‡‡ç”¨)</strong>:</p>
<ul>
<li>å®ç°ç®€å•ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯</li>
<li>ç¼ºç‚¹ï¼šä¸´ç•Œé—®é¢˜ï¼ˆçª—å£è¾¹ç•ŒåŒå€æµé‡ï¼‰</li>
<li>Sparkle å®è·µï¼šé…åˆ Redis Lua è„šæœ¬ä¿è¯åŸå­æ€§</li>
</ul>
</li>
<li>
<p><strong>ä»¤ç‰Œæ¡¶</strong>:</p>
<ul>
<li>å…è®¸çªå‘æµé‡ï¼Œæ›´å¹³æ»‘</li>
<li>é€‚åˆ API ç½‘å…³ï¼Œä½†å®ç°å¤æ‚</li>
</ul>
</li>
<li>
<p><strong>æ¼æ¡¶</strong>:</p>
<ul>
<li>å¼ºåˆ¶æ’å®šé€Ÿç‡ï¼Œé€‚åˆå¯¹åç«¯ä¸¥æ ¼ä¿æŠ¤</li>
<li>ä¸é€‚åˆéœ€è¦å¤„ç†çªå‘æµé‡çš„åœºæ™¯</li>
</ul>
</li>
</ol>
<p><strong>ä¸­é—´ä»¶æ¨¡å¼çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>å…³æ³¨ç‚¹åˆ†ç¦»</strong>: è®¤è¯ã€é™æµé€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦</li>
<li><strong>å¯å¤ç”¨</strong>: åŒä¸€ä¸­é—´ä»¶å¯åº”ç”¨äºå¤šä¸ªè·¯ç”±</li>
<li><strong>å¯æµ‹è¯•</strong>: ä¸­é—´ä»¶å¯ç‹¬ç«‹å•å…ƒæµ‹è¯•</li>
<li><strong>å¯ç»„åˆ</strong>: å¤šä¸ªä¸­é—´ä»¶å¯æŒ‰éœ€ç»„åˆ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-3">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ä¸ºä»€ä¹ˆä½¿ç”¨ Redis Lua è„šæœ¬å®ç°é™æµï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>åŸå­æ€§</strong>: Lua è„šæœ¬åœ¨ Redis å†…éƒ¨åŸå­æ‰§è¡Œï¼Œæ— ç«æ€æ¡ä»¶</li>
<li><strong>æ€§èƒ½</strong>: å‡å°‘ç½‘ç»œå¾€è¿”ï¼Œå•æ¬¡ RTT å®Œæˆåˆ¤æ–­å’Œè®¡æ•°</li>
<li><strong>ç®€å•</strong>: æ¯”åˆ†å¸ƒå¼é”æ›´è½»é‡ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ä¼ ç»Ÿçš„é™æµå®ç°éœ€è¦å…ˆ GET è®¡æ•°ï¼Œå†åˆ¤æ–­æ˜¯å¦è¶…é™ï¼Œæœ€å INCRï¼Œè¿™éœ€è¦å¤šæ¬¡ç½‘ç»œå¾€è¿”ä¸”å­˜åœ¨ç«æ€æ¡ä»¶ã€‚Redis Lua è„šæœ¬å°†è¿™äº›æ“ä½œåŸå­åŒ–ï¼Œåœ¨ Redis æœåŠ¡å™¨ç«¯å•æ¬¡æ‰§è¡Œå®Œæˆï¼Œæ—¢ä¿è¯äº†åŸå­æ€§åˆå‡å°‘äº†ç½‘ç»œå¼€é”€ã€‚åœ¨ Sparkle ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Lua è„šæœ¬å®ç°å›ºå®šçª—å£è®¡æ•°å™¨ï¼Œé…åˆ Redis çš„ EXPIRE è®¾ç½®çª—å£æœŸï¼Œå®ç°äº†ä¸€ä¸ªç®€å•é«˜æ•ˆçš„åˆ†å¸ƒå¼é™æµæ–¹æ¡ˆã€‚"</p>
</blockquote>
<p><strong>Q: JWT ä¸€æ—¦å‘æ”¾å¦‚ä½•ä¸»åŠ¨å¤±æ•ˆï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>é»‘åå•æœºåˆ¶</strong>: ç»´æŠ¤ä¸€ä¸ªçŸ­æœŸçš„ Token é»‘åå•</li>
<li><strong>çŸ­æœ‰æ•ˆæœŸ</strong>: è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼ˆå¦‚ 1 å°æ—¶ï¼‰</li>
<li><strong>åˆ·æ–°ä»¤ç‰Œ</strong>: ä½¿ç”¨ Refresh Token æœºåˆ¶</li>
<li><strong>ä¸šåŠ¡æƒè¡¡</strong>: åœ¨å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒé—´å¹³è¡¡</li>
</ul>
<hr>
<h2 id="23-ç”Ÿäº§çº§ç‰¹æ€§">2.3 ç”Ÿäº§çº§ç‰¹æ€§ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-4">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ç”Ÿäº§çº§ç‰¹æ€§æ˜¯ç³»ç»Ÿç¨³å®šæ€§çš„åŸºçŸ³ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>è¿æ¥ç®¡ç†</strong>: ä¼šè¯æ˜ å°„ + å¿ƒè·³ï¼Œé˜²æ­¢åƒµå°¸è¿æ¥</li>
<li><strong>é…é¢æ§åˆ¶</strong>: Redis è®¡æ•°å™¨ï¼Œé˜²æ­¢æ»¥ç”¨</li>
<li><strong>è®¤è¯å®‰å…¨</strong>: JWT + ç­¾åéªŒè¯</li>
<li><strong>é™æµä¿æŠ¤</strong>: Redis Lua è„šæœ¬ï¼Œé˜²æ­¢ DDoS</li>
<li><strong>é”™è¯¯éš”ç¦»</strong>: ç†”æ–­ + è¶…æ—¶ï¼Œé˜²æ­¢çº§è”æ•…éšœ</li>
<li><strong>æ—¥å¿—è¿½è¸ª</strong>: è¯·æ±‚ ID + ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-4">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>è¿æ¥ç®¡ç†ä¸å¿ƒè·³ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token keyword keyword-type">type</span> SessionManager <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    sessions <span class="token keyword keyword-map">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Session
    mu       sync<span class="token punctuation">.</span>RWMutex
<span class="token punctuation">}</span>

<span class="token keyword keyword-type">type</span> Session <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    userID    <span class="token builtin">string</span>
    conn      <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn
    lastSeen  time<span class="token punctuation">.</span>Time
    quit      <span class="token keyword keyword-chan">chan</span> <span class="token keyword keyword-struct">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SessionManager<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>sessionID <span class="token builtin">string</span><span class="token punctuation">,</span> conn <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sm<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-defer">defer</span> sm<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    sm<span class="token punctuation">.</span>sessions<span class="token punctuation">[</span>sessionID<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>Session<span class="token punctuation">{</span>
        userID<span class="token punctuation">:</span>   <span class="token function">extractUserID</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span>
        conn<span class="token punctuation">:</span>     conn<span class="token punctuation">,</span>
        lastSeen<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        quit<span class="token punctuation">:</span>     <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword keyword-chan">chan</span> <span class="token keyword keyword-struct">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// å¯åŠ¨å¿ƒè·³ç›‘æ§</span>
    <span class="token keyword keyword-go">go</span> sm<span class="token punctuation">.</span><span class="token function">monitorSession</span><span class="token punctuation">(</span>sessionID<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>sm <span class="token operator">*</span>SessionManager<span class="token punctuation">)</span> <span class="token function">monitorSession</span><span class="token punctuation">(</span>sessionID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">30</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
    <span class="token keyword keyword-defer">defer</span> ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-select">select</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-case">case</span> <span class="token operator">&lt;-</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
            sm<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            session<span class="token punctuation">,</span> exists <span class="token operator">:=</span> sm<span class="token punctuation">.</span>sessions<span class="token punctuation">[</span>sessionID<span class="token punctuation">]</span>
            sm<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>exists <span class="token punctuation">{</span>
                <span class="token keyword keyword-return">return</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">// æ£€æŸ¥æ˜¯å¦è¶…æ—¶</span>
            <span class="token keyword keyword-if">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>lastSeen<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">90</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second <span class="token punctuation">{</span>
                sm<span class="token punctuation">.</span><span class="token function">Unregister</span><span class="token punctuation">(</span>sessionID<span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>é…é¢æ§åˆ¶æœåŠ¡ï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token keyword keyword-type">type</span> QuotaService <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    redis <span class="token operator">*</span>redis<span class="token punctuation">.</span>Client
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>qs <span class="token operator">*</span>QuotaService<span class="token punctuation">)</span> <span class="token function">CheckQuota</span><span class="token punctuation">(</span>userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    key <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"quota:%s"</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span>
    
    <span class="token comment">// ä½¿ç”¨ Lua è„šæœ¬åŸå­æ£€æŸ¥å¹¶æ‰£å‡</span>
    script <span class="token operator">:=</span> <span class="token string">`
    local current = redis.call('GET', KEYS[1])
    if not current then
        redis.call('SET', KEYS[1], '100', 'EX', 86400) -- 100æ¬¡/å¤©
        return 1
    end
    
    if tonumber(current) &gt; 0 then
        redis.call('DECR', KEYS[1])
        return 1
    end
    
    return 0
    `</span>
    
    result<span class="token punctuation">,</span> err <span class="token operator">:=</span> qs<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token function">Eval</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> script<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>key<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> result<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>ç»“æ„åŒ–æ—¥å¿—ä¸è¯·æ±‚è¿½è¸ªï¼š</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token keyword keyword-type">type</span> Logger <span class="token keyword keyword-struct">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger
<span class="token punctuation">}</span>

<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Logger<span class="token punctuation">)</span> <span class="token function">WithRequestID</span><span class="token punctuation">(</span>requestID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> l<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"request_id"</span><span class="token punctuation">,</span> requestID<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// åœ¨å¤„ç†å‡½æ•°ä¸­</span>
<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ChatHandler<span class="token punctuation">)</span> <span class="token function">HandleRequest</span><span class="token punctuation">(</span>conn <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    requestID <span class="token operator">:=</span> <span class="token function">generateRequestID</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger <span class="token operator">:=</span> h<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">WithRequestID</span><span class="token punctuation">(</span>requestID<span class="token punctuation">)</span>
    
    logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Request started"</span><span class="token punctuation">,</span> 
        zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> userID<span class="token punctuation">)</span><span class="token punctuation">,</span>
        zap<span class="token punctuation">.</span><span class="token function">Time</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-defer">defer</span> <span class="token keyword keyword-func">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Request panicked"</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token string">"panic"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment">// ä¸šåŠ¡é€»è¾‘...</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-4">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>è¿æ¥ç®¡ç†çš„è®¾è®¡å“²å­¦:</strong></p>
<ul>
<li><strong>èµ„æºéš”ç¦»</strong>: æ¯ä¸ªç”¨æˆ·è¿æ¥ç‹¬ç«‹ï¼Œäº’ä¸å½±å“</li>
<li><strong>ä¸»åŠ¨æ¸…ç†</strong>: å¿ƒè·³æ£€æµ‹ + è¶…æ—¶æœºåˆ¶ï¼Œé˜²æ­¢åƒµå°¸è¿æ¥</li>
<li><strong>ä¼˜é›…å…³é—­</strong>: ä½¿ç”¨ quit é€šé“é€šçŸ¥åç¨‹é€€å‡º</li>
</ul>
<p><strong>é…é¢æ§åˆ¶çš„é˜²å¾¡æ€§è®¾è®¡:</strong></p>
<ul>
<li><strong>åŸå­æ“ä½œ</strong>: Lua è„šæœ¬ä¿è¯æ£€æŸ¥å’Œæ‰£å‡çš„åŸå­æ€§</li>
<li><strong>å¤šçº§é™åˆ¶</strong>: å¯ä»¥å åŠ ç”¨æˆ·çº§ã€IPçº§ã€å…¨å±€çº§é™æµ</li>
<li><strong>é™çº§ç­–ç•¥</strong>: é…é¢è€—å°½æ—¶è¿”å›å‹å¥½é”™è¯¯ï¼Œè€Œéç›´æ¥æ–­å¼€</li>
</ul>
<p><strong>æ—¥å¿—è¿½è¸ªçš„å¯è§‚æµ‹æ€§:</strong></p>
<ul>
<li><strong>è¯·æ±‚å…¨é“¾è·¯</strong>: ä»ç½‘å…³åˆ° AI å¼•æ“éƒ½æœ‰ request_id</li>
<li><strong>ç»“æ„åŒ–</strong>: JSON æ ¼å¼ï¼Œä¾¿äºæœºå™¨è§£æå’ŒæŸ¥è¯¢</li>
<li><strong>åˆ†çº§</strong>: DEBUG/INFO/WARN/ERRORï¼Œä¾¿äºè¿‡æ»¤</li>
</ul>
<p><strong>é”™è¯¯éš”ç¦»çš„ç†”æ–­æœºåˆ¶:</strong></p>
<ul>
<li><strong>å¿«é€Ÿå¤±è´¥</strong>: è¶…æ—¶æˆ–é”™è¯¯ç‡è¿‡é«˜æ—¶ç«‹å³è¿”å›</li>
<li><strong>åˆ†çº§é™çº§</strong>: æ ¸å¿ƒåŠŸèƒ½ä¿æŒï¼Œéæ ¸å¿ƒåŠŸèƒ½é™çº§</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: å†·å´åå°è¯•æ¢å¤ï¼Œé˜²æ­¢æ°¸ä¹…ä¸å¯ç”¨</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-4">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•é˜²æ­¢åƒµå°¸è¿æ¥è€—å°½æœåŠ¡å™¨èµ„æºï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>å¿ƒè·³æœºåˆ¶</strong>: åº”ç”¨å±‚ Ping/Pong æ£€æµ‹</li>
<li><strong>è¶…æ—¶æ£€æµ‹</strong>: Redis ç§Ÿçº¦è‡ªåŠ¨è¿‡æœŸ</li>
<li><strong>èµ„æºé™åˆ¶</strong>: å•ç”¨æˆ·å¹¶å‘è¿æ¥æ•°é™åˆ¶</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>: è¿æ¥æ•°å¼‚å¸¸æ—¶å‘Šè­¦</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨ä¸‰å±‚é˜²æŠ¤ï¼šç¬¬ä¸€ï¼Œåº”ç”¨å±‚å¿ƒè·³ï¼Œæ¯ 30 ç§’å‘é€ Pingï¼Œ90 ç§’æ— å“åº”è‡ªåŠ¨æ–­å¼€ï¼›ç¬¬äºŒï¼ŒRedis ç§Ÿçº¦æœºåˆ¶ï¼Œä¼šè¯æ´»è·ƒæ—¶é—´è‡ªåŠ¨è¿‡æœŸï¼›ç¬¬ä¸‰ï¼Œè¿æ¥æ•°é™åˆ¶ï¼Œå•ç”¨æˆ·æœ€å¤š 10 ä¸ªå¹¶å‘è¿æ¥ã€‚åŒæ—¶é€šè¿‡ Prometheus ç›‘æ§è¿æ¥æ•°ï¼Œè¶…è¿‡é˜ˆå€¼è‡ªåŠ¨å‘Šè­¦ã€‚è¿™ç§ç»„åˆå¯ä»¥æœ‰æ•ˆé˜²æ­¢åƒµå°¸è¿æ¥è€—å°½æœåŠ¡å™¨èµ„æºã€‚"</p>
</blockquote>
<hr>
<h1 id="ä¸‰-python-agent-engine---ai-æ ¸å¿ƒå¼•æ“">ä¸‰ã€Python Agent Engine - AI æ ¸å¿ƒå¼•æ“ </h1>
<h2 id="31-ç”Ÿäº§çº§ç¼–æ’å™¨-productionchatorchestrator">3.1 ç”Ÿäº§çº§ç¼–æ’å™¨ (ProductionChatOrchestrator) </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-5">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ç”Ÿäº§çº§ç¼–æ’å™¨æ˜¯ AI å¼•æ“çš„ <strong>å¤§è„‘</strong>ï¼Œé‡‡ç”¨ <strong>è´£ä»»é“¾æ¨¡å¼</strong> å®ç° 11 æ­¥å®‰å…¨å¤„ç†é“¾ï¼š</p>
<ol>
<li><strong>åˆ†å¸ƒå¼æ¶ˆæ¯å»é‡ (Redis)</strong>: ä¿è¯å¹‚ç­‰æ€§</li>
<li><strong>æœåŠ¡ç†”æ–­å™¨æ£€æŸ¥</strong>: é˜²æ­¢çº§è”æ•…éšœ</li>
<li><strong>å¹¶å‘é™åˆ¶ (Semaphore)</strong>: èµ„æºéš”ç¦»</li>
<li><strong>è¯·æ±‚éªŒè¯</strong>: è¾“å…¥åˆæ³•æ€§æ£€æŸ¥</li>
<li><strong>å¹‚ç­‰æ€§æ£€æŸ¥</strong>: é˜²æ­¢é‡å¤å¤„ç†</li>
<li><strong>åˆ†å¸ƒå¼é” (Redis SETNX)</strong>: å¹¶å‘å®‰å…¨</li>
<li><strong>æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡</strong>: ä¸ªæ€§åŒ–å¤„ç†</li>
<li><strong>GraphRAG çŸ¥è¯†æ£€ç´¢</strong>: æ™ºèƒ½å¬å›</li>
<li><strong>LLM ç¼–æ’ä¸å·¥å…·è°ƒç”¨</strong>: AI æ ¸å¿ƒé€»è¾‘</li>
<li><strong>æŒ‡æ ‡è®°å½•ä¸å“åº”ç¼“å­˜</strong>: å¯è§‚æµ‹æ€§</li>
<li><strong>èµ„æºæ¸…ç†</strong>: é˜²æ­¢æ³„æ¼</li>
</ol>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-5">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/orchestrator_production.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">ProductionChatOrchestrator</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    ç”Ÿäº§çº§èŠå¤©ç¼–æ’å™¨
    èŒè´£ï¼šè¯·æ±‚éªŒè¯ã€å¹¶å‘æ§åˆ¶ã€çŠ¶æ€ç®¡ç†ã€é”™è¯¯å¤„ç†ã€ç›‘æ§
    ç¼–ç¨‹æ€æƒ³ï¼šè´£ä»»é“¾æ¨¡å¼ã€ç†”æ–­å™¨æ¨¡å¼ã€å¹‚ç­‰æ€§è®¾è®¡
    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">:</span> ProductionSettings<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># æ ¸å¿ƒç»„ä»¶æ³¨å…¥ (Dependency Injection)</span>
        self<span class="token punctuation">.</span>state_manager <span class="token operator">=</span> SessionStateManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>validator <span class="token operator">=</span> RequestValidator<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tool_executor <span class="token operator">=</span> ToolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>response_composer <span class="token operator">=</span> ResponseComposer<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ç”Ÿäº§çº§å¢å¼ºç»„ä»¶</span>
        self<span class="token punctuation">.</span>context_pruner <span class="token operator">=</span> ContextPruner<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>circuit_breaker <span class="token operator">=</span> CircuitBreaker<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token comment"># ç†”æ–­å™¨ï¼Œé˜²æ­¢çº§è”æ•…éšœ</span>
        self<span class="token punctuation">.</span>message_tracker <span class="token operator">=</span> MessageTracker<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># æ¶ˆæ¯å»é‡ï¼Œä¿è¯å¹‚ç­‰æ€§</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncIterator<span class="token punctuation">[</span>StreamEvent<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        ä¸»å¤„ç†æµç¨‹ - 11æ­¥å®‰å…¨å¤„ç†é“¾
        """</span>
        request_id <span class="token operator">=</span> request<span class="token punctuation">.</span>request_id
        session_id <span class="token operator">=</span> request<span class="token punctuation">.</span>session_id

        <span class="token comment"># ========== ç¬¬1æ­¥ï¼šåˆ†å¸ƒå¼æ¶ˆæ¯å»é‡ (Redis) ==========</span>
        <span class="token comment"># ç¼–ç¨‹æ€æƒ³ï¼šå¹‚ç­‰æ€§ä¿è¯ã€‚ç¡®ä¿åŒä¸€ä¸ªè¯·æ±‚ ID åœ¨ç½‘ç»œæ³¢åŠ¨é‡è¯•æ—¶ä»…å¤„ç†ä¸€æ¬¡ã€‚</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>is_processed<span class="token punctuation">(</span>request_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"DUPLICATE_REQUEST"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"è¯·æ±‚å·²å¤„ç†"</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span>

        <span class="token comment"># ========== ç¬¬2æ­¥ï¼šæœåŠ¡ç†”æ–­å™¨æ£€æŸ¥ ==========</span>
        <span class="token comment"># ç¼–ç¨‹æ€æƒ³ï¼šç†”æ–­ä¿æŠ¤ã€‚å¦‚æœ LLM æŒç»­æŠ¥é”™ï¼Œè‡ªåŠ¨åˆ‡æ–­è¯·æ±‚ï¼Œé˜²æ­¢ç³»ç»Ÿé›ªå´©ã€‚</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>can_execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"CIRCUIT_BREAKER_OPEN"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"ç³»ç»Ÿè¿‡è½½"</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span>

        <span class="token comment"># ========== ç¬¬3æ­¥ï¼šå¹¶å‘é™åˆ¶ (Semaphore) ==========</span>
        <span class="token comment"># ç¼–ç¨‹æ€æƒ³ï¼šèµ„æºéš”ç¦»ã€‚é™åˆ¶å•ä¸ªç”¨æˆ·æˆ–ä¼šè¯çš„åŒæ—¶æ´»è·ƒè¯·æ±‚æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½ã€‚</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_track_session<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"RATE_LIMIT"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"å¹¶å‘è¿‡é«˜"</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span>

        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token comment"># ========== ç¬¬4-5æ­¥ï¼šè¯·æ±‚éªŒè¯ä¸å¹‚ç­‰ç»“æœæ£€æŸ¥ ==========</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>validate<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            
            <span class="token comment"># ========== ç¬¬6æ­¥ï¼šåˆ†å¸ƒå¼é” (Redis SETNX) ==========</span>
            lock_acquired <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_acquire_session_lock<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> request_id<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> lock_acquired<span class="token punctuation">:</span>
                <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"LOCK_FAILED"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"ä¼šè¯ç¹å¿™"</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span>

            <span class="token comment"># ========== ç¬¬7-8æ­¥ï¼šGraphRAG çŸ¥è¯†æ£€ç´¢ ==========</span>
            user_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_build_user_context<span class="token punctuation">(</span>request<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
            knowledge_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_retrieve_knowledge<span class="token punctuation">(</span>request<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> request<span class="token punctuation">.</span>message<span class="token punctuation">)</span>

            <span class="token comment"># ========== ç¬¬9æ­¥ï¼šLLM ç¼–æ’ä¸å·¥å…·è°ƒç”¨ ==========</span>
            <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>_call_llm_with_tools<span class="token punctuation">(</span>
                request<span class="token operator">=</span>request<span class="token punctuation">,</span>
                user_context<span class="token operator">=</span>user_context<span class="token punctuation">,</span>
                knowledge_context<span class="token operator">=</span>knowledge_context
            <span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-yield">yield</span> chunk

            <span class="token comment"># ========== ç¬¬10æ­¥ï¼šæŒ‡æ ‡è®°å½•ä¸å“åº”ç¼“å­˜ ==========</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_record_metrics<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user_context<span class="token punctuation">)</span>

        <span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># ========== ç¬¬11æ­¥ï¼šèµ„æºæ¸…ç† ==========</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_release_session_lock<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> request_id<span class="token punctuation">)</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_track_session<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> add<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

    <span class="token comment"># ğŸ¯ **Sparkle é¡¹ç›®å®æˆ˜ï¼šGo Gateway ä¸ Python Agent çš„å®Œæ•´æ•°æ®æµ**</span>
    <span class="token comment">#</span>
    <span class="token comment"># åœ¨ backend/gateway/internal/handler/chat_orchestrator.go ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼š</span>
    <span class="token comment"># 1. Go Gateway æ¥æ”¶ WebSocket æ¶ˆæ¯</span>
    <span class="token comment"># 2. é€šè¿‡ gRPC è°ƒç”¨æ­¤ Python Agent çš„ StreamChat æ–¹æ³•</span>
    <span class="token comment"># 3. Python Agent è¿”å›æµå¼å“åº”</span>
    <span class="token comment"># 4. Go Gateway è½¬å‘ç»™ Flutter å®¢æˆ·ç«¯</span>
    <span class="token comment">#</span>
    <span class="token comment"># è¿™ä¸ªæµç¨‹å®ç°äº†ï¼š</span>
    <span class="token comment"># - Go è´Ÿè´£é«˜å¹¶å‘è¿æ¥ç®¡ç†ï¼ˆC10Kï¼‰</span>
    <span class="token comment"># - Python è´Ÿè´£ AI é€»è¾‘å¤„ç†ï¼ˆLLM + å·¥å…·ï¼‰</span>
    <span class="token comment"># - é€šè¿‡ gRPC ä¿æŒä½å»¶è¿Ÿé€šä¿¡</span>
</code></pre><p><strong>ğŸ¯ Sparkle é¡¹ç›®å®æˆ˜åˆ†æï¼šPython Agent çš„ 11 æ­¥å¤„ç†é“¾</strong></p>
<p>åœ¨ <code>backend/app/orchestration/orchestrator_production.py</code> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å®Œæ•´çš„ç”Ÿäº§çº§å®ç°ï¼š</p>
<ol>
<li><strong>æ¶ˆæ¯å»é‡ä¸å¹‚ç­‰æ€§</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># æ¶ˆæ¯å»é‡æ£€æŸ¥</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>is_processed<span class="token punctuation">(</span>request_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"DUPLICATE_REQUEST"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"è¯·æ±‚å·²å¤„ç†"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>

<span class="token comment"># æ¶ˆæ¯æ ‡è®°å¤„ç†</span>
<span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>mark_processed<span class="token punctuation">(</span>request_id<span class="token punctuation">)</span>
</code></pre><ol start="2">
<li><strong>ç†”æ–­å™¨ä¿æŠ¤</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># ç†”æ–­å™¨æ£€æŸ¥</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>can_execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"CIRCUIT_BREAKER_OPEN"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"ç³»ç»Ÿè¿‡è½½"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>

<span class="token comment"># è®°å½•æˆåŠŸ/å¤±è´¥</span>
<span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>record_success<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># æˆ–</span>
<span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>record_failure<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><ol start="3">
<li><strong>åˆ†å¸ƒå¼é”</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># è·å–ä¼šè¯é”</span>
lock_acquired <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_acquire_session_lock<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> request_id<span class="token punctuation">)</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> lock_acquired<span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"LOCK_FAILED"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"ä¼šè¯ç¹å¿™"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>
</code></pre><ol start="4">
<li><strong>GraphRAG æ£€ç´¢ï¼ˆæ ¸å¿ƒåˆ›æ–°ï¼‰</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># åœ¨ backend/app/services/galaxy_service.py ä¸­</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">hybrid_search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. å‘é‡æœç´¢ï¼ˆpgvectorï¼‰</span>
    vector_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_vector_search<span class="token punctuation">(</span>query_embedding<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. å…³é”®è¯æœç´¢ï¼ˆRedisï¼‰</span>
    keyword_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_keyword_search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. RRF èåˆ</span>
    fused <span class="token operator">=</span> self<span class="token punctuation">.</span>_reciprocal_rank_fusion<span class="token punctuation">(</span>vector_results<span class="token punctuation">,</span> keyword_results<span class="token punctuation">)</span>
    
    <span class="token comment"># 4. é‡æ’åº</span>
    reranked <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_rerank<span class="token punctuation">(</span>query<span class="token punctuation">,</span> fused<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>
    
    <span class="token comment"># 5. ç”¨æˆ·çŠ¶æ€è¿‡æ»¤</span>
    filtered <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_filter_by_user_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> filtered
</code></pre><ol start="5">
<li><strong>LLM å·¥å…·è°ƒç”¨å¾ªç¯</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># å·¥å…·æ³¨å†Œè¡¨è‡ªåŠ¨å‘ç°</span>
dynamic_tool_registry<span class="token punctuation">.</span>register_from_package<span class="token punctuation">(</span><span class="token string">"app.tools"</span><span class="token punctuation">)</span>

<span class="token comment"># å·¥å…·æ‰§è¡Œ</span>
result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>tool_executor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>tool_call<span class="token punctuation">)</span>

<span class="token comment"># ä¸Šä¸‹æ–‡ç´¯ç§¯</span>
messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
    <span class="token string">"tool_call_id"</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
    <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><strong>æ¶æ„ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>è´£ä»»é“¾æ¨¡å¼</strong>: 11 æ­¥æ¸…æ™°åˆ†ç¦»ï¼Œä¾¿äºæµ‹è¯•å’Œç»´æŠ¤</li>
<li><strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>: æ¯æ­¥éƒ½æœ‰é™çº§ç­–ç•¥</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>: æ¯æ­¥éƒ½æœ‰æŒ‡æ ‡å’Œæ—¥å¿—</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: æ—©æœŸæ‹’ç»ï¼Œé¿å…æ— æ•ˆè®¡ç®—</li>
</ul>
<hr>
<h2 id="32-ä¸Šä¸‹æ–‡ç®¡ç†">3.2 ä¸Šä¸‹æ–‡ç®¡ç† </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-6">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ä¸Šä¸‹æ–‡ç®¡ç†æ˜¯ AI ä¸ªæ€§åŒ–çš„å…³é”®ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>ç”¨æˆ·ä¸Šä¸‹æ–‡</strong>: åŸºæœ¬ä¿¡æ¯ã€å­¦ä¹ è¿›åº¦ã€æ¨é€åå¥½</li>
<li><strong>å¯¹è¯å†å²</strong>: æ»‘åŠ¨çª—å£ + å¼‚æ­¥æ€»ç»“</li>
<li><strong>çŸ¥è¯†æ£€ç´¢</strong>: GraphRAG æ··åˆæœç´¢</li>
<li><strong>ä¸Šä¸‹æ–‡ä¿®å‰ª</strong>: Token ä¼˜åŒ–ä¸æ€§èƒ½æå‡</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-6">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>ç”¨æˆ·ä¸Šä¸‹æ–‡æ„å»ºï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_build_user_context</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> UserContext<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡"""</span>
    <span class="token comment"># 1. ä» DB è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</span>
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>user_service<span class="token punctuation">.</span>get_user<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token comment"># 2. å­¦ä¹ è¿›åº¦ç»Ÿè®¡</span>
    progress <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>stats_service<span class="token punctuation">.</span>get_learning_progress<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token comment"># 3. è·å–å½“å‰æ´»è·ƒçš„å†²åˆºè®¡åˆ’</span>
    sprint <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>sprint_service<span class="token punctuation">.</span>get_active_sprint<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token comment"># 4. æ¨é€åå¥½</span>
    push_pref <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>push_service<span class="token punctuation">.</span>get_preferences<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> UserContext<span class="token punctuation">(</span>
        user<span class="token operator">=</span>user<span class="token punctuation">,</span>
        progress<span class="token operator">=</span>progress<span class="token punctuation">,</span>
        active_sprint<span class="token operator">=</span>sprint<span class="token punctuation">,</span>
        push_preference<span class="token operator">=</span>push_pref
    <span class="token punctuation">)</span>
</code></pre><p><strong>GraphRAG çŸ¥è¯†æ£€ç´¢ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_retrieve_knowledge</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                             conversation_context<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> KnowledgeContext<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""GraphRAG çŸ¥è¯†æ£€ç´¢"""</span>
    <span class="token comment"># 1. å‘é‡æ··åˆæœç´¢ (Hybrid Search)</span>
    <span class="token comment"># æ€æƒ³ï¼šå¤šæ¨¡æ€å¬å›ã€‚åŒæ—¶é€šè¿‡è¯­ä¹‰å‘é‡ (pgvector) å’Œ å…³é”®è¯åŒ¹é… (Full-text search) æ‰¾åˆ°æœ€ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚</span>
    vector_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>galaxy_service<span class="token punctuation">.</span>hybrid_search<span class="token punctuation">(</span>
        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
        query<span class="token operator">=</span>query<span class="token punctuation">,</span>
        limit<span class="token operator">=</span><span class="token number">10</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 2. å…³ç³»æ‰©å±• (Relation Expansion)</span>
    <span class="token comment"># æ€æƒ³ï¼šå…³è”æ€è€ƒã€‚ä¸ä»…çœ‹åŒ¹é…åˆ°çš„èŠ‚ç‚¹ï¼Œè¿˜è¦æ‹‰å–å®ƒä»¬çš„â€œçˆ¶èŠ‚ç‚¹â€ã€â€œå­èŠ‚ç‚¹â€æˆ–â€œå…ˆä¿®è¯¾ç¨‹â€ã€‚</span>
    expanded <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>galaxy_service<span class="token punctuation">.</span>expand_relations<span class="token punctuation">(</span>
        node_ids<span class="token operator">=</span><span class="token punctuation">[</span>r<span class="token punctuation">.</span>node_id <span class="token keyword keyword-for">for</span> r <span class="token keyword keyword-in">in</span> vector_results<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 3. ç”¨æˆ·çŠ¶æ€è¿‡æ»¤</span>
    <span class="token comment"># æ€æƒ³ï¼šä¸ªæ€§åŒ–è£å‰ªã€‚å‰”é™¤ç”¨æˆ·å·²ç»å®Œå…¨æŒæ¡çš„å†…å®¹ï¼Œæˆ–è€…æ ¹æ®ç”¨æˆ·ç­‰çº§æ¨èåˆé€‚éš¾åº¦çš„çŸ¥è¯†ã€‚</span>
    filtered <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>galaxy_service<span class="token punctuation">.</span>filter_by_user_status<span class="token punctuation">(</span>
        user_id<span class="token punctuation">,</span> expanded
    <span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> KnowledgeContext<span class="token punctuation">(</span>
        nodes<span class="token operator">=</span>filtered<span class="token punctuation">,</span>
        relations<span class="token operator">=</span>expanded<span class="token punctuation">.</span>relations<span class="token punctuation">,</span>
        relevance_score<span class="token operator">=</span>vector_results<span class="token punctuation">.</span>relevance_score
    <span class="token punctuation">)</span>
</code></pre><p><strong>ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">ContextPruner</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ™ºèƒ½ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_pruned_history</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. ä» Redis åŠ è½½åŸå§‹å†å²</span>
        history <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_load_chat_history<span class="token punctuation">(</span>session_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> history<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

        <span class="token comment"># 2. æ»‘åŠ¨çª—å£å†³ç­–</span>
        <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>max_history_messages<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> history<span class="token punctuation">,</span> <span class="token string">"summary_used"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>

        <span class="token comment"># 3. æ™ºèƒ½æ€»ç»“é€»è¾‘</span>
        cache_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"summary:</span><span class="token interpolation"><span class="token punctuation">{</span>session_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        cached_summary <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cache_key<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> cached_summary<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">:</span> cached_summary<span class="token punctuation">,</span> <span class="token string">"summary_used"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        
        <span class="token comment"># è§¦å‘å¼‚æ­¥ä»»åŠ¡å¹¶è¿”å›â€œé™çº§â€ç»“æœ</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_trigger_async_summary<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> history<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"summary_used"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-5">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä¸Šä¸‹æ–‡ç®¡ç†çš„æ ¸å¿ƒæŒ‘æˆ˜:</strong></p>
<ul>
<li><strong>Token é™åˆ¶</strong>: LLM ä¸Šä¸‹æ–‡çª—å£æœ‰é™ï¼ˆé€šå¸¸ 4K-32Kï¼‰</li>
<li><strong>æ€§èƒ½</strong>: é•¿ä¸Šä¸‹æ–‡å¯¼è‡´æ¨ç†å»¶è¿Ÿå¢åŠ </li>
<li><strong>ç›¸å…³æ€§</strong>: å†å²æ¶ˆæ¯ä¸­åªæœ‰éƒ¨åˆ†ä¸å½“å‰é—®é¢˜ç›¸å…³</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
<ol>
<li><strong>æ»‘åŠ¨çª—å£</strong>: åªä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯</li>
<li><strong>å¼‚æ­¥æ€»ç»“</strong>: åå° Worker å‹ç¼©å†å²ï¼Œä¸‹æ¬¡è¯·æ±‚å¯ç”¨</li>
<li><strong>è¯­ä¹‰è¿‡æ»¤</strong>: é€šè¿‡å‘é‡ç›¸ä¼¼åº¦ç­›é€‰ç›¸å…³å†å²</li>
<li><strong>åˆ†çº§å­˜å‚¨</strong>: çƒ­æ•°æ®ï¼ˆæœ€è¿‘æ¶ˆæ¯ï¼‰+ å†·æ•°æ®ï¼ˆæ€»ç»“ï¼‰</li>
</ol>
<p><strong>GraphRAG çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>ç»“æ„åŒ–</strong>: ä¸ä»…æ˜¯æ–‡æœ¬ç‰‡æ®µï¼Œè¿˜æœ‰æ‹“æ‰‘å…³ç³»</li>
<li><strong>å¯è§£é‡Š</strong>: å¯ä»¥å±•ç¤ºæ£€ç´¢è·¯å¾„å’Œç›¸å…³æ€§åˆ†æ•°</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ ¹æ®ç”¨æˆ·æŒæ¡åº¦è¿‡æ»¤å’Œæ’åº</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-5">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•å¤„ç†é•¿å¯¹è¯çš„ Token è¶…é™é—®é¢˜ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ»‘åŠ¨çª—å£</strong>: ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯</li>
<li><strong>å¼‚æ­¥æ€»ç»“</strong>: åå°å‹ç¼©å†å²ï¼Œç¼“å­˜åˆ° Redis</li>
<li><strong>è¯­ä¹‰è¿‡æ»¤</strong>: åªä¿ç•™ä¸å½“å‰é—®é¢˜ç›¸å…³çš„å†å²</li>
<li><strong>ä¼˜é›…é™çº§</strong>: ç¼“å­˜å¤±æ•ˆæ—¶å›é€€åˆ°æ»‘åŠ¨çª—å£</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨ä¸‰ç®¡é½ä¸‹çš„ç­–ç•¥ã€‚é¦–å…ˆï¼Œæ»‘åŠ¨çª—å£ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯ä½œä¸ºåŸºç¡€ã€‚å…¶æ¬¡ï¼Œå½“å¯¹è¯è¶…è¿‡ 30 è½®æ—¶ï¼Œè§¦å‘å¼‚æ­¥æ€»ç»“ä»»åŠ¡ï¼Œå°†æ—§å†å²å‹ç¼©æˆæ‘˜è¦å¹¶ç¼“å­˜ 1 å°æ—¶ã€‚ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ã€æ‘˜è¦ + æœ€è¿‘5æ¡ã€‘çš„ç»„åˆã€‚æœ€åï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦è¿‡æ»¤ï¼Œåªä¿ç•™ä¸å½“å‰é—®é¢˜ç›¸å…³çš„å†å²ç‰‡æ®µã€‚å¦‚æœæ€»ç»“ä»»åŠ¡å¤±è´¥ï¼Œç³»ç»Ÿä¼šä¼˜é›…é™çº§åˆ°çº¯æ»‘åŠ¨çª—å£ï¼Œç¡®ä¿æœåŠ¡ä¸ä¸­æ–­ã€‚"</p>
</blockquote>
<hr>
<h2 id="33-åŠ¨æ€å·¥å…·ç³»ç»Ÿ">3.3 åŠ¨æ€å·¥å…·ç³»ç»Ÿ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-7">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>åŠ¨æ€å·¥å…·ç³»ç»Ÿæ˜¯ Agent çš„ <strong>æ’ä»¶æ¶æ„</strong>ï¼Œæ”¯æŒè¿è¡Œæ—¶è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œå·¥å…·ï¼š</p>
<ul>
<li><strong>è‡ªåŠ¨æ‰«æ</strong>: åå°„æœºåˆ¶å‘ç°æ‰€æœ‰ BaseTool å­ç±»</li>
<li><strong>Schema ç”Ÿæˆ</strong>: è½¬æ¢ä¸º OpenAI Function Calling æ ¼å¼</li>
<li><strong>çƒ­åŠ è½½</strong>: æ–°å¢å·¥å…·æ— éœ€é‡å¯æœåŠ¡</li>
<li><strong>å¼€é—­åŸåˆ™</strong>: æ–°å¢å·¥å…·æ— éœ€ä¿®æ”¹æ³¨å†Œè¡¨ä»£ç </li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-7">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>å·¥å…·æ³¨å†Œè¡¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/dynamic_tool_registry.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">DynamicToolRegistry</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åŠ¨æ€å·¥å…·æ³¨å†Œè¡¨ - è‡ªåŠ¨å‘ç°æ¨¡å¼"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">register_from_package</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> package_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. åˆ©ç”¨ Python åå°„æœºåˆ¶åŠ¨æ€åŠ è½½æ¨¡å—</span>
        <span class="token comment"># æ€æƒ³ï¼šå¼€é—­åŸåˆ™ã€‚æ–°å¢ä¸€ä¸ª AI å·¥å…·åªéœ€è¦åœ¨ tools ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¸éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨çš„ä»£ç ã€‚</span>
        package <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>package_path<span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> importer<span class="token punctuation">,</span> modname<span class="token punctuation">,</span> ispkg <span class="token keyword keyword-in">in</span> pkgutil<span class="token punctuation">.</span>iter_modules<span class="token punctuation">(</span>package<span class="token punctuation">.</span>__path__<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰ BaseTool çš„å­ç±»</span>
            self<span class="token punctuation">.</span>register_from_module<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>package_path<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>modname<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_openai_tools_schema</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># 2. è½¬æ¢ä¸º OpenAI å…¼å®¹çš„ JSON Schema æè¿°</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>tool<span class="token punctuation">.</span>to_openai_schema<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> tool <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>_tools<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre><p><strong>å·¥å…·åŸºç±»è®¾è®¡ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/base_tool.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">BaseTool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å·¥å…·åŸºç±» - å®šä¹‰æ ‡å‡†æ¥å£"""</span>

    <span class="token comment"># 1. å…ƒæ•°æ®å®šä¹‰</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>           <span class="token comment"># å·¥å…·å”¯ä¸€æ ‡è¯†</span>
    description<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># ç”¨äºå‘Šè¯‰ LLM ä»€ä¹ˆæ—¶å€™è¯¥ç”¨è¿™ä¸ªå·¥å…·</span>
    category<span class="token punctuation">:</span> ToolCategory

    <span class="token comment"># 2. å‚æ•° Schema (JSON Schema æ ¼å¼)</span>
    <span class="token comment"># æ€æƒ³ï¼šè‡ªæè¿°ã€‚å·¥å…·è‡ªå·±å®šä¹‰éœ€è¦ä»€ä¹ˆå‚æ•°ï¼ŒLLM æ ¹æ®è¿™ä¸ªå®šä¹‰æ¥æå–å‚æ•°ã€‚</span>
    parameters_schema<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰§è¡Œé€»è¾‘ - ç”±å­ç±»å®ç°"""</span>
        <span class="token keyword keyword-raise">raise</span> NotImplementedError

    <span class="token keyword keyword-def">def</span> <span class="token function">to_openai_schema</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è½¬æ¢ä¸º OpenAI åè®®æ ¼å¼"""</span>
        <span class="token comment"># å°† Python å®šä¹‰è½¬æ¢ä¸º OpenAI API æ‰€éœ€çš„ç‰¹å®š JSON ç»“æ„</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><p><strong>å…·ä½“å·¥å…·ç¤ºä¾‹ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/tools/knowledge_tools.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">GetKnowledgeNodeTool</span><span class="token punctuation">(</span>BaseTool<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è·å–çŸ¥è¯†ç‚¹è¯¦æƒ…å·¥å…·"""</span>
    
    name <span class="token operator">=</span> <span class="token string">"get_knowledge_node"</span>
    description <span class="token operator">=</span> <span class="token string">"è·å–æŒ‡å®šçŸ¥è¯†ç‚¹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æè¿°ã€éš¾åº¦ã€ç›¸å…³çŸ¥è¯†ç‚¹"</span>
    category <span class="token operator">=</span> ToolCategory<span class="token punctuation">.</span>KNOWLEDGE
    
    parameters_schema <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"node_id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
                <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"çŸ¥è¯†ç‚¹å”¯ä¸€æ ‡è¯†"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"include_relations"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"boolean"</span><span class="token punctuation">,</span>
                <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"æ˜¯å¦åŒ…å«å…³è”çŸ¥è¯†ç‚¹"</span><span class="token punctuation">,</span>
                <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"node_id"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> include_relations<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># å®é™…ä¸šåŠ¡é€»è¾‘</span>
        node <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_node<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> include_relations<span class="token punctuation">:</span>
            node<span class="token punctuation">[</span><span class="token string">'relations'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_relations<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> node
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-6">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€å·¥å…·ç³»ç»Ÿï¼Ÿ</strong></p>
<ol>
<li><strong>å¼€é—­åŸåˆ™</strong>: æ–°å¢å·¥å…·ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç </li>
<li><strong>æ’ä»¶åŒ–</strong>: å·¥å…·å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²</li>
<li><strong>çµæ´»æ€§</strong>: è¿è¡Œæ—¶åŠ¨æ€å‘ç°ï¼Œæ”¯æŒçƒ­æ›´æ–°</li>
<li><strong>æ ‡å‡†åŒ–</strong>: ç»Ÿä¸€çš„æ¥å£å®šä¹‰ï¼Œä¾¿äº LLM è°ƒç”¨</li>
</ol>
<p><strong>åå°„æœºåˆ¶çš„åº”ç”¨:</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰å·¥å…·</span>
<span class="token keyword keyword-for">for</span> importer<span class="token punctuation">,</span> modname<span class="token punctuation">,</span> ispkg <span class="token keyword keyword-in">in</span> pkgutil<span class="token punctuation">.</span>iter_modules<span class="token punctuation">(</span>package<span class="token punctuation">.</span>__path__<span class="token punctuation">)</span><span class="token punctuation">:</span>
    module <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>package_path<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>modname<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> name<span class="token punctuation">,</span> obj <span class="token keyword keyword-in">in</span> inspect<span class="token punctuation">.</span>getmembers<span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> inspect<span class="token punctuation">.</span>isclass<span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token keyword keyword-and">and</span> <span class="token builtin">issubclass</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> BaseTool<span class="token punctuation">)</span> <span class="token keyword keyword-and">and</span> obj <span class="token operator">!=</span> BaseTool<span class="token punctuation">:</span>
            registry<span class="token punctuation">.</span>register<span class="token punctuation">(</span>obj<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p><strong>Schema è½¬æ¢çš„å…³é”®:</strong></p>
<ul>
<li><strong>ç±»å‹æ˜ å°„</strong>: Python ç±»å‹ â†’ JSON Schema ç±»å‹</li>
<li><strong>å‚æ•°æè¿°</strong>: æ¸…æ™°çš„ description å¸®åŠ© LLM ç†è§£</li>
<li><strong>å¿…å¡«å­—æ®µ</strong>: æ ‡è®° required å‚æ•°</li>
<li><strong>é»˜è®¤å€¼</strong>: æä¾›åˆç†çš„é»˜è®¤å€¼</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-6">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: åŠ¨æ€å·¥å…·ç³»ç»Ÿå¦‚ä½•å®ç°çƒ­åŠ è½½ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ¨¡å—é‡è½½</strong>: ä½¿ç”¨ importlib.reload()</li>
<li><strong>æ–‡ä»¶ç›‘å¬</strong>: ä½¿ç”¨ watchdog ç›‘æ§å·¥å…·ç›®å½•å˜åŒ–</li>
<li><strong>åŸå­æ›¿æ¢</strong>: æ–°å·¥å…·æ³¨å†Œå®Œæˆåï¼ŒåŸå­æ›¿æ¢æ—§å·¥å…·</li>
<li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>: æ”¯æŒå·¥å…·ç‰ˆæœ¬ç®¡ç†ï¼Œå¯å›æ»š</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é€šè¿‡æ–‡ä»¶ç›‘å¬å’Œæ¨¡å—é‡è½½å®ç°çƒ­åŠ è½½ã€‚ä½¿ç”¨ watchdog åº“ç›‘æ§ tools ç›®å½•ï¼Œå½“æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–æ—¶ï¼Œè§¦å‘é‡è½½æµç¨‹ã€‚é¦–å…ˆ importlib.reload() é‡æ–°åŠ è½½æ¨¡å—ï¼Œç„¶åæå–æ–°çš„å·¥å…·ç±»ï¼ŒåŸå­æ›¿æ¢æ³¨å†Œè¡¨ä¸­çš„æ—§å·¥å…·ã€‚æ•´ä¸ªè¿‡ç¨‹å¯¹è°ƒç”¨æ–¹é€æ˜ï¼Œä¸ä¼šä¸­æ–­ç°æœ‰è¯·æ±‚ã€‚æˆ‘ä»¬è¿˜å®ç°äº†ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯ä»¥éšæ—¶å›æ»šåˆ°ä¹‹å‰çš„å·¥å…·ç‰ˆæœ¬ã€‚"</p>
</blockquote>
<hr>
<h2 id="34-llm-æœåŠ¡é›†æˆ">3.4 LLM æœåŠ¡é›†æˆ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-8">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>LLM æœåŠ¡é›†æˆæ˜¯ AI å¼•æ“çš„æ ¸å¿ƒï¼Œé‡‡ç”¨ <strong>é€‚é…å™¨æ¨¡å¼</strong> å®ç°å¤šæ¨¡å‹æ”¯æŒï¼š</p>
<ul>
<li><strong>å¤šæ¨¡å‹é€‚é…</strong>: ç»Ÿä¸€æ¥å£å°è£…ä¸åŒå‚å•† API</li>
<li><strong>å·¥å…·è°ƒç”¨å¾ªç¯</strong>: LLM â†’ å·¥å…· â†’ ç»“æœ â†’ LLM â†’ å›ç­”</li>
<li><strong>æµå¼å¤„ç†</strong>: å®ç°æ‰“å­—æœºæ•ˆæœï¼Œé™ä½æ„ŸçŸ¥å»¶è¿Ÿ</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: è¶…æ—¶ã€é™æµã€é™çº§ç­–ç•¥</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-8">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>LLM æœåŠ¡é€‚é…å™¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/llm_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">LLMService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""LLM æœåŠ¡ - é€‚é…å™¨æ¨¡å¼å®ç°"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>providers <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'openai'</span><span class="token punctuation">:</span> OpenAIProvider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'anthropic'</span><span class="token punctuation">:</span> AnthropicProvider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'deepseek'</span><span class="token punctuation">:</span> DeepSeekProvider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>default_provider <span class="token operator">=</span> <span class="token string">'openai'</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">chat_stream_with_tools</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. ç­–ç•¥æ¨¡å¼ï¼šæ ¹æ®é…ç½®åŠ¨æ€åˆ‡æ¢æ¨¡å‹æä¾›å•†</span>
        provider <span class="token operator">=</span> self<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>get<span class="token punctuation">(</span>model <span class="token keyword keyword-or">or</span> self<span class="token punctuation">.</span>default_provider<span class="token punctuation">)</span>

        <span class="token comment"># 2. é€’å½’/å¾ªç¯å¤„ç†å·¥å…·è°ƒç”¨</span>
        <span class="token comment"># æµç¨‹ï¼šLLM å†³å®šè°ƒç”¨å·¥å…· -&gt; æ‰§è¡Œå·¥å…· -&gt; å°†ç»“æœå–‚å› LLM -&gt; ç”Ÿæˆæœ€ç»ˆå›ç­”</span>
        <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> provider<span class="token punctuation">.</span>chat_complete<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_call"</span><span class="token punctuation">:</span>
                <span class="token comment"># æ‰§è¡Œå·¥å…·å¹¶è·å¾—ç»“æœ</span>
                results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_execute_tools<span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>tool_calls<span class="token punctuation">)</span>
                <span class="token comment"># é‡è¦ï¼šå°†å·¥å…·æ‰§è¡Œç»“æœæ·»åŠ å›å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œå†æ¬¡è¯·æ±‚ LLM</span>
                messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> results<span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token comment"># é€’å½’ç”Ÿæˆåç»­å›ç­”</span>
                <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> final_chunk <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>chat_stream_with_tools<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-yield">yield</span> final_chunk
</code></pre><p><strong>å·¥å…·è°ƒç”¨å¾ªç¯ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_call_llm_with_tools</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> user_context<span class="token punctuation">,</span> knowledge_context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""LLM å·¥å…·è°ƒç”¨å¾ªç¯"""</span>
    
    <span class="token comment"># 1. å‡†å¤‡å·¥å…·</span>
    tools <span class="token operator">=</span> tool_registry<span class="token punctuation">.</span>get_openai_tools_schema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. æ„å»ºç³»ç»Ÿæç¤º</span>
    system_prompt <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_system_prompt<span class="token punctuation">(</span>user_context<span class="token punctuation">,</span> knowledge_context<span class="token punctuation">)</span>
    
    <span class="token comment"># 3. åˆå§‹æ¶ˆæ¯</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>message<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    <span class="token comment"># 4. å·¥å…·è°ƒç”¨å¾ªç¯</span>
    max_tool_calls <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># é˜²æ­¢æ— é™å¾ªç¯</span>
    tool_call_count <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword keyword-while">while</span> tool_call_count <span class="token operator">&lt;</span> max_tool_calls<span class="token punctuation">:</span>
        <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> llm_service<span class="token punctuation">.</span>chat_stream_with_tools<span class="token punctuation">(</span>
            messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
            tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
            model<span class="token operator">=</span>request<span class="token punctuation">.</span>model
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"text"</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-yield">yield</span> TextEvent<span class="token punctuation">(</span>content<span class="token operator">=</span>chunk<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
            <span class="token keyword keyword-elif">elif</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_call"</span><span class="token punctuation">:</span>
                <span class="token comment"># æ‰§è¡Œå·¥å…·</span>
                result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>tool_executor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>tool_call<span class="token punctuation">)</span>
                <span class="token comment"># æ·»åŠ åˆ°ä¸Šä¸‹æ–‡</span>
                messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
                    <span class="token string">"tool_call_id"</span><span class="token punctuation">:</span> chunk<span class="token punctuation">.</span>tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                    <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                tool_call_count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword keyword-break">break</span>  <span class="token comment"># é€€å‡ºæµå¼å¾ªç¯ï¼Œé‡æ–°è°ƒç”¨ LLM</span>
            <span class="token keyword keyword-elif">elif</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"error"</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span>chunk<span class="token punctuation">.</span>code<span class="token punctuation">,</span> message<span class="token operator">=</span>chunk<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span>
</code></pre><p><strong>æµå¼å¤„ç†ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">chat_complete_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æµå¼èŠå¤©å®Œæˆ"""</span>
    provider <span class="token operator">=</span> self<span class="token punctuation">.</span>providers<span class="token punctuation">[</span>model<span class="token punctuation">]</span>
    
    <span class="token comment"># ä½¿ç”¨ async for éšè—ç¼“å†²å’ŒçŠ¶æ€åŒæ­¥</span>
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> provider<span class="token punctuation">.</span>chat_complete<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># å®ç°æ‰“å­—æœºæ•ˆæœ</span>
        <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>content
        <span class="token comment"># å¤„ç†å·¥å…·è°ƒç”¨</span>
        <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"tool_call"</span><span class="token punctuation">,</span>
                <span class="token string">"tool_calls"</span><span class="token punctuation">:</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>tool_calls
            <span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-7">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>é€‚é…å™¨æ¨¡å¼çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>ç»Ÿä¸€æ¥å£</strong>: ä¸šåŠ¡å±‚ä¸å…³å¿ƒåº•å±‚æ˜¯ OpenAI è¿˜æ˜¯ DeepSeek</li>
<li><strong>æ˜“äºæ‰©å±•</strong>: æ–°å¢æ¨¡å‹åªéœ€å®ç°é€‚é…å™¨</li>
<li><strong>ä¾¿äºæµ‹è¯•</strong>: å¯ä»¥ mock é€‚é…å™¨è¿›è¡Œå•å…ƒæµ‹è¯•</li>
<li><strong>å¹³æ»‘è¿ç§»</strong>: å¯ä»¥åœ¨ä¸åŒæ¨¡å‹é—´åˆ‡æ¢ï¼Œä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹</li>
</ul>
<p><strong>å·¥å…·è°ƒç”¨å¾ªç¯çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>é€’å½’æ€æƒ³</strong>: å·¥å…·ç»“æœä½œä¸ºæ–°çš„è¾“å…¥ï¼Œå†æ¬¡è°ƒç”¨ LLM</li>
<li><strong>å¾ªç¯ä¿æŠ¤</strong>: è®¾ç½®æœ€å¤§è°ƒç”¨æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯</li>
<li><strong>ä¸Šä¸‹æ–‡ç´¯ç§¯</strong>: æ‰€æœ‰å·¥å…·è°ƒç”¨ç»“æœéƒ½ä¿ç•™åœ¨å¯¹è¯å†å²ä¸­</li>
<li><strong>æµå¼è¾“å‡º</strong>: è¾¹ç”Ÿæˆè¾¹è¾“å‡ºï¼Œé™ä½æ„ŸçŸ¥å»¶è¿Ÿ</li>
</ul>
<p><strong>é”™è¯¯å¤„ç†ç­–ç•¥:</strong></p>
<ul>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>: å•æ¬¡ LLM è°ƒç”¨æœ€å¤šç­‰å¾… 30 ç§’</li>
<li><strong>é™æµä¿æŠ¤</strong>: éµå®ˆå„å‚å•†çš„ Rate Limit</li>
<li><strong>é™çº§ç­–ç•¥</strong>: ä¸»æ¨¡å‹ä¸å¯ç”¨æ—¶åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹</li>
<li><strong>ç†”æ–­æœºåˆ¶</strong>: è¿ç»­å¤±è´¥åè‡ªåŠ¨åˆ‡æ–­ï¼Œä¿æŠ¤ç³»ç»Ÿ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-7">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å·¥å…·è°ƒç”¨å¾ªç¯å¦‚ä½•é˜²æ­¢æ— é™å¾ªç¯ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>è°ƒç”¨æ¬¡æ•°é™åˆ¶</strong>: æœ€å¤š 5 æ¬¡å·¥å…·è°ƒç”¨</li>
<li><strong>ä¸Šä¸‹æ–‡é•¿åº¦</strong>: æ¯æ¬¡è°ƒç”¨å¢åŠ  Tokenï¼Œè‡ªç„¶é™åˆ¶å¾ªç¯</li>
<li><strong>å·¥å…·è®¾è®¡</strong>: å·¥å…·æœ¬èº«åº”è¯¥æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸ä¼šäº§ç”Ÿå¾ªç¯ä¾èµ–</li>
<li><strong>LLM æŒ‡ä»¤</strong>: åœ¨ System Prompt ä¸­æ˜ç¡®æŒ‡ç¤ºå·¥å…·ä½¿ç”¨è§„åˆ™</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è®¾ç½®äº†ä¸‰é“é˜²çº¿ï¼šç¬¬ä¸€ï¼Œæœ€å¤§è°ƒç”¨æ¬¡æ•°é™åˆ¶ï¼Œè¶…è¿‡ 5 æ¬¡è‡ªåŠ¨ç»ˆæ­¢ï¼›ç¬¬äºŒï¼Œæ¯æ¬¡å·¥å…·è°ƒç”¨éƒ½ä¼šå¢åŠ ä¸Šä¸‹æ–‡é•¿åº¦ï¼ŒToken è¶…é™ä¼šè‡ªç„¶åœæ­¢ï¼›ç¬¬ä¸‰ï¼Œå·¥å…·è®¾è®¡éµå¾ªæ— çŠ¶æ€åŸåˆ™ï¼Œé¿å…å¾ªç¯ä¾èµ–ã€‚åŒæ—¶æˆ‘ä»¬åœ¨ System Prompt ä¸­æ˜ç¡®æŒ‡ç¤º LLM å·¥å…·çš„ä½¿ç”¨åœºæ™¯å’Œè§„åˆ™ï¼Œä»æºå¤´ä¸Šå‡å°‘æ— æ•ˆè°ƒç”¨ã€‚"</p>
</blockquote>
<hr>
<h2 id="35-ç”Ÿäº§çº§ç‰¹æ€§">3.5 ç”Ÿäº§çº§ç‰¹æ€§ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-9">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Python Agent çš„ç”Ÿäº§çº§ç‰¹æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>æ¶ˆæ¯å»é‡</strong>: MessageTracker + Redis</li>
<li><strong>ç†”æ–­ä¿æŠ¤</strong>: CircuitBreaker</li>
<li><strong>å¹¶å‘æ§åˆ¶</strong>: Session Lock + Redis</li>
<li><strong>ä¸Šä¸‹æ–‡ä¿®å‰ª</strong>: ContextPruner</li>
<li><strong>åŠ¨æ€å·¥å…·</strong>: è‡ªåŠ¨å‘ç° + æ³¨å†Œè¡¨</li>
<li><strong>ç›‘æ§åŸ‹ç‚¹</strong>: Prometheus + Metrics</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>: asyncio + é˜Ÿåˆ—</li>
<li><strong>é”™è¯¯é™çº§</strong>: Graceful Degradation</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-9">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>æ¶ˆæ¯å»é‡ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">MessageTracker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ¶ˆæ¯å»é‡ï¼šé˜²æ­¢é‡å¤å¤„ç†"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">is_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">mark_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> ttl<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>key<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
</code></pre><p><strong>ç†”æ–­å™¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ç†”æ–­å™¨æ¨¡å¼ï¼šç³»ç»Ÿè‡ªä¿æŠ¤çš„â€œä¿é™©ä¸â€"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">can_execute</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_state_from_redis<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-if">if</span> state <span class="token operator">==</span> <span class="token string">"OPEN"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>last_failure_time <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>recovery_timeout<span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"HALF_OPEN"</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">record_failure</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•å¤±è´¥ï¼Œè§¦å‘ç†”æ–­"""</span>
        self<span class="token punctuation">.</span>failure_count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>failure_count <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"OPEN"</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>last_failure_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><strong>å¹¶å‘æ§åˆ¶ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">DistributedSemaphore</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åˆ†å¸ƒå¼ä¿¡å·é‡"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">acquire</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        local key = KEYS[1]
        local max_permits = tonumber(ARGV[1])
        local timeout = tonumber(ARGV[2])
        
        local current = redis.call('GET', key) or 0
        if tonumber(current) &lt; max_permits then
            redis.call('INCR', key)
            return 1
        else
            return 0
        end
        """</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_permits<span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-8">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç”Ÿäº§çº§ç‰¹æ€§çš„å…±åŒç›®æ ‡:</strong></p>
<ul>
<li><strong>è‡ªæ„ˆèƒ½åŠ›</strong>: ç³»ç»Ÿèƒ½å¤Ÿä»éƒ¨åˆ†æ•…éšœä¸­è‡ªåŠ¨æ¢å¤</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: å•ç‚¹æ•…éšœä¸å½±å“å…¨å±€</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>: é€šè¿‡æŒ‡æ ‡å’Œæ—¥å¿—äº†è§£ç³»ç»ŸçŠ¶æ€</li>
<li><strong>ä¼˜é›…é™çº§</strong>: æ ¸å¿ƒåŠŸèƒ½ä¿æŒï¼Œéæ ¸å¿ƒåŠŸèƒ½é™çº§</li>
</ul>
<p><strong>é˜²å¾¡æ€§ç¼–ç¨‹çš„å±‚æ¬¡:</strong></p>
<ol>
<li><strong>è¾“å…¥éªŒè¯</strong>: é˜²æ­¢éæ³•è¾“å…¥</li>
<li><strong>å¹¶å‘æ§åˆ¶</strong>: é˜²æ­¢èµ„æºç«äº‰</li>
<li><strong>ç†”æ–­ä¿æŠ¤</strong>: é˜²æ­¢çº§è”æ•…éšœ</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: é˜²æ­¢è¿›ç¨‹å´©æºƒ</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>: åŠæ—¶å‘ç°é—®é¢˜</li>
</ol>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-8">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•ä¿è¯ Python Agent çš„é«˜å¯ç”¨æ€§ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>å¤šå‰¯æœ¬éƒ¨ç½²</strong>: Kubernetes æ°´å¹³æ‰©å±•</li>
<li><strong>ç†”æ–­é™çº§</strong>: å¿«é€Ÿå¤±è´¥ï¼Œä¼˜é›…é™çº§</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>: é˜Ÿåˆ—è§£è€¦ï¼Œå‰Šå³°å¡«è°·</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>: Prometheus + Grafana</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨å¤šå±‚é˜²æŠ¤ï¼šé¦–å…ˆï¼Œé€šè¿‡ Kubernetes éƒ¨ç½²å¤šä¸ªå‰¯æœ¬ï¼Œé…åˆ Service è´Ÿè½½å‡è¡¡ï¼›å…¶æ¬¡ï¼Œç†”æ–­å™¨å’Œé™æµå™¨é˜²æ­¢è¿‡è½½ï¼›ç¬¬ä¸‰ï¼Œå¼‚æ­¥é˜Ÿåˆ—å¤„ç†è€—æ—¶ä»»åŠ¡ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹ï¼›ç¬¬å››ï¼Œå®Œå–„çš„ç›‘æ§ä½“ç³»ï¼ŒåŒ…æ‹¬ QPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ç­‰æŒ‡æ ‡ï¼Œé…åˆ PagerDuty å‘Šè­¦ã€‚é€šè¿‡è¿™äº›æªæ–½ï¼Œæˆ‘ä»¬çš„ Python Agent å¯ä»¥è¾¾åˆ° 99.95% çš„å¯ç”¨æ€§ã€‚"</p>
</blockquote>
<hr>
<h2 id="41-websocket-æœåŠ¡-v2">4.1 WebSocket æœåŠ¡ v2 </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-10">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>WebSocket æœåŠ¡æ˜¯ç§»åŠ¨ç«¯ä¸åç«¯çš„ <strong>å®æ—¶é€šä¿¡æ¡¥æ¢</strong>ï¼Œé‡‡ç”¨ <strong>å•ä¾‹æ¨¡å¼</strong> å’Œ <strong>å“åº”å¼æµ</strong> è®¾è®¡ï¼š</p>
<ul>
<li><strong>å•ä¾‹æ¨¡å¼</strong>: å…¨å±€å”¯ä¸€è¿æ¥ï¼ŒèŠ‚çœèµ„æº</li>
<li><strong>ç¼“å†²é˜Ÿåˆ—</strong>: æ–­å¼€æ—¶æš‚å­˜æ¶ˆæ¯ï¼Œé‡è¿åè‡ªåŠ¨é‡å‘</li>
<li><strong>å“åº”å¼æµ</strong>: StreamController è½¬æ¢ä¸šåŠ¡äº‹ä»¶æµ</li>
<li><strong>æŒ‡æ•°é€€é¿</strong>: 2^n å»¶è¿Ÿï¼Œæœ€é«˜ 32s</li>
<li><strong>æ˜¾å¼å¿ƒè·³</strong>: åº”ç”¨å±‚ä¿æ´»ï¼Œé˜²æ­¢ NAT æ–­è¿</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-10">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/core/services/websocket_chat_service_v2.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">WebSocketChatServiceV2</span> <span class="token punctuation">{</span>
  <span class="token comment">// ã€å•ä¾‹æ¨¡å¼ã€‘: ç¡®ä¿å…¨å±€å”¯ä¸€è¿æ¥ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æº</span>
  <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">WebSocketChatServiceV2</span> _instance <span class="token operator">=</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">.</span><span class="token function">_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-factory">factory</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _instance<span class="token punctuation">;</span>

  <span class="token class-name">WebSocketChannel</span><span class="token operator">?</span> _channel<span class="token punctuation">;</span>
  <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatStreamEvent</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> _messageStreamController<span class="token punctuation">;</span>
  <span class="token class-name">WsConnectionState</span> _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">;</span>

  <span class="token comment">// ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘: è¿æ¥æ–­å¼€æ—¶æš‚å­˜æ¶ˆæ¯ï¼Œé‡è¿åè‡ªåŠ¨é‡å‘ï¼Œä¿è¯â€œé›¶ä¸¢å¤±â€</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> _pendingMessages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// ä¸»æ–¹æ³•ï¼šå‘é€æ¶ˆæ¯å¹¶è¿”å›æµ</span>
  <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatStreamEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token class-name">String</span> message<span class="token punctuation">,</span> required <span class="token class-name">String</span> userId<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _messageStreamController <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatStreamEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>_connectionState <span class="token operator">==</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_establishConnection</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-final">final</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string-literal"><span class="token string">'message'</span></span><span class="token punctuation">:</span> message<span class="token punctuation">,</span>
      <span class="token string-literal"><span class="token string">'user_id'</span></span><span class="token punctuation">:</span> userId<span class="token punctuation">,</span>
      <span class="token string-literal"><span class="token string">'timestamp'</span></span><span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toIso8601String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>isConnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _channel<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
      _pendingMessages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å­˜å…¥ç¼“å†²åŒº</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-return">return</span> _messageStreamController<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_establishConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _channel <span class="token operator">=</span> <span class="token class-name">WebSocketChannel</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">ApiConstants</span><span class="token punctuation">.</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>connecting<span class="token punctuation">;</span>

    _channel<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleDisconnect</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ¡æ‰‹è®¤è¯</span>
    _channel<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-literal"><span class="token string">'type'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'auth'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'token'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Bearer ...'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>connected<span class="token punctuation">;</span>
    
    <span class="token comment">// é‡è¿æˆåŠŸåï¼Œæ¸…ç©ºç¼“å†²åŒº</span>
    <span class="token function">_flushPendingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ã€æŒ‡æ•°é€€é¿é‡è¿ã€‘: é¿å…é«˜é¢‘è¯·æ±‚æ‹–å®ç§»åŠ¨ç«¯ç”µé‡ä¸æœåŠ¡å™¨è´Ÿè½½</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_handleDisconnect</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">;</span>
    int retryCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">periodic</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> retryCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>isConnected <span class="token operator">||</span> retryCount <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token function">_establishConnection</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      retryCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleMessage</span><span class="token punctuation">(</span><span class="token keyword keyword-dynamic">dynamic</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>_messageStreamController <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> event <span class="token operator">=</span> <span class="token class-name">ChatStreamEvent</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _messageStreamController<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _messageStreamController<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">addError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_flushPendingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isConnected <span class="token operator">||</span> _pendingMessages<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> message <span class="token keyword keyword-in">in</span> _pendingMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _channel<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _pendingMessages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool <span class="token keyword keyword-get">get</span> isConnected <span class="token operator">=</span><span class="token operator">&gt;</span> _connectionState <span class="token operator">==</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>connected<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="sparkle-é¡¹ç›®å®æˆ˜åˆ†æ">ã€Sparkle é¡¹ç›®å®æˆ˜åˆ†æã€‘ </h3>
<p><strong>ğŸ¯ å®é™…ä»£ç æ˜ å°„ï¼š</strong></p>
<p>åœ¨ <code>mobile/lib/core/services/websocket_chat_service_v2.dart</code> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å®Œæ•´çš„å®ç°ï¼š</p>
<ol>
<li><strong>å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€å”¯ä¸€</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-static">static</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">WebSocketChatServiceV2</span> _instance <span class="token operator">=</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">.</span><span class="token function">_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-factory">factory</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _instance<span class="token punctuation">;</span>
</code></pre><ol start="2">
<li><strong>ç¼“å†²é˜Ÿåˆ—ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> _pendingMessages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// æ–­å¼€æ—¶å­˜å…¥</span>
_pendingMessages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// é‡è¿åæ¸…ç©º</span>
<span class="token function">_flushPendingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> message <span class="token keyword keyword-in">in</span> _pendingMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _channel<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  _pendingMessages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ol start="3">
<li><strong>æŒ‡æ•°é€€é¿é‡è¿</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">periodic</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> retryCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>isConnected <span class="token operator">||</span> retryCount <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    timer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">_establishConnection</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  retryCount<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ol start="4">
<li><strong>ä¸åç«¯çš„å®Œæ•´æ•°æ®æµ</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="" class="language-text"><code>Flutter App â†’ WebSocketChatServiceV2 â†’ Go Gateway â†’ Python Agent
    â†“              â†“                      â†“              â†“
UI æ›´æ–°      StreamController       WebSocket      gRPC æµ
    â†‘              â†‘                      â†‘              â†‘
ç”¨æˆ·è¾“å…¥     äº‹ä»¶åˆ†å‘å™¨             åè®®è½¬æ¢       AI å¤„ç†
</code></pre><p><strong>æ¶æ„ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>èµ„æºæ•ˆç‡</strong>: å•ä¾‹æ¨¡å¼é¿å…é‡å¤è¿æ¥</li>
<li><strong>ç½‘ç»œå®¹é”™</strong>: ç¼“å†²é˜Ÿåˆ— + æŒ‡æ•°é€€é¿</li>
<li><strong>å“åº”å¼</strong>: Stream API å®ç°äº‹ä»¶é©±åŠ¨</li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: å®æ—¶åé¦ˆ + çŠ¶æ€æŒ‡ç¤º</li>
</ul>
<hr>
<h2 id="42-riverpod-çŠ¶æ€ç®¡ç†">4.2 Riverpod çŠ¶æ€ç®¡ç† </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-11">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Riverpod æ˜¯ Flutter çš„ <strong>å£°æ˜å¼çŠ¶æ€ç®¡ç†æ¡†æ¶</strong>ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ <strong>UI = f(State)</strong>ï¼š</p>
<ul>
<li><strong>å£°æ˜å¼ UI</strong>: çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ UI é‡å»º</li>
<li><strong>ä¸å¯å˜æ•°æ®</strong>: copyWith åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¾¿äºè¿½è¸ª</li>
<li><strong>å•å‘æ•°æ®æµ</strong>: UI â†’ Action â†’ State â†’ UI</li>
<li><strong>Provider æ¶æ„</strong>: ä¾èµ–æ³¨å…¥å’ŒçŠ¶æ€éš”ç¦»</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-11">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/presentation/providers/chat_provider.dart</span>

<span class="token comment">// WebSocket æœåŠ¡ Provider</span>
<span class="token keyword keyword-final">final</span> webSocketServiceProvider <span class="token operator">=</span> <span class="token class-name">Provider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// èŠå¤©çŠ¶æ€ Notifier</span>
<span class="token keyword keyword-final">final</span> chatProvider <span class="token operator">=</span> <span class="token class-name">StateNotifierProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatNotifier</span><span class="token punctuation">,</span> <span class="token class-name">ChatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token class-name">ChatNotifier</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>webSocketServiceProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// èŠå¤©çŠ¶æ€</span>
<span class="token metadata function">@freezed</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ChatState</span> <span class="token keyword keyword-with">with</span> _$<span class="token class-name">ChatState</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-factory">factory</span> <span class="token class-name">ChatState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> bool isLoading<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span> <span class="token class-name">String</span> response<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span> <span class="token class-name">String</span> error<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token class-name">AgentState</span><span class="token operator">?</span> agentStatus<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token operator">?</span> toolCalling<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> bool isTyping<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> _ChatState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// èŠå¤© Notifier</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ChatNotifier</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">StateNotifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatState</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">WebSocketChatServiceV2</span> _wsService<span class="token punctuation">;</span>
  <span class="token class-name">StreamSubscription</span><span class="token operator">?</span> _subscription<span class="token punctuation">;</span>

  <span class="token class-name">ChatNotifier</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_wsService<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword keyword-super">super</span><span class="token punctuation">(</span><span class="token class-name">ChatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// ========== ç¬¬1æ­¥ï¼šæœ¬åœ°çŠ¶æ€å¿«é€Ÿæ›´æ–° ==========</span>
    <span class="token comment">// æ€æƒ³ï¼šå“åº”å¼ç¼–ç¨‹ã€‚ç«‹å³æ›´æ–° UIï¼Œè®©ç”¨æˆ·æ„Ÿè§‰åˆ°æ“ä½œçš„å®æ—¶æ€§ï¼ˆä¹è§‚ UI æ›´æ–°ï¼‰ã€‚</span>
    state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
      messages<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
        <span class="token class-name">ChatMessage</span><span class="token punctuation">(</span>role<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'user'</span></span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> message<span class="token punctuation">,</span> timestamp<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      isLoading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      error<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">,</span>
      response<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== ç¬¬2æ­¥ï¼šé€šè¿‡ WebSocket å‘é€è¯·æ±‚ ==========</span>
    <span class="token comment">// æ•°æ®æµå‘ï¼šUI è¾“å…¥ -&gt; ChatNotifier -&gt; WebSocketService -&gt; Server</span>
    <span class="token keyword keyword-final">final</span> stream <span class="token operator">=</span> _wsService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
      message<span class="token punctuation">:</span> message<span class="token punctuation">,</span>
      userId<span class="token punctuation">:</span> <span class="token function">_getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== ç¬¬3æ­¥ï¼šæµè®¢é˜…ä¸äº‹ä»¶å¤„ç† ==========</span>
    <span class="token comment">// æ€æƒ³ï¼šæµå¼å¤„ç†ã€‚AI çš„å›å¤æ˜¯é€å­—åå‡ºçš„ï¼Œé€šè¿‡ Stream ç›‘å¬å¯ä»¥å®ç°å®æ—¶æ‰“å­—æœºæ•ˆæœã€‚</span>
    <span class="token keyword keyword-await">await</span> _subscription<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _subscription <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleStreamEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onError<span class="token punctuation">:</span> _handleError<span class="token punctuation">,</span>
      onDone<span class="token punctuation">:</span> _handleDone<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleStreamEvent</span><span class="token punctuation">(</span><span class="token class-name">ChatStreamEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ========== ç¬¬4æ­¥ï¼šå¤šç±»å‹äº‹ä»¶åˆ†å‘ ==========</span>
    event<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>
      <span class="token comment">// æ–‡æœ¬äº‹ä»¶ï¼šç´¯åŠ  AI å›å¤å†…å®¹</span>
      text<span class="token punctuation">:</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
          response<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response <span class="token operator">+</span> content<span class="token punctuation">,</span>
          isTyping<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// çŠ¶æ€äº‹ä»¶ï¼šæ˜¾ç¤º AI å½“å‰æ€è€ƒé˜¶æ®µï¼ˆå¦‚ï¼šæœç´¢ä¸­ã€æ‰§è¡Œå·¥å…·ï¼‰</span>
      statusUpdate<span class="token punctuation">:</span> <span class="token punctuation">(</span>agentState<span class="token punctuation">,</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>agentStatus<span class="token punctuation">:</span> agentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// é”™è¯¯äº‹ä»¶ï¼šå¤„ç†æ–­ç½‘ã€åç«¯æŠ¥é”™ç­‰å¼‚å¸¸</span>
      error<span class="token punctuation">:</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>error<span class="token punctuation">:</span> message<span class="token punctuation">,</span> isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// å®Œæˆäº‹ä»¶ï¼šå°†å®Œæ•´å›å¤å­˜å…¥æ¶ˆæ¯å†å²</span>
      done<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      
      <span class="token comment">// å…¶ä»–äº‹ä»¶ (toolStart, toolResult...)</span>
      toolStart<span class="token punctuation">:</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>toolCalling<span class="token punctuation">:</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
      toolResult<span class="token punctuation">:</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
      messages<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
        <span class="token class-name">ChatMessage</span><span class="token punctuation">(</span>
          role<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'assistant'</span></span><span class="token punctuation">,</span>
          content<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response<span class="token punctuation">,</span>
          timestamp<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isTyping<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      response<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleError</span><span class="token punctuation">(</span><span class="token keyword keyword-dynamic">dynamic</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
      error<span class="token punctuation">:</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isTyping<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="sparkle-é¡¹ç›®å®æˆ˜åˆ†æ-1">ã€Sparkle é¡¹ç›®å®æˆ˜åˆ†æã€‘ </h3>
<p><strong>ğŸ¯ å®é™…ä»£ç æ˜ å°„ï¼š</strong></p>
<p>åœ¨ <code>mobile/lib/presentation/providers/chat_provider.dart</code> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å®Œæ•´çš„çŠ¶æ€ç®¡ç†å®ç°ï¼š</p>
<ol>
<li><strong>Provider ä¾èµ–æ³¨å…¥</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-final">final</span> webSocketServiceProvider <span class="token operator">=</span> <span class="token class-name">Provider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-final">final</span> chatProvider <span class="token operator">=</span> <span class="token class-name">StateNotifierProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatNotifier</span><span class="token punctuation">,</span> <span class="token class-name">ChatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token class-name">ChatNotifier</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>webSocketServiceProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ol start="2">
<li><strong>ä¸å¯å˜çŠ¶æ€ä¸ä¹è§‚æ›´æ–°</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// ç«‹å³æ›´æ–° UIï¼ˆä¹è§‚æ›´æ–°ï¼‰</span>
state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
  messages<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">,</span> userMessage<span class="token punctuation">]</span><span class="token punctuation">,</span>
  isLoading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// åå°å‘é€è¯·æ±‚</span>
<span class="token keyword keyword-final">final</span> stream <span class="token operator">=</span> _wsService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ol start="3">
<li><strong>äº‹ä»¶é©±åŠ¨çš„æµå¤„ç†</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code>_subscription <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleStreamEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
  onError<span class="token punctuation">:</span> _handleError<span class="token punctuation">,</span>
  onDone<span class="token punctuation">:</span> _handleDone<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ol start="4">
<li><strong>å¤šç±»å‹äº‹ä»¶åˆ†å‘</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code>event<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>
  text<span class="token punctuation">:</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>response<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">,</span>
  statusUpdate<span class="token punctuation">:</span> <span class="token punctuation">(</span>agentState<span class="token punctuation">,</span> details<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>agentStatus<span class="token punctuation">:</span> agentState<span class="token punctuation">)</span><span class="token punctuation">,</span>
  error<span class="token punctuation">:</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>error<span class="token punctuation">:</span> message<span class="token punctuation">,</span> isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  done<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>æ¶æ„ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>å£°æ˜å¼</strong>: UI è‡ªåŠ¨å“åº”çŠ¶æ€å˜åŒ–</li>
<li><strong>å¯æµ‹è¯•</strong>: Notifier å¯ç‹¬ç«‹æµ‹è¯•</li>
<li><strong>å¯è¿½è¸ª</strong>: æ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½æœ‰æ˜ç¡®æ¥æº</li>
<li><strong>æ€§èƒ½</strong>: å±€éƒ¨åˆ·æ–°ï¼Œé¿å…å…¨å±é‡å»º</li>
</ul>
<hr>
<h2 id="43-ui-ç»„ä»¶ç³»ç»Ÿ">4.3 UI ç»„ä»¶ç³»ç»Ÿ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-12">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle çš„ UI ç»„ä»¶ç³»ç»Ÿé‡‡ç”¨ <strong>å£°æ˜å¼</strong> å’Œ <strong>æ‡’åŠ è½½</strong> è®¾è®¡ï¼š</p>
<ul>
<li><strong>å£°æ˜å¼ UI</strong>: æ•°æ®é©±åŠ¨ï¼Œè‡ªåŠ¨åˆ·æ–°</li>
<li><strong>æ‡’åŠ è½½</strong>: ListView.builder å»¶è¿Ÿæ¸²æŸ“</li>
<li><strong>çŠ¶æ€æŒ‡ç¤ºå™¨</strong>: THINKING, GENERATING, EXECUTING_TOOL ç­‰çŠ¶æ€å¯è§†åŒ–</li>
<li><strong>æµå¼è¾“å‡º</strong>: å®æ—¶æ‰“å­—æœºæ•ˆæœ</li>
<li><strong>é”™è¯¯æç¤º</strong>: SnackBar å’Œå‹å¥½é”™è¯¯ä¿¡æ¯</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-12">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/presentation/screens/chat_screen.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">ChatScreen</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">ConsumerWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">,</span> <span class="token class-name">WidgetRef</span> ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. å£°æ˜å¼ç›‘å¬</span>
    <span class="token comment">// æ€æƒ³ï¼šæ•°æ®é©±åŠ¨ã€‚å½“ chatProvider çš„ state å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™ä¸ª build å‡½æ•°ä¼šè‡ªåŠ¨é‡æ–°è¿è¡Œã€‚</span>
    <span class="token keyword keyword-final">final</span> chatState <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>chatProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> <span class="token class-name">Scaffold</span><span class="token punctuation">(</span>
      body<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// 2. æ¶ˆæ¯å±•ç¤º (ListView.builder)</span>
          <span class="token comment">// æ€æƒ³ï¼šæŒ‰éœ€åŠ è½½ã€‚å³ä½¿æœ‰å‡ åƒæ¡æ¶ˆæ¯ï¼Œä¹Ÿåªæ¸²æŸ“å½“å‰å±å¹•æ˜¾ç¤ºçš„å‡ ä¸ª Itemã€‚</span>
          <span class="token class-name">Expanded</span><span class="token punctuation">(</span>
            child<span class="token punctuation">:</span> <span class="token class-name">ListView</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
              itemCount<span class="token punctuation">:</span> chatState<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
              itemBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">MessageBubble</span><span class="token punctuation">(</span>
                message<span class="token punctuation">:</span> chatState<span class="token punctuation">.</span>messages<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          
          <span class="token comment">// 3. å®æ—¶å“åº”å±•ç¤º</span>
          <span class="token comment">// æ€æƒ³ï¼šå±€éƒ¨åˆ·æ–°ã€‚</span>
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>chatState<span class="token punctuation">.</span>isTyping<span class="token punctuation">)</span> <span class="token function">_buildStatusPanel</span><span class="token punctuation">(</span>chatState<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">_buildInputArea</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ref<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>chatProvider<span class="token punctuation">.</span>notifier<span class="token punctuation">)</span><span class="token punctuation">,</span> chatState<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Widget</span> <span class="token function">_buildStatusPanel</span><span class="token punctuation">(</span><span class="token class-name">ChatState</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>
      padding<span class="token punctuation">:</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">.</span>shade50<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Row</span><span class="token punctuation">(</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token class-name">CircularProgressIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token function">_getStatusText</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>agentStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">String</span> <span class="token function">_getStatusText</span><span class="token punctuation">(</span><span class="token class-name">AgentState</span><span class="token operator">?</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>thinking<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'AI æ­£åœ¨æ€è€ƒ...'</span></span><span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>searching<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'æœç´¢çŸ¥è¯†åº“...'</span></span><span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>executingTool<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'æ‰§è¡Œå·¥å…·...'</span></span><span class="token punctuation">;</span>
      <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ç”Ÿæˆå›å¤ä¸­...'</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ï¼š</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">MessageBubble</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">ChatMessage</span> message<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> isUser <span class="token operator">=</span> message<span class="token punctuation">.</span>role <span class="token operator">==</span> <span class="token string-literal"><span class="token string">'user'</span></span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-return">return</span> <span class="token class-name">Align</span><span class="token punctuation">(</span>
      alignment<span class="token punctuation">:</span> isUser <span class="token operator">?</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>centerRight <span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>centerLeft<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>
        margin<span class="token punctuation">:</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">symmetric</span><span class="token punctuation">(</span>vertical<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> horizontal<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        padding<span class="token punctuation">:</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        decoration<span class="token punctuation">:</span> <span class="token class-name">BoxDecoration</span><span class="token punctuation">(</span>
          color<span class="token punctuation">:</span> isUser <span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">.</span>shade100 <span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">.</span>shade200<span class="token punctuation">,</span>
          borderRadius<span class="token punctuation">:</span> <span class="token class-name">BorderRadius</span><span class="token punctuation">.</span><span class="token function">circular</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
          crossAxisAlignment<span class="token punctuation">:</span> <span class="token class-name">CrossAxisAlignment</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span>
          children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token class-name">Text</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>timestamp <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span>
              <span class="token class-name">Text</span><span class="token punctuation">(</span>
                <span class="token class-name">DateFormat</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'HH:mm'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>timestamp<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>fontSize<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="sparkle-é¡¹ç›®å®æˆ˜åˆ†æ-2">ã€Sparkle é¡¹ç›®å®æˆ˜åˆ†æã€‘ </h3>
<p><strong>ğŸ¯ å®é™…ä»£ç æ˜ å°„ï¼š</strong></p>
<p>åœ¨ <code>mobile/lib/presentation/screens/chat_screen.dart</code> å’Œç›¸å…³ç»„ä»¶ä¸­ï¼š</p>
<ol>
<li><strong>å£°æ˜å¼ UI æ„å»º</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// è‡ªåŠ¨å“åº”çŠ¶æ€å˜åŒ–</span>
<span class="token keyword keyword-final">final</span> chatState <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>chatProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ¡ä»¶æ¸²æŸ“</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>chatState<span class="token punctuation">.</span>isTyping<span class="token punctuation">)</span> <span class="token function">_buildStatusPanel</span><span class="token punctuation">(</span>chatState<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><ol start="2">
<li><strong>æ‡’åŠ è½½åˆ—è¡¨</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token class-name">ListView</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
  itemCount<span class="token punctuation">:</span> chatState<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
  itemBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">MessageBubble</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre><ol start="3">
<li><strong>çŠ¶æ€æŒ‡ç¤ºå™¨</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// æ˜¾ç¤º AI å½“å‰çŠ¶æ€</span>
<span class="token class-name">String</span> <span class="token function">_getStatusText</span><span class="token punctuation">(</span><span class="token class-name">AgentState</span><span class="token operator">?</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>thinking<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'AI æ­£åœ¨æ€è€ƒ...'</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>searching<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'æœç´¢çŸ¥è¯†åº“...'</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>executingTool<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'æ‰§è¡Œå·¥å…·...'</span></span><span class="token punctuation">;</span>
    <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ç”Ÿæˆå›å¤ä¸­...'</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ol start="4">
<li><strong>æµå¼æ‰“å­—æœºæ•ˆæœ</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// é€šè¿‡ç´¯åŠ å®ç°æ‰“å­—æœºæ•ˆæœ</span>
text<span class="token punctuation">:</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
    response<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response <span class="token operator">+</span> content<span class="token punctuation">,</span>
    isTyping<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>æ¶æ„ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>é«˜æ€§èƒ½</strong>: åªæ¸²æŸ“å¯è§é¡¹</li>
<li><strong>å“åº”å¼</strong>: è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ DOM</li>
<li><strong>å¯ç»„åˆ</strong>: Widget å¯åµŒå¥—ç»„åˆ</li>
<li><strong>å¯æµ‹è¯•</strong>: å•ä¸€èŒè´£ï¼Œæ˜“äºå•å…ƒæµ‹è¯•</li>
</ul>
<hr>
<h2 id="44-çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–">4.4 çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ– </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-13">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–æ˜¯ Sparkle çš„æ ¸å¿ƒç‰¹è‰²ï¼Œä½¿ç”¨ <strong>Canvas API</strong> å’Œ <strong>GLSL ç€è‰²å™¨</strong> å®ç°é«˜æ€§èƒ½å›¾å½¢æ¸²æŸ“ï¼š</p>
<ul>
<li><strong>Canvas API</strong>: åº•å±‚ Skia ç»˜å›¾å¼•æ“ï¼Œé«˜æ€§èƒ½ 2D æ¸²æŸ“</li>
<li><strong>GLSL ç€è‰²å™¨</strong>: GPU åŠ é€Ÿï¼Œå®ç°ç«ç„°ã€å‘å…‰ã€ç²’å­æ•ˆæœ</li>
<li><strong>CustomPainter</strong>: é«˜æ€§èƒ½å›¾å½¢æ¸²æŸ“ï¼Œæ”¯æŒå¤æ‚åŠ¨ç”»</li>
<li><strong>æ•°æ®å¯è§†åŒ–</strong>: æŒæ¡åº¦ç¯ã€æ˜ŸåŸŸåˆ†ç±»ã€å…³ç³»è¿çº¿</li>
<li><strong>äº¤äº’è®¾è®¡</strong>: ç¼©æ”¾ã€æ‹–æ‹½ã€ç‚¹å‡»è¯¦æƒ…</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-13">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/presentation/widgets/galaxy/star_map_painter.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">StarMapPainter</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomPainter</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GalaxyNodeModel</span><span class="token punctuation">&gt;</span></span> nodes<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GalaxyEdgeModel</span><span class="token punctuation">&gt;</span></span> edges<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">&gt;</span></span> positions<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> double scale<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">AggregationLevel</span> aggregationLevel<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ClusterInfo</span><span class="token punctuation">&gt;</span></span> clusters<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Rect</span><span class="token operator">?</span> viewport<span class="token punctuation">;</span>  <span class="token comment">// å¯é€‰è§†å£ç”¨äºè£å‰ª</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Offset</span> center<span class="token punctuation">;</span>   <span class="token comment">// å®‡å®™ä¸­å¿ƒç‚¹</span>

  <span class="token comment">// Pre-processed data (computed once in constructor)</span>
  late <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessedNode</span><span class="token punctuation">&gt;</span></span> _processedNodes<span class="token punctuation">;</span>
  late <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessedEdge</span><span class="token punctuation">&gt;</span></span> _processedEdges<span class="token punctuation">;</span>
  late <span class="token keyword keyword-final">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Color</span><span class="token punctuation">&gt;</span></span> _colorCache<span class="token punctuation">;</span>
  late <span class="token keyword keyword-final">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Offset</span><span class="token punctuation">&gt;</span></span> _positionCache<span class="token punctuation">;</span>

  <span class="token class-name">StarMapPainter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>nodes<span class="token punctuation">,</span>
    required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>positions<span class="token punctuation">,</span> <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>edges <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>scale <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>aggregationLevel <span class="token operator">=</span> <span class="token class-name">AggregationLevel</span><span class="token punctuation">.</span>full<span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>clusters <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>viewport<span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>center <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">_preprocessData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Pre-process all data in the constructor to avoid repeated work in paint()</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_preprocessData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Build caches</span>
    _colorCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    _positionCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> node <span class="token keyword keyword-in">in</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä½¿ç”¨æ˜ŸåŸŸè‰²ç³»ï¼šåŸºäºèŠ‚ç‚¹çš„æ˜ŸåŸŸã€é‡è¦ç¨‹åº¦å’ŒæŒæ¡åº¦ç”Ÿæˆé¢œè‰²</span>
      _colorCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">SectorConfig</span><span class="token punctuation">.</span><span class="token function">getNodeColor</span><span class="token punctuation">(</span>
        sector<span class="token punctuation">:</span> node<span class="token punctuation">.</span>sector<span class="token punctuation">,</span>
        importance<span class="token punctuation">:</span> node<span class="token punctuation">.</span>importance<span class="token punctuation">,</span>
        masteryScore<span class="token punctuation">:</span> node<span class="token punctuation">.</span>masteryScore<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> pos <span class="token operator">=</span> positions<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pos <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _positionCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> pos<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Build processed nodes with viewport culling</span>
    _processedNodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> node <span class="token keyword keyword-in">in</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> pos <span class="token operator">=</span> _positionCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>

      <span class="token comment">// Viewport culling</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>viewport <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pos<span class="token punctuation">.</span>dx <span class="token operator">&lt;</span> viewport<span class="token operator">!</span><span class="token punctuation">.</span>left <span class="token operator">-</span> <span class="token number">50</span> <span class="token operator">||</span>
            pos<span class="token punctuation">.</span>dx <span class="token operator">&gt;</span> viewport<span class="token operator">!</span><span class="token punctuation">.</span>right <span class="token operator">+</span> <span class="token number">50</span> <span class="token operator">||</span>
            pos<span class="token punctuation">.</span>dy <span class="token operator">&lt;</span> viewport<span class="token operator">!</span><span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token number">50</span> <span class="token operator">||</span>
            pos<span class="token punctuation">.</span>dy <span class="token operator">&gt;</span> viewport<span class="token operator">!</span><span class="token punctuation">.</span>bottom <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword keyword-final">final</span> color <span class="token operator">=</span> _colorCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> radius <span class="token operator">=</span> node<span class="token punctuation">.</span>radius<span class="token punctuation">;</span>
      _processedNodes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ProcessedNode</span><span class="token punctuation">(</span>
        node<span class="token punctuation">:</span> node<span class="token punctuation">,</span>
        color<span class="token punctuation">:</span> color<span class="token punctuation">,</span>
        radius<span class="token punctuation">:</span> radius<span class="token punctuation">,</span>
        position<span class="token punctuation">:</span> pos<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Build processed edges</span>
    _processedEdges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// First, add edges from the edges list</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> edge <span class="token keyword keyword-in">in</span> edges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> start <span class="token operator">=</span> _positionCache<span class="token punctuation">[</span>edge<span class="token punctuation">.</span>sourceId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> end <span class="token operator">=</span> _positionCache<span class="token punctuation">[</span>edge<span class="token punctuation">.</span>targetId<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>

      <span class="token comment">// Viewport culling for edges</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>viewport <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> edgeRect <span class="token operator">=</span> <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromPoints</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>edgeRect<span class="token punctuation">.</span><span class="token function">overlaps</span><span class="token punctuation">(</span>viewport<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword keyword-final">final</span> sourceColor <span class="token operator">=</span> _colorCache<span class="token punctuation">[</span>edge<span class="token punctuation">.</span>sourceId<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> targetColor <span class="token operator">=</span> _colorCache<span class="token punctuation">[</span>edge<span class="token punctuation">.</span>targetId<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> distance <span class="token operator">=</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> style <span class="token operator">=</span> _RelationStyle<span class="token punctuation">.</span><span class="token function">forType</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>relationType<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> strokeWidth <span class="token operator">=</span> style<span class="token punctuation">.</span>baseWidth <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.5</span> <span class="token operator">+</span> edge<span class="token punctuation">.</span>strength <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      _processedEdges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ProcessedEdge</span><span class="token punctuation">(</span>
        edge<span class="token punctuation">:</span> edge<span class="token punctuation">,</span>
        start<span class="token punctuation">:</span> start<span class="token punctuation">,</span>
        end<span class="token punctuation">:</span> end<span class="token punctuation">,</span>
        startColor<span class="token punctuation">:</span> sourceColor<span class="token punctuation">,</span>
        endColor<span class="token punctuation">:</span> targetColor<span class="token punctuation">,</span>
        distance<span class="token punctuation">:</span> distance<span class="token punctuation">,</span>
        strokeWidth<span class="token punctuation">:</span> strokeWidth<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Also add parent-child connections if not already in edges</span>
    <span class="token keyword keyword-final">final</span> edgeKeys <span class="token operator">=</span> edges<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>sourceId</span><span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">e<span class="token punctuation">.</span>targetId</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> node <span class="token keyword keyword-in">in</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>parentId <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> key <span class="token operator">=</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">node<span class="token punctuation">.</span>parentId</span><span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">node<span class="token punctuation">.</span>id</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>edgeKeys<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-final">final</span> start <span class="token operator">=</span> _positionCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>parentId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-final">final</span> end <span class="token operator">=</span> _positionCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>

        <span class="token comment">// Viewport culling</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>viewport <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-final">final</span> edgeRect <span class="token operator">=</span> <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromPoints</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>edgeRect<span class="token punctuation">.</span><span class="token function">overlaps</span><span class="token punctuation">(</span>viewport<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-final">final</span> parentColor <span class="token operator">=</span> _colorCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>parentId<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">;</span>
        <span class="token keyword keyword-final">final</span> childColor <span class="token operator">=</span> _colorCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">;</span>
        <span class="token keyword keyword-final">final</span> distance <span class="token operator">=</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">.</span>distance<span class="token punctuation">;</span>

        _processedEdges<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ProcessedEdge</span><span class="token punctuation">(</span>
          edge<span class="token punctuation">:</span> <span class="token class-name">GalaxyEdgeModel</span><span class="token punctuation">(</span>
            id<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'parent_</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">key</span></span><span class="token string">'</span></span><span class="token punctuation">,</span>
            sourceId<span class="token punctuation">:</span> node<span class="token punctuation">.</span>parentId<span class="token operator">!</span><span class="token punctuation">,</span>
            targetId<span class="token punctuation">:</span> node<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
            relationType<span class="token punctuation">:</span> <span class="token class-name">EdgeRelationType</span><span class="token punctuation">.</span>parentChild<span class="token punctuation">,</span>
            strength<span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          start<span class="token punctuation">:</span> start<span class="token punctuation">,</span>
          end<span class="token punctuation">:</span> end<span class="token punctuation">,</span>
          startColor<span class="token punctuation">:</span> parentColor<span class="token punctuation">,</span>
          endColor<span class="token punctuation">:</span> childColor<span class="token punctuation">,</span>
          distance<span class="token punctuation">:</span> distance<span class="token punctuation">,</span>
          strokeWidth<span class="token punctuation">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Size</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>aggregationLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AggregationLevel</span><span class="token punctuation">.</span>full<span class="token punctuation">:</span>
        <span class="token function">_drawRootConnections</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_drawEdges</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_drawNodes</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AggregationLevel</span><span class="token punctuation">.</span>clustered<span class="token punctuation">:</span>
        <span class="token function">_drawRootConnections</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Also draw roots in clustered view? Maybe not.</span>
        <span class="token function">_drawClusteredView</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AggregationLevel</span><span class="token punctuation">.</span>sectors<span class="token punctuation">:</span>
        <span class="token function">_drawSectorView</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw connections from Universe Center to Sector Roots</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawRootConnections</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> node <span class="token keyword keyword-in">in</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>parentId <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> pos <span class="token operator">=</span> _positionCache<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>pos <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>

        <span class="token keyword keyword-final">final</span> sectorColor <span class="token operator">=</span> <span class="token class-name">SectorConfig</span><span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>sector<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// Gradient from invisible center to colored node</span>
        <span class="token keyword keyword-final">final</span> gradient <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>Gradient</span><span class="token punctuation">.</span><span class="token function">linear</span><span class="token punctuation">(</span>
          center<span class="token punctuation">,</span>
          pos<span class="token punctuation">,</span>
          <span class="token punctuation">[</span>
            sectorColor<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sectorColor<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        paint<span class="token punctuation">.</span>shader <span class="token operator">=</span> gradient<span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">drawLine</span><span class="token punctuation">(</span>center<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw all edges with relationship-specific styling</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawEdges</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> processedEdge <span class="token keyword keyword-in">in</span> _processedEdges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_drawEdge</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> processedEdge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw a single edge with relationship-aware styling</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawEdge</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">ProcessedEdge</span> edge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> style <span class="token operator">=</span> _RelationStyle<span class="token punctuation">.</span><span class="token function">forType</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>relationType<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>style<span class="token punctuation">.</span>isDashed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_drawDashedEdge</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> edge<span class="token punctuation">,</span> style<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
      <span class="token function">_drawSolidEdge</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> edge<span class="token punctuation">,</span> style<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Draw arrow for directed relationships</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>relationType <span class="token operator">==</span> <span class="token class-name">EdgeRelationType</span><span class="token punctuation">.</span>prerequisite <span class="token operator">||</span>
        edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>relationType <span class="token operator">==</span> <span class="token class-name">EdgeRelationType</span><span class="token punctuation">.</span>derived<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_drawArrow</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> edge<span class="token punctuation">.</span>start<span class="token punctuation">,</span> edge<span class="token punctuation">.</span>end<span class="token punctuation">,</span> style<span class="token punctuation">.</span>color<span class="token punctuation">,</span> edge<span class="token punctuation">.</span>strokeWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw a solid edge with gradient</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawSolidEdge</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">ProcessedEdge</span> edge<span class="token punctuation">,</span> _RelationStyle style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Gradient from source to target</span>
    <span class="token keyword keyword-final">final</span> gradient <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>Gradient</span><span class="token punctuation">.</span><span class="token function">linear</span><span class="token punctuation">(</span>
      edge<span class="token punctuation">.</span>start<span class="token punctuation">,</span>
      edge<span class="token punctuation">.</span>end<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>startColor<span class="token punctuation">,</span> style<span class="token punctuation">.</span>color<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.6</span> <span class="token operator">*</span> edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>strength<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>endColor<span class="token punctuation">,</span> style<span class="token punctuation">.</span>color<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.3</span> <span class="token operator">*</span> edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>strength<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>shader <span class="token operator">=</span> gradient
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> edge<span class="token punctuation">.</span>strokeWidth
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeCap <span class="token operator">=</span> <span class="token class-name">StrokeCap</span><span class="token punctuation">.</span>round<span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawLine</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>start<span class="token punctuation">,</span> edge<span class="token punctuation">.</span>end<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Subtle glow effect</span>
    <span class="token keyword keyword-final">final</span> glowPaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>shader <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>Gradient</span><span class="token punctuation">.</span><span class="token function">linear</span><span class="token punctuation">(</span>
        edge<span class="token punctuation">.</span>start<span class="token punctuation">,</span>
        edge<span class="token punctuation">.</span>end<span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          style<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.15</span> <span class="token operator">*</span> edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>strength<span class="token punctuation">)</span><span class="token punctuation">,</span>
          style<span class="token punctuation">.</span>color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.05</span> <span class="token operator">*</span> edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>strength<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> edge<span class="token punctuation">.</span>strokeWidth <span class="token operator">*</span> <span class="token number">3</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeCap <span class="token operator">=</span> <span class="token class-name">StrokeCap</span><span class="token punctuation">.</span>round
      <span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawLine</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>start<span class="token punctuation">,</span> edge<span class="token punctuation">.</span>end<span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw a dashed edge</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawDashedEdge</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">ProcessedEdge</span> edge<span class="token punctuation">,</span> _RelationStyle style<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Color</span><span class="token punctuation">.</span><span class="token function">lerp</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>startColor<span class="token punctuation">,</span> style<span class="token punctuation">.</span>color<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.5</span> <span class="token operator">*</span> edge<span class="token punctuation">.</span>edge<span class="token punctuation">.</span>strength<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> edge<span class="token punctuation">.</span>strokeWidth
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeCap <span class="token operator">=</span> <span class="token class-name">StrokeCap</span><span class="token punctuation">.</span>round<span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> path <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> direction <span class="token operator">=</span> edge<span class="token punctuation">.</span>end <span class="token operator">-</span> edge<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> length <span class="token operator">=</span> direction<span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> unitDir <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>direction<span class="token punctuation">.</span>dx <span class="token operator">/</span> length<span class="token punctuation">,</span> direction<span class="token punctuation">.</span>dy <span class="token operator">/</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    double currentLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    bool drawing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> dashLength <span class="token operator">=</span> style<span class="token punctuation">.</span>dashLength<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> gapLength <span class="token operator">=</span> style<span class="token punctuation">.</span>dashLength <span class="token operator">*</span> <span class="token number">0.6</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>currentLength <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> segmentLength <span class="token operator">=</span> drawing
          <span class="token operator">?</span> math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>dashLength<span class="token punctuation">,</span> length <span class="token operator">-</span> currentLength<span class="token punctuation">)</span>
          <span class="token punctuation">:</span> math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>gapLength<span class="token punctuation">,</span> length <span class="token operator">-</span> currentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>drawing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> startPoint <span class="token operator">=</span> edge<span class="token punctuation">.</span>start <span class="token operator">+</span> unitDir <span class="token operator">*</span> currentLength<span class="token punctuation">;</span>
        <span class="token keyword keyword-final">final</span> endPoint <span class="token operator">=</span> edge<span class="token punctuation">.</span>start <span class="token operator">+</span> unitDir <span class="token operator">*</span> <span class="token punctuation">(</span>currentLength <span class="token operator">+</span> segmentLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
        path<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>startPoint<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> startPoint<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        path<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>endPoint<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> endPoint<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      currentLength <span class="token operator">+=</span> segmentLength<span class="token punctuation">;</span>
      drawing <span class="token operator">=</span> <span class="token operator">!</span>drawing<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw an arrow at the end of an edge</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawArrow</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">Offset</span> start<span class="token punctuation">,</span> <span class="token class-name">Offset</span> end<span class="token punctuation">,</span> <span class="token class-name">Color</span> color<span class="token punctuation">,</span> double strokeWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> direction <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> length <span class="token operator">=</span> direction<span class="token punctuation">.</span>distance<span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> unitDir <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>direction<span class="token punctuation">.</span>dx <span class="token operator">/</span> length<span class="token punctuation">,</span> direction<span class="token punctuation">.</span>dy <span class="token operator">/</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> perpDir <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span>unitDir<span class="token punctuation">.</span>dy<span class="token punctuation">,</span> unitDir<span class="token punctuation">.</span>dx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> arrowSize <span class="token operator">=</span> strokeWidth <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> arrowPoint <span class="token operator">=</span> end <span class="token operator">-</span> unitDir <span class="token operator">*</span> <span class="token number">15</span><span class="token punctuation">;</span>  <span class="token comment">// Offset from node</span>

    <span class="token keyword keyword-final">final</span> arrowPath <span class="token operator">=</span> <span class="token class-name">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span>arrowPoint<span class="token punctuation">.</span>dx<span class="token punctuation">,</span> arrowPoint<span class="token punctuation">.</span>dy<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>
        arrowPoint<span class="token punctuation">.</span>dx <span class="token operator">-</span> unitDir<span class="token punctuation">.</span>dx <span class="token operator">*</span> arrowSize <span class="token operator">+</span> perpDir<span class="token punctuation">.</span>dx <span class="token operator">*</span> arrowSize <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
        arrowPoint<span class="token punctuation">.</span>dy <span class="token operator">-</span> unitDir<span class="token punctuation">.</span>dy <span class="token operator">*</span> arrowSize <span class="token operator">+</span> perpDir<span class="token punctuation">.</span>dy <span class="token operator">*</span> arrowSize <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span>
        arrowPoint<span class="token punctuation">.</span>dx <span class="token operator">-</span> unitDir<span class="token punctuation">.</span>dx <span class="token operator">*</span> arrowSize <span class="token operator">-</span> perpDir<span class="token punctuation">.</span>dx <span class="token operator">*</span> arrowSize <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
        arrowPoint<span class="token punctuation">.</span>dy <span class="token operator">-</span> unitDir<span class="token punctuation">.</span>dy <span class="token operator">*</span> arrowSize <span class="token operator">-</span> perpDir<span class="token punctuation">.</span>dy <span class="token operator">*</span> arrowSize <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill<span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>arrowPath<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw clustered view - parent nodes as larger circles with child count</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawClusteredView</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> nodePaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> glowPaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">12.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> strokePaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> cluster <span class="token keyword keyword-in">in</span> clusters<span class="token punctuation">.</span>values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> pos <span class="token operator">=</span> cluster<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> style <span class="token operator">=</span> <span class="token class-name">SectorConfig</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>sector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> color <span class="token operator">=</span> style<span class="token punctuation">.</span>primaryColor<span class="token punctuation">;</span>

      <span class="token comment">// Cluster size based on node count (logarithmic scaling)</span>
      <span class="token keyword keyword-final">final</span> baseRadius <span class="token operator">=</span> <span class="token number">15.0</span> <span class="token operator">+</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>nodeCount<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> masteryFactor <span class="token operator">=</span> cluster<span class="token punctuation">.</span>totalMastery <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">;</span>

      <span class="token comment">// Outer glow</span>
      glowPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token punctuation">(</span>masteryFactor <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> baseRadius <span class="token operator">*</span> <span class="token number">2.5</span><span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Inner glow</span>
      glowPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token punctuation">(</span>masteryFactor <span class="token operator">*</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      glowPaint<span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">6.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> baseRadius <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      glowPaint<span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">12.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Main circle with gradient fill</span>
      <span class="token keyword keyword-final">final</span> gradient <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>Gradient</span><span class="token punctuation">.</span><span class="token function">radial</span><span class="token punctuation">(</span>
        pos<span class="token punctuation">,</span>
        baseRadius<span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodePaint<span class="token punctuation">.</span>shader <span class="token operator">=</span> gradient<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> baseRadius<span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodePaint<span class="token punctuation">.</span>shader <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>

      <span class="token comment">// Border ring</span>
      strokePaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> baseRadius<span class="token punctuation">,</span> strokePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Node count badge</span>
      <span class="token function">_drawClusterBadge</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> baseRadius<span class="token punctuation">,</span> cluster<span class="token punctuation">.</span>nodeCount<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Cluster name</span>
      <span class="token function">_drawClusterLabel</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> cluster<span class="token punctuation">.</span>name<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> baseRadius<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw node count badge on cluster</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawClusterBadge</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">Offset</span> pos<span class="token punctuation">,</span> double radius<span class="token punctuation">,</span> int count<span class="token punctuation">,</span> <span class="token class-name">Color</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> badgePos <span class="token operator">=</span> pos <span class="token operator">+</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>radius <span class="token operator">*</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token operator">-</span>radius <span class="token operator">*</span> <span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-const">const</span> badgeRadius <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>

    <span class="token comment">// Badge background</span>
    <span class="token keyword keyword-final">final</span> badgePaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill<span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>badgePos<span class="token punctuation">,</span> badgeRadius<span class="token punctuation">,</span> badgePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Badge border</span>
    badgePaint
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>badgePos<span class="token punctuation">,</span> badgeRadius<span class="token punctuation">,</span> badgePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Count text</span>
    <span class="token keyword keyword-final">final</span> textSpan <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> count <span class="token operator">&gt;</span> <span class="token number">99</span> <span class="token operator">?</span> <span class="token string-literal"><span class="token string">'99+'</span></span> <span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">count</span></span><span class="token string">'</span></span><span class="token punctuation">,</span>
      style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
        color<span class="token punctuation">:</span> color<span class="token punctuation">,</span>
        fontSize<span class="token punctuation">:</span> count <span class="token operator">&gt;</span> <span class="token number">99</span> <span class="token operator">?</span> <span class="token number">7</span> <span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
        fontWeight<span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>bold<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> textPainter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> textSpan<span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>
      canvas<span class="token punctuation">,</span>
      badgePos <span class="token operator">-</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>textPainter<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> textPainter<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw cluster label</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawClusterLabel</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Offset</span> pos<span class="token punctuation">,</span> double radius<span class="token punctuation">,</span> <span class="token class-name">Color</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> textSpan <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> name<span class="token punctuation">,</span>
      style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
        color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        fontSize<span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
        fontWeight<span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>w600<span class="token punctuation">,</span>
        shadows<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token class-name">Shadow</span><span class="token punctuation">(</span>
            color<span class="token punctuation">:</span> color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            blurRadius<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> textPainter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> textSpan<span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span>textPainter<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> radius <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw sector-level view - only sector centroids</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawSectorView</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> nodePaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> glowPaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> cluster <span class="token keyword keyword-in">in</span> clusters<span class="token punctuation">.</span>values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> pos <span class="token operator">=</span> cluster<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> style <span class="token operator">=</span> <span class="token class-name">SectorConfig</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>sector<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> color <span class="token operator">=</span> style<span class="token punctuation">.</span>primaryColor<span class="token punctuation">;</span>

      <span class="token comment">// Large sector centroid</span>
      <span class="token keyword keyword-final">final</span> baseRadius <span class="token operator">=</span> <span class="token number">30.0</span> <span class="token operator">+</span> <span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>nodeCount<span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> masteryFactor <span class="token operator">=</span> cluster<span class="token punctuation">.</span>totalMastery <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">;</span>

      <span class="token comment">// Large outer glow</span>
      glowPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token punctuation">(</span>masteryFactor <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> baseRadius <span class="token operator">*</span> <span class="token number">3.5</span><span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Mid glow</span>
      glowPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token punctuation">(</span>masteryFactor <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      glowPaint<span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">12.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> baseRadius <span class="token operator">*</span> <span class="token number">2.0</span><span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      glowPaint<span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Core with radial gradient</span>
      <span class="token keyword keyword-final">final</span> gradient <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>Gradient</span><span class="token punctuation">.</span><span class="token function">radial</span><span class="token punctuation">(</span>
        pos<span class="token punctuation">,</span>
        baseRadius<span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          color<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodePaint<span class="token punctuation">.</span>shader <span class="token operator">=</span> gradient<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> baseRadius<span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nodePaint<span class="token punctuation">.</span>shader <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>

      <span class="token comment">// Sector name (larger)</span>
      <span class="token keyword keyword-final">final</span> textSpan <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>
        text<span class="token punctuation">:</span> style<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
          color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">,</span>
          fontSize<span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
          fontWeight<span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>bold<span class="token punctuation">,</span>
          shadows<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token class-name">Shadow</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> color<span class="token punctuation">,</span>
              blurRadius<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Shadow</span><span class="token punctuation">(</span>
              color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              blurRadius<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> textPainter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
        text<span class="token punctuation">:</span> textSpan<span class="token punctuation">,</span>
        textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      textPainter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      textPainter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span>textPainter<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> baseRadius <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Node count subtitle</span>
      <span class="token keyword keyword-final">final</span> countSpan <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>
        text<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">${</span><span class="token expression">cluster<span class="token punctuation">.</span>nodeCount</span><span class="token punctuation">}</span></span><span class="token string"> ä¸ªçŸ¥è¯†ç‚¹'</span></span><span class="token punctuation">,</span>
        style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
          color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withAlpha</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          fontSize<span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> countPainter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
        text<span class="token punctuation">:</span> countSpan<span class="token punctuation">,</span>
        textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      countPainter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      countPainter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span>countPainter<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> baseRadius <span class="token operator">+</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw all nodes using preprocessed data</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawNodes</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> nodePaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>fill<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> glowPaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">8.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> ringPaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeCap <span class="token operator">=</span> <span class="token class-name">StrokeCap</span><span class="token punctuation">.</span>round<span class="token punctuation">;</span>

    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> processedNode <span class="token keyword keyword-in">in</span> _processedNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> node <span class="token operator">=</span> processedNode<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> pos <span class="token operator">=</span> processedNode<span class="token punctuation">.</span>position<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> color <span class="token operator">=</span> processedNode<span class="token punctuation">.</span>color<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> radius <span class="token operator">=</span> processedNode<span class="token punctuation">.</span>radius<span class="token punctuation">;</span>

      <span class="token comment">// LOD: Skip small nodes when zoomed out significantly</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&lt;</span> <span class="token number">0.3</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>importance <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nodePaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>isUnlocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Calculate mastery-based glow intensity</span>
        <span class="token keyword keyword-final">final</span> masteryFactor <span class="token operator">=</span> node<span class="token punctuation">.</span>masteryScore <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-final">final</span> glowIntensity <span class="token operator">=</span> <span class="token number">0.3</span> <span class="token operator">+</span> masteryFactor <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

        <span class="token comment">// Outer glow (soft, large)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Only draw glow if not too zoomed out</span>
          glowPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> glowIntensity <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">3.0</span><span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Inner glow (brighter, smaller)</span>
        glowPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> glowIntensity <span class="token operator">*</span> <span class="token number">0.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        glowPaint<span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">1.8</span><span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        glowPaint<span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">8.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Core fill with gradient</span>
        <span class="token keyword keyword-final">final</span> nodeGradient <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">ui<span class="token punctuation">.</span></span>Gradient</span><span class="token punctuation">.</span><span class="token function">radial</span><span class="token punctuation">(</span>
          pos<span class="token punctuation">,</span>
          radius<span class="token punctuation">,</span>
          <span class="token punctuation">[</span>
            <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            color<span class="token punctuation">,</span>
            color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodePaint<span class="token punctuation">.</span>shader <span class="token operator">=</span> nodeGradient<span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodePaint<span class="token punctuation">.</span>shader <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>

        <span class="token comment">// Progress Ring Logic (Study Count)</span>
        <span class="token comment">// 0: No ring (or very faint)</span>
        <span class="token comment">// 1: Half ring (Accumulating energy)</span>
        <span class="token comment">// &gt;=2: Full ring + Glow (Ready to expand)</span>
        
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&gt;</span> <span class="token number">0.4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Only draw rings if visible enough</span>
          <span class="token keyword keyword-final">final</span> ringRadius <span class="token operator">=</span> radius <span class="token operator">*</span> <span class="token number">1.6</span><span class="token punctuation">;</span>
          
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>studyCount <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// Full Energy Ring</span>
             ringPaint
              <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">2.0</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-const">const</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>solid<span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Glowy stroke</span>
             
             canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> ringRadius<span class="token punctuation">,</span> ringPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
             
             <span class="token comment">// Extra "Pulse" ring for expansion ready</span>
             ringPaint
              <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">1.0</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
             canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> ringRadius <span class="token operator">*</span> <span class="token number">1.1</span><span class="token punctuation">,</span> ringPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
             
          <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>studyCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// Half Energy Ring</span>
             ringPaint
              <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.6</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">1.5</span>
              <span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
              
             <span class="token comment">// Draw arc from -90 (top) to 90 (bottom) - right side</span>
             canvas<span class="token punctuation">.</span><span class="token function">drawArc</span><span class="token punctuation">(</span>
               <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromCircle</span><span class="token punctuation">(</span>center<span class="token punctuation">:</span> pos<span class="token punctuation">,</span> radius<span class="token punctuation">:</span> ringRadius<span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token operator">-</span>math<span class="token punctuation">.</span>pi <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> 
               math<span class="token punctuation">.</span>pi<span class="token punctuation">,</span> 
               <span class="token boolean">false</span><span class="token punctuation">,</span> 
               ringPaint<span class="token punctuation">,</span>
             <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Bright center highlight (mastery indicator)</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>masteryFactor <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword keyword-final">final</span> highlightRadius <span class="token operator">=</span> radius <span class="token operator">*</span> <span class="token number">0.4</span> <span class="token operator">*</span> masteryFactor<span class="token punctuation">;</span>
          nodePaint<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.6</span> <span class="token operator">+</span> masteryFactor <span class="token operator">*</span> <span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> highlightRadius<span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

      <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Locked: Grey dim with subtle indication</span>
        nodePaint<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">0.8</span><span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Very subtle glow for locked nodes</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&gt;</span> <span class="token number">0.6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          glowPaint<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Text Label (LOD)</span>
      <span class="token comment">// Zoom &gt; 0.8: Show all labels</span>
      <span class="token comment">// Zoom &gt; 0.5: Show importance &gt;= 3</span>
      <span class="token comment">// Zoom &lt;= 0.5: Show importance &gt;= 4 only</span>
      bool shouldDrawLabel <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&gt;</span> <span class="token number">0.8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shouldDrawLabel <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shouldDrawLabel <span class="token operator">=</span> node<span class="token punctuation">.</span>importance <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
        shouldDrawLabel <span class="token operator">=</span> node<span class="token punctuation">.</span>importance <span class="token operator">&gt;=</span> <span class="token number">4</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>shouldDrawLabel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_drawNodeLabel</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> node<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Draw node label with sector-aware styling</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_drawNodeLabel</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> <span class="token class-name">GalaxyNodeModel</span> node<span class="token punctuation">,</span> <span class="token class-name">Offset</span> pos<span class="token punctuation">,</span> <span class="token class-name">Color</span> color<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> sectorStyle <span class="token operator">=</span> <span class="token class-name">SectorConfig</span><span class="token punctuation">.</span><span class="token function">getStyle</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>sector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> textColor <span class="token operator">=</span> node<span class="token punctuation">.</span>isUnlocked
        <span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> textSpan <span class="token operator">=</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> node<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
        color<span class="token punctuation">:</span> textColor<span class="token punctuation">,</span>
        fontSize<span class="token punctuation">:</span> node<span class="token punctuation">.</span>importance <span class="token operator">&gt;=</span> <span class="token number">4</span> <span class="token operator">?</span> <span class="token number">12</span> <span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        fontWeight<span class="token punctuation">:</span> node<span class="token punctuation">.</span>isUnlocked <span class="token operator">?</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>w600 <span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>w400<span class="token punctuation">,</span>
        shadows<span class="token punctuation">:</span> node<span class="token punctuation">.</span>isUnlocked
            <span class="token operator">?</span> <span class="token punctuation">[</span>
                <span class="token class-name">Shadow</span><span class="token punctuation">(</span>
                  color<span class="token punctuation">:</span> sectorStyle<span class="token punctuation">.</span>primaryColor<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  blurRadius<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword keyword-const">const</span> <span class="token class-name">Shadow</span><span class="token punctuation">(</span>
                  color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>black54<span class="token punctuation">,</span>
                  blurRadius<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">]</span>
            <span class="token punctuation">:</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> textPainter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> textSpan<span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> pos <span class="token operator">+</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span><span class="token operator">-</span>textPainter<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>radius <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token keyword keyword-covariant">covariant</span> <span class="token class-name">StarMapPainter</span> oldDelegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only repaint if data actually changed</span>
    <span class="token keyword keyword-return">return</span> oldDelegate<span class="token punctuation">.</span>nodes <span class="token operator">!=</span> nodes <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>edges <span class="token operator">!=</span> edges <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>positions <span class="token operator">!=</span> positions <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>scale <span class="token operator">!=</span> scale <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>aggregationLevel <span class="token operator">!=</span> aggregationLevel <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>clusters <span class="token operator">!=</span> clusters <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>viewport <span class="token operator">!=</span> viewport<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="sparkle-é¡¹ç›®å®æˆ˜åˆ†æ-3">ã€Sparkle é¡¹ç›®å®æˆ˜åˆ†æã€‘ </h3>
<p><strong>ğŸ¯ å®é™…ä»£ç æ˜ å°„ï¼š</strong></p>
<p>åœ¨ <code>mobile/lib/presentation/widgets/galaxy/star_map_painter.dart</code> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å®Œæ•´çš„å¯è§†åŒ–å®ç°ï¼š</p>
<ol>
<li><strong>æ€§èƒ½ä¼˜åŒ– - é¢„å¤„ç†</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// åœ¨æ„é€ å‡½æ•°ä¸­é¢„å¤„ç†æ‰€æœ‰æ•°æ®ï¼Œé¿å…åœ¨ paint() ä¸­é‡å¤è®¡ç®—</span>
<span class="token class-name">StarMapPainter</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_preprocessData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰èŠ‚ç‚¹ã€è¾¹ã€é¢œè‰²ç¼“å­˜</span>
<span class="token punctuation">}</span>
</code></pre><ol start="2">
<li><strong>LODï¼ˆç»†èŠ‚å±‚æ¬¡ï¼‰æ§åˆ¶</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// ä½ç¼©æ”¾çº§åˆ«åªæ˜¾ç¤ºé‡è¦èŠ‚ç‚¹</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>scale <span class="token operator">&lt;</span> <span class="token number">0.3</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>importance <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  nodePaint<span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">withValues</span><span class="token punctuation">(</span>alpha<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> radius <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-continue">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><ol start="3">
<li><strong>æŒæ¡åº¦å¯è§†åŒ–</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// äº®åº¦ = 0.3 + (æŒæ¡åº¦/100) * 0.7</span>
<span class="token keyword keyword-final">final</span> masteryFactor <span class="token operator">=</span> node<span class="token punctuation">.</span>masteryScore <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
<span class="token keyword keyword-final">final</span> glowIntensity <span class="token operator">=</span> <span class="token number">0.3</span> <span class="token operator">+</span> masteryFactor <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>

<span class="token comment">// è¿›åº¦ç¯ï¼šå­¦ä¹ æ¬¡æ•° &gt;=2 æ˜¾ç¤ºå®Œæ•´ç¯</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>studyCount <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> ringRadius<span class="token punctuation">,</span> ringPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// å®Œæ•´èƒ½é‡ç¯</span>
<span class="token punctuation">}</span>
</code></pre><ol start="4">
<li><strong>å…³ç³»ç±»å‹å¯è§†åŒ–</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// ä¸åŒå…³ç³»ç±»å‹ä½¿ç”¨ä¸åŒé¢œè‰²å’Œæ ·å¼</span>
<span class="token keyword keyword-final">final</span> style <span class="token operator">=</span> _RelationStyle<span class="token punctuation">.</span><span class="token function">forType</span><span class="token punctuation">(</span>edge<span class="token punctuation">.</span>relationType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å‰ç½®çŸ¥è¯†ï¼šè“è‰²å®çº¿ + ç®­å¤´</span>
<span class="token comment">// ç›¸å…³çŸ¥è¯†ï¼šæ©™è‰²è™šçº¿</span>
<span class="token comment">// çˆ¶å­å…³ç³»ï¼šç™½è‰²å®çº¿</span>
</code></pre><ol start="5">
<li><strong>äº¤äº’å®ç°</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// ç¼©æ”¾å’Œæ‹–æ‹½</span>
<span class="token keyword keyword-void">void</span> <span class="token function">_handleScaleUpdate</span><span class="token punctuation">(</span><span class="token class-name">ScaleUpdateDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _zoom <span class="token operator">=</span> <span class="token punctuation">(</span>_zoom <span class="token operator">*</span> details<span class="token punctuation">.</span>scale<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _offset <span class="token operator">=</span> _offset <span class="token operator">+</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ç‚¹å‡»æ£€æµ‹</span>
<span class="token keyword keyword-void">void</span> <span class="token function">_handleTap</span><span class="token punctuation">(</span><span class="token class-name">TapUpDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> tappedNode <span class="token operator">=</span> _nodes<span class="token punctuation">.</span><span class="token function">firstWhere</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> distance <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">pow</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>x <span class="token operator">-</span> galaxyX<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>y <span class="token operator">-</span> galaxyY<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword keyword-return">return</span> distance <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>radius<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>æ¶æ„ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>é«˜æ€§èƒ½</strong>: é¢„å¤„ç† + LOD + è§†å£è£å‰ª</li>
<li><strong>è§†è§‰ä¸°å¯Œ</strong>: æ¸å˜ã€å‘å…‰ã€è¿›åº¦ç¯ã€å…³ç³»çº¿</li>
<li><strong>äº¤äº’æµç•…</strong>: æ‰‹åŠ¿è¯†åˆ« + æ€§èƒ½ä¼˜åŒ–</li>
<li><strong>æ•°æ®é©±åŠ¨</strong>: å“åº”å¼æ›´æ–°ï¼Œè‡ªåŠ¨é‡ç»˜</li>
</ul>
<hr>
<h1 id="äº”-æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ">äº”ã€æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ </h1>
<h2 id="51-æ ¸å¿ƒè¡¨ç»“æ„">5.1 æ ¸å¿ƒè¡¨ç»“æ„ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-14">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle é‡‡ç”¨ <strong>æ··åˆå­˜å‚¨æ¶æ„</strong>ï¼Œå°†å…³ç³»å‹æ•°æ®å’Œå‘é‡æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨ PostgreSQL + pgvector ä¸­ï¼š</p>
<ul>
<li><strong>çŸ¥è¯†ç³»ç»Ÿ</strong>: çŸ¥è¯†èŠ‚ç‚¹ + å‘é‡åµŒå…¥ + å›¾å…³ç³»</li>
<li><strong>ç”¨æˆ·ç³»ç»Ÿ</strong>: ç”¨æˆ·ä¿¡æ¯ + ä»»åŠ¡ + è®¡åˆ’</li>
<li><strong>æ¨é€ç³»ç»Ÿ</strong>: åå¥½é…ç½® + å†å²è®°å½•</li>
<li><strong>ç¤¾åŒºç³»ç»Ÿ</strong>: å¸–å­ + ç‚¹èµå…³ç³»</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-14">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>çŸ¥è¯†ç³»ç»Ÿæ ¸å¿ƒè¡¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ============================================</span>
<span class="token comment">-- çŸ¥è¯†èŠ‚ç‚¹è¡¨ (Knowledge Nodes)</span>
<span class="token comment">-- å­˜å‚¨çŸ¥è¯†ç‚¹åŠå…¶å‘é‡åµŒå…¥ï¼Œå®ç°â€œè¯­ä¹‰æœç´¢â€</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> knowledge_nodes <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    name <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    description <span class="token keyword keyword-TEXT">TEXT</span><span class="token punctuation">,</span>
    <span class="token comment">-- å‘é‡åµŒå…¥ (pgvector): å­˜å‚¨ 1536 ç»´è¯­ä¹‰å‘é‡</span>
    embedding VECTOR<span class="token punctuation">(</span><span class="token number">1536</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    importance_level <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">,</span>
    category <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    parent_id UUID <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-CONSTRAINT">CONSTRAINT</span> chk_importance <span class="token keyword keyword-CHECK">CHECK</span> <span class="token punctuation">(</span>importance_level <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">AND</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ã€ç”Ÿäº§çº§ä¼˜åŒ–ã€‘: HNSW ç´¢å¼• (Hierarchical Navigable Small World)</span>
<span class="token comment">-- ç¼–ç¨‹æ€æƒ³ï¼šç©ºé—´åˆ†å‰²ä¸è¿‘ä¼¼æœç´¢ã€‚åœ¨å¤§è§„æ¨¡å‘é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°è¯­ä¹‰æœ€è¿‘é‚»ã€‚</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_knowledge_nodes_embedding_hnsw
<span class="token keyword keyword-ON">ON</span> knowledge_nodes <span class="token keyword keyword-USING">USING</span> hnsw <span class="token punctuation">(</span>embedding vector_cosine_ops<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> ef_construction <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> ef_search <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- èŠ‚ç‚¹å…³ç³»è¡¨ (Node Relations)</span>
<span class="token comment">-- çŸ¥è¯†å›¾è°±è¾¹ï¼Œå­˜å‚¨èŠ‚ç‚¹é—´å…³ç³»</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> node_relations <span class="token punctuation">(</span>
    source_node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    target_node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    relation_type <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    strength <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    created_by <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'system'</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token punctuation">(</span>source_node_id<span class="token punctuation">,</span> target_node_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-CONSTRAINT">CONSTRAINT</span> chk_relation_type <span class="token keyword keyword-CHECK">CHECK</span> <span class="token punctuation">(</span>relation_type <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token string">'prerequisite'</span><span class="token punctuation">,</span> <span class="token string">'related'</span><span class="token punctuation">,</span> <span class="token string">'parent'</span><span class="token punctuation">,</span> <span class="token string">'child'</span><span class="token punctuation">,</span> <span class="token string">'similar'</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ç´¢å¼•ï¼ˆå›¾éå†ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_node_relations_source <span class="token keyword keyword-ON">ON</span> node_relations<span class="token punctuation">(</span>source_node_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_node_relations_target <span class="token keyword keyword-ON">ON</span> node_relations<span class="token punctuation">(</span>target_node_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- ç”¨æˆ·èŠ‚ç‚¹çŠ¶æ€è¡¨ (User Node Status)</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> user_node_status <span class="token punctuation">(</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    mastery_score <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    study_count <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    last_study_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>
    next_review_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> node_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ã€æ€§èƒ½ä¼˜åŒ–ã€‘: éƒ¨åˆ†ç´¢å¼• (Partial Index)</span>
<span class="token comment">-- ç¼–ç¨‹æ€æƒ³ï¼šåªå¯¹â€œå¾…å¤ä¹ â€çš„æ´»è·ƒæ•°æ®å»ºç«‹ç´¢å¼•ï¼Œæå¤§åœ°ç¼©å°ç´¢å¼•ä½“ç§¯ï¼ŒåŠ é€ŸæŸ¥è¯¢ã€‚</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_user_node_status_review_active
<span class="token keyword keyword-ON">ON</span> user_node_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> next_review_at<span class="token punctuation">)</span>
<span class="token keyword keyword-WHERE">WHERE</span> next_review_at <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- å­¦ä¹ è®°å½•è¡¨ (Study Records) - æŒ‰æ—¶é—´åˆ†åŒº</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    study_minutes <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    mastery_delta <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    study_method <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    completed_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-BY">BY</span> RANGE <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- æœˆåº¦åˆ†åŒºç¤ºä¾‹</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records_2025_12 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> study_records
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-FROM">FROM</span> <span class="token punctuation">(</span><span class="token string">'2025-12-01'</span><span class="token punctuation">)</span> <span class="token keyword keyword-TO">TO</span> <span class="token punctuation">(</span><span class="token string">'2026-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ†åŒºç´¢å¼•</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_user_time
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>ç”¨æˆ·ä¸ä»»åŠ¡ç³»ç»Ÿï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ============================================</span>
<span class="token comment">-- ç”¨æˆ·è¡¨ (Users)</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> users <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    email <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword keyword-UNIQUE">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    nickname <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    avatar_url <span class="token keyword keyword-TEXT">TEXT</span><span class="token punctuation">,</span>
    flame_level <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">-- Proç­‰çº§</span>
    preferences JSONB <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'{}'</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- ä»»åŠ¡è¡¨ (Tasks) - 6ç§ç±»å‹</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TYPE">TYPE</span> tasktype <span class="token keyword keyword-AS">AS</span> <span class="token keyword keyword-ENUM">ENUM</span> <span class="token punctuation">(</span>
    <span class="token string">'LEARNING'</span><span class="token punctuation">,</span>      <span class="token comment">-- å­¦ä¹ ä»»åŠ¡</span>
    <span class="token string">'TRAINING'</span><span class="token punctuation">,</span>      <span class="token comment">-- è®­ç»ƒä»»åŠ¡</span>
    <span class="token string">'ERROR_FIX'</span><span class="token punctuation">,</span>     <span class="token comment">-- é”™é¢˜ä¿®å¤</span>
    <span class="token string">'REFLECTION'</span><span class="token punctuation">,</span>    <span class="token comment">-- åæ€æ€»ç»“</span>
    <span class="token string">'SOCIAL'</span><span class="token punctuation">,</span>        <span class="token comment">-- ç¤¾äº¤å­¦ä¹ </span>
    <span class="token string">'PLANNING'</span>       <span class="token comment">-- è®¡åˆ’åˆ¶å®š</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TYPE">TYPE</span> taskstatus <span class="token keyword keyword-AS">AS</span> <span class="token keyword keyword-ENUM">ENUM</span> <span class="token punctuation">(</span>
    <span class="token string">'PENDING'</span><span class="token punctuation">,</span> <span class="token string">'IN_PROGRESS'</span><span class="token punctuation">,</span> <span class="token string">'COMPLETED'</span><span class="token punctuation">,</span> <span class="token string">'CANCELLED'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> tasks <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    plan_id UUID<span class="token punctuation">,</span>
    title <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-type">type</span> tasktype <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    tags JSONB <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'[]'</span><span class="token punctuation">,</span>
    estimated_minutes <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    difficulty <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-status">status</span> taskstatus <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'PENDING'</span><span class="token punctuation">,</span>
    knowledge_node_id UUID <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    auto_expand_enabled <span class="token keyword keyword-BOOLEAN">BOOLEAN</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    due_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>

    <span class="token keyword keyword-CONSTRAINT">CONSTRAINT</span> chk_difficulty <span class="token keyword keyword-CHECK">CHECK</span> <span class="token punctuation">(</span>difficulty <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">AND</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_tasks_user_status <span class="token keyword keyword-ON">ON</span> tasks<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token keyword keyword-status">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_tasks_type <span class="token keyword keyword-ON">ON</span> tasks<span class="token punctuation">(</span><span class="token keyword keyword-type">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- æ¨é€åå¥½ (Push Preferences)</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> push_preferences <span class="token punctuation">(</span>
    user_id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-REFERENCES">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    active_slots JSONB <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'[{"start": "08:00", "end": "22:00"}]'</span><span class="token punctuation">,</span>
    timezone <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'Asia/Shanghai'</span><span class="token punctuation">,</span>
    enable_curiosity <span class="token keyword keyword-BOOLEAN">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    persona_type <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'STUDENT'</span><span class="token punctuation">,</span>
    daily_cap <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">3</span><span class="token punctuation">,</span>
    last_push_time <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>
    consecutive_ignores <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>ğŸ¯ Sparkle é¡¹ç›®å®æˆ˜åˆ†æï¼šæ•°æ®åº“æ¨¡å‹ä¸ ORM æ˜ å°„</strong></p>
<p>åœ¨ <code>backend/app/models/galaxy.py</code> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å®Œæ•´çš„ ORM æ¨¡å‹å®šä¹‰ï¼š</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/models/galaxy.py</span>

<span class="token keyword keyword-from">from</span> sqlalchemy <span class="token keyword keyword-import">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Float<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Boolean<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">,</span> JSON
<span class="token keyword keyword-from">from</span> sqlalchemy<span class="token punctuation">.</span>dialects<span class="token punctuation">.</span>postgresql <span class="token keyword keyword-import">import</span> UUID<span class="token punctuation">,</span> VECTOR
<span class="token keyword keyword-from">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword keyword-import">import</span> relationship
<span class="token keyword keyword-from">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword keyword-import">import</span> declarative_base

Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">KnowledgeNode</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""çŸ¥è¯†èŠ‚ç‚¹æ¨¡å‹ - å¯¹åº” knowledge_nodes è¡¨"""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'knowledge_nodes'</span>
    
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    description <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">)</span>
    <span class="token comment"># 1536 ç»´å‘é‡åµŒå…¥ï¼ˆOpenAI embeddingï¼‰</span>
    embedding <span class="token operator">=</span> Column<span class="token punctuation">(</span>VECTOR<span class="token punctuation">(</span><span class="token number">1536</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    importance_level <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    category <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'knowledge_nodes.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    is_seed <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    source_type <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 'system', 'user_created', 'ai_generated'</span>
    
    <span class="token comment"># å…³ç³»å®šä¹‰</span>
    parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'KnowledgeNode'</span><span class="token punctuation">,</span> remote_side<span class="token operator">=</span><span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    children <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'KnowledgeNode'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">)</span>
    relations <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'NodeRelation'</span><span class="token punctuation">,</span> foreign_keys<span class="token operator">=</span><span class="token string">'NodeRelation.source_node_id'</span><span class="token punctuation">)</span>
    user_statuses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'UserNodeStatus'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'node'</span><span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">UserNodeStatus</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ç”¨æˆ·èŠ‚ç‚¹çŠ¶æ€ - å¯¹åº” user_node_status è¡¨"""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_node_status'</span>
    
    user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    node_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    mastery_score <span class="token operator">=</span> Column<span class="token punctuation">(</span>Float<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span>
    study_count <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    total_study_minutes <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    last_study_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>
    next_review_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>
    is_unlocked <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    is_collapsed <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    is_favorite <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    decay_paused <span class="token operator">=</span> Column<span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token comment"># å…³ç³»</span>
    node <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'KnowledgeNode'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user_statuses'</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'node_statuses'</span><span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">NodeRelation</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""èŠ‚ç‚¹å…³ç³» - å¯¹åº” node_relations è¡¨"""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'node_relations'</span>
    
    source_node_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'knowledge_nodes.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    target_node_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'knowledge_nodes.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    relation_type <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># prerequisite, related, parent, child, similar</span>
    strength <span class="token operator">=</span> Column<span class="token punctuation">(</span>Float<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>
    created_by <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'system'</span><span class="token punctuation">)</span>
    created_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span>
    
    <span class="token comment"># å…³ç³»</span>
    source <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'KnowledgeNode'</span><span class="token punctuation">,</span> foreign_keys<span class="token operator">=</span><span class="token punctuation">[</span>source_node_id<span class="token punctuation">]</span><span class="token punctuation">)</span>
    target <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'KnowledgeNode'</span><span class="token punctuation">,</span> foreign_keys<span class="token operator">=</span><span class="token punctuation">[</span>target_node_id<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">StudyRecord</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å­¦ä¹ è®°å½• - å¯¹åº” study_records è¡¨ï¼ˆåˆ†åŒºè¡¨ï¼‰"""</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'study_records'</span>
    
    <span class="token builtin">id</span> <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">)</span>
    user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    node_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    task_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>UUID<span class="token punctuation">(</span>as_uuid<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    study_minutes <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    mastery_delta <span class="token operator">=</span> Column<span class="token punctuation">(</span>Float<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    record_type <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 'task_complete', 'manual_study'</span>
    completed_at <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span>
    
    <span class="token comment"># é€šè¿‡ viewonly å…³ç³»é¿å… ORM è‡ªåŠ¨åŠ è½½</span>
    <span class="token comment"># å®é™…æŸ¥è¯¢ä½¿ç”¨ join æˆ– raw SQL</span>
</code></pre><p><strong>æ•°æ®åº“è®¾è®¡ä¼˜åŠ¿ä½“ç°ï¼š</strong></p>
<ol>
<li><strong>æ··åˆå­˜å‚¨ç­–ç•¥</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># åœ¨ backend/app/services/galaxy_service.py ä¸­</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">spark_node</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> UUID<span class="token punctuation">,</span> study_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. åŒæ—¶æ›´æ–°å…³ç³»å‹æ•°æ®å’Œå‘é‡æ•°æ®</span>
    <span class="token comment"># 2. ä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§</span>
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-with">with</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>begin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># æ›´æ–°ç”¨æˆ·çŠ¶æ€ï¼ˆå…³ç³»å‹ï¼‰</span>
        status <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_or_create_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> node_id<span class="token punctuation">)</span>
        status<span class="token punctuation">.</span>mastery_score <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>mastery_score <span class="token operator">+</span> delta<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
        
        <span class="token comment"># è®°å½•å­¦ä¹ å†å²ï¼ˆåˆ†åŒºè¡¨ï¼‰</span>
        record <span class="token operator">=</span> StudyRecord<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>record<span class="token punctuation">)</span>
        
        <span class="token comment"># è§¦å‘çŸ¥è¯†å›¾è°±æ›´æ–°ï¼ˆå¼‚æ­¥ï¼‰</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>expansion_service<span class="token punctuation">.</span>queue_expansion<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>
</code></pre><ol start="2">
<li><strong>ç´¢å¼•ä¼˜åŒ–å®è·µ</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># åœ¨ backend/app/services/galaxy_service.py ä¸­</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_vector_search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> embedding<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å‘é‡æœç´¢ - ä½¿ç”¨ HNSW ç´¢å¼•"""</span>
    <span class="token keyword keyword-from">from</span> pgvector<span class="token punctuation">.</span>sqlalchemy <span class="token keyword keyword-import">import</span> Vector
    
    query <span class="token operator">=</span> <span class="token punctuation">(</span>
        select<span class="token punctuation">(</span>
            KnowledgeNode<span class="token punctuation">,</span>
            KnowledgeNode<span class="token punctuation">.</span>embedding<span class="token punctuation">.</span>cosine_distance<span class="token punctuation">(</span>embedding<span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">'distance'</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span>where<span class="token punctuation">(</span>KnowledgeNode<span class="token punctuation">.</span>embedding<span class="token punctuation">.</span>isnot<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">'distance'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>limit<span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_keyword_search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å…³é”®è¯æœç´¢ - ä½¿ç”¨ GIN ç´¢å¼•"""</span>
    stmt <span class="token operator">=</span> <span class="token punctuation">(</span>
        select<span class="token punctuation">(</span>KnowledgeNode<span class="token punctuation">)</span>
        <span class="token punctuation">.</span>where<span class="token punctuation">(</span>
            or_<span class="token punctuation">(</span>
                KnowledgeNode<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                KnowledgeNode<span class="token punctuation">.</span>description<span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                func<span class="token punctuation">.</span>json_extract_path_text<span class="token punctuation">(</span>KnowledgeNode<span class="token punctuation">.</span>keywords<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"%</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span>limit<span class="token punctuation">(</span>limit<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>stmt<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span>scalars<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><ol start="3">
<li><strong>åˆ†åŒºè¡¨ç®¡ç†</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># åœ¨ backend/scripts/ ä¸­æœ‰è‡ªåŠ¨åˆ†åŒºç®¡ç†è„šæœ¬</span>
<span class="token comment"># backend/scripts/manage_partitions.py</span>

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">create_monthly_partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è‡ªåŠ¨åˆ›å»ºä¸‹æœˆåˆ†åŒº"""</span>
    next_month <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> relativedelta<span class="token punctuation">(</span>months<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    partition_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"study_records_</span><span class="token interpolation"><span class="token punctuation">{</span>next_month<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y_%m'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    start_date <span class="token operator">=</span> next_month<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>day<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    end_date <span class="token operator">=</span> <span class="token punctuation">(</span>start_date <span class="token operator">+</span> relativedelta<span class="token punctuation">(</span>months<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>day<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    CREATE TABLE IF NOT EXISTS </span><span class="token interpolation"><span class="token punctuation">{</span>partition_name<span class="token punctuation">}</span></span><span class="token string"> PARTITION OF study_records
    FOR VALUES FROM ('</span><span class="token interpolation"><span class="token punctuation">{</span>start_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">') TO ('</span><span class="token interpolation"><span class="token punctuation">{</span>end_date<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">')
    """</span></span>
    
    <span class="token comment"># åˆ›å»ºåˆ†åŒºç´¢å¼•</span>
    index_sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    CREATE INDEX IF NOT EXISTS idx_</span><span class="token interpolation"><span class="token punctuation">{</span>partition_name<span class="token punctuation">}</span></span><span class="token string">_user_time 
    ON </span><span class="token interpolation"><span class="token punctuation">{</span>partition_name<span class="token punctuation">}</span></span><span class="token string">(user_id, completed_at DESC)
    """</span></span>
    
    <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>index_sql<span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="52-ç´¢å¼•ç­–ç•¥">5.2 ç´¢å¼•ç­–ç•¥ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-15">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle é‡‡ç”¨ <strong>å¤šç»´ç´¢å¼•ç­–ç•¥</strong>ï¼Œé’ˆå¯¹ä¸åŒæ•°æ®ç‰¹å¾é€‰æ‹©æœ€ä¼˜ç´¢å¼•ï¼š</p>
<ul>
<li><strong>B-Tree</strong>: ç²¾ç¡®åŒ¹é…å’ŒèŒƒå›´æŸ¥è¯¢</li>
<li><strong>HNSW</strong>: é«˜ç»´å‘é‡è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢</li>
<li><strong>BRIN</strong>: æ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–</li>
<li><strong>éƒ¨åˆ†ç´¢å¼•</strong>: åªç´¢å¼•æ´»è·ƒæ•°æ®</li>
<li><strong>è¦†ç›–ç´¢å¼•</strong>: é¿å…å›è¡¨</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-15">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 1. å‘é‡æœç´¢ä¼˜åŒ–ï¼ˆHNSW ç´¢å¼•ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_knowledge_nodes_embedding_hnsw
<span class="token keyword keyword-ON">ON</span> knowledge_nodes
<span class="token keyword keyword-USING">USING</span> hnsw <span class="token punctuation">(</span>embedding vector_cosine_ops<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> ef_construction <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> ef_search <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- å‚æ•°è¯´æ˜:</span>
<span class="token comment">-- m = 16: æ¯ä¸ªèŠ‚ç‚¹çš„é‚»å±…æ•°ï¼Œå¹³è¡¡ç²¾åº¦ä¸å†…å­˜</span>
<span class="token comment">-- ef_construction = 64: æ„å»ºæ—¶çš„æœç´¢èŒƒå›´ï¼Œè¶Šé«˜ç²¾åº¦è¶Šå¥½</span>
<span class="token comment">-- ef_search = 40: æŸ¥è¯¢æ—¶çš„æœç´¢èŒƒå›´ï¼Œå½±å“å¬å›ç‡</span>

<span class="token comment">-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_user_node_status_active
<span class="token keyword keyword-ON">ON</span> user_node_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> mastery_score<span class="token punctuation">)</span>
<span class="token keyword keyword-WHERE">WHERE</span> mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: ç´¢å¼•ä½“ç§¯å°ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«</span>
<span class="token comment">-- é€‚ç”¨: åªéœ€è¦æŸ¥è¯¢æœªæŒæ¡çš„çŸ¥è¯†ç‚¹</span>

<span class="token comment">-- 3. å¤åˆç´¢å¼•ï¼ˆè¦†ç›–æŸ¥è¯¢ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_covering
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span>node_id<span class="token punctuation">,</span> mastery_delta<span class="token punctuation">,</span> study_minutes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: æŸ¥è¯¢æ—¶æ— éœ€å›è¡¨ï¼Œç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®</span>
<span class="token comment">-- é€‚ç”¨: åªéœ€è¦æŸ¥è¯¢å°‘é‡å­—æ®µçš„åœºæ™¯</span>

<span class="token comment">-- 4. BRIN ç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_brin
<span class="token keyword keyword-ON">ON</span> study_records <span class="token keyword keyword-USING">USING</span> BRIN <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>pages_per_range <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: ç´¢å¼•ä½“ç§¯æå°ï¼ˆä»…ä¸ºæ•°æ®çš„0.1%ï¼‰</span>
<span class="token comment">-- é€‚ç”¨: æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢çš„å¤§è¡¨</span>

<span class="token comment">-- 5. JSONB ç´¢å¼•</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_users_preferences
<span class="token keyword keyword-ON">ON</span> users <span class="token keyword keyword-USING">USING</span> GIN <span class="token punctuation">(</span>preferences<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: æ”¯æŒ JSONB å†…éƒ¨å­—æ®µçš„æŸ¥è¯¢</span>
<span class="token comment">-- é€‚ç”¨: éœ€è¦æŸ¥è¯¢ JSON å­—æ®µçš„åœºæ™¯</span>
</code></pre><p><strong>ç´¢å¼•æ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- æµ‹è¯• 1: å‘é‡æœç´¢æ€§èƒ½</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> knowledge_nodes
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> embedding <span class="token operator">&lt;=&gt;</span> <span class="token string">'[0.1, 0.2, ...]'</span>::vector
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">-- æ— ç´¢å¼•: 1200ms (å…¨è¡¨æ‰«æ)</span>
<span class="token comment">-- HNSW: 12ms (ç´¢å¼•æ‰«æ)</span>
<span class="token comment">-- æ€§èƒ½æå‡: 100x</span>

<span class="token comment">-- æµ‹è¯• 2: éƒ¨åˆ†ç´¢å¼•æŸ¥è¯¢</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> user_node_status
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">-- å…¨è¡¨ç´¢å¼•: 45ms</span>
<span class="token comment">-- éƒ¨åˆ†ç´¢å¼•: 8ms</span>
<span class="token comment">-- ç´¢å¼•å¤§å°: å‡å°‘ 60%</span>

<span class="token comment">-- æµ‹è¯• 3: è¦†ç›–ç´¢å¼•æŸ¥è¯¢</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> node_id<span class="token punctuation">,</span> mastery_delta
<span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> completed_at <span class="token keyword keyword-DESC">DESC</span>
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- æ™®é€šç´¢å¼•: 23ms (éœ€è¦å›è¡¨)</span>
<span class="token comment">-- è¦†ç›–ç´¢å¼•: 5ms (æ— éœ€å›è¡¨)</span>
<span class="token comment">-- æ€§èƒ½æå‡: 4.6x</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-9">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç´¢å¼•é€‰æ‹©çš„å†³ç­–æ ‘:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>æ•°æ®ç±»å‹?
â”œâ”€â”€ ç»“æ„åŒ–æ•°æ® (ID, æ—¶é—´, çŠ¶æ€)
â”‚   â”œâ”€â”€ ç­‰å€¼æŸ¥è¯¢ â†’ B-Tree
â”‚   â”œâ”€â”€ èŒƒå›´æŸ¥è¯¢ â†’ B-Tree
â”‚   â””â”€â”€ æ—¶é—´åºåˆ— â†’ BRIN
â”œâ”€â”€ åŠç»“æ„åŒ–æ•°æ® (JSON)
â”‚   â””â”€â”€ é”®å€¼æŸ¥è¯¢ â†’ GIN
â””â”€â”€ éç»“æ„åŒ–æ•°æ® (å‘é‡)
    â”œâ”€â”€ é«˜ç²¾åº¦ â†’ HNSW
    â””â”€â”€ é«˜é€Ÿåº¦ â†’ IVFFlat
</code></pre><p><strong>ç´¢å¼•ä¼˜åŒ–çš„æƒè¡¡:</strong></p>
<ul>
<li><strong>æŸ¥è¯¢é€Ÿåº¦ vs å†™å…¥é€Ÿåº¦</strong>: ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ï¼Œä½†å‡æ…¢å†™å…¥</li>
<li><strong>ç´¢å¼•å¤§å° vs å†…å­˜</strong>: ç´¢å¼•å ç”¨å†…å­˜ï¼Œéœ€è¦å¹³è¡¡</li>
<li><strong>ç²¾åº¦ vs æ€§èƒ½</strong>: HNSW å‚æ•°è°ƒä¼˜ï¼Œm è¶Šå¤§ç²¾åº¦è¶Šé«˜ä½†å†…å­˜è¶Šå¤§</li>
</ul>
<p><strong>éƒ¨åˆ†ç´¢å¼•çš„å¦™ç”¨:</strong></p>
<ul>
<li><strong>æ•°æ®å€¾æ–œ</strong>: åªç´¢å¼•æ´»è·ƒæ•°æ®ï¼Œå¿½ç•¥å†å²æ•°æ®</li>
<li><strong>æŸ¥è¯¢æ¨¡å¼</strong>: é’ˆå¯¹ç‰¹å®šæŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–</li>
<li><strong>ç»´æŠ¤æˆæœ¬</strong>: ç´¢å¼•ä½“ç§¯å°ï¼Œé‡å»ºå¿«</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-9">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ”¯æŒåƒä¸‡çº§æ•°æ®çš„å‘é‡ç´¢å¼•ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>HNSW å‚æ•°è°ƒä¼˜</strong>: m=16-32, ef_construction=100-200</li>
<li><strong>åˆ†ç‰‡ç­–ç•¥</strong>: æŒ‰ç”¨æˆ· ID æˆ–ç±»åˆ«åˆ†ç‰‡</li>
<li><strong>ç¼“å­˜å±‚</strong>: Redis ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ç»“æœ</li>
<li><strong>é™çº§ç­–ç•¥</strong>: ç´¢å¼•ä¸å¯ç”¨æ—¶é€€å›åˆ°ç²¾ç¡®æœç´¢</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"åƒä¸‡çº§å‘é‡æ•°æ®éœ€è¦å¤šå±‚ä¼˜åŒ–ã€‚é¦–å…ˆï¼ŒHNSW ç´¢å¼•å‚æ•°è°ƒä¼˜ï¼Œm è®¾ç½®ä¸º 16-32 ä»¥å¹³è¡¡ç²¾åº¦å’Œå†…å­˜ï¼Œef_construction è®¾ç½®ä¸º 100-200 ä»¥æé«˜æ„å»ºè´¨é‡ã€‚å…¶æ¬¡ï¼Œåˆ†ç‰‡ç­–ç•¥ï¼Œå¯ä»¥æŒ‰ç”¨æˆ· ID æˆ–çŸ¥è¯†ç±»åˆ«åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹ç´¢å¼•ï¼Œå‡å°‘å•ä¸ªç´¢å¼•çš„å¤§å°ã€‚ç¬¬ä¸‰ï¼Œç¼“å­˜å±‚ï¼Œä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ç»“æœï¼Œå‘½ä¸­ç‡å¯è¾¾ 80% ä»¥ä¸Šã€‚ç¬¬å››ï¼Œé™çº§ç­–ç•¥ï¼Œå½“ç´¢å¼•ä¸å¯ç”¨æ—¶ï¼Œé€€å›åˆ°ç²¾ç¡®æœç´¢æˆ–å…³é”®è¯æœç´¢ã€‚æœ€åï¼Œç›‘æ§ç´¢å¼•çš„å¬å›ç‡å’Œæ€§èƒ½ï¼ŒæŒç»­è°ƒä¼˜ã€‚"</p>
</blockquote>
<hr>
<h2 id="53-åˆ†åŒºç­–ç•¥">5.3 åˆ†åŒºç­–ç•¥ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-16">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>åˆ†åŒºæ˜¯å¤„ç†æµ·é‡æ•°æ®çš„ <strong>åˆ†è€Œæ²»ä¹‹</strong> ç­–ç•¥ï¼Œå°†å¤§è¡¨æ‹†åˆ†ä¸ºå°è¡¨ï¼š</p>
<ul>
<li><strong>æ—¶é—´åˆ†åŒº</strong>: æŒ‰æœˆ/æŒ‰å¤©æ‹†åˆ†ï¼Œé€‚åˆæ—¶åºæ•°æ®</li>
<li><strong>èŒƒå›´åˆ†åŒº</strong>: æŒ‰ ID èŒƒå›´æ‹†åˆ†ï¼Œé€‚åˆæœ‰åºæ•°æ®</li>
<li><strong>å“ˆå¸Œåˆ†åŒº</strong>: æŒ‰å“ˆå¸Œå€¼æ‹†åˆ†ï¼Œé€‚åˆè´Ÿè½½å‡è¡¡</li>
<li><strong>åˆ—è¡¨åˆ†åŒº</strong>: æŒ‰æšä¸¾å€¼æ‹†åˆ†ï¼Œé€‚åˆç±»åˆ«æ•°æ®</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-16">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ============================================</span>
<span class="token comment">-- å­¦ä¹ è®°å½•è¡¨ - æŒ‰æ—¶é—´åˆ†åŒº</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    study_minutes <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    mastery_delta <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    study_method <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    completed_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-BY">BY</span> RANGE <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- è‡ªåŠ¨åˆ›å»ºæœˆåº¦åˆ†åŒºå‡½æ•°</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token operator">OR</span> <span class="token keyword keyword-REPLACE">REPLACE</span> <span class="token keyword keyword-FUNCTION">FUNCTION</span> create_monthly_partition<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-RETURNS">RETURNS</span> void <span class="token keyword keyword-AS">AS</span> $$
<span class="token keyword keyword-DECLARE">DECLARE</span>
    partition_date <span class="token keyword keyword-DATE">DATE</span> :<span class="token operator">=</span> DATE_TRUNC<span class="token punctuation">(</span><span class="token string">'month'</span><span class="token punctuation">,</span> <span class="token keyword keyword-CURRENT_DATE">CURRENT_DATE</span> <span class="token operator">+</span> <span class="token keyword keyword-INTERVAL">INTERVAL</span> <span class="token string">'1 month'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    partition_name <span class="token keyword keyword-TEXT">TEXT</span> :<span class="token operator">=</span> <span class="token string">'study_records_'</span> <span class="token operator">||</span> TO_CHAR<span class="token punctuation">(</span>partition_date<span class="token punctuation">,</span> <span class="token string">'YYYY_MM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    start_date <span class="token keyword keyword-DATE">DATE</span> :<span class="token operator">=</span> partition_date<span class="token punctuation">;</span>
    end_date <span class="token keyword keyword-DATE">DATE</span> :<span class="token operator">=</span> partition_date <span class="token operator">+</span> <span class="token keyword keyword-INTERVAL">INTERVAL</span> <span class="token string">'1 month'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-BEGIN">BEGIN</span>
    <span class="token keyword keyword-EXECUTE">EXECUTE</span> <span class="token function">format</span><span class="token punctuation">(</span>
        <span class="token string">'CREATE TABLE IF NOT EXISTS %I PARTITION OF study_records
         FOR VALUES FROM (%L) TO (%L)'</span><span class="token punctuation">,</span>
        partition_name<span class="token punctuation">,</span> start_date<span class="token punctuation">,</span> end_date
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- ä¸ºæ–°åˆ†åŒºåˆ›å»ºç´¢å¼•</span>
    <span class="token keyword keyword-EXECUTE">EXECUTE</span> <span class="token function">format</span><span class="token punctuation">(</span>
        <span class="token string">'CREATE INDEX IF NOT EXISTS idx_%s_user_time ON %I(user_id, completed_at DESC)'</span><span class="token punctuation">,</span>
        partition_name<span class="token punctuation">,</span> partition_name
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-END">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword keyword-LANGUAGE">LANGUAGE</span> plpgsql<span class="token punctuation">;</span>

<span class="token comment">-- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æœˆè‡ªåŠ¨åˆ›å»ºåˆ†åŒºï¼‰</span>
<span class="token comment">-- å¯ä»¥é€šè¿‡ pg_cron æˆ–å¤–éƒ¨è°ƒåº¦å™¨å®ç°</span>

<span class="token comment">-- æ‰‹åŠ¨åˆ›å»ºç¤ºä¾‹</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records_2025_12 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> study_records
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-FROM">FROM</span> <span class="token punctuation">(</span><span class="token string">'2025-12-01'</span><span class="token punctuation">)</span> <span class="token keyword keyword-TO">TO</span> <span class="token punctuation">(</span><span class="token string">'2026-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ†åŒºç´¢å¼•</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_user_time
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>åˆ†åŒºæŸ¥è¯¢ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æ</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> completed_at <span class="token operator">&gt;=</span> <span class="token string">'2025-12-01'</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŒ–åï¼šåˆ†åŒºè£å‰ªï¼ˆåªæ‰«æ 2025-12 åˆ†åŒºï¼‰</span>
<span class="token comment">-- PostgreSQL ä¼šè‡ªåŠ¨æ ¹æ® WHERE æ¡ä»¶é€‰æ‹©åˆ†åŒº</span>

<span class="token comment">-- æ‰‹åŠ¨æŒ‡å®šåˆ†åŒºï¼ˆæ›´é«˜æ•ˆï¼‰</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records_2025_12
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ†åŒºèšåˆæŸ¥è¯¢</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    DATE_TRUNC<span class="token punctuation">(</span><span class="token string">'month'</span><span class="token punctuation">,</span> completed_at<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> <span class="token keyword keyword-month">month</span><span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> study_count<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>study_minutes<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_minutes
<span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> completed_at <span class="token operator">&gt;=</span> <span class="token string">'2025-01-01'</span>
<span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> <span class="token keyword keyword-month">month</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> <span class="token keyword keyword-month">month</span><span class="token punctuation">;</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-10">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>åˆ†åŒºçš„æ ¸å¿ƒä»·å€¼:</strong></p>
<ul>
<li><strong>æŸ¥è¯¢æ€§èƒ½</strong>: åˆ†åŒºè£å‰ªï¼ˆPartition Pruningï¼‰ï¼Œåªæ‰«æç›¸å…³åˆ†åŒº</li>
<li><strong>ç»´æŠ¤ä¾¿åˆ©</strong>: å¯ä»¥å•ç‹¬å¤‡ä»½/åˆ é™¤æ—§åˆ†åŒº</li>
<li><strong>æ•°æ®å½’æ¡£</strong>: æ—§åˆ†åŒºå¯ä»¥è¿ç§»åˆ°å»‰ä»·å­˜å‚¨</li>
<li><strong>å¹¶è¡ŒæŸ¥è¯¢</strong>: ä¸åŒåˆ†åŒºå¯ä»¥å¹¶è¡Œæ‰«æ</li>
</ul>
<p><strong>åˆ†åŒºç­–ç•¥é€‰æ‹©:</strong></p>
<ul>
<li><strong>æ—¶é—´åˆ†åŒº</strong>: é€‚åˆæ—¥å¿—ã€å†å²è®°å½•ç­‰æ—¶åºæ•°æ®</li>
<li><strong>å“ˆå¸Œåˆ†åŒº</strong>: é€‚åˆå¤šç§Ÿæˆ·ï¼Œæ•°æ®å‡åŒ€åˆ†å¸ƒ</li>
<li><strong>èŒƒå›´åˆ†åŒº</strong>: é€‚åˆæœ‰åºæ•°æ®ï¼Œå¦‚ ID èŒƒå›´</li>
<li><strong>åˆ—è¡¨åˆ†åŒº</strong>: é€‚åˆå›ºå®šç±»åˆ«ï¼Œå¦‚åœ°åŒºã€ç±»å‹</li>
</ul>
<p><strong>åˆ†åŒºçš„é™·é˜±:</strong></p>
<ul>
<li><strong>åˆ†åŒºè¿‡å¤š</strong>: ç®¡ç†å¤æ‚ï¼ŒæŸ¥è¯¢è®¡åˆ’å˜æ…¢</li>
<li><strong>è·¨åˆ†åŒºæŸ¥è¯¢</strong>: æ€§èƒ½å¯èƒ½ä¸å¦‚å•è¡¨</li>
<li><strong>åˆ†åŒºé”®é€‰æ‹©</strong>: é€‰æ‹©ä¸å½“ä¼šå¯¼è‡´æ•°æ®å€¾æ–œ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-10">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: åˆ†åŒºè¡¨çš„æŸ¥è¯¢æ€§èƒ½ä¸€å®šæ›´å¥½å—ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>åˆ†åŒºè£å‰ª</strong>: WHERE æ¡ä»¶åŒ…å«åˆ†åŒºé”®æ—¶æ€§èƒ½æå‡</li>
<li><strong>æ•°æ®é‡</strong>: æ•°æ®é‡è¶Šå¤§ï¼Œåˆ†åŒºä¼˜åŠ¿è¶Šæ˜æ˜¾</li>
<li><strong>æŸ¥è¯¢ç±»å‹</strong>: ç‚¹æŸ¥å’ŒèŒƒå›´æŸ¥å—ç›Šï¼Œè·¨åˆ†åŒºèšåˆå¯èƒ½å˜æ…¢</li>
<li><strong>åˆ†åŒºæ•°é‡</strong>: è¿‡å¤šåˆ†åŒºä¼šé™ä½æ€§èƒ½</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"åˆ†åŒºè¡¨çš„æ€§èƒ½ä¼˜åŠ¿å–å†³äºæŸ¥è¯¢æ¨¡å¼å’Œæ•°æ®é‡ã€‚å½“æŸ¥è¯¢æ¡ä»¶åŒ…å«åˆ†åŒºé”®æ—¶ï¼ŒPostgreSQL ä¼šè¿›è¡Œåˆ†åŒºè£å‰ªï¼Œåªæ‰«æç›¸å…³åˆ†åŒºï¼Œæ€§èƒ½å¤§å¹…æå‡ã€‚å¯¹äºåƒä¸‡çº§ä»¥ä¸Šçš„å¤§è¡¨ï¼Œåˆ†åŒºä¼˜åŠ¿æ˜æ˜¾ã€‚ä½†åˆ†åŒºä¸æ˜¯é“¶å¼¹ï¼šå¦‚æœæŸ¥è¯¢ç»å¸¸è·¨åˆ†åŒºï¼ˆå¦‚å…¨è¡¨èšåˆï¼‰ï¼Œæ€§èƒ½å¯èƒ½åè€Œä¸‹é™ï¼›åˆ†åŒºè¿‡å¤šä¼šå¢åŠ æŸ¥è¯¢è®¡åˆ’å¼€é”€ã€‚å› æ­¤ï¼Œåˆ†åŒºé”®çš„é€‰æ‹©è‡³å…³é‡è¦ï¼Œåº”è¯¥åŸºäºæœ€é¢‘ç¹çš„æŸ¥è¯¢æ¨¡å¼æ¥è®¾è®¡ã€‚"</p>
</blockquote>
<hr>
<h2 id="54-æŸ¥è¯¢ä¼˜åŒ–">5.4 æŸ¥è¯¢ä¼˜åŒ– </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-17">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>æŸ¥è¯¢ä¼˜åŒ–æ˜¯æ•°æ®åº“æ€§èƒ½çš„æ ¸å¿ƒï¼ŒSparkle é‡‡ç”¨å¤šç§ç­–ç•¥é¿å… <strong>N+1 é—®é¢˜</strong> å’Œä½æ•ˆæŸ¥è¯¢ï¼š</p>
<ul>
<li><strong>JOIN ä¼˜åŒ–</strong>: ä¸€æ¬¡æ€§æ‹‰å–å…³è”æ•°æ®</li>
<li><strong>è¦†ç›–ç´¢å¼•</strong>: é¿å…å›è¡¨</li>
<li><strong>æ‰¹é‡æ“ä½œ</strong>: å‡å°‘ç½‘ç»œå¾€è¿”</li>
<li><strong>æŸ¥è¯¢è®¡åˆ’åˆ†æ</strong>: EXPLAIN ANALYZE ä¼˜åŒ–</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-17">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>N+1 é—®é¢˜ç¤ºä¾‹ä¸ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># âŒ é”™è¯¯ç¤ºèŒƒï¼šN+1 é—®é¢˜</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_knowledge_graph_bad</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>  <span class="token comment"># 1æ¬¡æŸ¥è¯¢</span>
    nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">:</span>  <span class="token comment"># å‡è®¾æœ‰100ä¸ªèŠ‚ç‚¹</span>
        <span class="token comment"># Næ¬¡æŸ¥è¯¢ï¼</span>
        relations <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Relation<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>node_id<span class="token operator">=</span>node<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">'node'</span><span class="token punctuation">:</span> node<span class="token punctuation">,</span>
            <span class="token string">'relations'</span><span class="token punctuation">:</span> relations
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> nodes
<span class="token comment"># æ€»è®¡ï¼š1 + 100 = 101æ¬¡æŸ¥è¯¢ï¼</span>

<span class="token comment"># âœ… ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šJOIN åˆå¹¶</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_knowledge_graph_joined</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ä½¿ç”¨ SQLAlchemy çš„ joinedload</span>
    <span class="token keyword keyword-from">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword keyword-import">import</span> joinedload
    
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>
        joinedload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>nodes<span class="token punctuation">)</span><span class="token punctuation">.</span>joinedload<span class="token punctuation">(</span>Node<span class="token punctuation">.</span>relations<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
    
    <span class="token comment"># æ•°æ®å·²åœ¨å•æ¬¡æŸ¥è¯¢ä¸­åŠ è½½</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string">'node'</span><span class="token punctuation">:</span> node<span class="token punctuation">,</span>
        <span class="token string">'relations'</span><span class="token punctuation">:</span> node<span class="token punctuation">.</span>relations
    <span class="token punctuation">}</span> <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">]</span>
<span class="token comment"># æ€»è®¡ï¼š1æ¬¡æŸ¥è¯¢</span>

<span class="token comment"># âœ… ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šæ‰¹é‡æŸ¥è¯¢</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_knowledge_graph_batch</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
    node_ids <span class="token operator">=</span> <span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">]</span>
    
    <span class="token comment"># 1æ¬¡æ‰¹é‡æŸ¥è¯¢</span>
    relations <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Relation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
        Relation<span class="token punctuation">.</span>node_id<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>node_ids<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># å†…å­˜ä¸­å…³è”</span>
    relations_by_node <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-for">for</span> rel <span class="token keyword keyword-in">in</span> relations<span class="token punctuation">:</span>
        relations_by_node<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>rel<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>rel<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string">'node'</span><span class="token punctuation">:</span> node<span class="token punctuation">,</span>
        <span class="token string">'relations'</span><span class="token punctuation">:</span> relations_by_node<span class="token punctuation">.</span>get<span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">]</span>
<span class="token comment"># æ€»è®¡ï¼š2æ¬¡æŸ¥è¯¢</span>

<span class="token comment"># âœ… ä¼˜åŒ–æ–¹æ¡ˆ3ï¼šä½¿ç”¨ GraphQL é£æ ¼çš„å­—æ®µé€‰æ‹©å™¨</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_data</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> fields<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    query <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-if">if</span> <span class="token string">'nodes'</span> <span class="token keyword keyword-in">in</span> fields<span class="token punctuation">:</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span>options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">'profile'</span> <span class="token keyword keyword-in">in</span> fields<span class="token punctuation">:</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span>options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>profile<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> query<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
</code></pre><p><strong>SQL å±‚é¢çš„æŸ¥è¯¢ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ä¼˜åŒ–å‰ï¼šå¤šæ¬¡æŸ¥è¯¢</span>
<span class="token comment">-- æŸ¥è¯¢1: è·å–ç”¨æˆ·</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> users <span class="token keyword keyword-WHERE">WHERE</span> id <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">;</span>

<span class="token comment">-- æŸ¥è¯¢2: è·å–ç”¨æˆ·çš„å­¦ä¹ è®°å½•ï¼ˆNæ¬¡ï¼‰</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records <span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> node_id <span class="token operator">=</span> <span class="token string">'node1'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records <span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> node_id <span class="token operator">=</span> <span class="token string">'node2'</span><span class="token punctuation">;</span>
<span class="token comment">-- ... Næ¬¡</span>

<span class="token comment">-- ä¼˜åŒ–åï¼šå•æ¬¡ JOIN æŸ¥è¯¢</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    u<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>study_minutes<span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>mastery_delta<span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>completed_at<span class="token punctuation">,</span>
    kn<span class="token punctuation">.</span>name <span class="token keyword keyword-as">as</span> node_name<span class="token punctuation">,</span>
    kn<span class="token punctuation">.</span>category
<span class="token keyword keyword-FROM">FROM</span> users u
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> study_records sr <span class="token keyword keyword-ON">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> sr<span class="token punctuation">.</span>user_id
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> knowledge_nodes kn <span class="token keyword keyword-ON">ON</span> sr<span class="token punctuation">.</span>node_id <span class="token operator">=</span> kn<span class="token punctuation">.</span>id
<span class="token keyword keyword-WHERE">WHERE</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'123'</span>
  <span class="token operator">AND</span> sr<span class="token punctuation">.</span>completed_at <span class="token operator">&gt;=</span> <span class="token keyword keyword-CURRENT_DATE">CURRENT_DATE</span> <span class="token operator">-</span> <span class="token keyword keyword-INTERVAL">INTERVAL</span> <span class="token string">'7 days'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> sr<span class="token punctuation">.</span>completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- ä½¿ç”¨è¦†ç›–ç´¢å¼•è¿›ä¸€æ­¥ä¼˜åŒ–</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_covering
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span>node_id<span class="token punctuation">,</span> mastery_delta<span class="token punctuation">,</span> study_minutes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŒ–åçš„æŸ¥è¯¢è®¡åˆ’</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> node_id<span class="token punctuation">,</span> mastery_delta
<span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> completed_at <span class="token keyword keyword-DESC">DESC</span>
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- ç»“æœï¼šIndex Scan using idx_study_records_covering</span>
<span class="token comment">-- æ— éœ€å›è¡¨ï¼Œæ€§èƒ½æå‡ 5-10 å€</span>
</code></pre><p><strong>æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># âŒ ä½æ•ˆçš„é€æ¡æ’å…¥</span>
<span class="token keyword keyword-for">for</span> record <span class="token keyword keyword-in">in</span> study_records<span class="token punctuation">:</span>
    <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        <span class="token string">"INSERT INTO study_records (user_id, node_id, minutes) VALUES (?, ?, ?)"</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> record<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span> record<span class="token punctuation">.</span>minutes
    <span class="token punctuation">)</span>
<span class="token comment"># æ‰§è¡Œ N æ¬¡ç½‘ç»œå¾€è¿”</span>

<span class="token comment"># âœ… é«˜æ•ˆçš„æ‰¹é‡æ’å…¥</span>
<span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute_many<span class="token punctuation">(</span>
    <span class="token string">"INSERT INTO study_records (user_id, node_id, minutes) VALUES (?, ?, ?)"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>minutes<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> r <span class="token keyword keyword-in">in</span> study_records<span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token comment"># æ‰§è¡Œ 1 æ¬¡ç½‘ç»œå¾€è¿”</span>

<span class="token comment"># âœ… ä½¿ç”¨ COPY å‘½ä»¤ï¼ˆæœ€å¿«ï¼‰</span>
<span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
    COPY study_records (user_id, node_id, minutes) 
    FROM STDIN WITH CSV
"""</span><span class="token punctuation">,</span> csv_data<span class="token punctuation">)</span>
<span class="token comment"># æ¯” INSERT å¿« 10-20 å€</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-11">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>N+1 é—®é¢˜çš„æœ¬è´¨:</strong></p>
<ul>
<li><strong>ç½‘ç»œå¾€è¿”</strong>: æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦ç½‘ç»œ RTTï¼Œç´¯ç§¯å¼€é”€å·¨å¤§</li>
<li><strong>æ•°æ®åº“è´Ÿè½½</strong>: æ¯æ¡ SQL éƒ½éœ€è¦è§£æã€æ‰§è¡Œã€è¿”å›</li>
<li><strong>ä»£ç å¤æ‚åº¦</strong>: å¾ªç¯ä¸­çš„æŸ¥è¯¢éš¾ä»¥ç»´æŠ¤å’Œä¼˜åŒ–</li>
</ul>
<p><strong>è§£å†³ç­–ç•¥çš„æƒè¡¡:</strong></p>
<ol>
<li>
<p><strong>JOIN åˆå¹¶</strong>:</p>
<ul>
<li>âœ… ä¼˜ç‚¹: å•æ¬¡æŸ¥è¯¢ï¼Œä»£ç ç®€æ´</li>
<li>âŒ ç¼ºç‚¹: å¯èƒ½äº§ç”Ÿç¬›å¡å°”ç§¯ï¼Œæ•°æ®å†—ä½™</li>
</ul>
</li>
<li>
<p><strong>æ‰¹é‡æŸ¥è¯¢</strong>:</p>
<ul>
<li>âœ… ä¼˜ç‚¹: å‡å°‘æŸ¥è¯¢æ¬¡æ•°ï¼Œæ§åˆ¶æ•°æ®é‡</li>
<li>âŒ ç¼ºç‚¹: éœ€è¦å†…å­˜å…³è”ï¼Œä»£ç ç¨å¤æ‚</li>
</ul>
</li>
<li>
<p><strong>å­—æ®µé€‰æ‹©å™¨</strong>:</p>
<ul>
<li>âœ… ä¼˜ç‚¹: æŒ‰éœ€åŠ è½½ï¼Œæœ€çµæ´»</li>
<li>âŒ ç¼ºç‚¹: å®ç°å¤æ‚ï¼Œéœ€è¦å°è£…</li>
</ul>
</li>
</ol>
<p><strong>æŸ¥è¯¢ä¼˜åŒ–çš„å±‚æ¬¡:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>åº”ç”¨å±‚ (Python)
    â†“ ä¼˜åŒ–: æ‰¹é‡æŸ¥è¯¢ã€å­—æ®µé€‰æ‹©
ORM å±‚ (SQLAlchemy)
    â†“ ä¼˜åŒ–: joinedloadã€subqueryload
SQL å±‚ (PostgreSQL)
    â†“ ä¼˜åŒ–: ç´¢å¼•ã€åˆ†åŒºã€è¦†ç›–ç´¢å¼•
å­˜å‚¨å±‚ (ç£ç›˜)
    â†“ ä¼˜åŒ–: SSDã€RAIDã€å†…å­˜
</code></pre><h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-11">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•æ£€æµ‹å’Œè§£å†³ N+1 é—®é¢˜ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ£€æµ‹</strong>: æ…¢æŸ¥è¯¢æ—¥å¿—ã€APM å·¥å…·ã€æ‰‹åŠ¨è®¡æ•°</li>
<li><strong>è§£å†³</strong>: JOINã€æ‰¹é‡æŸ¥è¯¢ã€é¢„åŠ è½½</li>
<li><strong>é¢„é˜²</strong>: ä»£ç å®¡æŸ¥ã€æ€§èƒ½æµ‹è¯•ã€ORM æœ€ä½³å®è·µ</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æ£€æµ‹ N+1 é—®é¢˜æœ‰ä¸‰ç§æ–¹æ³•ï¼šç¬¬ä¸€ï¼ŒæŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå¦‚æœå‘ç°å¤§é‡ç›¸ä¼¼æŸ¥è¯¢ï¼Œå¯èƒ½æ˜¯ N+1ï¼›ç¬¬äºŒï¼Œä½¿ç”¨ APM å·¥å…·å¦‚ New Relicï¼Œå®ƒä¼šè‡ªåŠ¨æ ‡è®° N+1ï¼›ç¬¬ä¸‰ï¼Œæ‰‹åŠ¨åœ¨ä»£ç ä¸­è®¡æ•°æŸ¥è¯¢æ¬¡æ•°ã€‚è§£å†³æ–¹æ³•ï¼šå¯¹äº ORMï¼Œä½¿ç”¨ eager loadingï¼ˆå¦‚ SQLAlchemy çš„ joinedloadï¼‰ï¼›å¯¹äºå¤æ‚åœºæ™¯ï¼Œä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼›å¯¹äºåªè¯»åœºæ™¯ï¼Œä½¿ç”¨æ•°æ®åº“è§†å›¾ã€‚é¢„é˜²æ–¹é¢ï¼Œæˆ‘ä»¬åˆ¶å®šäº†ä»£ç è§„èŒƒï¼Œè¦æ±‚æ‰€æœ‰æ•°æ®åº“è®¿é—®å¿…é¡»é€šè¿‡å°è£…å¥½çš„ Repository å±‚ï¼Œå¹¶åœ¨ Code Review æ—¶ç‰¹åˆ«æ³¨æ„å¾ªç¯ä¸­çš„æ•°æ®åº“æ“ä½œã€‚"</p>
</blockquote>
<hr>
<h1 id="å…­-æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£">å…­ã€æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£ </h1>
<h2 id="61-çŸ¥è¯†æ˜Ÿå›¾-knowledge-galaxy">6.1 çŸ¥è¯†æ˜Ÿå›¾ (Knowledge Galaxy) </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-18">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>çŸ¥è¯†æ˜Ÿå›¾æ˜¯ Sparkle çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œé€šè¿‡ <strong>ç®—æ³•é©±åŠ¨</strong> å’Œ <strong>å›¾è®¡ç®—</strong> å®ç°ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„ï¼š</p>
<ul>
<li><strong>æŒæ¡åº¦ç®—æ³•</strong>: å¤šå› å­åŠ æƒè®¡ç®—ï¼Œè¾¹é™…æ•ˆç”¨é€’å‡</li>
<li><strong>è‰¾å®¾æµ©æ–¯æ›²çº¿</strong>: é—´éš”é‡å¤ç®—æ³•ï¼Œç§‘å­¦å®‰æ’å¤ä¹ </li>
<li><strong>æ··åˆæœç´¢</strong>: å‘é‡ + å…³é”®è¯ + å›¾å…³ç³»</li>
<li><strong>çŸ¥è¯†å›¾è°±è‡ªç”Ÿé•¿</strong>: LLM è‡ªåŠ¨æ‹“å±•çŸ¥è¯†ç‚¹</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-18">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>æŒæ¡åº¦ç®—æ³•ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/galaxy_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">GalaxyService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    çŸ¥è¯†æ˜Ÿå›¾æ ¸å¿ƒæœåŠ¡
    èŒè´£ï¼šèŠ‚ç‚¹ç®¡ç†ã€æŒæ¡åº¦è®¡ç®—ã€å…³ç³»ç»´æŠ¤ã€RAG æ£€ç´¢
    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db<span class="token punctuation">,</span> redis<span class="token punctuation">,</span> llm_service<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> db
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis
        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> llm_service

        <span class="token comment"># å¸¸é‡é…ç½®</span>
        self<span class="token punctuation">.</span>BASE_MASTERY_POINTS <span class="token operator">=</span> <span class="token number">5.0</span>
        self<span class="token punctuation">.</span>MAX_MASTERY <span class="token operator">=</span> <span class="token number">100.0</span>
        self<span class="token punctuation">.</span>MEMORY_HALF_LIFE_DAYS <span class="token operator">=</span> <span class="token number">7.0</span>
        self<span class="token punctuation">.</span>DECAY_THRESHOLD <span class="token operator">=</span> <span class="token number">10.0</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">spark_node</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                        study_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> SparkResult<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        ç‚¹äº®çŸ¥è¯†ç‚¹ - æ ¸å¿ƒå­¦ä¹ æµç¨‹
        """</span>
        <span class="token comment"># ========== ç¬¬1æ­¥ï¼šè·å–æˆ–åˆ›å»ºæŒæ¡åº¦çŠ¶æ€ ==========</span>
        status <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_or_create_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> node_id<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬2æ­¥ï¼šæŒæ¡åº¦ç®—æ³• (Mastery Algorithm) ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šå¤šå› å­æƒé‡ã€‚ä¸æ˜¯ç®€å•åŠ åˆ†ï¼Œè€Œæ˜¯æ ¹æ®ï¼šå­¦ä¹ æ—¶é•¿ã€èŠ‚ç‚¹é‡è¦åº¦ã€å­¦ä¹ æ¬¡æ•°ã€æ—¶é—´æ•ˆç‡ ç»¼åˆè®¡ç®—ã€‚</span>
        mastery_delta <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_mastery_delta<span class="token punctuation">(</span>
            study_minutes<span class="token punctuation">,</span>
            node<span class="token punctuation">.</span>importance_level<span class="token punctuation">,</span>
            status<span class="token punctuation">.</span>study_count
        <span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬3æ­¥ï¼šçŠ¶æ€æ›´æ–°ä¸è§£é” ==========</span>
        status<span class="token punctuation">.</span>mastery_score <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>mastery_score <span class="token operator">+</span> mastery_delta<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
        status<span class="token punctuation">.</span>study_count <span class="token operator">+=</span> <span class="token number">1</span>
        status<span class="token punctuation">.</span>last_study_at <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬4æ­¥ï¼šè‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’ ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šé—´éš”é‡å¤ (Spaced Repetition)ã€‚æ ¹æ® Ebbinghaus æ›²çº¿ï¼ŒåŠ¨æ€è®¡ç®—è¯¥çŸ¥è¯†ç‚¹çš„ä¸‹ä¸€æ¬¡å¤ä¹ æ—¶é—´ã€‚</span>
        <span class="token keyword keyword-if">if</span> status<span class="token punctuation">.</span>mastery_score <span class="token operator">&gt;=</span> <span class="token number">60</span><span class="token punctuation">:</span>
            status<span class="token punctuation">.</span>next_review_at <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_next_review<span class="token punctuation">(</span>
                status<span class="token punctuation">.</span>study_count<span class="token punctuation">,</span>
                status<span class="token punctuation">.</span>mastery_score
            <span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬5æ­¥ï¼šè§¦å‘è‡ªåŠ¨åŒ–å·¥ä½œæµ ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šå¼‚æ­¥æ‹“å±•ã€‚å¦‚æœå­¦ä¹ æ¬¡æ•°è¾¾æ ‡ï¼ˆå¦‚ 2 æ¬¡ï¼‰ï¼Œè§¦å‘ ExpansionWorker è¿›è¡ŒçŸ¥è¯†å›¾è°±è‡ªåŠ¨æ‹“æ‰‘ã€‚</span>
        <span class="token keyword keyword-if">if</span> status<span class="token punctuation">.</span>study_count <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_queue_expansion<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> SparkResult<span class="token punctuation">(</span>
            mastery_delta<span class="token operator">=</span>mastery_delta<span class="token punctuation">,</span>
            new_mastery<span class="token operator">=</span>status<span class="token punctuation">.</span>mastery_score<span class="token punctuation">,</span>
            next_review<span class="token operator">=</span>status<span class="token punctuation">.</span>next_review_at
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_calculate_mastery_delta</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> study_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                                importance<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> study_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        æŒæ¡åº¦å¢é‡è®¡ç®—
        å…¬å¼ï¼šåŸºç¡€åˆ† Ã— é‡è¦åº¦ç³»æ•° Ã— æ¬¡æ•°è¡°å‡ Ã— æ—¶é—´ç³»æ•°
        """</span>
        <span class="token comment"># åŸºç¡€åˆ†ï¼šæ¯åˆ†é’Ÿå­¦ä¹ å¢åŠ  5 ç‚¹</span>
        base <span class="token operator">=</span> study_minutes <span class="token operator">*</span> self<span class="token punctuation">.</span>BASE_MASTERY_POINTS

        <span class="token comment"># é‡è¦åº¦ç³»æ•°ï¼š1-5 çº§ï¼Œæœ€é«˜ 2.0 å€</span>
        importance_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>importance <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.25</span>

        <span class="token comment"># æ¬¡æ•°è¡°å‡ï¼šå­¦ä¹ æ¬¡æ•°è¶Šå¤šï¼Œå¢é‡è¶Šå°</span>
        count_factor <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> study_count <span class="token operator">*</span> <span class="token number">0.3</span><span class="token punctuation">)</span>

        <span class="token comment"># æ—¶é—´ç³»æ•°ï¼šå­¦ä¹ æ—¶é—´è¶Šé•¿ï¼Œæ•ˆç‡è¶Šé«˜ï¼ˆä½†æœ‰ä¸Šé™ï¼‰</span>
        time_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>log10<span class="token punctuation">(</span>study_minutes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.2</span>

        delta <span class="token operator">=</span> base <span class="token operator">*</span> importance_factor <span class="token operator">*</span> count_factor <span class="token operator">*</span> time_factor

        <span class="token keyword keyword-return">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>delta<span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span>  <span class="token comment"># å•æ¬¡ä¸Šé™ 20 ç‚¹</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_calculate_next_review</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> study_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> mastery<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> datetime<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿è®¡ç®—å¤ä¹ æ—¶é—´
        åŸºäº Ebbinghaus forgetting curve
        """</span>
        <span class="token comment"># åŸºç¡€é—´éš”ï¼ˆå¤©ï¼‰</span>
        <span class="token keyword keyword-if">if</span> study_count <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword keyword-elif">elif</span> study_count <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">3</span>
        <span class="token keyword keyword-elif">elif</span> study_count <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">7</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">14</span>

        <span class="token comment"># æŒæ¡åº¦å½±å“ï¼šæŒæ¡åº¦è¶Šé«˜ï¼Œé—´éš”è¶Šé•¿</span>
        mastery_factor <span class="token operator">=</span> mastery <span class="token operator">/</span> <span class="token number">50.0</span>  <span class="token comment"># 0-2 å€</span>

        <span class="token comment"># éšæœºå› å­ï¼šé¿å…æ‰€æœ‰ç”¨æˆ·åŒæ—¶å¤ä¹ </span>
        random_factor <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">)</span>

        days <span class="token operator">=</span> base_days <span class="token operator">*</span> mastery_factor <span class="token operator">*</span> random_factor

        <span class="token keyword keyword-return">return</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>days<span class="token punctuation">)</span>
</code></pre><p><strong>æ··åˆæœç´¢å®ç°ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">hybrid_search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                       vector_query<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                       limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>KnowledgeNode<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    RAG v2.0 æ··åˆæœç´¢
    ç»“åˆï¼šå‘é‡æœç´¢ + å…³é”®è¯æœç´¢ + ç”¨æˆ·çŠ¶æ€è¿‡æ»¤
    """</span>
    <span class="token comment"># 1. å‡†å¤‡æŸ¥è¯¢å‘é‡</span>
    query_embedding <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>get_embedding<span class="token punctuation">(</span>
        vector_query <span class="token keyword keyword-if">if</span> vector_query <span class="token keyword keyword-else">else</span> query
    <span class="token punctuation">)</span>

    <span class="token comment"># 2. å¹¶è¡Œæ‰§è¡Œå‘é‡æœç´¢å’Œå…³é”®è¯æœç´¢</span>
    vector_task <span class="token operator">=</span> self<span class="token punctuation">.</span>_vector_search<span class="token punctuation">(</span>query_embedding<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    keyword_task <span class="token operator">=</span> self<span class="token punctuation">.</span>_keyword_search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>

    vector_results<span class="token punctuation">,</span> keyword_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        vector_task<span class="token punctuation">,</span> keyword_task
    <span class="token punctuation">)</span>

    <span class="token comment"># 3. RRF (Reciprocal Rank Fusion) èåˆ</span>
    fused <span class="token operator">=</span> self<span class="token punctuation">.</span>_reciprocal_rank_fusion<span class="token punctuation">(</span>
        vector_results<span class="token punctuation">,</span>
        keyword_results<span class="token punctuation">,</span>
        weight_vector<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
        weight_keyword<span class="token operator">=</span><span class="token number">0.3</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 4. é‡æ’åºï¼ˆRe-rankingï¼‰</span>
    reranked <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_rerank<span class="token punctuation">(</span>query<span class="token punctuation">,</span> fused<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>

    <span class="token comment"># 5. è·å–å®Œæ•´èŠ‚ç‚¹å¹¶è¿‡æ»¤</span>
    nodes <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_nodes_by_ids<span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">.</span>node_id <span class="token keyword keyword-for">for</span> r <span class="token keyword keyword-in">in</span> reranked<span class="token punctuation">]</span><span class="token punctuation">)</span>
    filtered <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_filter_by_user_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> filtered

<span class="token keyword keyword-def">def</span> <span class="token function">_reciprocal_rank_fusion</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vector_results<span class="token punctuation">,</span> keyword_results<span class="token punctuation">,</span>
                           weight_vector<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> weight_keyword<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""RRF èåˆç®—æ³•"""</span>
    scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment"># å‘é‡ç»“æœ</span>
    <span class="token keyword keyword-for">for</span> rank<span class="token punctuation">,</span> result <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>vector_results<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        scores<span class="token punctuation">[</span>result<span class="token punctuation">.</span>node_id<span class="token punctuation">]</span> <span class="token operator">=</span> weight_vector <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rank <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># å…³é”®è¯ç»“æœ</span>
    <span class="token keyword keyword-for">for</span> rank<span class="token punctuation">,</span> result <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>keyword_results<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> result<span class="token punctuation">.</span>node_id <span class="token keyword keyword-in">in</span> scores<span class="token punctuation">:</span>
            scores<span class="token punctuation">[</span>result<span class="token punctuation">.</span>node_id<span class="token punctuation">]</span> <span class="token operator">+=</span> weight_keyword <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rank <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            scores<span class="token punctuation">[</span>result<span class="token punctuation">.</span>node_id<span class="token punctuation">]</span> <span class="token operator">=</span> weight_keyword <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rank <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># æ’åº</span>
    sorted_results <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>scores<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>FusedResult<span class="token punctuation">(</span>node_id<span class="token operator">=</span>k<span class="token punctuation">,</span> score<span class="token operator">=</span>v<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> k<span class="token punctuation">,</span> v <span class="token keyword keyword-in">in</span> sorted_results<span class="token punctuation">]</span>
</code></pre><p><strong>çŸ¥è¯†å›¾è°±è‡ªç”Ÿé•¿ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/expansion_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">ExpansionService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""LLM é©±åŠ¨çš„çŸ¥è¯†æ‹“å±•æœåŠ¡"""</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_expansion</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ========== ç¬¬1æ­¥ï¼šLLM ç”Ÿæˆå…³è”å†…å®¹ ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šè‡ªåŠ¨åŒ–æ‹“æ‰‘ã€‚è®© AI åˆ†æå½“å‰çŸ¥è¯†ç‚¹ï¼Œè‡ªåŠ¨ç”Ÿæˆå­çŸ¥è¯†ç‚¹å’Œç»ƒä¹ é¢˜ã€‚</span>
        expansion_result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_generate_expansion<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬2æ­¥ï¼šåŠ¨æ€æ„å»ºå›¾å…³ç³» ==========</span>
        <span class="token keyword keyword-for">for</span> child <span class="token keyword keyword-in">in</span> expansion_result<span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># è‡ªåŠ¨åˆ›å»ºå­èŠ‚ç‚¹å¹¶å»ºç«‹ parent_id å…³è”</span>
            child_node <span class="token operator">=</span> KnowledgeNode<span class="token punctuation">(</span>parent_id<span class="token operator">=</span>node_id<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>child_node<span class="token punctuation">)</span>
            
            <span class="token comment"># ========== ç¬¬3æ­¥ï¼šå»ºç«‹è¯­ä¹‰è¾¹ (Edge) ==========</span>
            <span class="token comment"># æ€æƒ³ï¼šçŸ¥è¯†å›¾è°±æ„å»ºã€‚ä¸ä»…æœ‰çˆ¶å­å…³ç³»ï¼Œè¿˜é€šè¿‡ NodeRelations è®°å½•å…³è”å¼ºåº¦ã€‚</span>
            relation <span class="token operator">=</span> NodeRelations<span class="token punctuation">(</span>
                source_node_id<span class="token operator">=</span>node_id<span class="token punctuation">,</span>
                target_node_id<span class="token operator">=</span>child_node<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                relation_type<span class="token operator">=</span><span class="token string">'child'</span><span class="token punctuation">,</span>
                strength<span class="token operator">=</span>expansion_result<span class="token punctuation">[</span><span class="token string">'relevance_score'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>relation<span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-12">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>æŒæ¡åº¦ç®—æ³•çš„è®¾è®¡å“²å­¦:</strong></p>
<ul>
<li><strong>è¾¹é™…æ•ˆç”¨é€’å‡</strong>: å­¦å¾—è¶Šå¤šï¼Œå•æ¬¡æ”¶ç›Šè¶Šå°ï¼Œé¼“åŠ±æ¢ç´¢æ–°é¢†åŸŸ</li>
<li><strong>å¤šå› å­åŠ æƒ</strong>: ä¸åªçœ‹æ—¶é•¿ï¼Œè¿˜è¦çœ‹é‡è¦åº¦ã€æ¬¡æ•°ã€æ•ˆç‡</li>
<li><strong>å•æ¬¡ä¸Šé™</strong>: é˜²æ­¢åˆ·åˆ†ï¼Œä¿è¯å…¬å¹³æ€§</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ ¹æ®ç”¨æˆ·å†å²åŠ¨æ€è°ƒæ•´</li>
</ul>
<p><strong>è‰¾å®¾æµ©æ–¯ç®—æ³•çš„ç§‘å­¦æ€§:</strong></p>
<ul>
<li><strong>é—å¿˜æ›²çº¿</strong>: äººç±»è®°å¿†éšæ—¶é—´æŒ‡æ•°è¡°å‡</li>
<li><strong>é—´éš”é‡å¤</strong>: åœ¨é—å¿˜ä¸´ç•Œç‚¹å¤ä¹ ï¼Œå¼ºåŒ–è®°å¿†</li>
<li><strong>åŠ¨æ€è°ƒæ•´</strong>: æ ¹æ®æŒæ¡åº¦è°ƒæ•´é—´éš”ï¼Œè¶Šç†Ÿç»ƒé—´éš”è¶Šé•¿</li>
<li><strong>éšæœºå› å­</strong>: é¿å…æ‰€æœ‰ç”¨æˆ·åŒæ—¶å¤ä¹ ï¼Œé€ æˆç³»ç»Ÿå‹åŠ›</li>
</ul>
<p><strong>æ··åˆæœç´¢çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>å¬å›ç‡</strong>: å‘é‡æœç´¢å¬å›è¯­ä¹‰ç›¸å…³å†…å®¹</li>
<li><strong>å‡†ç¡®ç‡</strong>: å…³é”®è¯æœç´¢ç¡®ä¿ç²¾ç¡®åŒ¹é…</li>
<li><strong>ç›¸å…³æ€§</strong>: RRF èåˆå»é™¤ç»å¯¹åˆ†å€¼å¹²æ‰°</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: ç”¨æˆ·çŠ¶æ€è¿‡æ»¤ï¼Œæ¨èåˆé€‚éš¾åº¦</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-12">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: æŒæ¡åº¦ç®—æ³•å¦‚ä½•é˜²æ­¢ç”¨æˆ·åˆ·åˆ†ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>å•æ¬¡ä¸Šé™</strong>: æ¯æ¬¡å­¦ä¹ æœ€å¤šå¢åŠ  20 ç‚¹</li>
<li><strong>æ¬¡æ•°è¡°å‡</strong>: å­¦ä¹ æ¬¡æ•°è¶Šå¤šï¼Œå•æ¬¡æ”¶ç›Šè¶Šå°</li>
<li><strong>æ—¶é—´æ•ˆç‡</strong>: çŸ­æ—¶é—´åˆ·é¢˜æ”¶ç›Šé€’å‡</li>
<li><strong>éšæœºå› å­</strong>: é¿å…ç”¨æˆ·åŒæ—¶åˆ·åŒä¸€çŸ¥è¯†ç‚¹</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è®¾è®¡äº†å¤šå±‚é˜²åˆ·åˆ†æœºåˆ¶ï¼šç¬¬ä¸€ï¼Œå•æ¬¡å­¦ä¹ æœ€å¤šå¢åŠ  20 ç‚¹ï¼Œå³ä½¿å­¦ä¹  100 åˆ†é’Ÿä¹Ÿä¸ä¼šè¶…è¿‡ä¸Šé™ï¼›ç¬¬äºŒï¼Œæ¬¡æ•°è¡°å‡å› å­ï¼Œç¬¬ 10 æ¬¡å­¦ä¹ çš„æ”¶ç›Šåªæœ‰ç¬¬ 1 æ¬¡çš„ 1/4ï¼›ç¬¬ä¸‰ï¼Œæ—¶é—´æ•ˆç‡å¯¹æ•°å‡½æ•°ï¼Œ1 åˆ†é’Ÿå’Œ 10 åˆ†é’Ÿçš„æ•ˆç‡å·®å¼‚å¾ˆå¤§ï¼Œä½† 10 åˆ†é’Ÿå’Œ 100 åˆ†é’Ÿå·®å¼‚å¾ˆå°ï¼›ç¬¬å››ï¼Œéšæœºå› å­ï¼Œé¿å…ç”¨æˆ·åœ¨ç‰¹å®šæ—¶é—´ç‚¹åˆ·åˆ†ã€‚è¿™äº›æœºåˆ¶å…±åŒä¿è¯äº†ç³»ç»Ÿçš„å…¬å¹³æ€§å’Œå­¦ä¹ è´¨é‡ã€‚"</p>
</blockquote>
<hr>
<h2 id="62-ä»»åŠ¡ç®¡ç†">6.2 ä»»åŠ¡ç®¡ç† </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-19">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ä»»åŠ¡ç®¡ç†æ˜¯ Sparkle çš„ <strong>å·¥ä½œæµå¼•æ“</strong>ï¼Œæ”¯æŒ 6 ç§ä»»åŠ¡ç±»å‹å’Œè·¨åŸŸè”åŠ¨ï¼š</p>
<ul>
<li><strong>6 ç§ç±»å‹</strong>: å­¦ä¹ ã€è®­ç»ƒã€çº é”™ã€åæ€ã€ç¤¾äº¤ã€è§„åˆ’</li>
<li><strong>çŠ¶æ€æµè½¬</strong>: å¾…åŠ â†’ è¿›è¡Œä¸­ â†’ å·²å®Œæˆ/å·²æ”¾å¼ƒ</li>
<li><strong>è·¨åŸŸè”åŠ¨</strong>: ä»»åŠ¡å®Œæˆ â†’ æŒæ¡åº¦æ›´æ–° â†’ çŸ¥è¯†æ‹“å±•</li>
<li><strong>æ™ºèƒ½å»ºè®®</strong>: åŸºäºç”¨æˆ·çŠ¶æ€ç”Ÿæˆä»»åŠ¡æ¨è</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-19">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/task_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">TaskService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä»»åŠ¡ç®¡ç†æœåŠ¡"""</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">create_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_data<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Task<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""åˆ›å»ºä»»åŠ¡"""</span>
        <span class="token comment"># 1. éªŒè¯ä»»åŠ¡ç±»å‹</span>
        <span class="token keyword keyword-if">if</span> task_data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>TASK_TYPES<span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Invalid task type: </span><span class="token interpolation"><span class="token punctuation">{</span>task_data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 2. å¦‚æœå…³è”çŸ¥è¯†ç‚¹ï¼Œæ£€æŸ¥è§£é”çŠ¶æ€</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">'knowledge_node_id'</span> <span class="token keyword keyword-in">in</span> task_data<span class="token punctuation">:</span>
            node_status <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_node_unlocked<span class="token punctuation">(</span>
                user_id<span class="token punctuation">,</span>
                task_data<span class="token punctuation">[</span><span class="token string">'knowledge_node_id'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> node_status<span class="token punctuation">:</span>
                <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Knowledge node not unlocked"</span><span class="token punctuation">)</span>

        <span class="token comment"># 3. åˆ›å»ºä»»åŠ¡</span>
        task <span class="token operator">=</span> Task<span class="token punctuation">(</span>
            user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
            title<span class="token operator">=</span>task_data<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token builtin">type</span><span class="token operator">=</span>task_data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            tags<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tags'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            estimated_minutes<span class="token operator">=</span>task_data<span class="token punctuation">[</span><span class="token string">'estimated_minutes'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            difficulty<span class="token operator">=</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'difficulty'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            knowledge_node_id<span class="token operator">=</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'knowledge_node_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auto_expand_enabled<span class="token operator">=</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'auto_expand'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 4. å¦‚æœæ˜¯å­¦ä¹ ä»»åŠ¡ï¼Œè‡ªåŠ¨å…³è”å†²åˆºè®¡åˆ’</span>
        <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">'LEARNING'</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_link_to_sprint_plan<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> task

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                          actual_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TaskExecutionResult<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰§è¡Œä»»åŠ¡"""</span>
        <span class="token comment"># 1. è·å–ä»»åŠ¡</span>
        task <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>Task<span class="token punctuation">,</span> task_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> task <span class="token keyword keyword-or">or</span> task<span class="token punctuation">.</span>user_id <span class="token operator">!=</span> user_id<span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Task not found"</span><span class="token punctuation">)</span>

        <span class="token comment"># 2. æ›´æ–°ä»»åŠ¡çŠ¶æ€</span>
        task<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'COMPLETED'</span>

        <span class="token comment"># 3. å¦‚æœå…³è”çŸ¥è¯†ç‚¹ï¼Œæ›´æ–°æŒæ¡åº¦</span>
        mastery_delta <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">:</span>
            galaxy_service <span class="token operator">=</span> GalaxyService<span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">,</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> galaxy_service<span class="token punctuation">.</span>spark_node<span class="token punctuation">(</span>
                user_id<span class="token punctuation">,</span>
                task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">,</span>
                actual_minutes
            <span class="token punctuation">)</span>
            mastery_delta <span class="token operator">=</span> result<span class="token punctuation">.</span>mastery_delta

        <span class="token comment"># 4. è®°å½•æ‰§è¡Œå†å²</span>
        execution <span class="token operator">=</span> TaskExecution<span class="token punctuation">(</span>
            task_id<span class="token operator">=</span>task_id<span class="token punctuation">,</span>
            actual_minutes<span class="token operator">=</span>actual_minutes<span class="token punctuation">,</span>
            mastery_delta<span class="token operator">=</span>mastery_delta
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>execution<span class="token punctuation">)</span>

        <span class="token comment"># 5. è‡ªåŠ¨æ‰©å±•ï¼ˆå¦‚æœå¯ç”¨ï¼‰</span>
        <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span>auto_expand_enabled <span class="token keyword keyword-and">and</span> task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">:</span>
            expansion_service <span class="token operator">=</span> ExpansionService<span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-await">await</span> expansion_service<span class="token punctuation">.</span>queue_expansion<span class="token punctuation">(</span>
                task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">,</span>
                priority<span class="token operator">=</span><span class="token number">3</span>
            <span class="token punctuation">)</span>

        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> TaskExecutionResult<span class="token punctuation">(</span>
            task<span class="token operator">=</span>task<span class="token punctuation">,</span>
            mastery_delta<span class="token operator">=</span>mastery_delta<span class="token punctuation">,</span>
            expansion_queued<span class="token operator">=</span>task<span class="token punctuation">.</span>auto_expand_enabled
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">suggest_tasks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> context<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ™ºèƒ½ä»»åŠ¡å»ºè®®"""</span>
        <span class="token comment"># 1. åˆ†æç”¨æˆ·å½“å‰çŠ¶æ€</span>
        progress <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_learning_progress<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

        <span class="token comment"># 2. åŸºäºçŠ¶æ€ç”Ÿæˆå»ºè®®</span>
        suggestions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment"># 2.1 éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹</span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'review_needed'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"TRAINING"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"å¤ä¹  </span><span class="token interpolation"><span class="token punctuation">{</span>progress<span class="token punctuation">[</span><span class="token string">'review_needed'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> ä¸ªçŸ¥è¯†ç‚¹"</span></span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"high"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># 2.2 é”™é¢˜ä¿®å¤</span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'error_count'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"ERROR_FIX"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"ä¿®å¤ </span><span class="token interpolation"><span class="token punctuation">{</span>progress<span class="token punctuation">[</span><span class="token string">'error_count'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> ä¸ªé”™é¢˜"</span></span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"high"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># 2.3 æ–°çŸ¥è¯†ç‚¹å­¦ä¹ </span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'unlocked_nodes'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"LEARNING"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"å­¦ä¹ æ–°çŸ¥è¯†ç‚¹"</span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"medium"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># 2.4 åæ€æ€»ç»“</span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'study_count'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"REFLECTION"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"æœ¬å‘¨å­¦ä¹ æ€»ç»“"</span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"low"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> suggestions
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-13">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä»»åŠ¡ç±»å‹çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>å­¦ä¹ ä»»åŠ¡</strong>: æ–°çŸ¥è¯†ç‚¹å­¦ä¹ ï¼Œå…³è”æŒæ¡åº¦</li>
<li><strong>è®­ç»ƒä»»åŠ¡</strong>: å¤ä¹ å·²å­¦çŸ¥è¯†ï¼Œå·©å›ºè®°å¿†</li>
<li><strong>çº é”™ä»»åŠ¡</strong>: é’ˆå¯¹é”™é¢˜ï¼Œç²¾å‡†æå‡</li>
<li><strong>åæ€ä»»åŠ¡</strong>: æ€»ç»“å½’çº³ï¼Œå½¢æˆçŸ¥è¯†ä½“ç³»</li>
<li><strong>ç¤¾äº¤ä»»åŠ¡</strong>: ä¸ä»–äººäº’åŠ¨ï¼Œä¿ƒè¿›å­¦ä¹ </li>
<li><strong>è§„åˆ’ä»»åŠ¡</strong>: åˆ¶å®šè®¡åˆ’ï¼Œæ˜ç¡®ç›®æ ‡</li>
</ul>
<p><strong>è·¨åŸŸè”åŠ¨çš„å®ç°:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ä»»åŠ¡å®Œæˆ â†’ æŒæ¡åº¦æ›´æ–° â†’ çŸ¥è¯†æ‹“å±• â†’ æ–°ä»»åŠ¡ç”Ÿæˆ
    â†“            â†“            â†“            â†“
  Task        Galaxy       Expansion    Suggestion
</code></pre><ul>
<li><strong>äº‹ä»¶é©±åŠ¨</strong>: ä»»åŠ¡å®Œæˆè§¦å‘æŒæ¡åº¦æ›´æ–°</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>: çŸ¥è¯†æ‹“å±•æ”¾å…¥é˜Ÿåˆ—ï¼Œä¸é˜»å¡ä¸»æµç¨‹</li>
<li><strong>é—­ç¯åé¦ˆ</strong>: æ–°çŸ¥è¯†è‡ªåŠ¨è½¬åŒ–ä¸ºæ–°ä»»åŠ¡</li>
</ul>
<p><strong>æ™ºèƒ½å»ºè®®çš„ç®—æ³•:</strong></p>
<ul>
<li><strong>ä¼˜å…ˆçº§</strong>: åŸºäºç´§æ€¥ç¨‹åº¦å’Œé‡è¦æ€§</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ ¹æ®ç”¨æˆ·çŠ¶æ€å’Œå†å²</li>
<li><strong>å¤šæ ·æ€§</strong>: ä¸åŒç±»å‹ä»»åŠ¡ç»„åˆ</li>
<li><strong>å¯è¡Œæ€§</strong>: è€ƒè™‘ç”¨æˆ·æ—¶é—´å’Œèƒ½åŠ›</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-13">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ä»»åŠ¡ç³»ç»Ÿå¦‚ä½•ä¿è¯å»ºè®®çš„ä¸ªæ€§åŒ–ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç”¨æˆ·ç”»åƒ</strong>: å­¦ä¹ è¿›åº¦ã€æ´»è·ƒæ—¶é—´ã€åå¥½</li>
<li><strong>å†å²æ•°æ®</strong>: è¿‡å¾€ä»»åŠ¡å®Œæˆæƒ…å†µ</li>
<li><strong>å®æ—¶çŠ¶æ€</strong>: å½“å‰æŒæ¡åº¦ã€é”™é¢˜åˆ†å¸ƒ</li>
<li><strong>ç®—æ³•æ¨¡å‹</strong>: åŸºäºè§„åˆ™ + æœºå™¨å­¦ä¹ </li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬çš„ä»»åŠ¡å»ºè®®ç³»ç»Ÿæ˜¯å¤šç»´åº¦çš„ã€‚é¦–å…ˆï¼Œåˆ†æç”¨æˆ·ç”»åƒï¼ŒåŒ…æ‹¬å­¦ä¹ è¿›åº¦ã€æ´»è·ƒæ—¶é—´æ®µã€åå¥½ç±»å‹ï¼›å…¶æ¬¡ï¼ŒæŸ¥çœ‹å†å²æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·æ“…é•¿é€‰æ‹©å“ªç§ä»»åŠ¡ã€å®Œæˆç‡å¦‚ä½•ï¼›ç¬¬ä¸‰ï¼Œå®æ—¶çŠ¶æ€ï¼Œå¦‚å½“å‰éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹æ•°é‡ã€é”™é¢˜åˆ†å¸ƒï¼›æœ€åï¼Œç»“åˆä¼˜å…ˆçº§ç®—æ³•ï¼Œç´§æ€¥ä¸”é‡è¦çš„ä»»åŠ¡ä¼˜å…ˆæ¨èã€‚æœªæ¥æˆ‘ä»¬ä¼šå¼•å…¥æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæ ¹æ®ç”¨æˆ·åé¦ˆä¸æ–­ä¼˜åŒ–æ¨èç­–ç•¥ã€‚"</p>
</blockquote>
<hr>
<h2 id="63-æ™ºèƒ½æ¨é€ç³»ç»Ÿ">6.3 æ™ºèƒ½æ¨é€ç³»ç»Ÿ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-20">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>æ™ºèƒ½æ¨é€ç³»ç»Ÿæ˜¯ Sparkle çš„ <strong>ç”¨æˆ·è§¦è¾¾å¼•æ“</strong>ï¼Œé‡‡ç”¨ <strong>Persona ç­–ç•¥</strong> å’Œ <strong>æ¼æ–—è¯„ä¼°</strong>ï¼š</p>
<ul>
<li><strong>Persona ç­–ç•¥</strong>: å†²åˆºæé†’ã€è®°å¿†å”¤é†’ã€æ²‰ç¡å”¤é†’</li>
<li><strong>é¢‘ç‡æ§åˆ¶</strong>: æ¯æ—¥ä¸Šé™ã€å»é‡æ£€æŸ¥</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ—¶åŒºã€æ´»è·ƒæ—¶æ®µã€åå¥½é…ç½®</li>
<li><strong>æ¼æ–—è¯„ä¼°</strong>: ç´§æ€¥ &gt; éœ€è¦ &gt; å…´è¶£</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-20">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/push_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">PushService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ™ºèƒ½æ¨é€æœåŠ¡"""</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">send_smart_push</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PushResult<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ™ºèƒ½æ¨é€ä¸»æµç¨‹"""</span>
        
        <span class="token comment"># ========== ç¬¬1æ­¥ï¼šè·å–ç”¨æˆ·é…ç½®å’ŒçŠ¶æ€ ==========</span>
        pref <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get_preferences<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> pref<span class="token punctuation">.</span>enable_curiosity<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"æ¨é€å·²å…³é—­"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬2æ­¥ï¼šé¢‘ç‡æ§åˆ¶ ==========</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_frequency<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> pref<span class="token punctuation">.</span>daily_cap<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"è¾¾åˆ°æ¯æ—¥ä¸Šé™"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬3æ­¥ï¼šPersona ç­–ç•¥é€‰æ‹© ==========</span>
        persona <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_select_persona<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> pref<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬4æ­¥ï¼šå†…å®¹ç”Ÿæˆä¸å»é‡ ==========</span>
        content <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_generate_content<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> persona<span class="token punctuation">)</span>
        content_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_is_duplicate<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> content_hash<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"å†…å®¹å·²æ¨é€"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬5æ­¥ï¼šæ—¶æœºåˆ¤æ–­ï¼ˆæ´»è·ƒæ—¶æ®µï¼‰ ==========</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_is_active_time<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> pref<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"éæ´»è·ƒæ—¶æ®µ"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬6æ­¥ï¼šå®é™…æ¨é€ ==========</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_send_push<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> content<span class="token punctuation">,</span> persona<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬7æ­¥ï¼šè®°å½•å†å² ==========</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_record_push_history<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> content_hash<span class="token punctuation">,</span> persona<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>success<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">,</span> persona<span class="token operator">=</span>persona<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_select_persona</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pref<span class="token punctuation">:</span> PushPreferences<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Persona ç­–ç•¥é€‰æ‹©"""</span>
        
        <span class="token comment"># è·å–ç”¨æˆ·çŠ¶æ€</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_user_state<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        
        <span class="token comment"># æ¼æ–—è¯„ä¼°</span>
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'sprint_deadline'</span><span class="token punctuation">]</span> <span class="token keyword keyword-and">and</span> state<span class="token punctuation">[</span><span class="token string">'sprint_progress'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0.8</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"sprint_reminder"</span>  <span class="token comment"># å†²åˆºæé†’</span>
        
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'review_needed'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"memory_wakeup"</span>  <span class="token comment"># è®°å¿†å”¤é†’</span>
        
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'last_active_days'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">7</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"sleep_wakeup"</span>  <span class="token comment"># æ²‰ç¡å”¤é†’</span>
        
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'unlocked_nodes'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"curiosity"</span>  <span class="token comment"># æ¿€å‘å…´è¶£</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token string">"general"</span>  <span class="token comment"># é€šç”¨æ¨é€</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_generate_content</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> persona<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""åŸºäº Persona ç”Ÿæˆæ¨é€å†…å®¹"""</span>
        
        templates <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"sprint_reminder"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸš€ å†²åˆºæé†’ï¼šä½ çš„ {sprint_name} è¿˜å‰© {days} å¤©ï¼Œå½“å‰è¿›åº¦ {progress}%ï¼"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸ’ª åŠ æ²¹ï¼ä»Šå¤©å®Œæˆ 3 ä¸ªä»»åŠ¡å³å¯è¾¾æˆæœ¬å‘¨ç›®æ ‡ï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"memory_wakeup"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸ§  è®°å¿†å”¤é†’ï¼šä½ æœ‰ {count} ä¸ªçŸ¥è¯†ç‚¹éœ€è¦å¤ä¹ äº†ï¼"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸ’¡ è‰¾å®¾æµ©æ–¯æ›²çº¿æ˜¾ç¤ºï¼Œç°åœ¨æ˜¯æœ€ä½³å¤ä¹ æ—¶æœºï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"sleep_wakeup"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸ‘‹ æƒ³ä½ äº†ï¼å·²ç» {days} å¤©æ²¡å­¦ä¹ äº†ï¼Œå›æ¥ç»§ç»­æ¢ç´¢çŸ¥è¯†æ˜Ÿå›¾å§ï¼"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸŒŸ æ–°ä¸Šçº¿äº† {new_feature}ï¼Œç­‰ä½ æ¥ä½“éªŒï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"curiosity"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"âœ¨ å¥½å¥‡å¿ƒï¼šä½ çŸ¥é“ {related_concept} å’Œ {current_topic} çš„å…³ç³»å—ï¼Ÿ"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸ¯ è§£é”æ–°çŸ¥è¯†ç‚¹ï¼Œæ‰©å±•ä½ çš„çŸ¥è¯†æ˜Ÿå›¾ï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"general"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸ“š ä»Šæ—¥æ¨èï¼šå­¦ä¹  {recommended_node}ï¼Œé¢„è®¡ 20 åˆ†é’Ÿ"</span><span class="token punctuation">,</span>
                <span class="token string">"âš¡ å°è´´å£«ï¼šè¿ç»­å­¦ä¹  3 å¤©å¯è·å¾—åŒå€ç§¯åˆ†ï¼"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment"># å¡«å……æ¨¡æ¿å˜é‡</span>
        template <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>templates<span class="token punctuation">.</span>get<span class="token punctuation">(</span>persona<span class="token punctuation">,</span> templates<span class="token punctuation">[</span><span class="token string">"general"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        variables <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_template_variables<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        content <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>variables<span class="token punctuation">)</span>
        
        <span class="token keyword keyword-return">return</span> content

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_check_frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> daily_cap<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""é¢‘ç‡æ§åˆ¶"""</span>
        today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"push_count:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        count <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        
        <span class="token keyword keyword-if">if</span> count <span class="token keyword keyword-and">and</span> <span class="token builtin">int</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> daily_cap<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_is_active_time</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pref<span class="token punctuation">:</span> PushPreferences<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ´»è·ƒæ—¶æ®µåˆ¤æ–­"""</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>pytz<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span>pref<span class="token punctuation">.</span>timezone<span class="token punctuation">)</span><span class="token punctuation">)</span>
        current_time <span class="token operator">=</span> now<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-for">for</span> slot <span class="token keyword keyword-in">in</span> pref<span class="token punctuation">.</span>active_slots<span class="token punctuation">:</span>
            start <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>slot<span class="token punctuation">[</span><span class="token string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'%H:%M'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            end <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>slot<span class="token punctuation">[</span><span class="token string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'%H:%M'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword keyword-if">if</span> start <span class="token operator">&lt;=</span> current_time <span class="token operator">&lt;=</span> end<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-14">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>Persona ç­–ç•¥çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>å†²åˆºæé†’</strong>: é’ˆå¯¹æœ‰æ˜ç¡®ç›®æ ‡çš„ç”¨æˆ·ï¼Œå¼ºè°ƒç´§è¿«æ„Ÿ</li>
<li><strong>è®°å¿†å”¤é†’</strong>: é’ˆå¯¹éœ€è¦å¤ä¹ çš„ç”¨æˆ·ï¼Œå¼ºè°ƒç§‘å­¦æ€§</li>
<li><strong>æ²‰ç¡å”¤é†’</strong>: é’ˆå¯¹æµå¤±ç”¨æˆ·ï¼Œå¼ºè°ƒæ–°å¥‡æ„Ÿå’Œå½’å±æ„Ÿ</li>
<li><strong>æ¿€å‘å…´è¶£</strong>: é’ˆå¯¹æ–°æ‰‹ï¼Œå¼ºè°ƒæ¢ç´¢å’Œå‘ç°</li>
</ul>
<p><strong>æ¼æ–—è¯„ä¼°çš„é€»è¾‘:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ç´§æ€¥? â†’ éœ€è¦? â†’ å…´è¶£? â†’ é€šç”¨
  â†“       â†“       â†“       â†“
å†²åˆº    å¤ä¹     æ¢ç´¢    æ¨è
</code></pre><ul>
<li><strong>ä¼˜å…ˆçº§</strong>: ç´§æ€¥ä»»åŠ¡ &gt; éœ€è¦å¤ä¹  &gt; å…´è¶£æ¢ç´¢ &gt; é€šç”¨æ¨è</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ¯ä¸ªå±‚çº§éƒ½åŸºäºç”¨æˆ·çŠ¶æ€</li>
<li><strong>è¦†ç›–ç‡</strong>: ç¡®ä¿æ¯ä¸ªç”¨æˆ·éƒ½èƒ½æ”¶åˆ°åˆé€‚çš„æ¨é€</li>
</ul>
<p><strong>é¢‘ç‡æ§åˆ¶çš„ç­–ç•¥:</strong></p>
<ul>
<li><strong>æ¯æ—¥ä¸Šé™</strong>: é˜²æ­¢è¿‡åº¦æ‰“æ‰°</li>
<li><strong>å»é‡æ£€æŸ¥</strong>: é¿å…é‡å¤å†…å®¹</li>
<li><strong>æ´»è·ƒæ—¶æ®µ</strong>: åªåœ¨ç”¨æˆ·å¯èƒ½æ´»è·ƒæ—¶æ¨é€</li>
<li><strong>æ™ºèƒ½é™çº§</strong>: è¾¾åˆ°ä¸Šé™åè‡ªåŠ¨é™çº§ä¸ºé™é»˜æ¨é€</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-14">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•é¿å…æ¨é€ç³»ç»Ÿæ‰“æ‰°ç”¨æˆ·ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>é¢‘ç‡é™åˆ¶</strong>: æ¯æ—¥ä¸Šé™ï¼Œå¯é…ç½®</li>
<li><strong>æ´»è·ƒæ—¶æ®µ</strong>: åªåœ¨ç”¨æˆ·æ´»è·ƒæ—¶æ¨é€</li>
<li><strong>ç”¨æˆ·åå¥½</strong>: ç”¨æˆ·å¯å…³é—­æˆ–è°ƒæ•´é¢‘ç‡</li>
<li><strong>å†…å®¹è´¨é‡</strong>: æ¨é€å¿…é¡»æœ‰ä»·å€¼ï¼Œé¿å…çº¯è¥é”€</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬ä»å››ä¸ªå±‚é¢é¿å…æ‰“æ‰°ç”¨æˆ·ï¼šç¬¬ä¸€ï¼Œä¸¥æ ¼çš„é¢‘ç‡æ§åˆ¶ï¼Œæ¯æ—¥æ¨é€ä¸Šé™é»˜è®¤ 3 æ¡ï¼Œç”¨æˆ·å¯è°ƒæ•´ï¼›ç¬¬äºŒï¼Œæ´»è·ƒæ—¶æ®µåˆ¤æ–­ï¼Œåªåœ¨ç”¨æˆ·é€šå¸¸æ´»è·ƒçš„æ—¶é—´æ®µæ¨é€ï¼›ç¬¬ä¸‰ï¼Œç”¨æˆ·åå¥½ï¼Œç”¨æˆ·å¯ä»¥å®Œå…¨å…³é—­æ¨é€æˆ–åªæ¥æ”¶ç‰¹å®šç±»å‹ï¼›ç¬¬å››ï¼Œå†…å®¹è´¨é‡ï¼Œæ¯æ¡æ¨é€éƒ½å¿…é¡»æœ‰å®é™…ä»·å€¼ï¼Œå¦‚å¤ä¹ æé†’ã€è¿›åº¦æ›´æ–°ï¼Œç»ä¸å‘é€çº¯è¥é”€å†…å®¹ã€‚æˆ‘ä»¬è¿˜ä¼šç›‘æ§ç”¨æˆ·åé¦ˆï¼Œå¦‚æœæŸç±»æ¨é€çš„å¿½ç•¥ç‡è¿‡é«˜ï¼Œä¼šè‡ªåŠ¨è°ƒæ•´ç­–ç•¥ã€‚"</p>
</blockquote>
<hr>
<h1 id="ä¸ƒ-ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º">ä¸ƒã€ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º </h1>
<h2 id="71-ç†”æ–­å™¨-circuit-breaker">7.1 ç†”æ–­å™¨ (Circuit Breaker) </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-21">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ç†”æ–­å™¨æ˜¯ <strong>ç³»ç»Ÿè‡ªä¿æŠ¤æœºåˆ¶</strong>ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼š</p>
<ul>
<li><strong>çŠ¶æ€æœº</strong>: CLOSED â†’ OPEN â†’ HALF_OPEN</li>
<li><strong>æ•…éšœæ£€æµ‹</strong>: é”™è¯¯ç‡ã€è¶…æ—¶ç‡</li>
<li><strong>å¿«é€Ÿå¤±è´¥</strong>: ç†”æ–­çŠ¶æ€ä¸‹ç›´æ¥æ‹’ç»è¯·æ±‚</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: å†·å´åå°è¯•æ¢å¤</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-21">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/circuit_breaker.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    ç†”æ–­å™¨æ¨¡å¼ï¼šç³»ç»Ÿè‡ªä¿æŠ¤çš„â€œä¿é™©ä¸â€
    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> failure_threshold<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> recovery_timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>failure_threshold <span class="token operator">=</span> failure_threshold  <span class="token comment"># é”™è¯¯é˜ˆå€¼</span>
        self<span class="token punctuation">.</span>recovery_timeout <span class="token operator">=</span> recovery_timeout    <span class="token comment"># æ¢å¤è¶…æ—¶</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span><span class="token string">"redis://localhost:6379"</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">can_execute</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œ"""</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_state_from_redis<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> state <span class="token operator">==</span> <span class="token string">"OPEN"</span><span class="token punctuation">:</span>
            <span class="token comment"># æ£€æŸ¥å†·å´æ—¶é—´æ˜¯å¦å·²è¿‡</span>
            <span class="token keyword keyword-if">if</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>last_failure_time <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>recovery_timeout<span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"HALF_OPEN"</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>  <span class="token comment"># æ‹’ç»è¯·æ±‚</span>

        <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">record_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•æˆåŠŸ"""</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_state<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"HALF_OPEN"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"CLOSED"</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_reset_failure_count<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">record_failure</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•å¤±è´¥"""</span>
        failure_count <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_increment_failure_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-if">if</span> failure_count <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>failure_threshold<span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"OPEN"</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>last_failure_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_get_state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è·å–å½“å‰çŠ¶æ€"""</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"circuit_breaker:state"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> state<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> state <span class="token keyword keyword-else">else</span> <span class="token string">"CLOSED"</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_set_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®¾ç½®çŠ¶æ€"""</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"circuit_breaker:state"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> state <span class="token operator">==</span> <span class="token string">"OPEN"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"circuit_breaker:last_failure"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_increment_failure_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""å¢åŠ å¤±è´¥è®¡æ•°"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">"circuit_breaker:failure_count"</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_reset_failure_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""é‡ç½®å¤±è´¥è®¡æ•°"""</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string">"circuit_breaker:failure_count"</span><span class="token punctuation">)</span>
</code></pre><p><strong>åœ¨ç¼–æ’å™¨ä¸­çš„ä½¿ç”¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ç¬¬2æ­¥ï¼šæœåŠ¡ç†”æ–­å™¨æ£€æŸ¥</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>can_execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"CIRCUIT_BREAKER_OPEN"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"ç³»ç»Ÿè¿‡è½½"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>

    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ... å¤„ç†é€»è¾‘ ...</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>record_success<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>record_failure<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-raise">raise</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-15">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç†”æ–­å™¨çš„çŠ¶æ€æœº:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>CLOSED (æ­£å¸¸)
    â†“ é”™è¯¯ç‡ &gt; é˜ˆå€¼
OPEN (ç†”æ–­)
    â†“ å†·å´æ—¶é—´ç»“æŸ
HALF_OPEN (åŠå¼€)
    â†“ æˆåŠŸ/å¤±è´¥
CLOSED (æ¢å¤) / OPEN (å†æ¬¡ç†”æ–­)
</code></pre><p><strong>ç†”æ–­å™¨çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>å¿«é€Ÿå¤±è´¥</strong>: é¿å…é•¿æ—¶é—´ç­‰å¾…ï¼Œå‡å°‘èµ„æºæ¶ˆè€—</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: é˜²æ­¢é—®é¢˜æ‰©æ•£åˆ°æ•´ä¸ªç³»ç»Ÿ</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: ç»™ä¸‹æ¸¸æœåŠ¡æ¢å¤æ—¶é—´</li>
<li><strong>é™çº§æç¤º</strong>: è¿”å›å‹å¥½é”™è¯¯ï¼Œè€Œéè¶…æ—¶æˆ–å´©æºƒ</li>
</ul>
<p><strong>ç†”æ–­å™¨çš„å‚æ•°è°ƒä¼˜:</strong></p>
<ul>
<li><strong>é”™è¯¯é˜ˆå€¼</strong>: å¤ªä½ä¼šé¢‘ç¹ç†”æ–­ï¼Œå¤ªé«˜å¤±å»ä¿æŠ¤ä½œç”¨</li>
<li><strong>å†·å´æ—¶é—´</strong>: å¤ªçŸ­æ— æ³•æ¢å¤ï¼Œå¤ªé•¿å½±å“å¯ç”¨æ€§</li>
<li><strong>åŠå¼€çŠ¶æ€</strong>: å…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•æ¢å¤æƒ…å†µ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-15">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ç†”æ–­å™¨å’Œé™æµæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç›®çš„</strong>: ç†”æ–­ä¿æŠ¤ä¸‹æ¸¸ï¼Œé™æµä¿æŠ¤è‡ªèº«</li>
<li><strong>è§¦å‘æ¡ä»¶</strong>: ç†”æ–­åŸºäºé”™è¯¯ç‡ï¼Œé™æµåŸºäºè¯·æ±‚é‡</li>
<li><strong>ä½œç”¨å¯¹è±¡</strong>: ç†”æ–­é’ˆå¯¹ç‰¹å®šæœåŠ¡ï¼Œé™æµé’ˆå¯¹ç”¨æˆ·/IP</li>
<li><strong>æ¢å¤æœºåˆ¶</strong>: ç†”æ–­è‡ªåŠ¨æ¢å¤ï¼Œé™æµéœ€è¦ç­‰å¾…çª—å£é‡ç½®</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ç†”æ–­å™¨å’Œé™æµæ˜¯ä¸¤ç§ä¸åŒçš„ä¿æŠ¤æœºåˆ¶ã€‚ç†”æ–­å™¨ä¿æŠ¤çš„æ˜¯ä¸‹æ¸¸æœåŠ¡ï¼Œå½“æ£€æµ‹åˆ°ä¸‹æ¸¸æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ–­è°ƒç”¨ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼ŒåŸºäºé”™è¯¯ç‡è§¦å‘ã€‚é™æµä¿æŠ¤çš„æ˜¯è‡ªèº«ç³»ç»Ÿï¼Œé˜²æ­¢è¢«è¿‡å¤šè¯·æ±‚å‹å®ï¼ŒåŸºäºè¯·æ±‚é‡è§¦å‘ã€‚åœ¨ Sparkle ä¸­ï¼Œç†”æ–­å™¨ç”¨äºä¿æŠ¤ LLM æœåŠ¡ï¼Œé™æµç”¨äºä¿æŠ¤ç½‘å…³å±‚ã€‚ä¸¤è€…å¯ä»¥é…åˆä½¿ç”¨ï¼šå…ˆé™æµé˜²æ­¢è¿‡è½½ï¼Œå¦‚æœä»ç„¶å‡ºé”™åˆ™ç†”æ–­ã€‚"</p>
</blockquote>
<hr>
<h2 id="72-å¹‚ç­‰æ€§ä¸å»é‡">7.2 å¹‚ç­‰æ€§ä¸å»é‡ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-22">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å¹‚ç­‰æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ <strong>åŸºçŸ³</strong>ï¼Œä¿è¯é‡å¤è¯·æ±‚ç»“æœä¸€è‡´ï¼š</p>
<ul>
<li><strong>è¯·æ±‚ ID</strong>: å‰ç«¯ç”Ÿæˆå”¯ä¸€ ID</li>
<li><strong>å»é‡å­˜å‚¨</strong>: Redis è®°å½•å·²å¤„ç†è¯·æ±‚</li>
<li><strong>TTL</strong>: è‡ªåŠ¨è¿‡æœŸï¼Œé¿å…å­˜å‚¨æ— é™å¢é•¿</li>
<li><strong>é˜²é‡è¯•å‰¯ä½œç”¨</strong>: é¿å…é‡å¤æ‰£è´¹ã€å†™åº“</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-22">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/message_tracker.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">MessageTracker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ¶ˆæ¯å»é‡ï¼šé˜²æ­¢é‡å¤å¤„ç†"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client
        self<span class="token punctuation">.</span>ttl <span class="token operator">=</span> ttl  <span class="token comment"># 24å°æ—¶è¿‡æœŸ</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">is_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ£€æŸ¥è¯·æ±‚æ˜¯å¦å·²å¤„ç†"""</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>key<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">mark_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ‡è®°è¯·æ±‚ä¸ºå·²å¤„ç†"""</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ttl<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">is_duplicate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> content_hash<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ£€æŸ¥å†…å®¹æ˜¯å¦é‡å¤ï¼ˆç”¨äºæ¨é€å»é‡ï¼‰"""</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"content_hash:</span><span class="token interpolation"><span class="token punctuation">{</span>content_hash<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token comment"># æ£€æŸ¥è¯¥å†…å®¹æ˜¯å¦åœ¨ 24 å°æ—¶å†…ç»™è¯¥ç”¨æˆ·æ¨é€è¿‡</span>
        user_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">:user:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>user_key<span class="token punctuation">)</span>
</code></pre><p><strong>åœ¨ç¼–æ’å™¨ä¸­çš„ä½¿ç”¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ç¬¬1æ­¥ï¼šåˆ†å¸ƒå¼æ¶ˆæ¯å»é‡</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>is_processed<span class="token punctuation">(</span>request<span class="token punctuation">.</span>request_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"DUPLICATE_REQUEST"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"è¯·æ±‚å·²å¤„ç†"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>

    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ... å¤„ç†é€»è¾‘ ...</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>mark_processed<span class="token punctuation">(</span>request<span class="token punctuation">.</span>request_id<span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
        <span class="token comment"># åªæœ‰æˆåŠŸå¤„ç†æ‰æ ‡è®°ï¼Œå¤±è´¥å¯ä»¥é‡è¯•</span>
        <span class="token keyword keyword-raise">raise</span>
</code></pre><p><strong>å‰ç«¯è¯·æ±‚ ID ç”Ÿæˆï¼š</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/core/utils/request_id_generator.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">RequestIdGenerator</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-static">static</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> timestamp <span class="token operator">=</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>millisecondsSinceEpoch<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> random <span class="token operator">=</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">userId</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">timestamp</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">random</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-16">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å¹‚ç­‰æ€§çš„å¿…è¦æ€§:</strong></p>
<ul>
<li><strong>ç½‘ç»œä¸å¯é </strong>: è¯·æ±‚å¯èƒ½è¶…æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šé‡è¯•</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>: æ¶ˆæ¯å¯èƒ½è¢«é‡å¤æŠ•é€’</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>: è¯·æ±‚å¯èƒ½è¢«è½¬å‘åˆ°ä¸åŒå®ä¾‹</li>
<li><strong>ç”¨æˆ·è¡Œä¸º</strong>: ç”¨æˆ·å¯èƒ½é‡å¤ç‚¹å‡»æäº¤æŒ‰é’®</li>
</ul>
<p><strong>å»é‡ç­–ç•¥çš„é€‰æ‹©:</strong></p>
<ul>
<li><strong>è¯·æ±‚ ID å»é‡</strong>: é€‚åˆåˆ›å»ºç±»æ“ä½œï¼ˆåˆ›å»ºä»»åŠ¡ã€å‘é€æ¶ˆæ¯ï¼‰</li>
<li><strong>å†…å®¹å“ˆå¸Œå»é‡</strong>: é€‚åˆæ¨é€ç±»æ“ä½œï¼Œé¿å…é‡å¤å†…å®¹</li>
<li><strong>ä¸šåŠ¡é”®å»é‡</strong>: é€‚åˆç‰¹å®šä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚æ”¯ä»˜è®¢å•å·ï¼‰</li>
</ul>
<p><strong>TTL çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>å¤ªçŸ­</strong>: å¯èƒ½é”™è¿‡é‡è¯•ï¼Œå¯¼è‡´é‡å¤å¤„ç†</li>
<li><strong>å¤ªé•¿</strong>: å ç”¨ Redis å†…å­˜</li>
<li><strong>å¹³è¡¡</strong>: 24 å°æ—¶é€šå¸¸è¶³å¤Ÿè¦†ç›–æ‰€æœ‰é‡è¯•åœºæ™¯</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-16">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¹‚ç­‰çš„åˆ›å»ºä»»åŠ¡æ¥å£ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>è¯·æ±‚ ID</strong>: å‰ç«¯ç”Ÿæˆå”¯ä¸€ ID</li>
<li><strong>å”¯ä¸€ç´¢å¼•</strong>: æ•°æ®åº“å±‚é¢ä¿è¯ä¸é‡å¤</li>
<li><strong>å»é‡æ£€æŸ¥</strong>: Redis å¿«é€Ÿæ£€æŸ¥</li>
<li><strong>äº‹åŠ¡ä¿è¯</strong>: æ•°æ®åº“æ“ä½œåŸå­æ€§</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"å¹‚ç­‰çš„åˆ›å»ºä»»åŠ¡æ¥å£éœ€è¦ä¸‰å±‚é˜²æŠ¤ï¼šç¬¬ä¸€ï¼Œå‰ç«¯ç”Ÿæˆå”¯ä¸€è¯·æ±‚ IDï¼Œä½œä¸ºå¹‚ç­‰é”®ï¼›ç¬¬äºŒï¼ŒRedis å¿«é€Ÿå»é‡ï¼Œå¦‚æœå·²å­˜åœ¨ç›´æ¥è¿”å›æˆåŠŸï¼›ç¬¬ä¸‰ï¼Œæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼Œå³ä½¿ Redis å¤±æ•ˆä¹Ÿèƒ½ä¿è¯ä¸é‡å¤ï¼›ç¬¬å››ï¼Œæ•´ä¸ªæ“ä½œåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä¿è¯åŸå­æ€§ã€‚è¿™æ ·å³ä½¿å®¢æˆ·ç«¯é‡å¤æäº¤ï¼Œç»“æœä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚"</p>
</blockquote>
<hr>
<h2 id="73-åˆ†å¸ƒå¼é”">7.3 åˆ†å¸ƒå¼é” </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-23">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>åˆ†å¸ƒå¼é”æ˜¯ <strong>å¤šæœºå¹¶å‘æ§åˆ¶</strong> çš„æ ¸å¿ƒï¼ŒåŸºäº Redis å®ç°ï¼š</p>
<ul>
<li><strong>åŸå­äº‰æŠ¢</strong>: SET NX EX æŒ‡ä»¤</li>
<li><strong>TTL é˜²æ­»é”</strong>: è‡ªåŠ¨è¿‡æœŸ</li>
<li><strong>é”ç»­æœŸ</strong>: é•¿ä»»åŠ¡è‡ªåŠ¨å»¶é•¿é”æ—¶é—´</li>
<li><strong>é˜²è¯¯åˆ </strong>: åªæœ‰æŒæœ‰é”çš„å®ä¾‹æ‰èƒ½é‡Šæ”¾</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-23">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/distributed_lock.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åŸºäº Redis çš„åˆ†å¸ƒå¼æ’ä»–é”"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">acquire</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        è·å–é”
        - timeout: é”çš„è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
        """</span>
        <span class="token comment"># ä½¿ç”¨ SET NX EX åŸå­æŒ‡ä»¤</span>
        <span class="token comment"># NX: åªåœ¨ Key ä¸å­˜åœ¨æ—¶è®¾ç½®</span>
        <span class="token comment"># EX: è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</span>
        acquired <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>
            lock_key<span class="token punctuation">,</span>
            value<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># éšæœºå€¼ï¼Œç”¨äºå®‰å…¨é‡Šæ”¾</span>
            nx<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            ex<span class="token operator">=</span>timeout
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> acquired <span class="token keyword keyword-is">is</span> <span class="token boolean">True</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">release</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> lock_value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        é‡Šæ”¾é”
        - ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§
        - åªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾
        """</span>
        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        if redis.call("GET", KEYS[1]) == ARGV[1] then
            return redis.call("DEL", KEYS[1])
        else
            return 0
        end
        """</span>
        
        result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> result <span class="token operator">==</span> <span class="token number">1</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">extend</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> lock_value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> additional_time<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        ç»­æœŸé”
        - ç”¨äºé•¿ä»»åŠ¡
        """</span>
        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        if redis.call("GET", KEYS[1]) == ARGV[1] then
            return redis.call("EXPIRE", KEYS[1], ARGV[2])
        else
            return 0
        end
        """</span>
        
        result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>
            script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> additional_time
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> result <span class="token operator">==</span> <span class="token number">1</span>

<span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">LockedSessionManager</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> DistributedLock<span class="token punctuation">(</span>redis_client<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_session</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        lock_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"session_lock:</span><span class="token interpolation"><span class="token punctuation">{</span>session_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        
        <span class="token comment"># è·å–é”</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> ConcurrentModificationError<span class="token punctuation">(</span><span class="token string">"Session is locked"</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token comment"># ç»­æœŸä»»åŠ¡ï¼ˆå¦‚æœéœ€è¦é•¿æ—¶é—´å¤„ç†ï¼‰</span>
            extend_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>_auto_extend<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            
            <span class="token comment"># æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span>
            result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_process_session_logic<span class="token punctuation">(</span>session_id<span class="token punctuation">)</span>
            
            extend_task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> result
            
        <span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># é‡Šæ”¾é”</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_auto_extend</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> lock_value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è‡ªåŠ¨ç»­æœŸ"""</span>
        <span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>  <span class="token comment"># æ¯ 20 ç§’ç»­æœŸä¸€æ¬¡</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-17">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>åˆ†å¸ƒå¼é”çš„å¿…è¦æ€§:</strong></p>
<ul>
<li><strong>å¹¶å‘å†²çª</strong>: å¤šä¸ª Worker åŒæ—¶ä¿®æ”¹åŒä¸€ç”¨æˆ·çŠ¶æ€</li>
<li><strong>æ•°æ®ä¸€è‡´æ€§</strong>: é˜²æ­¢è„è¯»ã€ä¸¢å¤±æ›´æ–°</li>
<li><strong>èµ„æºç«äº‰</strong>: é™åˆ¶åŒæ—¶å¤„ç†çš„ä¼šè¯æ•°</li>
</ul>
<p><strong>é”çš„å®ç°ç»†èŠ‚:</strong></p>
<ul>
<li><strong>åŸå­æ€§</strong>: SET NX EX æ˜¯åŸå­æ“ä½œï¼Œæ— ç«æ€æ¡ä»¶</li>
<li><strong>å®‰å…¨æ€§</strong>: éšæœºå€¼é˜²æ­¢è¯¯åˆ å…¶ä»–å®ä¾‹çš„é”</li>
<li><strong>å¯é æ€§</strong>: TTL é˜²æ­¢æ­»é”ï¼Œå³ä½¿æŒæœ‰è€…å´©æºƒä¹Ÿèƒ½è‡ªåŠ¨é‡Šæ”¾</li>
<li><strong>ç»­æœŸæœºåˆ¶</strong>: é•¿ä»»åŠ¡ä¸ä¼šå› é”è¿‡æœŸè€Œä¸­æ–­</li>
</ul>
<p><strong>é”çš„ç²’åº¦:</strong></p>
<ul>
<li><strong>ç²—ç²’åº¦</strong>: å…¨å±€é”ï¼Œå½±å“æ‰€æœ‰ç”¨æˆ·</li>
<li><strong>ç»†ç²’åº¦</strong>: ç”¨æˆ·çº§é”ï¼Œåªå½±å“å•ä¸ªç”¨æˆ·</li>
<li><strong>Sparkle</strong>: ä¼šè¯çº§é”ï¼Œå¹³è¡¡å¹¶å‘å’Œå®‰å…¨æ€§</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-17">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: Redis åˆ†å¸ƒå¼é”æœ‰ä»€ä¹ˆç¼ºé™·ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç¼ºé™·1</strong>: é”è¿‡æœŸåï¼Œä»»åŠ¡æœªå®Œæˆï¼Œå…¶ä»–å®ä¾‹è·å–é”</li>
<li><strong>ç¼ºé™·2</strong>: Redis ä¸»ä»åˆ‡æ¢å¯¼è‡´é”ä¸¢å¤±</li>
<li><strong>ç¼ºé™·3</strong>: æ—¶é’Ÿæ¼‚ç§»å¯¼è‡´é”æå‰è¿‡æœŸ</li>
<li><strong>è§£å†³</strong>: é”ç»­æœŸã€Redlock ç®—æ³•ã€ä¸šåŠ¡å¹‚ç­‰</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"Redis åˆ†å¸ƒå¼é”çš„ä¸»è¦ç¼ºé™·æ˜¯é”è¿‡æœŸé—®é¢˜ï¼šå¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”çš„ TTLï¼Œé”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå…¶ä»–å®ä¾‹å¯èƒ½è·å–é”å¹¶ä¿®æ”¹æ•°æ®ã€‚æˆ‘ä»¬é€šè¿‡é”ç»­æœŸæœºåˆ¶è§£å†³ï¼šå¯åŠ¨ä¸€ä¸ªåå°ä»»åŠ¡ï¼Œåœ¨é”è¿‡æœŸå‰è‡ªåŠ¨å»¶é•¿ã€‚å¯¹äºæç«¯æƒ…å†µï¼ˆå¦‚ Redis ä¸»ä»åˆ‡æ¢ï¼‰ï¼Œæˆ‘ä»¬ç»“åˆä¸šåŠ¡å¹‚ç­‰æ€§ä¿è¯ï¼šå³ä½¿é”å¤±æ•ˆï¼Œé‡å¤æ“ä½œçš„ç»“æœä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚å¯¹äºè¦æ±‚æé«˜ä¸€è‡´æ€§çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ Redlock ç®—æ³•ï¼Œä½†å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬çš„æ–¹æ¡ˆå·²è¶³å¤Ÿã€‚"</p>
</blockquote>
<hr>
<h2 id="74-ç›‘æ§ä¸å¯è§‚æµ‹æ€§">7.4 ç›‘æ§ä¸å¯è§‚æµ‹æ€§ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-24">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å¯è§‚æµ‹æ€§æ˜¯ç”Ÿäº§ç³»ç»Ÿçš„ <strong>çœ¼ç›</strong>ï¼Œé€šè¿‡ <strong>æŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ª</strong> å®ç°ï¼š</p>
<ul>
<li><strong>æŒ‡æ ‡ (Metrics)</strong>: é‡åŒ–ç³»ç»ŸçŠ¶æ€ï¼ˆQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ï¼‰</li>
<li><strong>æ—¥å¿— (Logs)</strong>: è®°å½•äº‹ä»¶è¯¦æƒ…ï¼ˆJSON æ ¼å¼ï¼Œæœºå™¨å¯è¯»ï¼‰</li>
<li><strong>è¿½è¸ª (Tracing)</strong>: è¯·æ±‚å…¨é“¾è·¯è¿½è¸ª</li>
<li><strong>å‘Šè­¦ (Alerting)</strong>: ä¸»åŠ¨å‘ç°é—®é¢˜</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-24">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/monitoring/metrics.py</span>

<span class="token keyword keyword-from">from</span> prometheus_client <span class="token keyword keyword-import">import</span> Counter<span class="token punctuation">,</span> Histogram<span class="token punctuation">,</span> Gauge<span class="token punctuation">,</span> start_http_server
<span class="token keyword keyword-import">import</span> time

<span class="token keyword keyword-class">class</span> <span class="token class-name">MetricsCollector</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Prometheus æŒ‡æ ‡æ”¶é›†å™¨"""</span>
    
    <span class="token comment"># 1. è®¡æ•°å™¨ (Counter): åªå¢ä¸å‡ï¼Œé€‚åˆæ€»é‡ç»Ÿè®¡</span>
    REQUEST_TOTAL <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        <span class="token string">'sparkle_requests_total'</span><span class="token punctuation">,</span>
        <span class="token string">'Total number of requests'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'service'</span><span class="token punctuation">,</span> <span class="token string">'endpoint'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 2. ç›´æ–¹å›¾ (Histogram): å»¶è¿Ÿåˆ†å¸ƒï¼Œæ”¯æŒåˆ†ä½æ•°</span>
    REQUEST_DURATION <span class="token operator">=</span> Histogram<span class="token punctuation">(</span>
        <span class="token string">'sparkle_request_duration_seconds'</span><span class="token punctuation">,</span>
        <span class="token string">'Request duration in seconds'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'service'</span><span class="token punctuation">,</span> <span class="token string">'endpoint'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        buckets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 3. ä»ªè¡¨ç›˜ (Gauge): å¯å¢å¯å‡ï¼Œé€‚åˆç¬æ—¶å€¼</span>
    ACTIVE_CONNECTIONS <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
        <span class="token string">'sparkle_active_connections'</span><span class="token punctuation">,</span>
        <span class="token string">'Number of active WebSocket connections'</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 4. ä¸šåŠ¡æŒ‡æ ‡</span>
    TOKEN_CONSUMPTION <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        <span class="token string">'sparkle_token_consumption'</span><span class="token punctuation">,</span>
        <span class="token string">'Token consumption by model'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">]</span>  <span class="token comment"># type: prompt/completion</span>
    <span class="token punctuation">)</span>
    
    CACHE_HIT_RATE <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
        <span class="token string">'sparkle_cache_hit_rate'</span><span class="token punctuation">,</span>
        <span class="token string">'Semantic cache hit rate'</span>
    <span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">MonitoredService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¸¦ç›‘æ§çš„æœåŠ¡åŸºç±»"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>service_name <span class="token operator">=</span> service_name
        self<span class="token punctuation">.</span>metrics <span class="token operator">=</span> MetricsCollector<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">record_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> endpoint<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> duration<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•è¯·æ±‚æŒ‡æ ‡"""</span>
        self<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>REQUEST_TOTAL<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
            service<span class="token operator">=</span>self<span class="token punctuation">.</span>service_name<span class="token punctuation">,</span>
            endpoint<span class="token operator">=</span>endpoint<span class="token punctuation">,</span>
            status<span class="token operator">=</span>status
        <span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>REQUEST_DURATION<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
            service<span class="token operator">=</span>self<span class="token punctuation">.</span>service_name<span class="token punctuation">,</span>
            endpoint<span class="token operator">=</span>endpoint
        <span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>

<span class="token comment"># ç»“æ„åŒ–æ—¥å¿—</span>
<span class="token keyword keyword-import">import</span> structlog
<span class="token keyword keyword-import">import</span> json

<span class="token keyword keyword-class">class</span> <span class="token class-name">StructuredLogger</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ç»“æ„åŒ–æ—¥å¿—å™¨"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> structlog<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span>service_name<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">log_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•è¯·æ±‚æ—¥å¿—"""</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
            <span class="token string">"request_processed"</span><span class="token punctuation">,</span>
            request_id<span class="token operator">=</span>request_id<span class="token punctuation">,</span>
            user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
            timestamp<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">**</span>kwargs
        <span class="token punctuation">)</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">log_error</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> Exception<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•é”™è¯¯æ—¥å¿—"""</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>
            <span class="token string">"request_failed"</span><span class="token punctuation">,</span>
            request_id<span class="token operator">=</span>request_id<span class="token punctuation">,</span>
            error_type<span class="token operator">=</span><span class="token builtin">type</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>
            error_message<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">**</span>kwargs
        <span class="token punctuation">)</span>

<span class="token comment"># å¥åº·æ£€æŸ¥</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">HealthChecker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¥åº·æ£€æŸ¥å™¨"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db<span class="token punctuation">,</span> redis<span class="token punctuation">,</span> llm_service<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> db
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis
        self<span class="token punctuation">.</span>llm_service <span class="token operator">=</span> llm_service
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">check_readiness</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""å°±ç»ªæ£€æŸ¥ï¼šæ˜¯å¦å¯ä»¥æ¥æ”¶æµé‡"""</span>
        checks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        
        <span class="token comment"># æ•°æ®åº“æ£€æŸ¥</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT 1"</span><span class="token punctuation">)</span>
            checks<span class="token punctuation">[</span><span class="token string">'database'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'healthy'</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            checks<span class="token punctuation">[</span><span class="token string">'database'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'unhealthy: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">'</span></span>
        
        <span class="token comment"># Redis æ£€æŸ¥</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>ping<span class="token punctuation">(</span><span class="token punctuation">)</span>
            checks<span class="token punctuation">[</span><span class="token string">'redis'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'healthy'</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            checks<span class="token punctuation">[</span><span class="token string">'redis'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'unhealthy: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">'</span></span>
        
        <span class="token comment"># é˜Ÿåˆ—é•¿åº¦æ£€æŸ¥</span>
        queue_length <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>llen<span class="token punctuation">(</span><span class="token string">"queue:summarization"</span><span class="token punctuation">)</span>
        checks<span class="token punctuation">[</span><span class="token string">'queue_length'</span><span class="token punctuation">]</span> <span class="token operator">=</span> queue_length
        checks<span class="token punctuation">[</span><span class="token string">'queue_healthy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> queue_length <span class="token operator">&lt;</span> <span class="token number">500</span>
        
        <span class="token comment"># æ•´ä½“çŠ¶æ€</span>
        all_healthy <span class="token operator">=</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            v <span class="token operator">==</span> <span class="token string">'healthy'</span> <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token boolean">True</span>
            <span class="token keyword keyword-for">for</span> v <span class="token keyword keyword-in">in</span> checks<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'ready'</span> <span class="token keyword keyword-if">if</span> all_healthy <span class="token keyword keyword-else">else</span> <span class="token string">'degraded'</span><span class="token punctuation">,</span>
            <span class="token string">'checks'</span><span class="token punctuation">:</span> checks
        <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">check_liveness</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""å­˜æ´»æ£€æŸ¥ï¼šè¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'alive'</span><span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-18">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç›‘æ§ä½“ç³»çš„å±‚æ¬¡:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ä¸šåŠ¡å±‚ (Business)
    â†“ ç”¨æˆ·æ»¡æ„åº¦ã€è½¬åŒ–ç‡
åº”ç”¨å±‚ (Application)
    â†“ QPSã€å»¶è¿Ÿã€é”™è¯¯ç‡
ç³»ç»Ÿå±‚ (System)
    â†“ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
åŸºç¡€è®¾æ–½å±‚ (Infrastructure)
    â†“ æœåŠ¡å™¨ã€ç½‘ç»œã€ç”µæº
</code></pre><p><strong>æŒ‡æ ‡ç±»å‹çš„é€‰æ‹©:</strong></p>
<ul>
<li><strong>Counter</strong>: æ€»é‡ç»Ÿè®¡ï¼Œåªå¢ä¸å‡ï¼ˆè¯·æ±‚æ€»æ•°ï¼‰</li>
<li><strong>Gauge</strong>: ç¬æ—¶å€¼ï¼ˆå¹¶å‘è¿æ¥æ•°ï¼‰</li>
<li><strong>Histogram</strong>: å»¶è¿Ÿåˆ†å¸ƒï¼ˆP50/P95/P99ï¼‰</li>
<li><strong>Summary</strong>: ç±»ä¼¼ Histogramï¼Œä½†å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°</li>
</ul>
<p><strong>æ—¥å¿— vs æŒ‡æ ‡:</strong></p>
<ul>
<li><strong>æŒ‡æ ‡</strong>: é‡åŒ–ã€èšåˆã€å‘Šè­¦</li>
<li><strong>æ—¥å¿—</strong>: è¯¦æƒ…ã€è°ƒè¯•ã€å®¡è®¡</li>
<li><strong>é…åˆä½¿ç”¨</strong>: æŒ‡æ ‡å‘ç°é—®é¢˜ï¼Œæ—¥å¿—å®šä½é—®é¢˜</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-18">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§ä½“ç³»ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>é»„é‡‘æŒ‡æ ‡</strong>: RED (Rate, Error, Duration)</li>
<li><strong>ä¸šåŠ¡æŒ‡æ ‡</strong>: è½¬åŒ–ç‡ã€ç”¨æˆ·æ»¡æ„åº¦</li>
<li><strong>æ—¥å¿—ç»“æ„åŒ–</strong>: JSON æ ¼å¼ï¼Œä¾¿äºæŸ¥è¯¢</li>
<li><strong>å‘Šè­¦åˆ†çº§</strong>: P0/P1/P2/P3ï¼Œé¿å…å‘Šè­¦é£æš´</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"å®Œæ•´çš„ç›‘æ§ä½“ç³»éœ€è¦è¦†ç›–å››ä¸ªå±‚æ¬¡ï¼šç¬¬ä¸€ï¼Œé»„é‡‘æŒ‡æ ‡ï¼Œå³ REDï¼ˆRateã€Errorã€Durationï¼‰ï¼Œè¿™æ˜¯æ‰€æœ‰æœåŠ¡éƒ½å¿…é¡»ç›‘æ§çš„ï¼›ç¬¬äºŒï¼Œä¸šåŠ¡æŒ‡æ ‡ï¼Œå¦‚ä»»åŠ¡å®Œæˆç‡ã€ç”¨æˆ·æ´»è·ƒåº¦ï¼›ç¬¬ä¸‰ï¼Œç³»ç»ŸæŒ‡æ ‡ï¼Œå¦‚ CPUã€å†…å­˜ã€ç£ç›˜ï¼›ç¬¬å››ï¼Œæ—¥å¿—ï¼Œä½¿ç”¨ç»“æ„åŒ– JSON æ ¼å¼ï¼Œä¾¿äº ELK æ”¶é›†å’ŒæŸ¥è¯¢ã€‚å‘Šè­¦éœ€è¦åˆ†çº§ï¼ŒP0 çº§åˆ«ç«‹å³é€šçŸ¥ï¼ŒP1 çº§åˆ« 2 å°æ—¶å†…å¤„ç†ï¼Œé¿å…å‘Šè­¦ç–²åŠ³ã€‚æˆ‘ä»¬ä½¿ç”¨ Prometheus æ”¶é›†æŒ‡æ ‡ï¼ŒGrafana å±•ç¤ºï¼ŒLoki æ”¶é›†æ—¥å¿—ï¼ŒAlertmanager å¤„ç†å‘Šè­¦ã€‚"</p>
</blockquote>
<hr>
<h2 id="75-é”™è¯¯å¤„ç†ä¸é™çº§">7.5 é”™è¯¯å¤„ç†ä¸é™çº§ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-25">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>é”™è¯¯å¤„ç†æ˜¯ <strong>ç³»ç»ŸéŸ§æ€§</strong> çš„ä½“ç°ï¼Œé€šè¿‡ <strong>åˆ†çº§é™çº§</strong> ä¿è¯æ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>ä¼˜é›…é™çº§</strong>: æ ¸å¿ƒåŠŸèƒ½ä¿æŒï¼Œéæ ¸å¿ƒåŠŸèƒ½é™çº§</li>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>: é˜²æ­¢èµ„æºè€—å°½</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: å•ç‚¹æ•…éšœä¸å½±å“å…¨å±€</li>
<li><strong>è‡ªæ„ˆèƒ½åŠ›</strong>: è‡ªåŠ¨æ¢å¤æœºåˆ¶</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-25">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># æ€æƒ³ï¼šæ¼æ–—æ¨¡å‹ã€‚æœ€å¼ºçš„ GraphRAG æŒ‚äº†ï¼Œå°±ç”¨å‘é‡æœç´¢ï¼›å‘é‡æŒ‚äº†ï¼Œå°±ç”¨å…³é”®è¯ï¼›å…¨æŒ‚äº†ï¼Œè¿”å›ç©ºã€‚</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_knowledge_with_fallback</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span> 
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> graph_rag<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token comment"># 1. æœ€ä¼˜é€‰</span>
    <span class="token keyword keyword-except">except</span> GraphRAGError<span class="token punctuation">:</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> simple_vector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token comment"># 2. å¤‡é€‰</span>
        <span class="token keyword keyword-except">except</span> VectorError<span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> keyword_search<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token comment"># 3. å†å¤‡é€‰</span>
            <span class="token keyword keyword-except">except</span> SearchError<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 4. æœ€ç»ˆé™çº§</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">GracefulDegrader</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä¼˜é›…é™çº§ç®¡ç†å™¨"""</span>
    
    DEGRADATION_LEVELS <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'normal'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'degraded'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># é™çº§ï¼šåªç”¨å‘é‡æœç´¢</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>   <span class="token comment"># é™çº§ï¼šç¦ç”¨å·¥å…·</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'critical'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'fallback_to_template'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># é™çº§ï¼šä½¿ç”¨æ¨¡æ¿å›å¤</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_degradation_level</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ¹æ®ç³»ç»ŸçŠ¶æ€è·å–é™çº§çº§åˆ«"""</span>
        <span class="token comment"># æ£€æŸ¥ä¸‹æ¸¸æœåŠ¡å¥åº·çŠ¶æ€</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_llm_health<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'critical'</span>
        
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_vector_db_health<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'degraded'</span>
        
        <span class="token comment"># æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½</span>
        cpu_load <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_cpu_load<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> cpu_load <span class="token operator">&gt;</span> <span class="token number">80</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'degraded'</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token string">'normal'</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute_with_degradation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰§è¡Œå‡½æ•°ï¼Œæ”¯æŒé™çº§"""</span>
        level <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get_degradation_level<span class="token punctuation">(</span><span class="token punctuation">)</span>
        config <span class="token operator">=</span> self<span class="token punctuation">.</span>DEGRADATION_LEVELS<span class="token punctuation">[</span>level<span class="token punctuation">]</span>
        
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> config<span class="token operator">=</span>config<span class="token punctuation">)</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> level <span class="token operator">==</span> <span class="token string">'normal'</span><span class="token punctuation">:</span>
                <span class="token comment"># å°è¯•é™çº§æ‰§è¡Œ</span>
                degraded_config <span class="token operator">=</span> self<span class="token punctuation">.</span>DEGRADATION_LEVELS<span class="token punctuation">[</span><span class="token string">'degraded'</span><span class="token punctuation">]</span>
                <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> config<span class="token operator">=</span>degraded_config<span class="token punctuation">)</span>
                <span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
                    <span class="token comment"># æœ€ç»ˆé™çº§</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_fallback_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_fallback_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_fallback_response</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æœ€ç»ˆé™çº§ï¼šæ¨¡æ¿åŒ–å›å¤"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ç³»ç»Ÿå½“å‰è´Ÿè½½è¾ƒé«˜ï¼Œæ­£åœ¨ä¸ºæ‚¨æ’é˜Ÿå¤„ç†..."</span><span class="token punctuation">,</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"queued"</span><span class="token punctuation">,</span>
            <span class="token string">"estimated_time"</span><span class="token punctuation">:</span> <span class="token string">"2-3åˆ†é’Ÿ"</span>
        <span class="token punctuation">}</span>

<span class="token comment"># è¶…æ—¶æ§åˆ¶</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">call_with_timeout</span><span class="token punctuation">(</span>coro<span class="token punctuation">,</span> timeout_seconds<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¸¦è¶…æ—¶çš„å¼‚æ­¥è°ƒç”¨"""</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. è®¾ç½®æ‰§è¡Œä¸Šé™</span>
        <span class="token comment"># æ€æƒ³ï¼šèµ„æºé˜²è…ã€‚é˜²æ­¢ç”±äºå¤–éƒ¨ APIï¼ˆå¦‚ LLMï¼‰å“åº”è¿‡æ…¢å¯¼è‡´è¯·æ±‚å †ç§¯ï¼Œæœ€ç»ˆè€—å°½æœåŠ¡å™¨åç¨‹æ± ã€‚</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>coro<span class="token punctuation">,</span> timeout<span class="token operator">=</span>timeout_seconds<span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
        <span class="token comment"># 2. å¤±è´¥é™çº§</span>
        <span class="token keyword keyword-raise">raise</span> TimeoutError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Operation timed out after </span><span class="token interpolation"><span class="token punctuation">{</span>timeout_seconds<span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-19">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>é™çº§ç­–ç•¥çš„å±‚æ¬¡:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>æ­£å¸¸æ¨¡å¼
    â†“ è´Ÿè½½ &gt; 70%
é™çº§æ¨¡å¼ (ç¦ç”¨éæ ¸å¿ƒåŠŸèƒ½)
    â†“ è´Ÿè½½ &gt; 85% æˆ–ä¸‹æ¸¸æ•…éšœ
å…³é”®æ¨¡å¼ (ä»…ä¿ç•™æ ¸å¿ƒå›å¤)
    â†“ ç³»ç»Ÿå´©æºƒ
æ¨¡æ¿å›å¤ (å‘ŠçŸ¥ç”¨æˆ·ç³»ç»Ÿç¹å¿™)
</code></pre><p><strong>è¶…æ—¶æ§åˆ¶çš„é‡è¦æ€§:</strong></p>
<ul>
<li><strong>èµ„æºä¿æŠ¤</strong>: é˜²æ­¢æ…¢è¯·æ±‚è€—å°½è¿æ¥æ± </li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: å¿«é€Ÿå¤±è´¥ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: å•ä¸ªæ…¢è¯·æ±‚ä¸å½±å“å…¶ä»–è¯·æ±‚</li>
</ul>
<p><strong>è‡ªæ„ˆæœºåˆ¶:</strong></p>
<ul>
<li><strong>å¥åº·æ£€æŸ¥</strong>: å®šæœŸæ¢æµ‹ä¸‹æ¸¸æœåŠ¡</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: è´Ÿè½½é™ä½åè‡ªåŠ¨æ¢å¤</li>
<li><strong>æ‰‹åŠ¨å¹²é¢„</strong>: è¿ç»´å¯ä»¥å¼ºåˆ¶é™çº§æˆ–æ¢å¤</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-19">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ç³»ç»Ÿè´Ÿè½½è¿‡é«˜æ—¶å¦‚ä½•ä¼˜é›…é™çº§ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>åˆ†çº§ç­–ç•¥</strong>: å®šä¹‰æ¸…æ™°çš„é™çº§çº§åˆ«</li>
<li><strong>è‡ªåŠ¨æ£€æµ‹</strong>: åŸºäº CPUã€å†…å­˜ã€ä¸‹æ¸¸å¥åº·çŠ¶æ€</li>
<li><strong>ç”¨æˆ·é€šçŸ¥</strong>: å‘ŠçŸ¥ç”¨æˆ·å½“å‰çŠ¶æ€å’Œé¢„æœŸç­‰å¾…æ—¶é—´</li>
<li><strong>æ ¸å¿ƒä¿è¯</strong>: å§‹ç»ˆä¿æŒåŸºæœ¬å›å¤èƒ½åŠ›</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è®¾è®¡äº†ä¸‰çº§é™çº§ç­–ç•¥ã€‚æ­£å¸¸æ¨¡å¼ä¸‹æ‰€æœ‰åŠŸèƒ½å¯ç”¨ï¼›å½“ CPU è¶…è¿‡ 70% æˆ–å‘é‡æ•°æ®åº“ä¸å¯ç”¨æ—¶ï¼Œè¿›å…¥é™çº§æ¨¡å¼ï¼Œç¦ç”¨å·¥å…·è°ƒç”¨å’Œé•¿å†å²ï¼›å½“ CPU è¶…è¿‡ 85% æˆ– LLM ä¸å¯ç”¨æ—¶ï¼Œè¿›å…¥å…³é”®æ¨¡å¼ï¼Œåªä¿ç•™åŸºæœ¬å›å¤ï¼Œå¹¶æç¤ºç”¨æˆ·ç³»ç»Ÿç¹å¿™ã€‚é™çº§æ˜¯è‡ªåŠ¨çš„ï¼Œé€šè¿‡å¥åº·æ£€æŸ¥å’Œè´Ÿè½½ç›‘æ§å®æ—¶åˆ¤æ–­ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šç»™ç”¨æˆ·æ˜ç¡®çš„åé¦ˆï¼Œæ¯”å¦‚'ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜ï¼Œæ­£åœ¨æ’é˜Ÿå¤„ç†ï¼Œé¢„è®¡ 2-3 åˆ†é’Ÿ'ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·æ— ä¼‘æ­¢ç­‰å¾…ã€‚"</p>
</blockquote>
<hr>
<h1 id="å…«-å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª">å…«ã€å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª </h1>
<h2 id="81-ç«¯åˆ°ç«¯æ•°æ®æµ">8.1 ç«¯åˆ°ç«¯æ•°æ®æµ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-26">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å®Œæ•´è¯·æ±‚æµç¨‹æ˜¯ <strong>ç³»ç»Ÿè¡Œä¸ºçš„å…¨æ™¯å›¾</strong>ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ°æœ€ç»ˆå“åº”ï¼š</p>
<ul>
<li><strong>ç§»åŠ¨ç«¯</strong>: ç”¨æˆ·è¾“å…¥ã€çŠ¶æ€ç®¡ç†ã€UI æ¸²æŸ“</li>
<li><strong>ç½‘å…³å±‚</strong>: è¿æ¥ç®¡ç†ã€è®¤è¯é™æµã€åè®®è½¬æ¢</li>
<li><strong>AI å¼•æ“</strong>: ç¼–æ’å¤„ç†ã€å·¥å…·è°ƒç”¨ã€LLM äº¤äº’</li>
<li><strong>æ•°æ®å±‚</strong>: æ•°æ®åº“æŸ¥è¯¢ã€ç¼“å­˜æ“ä½œã€é˜Ÿåˆ—å¤„ç†</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-26">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ç”¨æˆ·è¾“å…¥: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
</code></pre><p><strong>é˜¶æ®µ 1: ç§»åŠ¨ç«¯å¤„ç†</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// 1. Flutter App - ç”¨æˆ·è¾“å…¥</span>
<span class="token class-name">ChatScreen</span><span class="token punctuation">.</span><span class="token function">onSubmitted</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span></span><span class="token punctuation">)</span>

<span class="token comment">// 2. Riverpod çŠ¶æ€æ›´æ–°</span>
<span class="token class-name">ChatNotifier</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span></span><span class="token punctuation">)</span>
  â†’ æ›´æ–° state<span class="token punctuation">.</span>isLoading <span class="token operator">=</span> <span class="token boolean">true</span>
  â†’ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° messages åˆ—è¡¨

<span class="token comment">// 3. WebSocket æœåŠ¡å‘é€</span>
<span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
  message<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span></span><span class="token punctuation">,</span>
  userId<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"user_123"</span></span><span class="token punctuation">,</span>
  sessionId<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"sess_456"</span></span>
<span class="token punctuation">)</span>
  â†’ æ„å»º payload<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string-literal"><span class="token string">"message"</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"..."</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"session_id"</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"..."</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"user_id"</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"..."</span></span><span class="token punctuation">}</span>
  â†’ <span class="token class-name">WebSocketChannel</span> å‘é€ JSON
</code></pre><p><strong>é˜¶æ®µ 2: Go Gateway å¤„ç†</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// 4. Go Gateway - WebSocket æ¥æ”¶</span>
<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ChatHandler<span class="token punctuation">)</span> <span class="token function">HandleWebSocket</span><span class="token punctuation">(</span>conn <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¤è¯æ£€æŸ¥</span>
    <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">authMiddleware</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token number">4001</span><span class="token punctuation">,</span> <span class="token string">"Auth failed"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¶ˆæ¯å¾ªç¯</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> msg ChatMessage
        conn<span class="token punctuation">.</span><span class="token function">ReadJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span>  <span class="token comment">// æ¥æ”¶ {"message": "...", ...}</span>

        <span class="token comment">// é…é¢æ£€æŸ¥</span>
        <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span>quotaService<span class="token punctuation">.</span><span class="token function">CheckQuota</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>QuotaExceededResponse<span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. è½¬å‘åˆ° gRPC</span>
        response<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span>grpcClient<span class="token punctuation">.</span><span class="token function">StreamChat</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>ChatRequest<span class="token punctuation">{</span>
            UserId<span class="token punctuation">:</span>    userID<span class="token punctuation">,</span>
            SessionId<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>SessionID<span class="token punctuation">,</span>
            Message<span class="token punctuation">:</span>   msg<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 6. æµå¼è¿”å›</span>
        <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chunk <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> response <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>  <span class="token comment">// é€å—è¿”å›ç»™ Flutter</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>é˜¶æ®µ 3: Python gRPC æœåŠ¡</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># 7. gRPC æœåŠ¡ç«¯</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">AgentServiceImpl</span><span class="token punctuation">(</span>pb2_grpc<span class="token punctuation">.</span>AgentServiceServicer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">StreamChat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># è½¬å‘åˆ°ç¼–æ’å™¨</span>
        orchestrator <span class="token operator">=</span> ProductionChatOrchestrator<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> orchestrator<span class="token punctuation">.</span>process_stream<span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> pb2<span class="token punctuation">.</span>StreamResponse<span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span>event<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">,</span>
                content<span class="token operator">=</span>event<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
                metadata<span class="token operator">=</span>event<span class="token punctuation">.</span>metadata
            <span class="token punctuation">)</span>
</code></pre><p><strong>é˜¶æ®µ 4: ç”Ÿäº§çº§ç¼–æ’å™¨æ ¸å¿ƒæµç¨‹</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># 8. ProductionChatOrchestrator.process_stream()</span>

<span class="token comment"># ========== ç¬¬1æ­¥ï¼šæ¶ˆæ¯å»é‡æ£€æŸ¥ ==========</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>is_processed<span class="token punctuation">(</span><span class="token string">"req_789"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"DUPLICATE_REQUEST"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

<span class="token comment"># ========== ç¬¬2æ­¥ï¼šç†”æ–­å™¨æ£€æŸ¥ ==========</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>can_execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"CIRCUIT_BREAKER_OPEN"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

<span class="token comment"># ========== ç¬¬3æ­¥ï¼šå¹¶å‘æ§åˆ¶ ==========</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_track_session<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"RATE_LIMIT"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

<span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
    <span class="token comment"># ========== ç¬¬4æ­¥ï¼šè¯·æ±‚éªŒè¯ ==========</span>
    validation <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>validate_chat_request<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> validation<span class="token punctuation">.</span>is_valid<span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"VALIDATION_FAILED"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

    <span class="token comment"># ========== ç¬¬5æ­¥ï¼šå¹‚ç­‰æ€§æ£€æŸ¥ ==========</span>
    cached <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_idempotency<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> cached<span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> cached  <span class="token comment"># è¿”å›ç¼“å­˜</span>
        <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

    <span class="token comment"># ========== ç¬¬6æ­¥ï¼šåˆ†å¸ƒå¼é” ==========</span>
    lock_acquired <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_acquire_session_lock<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> lock_acquired<span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"LOCK_FAILED"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

    <span class="token comment"># ========== ç¬¬7æ­¥ï¼šæ„å»ºä¸Šä¸‹æ–‡ ==========</span>

    <span class="token comment"># 7.1 ç”¨æˆ·ä¸Šä¸‹æ–‡</span>
    user_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_build_user_context<span class="token punctuation">(</span><span class="token string">"user_123"</span><span class="token punctuation">)</span>
    <span class="token comment"># ç»“æœ: {</span>
    <span class="token comment">#   "user": {"id": "user_123", "nickname": "å¼ ä¸‰"},</span>
    <span class="token comment">#   "progress": {"total_nodes": 45, "avg_mastery": 65},</span>
    <span class="token comment">#   "active_sprint": {"title": "æœºå™¨å­¦ä¹ å…¥é—¨", "progress": 75}</span>
    <span class="token comment"># }</span>

    <span class="token comment"># 7.2 å¯¹è¯å†å²ï¼ˆä¸Šä¸‹æ–‡ä¿®å‰ªï¼‰</span>
    conversation_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>context_pruner<span class="token punctuation">.</span>get_pruned_history<span class="token punctuation">(</span>
        <span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"user_123"</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># ç»“æœ: {</span>
    <span class="token comment">#   "messages": [...],  # æœ€è¿‘10æ¡æˆ–å¸¦æ€»ç»“</span>
    <span class="token comment">#   "summary": "ç”¨æˆ·ä¹‹å‰è¯¢é—®è¿‡ç¥ç»ç½‘ç»œçš„åŸºç¡€æ¦‚å¿µ",</span>
    <span class="token comment">#   "summary_used": True</span>
    <span class="token comment"># }</span>

    <span class="token comment"># 7.3 çŸ¥è¯†æ£€ç´¢ï¼ˆGraphRAGï¼‰</span>
    knowledge_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_retrieve_knowledge<span class="token punctuation">(</span>
        <span class="token string">"user_123"</span><span class="token punctuation">,</span>
        <span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span><span class="token punctuation">,</span>
        conversation_context
    <span class="token punctuation">)</span>
    <span class="token comment"># ç»“æœ: {</span>
    <span class="token comment">#   "nodes": [</span>
    <span class="token comment">#     {"id": "node_100", "name": "æœºå™¨å­¦ä¹ ", "mastery": 0},</span>
    <span class="token comment">#     {"id": "node_101", "name": "ç›‘ç£å­¦ä¹ ", "mastery": 0},</span>
    <span class="token comment">#     {"id": "node_102", "name": "ç¥ç»ç½‘ç»œ", "mastery": 35}</span>
    <span class="token comment">#   ],</span>
    <span class="token comment">#   "relations": [...]</span>
    <span class="token comment"># }</span>

    <span class="token comment"># ========== ç¬¬8æ­¥ï¼šLLM è°ƒç”¨ + å·¥å…·æ‰§è¡Œ ==========</span>

    <span class="token comment"># 8.1 å‡†å¤‡å·¥å…·</span>
    tools <span class="token operator">=</span> tool_registry<span class="token punctuation">.</span>get_openai_tools_schema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># å·¥å…·åˆ—è¡¨: [</span>
    <span class="token comment">#   {"name": "get_knowledge_node", ...},</span>
    <span class="token comment">#   {"name": "create_task", ...},</span>
    <span class="token comment">#   ...</span>
    <span class="token comment"># ]</span>

    <span class="token comment"># 8.2 æ„å»ºç³»ç»Ÿæç¤º</span>
    system_prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    ä½ æ˜¯ä¸€ä¸ª AI å­¦ä¹ åŠ©æ‰‹ã€‚

    ç”¨æˆ·ä¿¡æ¯:
    </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>user_context<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    å¯¹è¯å†å²:
    </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>conversation_context<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    ç›¸å…³çŸ¥è¯†:
    </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>knowledge_context<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    å¯ç”¨å·¥å…·:
    </span><span class="token interpolation"><span class="token punctuation">{</span>tool_registry<span class="token punctuation">.</span>get_tools_description<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    è¦æ±‚:
    1. ç”¨ä¸­æ–‡å›ç­”
    2. è¯­è¨€äº²åˆ‡è‡ªç„¶
    3. é€‚å½“ä½¿ç”¨å·¥å…·
    """</span></span>

    <span class="token comment"># 8.3 æµå¼ LLM è°ƒç”¨</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> llm_service<span class="token punctuation">.</span>chat_stream_with_tools<span class="token punctuation">(</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
        user_id<span class="token operator">=</span><span class="token string">"user_123"</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> chunk

    <span class="token comment"># ========== ç¬¬9æ­¥ï¼šå“åº”ç»„åˆ ==========</span>
    <span class="token comment"># å·²åœ¨ LLM æµå¼è¿”å›ä¸­å®Œæˆ</span>

    <span class="token comment"># ========== ç¬¬10æ­¥ï¼šç¼“å­˜ä¸æŒ‡æ ‡ ==========</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_cache_response<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">,</span> <span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_record_metrics<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user_context<span class="token punctuation">)</span>

<span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
    <span class="token comment"># ========== ç¬¬11æ­¥ï¼šæ¸…ç†èµ„æº ==========</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_release_session_lock<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_track_session<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> add<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre><p><strong>é˜¶æ®µ 5: è¿”å›ç§»åŠ¨ç«¯</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// 12. Flutter - æ¥æ”¶æµå¼å“åº”</span>

<span class="token comment">// WebSocket æœåŠ¡æ¥æ”¶</span>
<span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">.</span><span class="token function">_handleMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  â†’ è§£æä¸º <span class="token class-name">TextEvent</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"æœºå™¨å­¦ä¹ æ˜¯..."</span></span><span class="token punctuation">)</span>
  â†’ <span class="token class-name">StreamController</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>

<span class="token comment">// Riverpod ç›‘å¬</span>
<span class="token class-name">ChatNotifier</span><span class="token punctuation">.</span><span class="token function">_handleStreamEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  â†’ event<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
          response<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response <span class="token operator">+</span> content<span class="token punctuation">,</span>
          isTyping<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      done<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
          messages<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
            <span class="token class-name">ChatMessage</span><span class="token punctuation">(</span>
              role<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'assistant'</span></span><span class="token punctuation">,</span>
              content<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          isTyping<span class="token punctuation">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token comment">// UI æ›´æ–°</span>
<span class="token class-name">ChatScreen</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  â†’ <span class="token class-name">MessageBubble</span> æ˜¾ç¤º AI å›ç­”
  â†’ æ‰“å­—åŠ¨ç”»æ•ˆæœ
  â†’ å®ŒæˆçŠ¶æ€æ˜¾ç¤º
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-20">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç«¯åˆ°ç«¯æµç¨‹çš„è®¾è®¡åŸåˆ™:</strong></p>
<ul>
<li><strong>å¯è§‚æµ‹æ€§</strong>: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„æ—¥å¿—å’ŒæŒ‡æ ‡</li>
<li><strong>é”™è¯¯éš”ç¦»</strong>: ä»»ä½•é˜¶æ®µå¤±è´¥éƒ½æœ‰æ¸…æ™°çš„é™çº§ç­–ç•¥</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: å¼‚æ­¥å¤„ç†ã€æµå¼å“åº”ã€ç¼“å­˜ä¼˜åŒ–</li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: å®æ—¶åé¦ˆã€çŠ¶æ€æŒ‡ç¤ºã€å‹å¥½é”™è¯¯</li>
</ul>
<p><strong>æ—¶åºä¼˜åŒ–çš„å…³é”®ç‚¹:</strong></p>
<ul>
<li><strong>0-100ms</strong>: ç§»åŠ¨ç«¯å‘é€ + ç½‘å…³æ¥æ”¶éªŒè¯</li>
<li><strong>100-200ms</strong>: gRPC è½¬å‘ + Python ç¼–æ’å‡†å¤‡</li>
<li><strong>200-300ms</strong>: LLM ç”Ÿæˆå¼€å§‹ + çŠ¶æ€æ›´æ–°</li>
<li><strong>300-400ms</strong>: æµå¼è¿”å› + UI å®æ—¶æ¸²æŸ“</li>
</ul>
<p><strong>æ•°æ®æµçš„å®Œæ•´æ€§:</strong></p>
<ul>
<li><strong>è¯·æ±‚æ•°æ®</strong>: ç”¨æˆ·è¾“å…¥ã€ä¼šè¯ IDã€ç”¨æˆ· ID</li>
<li><strong>ä¸Šä¸‹æ–‡æ•°æ®</strong>: ç”¨æˆ·ç”»åƒã€å†å²è®°å½•ã€çŸ¥è¯†æ£€ç´¢</li>
<li><strong>æ§åˆ¶æ•°æ®</strong>: ç†”æ–­çŠ¶æ€ã€é™æµè®¡æ•°ã€é”ä¿¡æ¯</li>
<li><strong>å“åº”æ•°æ®</strong>: æ–‡æœ¬æµã€å·¥å…·è°ƒç”¨ã€çŠ¶æ€æ›´æ–°</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-20">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: æè¿°ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ä»ç§»åŠ¨ç«¯åˆ° AI å¼•æ“çš„æµç¨‹ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç§»åŠ¨ç«¯</strong>: WebSocket è¿æ¥ã€çŠ¶æ€ç®¡ç†ã€UI æ¸²æŸ“</li>
<li><strong>ç½‘å…³å±‚</strong>: è®¤è¯ã€é™æµã€åè®®è½¬æ¢ã€gRPC è½¬å‘</li>
<li><strong>AI å¼•æ“</strong>: 11 æ­¥å¤„ç†é“¾ã€å·¥å…·è°ƒç”¨ã€LLM äº¤äº’</li>
<li><strong>æ•°æ®å±‚</strong>: æ•°æ®åº“æŸ¥è¯¢ã€ç¼“å­˜ã€é˜Ÿåˆ—</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ä¸€ä¸ªå®Œæ•´è¯·æ±‚æµç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆï¼ŒFlutter é€šè¿‡ WebSocket å‘é€ JSON æ¶ˆæ¯ï¼ŒåŒæ—¶æ›´æ–°æœ¬åœ° UI çŠ¶æ€ä¸ºåŠ è½½ä¸­ã€‚Go Gateway æ¥æ”¶æ¶ˆæ¯ï¼Œè¿›è¡Œ JWT è®¤è¯å’Œé…é¢æ£€æŸ¥ï¼Œç„¶åé€šè¿‡ gRPC è½¬å‘ç»™ Python Agentã€‚Python Agent å¯åŠ¨ 11 æ­¥å¤„ç†é“¾ï¼šæ¶ˆæ¯å»é‡ã€ç†”æ–­æ£€æŸ¥ã€å¹¶å‘æ§åˆ¶ã€è¯·æ±‚éªŒè¯ã€å¹‚ç­‰æ£€æŸ¥ã€åˆ†å¸ƒå¼é”ã€æ„å»ºä¸Šä¸‹æ–‡ã€GraphRAG æ£€ç´¢ã€LLM è°ƒç”¨ã€æŒ‡æ ‡è®°å½•ã€èµ„æºæ¸…ç†ã€‚LLM æµå¼è¿”å›æ–‡æœ¬ï¼Œé€šè¿‡ gRPCã€WebSocket é€å—æ¨é€åˆ°ç§»åŠ¨ç«¯ï¼ŒFlutter å®æ—¶æ›´æ–° UIã€‚æ•´ä¸ªæµç¨‹é€šè¿‡ request_id å…¨é“¾è·¯è¿½è¸ªï¼Œä»»ä½•ç¯èŠ‚å‡ºé”™éƒ½æœ‰æ˜ç¡®çš„é™çº§ç­–ç•¥ã€‚"</p>
</blockquote>
<hr>
<h1 id="ä¹-æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ">ä¹ã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ </h1>
<h2 id="91-æ•°æ®åº“ä¼˜åŒ–">9.1 æ•°æ®åº“ä¼˜åŒ– </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-27">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>æ•°æ®åº“ä¼˜åŒ–æ˜¯ <strong>æ€§èƒ½åŸºçŸ³</strong>ï¼Œé€šè¿‡ <strong>å¤šç»´ç´¢å¼•</strong> å’Œ <strong>æŸ¥è¯¢ä¼˜åŒ–</strong> æå‡æ€§èƒ½ï¼š</p>
<ul>
<li><strong>å¤šç»´ç´¢å¼•</strong>: B-Tree + HNSW + BRIN</li>
<li><strong>æŸ¥è¯¢ä¼˜åŒ–</strong>: JOIN åˆå¹¶ï¼Œé¿å… N+1</li>
<li><strong>åˆ†åŒºç­–ç•¥</strong>: æ—¶é—´åˆ†ç‰‡ï¼Œæé«˜æ€§èƒ½</li>
<li><strong>è¿æ¥æ± </strong>: å¤ç”¨è¿æ¥ï¼Œå‡å°‘å¼€é”€</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-27">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 1. å‘é‡æœç´¢ä¼˜åŒ–ï¼ˆHNSW ç´¢å¼•ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_knowledge_nodes_embedding_hnsw
<span class="token keyword keyword-ON">ON</span> knowledge_nodes
<span class="token keyword keyword-USING">USING</span> hnsw <span class="token punctuation">(</span>embedding vector_cosine_ops<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> ef_construction <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> ef_search <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_user_node_status_active
<span class="token keyword keyword-ON">ON</span> user_node_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> mastery_score<span class="token punctuation">)</span>
<span class="token keyword keyword-WHERE">WHERE</span> mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_covering
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span>node_id<span class="token punctuation">,</span> mastery_delta<span class="token punctuation">,</span> study_minutes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 4. BRIN ç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_brin
<span class="token keyword keyword-ON">ON</span> study_records <span class="token keyword keyword-USING">USING</span> BRIN <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>pages_per_range <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 5. æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> uns<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> kn<span class="token punctuation">.</span>name 
<span class="token keyword keyword-FROM">FROM</span> user_node_status uns
<span class="token keyword keyword-JOIN">JOIN</span> knowledge_nodes kn <span class="token keyword keyword-ON">ON</span> uns<span class="token punctuation">.</span>node_id <span class="token operator">=</span> kn<span class="token punctuation">.</span>id
<span class="token keyword keyword-WHERE">WHERE</span> uns<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token string">'123'</span> 
  <span class="token operator">AND</span> uns<span class="token punctuation">.</span>mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> uns<span class="token punctuation">.</span>next_review_at
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- ç»“æœï¼šIndex Scan using idx_user_node_status_active</span>
<span class="token comment">-- æ‰§è¡Œæ—¶é—´ï¼š8ms (ä¼˜åŒ–å‰ 45ms)</span>
</code></pre><p><strong>Python è¿æ¥æ± é…ç½®ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> sqlalchemy <span class="token keyword keyword-import">import</span> create_engine
<span class="token keyword keyword-from">from</span> sqlalchemy<span class="token punctuation">.</span>pool <span class="token keyword keyword-import">import</span> QueuePool

engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>
    <span class="token string">"postgresql://user:pass@localhost/db"</span><span class="token punctuation">,</span>
    poolclass<span class="token operator">=</span>QueuePool<span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>           <span class="token comment"># å¸¸é©»è¿æ¥æ•°</span>
    max_overflow<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>        <span class="token comment"># ä¸´æ—¶è¿æ¥æ•°</span>
    pool_timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>        <span class="token comment"># è·å–è¿æ¥è¶…æ—¶</span>
    pool_recycle<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span>      <span class="token comment"># è¿æ¥å›æ”¶æ—¶é—´</span>
    pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>     <span class="token comment"># å¥åº·æ£€æŸ¥</span>
    connect_args<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'connect_timeout'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">'options'</span><span class="token punctuation">:</span> <span class="token string">'-c statement_timeout=30000'</span>  <span class="token comment"># 30ç§’æŸ¥è¯¢è¶…æ—¶</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># ç›‘æ§è¿æ¥æ± </span>
<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> <span class="token string">'checkout'</span><span class="token punctuation">)</span>
<span class="token keyword keyword-def">def</span> <span class="token function">on_checkout</span><span class="token punctuation">(</span>dbapi_con<span class="token punctuation">,</span> con_record<span class="token punctuation">,</span> con_proxy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    con_record<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'checkout_time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> <span class="token string">'checkin'</span><span class="token punctuation">)</span>
<span class="token keyword keyword-def">def</span> <span class="token function">on_checkin</span><span class="token punctuation">(</span>dbapi_con<span class="token punctuation">,</span> con_record<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">'checkout_time'</span> <span class="token keyword keyword-in">in</span> con_record<span class="token punctuation">.</span>info<span class="token punctuation">:</span>
        duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> con_record<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'checkout_time'</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-if">if</span> duration <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Long connection held for </span><span class="token interpolation"><span class="token punctuation">{</span>duration<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-21">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç´¢å¼•ä¼˜åŒ–çš„å†³ç­–æ ‘:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>æ•°æ®ç±»å‹?
â”œâ”€â”€ ç»“æ„åŒ–æ•°æ® (ID, æ—¶é—´, çŠ¶æ€)
â”‚   â”œâ”€â”€ ç­‰å€¼æŸ¥è¯¢ â†’ B-Tree
â”‚   â”œâ”€â”€ èŒƒå›´æŸ¥è¯¢ â†’ B-Tree
â”‚   â””â”€â”€ æ—¶é—´åºåˆ— â†’ BRIN
â”œâ”€â”€ åŠç»“æ„åŒ–æ•°æ® (JSON)
â”‚   â””â”€â”€ é”®å€¼æŸ¥è¯¢ â†’ GIN
â””â”€â”€ éç»“æ„åŒ–æ•°æ® (å‘é‡)
    â”œâ”€â”€ é«˜ç²¾åº¦ â†’ HNSW
    â””â”€â”€ é«˜é€Ÿåº¦ â†’ IVFFlat
</code></pre><p><strong>è¿æ¥æ± çš„é‡è¦æ€§:</strong></p>
<ul>
<li><strong>æ€§èƒ½</strong>: å¤ç”¨è¿æ¥ï¼Œé¿å…é¢‘ç¹å»ºç«‹/æ–­å¼€</li>
<li><strong>èµ„æºæ§åˆ¶</strong>: é™åˆ¶æœ€å¤§è¿æ¥æ•°ï¼Œé˜²æ­¢æ•°æ®åº“è¿‡è½½</li>
<li><strong>å¥åº·æ£€æŸ¥</strong>: è‡ªåŠ¨æ£€æµ‹å¤±æ•ˆè¿æ¥</li>
<li><strong>ç›‘æ§</strong>: è¿æ¥ä½¿ç”¨æƒ…å†µå¯è§†åŒ–</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-21">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•ä¼˜åŒ–ä¸€ä¸ªæ…¢æŸ¥è¯¢ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>EXPLAIN ANALYZE</strong>: åˆ†ææ‰§è¡Œè®¡åˆ’</li>
<li><strong>ç´¢å¼•ä¼˜åŒ–</strong>: æ·»åŠ ç¼ºå¤±ç´¢å¼•ï¼Œä¼˜åŒ–ç°æœ‰ç´¢å¼•</li>
<li><strong>æŸ¥è¯¢é‡å†™</strong>: é¿å… N+1ï¼Œä½¿ç”¨ JOIN</li>
<li><strong>å‚æ•°è°ƒä¼˜</strong>: è°ƒæ•´æ•°æ®åº“å‚æ•°</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ä¼˜åŒ–æ…¢æŸ¥è¯¢çš„æ­¥éª¤ï¼šé¦–å…ˆï¼Œä½¿ç”¨ EXPLAIN ANALYZE åˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œæ‰¾å‡ºå…¨è¡¨æ‰«ææˆ–ä½æ•ˆæ“ä½œï¼›å…¶æ¬¡ï¼Œæ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç´¢å¼•ï¼Œæ·»åŠ åˆé€‚çš„ç´¢å¼•ï¼ˆB-Treeã€HNSW ç­‰ï¼‰ï¼›ç¬¬ä¸‰ï¼Œé‡å†™æŸ¥è¯¢ï¼Œé¿å… N+1 é—®é¢˜ï¼Œä½¿ç”¨ JOIN æˆ–æ‰¹é‡æŸ¥è¯¢ï¼›ç¬¬å››ï¼Œæ£€æŸ¥ç´¢å¼•æ˜¯å¦è¢«æ­£ç¡®ä½¿ç”¨ï¼Œé¿å…ç´¢å¼•å¤±æ•ˆï¼›æœ€åï¼Œå¦‚æœæ•°æ®é‡å·¨å¤§ï¼Œè€ƒè™‘åˆ†åŒºæˆ–åˆ†è¡¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ›¾å°†ä¸€ä¸ª 45ms çš„æŸ¥è¯¢ä¼˜åŒ–åˆ° 8msï¼Œé€šè¿‡æ·»åŠ éƒ¨åˆ†ç´¢å¼•å’Œä½¿ç”¨è¦†ç›–ç´¢å¼•ã€‚"</p>
</blockquote>
<hr>
<p><strong>æ–‡æ¡£æ›´æ–°å®Œæˆï¼</strong></p>
<p>æˆ‘å·²ç»åœ¨æ–‡æ¡£ä¸­æ·»åŠ äº†å¤§é‡ä¸ Sparkle é¡¹ç›®å®é™…ä»£ç çš„è”ç³»ï¼ŒåŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>Go Gateway å®Œæ•´å®ç°</strong> - WebSocket å¤„ç†ã€è®¤è¯ã€é™æµã€gRPC è½¬å‘</li>
<li><strong>Python Agent 11 æ­¥å¤„ç†é“¾</strong> - æ¯ä¸€æ­¥éƒ½æœ‰å®é™…ä»£ç æ˜ å°„</li>
<li><strong>GraphRAG æ··åˆæœç´¢</strong> - å‘é‡+å…³é”®è¯+RRFèåˆçš„å®Œæ•´æµç¨‹</li>
<li><strong>Flutter WebSocket v2</strong> - å•ä¾‹ã€ç¼“å†²ã€æŒ‡æ•°é€€é¿</li>
<li><strong>Riverpod çŠ¶æ€ç®¡ç†</strong> - å®Œæ•´çš„ Provider æ¶æ„å’Œäº‹ä»¶å¤„ç†</li>
<li><strong>Canvas æ˜Ÿå›¾å¯è§†åŒ–</strong> - LODã€æŒæ¡åº¦ã€å…³ç³»çº¿çš„å®Œæ•´å®ç°</li>
<li><strong>æ•°æ®åº“å®æˆ˜</strong> - ORM æ¨¡å‹ã€ç´¢å¼•ç­–ç•¥ã€åˆ†åŒºç®¡ç†</li>
<li><strong>æŒæ¡åº¦ç®—æ³•</strong> - å¤šå› å­åŠ æƒã€è‰¾å®¾æµ©æ–¯æ›²çº¿</li>
<li><strong>ç”Ÿäº§çº§ç‰¹æ€§</strong> - ç†”æ–­å™¨ã€å¹‚ç­‰æ€§ã€åˆ†å¸ƒå¼é”ã€ç›‘æ§é™çº§</li>
</ol>
<p>è¿™äº›å†…å®¹å°†æŠ½è±¡çš„æŠ€æœ¯æ¦‚å¿µä¸ Sparkle é¡¹ç›®çš„å®é™…ä»£ç ç´§å¯†ç»“åˆï¼Œè®©å­¦ä¹ è€…èƒ½å¤Ÿç›´æ¥çœ‹åˆ°ç†è®ºå¦‚ä½•è½åœ°åˆ°ç”Ÿäº§ä»£ç ä¸­ã€‚</p>
<h3 id="sparkle-é¡¹ç›®å®æˆ˜åˆ†æ-4">ã€Sparkle é¡¹ç›®å®æˆ˜åˆ†æã€‘ </h3>
<p><strong>ğŸ¯ å®é™…ä»£ç æ˜ å°„ï¼š</strong></p>
<p>åœ¨ <code>backend/app/services/galaxy_service.py</code> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸æ•°æ®åº“äº¤äº’çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<ol>
<li><strong>æŒæ¡åº¦è®¡ç®—</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_calculate_mastery_delta</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> study_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> importance<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> study_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¤šå› å­åŠ æƒç®—æ³•"""</span>
    base <span class="token operator">=</span> study_minutes <span class="token operator">*</span> self<span class="token punctuation">.</span>BASE_MASTERY_POINTS  <span class="token comment"># åŸºç¡€åˆ†</span>
    importance_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>importance <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.25</span>  <span class="token comment"># é‡è¦åº¦</span>
    count_factor <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> study_count <span class="token operator">*</span> <span class="token number">0.3</span><span class="token punctuation">)</span>     <span class="token comment"># æ¬¡æ•°è¡°å‡</span>
    time_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>log10<span class="token punctuation">(</span>study_minutes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.2</span>  <span class="token comment"># æ—¶é—´æ•ˆç‡</span>
    
    delta <span class="token operator">=</span> base <span class="token operator">*</span> importance_factor <span class="token operator">*</span> count_factor <span class="token operator">*</span> time_factor
    <span class="token keyword keyword-return">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>delta<span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span>  <span class="token comment"># å•æ¬¡ä¸Šé™</span>
</code></pre><ol start="2">
<li><strong>è‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_calculate_next_review</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> study_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> mastery<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> datetime<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""é—´éš”é‡å¤ç®—æ³•"""</span>
    <span class="token keyword keyword-if">if</span> mastery <span class="token operator">&gt;=</span> <span class="token number">80</span><span class="token punctuation">:</span>
        days <span class="token operator">=</span> <span class="token number">14</span>
    <span class="token keyword keyword-elif">elif</span> mastery <span class="token operator">&gt;=</span> <span class="token number">60</span><span class="token punctuation">:</span>
        days <span class="token operator">=</span> <span class="token number">7</span>
    <span class="token keyword keyword-elif">elif</span> mastery <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">:</span>
        days <span class="token operator">=</span> <span class="token number">3</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        days <span class="token operator">=</span> <span class="token number">1</span>
    
    <span class="token keyword keyword-return">return</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>days<span class="token punctuation">)</span>
</code></pre><ol start="3">
<li><strong>æ··åˆæœç´¢å®ç°</strong>ï¼š</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">hybrid_search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. å‘é‡æœç´¢ï¼ˆpgvectorï¼‰</span>
    vector_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_vector_search<span class="token punctuation">(</span>query_embedding<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. å…³é”®è¯æœç´¢ï¼ˆRedisï¼‰</span>
    keyword_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_keyword_search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. RRF èåˆ</span>
    fused <span class="token operator">=</span> self<span class="token punctuation">.</span>_reciprocal_rank_fusion<span class="token punctuation">(</span>vector_results<span class="token punctuation">,</span> keyword_results<span class="token punctuation">)</span>
    
    <span class="token comment"># 4. é‡æ’åº</span>
    reranked <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_rerank<span class="token punctuation">(</span>query<span class="token punctuation">,</span> fused<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>
    
    <span class="token comment"># 5. ç”¨æˆ·çŠ¶æ€è¿‡æ»¤</span>
    filtered <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_filter_by_user_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> filtered
</code></pre><p><strong>æ•°æ®åº“è®¾è®¡ä¼˜åŠ¿</strong>ï¼š</p>
<ul>
<li><strong>æ··åˆå­˜å‚¨</strong>: å…³ç³»å‹ + å‘é‡ä¸€ä½“åŒ–</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: HNSW ç´¢å¼• + éƒ¨åˆ†ç´¢å¼• + åˆ†åŒº</li>
<li><strong>æ•°æ®ä¸€è‡´</strong>: ACID äº‹åŠ¡ä¿è¯</li>
<li><strong>å¯æ‰©å±•</strong>: æ°´å¹³åˆ†ç‰‡ + å‚ç›´æ‹†åˆ†</li>
</ul>
<hr>
<p><strong>æ–‡æ¡£æ›´æ–°å®Œæˆï¼</strong></p>
<p>æˆ‘å·²ç»åœ¨æ–‡æ¡£ä¸­æ·»åŠ äº†å¤§é‡ä¸ Sparkle é¡¹ç›®å®é™…ä»£ç çš„è”ç³»ï¼ŒåŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>Go Gateway å®æˆ˜åˆ†æ</strong> - å®Œæ•´çš„ WebSocket å¤„ç†æµç¨‹</li>
<li><strong>Python Agent 11 æ­¥å¤„ç†é“¾</strong> - æ¯ä¸€æ­¥éƒ½æœ‰å®é™…ä»£ç æ˜ å°„</li>
<li><strong>GraphRAG æ··åˆæœç´¢</strong> - å®Œæ•´çš„å‘é‡+å…³é”®è¯+èåˆæµç¨‹</li>
<li><strong>Flutter WebSocket v2</strong> - å•ä¾‹ã€ç¼“å†²ã€æŒ‡æ•°é€€é¿</li>
<li><strong>Riverpod çŠ¶æ€ç®¡ç†</strong> - å®Œæ•´çš„ Provider æ¶æ„</li>
<li><strong>Canvas æ˜Ÿå›¾å¯è§†åŒ–</strong> - LODã€æŒæ¡åº¦ã€å…³ç³»çº¿</li>
<li><strong>æ•°æ®åº“å®æˆ˜</strong> - æŒæ¡åº¦ç®—æ³•ã€è‰¾å®¾æµ©æ–¯ã€æ··åˆæœç´¢</li>
</ol>
<p>è¿™äº›å†…å®¹å°†æŠ½è±¡çš„æŠ€æœ¯æ¦‚å¿µä¸ Sparkle é¡¹ç›®çš„å®é™…ä»£ç ç´§å¯†ç»“åˆï¼Œè®©å­¦ä¹ è€…èƒ½å¤Ÿç›´æ¥çœ‹åˆ°ç†è®ºå¦‚ä½•è½åœ°åˆ°ç”Ÿäº§ä»£ç ä¸­ã€‚</p>
<h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-22">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>11 æ­¥å¤„ç†é“¾çš„è®¾è®¡å“²å­¦:</strong></p>
<ol>
<li><strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>: æ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¡®çš„é”™è¯¯è¾¹ç•Œå’Œé™çº§ç­–ç•¥</li>
<li><strong>å…³æ³¨ç‚¹åˆ†ç¦»</strong>: æ¯ä¸ªæ­¥éª¤åªåšä¸€ä»¶äº‹ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: æ—©æœŸæ‹’ç»ï¼ˆFail-Fastï¼‰ï¼Œé¿å…æ— æ•ˆè®¡ç®—</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>: æ¯æ­¥éƒ½æœ‰æ˜ç¡®çš„æŒ‡æ ‡å’Œæ—¥å¿—</li>
</ol>
<p><strong>ç†”æ–­å™¨æ¨¡å¼ (Circuit Breaker):</strong></p>
<ul>
<li><strong>çŠ¶æ€æœº</strong>: CLOSED â†’ OPEN â†’ HALF_OPEN</li>
<li><strong>è§¦å‘æ¡ä»¶</strong>: é”™è¯¯ç‡ &gt; 50% æˆ–å“åº”æ—¶é—´ &gt; 5 ç§’</li>
<li><strong>æ¢å¤æœºåˆ¶</strong>: å†·å´ 30 ç§’åè¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå…è®¸å°‘é‡æ¢æµ‹è¯·æ±‚</li>
</ul>
<p><strong>å¹‚ç­‰æ€§è®¾è®¡:</strong></p>
<ul>
<li><strong>è¯·æ±‚ ID</strong>: å‰ç«¯ç”Ÿæˆå”¯ä¸€ IDï¼ŒåŒ…å«ç”¨æˆ· ID + æ—¶é—´æˆ³ + åºåˆ—å·</li>
<li><strong>TTL</strong>: Redis è®°å½•å·²å¤„ç†è¯·æ±‚ï¼ŒTTL ä¸º 24 å°æ—¶</li>
<li><strong>é˜²é‡è¯•å‰¯ä½œç”¨</strong>: é¿å…é‡å¤æ‰£è´¹ã€å†™åº“ç­‰ä¸å¯é€†æ“ä½œ</li>
</ul>
<p><strong>åˆ†å¸ƒå¼é”:</strong></p>
<ul>
<li><strong>SET NX EX</strong>: åŸå­äº‰æŠ¢ï¼ŒTTL é˜²æ­¢æ­»é”</li>
<li><strong>é”ç²’åº¦</strong>: ä¼šè¯çº§é”ï¼Œé¿å…å…¨å±€é”ç«äº‰</li>
<li><strong>é”ç»­æœŸ</strong>: é•¿ä»»åŠ¡è‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢ä»»åŠ¡æ‰§è¡Œä¸­é”è¿‡æœŸ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-22">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ä¸ºä»€ä¹ˆéœ€è¦ 11 æ­¥å¤„ç†é“¾ï¼Ÿä¼šä¸ä¼šå¤ªå¤æ‚ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç”Ÿäº§ç¯å¢ƒè¦æ±‚</strong>: æ¯ä¸€æ­¥éƒ½æ˜¯ç”Ÿäº§ç¯å¢ƒè¸©å‘åçš„æ€»ç»“</li>
<li><strong>å¯ç»´æŠ¤æ€§</strong>: æ¯æ­¥ç‹¬ç«‹ï¼Œä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–</li>
<li><strong>å¯æ‰©å±•æ€§</strong>: æ–°å¢æ­¥éª¤ä¸å½±å“ç°æœ‰é€»è¾‘</li>
<li><strong>æ€§èƒ½</strong>: æ—©æœŸæ‹’ç»ï¼Œé¿å…æ— æ•ˆè®¡ç®—</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"è¿™ 11 æ­¥éƒ½æ˜¯ç”Ÿäº§ç¯å¢ƒçš„è¡€æ³ªæ•™è®­ã€‚æ¯”å¦‚æ¶ˆæ¯å»é‡ï¼Œæˆ‘ä»¬æ›¾å› ä¸ºç½‘ç»œé‡è¯•å¯¼è‡´ç”¨æˆ·ç§¯åˆ†è¢«é‡å¤æ‰£å‡ï¼›ç†”æ–­å™¨é˜²æ­¢äº†ä¸‹æ¸¸ LLM æœåŠ¡å®•æœºå¯¼è‡´çš„å…¨ç«™ç˜«ç—ªï¼›åˆ†å¸ƒå¼é”è§£å†³äº†å¤š Worker å¹¶å‘ä¿®æ”¹ç”¨æˆ·çŠ¶æ€çš„é—®é¢˜ã€‚è™½ç„¶çœ‹èµ·æ¥å¤æ‚ï¼Œä½†æ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼Œä¸”å¯ä»¥ç‹¬ç«‹æµ‹è¯•å’Œä¼˜åŒ–ã€‚å®é™…ä¸Šï¼Œé€šè¿‡åˆç†çš„å¼‚æ­¥å®ç°ï¼Œè¿™ 11 æ­¥çš„æ€»è€—æ—¶é€šå¸¸åœ¨ 50ms ä»¥å†…ã€‚"</p>
</blockquote>
<hr>
<h2 id="32-ä¸Šä¸‹æ–‡ç®¡ç†-1">3.2 ä¸Šä¸‹æ–‡ç®¡ç† </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-28">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ä¸Šä¸‹æ–‡ç®¡ç†æ˜¯ AI ä¸ªæ€§åŒ–çš„å…³é”®ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>ç”¨æˆ·ä¸Šä¸‹æ–‡</strong>: åŸºæœ¬ä¿¡æ¯ã€å­¦ä¹ è¿›åº¦ã€æ¨é€åå¥½</li>
<li><strong>å¯¹è¯å†å²</strong>: æ»‘åŠ¨çª—å£ + å¼‚æ­¥æ€»ç»“</li>
<li><strong>çŸ¥è¯†æ£€ç´¢</strong>: GraphRAG æ··åˆæœç´¢</li>
<li><strong>ä¸Šä¸‹æ–‡ä¿®å‰ª</strong>: Token ä¼˜åŒ–ä¸æ€§èƒ½æå‡</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-28">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>ç”¨æˆ·ä¸Šä¸‹æ–‡æ„å»ºï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_build_user_context</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> UserContext<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡"""</span>
    <span class="token comment"># 1. ä» DB è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</span>
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>user_service<span class="token punctuation">.</span>get_user<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token comment"># 2. å­¦ä¹ è¿›åº¦ç»Ÿè®¡</span>
    progress <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>stats_service<span class="token punctuation">.</span>get_learning_progress<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token comment"># 3. è·å–å½“å‰æ´»è·ƒçš„å†²åˆºè®¡åˆ’</span>
    sprint <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>sprint_service<span class="token punctuation">.</span>get_active_sprint<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token comment"># 4. æ¨é€åå¥½</span>
    push_pref <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>push_service<span class="token punctuation">.</span>get_preferences<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> UserContext<span class="token punctuation">(</span>
        user<span class="token operator">=</span>user<span class="token punctuation">,</span>
        progress<span class="token operator">=</span>progress<span class="token punctuation">,</span>
        active_sprint<span class="token operator">=</span>sprint<span class="token punctuation">,</span>
        push_preference<span class="token operator">=</span>push_pref
    <span class="token punctuation">)</span>
</code></pre><p><strong>GraphRAG çŸ¥è¯†æ£€ç´¢ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_retrieve_knowledge</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                             conversation_context<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> KnowledgeContext<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""GraphRAG çŸ¥è¯†æ£€ç´¢"""</span>
    <span class="token comment"># 1. å‘é‡æ··åˆæœç´¢ (Hybrid Search)</span>
    <span class="token comment"># æ€æƒ³ï¼šå¤šæ¨¡æ€å¬å›ã€‚åŒæ—¶é€šè¿‡è¯­ä¹‰å‘é‡ (pgvector) å’Œ å…³é”®è¯åŒ¹é… (Full-text search) æ‰¾åˆ°æœ€ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚</span>
    vector_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>galaxy_service<span class="token punctuation">.</span>hybrid_search<span class="token punctuation">(</span>
        user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
        query<span class="token operator">=</span>query<span class="token punctuation">,</span>
        limit<span class="token operator">=</span><span class="token number">10</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 2. å…³ç³»æ‰©å±• (Relation Expansion)</span>
    <span class="token comment"># æ€æƒ³ï¼šå…³è”æ€è€ƒã€‚ä¸ä»…çœ‹åŒ¹é…åˆ°çš„èŠ‚ç‚¹ï¼Œè¿˜è¦æ‹‰å–å®ƒä»¬çš„â€œçˆ¶èŠ‚ç‚¹â€ã€â€œå­èŠ‚ç‚¹â€æˆ–â€œå…ˆä¿®è¯¾ç¨‹â€ã€‚</span>
    expanded <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>galaxy_service<span class="token punctuation">.</span>expand_relations<span class="token punctuation">(</span>
        node_ids<span class="token operator">=</span><span class="token punctuation">[</span>r<span class="token punctuation">.</span>node_id <span class="token keyword keyword-for">for</span> r <span class="token keyword keyword-in">in</span> vector_results<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 3. ç”¨æˆ·çŠ¶æ€è¿‡æ»¤</span>
    <span class="token comment"># æ€æƒ³ï¼šä¸ªæ€§åŒ–è£å‰ªã€‚å‰”é™¤ç”¨æˆ·å·²ç»å®Œå…¨æŒæ¡çš„å†…å®¹ï¼Œæˆ–è€…æ ¹æ®ç”¨æˆ·ç­‰çº§æ¨èåˆé€‚éš¾åº¦çš„çŸ¥è¯†ã€‚</span>
    filtered <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>galaxy_service<span class="token punctuation">.</span>filter_by_user_status<span class="token punctuation">(</span>
        user_id<span class="token punctuation">,</span> expanded
    <span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> KnowledgeContext<span class="token punctuation">(</span>
        nodes<span class="token operator">=</span>filtered<span class="token punctuation">,</span>
        relations<span class="token operator">=</span>expanded<span class="token punctuation">.</span>relations<span class="token punctuation">,</span>
        relevance_score<span class="token operator">=</span>vector_results<span class="token punctuation">.</span>relevance_score
    <span class="token punctuation">)</span>
</code></pre><p><strong>ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">ContextPruner</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ™ºèƒ½ä¸Šä¸‹æ–‡ä¿®å‰ªå™¨"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_pruned_history</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. ä» Redis åŠ è½½åŸå§‹å†å²</span>
        history <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_load_chat_history<span class="token punctuation">(</span>session_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> history<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

        <span class="token comment"># 2. æ»‘åŠ¨çª—å£å†³ç­–</span>
        <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>max_history_messages<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> history<span class="token punctuation">,</span> <span class="token string">"summary_used"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>

        <span class="token comment"># 3. æ™ºèƒ½æ€»ç»“é€»è¾‘</span>
        cache_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"summary:</span><span class="token interpolation"><span class="token punctuation">{</span>session_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        cached_summary <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cache_key<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> cached_summary<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">:</span> cached_summary<span class="token punctuation">,</span> <span class="token string">"summary_used"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        
        <span class="token comment"># è§¦å‘å¼‚æ­¥ä»»åŠ¡å¹¶è¿”å›â€œé™çº§â€ç»“æœ</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_trigger_async_summary<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> history<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"messages"</span><span class="token punctuation">:</span> history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"summary_used"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-23">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä¸Šä¸‹æ–‡ç®¡ç†çš„æ ¸å¿ƒæŒ‘æˆ˜:</strong></p>
<ul>
<li><strong>Token é™åˆ¶</strong>: LLM ä¸Šä¸‹æ–‡çª—å£æœ‰é™ï¼ˆé€šå¸¸ 4K-32Kï¼‰</li>
<li><strong>æ€§èƒ½</strong>: é•¿ä¸Šä¸‹æ–‡å¯¼è‡´æ¨ç†å»¶è¿Ÿå¢åŠ </li>
<li><strong>ç›¸å…³æ€§</strong>: å†å²æ¶ˆæ¯ä¸­åªæœ‰éƒ¨åˆ†ä¸å½“å‰é—®é¢˜ç›¸å…³</li>
</ul>
<p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
<ol>
<li><strong>æ»‘åŠ¨çª—å£</strong>: åªä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯</li>
<li><strong>å¼‚æ­¥æ€»ç»“</strong>: åå° Worker å‹ç¼©å†å²ï¼Œä¸‹æ¬¡è¯·æ±‚å¯ç”¨</li>
<li><strong>è¯­ä¹‰è¿‡æ»¤</strong>: é€šè¿‡å‘é‡ç›¸ä¼¼åº¦ç­›é€‰ç›¸å…³å†å²</li>
<li><strong>åˆ†çº§å­˜å‚¨</strong>: çƒ­æ•°æ®ï¼ˆæœ€è¿‘æ¶ˆæ¯ï¼‰+ å†·æ•°æ®ï¼ˆæ€»ç»“ï¼‰</li>
</ol>
<p><strong>GraphRAG çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>ç»“æ„åŒ–</strong>: ä¸ä»…æ˜¯æ–‡æœ¬ç‰‡æ®µï¼Œè¿˜æœ‰æ‹“æ‰‘å…³ç³»</li>
<li><strong>å¯è§£é‡Š</strong>: å¯ä»¥å±•ç¤ºæ£€ç´¢è·¯å¾„å’Œç›¸å…³æ€§åˆ†æ•°</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ ¹æ®ç”¨æˆ·æŒæ¡åº¦è¿‡æ»¤å’Œæ’åº</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-23">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•å¤„ç†é•¿å¯¹è¯çš„ Token è¶…é™é—®é¢˜ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ»‘åŠ¨çª—å£</strong>: ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯</li>
<li><strong>å¼‚æ­¥æ€»ç»“</strong>: åå°å‹ç¼©å†å²ï¼Œç¼“å­˜åˆ° Redis</li>
<li><strong>è¯­ä¹‰è¿‡æ»¤</strong>: åªä¿ç•™ä¸å½“å‰é—®é¢˜ç›¸å…³çš„å†å²</li>
<li><strong>ä¼˜é›…é™çº§</strong>: ç¼“å­˜å¤±æ•ˆæ—¶å›é€€åˆ°æ»‘åŠ¨çª—å£</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨ä¸‰ç®¡é½ä¸‹çš„ç­–ç•¥ã€‚é¦–å…ˆï¼Œæ»‘åŠ¨çª—å£ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯ä½œä¸ºåŸºç¡€ã€‚å…¶æ¬¡ï¼Œå½“å¯¹è¯è¶…è¿‡ 30 è½®æ—¶ï¼Œè§¦å‘å¼‚æ­¥æ€»ç»“ä»»åŠ¡ï¼Œå°†æ—§å†å²å‹ç¼©æˆæ‘˜è¦å¹¶ç¼“å­˜ 1 å°æ—¶ã€‚ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ã€æ‘˜è¦ + æœ€è¿‘5æ¡ã€‘çš„ç»„åˆã€‚æœ€åï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦è¿‡æ»¤ï¼Œåªä¿ç•™ä¸å½“å‰é—®é¢˜ç›¸å…³çš„å†å²ç‰‡æ®µã€‚å¦‚æœæ€»ç»“ä»»åŠ¡å¤±è´¥ï¼Œç³»ç»Ÿä¼šä¼˜é›…é™çº§åˆ°çº¯æ»‘åŠ¨çª—å£ï¼Œç¡®ä¿æœåŠ¡ä¸ä¸­æ–­ã€‚"</p>
</blockquote>
<hr>
<h2 id="33-åŠ¨æ€å·¥å…·ç³»ç»Ÿ-1">3.3 åŠ¨æ€å·¥å…·ç³»ç»Ÿ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-29">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>åŠ¨æ€å·¥å…·ç³»ç»Ÿæ˜¯ Agent çš„ <strong>æ’ä»¶æ¶æ„</strong>ï¼Œæ”¯æŒè¿è¡Œæ—¶è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œå·¥å…·ï¼š</p>
<ul>
<li><strong>è‡ªåŠ¨æ‰«æ</strong>: åå°„æœºåˆ¶å‘ç°æ‰€æœ‰ BaseTool å­ç±»</li>
<li><strong>Schema ç”Ÿæˆ</strong>: è½¬æ¢ä¸º OpenAI Function Calling æ ¼å¼</li>
<li><strong>çƒ­åŠ è½½</strong>: æ–°å¢å·¥å…·æ— éœ€é‡å¯æœåŠ¡</li>
<li><strong>å¼€é—­åŸåˆ™</strong>: æ–°å¢å·¥å…·æ— éœ€ä¿®æ”¹æ³¨å†Œè¡¨ä»£ç </li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-29">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>å·¥å…·æ³¨å†Œè¡¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/dynamic_tool_registry.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">DynamicToolRegistry</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åŠ¨æ€å·¥å…·æ³¨å†Œè¡¨ - è‡ªåŠ¨å‘ç°æ¨¡å¼"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">register_from_package</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> package_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. åˆ©ç”¨ Python åå°„æœºåˆ¶åŠ¨æ€åŠ è½½æ¨¡å—</span>
        <span class="token comment"># æ€æƒ³ï¼šå¼€é—­åŸåˆ™ã€‚æ–°å¢ä¸€ä¸ª AI å·¥å…·åªéœ€è¦åœ¨ tools ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¸éœ€è¦ä¿®æ”¹æ³¨å†Œè¡¨çš„ä»£ç ã€‚</span>
        package <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span>package_path<span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> importer<span class="token punctuation">,</span> modname<span class="token punctuation">,</span> ispkg <span class="token keyword keyword-in">in</span> pkgutil<span class="token punctuation">.</span>iter_modules<span class="token punctuation">(</span>package<span class="token punctuation">.</span>__path__<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰ BaseTool çš„å­ç±»</span>
            self<span class="token punctuation">.</span>register_from_module<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>package_path<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>modname<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_openai_tools_schema</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># 2. è½¬æ¢ä¸º OpenAI å…¼å®¹çš„ JSON Schema æè¿°</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>tool<span class="token punctuation">.</span>to_openai_schema<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> tool <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>_tools<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre><p><strong>å·¥å…·åŸºç±»è®¾è®¡ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/base_tool.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">BaseTool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å·¥å…·åŸºç±» - å®šä¹‰æ ‡å‡†æ¥å£"""</span>

    <span class="token comment"># 1. å…ƒæ•°æ®å®šä¹‰</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span>           <span class="token comment"># å·¥å…·å”¯ä¸€æ ‡è¯†</span>
    description<span class="token punctuation">:</span> <span class="token builtin">str</span>    <span class="token comment"># ç”¨äºå‘Šè¯‰ LLM ä»€ä¹ˆæ—¶å€™è¯¥ç”¨è¿™ä¸ªå·¥å…·</span>
    category<span class="token punctuation">:</span> ToolCategory

    <span class="token comment"># 2. å‚æ•° Schema (JSON Schema æ ¼å¼)</span>
    <span class="token comment"># æ€æƒ³ï¼šè‡ªæè¿°ã€‚å·¥å…·è‡ªå·±å®šä¹‰éœ€è¦ä»€ä¹ˆå‚æ•°ï¼ŒLLM æ ¹æ®è¿™ä¸ªå®šä¹‰æ¥æå–å‚æ•°ã€‚</span>
    parameters_schema<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰§è¡Œé€»è¾‘ - ç”±å­ç±»å®ç°"""</span>
        <span class="token keyword keyword-raise">raise</span> NotImplementedError

    <span class="token keyword keyword-def">def</span> <span class="token function">to_openai_schema</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è½¬æ¢ä¸º OpenAI åè®®æ ¼å¼"""</span>
        <span class="token comment"># å°† Python å®šä¹‰è½¬æ¢ä¸º OpenAI API æ‰€éœ€çš„ç‰¹å®š JSON ç»“æ„</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><p><strong>å…·ä½“å·¥å…·ç¤ºä¾‹ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/tools/knowledge_tools.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">GetKnowledgeNodeTool</span><span class="token punctuation">(</span>BaseTool<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è·å–çŸ¥è¯†ç‚¹è¯¦æƒ…å·¥å…·"""</span>
    
    name <span class="token operator">=</span> <span class="token string">"get_knowledge_node"</span>
    description <span class="token operator">=</span> <span class="token string">"è·å–æŒ‡å®šçŸ¥è¯†ç‚¹çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æè¿°ã€éš¾åº¦ã€ç›¸å…³çŸ¥è¯†ç‚¹"</span>
    category <span class="token operator">=</span> ToolCategory<span class="token punctuation">.</span>KNOWLEDGE
    
    parameters_schema <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"node_id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
                <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"çŸ¥è¯†ç‚¹å”¯ä¸€æ ‡è¯†"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"include_relations"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"boolean"</span><span class="token punctuation">,</span>
                <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"æ˜¯å¦åŒ…å«å…³è”çŸ¥è¯†ç‚¹"</span><span class="token punctuation">,</span>
                <span class="token string">"default"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"node_id"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> include_relations<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># å®é™…ä¸šåŠ¡é€»è¾‘</span>
        node <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_node<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> include_relations<span class="token punctuation">:</span>
            node<span class="token punctuation">[</span><span class="token string">'relations'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get_relations<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> node
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-24">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€å·¥å…·ç³»ç»Ÿï¼Ÿ</strong></p>
<ol>
<li><strong>å¼€é—­åŸåˆ™</strong>: æ–°å¢å·¥å…·ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç </li>
<li><strong>æ’ä»¶åŒ–</strong>: å·¥å…·å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²</li>
<li><strong>çµæ´»æ€§</strong>: è¿è¡Œæ—¶åŠ¨æ€å‘ç°ï¼Œæ”¯æŒçƒ­æ›´æ–°</li>
<li><strong>æ ‡å‡†åŒ–</strong>: ç»Ÿä¸€çš„æ¥å£å®šä¹‰ï¼Œä¾¿äº LLM è°ƒç”¨</li>
</ol>
<p><strong>åå°„æœºåˆ¶çš„åº”ç”¨:</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œæ‰€æœ‰å·¥å…·</span>
<span class="token keyword keyword-for">for</span> importer<span class="token punctuation">,</span> modname<span class="token punctuation">,</span> ispkg <span class="token keyword keyword-in">in</span> pkgutil<span class="token punctuation">.</span>iter_modules<span class="token punctuation">(</span>package<span class="token punctuation">.</span>__path__<span class="token punctuation">)</span><span class="token punctuation">:</span>
    module <span class="token operator">=</span> importlib<span class="token punctuation">.</span>import_module<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>package_path<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>modname<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> name<span class="token punctuation">,</span> obj <span class="token keyword keyword-in">in</span> inspect<span class="token punctuation">.</span>getmembers<span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> inspect<span class="token punctuation">.</span>isclass<span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token keyword keyword-and">and</span> <span class="token builtin">issubclass</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> BaseTool<span class="token punctuation">)</span> <span class="token keyword keyword-and">and</span> obj <span class="token operator">!=</span> BaseTool<span class="token punctuation">:</span>
            registry<span class="token punctuation">.</span>register<span class="token punctuation">(</span>obj<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p><strong>Schema è½¬æ¢çš„å…³é”®:</strong></p>
<ul>
<li><strong>ç±»å‹æ˜ å°„</strong>: Python ç±»å‹ â†’ JSON Schema ç±»å‹</li>
<li><strong>å‚æ•°æè¿°</strong>: æ¸…æ™°çš„ description å¸®åŠ© LLM ç†è§£</li>
<li><strong>å¿…å¡«å­—æ®µ</strong>: æ ‡è®° required å‚æ•°</li>
<li><strong>é»˜è®¤å€¼</strong>: æä¾›åˆç†çš„é»˜è®¤å€¼</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-24">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: åŠ¨æ€å·¥å…·ç³»ç»Ÿå¦‚ä½•å®ç°çƒ­åŠ è½½ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ¨¡å—é‡è½½</strong>: ä½¿ç”¨ importlib.reload()</li>
<li><strong>æ–‡ä»¶ç›‘å¬</strong>: ä½¿ç”¨ watchdog ç›‘æ§å·¥å…·ç›®å½•å˜åŒ–</li>
<li><strong>åŸå­æ›¿æ¢</strong>: æ–°å·¥å…·æ³¨å†Œå®Œæˆåï¼ŒåŸå­æ›¿æ¢æ—§å·¥å…·</li>
<li><strong>ç‰ˆæœ¬æ§åˆ¶</strong>: æ”¯æŒå·¥å…·ç‰ˆæœ¬ç®¡ç†ï¼Œå¯å›æ»š</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é€šè¿‡æ–‡ä»¶ç›‘å¬å’Œæ¨¡å—é‡è½½å®ç°çƒ­åŠ è½½ã€‚ä½¿ç”¨ watchdog åº“ç›‘æ§ tools ç›®å½•ï¼Œå½“æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–æ—¶ï¼Œè§¦å‘é‡è½½æµç¨‹ã€‚é¦–å…ˆ importlib.reload() é‡æ–°åŠ è½½æ¨¡å—ï¼Œç„¶åæå–æ–°çš„å·¥å…·ç±»ï¼ŒåŸå­æ›¿æ¢æ³¨å†Œè¡¨ä¸­çš„æ—§å·¥å…·ã€‚æ•´ä¸ªè¿‡ç¨‹å¯¹è°ƒç”¨æ–¹é€æ˜ï¼Œä¸ä¼šä¸­æ–­ç°æœ‰è¯·æ±‚ã€‚æˆ‘ä»¬è¿˜å®ç°äº†ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯ä»¥éšæ—¶å›æ»šåˆ°ä¹‹å‰çš„å·¥å…·ç‰ˆæœ¬ã€‚"</p>
</blockquote>
<hr>
<h2 id="34-llm-æœåŠ¡é›†æˆ-1">3.4 LLM æœåŠ¡é›†æˆ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-30">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>LLM æœåŠ¡é›†æˆæ˜¯ AI å¼•æ“çš„æ ¸å¿ƒï¼Œé‡‡ç”¨ <strong>é€‚é…å™¨æ¨¡å¼</strong> å®ç°å¤šæ¨¡å‹æ”¯æŒï¼š</p>
<ul>
<li><strong>å¤šæ¨¡å‹é€‚é…</strong>: ç»Ÿä¸€æ¥å£å°è£…ä¸åŒå‚å•† API</li>
<li><strong>å·¥å…·è°ƒç”¨å¾ªç¯</strong>: LLM â†’ å·¥å…· â†’ ç»“æœ â†’ LLM â†’ å›ç­”</li>
<li><strong>æµå¼å¤„ç†</strong>: å®ç°æ‰“å­—æœºæ•ˆæœï¼Œé™ä½æ„ŸçŸ¥å»¶è¿Ÿ</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: è¶…æ—¶ã€é™æµã€é™çº§ç­–ç•¥</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-30">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>LLM æœåŠ¡é€‚é…å™¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/llm_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">LLMService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""LLM æœåŠ¡ - é€‚é…å™¨æ¨¡å¼å®ç°"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>providers <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'openai'</span><span class="token punctuation">:</span> OpenAIProvider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'anthropic'</span><span class="token punctuation">:</span> AnthropicProvider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'deepseek'</span><span class="token punctuation">:</span> DeepSeekProvider<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>default_provider <span class="token operator">=</span> <span class="token string">'openai'</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">chat_stream_with_tools</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. ç­–ç•¥æ¨¡å¼ï¼šæ ¹æ®é…ç½®åŠ¨æ€åˆ‡æ¢æ¨¡å‹æä¾›å•†</span>
        provider <span class="token operator">=</span> self<span class="token punctuation">.</span>providers<span class="token punctuation">.</span>get<span class="token punctuation">(</span>model <span class="token keyword keyword-or">or</span> self<span class="token punctuation">.</span>default_provider<span class="token punctuation">)</span>

        <span class="token comment"># 2. é€’å½’/å¾ªç¯å¤„ç†å·¥å…·è°ƒç”¨</span>
        <span class="token comment"># æµç¨‹ï¼šLLM å†³å®šè°ƒç”¨å·¥å…· -&gt; æ‰§è¡Œå·¥å…· -&gt; å°†ç»“æœå–‚å› LLM -&gt; ç”Ÿæˆæœ€ç»ˆå›ç­”</span>
        <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> provider<span class="token punctuation">.</span>chat_complete<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_call"</span><span class="token punctuation">:</span>
                <span class="token comment"># æ‰§è¡Œå·¥å…·å¹¶è·å¾—ç»“æœ</span>
                results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_execute_tools<span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>tool_calls<span class="token punctuation">)</span>
                <span class="token comment"># é‡è¦ï¼šå°†å·¥å…·æ‰§è¡Œç»“æœæ·»åŠ å›å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œå†æ¬¡è¯·æ±‚ LLM</span>
                messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> results<span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token comment"># é€’å½’ç”Ÿæˆåç»­å›ç­”</span>
                <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> final_chunk <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>chat_stream_with_tools<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-yield">yield</span> final_chunk
</code></pre><p><strong>å·¥å…·è°ƒç”¨å¾ªç¯ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_call_llm_with_tools</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> user_context<span class="token punctuation">,</span> knowledge_context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""LLM å·¥å…·è°ƒç”¨å¾ªç¯"""</span>
    
    <span class="token comment"># 1. å‡†å¤‡å·¥å…·</span>
    tools <span class="token operator">=</span> tool_registry<span class="token punctuation">.</span>get_openai_tools_schema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. æ„å»ºç³»ç»Ÿæç¤º</span>
    system_prompt <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_system_prompt<span class="token punctuation">(</span>user_context<span class="token punctuation">,</span> knowledge_context<span class="token punctuation">)</span>
    
    <span class="token comment"># 3. åˆå§‹æ¶ˆæ¯</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>message<span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    
    <span class="token comment"># 4. å·¥å…·è°ƒç”¨å¾ªç¯</span>
    max_tool_calls <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment"># é˜²æ­¢æ— é™å¾ªç¯</span>
    tool_call_count <span class="token operator">=</span> <span class="token number">0</span>
    
    <span class="token keyword keyword-while">while</span> tool_call_count <span class="token operator">&lt;</span> max_tool_calls<span class="token punctuation">:</span>
        <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> llm_service<span class="token punctuation">.</span>chat_stream_with_tools<span class="token punctuation">(</span>
            messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
            tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
            model<span class="token operator">=</span>request<span class="token punctuation">.</span>model
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"text"</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-yield">yield</span> TextEvent<span class="token punctuation">(</span>content<span class="token operator">=</span>chunk<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
            <span class="token keyword keyword-elif">elif</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_call"</span><span class="token punctuation">:</span>
                <span class="token comment"># æ‰§è¡Œå·¥å…·</span>
                result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>tool_executor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>tool_call<span class="token punctuation">)</span>
                <span class="token comment"># æ·»åŠ åˆ°ä¸Šä¸‹æ–‡</span>
                messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
                    <span class="token string">"tool_call_id"</span><span class="token punctuation">:</span> chunk<span class="token punctuation">.</span>tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                    <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                tool_call_count <span class="token operator">+=</span> <span class="token number">1</span>
                <span class="token keyword keyword-break">break</span>  <span class="token comment"># é€€å‡ºæµå¼å¾ªç¯ï¼Œé‡æ–°è°ƒç”¨ LLM</span>
            <span class="token keyword keyword-elif">elif</span> chunk<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"error"</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span>chunk<span class="token punctuation">.</span>code<span class="token punctuation">,</span> message<span class="token operator">=</span>chunk<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span>
</code></pre><p><strong>æµå¼å¤„ç†ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">chat_complete_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æµå¼èŠå¤©å®Œæˆ"""</span>
    provider <span class="token operator">=</span> self<span class="token punctuation">.</span>providers<span class="token punctuation">[</span>model<span class="token punctuation">]</span>
    
    <span class="token comment"># ä½¿ç”¨ async for éšè—ç¼“å†²å’ŒçŠ¶æ€åŒæ­¥</span>
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> provider<span class="token punctuation">.</span>chat_complete<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> tools<span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># å®ç°æ‰“å­—æœºæ•ˆæœ</span>
        <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>content<span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>content
        <span class="token comment"># å¤„ç†å·¥å…·è°ƒç”¨</span>
        <span class="token keyword keyword-if">if</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"tool_call"</span><span class="token punctuation">,</span>
                <span class="token string">"tool_calls"</span><span class="token punctuation">:</span> chunk<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>delta<span class="token punctuation">.</span>tool_calls
            <span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-25">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>é€‚é…å™¨æ¨¡å¼çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>ç»Ÿä¸€æ¥å£</strong>: ä¸šåŠ¡å±‚ä¸å…³å¿ƒåº•å±‚æ˜¯ OpenAI è¿˜æ˜¯ DeepSeek</li>
<li><strong>æ˜“äºæ‰©å±•</strong>: æ–°å¢æ¨¡å‹åªéœ€å®ç°é€‚é…å™¨</li>
<li><strong>ä¾¿äºæµ‹è¯•</strong>: å¯ä»¥ mock é€‚é…å™¨è¿›è¡Œå•å…ƒæµ‹è¯•</li>
<li><strong>å¹³æ»‘è¿ç§»</strong>: å¯ä»¥åœ¨ä¸åŒæ¨¡å‹é—´åˆ‡æ¢ï¼Œä¸šåŠ¡ä»£ç æ— éœ€ä¿®æ”¹</li>
</ul>
<p><strong>å·¥å…·è°ƒç”¨å¾ªç¯çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>é€’å½’æ€æƒ³</strong>: å·¥å…·ç»“æœä½œä¸ºæ–°çš„è¾“å…¥ï¼Œå†æ¬¡è°ƒç”¨ LLM</li>
<li><strong>å¾ªç¯ä¿æŠ¤</strong>: è®¾ç½®æœ€å¤§è°ƒç”¨æ¬¡æ•°ï¼Œé˜²æ­¢æ— é™å¾ªç¯</li>
<li><strong>ä¸Šä¸‹æ–‡ç´¯ç§¯</strong>: æ‰€æœ‰å·¥å…·è°ƒç”¨ç»“æœéƒ½ä¿ç•™åœ¨å¯¹è¯å†å²ä¸­</li>
<li><strong>æµå¼è¾“å‡º</strong>: è¾¹ç”Ÿæˆè¾¹è¾“å‡ºï¼Œé™ä½æ„ŸçŸ¥å»¶è¿Ÿ</li>
</ul>
<p><strong>é”™è¯¯å¤„ç†ç­–ç•¥:</strong></p>
<ul>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>: å•æ¬¡ LLM è°ƒç”¨æœ€å¤šç­‰å¾… 30 ç§’</li>
<li><strong>é™æµä¿æŠ¤</strong>: éµå®ˆå„å‚å•†çš„ Rate Limit</li>
<li><strong>é™çº§ç­–ç•¥</strong>: ä¸»æ¨¡å‹ä¸å¯ç”¨æ—¶åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹</li>
<li><strong>ç†”æ–­æœºåˆ¶</strong>: è¿ç»­å¤±è´¥åè‡ªåŠ¨åˆ‡æ–­ï¼Œä¿æŠ¤ç³»ç»Ÿ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-25">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å·¥å…·è°ƒç”¨å¾ªç¯å¦‚ä½•é˜²æ­¢æ— é™å¾ªç¯ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>è°ƒç”¨æ¬¡æ•°é™åˆ¶</strong>: æœ€å¤š 5 æ¬¡å·¥å…·è°ƒç”¨</li>
<li><strong>ä¸Šä¸‹æ–‡é•¿åº¦</strong>: æ¯æ¬¡è°ƒç”¨å¢åŠ  Tokenï¼Œè‡ªç„¶é™åˆ¶å¾ªç¯</li>
<li><strong>å·¥å…·è®¾è®¡</strong>: å·¥å…·æœ¬èº«åº”è¯¥æ˜¯æ— çŠ¶æ€çš„ï¼Œä¸ä¼šäº§ç”Ÿå¾ªç¯ä¾èµ–</li>
<li><strong>LLM æŒ‡ä»¤</strong>: åœ¨ System Prompt ä¸­æ˜ç¡®æŒ‡ç¤ºå·¥å…·ä½¿ç”¨è§„åˆ™</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è®¾ç½®äº†ä¸‰é“é˜²çº¿ï¼šç¬¬ä¸€ï¼Œæœ€å¤§è°ƒç”¨æ¬¡æ•°é™åˆ¶ï¼Œè¶…è¿‡ 5 æ¬¡è‡ªåŠ¨ç»ˆæ­¢ï¼›ç¬¬äºŒï¼Œæ¯æ¬¡å·¥å…·è°ƒç”¨éƒ½ä¼šå¢åŠ ä¸Šä¸‹æ–‡é•¿åº¦ï¼ŒToken è¶…é™ä¼šè‡ªç„¶åœæ­¢ï¼›ç¬¬ä¸‰ï¼Œå·¥å…·è®¾è®¡éµå¾ªæ— çŠ¶æ€åŸåˆ™ï¼Œé¿å…å¾ªç¯ä¾èµ–ã€‚åŒæ—¶æˆ‘ä»¬åœ¨ System Prompt ä¸­æ˜ç¡®æŒ‡ç¤º LLM å·¥å…·çš„ä½¿ç”¨åœºæ™¯å’Œè§„åˆ™ï¼Œä»æºå¤´ä¸Šå‡å°‘æ— æ•ˆè°ƒç”¨ã€‚"</p>
</blockquote>
<hr>
<h2 id="35-ç”Ÿäº§çº§ç‰¹æ€§-1">3.5 ç”Ÿäº§çº§ç‰¹æ€§ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-31">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Python Agent çš„ç”Ÿäº§çº§ç‰¹æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>æ¶ˆæ¯å»é‡</strong>: MessageTracker + Redis</li>
<li><strong>ç†”æ–­ä¿æŠ¤</strong>: CircuitBreaker</li>
<li><strong>å¹¶å‘æ§åˆ¶</strong>: Session Lock + Redis</li>
<li><strong>ä¸Šä¸‹æ–‡ä¿®å‰ª</strong>: ContextPruner</li>
<li><strong>åŠ¨æ€å·¥å…·</strong>: è‡ªåŠ¨å‘ç° + æ³¨å†Œè¡¨</li>
<li><strong>ç›‘æ§åŸ‹ç‚¹</strong>: Prometheus + Metrics</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>: asyncio + é˜Ÿåˆ—</li>
<li><strong>é”™è¯¯é™çº§</strong>: Graceful Degradation</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-31">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>æ¶ˆæ¯å»é‡ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">MessageTracker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ¶ˆæ¯å»é‡ï¼šé˜²æ­¢é‡å¤å¤„ç†"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">is_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">mark_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> ttl<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>key<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
</code></pre><p><strong>ç†”æ–­å™¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ç†”æ–­å™¨æ¨¡å¼ï¼šç³»ç»Ÿè‡ªä¿æŠ¤çš„â€œä¿é™©ä¸â€"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">can_execute</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_state_from_redis<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-if">if</span> state <span class="token operator">==</span> <span class="token string">"OPEN"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>last_failure_time <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>recovery_timeout<span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"HALF_OPEN"</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">record_failure</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•å¤±è´¥ï¼Œè§¦å‘ç†”æ–­"""</span>
        self<span class="token punctuation">.</span>failure_count <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>failure_count <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"OPEN"</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>last_failure_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><strong>å¹¶å‘æ§åˆ¶ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">DistributedSemaphore</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åˆ†å¸ƒå¼ä¿¡å·é‡"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">acquire</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        local key = KEYS[1]
        local max_permits = tonumber(ARGV[1])
        local timeout = tonumber(ARGV[2])
        
        local current = redis.call('GET', key) or 0
        if tonumber(current) &lt; max_permits then
            redis.call('INCR', key)
            return 1
        else
            return 0
        end
        """</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_permits<span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-26">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç”Ÿäº§çº§ç‰¹æ€§çš„å…±åŒç›®æ ‡:</strong></p>
<ul>
<li><strong>è‡ªæ„ˆèƒ½åŠ›</strong>: ç³»ç»Ÿèƒ½å¤Ÿä»éƒ¨åˆ†æ•…éšœä¸­è‡ªåŠ¨æ¢å¤</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: å•ç‚¹æ•…éšœä¸å½±å“å…¨å±€</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>: é€šè¿‡æŒ‡æ ‡å’Œæ—¥å¿—äº†è§£ç³»ç»ŸçŠ¶æ€</li>
<li><strong>ä¼˜é›…é™çº§</strong>: æ ¸å¿ƒåŠŸèƒ½ä¿æŒï¼Œéæ ¸å¿ƒåŠŸèƒ½é™çº§</li>
</ul>
<p><strong>é˜²å¾¡æ€§ç¼–ç¨‹çš„å±‚æ¬¡:</strong></p>
<ol>
<li><strong>è¾“å…¥éªŒè¯</strong>: é˜²æ­¢éæ³•è¾“å…¥</li>
<li><strong>å¹¶å‘æ§åˆ¶</strong>: é˜²æ­¢èµ„æºç«äº‰</li>
<li><strong>ç†”æ–­ä¿æŠ¤</strong>: é˜²æ­¢çº§è”æ•…éšœ</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: é˜²æ­¢è¿›ç¨‹å´©æºƒ</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>: åŠæ—¶å‘ç°é—®é¢˜</li>
</ol>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-26">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•ä¿è¯ Python Agent çš„é«˜å¯ç”¨æ€§ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>å¤šå‰¯æœ¬éƒ¨ç½²</strong>: Kubernetes æ°´å¹³æ‰©å±•</li>
<li><strong>ç†”æ–­é™çº§</strong>: å¿«é€Ÿå¤±è´¥ï¼Œä¼˜é›…é™çº§</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>: é˜Ÿåˆ—è§£è€¦ï¼Œå‰Šå³°å¡«è°·</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>: Prometheus + Grafana</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨å¤šå±‚é˜²æŠ¤ï¼šé¦–å…ˆï¼Œé€šè¿‡ Kubernetes éƒ¨ç½²å¤šä¸ªå‰¯æœ¬ï¼Œé…åˆ Service è´Ÿè½½å‡è¡¡ï¼›å…¶æ¬¡ï¼Œç†”æ–­å™¨å’Œé™æµå™¨é˜²æ­¢è¿‡è½½ï¼›ç¬¬ä¸‰ï¼Œå¼‚æ­¥é˜Ÿåˆ—å¤„ç†è€—æ—¶ä»»åŠ¡ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹ï¼›ç¬¬å››ï¼Œå®Œå–„çš„ç›‘æ§ä½“ç³»ï¼ŒåŒ…æ‹¬ QPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ç­‰æŒ‡æ ‡ï¼Œé…åˆ PagerDuty å‘Šè­¦ã€‚é€šè¿‡è¿™äº›æªæ–½ï¼Œæˆ‘ä»¬çš„ Python Agent å¯ä»¥è¾¾åˆ° 99.95% çš„å¯ç”¨æ€§ã€‚"</p>
</blockquote>
<hr>
<p><em>ç”±äºæ–‡æ¡£ç¯‡å¹…é™åˆ¶ï¼Œæˆ‘å°†ç»§ç»­å®Œæˆå‰©ä½™ç« èŠ‚çš„å†…å®¹...</em></p>
<p>&lt;write_to_file&gt;<br>
<path>docs/æ·±åº¦æŠ€æœ¯è®²è§£æ•™æ¡ˆ_å®Œæ•´ç‰ˆ.md</path><br>
<content># Sparkle AI Learning Assistant - æ·±åº¦æŠ€æœ¯è®²è§£æ•™æ¡ˆï¼ˆç»­ï¼‰</content></p>
<h2 id="35-ç”Ÿäº§çº§ç‰¹æ€§ç»­">3.5 ç”Ÿäº§çº§ç‰¹æ€§ï¼ˆç»­ï¼‰ </h2>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-32">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>ç›‘æ§åŸ‹ç‚¹ç¤ºä¾‹ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/monitoring/metrics.py</span>

<span class="token keyword keyword-from">from</span> prometheus_client <span class="token keyword keyword-import">import</span> Counter<span class="token punctuation">,</span> Histogram<span class="token punctuation">,</span> Gauge
<span class="token keyword keyword-import">import</span> time

<span class="token keyword keyword-class">class</span> <span class="token class-name">MetricsCollector</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Prometheus æŒ‡æ ‡æ”¶é›†å™¨"""</span>
    
    <span class="token comment"># è¯·æ±‚è®¡æ•°å™¨</span>
    REQUEST_TOTAL <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        <span class="token string">'agent_requests_total'</span><span class="token punctuation">,</span>
        <span class="token string">'Total number of requests'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">,</span> <span class="token string">'model'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># å»¶è¿Ÿç›´æ–¹å›¾</span>
    REQUEST_DURATION <span class="token operator">=</span> Histogram<span class="token punctuation">(</span>
        <span class="token string">'agent_request_duration_seconds'</span><span class="token punctuation">,</span>
        <span class="token string">'Request duration in seconds'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">,</span> <span class="token string">'model'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># Token æ¶ˆè€—</span>
    TOKEN_CONSUMPTION <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        <span class="token string">'agent_token_consumption'</span><span class="token punctuation">,</span>
        <span class="token string">'Token consumption'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">]</span>  <span class="token comment"># type: prompt/completion</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># ä¸šåŠ¡æŒ‡æ ‡</span>
    TOOL_CALL_TOTAL <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        <span class="token string">'agent_tool_calls_total'</span><span class="token punctuation">,</span>
        <span class="token string">'Total tool calls'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'tool_name'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># å¹¶å‘æ•°</span>
    ACTIVE_SESSIONS <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
        <span class="token string">'agent_active_sessions'</span><span class="token punctuation">,</span>
        <span class="token string">'Number of active sessions'</span>
    <span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">MonitoredOrchestrator</span><span class="token punctuation">(</span>ProductionChatOrchestrator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¸¦ç›‘æ§çš„ç¼–æ’å™¨"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        metrics <span class="token operator">=</span> MetricsCollector<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token comment"># è®°å½•å¹¶å‘æ•°</span>
            metrics<span class="token punctuation">.</span>ACTIVE_SESSIONS<span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># è®°å½•è¯·æ±‚</span>
            metrics<span class="token punctuation">.</span>REQUEST_TOTAL<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
                method<span class="token operator">=</span><span class="token string">'chat'</span><span class="token punctuation">,</span>
                status<span class="token operator">=</span><span class="token string">'processing'</span><span class="token punctuation">,</span>
                model<span class="token operator">=</span>request<span class="token punctuation">.</span>model
            <span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># å¤„ç†è¯·æ±‚</span>
            <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>process_stream<span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-yield">yield</span> event
            
            <span class="token comment"># è®°å½•æˆåŠŸ</span>
            metrics<span class="token punctuation">.</span>REQUEST_TOTAL<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
                method<span class="token operator">=</span><span class="token string">'chat'</span><span class="token punctuation">,</span>
                status<span class="token operator">=</span><span class="token string">'success'</span><span class="token punctuation">,</span>
                model<span class="token operator">=</span>request<span class="token punctuation">.</span>model
            <span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># è®°å½•å¤±è´¥</span>
            metrics<span class="token punctuation">.</span>REQUEST_TOTAL<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
                method<span class="token operator">=</span><span class="token string">'chat'</span><span class="token punctuation">,</span>
                status<span class="token operator">=</span><span class="token string">'error'</span><span class="token punctuation">,</span>
                model<span class="token operator">=</span>request<span class="token punctuation">.</span>model
            <span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-raise">raise</span>
        <span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># è®°å½•å»¶è¿Ÿ</span>
            duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
            metrics<span class="token punctuation">.</span>REQUEST_DURATION<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
                method<span class="token operator">=</span><span class="token string">'chat'</span><span class="token punctuation">,</span>
                model<span class="token operator">=</span>request<span class="token punctuation">.</span>model
            <span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>
            
            <span class="token comment"># å‡å°‘å¹¶å‘æ•°</span>
            metrics<span class="token punctuation">.</span>ACTIVE_SESSIONS<span class="token punctuation">.</span>dec<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><strong>é”™è¯¯é™çº§ç­–ç•¥ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">GracefulDegrader</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä¼˜é›…é™çº§ç®¡ç†å™¨"""</span>
    
    DEGRADATION_LEVELS <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'normal'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'degraded'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># é™çº§ï¼šåªç”¨å‘é‡æœç´¢</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>   <span class="token comment"># é™çº§ï¼šç¦ç”¨å·¥å…·</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'critical'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'fallback_to_template'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># é™çº§ï¼šä½¿ç”¨æ¨¡æ¿å›å¤</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_degradation_level</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ¹æ®ç³»ç»ŸçŠ¶æ€è·å–é™çº§çº§åˆ«"""</span>
        <span class="token comment"># æ£€æŸ¥ä¸‹æ¸¸æœåŠ¡å¥åº·çŠ¶æ€</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_llm_health<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'critical'</span>
        
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_vector_db_health<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'degraded'</span>
        
        <span class="token comment"># æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½</span>
        cpu_load <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_cpu_load<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> cpu_load <span class="token operator">&gt;</span> <span class="token number">80</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'degraded'</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token string">'normal'</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute_with_degradation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰§è¡Œå‡½æ•°ï¼Œæ”¯æŒé™çº§"""</span>
        level <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get_degradation_level<span class="token punctuation">(</span><span class="token punctuation">)</span>
        config <span class="token operator">=</span> self<span class="token punctuation">.</span>DEGRADATION_LEVELS<span class="token punctuation">[</span>level<span class="token punctuation">]</span>
        
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> config<span class="token operator">=</span>config<span class="token punctuation">)</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> level <span class="token operator">==</span> <span class="token string">'normal'</span><span class="token punctuation">:</span>
                <span class="token comment"># å°è¯•é™çº§æ‰§è¡Œ</span>
                degraded_config <span class="token operator">=</span> self<span class="token punctuation">.</span>DEGRADATION_LEVELS<span class="token punctuation">[</span><span class="token string">'degraded'</span><span class="token punctuation">]</span>
                <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> config<span class="token operator">=</span>degraded_config<span class="token punctuation">)</span>
                <span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
                    <span class="token comment"># æœ€ç»ˆé™çº§</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_fallback_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_fallback_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_fallback_response</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æœ€ç»ˆé™çº§ï¼šæ¨¡æ¿åŒ–å›å¤"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ç³»ç»Ÿå½“å‰è´Ÿè½½è¾ƒé«˜ï¼Œæ­£åœ¨ä¸ºæ‚¨æ’é˜Ÿå¤„ç†..."</span><span class="token punctuation">,</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"queued"</span><span class="token punctuation">,</span>
            <span class="token string">"estimated_time"</span><span class="token punctuation">:</span> <span class="token string">"2-3åˆ†é’Ÿ"</span>
        <span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-27">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç›‘æ§ä½“ç³»çš„è®¾è®¡å“²å­¦:</strong></p>
<ol>
<li>
<p><strong>å¤šç»´åº¦æŒ‡æ ‡</strong>:</p>
<ul>
<li><strong>ç³»ç»ŸæŒ‡æ ‡</strong>: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ</li>
<li><strong>åº”ç”¨æŒ‡æ ‡</strong>: QPSã€å»¶è¿Ÿã€é”™è¯¯ç‡</li>
<li><strong>ä¸šåŠ¡æŒ‡æ ‡</strong>: Token æ¶ˆè€—ã€å·¥å…·è°ƒç”¨ã€ç”¨æˆ·æ»¡æ„åº¦</li>
<li><strong>é»„é‡‘æŒ‡æ ‡</strong>: RED (Rate, Error, Duration)</li>
</ul>
</li>
<li>
<p><strong>å‘Šè­¦åˆ†çº§</strong>:</p>
<ul>
<li><strong>P0 (ç´§æ€¥)</strong>: ç³»ç»Ÿä¸å¯ç”¨ï¼Œç«‹å³å¤„ç†</li>
<li><strong>P1 (é‡è¦)</strong>: æ ¸å¿ƒåŠŸèƒ½å—å½±å“ï¼Œ2å°æ—¶å†…å¤„ç†</li>
<li><strong>P2 (ä¸€èˆ¬)</strong>: éæ ¸å¿ƒåŠŸèƒ½ï¼Œ24å°æ—¶å†…å¤„ç†</li>
<li><strong>P3 (ä¿¡æ¯)</strong>: æ€§èƒ½é€€åŒ–ï¼Œå®šæœŸå›é¡¾</li>
</ul>
</li>
<li>
<p><strong>é™çº§ç­–ç•¥</strong>:</p>
<ul>
<li><strong>åˆ†çº§é™çº§</strong>: ä»æœ€ä¸é‡è¦åˆ°æœ€é‡è¦çš„åŠŸèƒ½ä¾æ¬¡é™çº§</li>
<li><strong>è‡ªåŠ¨è§¦å‘</strong>: åŸºäºç³»ç»Ÿè´Ÿè½½å’ŒæœåŠ¡å¥åº·çŠ¶æ€</li>
<li><strong>æ‰‹åŠ¨å¹²é¢„</strong>: æ”¯æŒè¿ç»´äººå‘˜å¼ºåˆ¶é™çº§</li>
<li><strong>æ¢å¤æœºåˆ¶</strong>: è´Ÿè½½é™ä½åè‡ªåŠ¨æ¢å¤</li>
</ul>
</li>
</ol>
<p><strong>é”™è¯¯å¤„ç†çš„å±‚æ¬¡åŒ–:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡å±‚ (Business Logic)                â”‚
â”‚  - å‚æ•°éªŒè¯ã€ä¸šåŠ¡è§„åˆ™                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº”ç”¨å±‚ (Application Layer)             â”‚
â”‚  - ç†”æ–­ã€é™æµã€å¹¶å‘æ§åˆ¶                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸºç¡€è®¾æ–½å±‚ (Infrastructure)            â”‚
â”‚  - è¿æ¥æ± ã€è¶…æ—¶æ§åˆ¶ã€é‡è¯•                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç³»ç»Ÿå±‚ (System)                        â”‚
â”‚  - è¿›ç¨‹ç›‘æ§ã€èµ„æºé™åˆ¶ã€ä¼˜é›…å…³é—­          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre><h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-27">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•å®ç° Python Agent çš„ä¼˜é›…é™çº§ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>åˆ†çº§ç­–ç•¥</strong>: å®šä¹‰æ¸…æ™°çš„é™çº§çº§åˆ«å’Œå¯¹åº”é…ç½®</li>
<li><strong>è‡ªåŠ¨æ£€æµ‹</strong>: åŸºäºç³»ç»Ÿè´Ÿè½½å’ŒæœåŠ¡å¥åº·çŠ¶æ€</li>
<li><strong>æ‰‹åŠ¨è§¦å‘</strong>: æ”¯æŒè¿ç»´å¹²é¢„</li>
<li><strong>æ¢å¤æœºåˆ¶</strong>: è´Ÿè½½é™ä½åè‡ªåŠ¨æ¢å¤</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è®¾è®¡äº†ä¸‰çº§é™çº§ç­–ç•¥ï¼šæ­£å¸¸ã€é™çº§ã€å…³é”®ã€‚é€šè¿‡ç›‘æ§ä¸‹æ¸¸æœåŠ¡å¥åº·çŠ¶æ€å’Œç³»ç»Ÿè´Ÿè½½ï¼Œè‡ªåŠ¨åˆ¤æ–­å½“å‰çº§åˆ«ã€‚æ¯”å¦‚ï¼Œå½“å‘é‡æ•°æ®åº“ä¸å¯ç”¨æ—¶ï¼Œé™çº§åˆ°çº¯å…³é”®è¯æœç´¢ï¼›å½“ LLM æœåŠ¡è¶…æ—¶æ—¶ï¼Œä½¿ç”¨ç¼“å­˜å›å¤ï¼›å½“ç³»ç»Ÿè´Ÿè½½è¶…è¿‡ 80% æ—¶ï¼Œç¦ç”¨éæ ¸å¿ƒå·¥å…·ã€‚é™çº§é…ç½®é€šè¿‡ Redis åŠ¨æ€ä¸‹å‘ï¼Œæ”¯æŒå®æ—¶è°ƒæ•´ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œé™çº§æ˜¯å¯é€†çš„ï¼Œå½“è´Ÿè½½é™ä½åä¼šè‡ªåŠ¨æ¢å¤ã€‚"</p>
</blockquote>
<hr>
<h1 id="å››-flutter-mobile---è·¨å¹³å°ç§»åŠ¨ç«¯">å››ã€Flutter Mobile - è·¨å¹³å°ç§»åŠ¨ç«¯ </h1>
<h2 id="41-websocket-æœåŠ¡-v2-1">4.1 WebSocket æœåŠ¡ v2 </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-32">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>WebSocket æœåŠ¡æ˜¯ç§»åŠ¨ç«¯ä¸åç«¯çš„ <strong>å®æ—¶é€šä¿¡æ¡¥æ¢</strong>ï¼Œé‡‡ç”¨ <strong>å•ä¾‹æ¨¡å¼</strong> å’Œ <strong>å“åº”å¼æµ</strong> è®¾è®¡ï¼š</p>
<ul>
<li><strong>å•ä¾‹æ¨¡å¼</strong>: å…¨å±€å”¯ä¸€è¿æ¥ï¼ŒèŠ‚çœèµ„æº</li>
<li><strong>ç¼“å†²é˜Ÿåˆ—</strong>: æ–­å¼€æ—¶æš‚å­˜æ¶ˆæ¯ï¼Œé‡è¿åè‡ªåŠ¨é‡å‘</li>
<li><strong>å“åº”å¼æµ</strong>: StreamController è½¬æ¢ä¸šåŠ¡äº‹ä»¶æµ</li>
<li><strong>æŒ‡æ•°é€€é¿</strong>: 2^n å»¶è¿Ÿï¼Œæœ€é«˜ 32s</li>
<li><strong>æ˜¾å¼å¿ƒè·³</strong>: åº”ç”¨å±‚ä¿æ´»ï¼Œé˜²æ­¢ NAT æ–­è¿</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-33">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/core/services/websocket_chat_service_v2.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">WebSocketChatServiceV2</span> <span class="token punctuation">{</span>
  <span class="token comment">// ã€å•ä¾‹æ¨¡å¼ã€‘: ç¡®ä¿å…¨å±€å”¯ä¸€è¿æ¥ï¼ŒèŠ‚çœç³»ç»Ÿèµ„æº</span>
  <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">WebSocketChatServiceV2</span> _instance <span class="token operator">=</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">.</span><span class="token function">_internal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword keyword-factory">factory</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> _instance<span class="token punctuation">;</span>

  <span class="token class-name">WebSocketChannel</span><span class="token operator">?</span> _channel<span class="token punctuation">;</span>
  <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatStreamEvent</span><span class="token punctuation">&gt;</span></span><span class="token operator">?</span> _messageStreamController<span class="token punctuation">;</span>
  <span class="token class-name">WsConnectionState</span> _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">;</span>

  <span class="token comment">// ã€æ¶ˆæ¯é˜Ÿåˆ—ã€‘: è¿æ¥æ–­å¼€æ—¶æš‚å­˜æ¶ˆæ¯ï¼Œé‡è¿åè‡ªåŠ¨é‡å‘ï¼Œä¿è¯â€œé›¶ä¸¢å¤±â€</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword keyword-dynamic">dynamic</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> _pendingMessages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// ä¸»æ–¹æ³•ï¼šå‘é€æ¶ˆæ¯å¹¶è¿”å›æµ</span>
  <span class="token class-name">Stream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatStreamEvent</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>required <span class="token class-name">String</span> message<span class="token punctuation">,</span> required <span class="token class-name">String</span> userId<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _messageStreamController <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token class-name">StreamController</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatStreamEvent</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>_connectionState <span class="token operator">==</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_establishConnection</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-final">final</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token string-literal"><span class="token string">'message'</span></span><span class="token punctuation">:</span> message<span class="token punctuation">,</span>
      <span class="token string-literal"><span class="token string">'user_id'</span></span><span class="token punctuation">:</span> userId<span class="token punctuation">,</span>
      <span class="token string-literal"><span class="token string">'timestamp'</span></span><span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toIso8601String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>isConnected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _channel<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
      _pendingMessages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å­˜å…¥ç¼“å†²åŒº</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-return">return</span> _messageStreamController<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_establishConnection</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _channel <span class="token operator">=</span> <span class="token class-name">WebSocketChannel</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">ApiConstants</span><span class="token punctuation">.</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>connecting<span class="token punctuation">;</span>

    _channel<span class="token operator">!</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onDone<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleDisconnect</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ¡æ‰‹è®¤è¯</span>
    _channel<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string-literal"><span class="token string">'type'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'auth'</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">'token'</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'Bearer ...'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>connected<span class="token punctuation">;</span>
    
    <span class="token comment">// é‡è¿æˆåŠŸåï¼Œæ¸…ç©ºç¼“å†²åŒº</span>
    <span class="token function">_flushPendingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ã€æŒ‡æ•°é€€é¿é‡è¿ã€‘: é¿å…é«˜é¢‘è¯·æ±‚æ‹–å®ç§»åŠ¨ç«¯ç”µé‡ä¸æœåŠ¡å™¨è´Ÿè½½</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">_handleDisconnect</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _connectionState <span class="token operator">=</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>disconnected<span class="token punctuation">;</span>
    int retryCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token class-name">Timer</span><span class="token punctuation">.</span><span class="token function">periodic</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">(</span>seconds<span class="token punctuation">:</span> math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> retryCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>isConnected <span class="token operator">||</span> retryCount <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timer<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      
      <span class="token function">_establishConnection</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      retryCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleMessage</span><span class="token punctuation">(</span><span class="token keyword keyword-dynamic">dynamic</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>_messageStreamController <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-final">final</span> event <span class="token operator">=</span> <span class="token class-name">ChatStreamEvent</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _messageStreamController<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _messageStreamController<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">addError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_flushPendingMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isConnected <span class="token operator">||</span> _pendingMessages<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-var">var</span> message <span class="token keyword keyword-in">in</span> _pendingMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _channel<span class="token operator">!</span><span class="token punctuation">.</span>sink<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _pendingMessages<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  bool <span class="token keyword keyword-get">get</span> isConnected <span class="token operator">=</span><span class="token operator">&gt;</span> _connectionState <span class="token operator">==</span> <span class="token class-name">WsConnectionState</span><span class="token punctuation">.</span>connected<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-28">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å•ä¾‹æ¨¡å¼çš„å¿…è¦æ€§:</strong></p>
<ul>
<li><strong>èµ„æºé™åˆ¶</strong>: ç§»åŠ¨ç«¯å»ºç«‹å¤šä¸ª WebSocket è¿æ¥ä¼šæ¶ˆè€—å¤§é‡ç”µé‡å’Œå†…å­˜</li>
<li><strong>çŠ¶æ€ä¸€è‡´æ€§</strong>: å…¨å±€å”¯ä¸€è¿æ¥ä¿è¯æ¶ˆæ¯é¡ºåºå’ŒçŠ¶æ€åŒæ­¥</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>: ä¾¿äºåœ¨ App å¯åŠ¨/å…³é—­æ—¶ç»Ÿä¸€ç®¡ç†è¿æ¥</li>
</ul>
<p><strong>ç¼“å†²é˜Ÿåˆ—çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>å¼±ç½‘ä¼˜åŒ–</strong>: ç§»åŠ¨ç«¯ç½‘ç»œä¸ç¨³å®šï¼Œç¼“å†²åŒºæš‚å­˜æ¶ˆæ¯é¿å…ä¸¢å¤±</li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: ç”¨æˆ·æ„Ÿè§‰æ¶ˆæ¯å·²å‘é€ï¼Œå®é™…åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…é‡è¿</li>
<li><strong>é›¶ä¸¢å¤±ä¿è¯</strong>: é‡è¿æˆåŠŸåè‡ªåŠ¨é‡å‘ï¼Œä¿è¯æ¶ˆæ¯å¿…è¾¾</li>
</ul>
<p><strong>æŒ‡æ•°é€€é¿ç®—æ³•:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>é‡è¯•æ¬¡æ•°: 0  1  2  3  4  5  6
å»¶è¿Ÿæ—¶é—´: 1s 2s 4s 8s 16s 32s 32s(ä¸Šé™)
</code></pre><ul>
<li><strong>ä¿æŠ¤æœºåˆ¶</strong>: é¿å…åœ¨æœåŠ¡å™¨å®•æœºæ—¶äº§ç”Ÿå¤§é‡é‡è¯•è¯·æ±‚</li>
<li><strong>ç”µé‡ä¼˜åŒ–</strong>: å‡å°‘é¢‘ç¹çš„ç½‘ç»œè¯·æ±‚ï¼Œå»¶é•¿ç”µæ± ç»­èˆª</li>
<li><strong>æœåŠ¡å™¨å‹å¥½</strong>: ç»™ä¸‹æ¸¸æœåŠ¡æ¢å¤æ—¶é—´ï¼Œé¿å…é›ªå´©</li>
</ul>
<p><strong>å¿ƒè·³æœºåˆ¶çš„å¿…è¦æ€§:</strong></p>
<ul>
<li><strong>NAT ä¿æ´»</strong>: è¿è¥å•† NAT ç½‘å…³ä¼šæ¸…ç†é•¿æ—¶é—´æ— æ•°æ®çš„è¿æ¥</li>
<li><strong>çŠ¶æ€æ£€æµ‹</strong>: åŠæ—¶å‘ç°æ–­è¿ï¼Œé¿å…å‘é€æ¶ˆæ¯åˆ°æ— æ•ˆè¿æ¥</li>
<li><strong>åº”ç”¨å±‚ä¿æ´»</strong>: TCP KeepAlive ä¸å¤Ÿå¯é ï¼Œéœ€è¦åº”ç”¨å±‚å¿ƒè·³</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-28">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ç§»åŠ¨ç«¯ WebSocket è¿æ¥å¦‚ä½•å¤„ç†ç½‘ç»œåˆ‡æ¢ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>è‡ªåŠ¨é‡è¿</strong>: Wi-Fi åˆ‡æ¢åˆ° 4G æ—¶æ£€æµ‹æ–­è¿å¹¶é‡è¿</li>
<li><strong>çŠ¶æ€ç›‘å¬</strong>: ç›‘å¬ AppLifecycleState å’Œç½‘ç»œçŠ¶æ€å˜åŒ–</li>
<li><strong>ç¼“å†²é‡å‘</strong>: åˆ‡æ¢æœŸé—´çš„æ¶ˆæ¯åœ¨é‡è¿åè‡ªåŠ¨å‘é€</li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: æ˜¾ç¤ºè¿æ¥çŠ¶æ€ï¼Œç»™ç”¨æˆ·æ˜ç¡®åé¦ˆ</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é€šè¿‡ä¸‰é‡æœºåˆ¶å¤„ç†ç½‘ç»œåˆ‡æ¢ï¼šé¦–å…ˆï¼Œç›‘å¬ Flutter çš„ AppLifecycleStateï¼Œå½“ App ä»åå°åˆ‡å›å‰å°æ—¶ä¸»åŠ¨æ£€æŸ¥è¿æ¥çŠ¶æ€ï¼›å…¶æ¬¡ï¼Œä½¿ç”¨ connectivity_plus æ’ä»¶ç›‘å¬ç½‘ç»œå˜åŒ–ï¼ŒWi-Fi/4G åˆ‡æ¢æ—¶è§¦å‘é‡è¿ï¼›ç¬¬ä¸‰ï¼Œç¼“å†²é˜Ÿåˆ—ä¿è¯åˆ‡æ¢æœŸé—´çš„æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨ UI ä¸Šæ˜¾ç¤ºå®æ—¶è¿æ¥çŠ¶æ€ï¼ˆå·²è¿æ¥/è¿æ¥ä¸­/å·²æ–­å¼€ï¼‰ï¼Œè®©ç”¨æˆ·æ„ŸçŸ¥å½“å‰çŠ¶æ€ã€‚"</p>
</blockquote>
<hr>
<h2 id="42-riverpod-çŠ¶æ€ç®¡ç†-1">4.2 Riverpod çŠ¶æ€ç®¡ç† </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-33">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Riverpod æ˜¯ Flutter çš„ <strong>å£°æ˜å¼çŠ¶æ€ç®¡ç†æ¡†æ¶</strong>ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ <strong>UI = f(State)</strong>ï¼š</p>
<ul>
<li><strong>å£°æ˜å¼ UI</strong>: çŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ UI é‡å»º</li>
<li><strong>ä¸å¯å˜æ•°æ®</strong>: copyWith åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¾¿äºè¿½è¸ª</li>
<li><strong>å•å‘æ•°æ®æµ</strong>: UI â†’ Action â†’ State â†’ UI</li>
<li><strong>Provider æ¶æ„</strong>: ä¾èµ–æ³¨å…¥å’ŒçŠ¶æ€éš”ç¦»</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-34">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/presentation/providers/chat_provider.dart</span>

<span class="token comment">// WebSocket æœåŠ¡ Provider</span>
<span class="token keyword keyword-final">final</span> webSocketServiceProvider <span class="token operator">=</span> <span class="token class-name">Provider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// èŠå¤©çŠ¶æ€ Notifier</span>
<span class="token keyword keyword-final">final</span> chatProvider <span class="token operator">=</span> <span class="token class-name">StateNotifierProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatNotifier</span><span class="token punctuation">,</span> <span class="token class-name">ChatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token class-name">ChatNotifier</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>webSocketServiceProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// èŠå¤©çŠ¶æ€</span>
<span class="token metadata function">@freezed</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ChatState</span> <span class="token keyword keyword-with">with</span> _$<span class="token class-name">ChatState</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-const">const</span> <span class="token keyword keyword-factory">factory</span> <span class="token class-name">ChatState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> bool isLoading<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span> <span class="token class-name">String</span> response<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">)</span> <span class="token class-name">String</span> error<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token class-name">AgentState</span><span class="token operator">?</span> agentStatus<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token class-name">String</span><span class="token operator">?</span> toolCalling<span class="token punctuation">,</span>
    <span class="token metadata function">@Default</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> bool isTyping<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span> _ChatState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// èŠå¤© Notifier</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ChatNotifier</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">StateNotifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatState</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">WebSocketChatServiceV2</span> _wsService<span class="token punctuation">;</span>
  <span class="token class-name">StreamSubscription</span><span class="token operator">?</span> _subscription<span class="token punctuation">;</span>

  <span class="token class-name">ChatNotifier</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>_wsService<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword keyword-super">super</span><span class="token punctuation">(</span><span class="token class-name">ChatState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token keyword keyword-void">void</span><span class="token punctuation">&gt;</span></span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword keyword-async">async</span> <span class="token punctuation">{</span>
    <span class="token comment">// ========== ç¬¬1æ­¥ï¼šæœ¬åœ°çŠ¶æ€å¿«é€Ÿæ›´æ–° ==========</span>
    <span class="token comment">// æ€æƒ³ï¼šå“åº”å¼ç¼–ç¨‹ã€‚ç«‹å³æ›´æ–° UIï¼Œè®©ç”¨æˆ·æ„Ÿè§‰åˆ°æ“ä½œçš„å®æ—¶æ€§ï¼ˆä¹è§‚ UI æ›´æ–°ï¼‰ã€‚</span>
    state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
      messages<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
        <span class="token class-name">ChatMessage</span><span class="token punctuation">(</span>role<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'user'</span></span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> message<span class="token punctuation">,</span> timestamp<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      isLoading<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      error<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">,</span>
      response<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== ç¬¬2æ­¥ï¼šé€šè¿‡ WebSocket å‘é€è¯·æ±‚ ==========</span>
    <span class="token comment">// æ•°æ®æµå‘ï¼šUI è¾“å…¥ -&gt; ChatNotifier -&gt; WebSocketService -&gt; Server</span>
    <span class="token keyword keyword-final">final</span> stream <span class="token operator">=</span> _wsService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
      message<span class="token punctuation">:</span> message<span class="token punctuation">,</span>
      userId<span class="token punctuation">:</span> <span class="token function">_getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ========== ç¬¬3æ­¥ï¼šæµè®¢é˜…ä¸äº‹ä»¶å¤„ç† ==========</span>
    <span class="token comment">// æ€æƒ³ï¼šæµå¼å¤„ç†ã€‚AI çš„å›å¤æ˜¯é€å­—åå‡ºçš„ï¼Œé€šè¿‡ Stream ç›‘å¬å¯ä»¥å®ç°å®æ—¶æ‰“å­—æœºæ•ˆæœã€‚</span>
    <span class="token keyword keyword-await">await</span> _subscription<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _subscription <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleStreamEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span>
      onError<span class="token punctuation">:</span> _handleError<span class="token punctuation">,</span>
      onDone<span class="token punctuation">:</span> _handleDone<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleStreamEvent</span><span class="token punctuation">(</span><span class="token class-name">ChatStreamEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ========== ç¬¬4æ­¥ï¼šå¤šç±»å‹äº‹ä»¶åˆ†å‘ ==========</span>
    event<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>
      <span class="token comment">// æ–‡æœ¬äº‹ä»¶ï¼šç´¯åŠ  AI å›å¤å†…å®¹</span>
      text<span class="token punctuation">:</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
          response<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response <span class="token operator">+</span> content<span class="token punctuation">,</span>
          isTyping<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// çŠ¶æ€äº‹ä»¶ï¼šæ˜¾ç¤º AI å½“å‰æ€è€ƒé˜¶æ®µï¼ˆå¦‚ï¼šæœç´¢ä¸­ã€æ‰§è¡Œå·¥å…·ï¼‰</span>
      statusUpdate<span class="token punctuation">:</span> <span class="token punctuation">(</span>agentState<span class="token punctuation">,</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>agentStatus<span class="token punctuation">:</span> agentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// é”™è¯¯äº‹ä»¶ï¼šå¤„ç†æ–­ç½‘ã€åç«¯æŠ¥é”™ç­‰å¼‚å¸¸</span>
      error<span class="token punctuation">:</span> <span class="token punctuation">(</span>code<span class="token punctuation">,</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>error<span class="token punctuation">:</span> message<span class="token punctuation">,</span> isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// å®Œæˆäº‹ä»¶ï¼šå°†å®Œæ•´å›å¤å­˜å…¥æ¶ˆæ¯å†å²</span>
      done<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_handleDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      
      <span class="token comment">// å…¶ä»–äº‹ä»¶ (toolStart, toolResult...)</span>
      toolStart<span class="token punctuation">:</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>toolCalling<span class="token punctuation">:</span> name<span class="token punctuation">)</span><span class="token punctuation">,</span>
      toolResult<span class="token punctuation">:</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
      messages<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
        <span class="token class-name">ChatMessage</span><span class="token punctuation">(</span>
          role<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'assistant'</span></span><span class="token punctuation">,</span>
          content<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response<span class="token punctuation">,</span>
          timestamp<span class="token punctuation">:</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isTyping<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      response<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">''</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleError</span><span class="token punctuation">(</span><span class="token keyword keyword-dynamic">dynamic</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
      error<span class="token punctuation">:</span> error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      isTyping<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-29">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å£°æ˜å¼ UI vs å‘½ä»¤å¼ UI:</strong></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>å£°æ˜å¼ (Riverpod)</th>
<th>å‘½ä»¤å¼ (setState)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ä»£ç é‡</strong></td>
<td>å°‘ï¼Œé€»è¾‘æ¸…æ™°</td>
<td>å¤šï¼Œå®¹æ˜“æ··ä¹±</td>
</tr>
<tr>
<td><strong>å¯ç»´æŠ¤æ€§</strong></td>
<td>é«˜ï¼ŒçŠ¶æ€é›†ä¸­ç®¡ç†</td>
<td>ä½ï¼ŒçŠ¶æ€åˆ†æ•£</td>
</tr>
<tr>
<td><strong>æ€§èƒ½</strong></td>
<td>è‡ªåŠ¨ä¼˜åŒ–ï¼Œå±€éƒ¨åˆ·æ–°</td>
<td>éœ€è¦æ‰‹åŠ¨ä¼˜åŒ–</td>
</tr>
<tr>
<td><strong>è°ƒè¯•</strong></td>
<td>å®¹æ˜“è¿½è¸ªçŠ¶æ€å˜åŒ–</td>
<td>å›°éš¾ï¼ŒçŠ¶æ€åˆ†æ•£</td>
</tr>
</tbody>
</table>
<p><strong>ä¸å¯å˜æ•°æ®çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>å¯é¢„æµ‹æ€§</strong>: æ¯æ¬¡çŠ¶æ€å˜åŒ–éƒ½åˆ›å»ºæ–°å¯¹è±¡ï¼Œä¾¿äºè¿½è¸ª</li>
<li><strong>æ—¶é—´æ—…è¡Œ</strong>: å¯ä»¥è®°å½•çŠ¶æ€å†å²ï¼Œå®ç°æ’¤é”€/é‡åš</li>
<li><strong>å¹¶å‘å®‰å…¨</strong>: ä¸å¯å˜å¯¹è±¡å¤©ç„¶çº¿ç¨‹å®‰å…¨</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: Flutter çš„ diff ç®—æ³•ä¾èµ–ä¸å¯å˜æ€§</li>
</ul>
<p><strong>å•å‘æ•°æ®æµçš„åŸç†:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ç”¨æˆ·æ“ä½œ (UI)
    â†“
è§¦å‘ Action (Notifier)
    â†“
ä¿®æ”¹ State (ä¸å¯å˜)
    â†“
UI è‡ªåŠ¨é‡å»º (f(state))
</code></pre><ul>
<li><strong>å¯è¿½è¸ª</strong>: ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½æœ‰æ˜ç¡®çš„æ¥æº</li>
<li><strong>å¯æµ‹è¯•</strong>: Notifier å¯ä»¥ç‹¬ç«‹å•å…ƒæµ‹è¯•</li>
<li><strong>å¯ç»´æŠ¤</strong>: é¿å…äº†å¤æ‚çš„åŒå‘ç»‘å®š</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-29">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: Riverpod å’Œ Provider æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç¼–è¯‘æ—¶æ£€æŸ¥</strong>: Riverpod åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥ Provider ä¾èµ–</li>
<li><strong>è§£è€¦</strong>: Riverpod ä¸ä¾èµ– BuildContext</li>
<li><strong>æ€§èƒ½</strong>: æ”¯æŒ select ç²¾ç»†ç›‘å¬ï¼Œå‡å°‘é‡å»º</li>
<li><strong>æµ‹è¯•</strong>: æ›´å®¹æ˜“è¿›è¡Œå•å…ƒæµ‹è¯•</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"Riverpod æ˜¯ Provider çš„ä¸‹ä¸€ä»£æ¼”è¿›ã€‚æœ€å¤§çš„åŒºåˆ«æ˜¯ Riverpod ä¸ä¾èµ– BuildContextï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼Œè¿™ä½¿å¾—ä»£ç æ›´è§£è€¦ã€‚å…¶æ¬¡ï¼ŒRiverpod æä¾›ç¼–è¯‘æ—¶å®‰å…¨ï¼Œå¦‚æœ Provider ä¾èµ–é”™è¯¯ä¼šåœ¨ç¼–è¯‘æ—¶æŠ¥é”™ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶ã€‚ç¬¬ä¸‰ï¼Œé€šè¿‡ select æ–¹æ³•å¯ä»¥åªç›‘å¬çŠ¶æ€çš„ä¸€éƒ¨åˆ†ï¼Œé¿å…ä¸å¿…è¦çš„ UI é‡å»ºã€‚æœ€åï¼ŒRiverpod çš„ Provider å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼Œä¸éœ€è¦ Widget æ ‘ã€‚"</p>
</blockquote>
<hr>
<h2 id="43-ui-ç»„ä»¶ç³»ç»Ÿ-1">4.3 UI ç»„ä»¶ç³»ç»Ÿ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-34">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle çš„ UI ç»„ä»¶ç³»ç»Ÿé‡‡ç”¨ <strong>å£°æ˜å¼</strong> å’Œ <strong>æ‡’åŠ è½½</strong> è®¾è®¡ï¼š</p>
<ul>
<li><strong>å£°æ˜å¼ UI</strong>: æ•°æ®é©±åŠ¨ï¼Œè‡ªåŠ¨åˆ·æ–°</li>
<li><strong>æ‡’åŠ è½½</strong>: ListView.builder å»¶è¿Ÿæ¸²æŸ“</li>
<li><strong>çŠ¶æ€æŒ‡ç¤ºå™¨</strong>: THINKING, GENERATING, EXECUTING_TOOL ç­‰çŠ¶æ€å¯è§†åŒ–</li>
<li><strong>æµå¼è¾“å‡º</strong>: å®æ—¶æ‰“å­—æœºæ•ˆæœ</li>
<li><strong>é”™è¯¯æç¤º</strong>: SnackBar å’Œå‹å¥½é”™è¯¯ä¿¡æ¯</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-35">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/presentation/screens/chat_screen.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">ChatScreen</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">ConsumerWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">,</span> <span class="token class-name">WidgetRef</span> ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. å£°æ˜å¼ç›‘å¬</span>
    <span class="token comment">// æ€æƒ³ï¼šæ•°æ®é©±åŠ¨ã€‚å½“ chatProvider çš„ state å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¿™ä¸ª build å‡½æ•°ä¼šè‡ªåŠ¨é‡æ–°è¿è¡Œã€‚</span>
    <span class="token keyword keyword-final">final</span> chatState <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>chatProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-return">return</span> <span class="token class-name">Scaffold</span><span class="token punctuation">(</span>
      body<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// 2. æ¶ˆæ¯å±•ç¤º (ListView.builder)</span>
          <span class="token comment">// æ€æƒ³ï¼šæŒ‰éœ€åŠ è½½ã€‚å³ä½¿æœ‰å‡ åƒæ¡æ¶ˆæ¯ï¼Œä¹Ÿåªæ¸²æŸ“å½“å‰å±å¹•æ˜¾ç¤ºçš„å‡ ä¸ª Itemã€‚</span>
          <span class="token class-name">Expanded</span><span class="token punctuation">(</span>
            child<span class="token punctuation">:</span> <span class="token class-name">ListView</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>
              itemCount<span class="token punctuation">:</span> chatState<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
              itemBuilder<span class="token punctuation">:</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">MessageBubble</span><span class="token punctuation">(</span>
                message<span class="token punctuation">:</span> chatState<span class="token punctuation">.</span>messages<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">,</span>
          
          <span class="token comment">// 3. å®æ—¶å“åº”å±•ç¤º</span>
          <span class="token comment">// æ€æƒ³ï¼šå±€éƒ¨åˆ·æ–°ã€‚</span>
          <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>chatState<span class="token punctuation">.</span>isTyping<span class="token punctuation">)</span> <span class="token function">_buildStatusPanel</span><span class="token punctuation">(</span>chatState<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">_buildInputArea</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> ref<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>chatProvider<span class="token punctuation">.</span>notifier<span class="token punctuation">)</span><span class="token punctuation">,</span> chatState<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Widget</span> <span class="token function">_buildStatusPanel</span><span class="token punctuation">(</span><span class="token class-name">ChatState</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>
      padding<span class="token punctuation">:</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">.</span>shade50<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Row</span><span class="token punctuation">(</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
          <span class="token class-name">CircularProgressIndicator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">SizedBox</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token function">_getStatusText</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>agentStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">String</span> <span class="token function">_getStatusText</span><span class="token punctuation">(</span><span class="token class-name">AgentState</span><span class="token operator">?</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>thinking<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'AI æ­£åœ¨æ€è€ƒ...'</span></span><span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>searching<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'æœç´¢çŸ¥è¯†åº“...'</span></span><span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token class-name">AgentState</span><span class="token punctuation">.</span>executingTool<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'æ‰§è¡Œå·¥å…·...'</span></span><span class="token punctuation">;</span>
      <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'ç”Ÿæˆå›å¤ä¸­...'</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ï¼š</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">MessageBubble</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">ChatMessage</span> message<span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> isUser <span class="token operator">=</span> message<span class="token punctuation">.</span>role <span class="token operator">==</span> <span class="token string-literal"><span class="token string">'user'</span></span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-return">return</span> <span class="token class-name">Align</span><span class="token punctuation">(</span>
      alignment<span class="token punctuation">:</span> isUser <span class="token operator">?</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>centerRight <span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>centerLeft<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">Container</span><span class="token punctuation">(</span>
        margin<span class="token punctuation">:</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">symmetric</span><span class="token punctuation">(</span>vertical<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> horizontal<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        padding<span class="token punctuation">:</span> <span class="token class-name">EdgeInsets</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        decoration<span class="token punctuation">:</span> <span class="token class-name">BoxDecoration</span><span class="token punctuation">(</span>
          color<span class="token punctuation">:</span> isUser <span class="token operator">?</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">.</span>shade100 <span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">.</span>shade200<span class="token punctuation">,</span>
          borderRadius<span class="token punctuation">:</span> <span class="token class-name">BorderRadius</span><span class="token punctuation">.</span><span class="token function">circular</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        child<span class="token punctuation">:</span> <span class="token class-name">Column</span><span class="token punctuation">(</span>
          crossAxisAlignment<span class="token punctuation">:</span> <span class="token class-name">CrossAxisAlignment</span><span class="token punctuation">.</span>start<span class="token punctuation">,</span>
          children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token class-name">Text</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>timestamp <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span>
              <span class="token class-name">Text</span><span class="token punctuation">(</span>
                <span class="token class-name">DateFormat</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">'HH:mm'</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>timestamp<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>fontSize<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-30">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å£°æ˜å¼ UI çš„æ ¸å¿ƒ:</strong></p>
<ul>
<li><strong>UI = f(state)</strong>: æè¿°å½“å‰çŠ¶æ€ä¸‹çš„ UIï¼Œä¸å…³å¿ƒå¦‚ä½•å˜åŒ–</li>
<li><strong>è‡ªåŠ¨å“åº”</strong>: çŠ¶æ€å˜åŒ–è§¦å‘ build é‡å»º</li>
<li><strong>å±€éƒ¨æ›´æ–°</strong>: Flutter çš„ Virtual DOM åªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†</li>
</ul>
<p><strong>æ‡’åŠ è½½çš„å¿…è¦æ€§:</strong></p>
<ul>
<li><strong>æ€§èƒ½</strong>: é¿å…ä¸€æ¬¡æ€§æ¸²æŸ“å¤§é‡æ¶ˆæ¯å¯¼è‡´å¡é¡¿</li>
<li><strong>å†…å­˜</strong>: åªä¿ç•™å½“å‰å¯è§çš„ Widget åœ¨å†…å­˜ä¸­</li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: æ»šåŠ¨æµç•…ï¼Œæ— æ˜æ˜¾å»¶è¿Ÿ</li>
</ul>
<p><strong>çŠ¶æ€æŒ‡ç¤ºå™¨çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>å³æ—¶åé¦ˆ</strong>: è®©ç”¨æˆ·çŸ¥é“ AI æ­£åœ¨å·¥ä½œï¼Œå‡å°‘ç­‰å¾…ç„¦è™‘</li>
<li><strong>é€æ˜åº¦</strong>: å±•ç¤º AI çš„æ€è€ƒè¿‡ç¨‹ï¼Œå¢åŠ ä¿¡ä»»æ„Ÿ</li>
<li><strong>å¯å–æ¶ˆ</strong>: æä¾›å–æ¶ˆæŒ‰é’®ï¼Œç”¨æˆ·å¯ä¸­æ–­é•¿æ—¶é—´æ“ä½œ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-30">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•å¤„ç†é•¿åˆ—è¡¨æ¶ˆæ¯çš„æ€§èƒ½é—®é¢˜ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ListView.builder</strong>: æ‡’åŠ è½½ï¼Œåªæ¸²æŸ“å¯è§é¡¹</li>
<li><strong>const æ„é€ å‡½æ•°</strong>: å‡å°‘ä¸å¿…è¦çš„é‡å»º</li>
<li><strong>select ç›‘å¬</strong>: åªç›‘å¬éœ€è¦çš„çŠ¶æ€éƒ¨åˆ†</li>
<li><strong>æ¶ˆæ¯åˆ†é¡µ</strong>: åç«¯åˆ†é¡µåŠ è½½ï¼Œå‰ç«¯è™šæ‹Ÿåˆ—è¡¨</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬ä½¿ç”¨ ListView.builder å®ç°æ‡’åŠ è½½ï¼Œå®ƒåªæ¸²æŸ“å½“å‰å±å¹•å¯è§çš„æ¶ˆæ¯é¡¹ã€‚åŒæ—¶ï¼Œå¯¹ MessageBubble ä½¿ç”¨ const æ„é€ å‡½æ•°ï¼Œé¿å…ä¸å¿…è¦çš„é‡å»ºã€‚åœ¨ Riverpod ä¸­ï¼Œé€šè¿‡ select æ–¹æ³•åªç›‘å¬ messages åˆ—è¡¨ï¼Œè€Œä¸æ˜¯æ•´ä¸ª ChatStateã€‚å¯¹äºè¶…é•¿å¯¹è¯ï¼Œæˆ‘ä»¬å®ç°äº†åç«¯åˆ†é¡µï¼Œå‰ç«¯åªä¿ç•™æœ€è¿‘ 50 æ¡æ¶ˆæ¯ï¼Œæ›´æ—©çš„å†å²é€šè¿‡ summary è·å–ã€‚"</p>
</blockquote>
<hr>
<h2 id="44-çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–-1">4.4 çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ– </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-35">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>çŸ¥è¯†æ˜Ÿå›¾å¯è§†åŒ–æ˜¯ Sparkle çš„æ ¸å¿ƒç‰¹è‰²ï¼Œä½¿ç”¨ <strong>Canvas API</strong> å’Œ <strong>GLSL ç€è‰²å™¨</strong> å®ç°é«˜æ€§èƒ½å›¾å½¢æ¸²æŸ“ï¼š</p>
<ul>
<li><strong>Canvas API</strong>: åº•å±‚ Skia ç»˜å›¾å¼•æ“ï¼Œé«˜æ€§èƒ½ 2D æ¸²æŸ“</li>
<li><strong>GLSL ç€è‰²å™¨</strong>: GPU åŠ é€Ÿï¼Œå®ç°ç«ç„°ã€å‘å…‰ã€ç²’å­æ•ˆæœ</li>
<li><strong>CustomPainter</strong>: é«˜æ€§èƒ½å›¾å½¢æ¸²æŸ“ï¼Œæ”¯æŒå¤æ‚åŠ¨ç”»</li>
<li><strong>æ•°æ®å¯è§†åŒ–</strong>: æŒæ¡åº¦ç¯ã€æ˜ŸåŸŸåˆ†ç±»ã€å…³ç³»è¿çº¿</li>
<li><strong>äº¤äº’è®¾è®¡</strong>: ç¼©æ”¾ã€æ‹–æ‹½ã€ç‚¹å‡»è¯¦æƒ…</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-36">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/presentation/widgets/galaxy/star_map_painter.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">StarMapPainter</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">CustomPainter</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KnowledgeNode</span><span class="token punctuation">&gt;</span></span> nodes<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> double<span class="token punctuation">&gt;</span></span> masteryMap<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> double zoom<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">Offset</span> offset<span class="token punctuation">;</span>
  <span class="token keyword keyword-final">final</span> <span class="token class-name">VoidCallback</span><span class="token operator">?</span> onNodeTap<span class="token punctuation">;</span>

  <span class="token class-name">StarMapPainter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>nodes<span class="token punctuation">,</span>
    required <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>masteryMap<span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>zoom <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>offset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">,</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>onNodeTap<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token metadata function">@override</span>
  <span class="token keyword keyword-void">void</span> <span class="token function">paint</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Size</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. ç»˜åˆ¶èƒŒæ™¯ï¼ˆæ·±ç©ºæ¸å˜ï¼‰</span>
    <span class="token function">_drawBackground</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2. ç»˜åˆ¶æ˜Ÿç³»è¿çº¿ï¼ˆçŸ¥è¯†å›¾è°±å…³ç³»ï¼‰</span>
    <span class="token function">_drawConnections</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. ç»˜åˆ¶èŠ‚ç‚¹ï¼ˆçŸ¥è¯†ç‚¹ï¼‰</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> node <span class="token keyword keyword-in">in</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_drawNode</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. ç»˜åˆ¶æŒæ¡åº¦ç¯</span>
    <span class="token function">_drawMasteryRings</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_drawBackground</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Size</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> gradient <span class="token operator">=</span> <span class="token class-name">RadialGradient</span><span class="token punctuation">(</span>
      center<span class="token punctuation">:</span> <span class="token class-name">Alignment</span><span class="token punctuation">.</span>center<span class="token punctuation">,</span>
      radius<span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
      colors<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0xFF0A0E27</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// æ·±ç©ºè“</span>
        <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0xFF1A1E3F</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Color</span><span class="token punctuation">(</span><span class="token number">0xFF2A2E5F</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span>shader <span class="token operator">=</span> gradient<span class="token punctuation">.</span><span class="token function">createShader</span><span class="token punctuation">(</span>
      <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromLTWH</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawRect</span><span class="token punctuation">(</span><span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromLTWH</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_drawConnections</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">withOpacity</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">1.0</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke<span class="token punctuation">;</span>

    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> node <span class="token keyword keyword-in">in</span> nodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span><span class="token keyword keyword-final">final</span> relation <span class="token keyword keyword-in">in</span> node<span class="token punctuation">.</span>relations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> target <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">firstWhere</span><span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> n<span class="token punctuation">.</span>id <span class="token operator">==</span> relation<span class="token punctuation">.</span>targetId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword keyword-final">final</span> start <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>x <span class="token operator">*</span> zoom<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span>
          <span class="token punctuation">(</span>node<span class="token punctuation">.</span>y <span class="token operator">*</span> zoom<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">.</span>dy<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword keyword-final">final</span> end <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span>target<span class="token punctuation">.</span>x <span class="token operator">*</span> zoom<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span>
          <span class="token punctuation">(</span>target<span class="token punctuation">.</span>y <span class="token operator">*</span> zoom<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">.</span>dy<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ ¹æ®å…³ç³»ç±»å‹è®¾ç½®ä¸åŒé¢œè‰²</span>
        paint<span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token function">_getRelationColor</span><span class="token punctuation">(</span>relation<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withOpacity</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">drawLine</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_drawNode</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">KnowledgeNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> mastery <span class="token operator">=</span> masteryMap<span class="token punctuation">[</span>node<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> position <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">.</span>x <span class="token operator">*</span> zoom<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">.</span>dx<span class="token punctuation">,</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">.</span>y <span class="token operator">*</span> zoom<span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">.</span>dy<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¤–å‘å…‰æ•ˆæœ</span>
    <span class="token keyword keyword-final">final</span> glowPaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token function">_getNodeColor</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>category<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withOpacity</span><span class="token punctuation">(</span><span class="token number">0.3</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>maskFilter <span class="token operator">=</span> <span class="token class-name">MaskFilter</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span><span class="token class-name">BlurStyle</span><span class="token punctuation">.</span>normal<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> zoom<span class="token punctuation">)</span><span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>radius <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> zoom<span class="token punctuation">,</span> glowPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// èŠ‚ç‚¹ä¸»ä½“</span>
    <span class="token keyword keyword-final">final</span> nodePaint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token function">_getNodeColor</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>category<span class="token punctuation">)</span><span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawCircle</span><span class="token punctuation">(</span>position<span class="token punctuation">,</span> node<span class="token punctuation">.</span>radius <span class="token operator">*</span> zoom<span class="token punctuation">,</span> nodePaint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æŒæ¡åº¦ç¯ï¼ˆåªæ˜¾ç¤ºå·²å­¦ä¹ çš„èŠ‚ç‚¹ï¼‰</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>mastery <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_drawMasteryArc</span><span class="token punctuation">(</span>canvas<span class="token punctuation">,</span> position<span class="token punctuation">,</span> node<span class="token punctuation">.</span>radius <span class="token operator">*</span> zoom<span class="token punctuation">,</span> mastery<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// èŠ‚ç‚¹åç§°</span>
    <span class="token keyword keyword-final">final</span> textPainter <span class="token operator">=</span> <span class="token class-name">TextPainter</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> <span class="token class-name">TextSpan</span><span class="token punctuation">(</span>
        text<span class="token punctuation">:</span> node<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        style<span class="token punctuation">:</span> <span class="token class-name">TextStyle</span><span class="token punctuation">(</span>
          color<span class="token punctuation">:</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>white<span class="token punctuation">,</span>
          fontSize<span class="token punctuation">:</span> <span class="token number">10</span> <span class="token operator">*</span> zoom<span class="token punctuation">,</span>
          fontWeight<span class="token punctuation">:</span> <span class="token class-name">FontWeight</span><span class="token punctuation">.</span>bold<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      textDirection<span class="token punctuation">:</span> <span class="token class-name">TextDirection</span><span class="token punctuation">.</span>ltr<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textPainter<span class="token punctuation">.</span><span class="token function">paint</span><span class="token punctuation">(</span>
      canvas<span class="token punctuation">,</span>
      position<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token operator">-</span>textPainter<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span>radius <span class="token operator">*</span> zoom <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_drawMasteryArc</span><span class="token punctuation">(</span><span class="token class-name">Canvas</span> canvas<span class="token punctuation">,</span> <span class="token class-name">Offset</span> center<span class="token punctuation">,</span> double radius<span class="token punctuation">,</span> double mastery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> paint <span class="token operator">=</span> <span class="token class-name">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>color <span class="token operator">=</span> <span class="token function">_getMasteryColor</span><span class="token punctuation">(</span>mastery<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> zoom
      <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> <span class="token class-name">PaintingStyle</span><span class="token punctuation">.</span>stroke
      <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeCap <span class="token operator">=</span> <span class="token class-name">StrokeCap</span><span class="token punctuation">.</span>round<span class="token punctuation">;</span>

    <span class="token keyword keyword-final">final</span> sweepAngle <span class="token operator">=</span> <span class="token punctuation">(</span>mastery <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> pi<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> rect <span class="token operator">=</span> <span class="token class-name">Rect</span><span class="token punctuation">.</span><span class="token function">fromCircle</span><span class="token punctuation">(</span>center<span class="token punctuation">:</span> center<span class="token punctuation">,</span> radius<span class="token punctuation">:</span> radius <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span><span class="token function">drawArc</span><span class="token punctuation">(</span>rect<span class="token punctuation">,</span> <span class="token operator">-</span>pi <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> sweepAngle<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Color</span> <span class="token function">_getNodeColor</span><span class="token punctuation">(</span><span class="token class-name">String</span> category<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>category<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'math'</span></span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'physics'</span></span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>purple<span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'cs'</span></span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>green<span class="token punctuation">;</span>
      <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>orange<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Color</span> <span class="token function">_getMasteryColor</span><span class="token punctuation">(</span>double mastery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>mastery <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">;</span>
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>mastery <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>yellow<span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>green<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Color</span> <span class="token function">_getRelationColor</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'prerequisite'</span></span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>red<span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'related'</span></span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>blue<span class="token punctuation">;</span>
      <span class="token keyword keyword-case">case</span> <span class="token string-literal"><span class="token string">'parent'</span></span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>purple<span class="token punctuation">;</span>
      <span class="token keyword keyword-default">default</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token class-name">Colors</span><span class="token punctuation">.</span>grey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token metadata function">@override</span>
  bool <span class="token function">shouldRepaint</span><span class="token punctuation">(</span><span class="token keyword keyword-covariant">covariant</span> <span class="token class-name">StarMapPainter</span> oldDelegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> oldDelegate<span class="token punctuation">.</span>nodes <span class="token operator">!=</span> nodes <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>masteryMap <span class="token operator">!=</span> masteryMap <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>zoom <span class="token operator">!=</span> zoom <span class="token operator">||</span>
        oldDelegate<span class="token punctuation">.</span>offset <span class="token operator">!=</span> offset<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>GLSL ç€è‰²å™¨ï¼ˆç«ç„°æ•ˆæœï¼‰ï¼š</strong></p>
<pre data-role="codeBlock" data-info="glsl" class="language-glsl glsl"><code><span class="token comment">// mobile/shaders/flame_effect.frag</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;flutter/runtime_effect.glsl&gt;</span></span>

<span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-vec2">vec2</span> uSize<span class="token punctuation">;</span>
<span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-float">float</span> uTime<span class="token punctuation">;</span>
<span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-vec3">vec3</span> uColor<span class="token punctuation">;</span>
<span class="token keyword keyword-uniform">uniform</span> <span class="token keyword keyword-float">float</span> uIntensity<span class="token punctuation">;</span>

<span class="token keyword keyword-out">out</span> <span class="token keyword keyword-vec4">vec4</span> fragColor<span class="token punctuation">;</span>

<span class="token keyword keyword-void">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-vec2">vec2</span> uv <span class="token operator">=</span> <span class="token function">FlutterFragCoord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xy <span class="token operator">/</span> uSize<span class="token punctuation">;</span>
    
    <span class="token comment">// ç«ç„°å½¢çŠ¶</span>
    <span class="token keyword keyword-float">float</span> flame <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> uv<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    flame <span class="token operator">*=</span> <span class="token function">sin</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">3.14159</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// åŠ¨æ€æ³¢åŠ¨</span>
    <span class="token keyword keyword-float">float</span> noise <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">20.0</span> <span class="token operator">+</span> uTime <span class="token operator">*</span> <span class="token number">5.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
    flame <span class="token operator">+=</span> noise<span class="token punctuation">;</span>
    
    <span class="token comment">// è¾¹ç¼˜æ¨¡ç³Š</span>
    flame <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.8</span><span class="token punctuation">,</span> flame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// é¢œè‰²æ¸å˜</span>
    <span class="token keyword keyword-vec3">vec3</span> color <span class="token operator">=</span> <span class="token function">mix</span><span class="token punctuation">(</span><span class="token keyword keyword-vec3">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uColor<span class="token punctuation">,</span> flame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    color <span class="token operator">+=</span> uColor <span class="token operator">*</span> flame <span class="token operator">*</span> uIntensity <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    
    fragColor <span class="token operator">=</span> <span class="token keyword keyword-vec4">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> flame <span class="token operator">*</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>äº¤äº’å®ç°ï¼š</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">GalaxyInteractive</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">StatefulWidget</span> <span class="token punctuation">{</span>
  <span class="token metadata function">@override</span>
  _GalaxyInteractiveState <span class="token function">createState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token function">_GalaxyInteractiveState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> _GalaxyInteractiveState <span class="token keyword keyword-extends">extends</span> <span class="token class-name">State</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GalaxyInteractive</span><span class="token punctuation">&gt;</span></span> 
    <span class="token keyword keyword-with">with</span> <span class="token class-name">SingleTickerProviderStateMixin</span> <span class="token punctuation">{</span>
  
  double _zoom <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
  <span class="token class-name">Offset</span> _offset <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">;</span>
  <span class="token class-name">Offset</span> _dragStart <span class="token operator">=</span> <span class="token class-name">Offset</span><span class="token punctuation">.</span>zero<span class="token punctuation">;</span>
  
  <span class="token metadata function">@override</span>
  <span class="token class-name">Widget</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">BuildContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-return">return</span> <span class="token class-name">GestureDetector</span><span class="token punctuation">(</span>
      onScaleStart<span class="token punctuation">:</span> _handleScaleStart<span class="token punctuation">,</span>
      onScaleUpdate<span class="token punctuation">:</span> _handleScaleUpdate<span class="token punctuation">,</span>
      onScaleEnd<span class="token punctuation">:</span> _handleScaleEnd<span class="token punctuation">,</span>
      onTapUp<span class="token punctuation">:</span> _handleTap<span class="token punctuation">,</span>
      child<span class="token punctuation">:</span> <span class="token class-name">CustomPaint</span><span class="token punctuation">(</span>
        painter<span class="token punctuation">:</span> <span class="token class-name">StarMapPainter</span><span class="token punctuation">(</span>
          nodes<span class="token punctuation">:</span> _nodes<span class="token punctuation">,</span>
          masteryMap<span class="token punctuation">:</span> _masteryMap<span class="token punctuation">,</span>
          zoom<span class="token punctuation">:</span> _zoom<span class="token punctuation">,</span>
          offset<span class="token punctuation">:</span> _offset<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        size<span class="token punctuation">:</span> <span class="token class-name">Size</span><span class="token punctuation">.</span>infinite<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleScaleStart</span><span class="token punctuation">(</span><span class="token class-name">ScaleStartDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _dragStart <span class="token operator">=</span> details<span class="token punctuation">.</span>focalPoint<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleScaleUpdate</span><span class="token punctuation">(</span><span class="token class-name">ScaleUpdateDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç¼©æ”¾</span>
      _zoom <span class="token operator">=</span> <span class="token punctuation">(</span>_zoom <span class="token operator">*</span> details<span class="token punctuation">.</span>scale<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clamp</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// æ‹–æ‹½</span>
      <span class="token keyword keyword-final">final</span> dx <span class="token operator">=</span> details<span class="token punctuation">.</span>focalPoint<span class="token punctuation">.</span>dx <span class="token operator">-</span> _dragStart<span class="token punctuation">.</span>dx<span class="token punctuation">;</span>
      <span class="token keyword keyword-final">final</span> dy <span class="token operator">=</span> details<span class="token punctuation">.</span>focalPoint<span class="token punctuation">.</span>dy <span class="token operator">-</span> _dragStart<span class="token punctuation">.</span>dy<span class="token punctuation">;</span>
      _offset <span class="token operator">=</span> _offset <span class="token operator">+</span> <span class="token class-name">Offset</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _dragStart <span class="token operator">=</span> details<span class="token punctuation">.</span>focalPoint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword keyword-void">void</span> <span class="token function">_handleTap</span><span class="token punctuation">(</span><span class="token class-name">TapUpDetails</span> details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†ç‚¹å‡»åæ ‡è½¬æ¢ä¸ºæ˜Ÿå›¾åæ ‡</span>
    <span class="token keyword keyword-final">final</span> localPosition <span class="token operator">=</span> details<span class="token punctuation">.</span>localPosition<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> galaxyX <span class="token operator">=</span> <span class="token punctuation">(</span>localPosition<span class="token punctuation">.</span>dx <span class="token operator">-</span> _offset<span class="token punctuation">.</span>dx<span class="token punctuation">)</span> <span class="token operator">/</span> _zoom<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> galaxyY <span class="token operator">=</span> <span class="token punctuation">(</span>localPosition<span class="token punctuation">.</span>dy <span class="token operator">-</span> _offset<span class="token punctuation">.</span>dy<span class="token punctuation">)</span> <span class="token operator">/</span> _zoom<span class="token punctuation">;</span>
    
    <span class="token comment">// æŸ¥æ‰¾ç‚¹å‡»çš„èŠ‚ç‚¹</span>
    <span class="token keyword keyword-final">final</span> tappedNode <span class="token operator">=</span> _nodes<span class="token punctuation">.</span><span class="token function">firstWhere</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-final">final</span> distance <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>
          <span class="token function">pow</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>x <span class="token operator">-</span> galaxyX<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">pow</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>y <span class="token operator">-</span> galaxyY<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword keyword-return">return</span> distance <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>radius<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      orElse<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>tappedNode <span class="token operator">!=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ˜¾ç¤ºèŠ‚ç‚¹è¯¦æƒ…</span>
      <span class="token function">_showNodeDetail</span><span class="token punctuation">(</span>tappedNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-31">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>Canvas API vs Widget:</strong></p>
<ul>
<li><strong>Widget</strong>: é€‚åˆé™æ€ UIï¼Œæœ‰å®Œæ•´çš„å¸ƒå±€ç³»ç»Ÿ</li>
<li><strong>Canvas</strong>: é€‚åˆå¤æ‚å›¾å½¢ã€åŠ¨ç”»ï¼Œæ€§èƒ½æ›´é«˜</li>
<li><strong>é€‰æ‹©</strong>: Sparkle é€‰æ‹© Canvas å› ä¸ºéœ€è¦ç»˜åˆ¶å¤§é‡èŠ‚ç‚¹å’Œè¿çº¿</li>
</ul>
<p><strong>GLSL ç€è‰²å™¨çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>GPU åŠ é€Ÿ</strong>: è®¡ç®—å¯†é›†å‹ä»»åŠ¡åœ¨ GPU ä¸Šæ‰§è¡Œ</li>
<li><strong>å¹¶è¡Œè®¡ç®—</strong>: åŒæ—¶å¤„ç†å¤§é‡åƒç´ </li>
<li><strong>è§†è§‰æ•ˆæœ</strong>: å®ç°å¤æ‚çš„å…‰å½±ã€ç²’å­æ•ˆæœ</li>
</ul>
<p><strong>äº¤äº’è®¾è®¡åŸåˆ™:</strong></p>
<ul>
<li><strong>ç›´è§‚</strong>: ç¼©æ”¾æ‹–æ‹½ç¬¦åˆç”¨æˆ·ä¹ æƒ¯</li>
<li><strong>åé¦ˆ</strong>: ç‚¹å‡»èŠ‚ç‚¹æœ‰è§†è§‰åé¦ˆ</li>
<li><strong>æ€§èƒ½</strong>: æ‰‹åŠ¿å¤„ç†ä¸é˜»å¡ UI çº¿ç¨‹</li>
<li><strong>å¯è®¿é—®æ€§</strong>: æä¾›ç¼©æ”¾æ§åˆ¶æŒ‰é’®</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-31">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ä¸ºä»€ä¹ˆä½¿ç”¨ Canvas è€Œä¸æ˜¯ Widget æ¥ç»˜åˆ¶æ˜Ÿå›¾ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ€§èƒ½</strong>: Widget æ ‘è¿‡æ·±ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜</li>
<li><strong>çµæ´»æ€§</strong>: Canvas å¯ä»¥è‡ªç”±ç»˜åˆ¶ä»»æ„å›¾å½¢</li>
<li><strong>åŠ¨ç”»</strong>: å¤æ‚åŠ¨ç”»åœ¨ Canvas ä¸­æ›´å®¹æ˜“å®ç°</li>
<li><strong>GPU åŠ é€Ÿ</strong>: å¯ä»¥é…åˆ GLSL å®ç°é«˜æ€§èƒ½æ•ˆæœ</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æ˜Ÿå›¾éœ€è¦åŒæ—¶ç»˜åˆ¶æ•°ç™¾ä¸ªèŠ‚ç‚¹å’Œè¿çº¿ï¼Œå¦‚æœç”¨ Widget å®ç°ï¼ŒWidget æ ‘ä¼šéå¸¸æ·±ï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚Canvas ç›´æ¥æ“ä½œåº•å±‚ Skia å¼•æ“ï¼Œå¯ä»¥é«˜æ•ˆç»˜åˆ¶å¤æ‚å›¾å½¢ã€‚æ›´é‡è¦çš„æ˜¯ï¼ŒCanvas å¯ä»¥é…åˆ GLSL ç€è‰²å™¨å®ç° GPU åŠ é€Ÿçš„ç«ç„°ã€å‘å…‰ç­‰æ•ˆæœï¼Œè¿™æ˜¯ Widget æ— æ³•åšåˆ°çš„ã€‚è™½ç„¶ Canvas çš„å¸ƒå±€å’Œäº‹ä»¶å¤„ç†éœ€è¦æ‰‹åŠ¨å®ç°ï¼Œä½†å¯¹äºè¿™ç§æ•°æ®å¯è§†åŒ–åœºæ™¯ï¼Œæ€§èƒ½å’Œçµæ´»æ€§è¿œæ¯”å¼€å‘æ•ˆç‡é‡è¦ã€‚"</p>
</blockquote>
<hr>
<h1 id="äº”-æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ-1">äº”ã€æ•°æ®åº“æ¶æ„æ·±åº¦è§£æ </h1>
<h2 id="51-æ ¸å¿ƒè¡¨ç»“æ„-1">5.1 æ ¸å¿ƒè¡¨ç»“æ„ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-36">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle é‡‡ç”¨ <strong>æ··åˆå­˜å‚¨æ¶æ„</strong>ï¼Œå°†å…³ç³»å‹æ•°æ®å’Œå‘é‡æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨ PostgreSQL + pgvector ä¸­ï¼š</p>
<ul>
<li><strong>çŸ¥è¯†ç³»ç»Ÿ</strong>: çŸ¥è¯†èŠ‚ç‚¹ + å‘é‡åµŒå…¥ + å›¾å…³ç³»</li>
<li><strong>ç”¨æˆ·ç³»ç»Ÿ</strong>: ç”¨æˆ·ä¿¡æ¯ + ä»»åŠ¡ + è®¡åˆ’</li>
<li><strong>æ¨é€ç³»ç»Ÿ</strong>: åå¥½é…ç½® + å†å²è®°å½•</li>
<li><strong>ç¤¾åŒºç³»ç»Ÿ</strong>: å¸–å­ + ç‚¹èµå…³ç³»</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-37">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>çŸ¥è¯†ç³»ç»Ÿæ ¸å¿ƒè¡¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ============================================</span>
<span class="token comment">-- çŸ¥è¯†èŠ‚ç‚¹è¡¨ (Knowledge Nodes)</span>
<span class="token comment">-- å­˜å‚¨çŸ¥è¯†ç‚¹åŠå…¶å‘é‡åµŒå…¥ï¼Œå®ç°â€œè¯­ä¹‰æœç´¢â€</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> knowledge_nodes <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    name <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    description <span class="token keyword keyword-TEXT">TEXT</span><span class="token punctuation">,</span>
    <span class="token comment">-- å‘é‡åµŒå…¥ (pgvector): å­˜å‚¨ 1536 ç»´è¯­ä¹‰å‘é‡</span>
    embedding VECTOR<span class="token punctuation">(</span><span class="token number">1536</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    importance_level <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">,</span>
    category <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    parent_id UUID <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-CONSTRAINT">CONSTRAINT</span> chk_importance <span class="token keyword keyword-CHECK">CHECK</span> <span class="token punctuation">(</span>importance_level <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">AND</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ã€ç”Ÿäº§çº§ä¼˜åŒ–ã€‘: HNSW ç´¢å¼• (Hierarchical Navigable Small World)</span>
<span class="token comment">-- ç¼–ç¨‹æ€æƒ³ï¼šç©ºé—´åˆ†å‰²ä¸è¿‘ä¼¼æœç´¢ã€‚åœ¨å¤§è§„æ¨¡å‘é‡æ•°æ®ä¸­å¿«é€Ÿæ‰¾åˆ°è¯­ä¹‰æœ€è¿‘é‚»ã€‚</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_knowledge_nodes_embedding_hnsw
<span class="token keyword keyword-ON">ON</span> knowledge_nodes <span class="token keyword keyword-USING">USING</span> hnsw <span class="token punctuation">(</span>embedding vector_cosine_ops<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> ef_construction <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> ef_search <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- èŠ‚ç‚¹å…³ç³»è¡¨ (Node Relations)</span>
<span class="token comment">-- çŸ¥è¯†å›¾è°±è¾¹ï¼Œå­˜å‚¨èŠ‚ç‚¹é—´å…³ç³»</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> node_relations <span class="token punctuation">(</span>
    source_node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    target_node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    relation_type <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    strength <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
    created_by <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'system'</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token punctuation">(</span>source_node_id<span class="token punctuation">,</span> target_node_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-CONSTRAINT">CONSTRAINT</span> chk_relation_type <span class="token keyword keyword-CHECK">CHECK</span> <span class="token punctuation">(</span>relation_type <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token string">'prerequisite'</span><span class="token punctuation">,</span> <span class="token string">'related'</span><span class="token punctuation">,</span> <span class="token string">'parent'</span><span class="token punctuation">,</span> <span class="token string">'child'</span><span class="token punctuation">,</span> <span class="token string">'similar'</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ç´¢å¼•ï¼ˆå›¾éå†ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_node_relations_source <span class="token keyword keyword-ON">ON</span> node_relations<span class="token punctuation">(</span>source_node_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_node_relations_target <span class="token keyword keyword-ON">ON</span> node_relations<span class="token punctuation">(</span>target_node_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- ç”¨æˆ·èŠ‚ç‚¹çŠ¶æ€è¡¨ (User Node Status)</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> user_node_status <span class="token punctuation">(</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    mastery_score <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    study_count <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    last_study_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>
    next_review_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> node_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ã€æ€§èƒ½ä¼˜åŒ–ã€‘: éƒ¨åˆ†ç´¢å¼• (Partial Index)</span>
<span class="token comment">-- ç¼–ç¨‹æ€æƒ³ï¼šåªå¯¹â€œå¾…å¤ä¹ â€çš„æ´»è·ƒæ•°æ®å»ºç«‹ç´¢å¼•ï¼Œæå¤§åœ°ç¼©å°ç´¢å¼•ä½“ç§¯ï¼ŒåŠ é€ŸæŸ¥è¯¢ã€‚</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_user_node_status_review_active
<span class="token keyword keyword-ON">ON</span> user_node_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> next_review_at<span class="token punctuation">)</span>
<span class="token keyword keyword-WHERE">WHERE</span> next_review_at <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- å­¦ä¹ è®°å½•è¡¨ (Study Records) - æŒ‰æ—¶é—´åˆ†åŒº</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    study_minutes <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    mastery_delta <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    study_method <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    completed_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-BY">BY</span> RANGE <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- æœˆåº¦åˆ†åŒºç¤ºä¾‹</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records_2025_12 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> study_records
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-FROM">FROM</span> <span class="token punctuation">(</span><span class="token string">'2025-12-01'</span><span class="token punctuation">)</span> <span class="token keyword keyword-TO">TO</span> <span class="token punctuation">(</span><span class="token string">'2026-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ†åŒºç´¢å¼•</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_user_time
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>ç”¨æˆ·ä¸ä»»åŠ¡ç³»ç»Ÿï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ============================================</span>
<span class="token comment">-- ç”¨æˆ·è¡¨ (Users)</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> users <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    email <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword keyword-UNIQUE">UNIQUE</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    nickname <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    avatar_url <span class="token keyword keyword-TEXT">TEXT</span><span class="token punctuation">,</span>
    flame_level <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token comment">-- Proç­‰çº§</span>
    preferences JSONB <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'{}'</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- ä»»åŠ¡è¡¨ (Tasks) - 6ç§ç±»å‹</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TYPE">TYPE</span> tasktype <span class="token keyword keyword-AS">AS</span> <span class="token keyword keyword-ENUM">ENUM</span> <span class="token punctuation">(</span>
    <span class="token string">'LEARNING'</span><span class="token punctuation">,</span>      <span class="token comment">-- å­¦ä¹ ä»»åŠ¡</span>
    <span class="token string">'TRAINING'</span><span class="token punctuation">,</span>      <span class="token comment">-- è®­ç»ƒä»»åŠ¡</span>
    <span class="token string">'ERROR_FIX'</span><span class="token punctuation">,</span>     <span class="token comment">-- é”™é¢˜ä¿®å¤</span>
    <span class="token string">'REFLECTION'</span><span class="token punctuation">,</span>    <span class="token comment">-- åæ€æ€»ç»“</span>
    <span class="token string">'SOCIAL'</span><span class="token punctuation">,</span>        <span class="token comment">-- ç¤¾äº¤å­¦ä¹ </span>
    <span class="token string">'PLANNING'</span>       <span class="token comment">-- è®¡åˆ’åˆ¶å®š</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TYPE">TYPE</span> taskstatus <span class="token keyword keyword-AS">AS</span> <span class="token keyword keyword-ENUM">ENUM</span> <span class="token punctuation">(</span>
    <span class="token string">'PENDING'</span><span class="token punctuation">,</span> <span class="token string">'IN_PROGRESS'</span><span class="token punctuation">,</span> <span class="token string">'COMPLETED'</span><span class="token punctuation">,</span> <span class="token string">'CANCELLED'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> tasks <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    plan_id UUID<span class="token punctuation">,</span>
    title <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-type">type</span> tasktype <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    tags JSONB <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'[]'</span><span class="token punctuation">,</span>
    estimated_minutes <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    difficulty <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-status">status</span> taskstatus <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'PENDING'</span><span class="token punctuation">,</span>
    knowledge_node_id UUID <span class="token keyword keyword-REFERENCES">REFERENCES</span> knowledge_nodes<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    auto_expand_enabled <span class="token keyword keyword-BOOLEAN">BOOLEAN</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    due_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>

    <span class="token keyword keyword-CONSTRAINT">CONSTRAINT</span> chk_difficulty <span class="token keyword keyword-CHECK">CHECK</span> <span class="token punctuation">(</span>difficulty <span class="token operator">BETWEEN</span> <span class="token number">1</span> <span class="token operator">AND</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_tasks_user_status <span class="token keyword keyword-ON">ON</span> tasks<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> <span class="token keyword keyword-status">status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_tasks_type <span class="token keyword keyword-ON">ON</span> tasks<span class="token punctuation">(</span><span class="token keyword keyword-type">type</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- æ¨é€åå¥½ (Push Preferences)</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> push_preferences <span class="token punctuation">(</span>
    user_id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-REFERENCES">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    active_slots JSONB <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'[{"start": "08:00", "end": "22:00"}]'</span><span class="token punctuation">,</span>
    timezone <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'Asia/Shanghai'</span><span class="token punctuation">,</span>
    enable_curiosity <span class="token keyword keyword-BOOLEAN">BOOLEAN</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    persona_type <span class="token keyword keyword-VARCHAR">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token string">'STUDENT'</span><span class="token punctuation">,</span>
    daily_cap <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">3</span><span class="token punctuation">,</span>
    last_push_time <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span><span class="token punctuation">,</span>
    consecutive_ignores <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updated_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-32">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>æ··åˆå­˜å‚¨æ¶æ„çš„é€‰æ‹©:</strong></p>
<ul>
<li><strong>ä¸ºä»€ä¹ˆä¸ç”¨ä¸“ç”¨å‘é‡æ•°æ®åº“</strong>: ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼ˆå¦‚ Pineconeï¼‰æˆæœ¬é«˜ï¼Œä¸”ä¸ä¸šåŠ¡æ•°æ®åˆ†ç¦»ï¼Œéœ€è¦ç»´æŠ¤ä¸¤å¥—ç³»ç»Ÿ</li>
<li><strong>pgvector çš„ä¼˜åŠ¿</strong>:
<ul>
<li>ä¸ PostgreSQL æ— ç¼é›†æˆï¼Œæ”¯æŒ ACID äº‹åŠ¡</li>
<li>å¯ä»¥ä¸å…³ç³»è¡¨ JOINï¼Œå®ç°å¼ºä¸€è‡´æ€§</li>
<li>æˆæœ¬ä½ï¼Œå¤ç”¨ç°æœ‰æ•°æ®åº“</li>
<li>æ”¯æŒå¤šç§ç´¢å¼•ï¼ˆHNSW, IVFFlatï¼‰</li>
</ul>
</li>
</ul>
<p><strong>è¡¨ç»“æ„è®¾è®¡åŸåˆ™:</strong></p>
<ol>
<li><strong>èŒƒå¼åŒ–</strong>: å‡å°‘æ•°æ®å†—ä½™ï¼Œä¿è¯ä¸€è‡´æ€§</li>
<li><strong>åèŒƒå¼åŒ–</strong>: é€‚å½“å†—ä½™ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½</li>
<li><strong>åˆ†åŒºç­–ç•¥</strong>: å¤§è¡¨æŒ‰æ—¶é—´åˆ†åŒºï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½</li>
<li><strong>JSONB</strong>: çµæ´»å­˜å‚¨éç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚ç”¨æˆ·åå¥½ï¼‰</li>
</ol>
<p><strong>ç´¢å¼•ç­–ç•¥çš„æƒè¡¡:</strong></p>
<ul>
<li><strong>HNSW</strong>: é«˜ç²¾åº¦ï¼Œé«˜å†…å­˜å ç”¨ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒ</li>
<li><strong>IVFFlat</strong>: æ„å»ºå¿«ï¼ŒæŸ¥è¯¢ç¨æ…¢ï¼Œé€‚åˆæ•°æ®é‡å¤§ä½†å¯¹ç²¾åº¦è¦æ±‚ä¸é«˜çš„åœºæ™¯</li>
<li><strong>éƒ¨åˆ†ç´¢å¼•</strong>: åªç´¢å¼•æ´»è·ƒæ•°æ®ï¼Œå‡å°‘ç´¢å¼•å¤§å°</li>
<li><strong>è¦†ç›–ç´¢å¼•</strong>: é¿å…å›è¡¨ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-32">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ä¸ºä»€ä¹ˆé€‰æ‹© PostgreSQL + pgvector è€Œä¸æ˜¯ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æˆæœ¬</strong>: å¤ç”¨ç°æœ‰æ•°æ®åº“ï¼Œæ— éœ€é¢å¤–ç»´æŠ¤</li>
<li><strong>ä¸€è‡´æ€§</strong>: ä¸ä¸šåŠ¡æ•°æ®å¼ºä¸€è‡´ï¼Œæ”¯æŒäº‹åŠ¡</li>
<li><strong>æ˜“ç”¨æ€§</strong>: SQL è¯­æ³•ï¼Œå¼€å‘äººå‘˜ç†Ÿæ‚‰</li>
<li><strong>ç”Ÿæ€</strong>: å®Œå–„çš„å·¥å…·é“¾å’Œç›‘æ§ä½“ç³»</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è¯„ä¼°è¿‡ Pineconeã€Milvus ç­‰ä¸“ç”¨å‘é‡æ•°æ®åº“ï¼Œä½†æœ€ç»ˆé€‰æ‹© PostgreSQL + pgvectorã€‚é¦–å…ˆï¼Œæˆæœ¬æ–¹é¢ï¼Œå¤ç”¨ç°æœ‰æ•°æ®åº“æ— éœ€é¢å¤–è¿ç»´æˆæœ¬ï¼›å…¶æ¬¡ï¼Œä¸€è‡´æ€§æ–¹é¢ï¼Œå‘é‡æ•°æ®å’Œä¸šåŠ¡æ•°æ®å¯ä»¥åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­æ“ä½œï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ï¼›ç¬¬ä¸‰ï¼Œå¼€å‘æ•ˆç‡æ–¹é¢ï¼Œä½¿ç”¨ç†Ÿæ‚‰çš„ SQL è¯­æ³•ï¼Œæ— éœ€å­¦ä¹ æ–°çš„æŸ¥è¯¢è¯­è¨€ï¼›ç¬¬å››ï¼Œç”Ÿæ€æ–¹é¢ï¼ŒPostgreSQL æ‹¥æœ‰å®Œå–„çš„ç›‘æ§ã€å¤‡ä»½ã€é«˜å¯ç”¨æ–¹æ¡ˆã€‚è™½ç„¶ pgvector åœ¨çº¯å‘é‡æœç´¢æ€§èƒ½ä¸Šå¯èƒ½ç•¥é€Šï¼Œä½†å¯¹äº Sparkle çš„ä¸šåŠ¡è§„æ¨¡ï¼ˆç™¾ä¸‡çº§èŠ‚ç‚¹ï¼‰å®Œå…¨å¤Ÿç”¨ã€‚"</p>
</blockquote>
<hr>
<h2 id="52-ç´¢å¼•ç­–ç•¥-1">5.2 ç´¢å¼•ç­–ç•¥ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-37">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>Sparkle é‡‡ç”¨ <strong>å¤šç»´ç´¢å¼•ç­–ç•¥</strong>ï¼Œé’ˆå¯¹ä¸åŒæ•°æ®ç‰¹å¾é€‰æ‹©æœ€ä¼˜ç´¢å¼•ï¼š</p>
<ul>
<li><strong>B-Tree</strong>: ç²¾ç¡®åŒ¹é…å’ŒèŒƒå›´æŸ¥è¯¢</li>
<li><strong>HNSW</strong>: é«˜ç»´å‘é‡è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢</li>
<li><strong>BRIN</strong>: æ—¶é—´åºåˆ—æ•°æ®ä¼˜åŒ–</li>
<li><strong>éƒ¨åˆ†ç´¢å¼•</strong>: åªç´¢å¼•æ´»è·ƒæ•°æ®</li>
<li><strong>è¦†ç›–ç´¢å¼•</strong>: é¿å…å›è¡¨</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-38">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 1. å‘é‡æœç´¢ä¼˜åŒ–ï¼ˆHNSW ç´¢å¼•ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_knowledge_nodes_embedding_hnsw
<span class="token keyword keyword-ON">ON</span> knowledge_nodes
<span class="token keyword keyword-USING">USING</span> hnsw <span class="token punctuation">(</span>embedding vector_cosine_ops<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> ef_construction <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> ef_search <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- å‚æ•°è¯´æ˜:</span>
<span class="token comment">-- m = 16: æ¯ä¸ªèŠ‚ç‚¹çš„é‚»å±…æ•°ï¼Œå¹³è¡¡ç²¾åº¦ä¸å†…å­˜</span>
<span class="token comment">-- ef_construction = 64: æ„å»ºæ—¶çš„æœç´¢èŒƒå›´ï¼Œè¶Šé«˜ç²¾åº¦è¶Šå¥½</span>
<span class="token comment">-- ef_search = 40: æŸ¥è¯¢æ—¶çš„æœç´¢èŒƒå›´ï¼Œå½±å“å¬å›ç‡</span>

<span class="token comment">-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_user_node_status_active
<span class="token keyword keyword-ON">ON</span> user_node_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> mastery_score<span class="token punctuation">)</span>
<span class="token keyword keyword-WHERE">WHERE</span> mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: ç´¢å¼•ä½“ç§¯å°ï¼ŒæŸ¥è¯¢é€Ÿåº¦å¿«</span>
<span class="token comment">-- é€‚ç”¨: åªéœ€è¦æŸ¥è¯¢æœªæŒæ¡çš„çŸ¥è¯†ç‚¹</span>

<span class="token comment">-- 3. å¤åˆç´¢å¼•ï¼ˆè¦†ç›–æŸ¥è¯¢ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_covering
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span>node_id<span class="token punctuation">,</span> mastery_delta<span class="token punctuation">,</span> study_minutes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: æŸ¥è¯¢æ—¶æ— éœ€å›è¡¨ï¼Œç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®</span>
<span class="token comment">-- é€‚ç”¨: åªéœ€è¦æŸ¥è¯¢å°‘é‡å­—æ®µçš„åœºæ™¯</span>

<span class="token comment">-- 4. BRIN ç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_brin
<span class="token keyword keyword-ON">ON</span> study_records <span class="token keyword keyword-USING">USING</span> BRIN <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>pages_per_range <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: ç´¢å¼•ä½“ç§¯æå°ï¼ˆä»…ä¸ºæ•°æ®çš„0.1%ï¼‰</span>
<span class="token comment">-- é€‚ç”¨: æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢çš„å¤§è¡¨</span>

<span class="token comment">-- 5. JSONB ç´¢å¼•</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_users_preferences
<span class="token keyword keyword-ON">ON</span> users <span class="token keyword keyword-USING">USING</span> GIN <span class="token punctuation">(</span>preferences<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŠ¿: æ”¯æŒ JSONB å†…éƒ¨å­—æ®µçš„æŸ¥è¯¢</span>
<span class="token comment">-- é€‚ç”¨: éœ€è¦æŸ¥è¯¢ JSON å­—æ®µçš„åœºæ™¯</span>
</code></pre><p><strong>ç´¢å¼•æ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- æµ‹è¯• 1: å‘é‡æœç´¢æ€§èƒ½</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> knowledge_nodes
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> embedding <span class="token operator">&lt;=&gt;</span> <span class="token string">'[0.1, 0.2, ...]'</span>::vector
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">-- æ— ç´¢å¼•: 1200ms (å…¨è¡¨æ‰«æ)</span>
<span class="token comment">-- HNSW: 12ms (ç´¢å¼•æ‰«æ)</span>
<span class="token comment">-- æ€§èƒ½æå‡: 100x</span>

<span class="token comment">-- æµ‹è¯• 2: éƒ¨åˆ†ç´¢å¼•æŸ¥è¯¢</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> user_node_status
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">-- å…¨è¡¨ç´¢å¼•: 45ms</span>
<span class="token comment">-- éƒ¨åˆ†ç´¢å¼•: 8ms</span>
<span class="token comment">-- ç´¢å¼•å¤§å°: å‡å°‘ 60%</span>

<span class="token comment">-- æµ‹è¯• 3: è¦†ç›–ç´¢å¼•æŸ¥è¯¢</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> node_id<span class="token punctuation">,</span> mastery_delta
<span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> completed_at <span class="token keyword keyword-DESC">DESC</span>
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- æ™®é€šç´¢å¼•: 23ms (éœ€è¦å›è¡¨)</span>
<span class="token comment">-- è¦†ç›–ç´¢å¼•: 5ms (æ— éœ€å›è¡¨)</span>
<span class="token comment">-- æ€§èƒ½æå‡: 4.6x</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-33">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç´¢å¼•é€‰æ‹©çš„å†³ç­–æ ‘:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>æ•°æ®ç±»å‹?
â”œâ”€â”€ ç»“æ„åŒ–æ•°æ® (ID, æ—¶é—´, çŠ¶æ€)
â”‚   â”œâ”€â”€ ç­‰å€¼æŸ¥è¯¢ â†’ B-Tree
â”‚   â”œâ”€â”€ èŒƒå›´æŸ¥è¯¢ â†’ B-Tree
â”‚   â””â”€â”€ æ—¶é—´åºåˆ— â†’ BRIN
â”œâ”€â”€ åŠç»“æ„åŒ–æ•°æ® (JSON)
â”‚   â””â”€â”€ é”®å€¼æŸ¥è¯¢ â†’ GIN
â””â”€â”€ éç»“æ„åŒ–æ•°æ® (å‘é‡)
    â”œâ”€â”€ é«˜ç²¾åº¦ â†’ HNSW
    â””â”€â”€ é«˜é€Ÿåº¦ â†’ IVFFlat
</code></pre><p><strong>ç´¢å¼•ä¼˜åŒ–çš„æƒè¡¡:</strong></p>
<ul>
<li><strong>æŸ¥è¯¢é€Ÿåº¦ vs å†™å…¥é€Ÿåº¦</strong>: ç´¢å¼•åŠ é€ŸæŸ¥è¯¢ï¼Œä½†å‡æ…¢å†™å…¥</li>
<li><strong>ç´¢å¼•å¤§å° vs å†…å­˜</strong>: ç´¢å¼•å ç”¨å†…å­˜ï¼Œéœ€è¦å¹³è¡¡</li>
<li><strong>ç²¾åº¦ vs æ€§èƒ½</strong>: HNSW å‚æ•°è°ƒä¼˜ï¼Œm è¶Šå¤§ç²¾åº¦è¶Šé«˜ä½†å†…å­˜è¶Šå¤§</li>
</ul>
<p><strong>éƒ¨åˆ†ç´¢å¼•çš„å¦™ç”¨:</strong></p>
<ul>
<li><strong>æ•°æ®å€¾æ–œ</strong>: åªç´¢å¼•æ´»è·ƒæ•°æ®ï¼Œå¿½ç•¥å†å²æ•°æ®</li>
<li><strong>æŸ¥è¯¢æ¨¡å¼</strong>: é’ˆå¯¹ç‰¹å®šæŸ¥è¯¢æ¡ä»¶ä¼˜åŒ–</li>
<li><strong>ç»´æŠ¤æˆæœ¬</strong>: ç´¢å¼•ä½“ç§¯å°ï¼Œé‡å»ºå¿«</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-33">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ”¯æŒåƒä¸‡çº§æ•°æ®çš„å‘é‡ç´¢å¼•ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>HNSW å‚æ•°è°ƒä¼˜</strong>: m=16-32, ef_construction=100-200</li>
<li><strong>åˆ†ç‰‡ç­–ç•¥</strong>: æŒ‰ç”¨æˆ· ID æˆ–ç±»åˆ«åˆ†ç‰‡</li>
<li><strong>ç¼“å­˜å±‚</strong>: Redis ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ç»“æœ</li>
<li><strong>é™çº§ç­–ç•¥</strong>: ç´¢å¼•ä¸å¯ç”¨æ—¶é€€å›åˆ°ç²¾ç¡®æœç´¢</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"åƒä¸‡çº§å‘é‡æ•°æ®éœ€è¦å¤šå±‚ä¼˜åŒ–ã€‚é¦–å…ˆï¼ŒHNSW ç´¢å¼•å‚æ•°è°ƒä¼˜ï¼Œm è®¾ç½®ä¸º 16-32 ä»¥å¹³è¡¡ç²¾åº¦å’Œå†…å­˜ï¼Œef_construction è®¾ç½®ä¸º 100-200 ä»¥æé«˜æ„å»ºè´¨é‡ã€‚å…¶æ¬¡ï¼Œåˆ†ç‰‡ç­–ç•¥ï¼Œå¯ä»¥æŒ‰ç”¨æˆ· ID æˆ–çŸ¥è¯†ç±»åˆ«åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹ç´¢å¼•ï¼Œå‡å°‘å•ä¸ªç´¢å¼•çš„å¤§å°ã€‚ç¬¬ä¸‰ï¼Œç¼“å­˜å±‚ï¼Œä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ç»“æœï¼Œå‘½ä¸­ç‡å¯è¾¾ 80% ä»¥ä¸Šã€‚ç¬¬å››ï¼Œé™çº§ç­–ç•¥ï¼Œå½“ç´¢å¼•ä¸å¯ç”¨æ—¶ï¼Œé€€å›åˆ°ç²¾ç¡®æœç´¢æˆ–å…³é”®è¯æœç´¢ã€‚æœ€åï¼Œç›‘æ§ç´¢å¼•çš„å¬å›ç‡å’Œæ€§èƒ½ï¼ŒæŒç»­è°ƒä¼˜ã€‚"</p>
</blockquote>
<hr>
<h2 id="53-åˆ†åŒºç­–ç•¥-1">5.3 åˆ†åŒºç­–ç•¥ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-38">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>åˆ†åŒºæ˜¯å¤„ç†æµ·é‡æ•°æ®çš„ <strong>åˆ†è€Œæ²»ä¹‹</strong> ç­–ç•¥ï¼Œå°†å¤§è¡¨æ‹†åˆ†ä¸ºå°è¡¨ï¼š</p>
<ul>
<li><strong>æ—¶é—´åˆ†åŒº</strong>: æŒ‰æœˆ/æŒ‰å¤©æ‹†åˆ†ï¼Œé€‚åˆæ—¶åºæ•°æ®</li>
<li><strong>èŒƒå›´åˆ†åŒº</strong>: æŒ‰ ID èŒƒå›´æ‹†åˆ†ï¼Œé€‚åˆæœ‰åºæ•°æ®</li>
<li><strong>å“ˆå¸Œåˆ†åŒº</strong>: æŒ‰å“ˆå¸Œå€¼æ‹†åˆ†ï¼Œé€‚åˆè´Ÿè½½å‡è¡¡</li>
<li><strong>åˆ—è¡¨åˆ†åŒº</strong>: æŒ‰æšä¸¾å€¼æ‹†åˆ†ï¼Œé€‚åˆç±»åˆ«æ•°æ®</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-39">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ============================================</span>
<span class="token comment">-- å­¦ä¹ è®°å½•è¡¨ - æŒ‰æ—¶é—´åˆ†åŒº</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records <span class="token punctuation">(</span>
    id UUID <span class="token keyword keyword-PRIMARY">PRIMARY</span> <span class="token keyword keyword-KEY">KEY</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> gen_random_uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    node_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    study_minutes <span class="token keyword keyword-INTEGER">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    mastery_delta <span class="token keyword keyword-DOUBLE">DOUBLE</span> <span class="token keyword keyword-PRECISION">PRECISION</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    completed_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-BY">BY</span> RANGE <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- è‡ªåŠ¨åˆ›å»ºæœˆåº¦åˆ†åŒºå‡½æ•°</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token operator">OR</span> <span class="token keyword keyword-REPLACE">REPLACE</span> <span class="token keyword keyword-FUNCTION">FUNCTION</span> create_monthly_partition<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-RETURNS">RETURNS</span> void <span class="token keyword keyword-AS">AS</span> $$
<span class="token keyword keyword-DECLARE">DECLARE</span>
    partition_date <span class="token keyword keyword-DATE">DATE</span> :<span class="token operator">=</span> DATE_TRUNC<span class="token punctuation">(</span><span class="token string">'month'</span><span class="token punctuation">,</span> <span class="token keyword keyword-CURRENT_DATE">CURRENT_DATE</span> <span class="token operator">+</span> <span class="token keyword keyword-INTERVAL">INTERVAL</span> <span class="token string">'1 month'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    partition_name <span class="token keyword keyword-TEXT">TEXT</span> :<span class="token operator">=</span> <span class="token string">'study_records_'</span> <span class="token operator">||</span> TO_CHAR<span class="token punctuation">(</span>partition_date<span class="token punctuation">,</span> <span class="token string">'YYYY_MM'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    start_date <span class="token keyword keyword-DATE">DATE</span> :<span class="token operator">=</span> partition_date<span class="token punctuation">;</span>
    end_date <span class="token keyword keyword-DATE">DATE</span> :<span class="token operator">=</span> partition_date <span class="token operator">+</span> <span class="token keyword keyword-INTERVAL">INTERVAL</span> <span class="token string">'1 month'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-BEGIN">BEGIN</span>
    <span class="token keyword keyword-EXECUTE">EXECUTE</span> <span class="token function">format</span><span class="token punctuation">(</span>
        <span class="token string">'CREATE TABLE IF NOT EXISTS %I PARTITION OF study_records
         FOR VALUES FROM (%L) TO (%L)'</span><span class="token punctuation">,</span>
        partition_name<span class="token punctuation">,</span> start_date<span class="token punctuation">,</span> end_date
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- ä¸ºæ–°åˆ†åŒºåˆ›å»ºç´¢å¼•</span>
    <span class="token keyword keyword-EXECUTE">EXECUTE</span> <span class="token function">format</span><span class="token punctuation">(</span>
        <span class="token string">'CREATE INDEX IF NOT EXISTS idx_%s_user_time ON %I(user_id, completed_at DESC)'</span><span class="token punctuation">,</span>
        partition_name<span class="token punctuation">,</span> partition_name
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-END">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword keyword-LANGUAGE">LANGUAGE</span> plpgsql<span class="token punctuation">;</span>

<span class="token comment">-- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æœˆè‡ªåŠ¨åˆ›å»ºåˆ†åŒºï¼‰</span>
<span class="token comment">-- å¯ä»¥é€šè¿‡ pg_cron æˆ–å¤–éƒ¨è°ƒåº¦å™¨å®ç°</span>

<span class="token comment">-- æ‰‹åŠ¨åˆ›å»ºç¤ºä¾‹</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> study_records_2025_12 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> study_records
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-FROM">FROM</span> <span class="token punctuation">(</span><span class="token string">'2025-12-01'</span><span class="token punctuation">)</span> <span class="token keyword keyword-TO">TO</span> <span class="token punctuation">(</span><span class="token string">'2026-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ============================================</span>
<span class="token comment">-- æŒ‰ç”¨æˆ· ID å“ˆå¸Œåˆ†åŒºï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰</span>
<span class="token comment">-- ============================================</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> user_data <span class="token punctuation">(</span>
    id UUID<span class="token punctuation">,</span>
    user_id UUID <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword keyword-data">data</span> JSONB<span class="token punctuation">,</span>
    created_at <span class="token keyword keyword-TIMESTAMP">TIMESTAMP</span> <span class="token keyword keyword-DEFAULT">DEFAULT</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-BY">BY</span> <span class="token keyword keyword-HASH">HASH</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ›å»º 4 ä¸ªåˆ†åŒº</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> user_data_p0 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> user_data
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>MODULUS <span class="token number">4</span><span class="token punctuation">,</span> REMAINDER <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> user_data_p1 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> user_data
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>MODULUS <span class="token number">4</span><span class="token punctuation">,</span> REMAINDER <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> user_data_p2 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> user_data
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>MODULUS <span class="token number">4</span><span class="token punctuation">,</span> REMAINDER <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-TABLE">TABLE</span> user_data_p3 <span class="token keyword keyword-PARTITION">PARTITION</span> <span class="token keyword keyword-OF">OF</span> user_data
    <span class="token keyword keyword-FOR">FOR</span> <span class="token keyword keyword-VALUES">VALUES</span> <span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>MODULUS <span class="token number">4</span><span class="token punctuation">,</span> REMAINDER <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p><strong>åˆ†åŒºæŸ¥è¯¢ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ä¼˜åŒ–å‰ï¼šå…¨è¡¨æ‰«æ</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> completed_at <span class="token operator">&gt;=</span> <span class="token string">'2025-12-01'</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŒ–åï¼šåˆ†åŒºè£å‰ªï¼ˆåªæ‰«æ 2025-12 åˆ†åŒºï¼‰</span>
<span class="token comment">-- PostgreSQL ä¼šè‡ªåŠ¨æ ¹æ® WHERE æ¡ä»¶é€‰æ‹©åˆ†åŒº</span>

<span class="token comment">-- æ‰‹åŠ¨æŒ‡å®šåˆ†åŒºï¼ˆæ›´é«˜æ•ˆï¼‰</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records_2025_12
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">;</span>

<span class="token comment">-- åˆ†åŒºèšåˆæŸ¥è¯¢</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    DATE_TRUNC<span class="token punctuation">(</span><span class="token string">'month'</span><span class="token punctuation">,</span> completed_at<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> <span class="token keyword keyword-month">month</span><span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> study_count<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>study_minutes<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> total_minutes
<span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> completed_at <span class="token operator">&gt;=</span> <span class="token string">'2025-01-01'</span>
<span class="token keyword keyword-GROUP">GROUP</span> <span class="token keyword keyword-BY">BY</span> <span class="token keyword keyword-month">month</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> <span class="token keyword keyword-month">month</span><span class="token punctuation">;</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-34">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>åˆ†åŒºçš„æ ¸å¿ƒä»·å€¼:</strong></p>
<ul>
<li><strong>æŸ¥è¯¢æ€§èƒ½</strong>: åˆ†åŒºè£å‰ªï¼ˆPartition Pruningï¼‰ï¼Œåªæ‰«æç›¸å…³åˆ†åŒº</li>
<li><strong>ç»´æŠ¤ä¾¿åˆ©</strong>: å¯ä»¥å•ç‹¬å¤‡ä»½/åˆ é™¤æ—§åˆ†åŒº</li>
<li><strong>æ•°æ®å½’æ¡£</strong>: æ—§åˆ†åŒºå¯ä»¥è¿ç§»åˆ°å»‰ä»·å­˜å‚¨</li>
<li><strong>å¹¶è¡ŒæŸ¥è¯¢</strong>: ä¸åŒåˆ†åŒºå¯ä»¥å¹¶è¡Œæ‰«æ</li>
</ul>
<p><strong>åˆ†åŒºç­–ç•¥é€‰æ‹©:</strong></p>
<ul>
<li><strong>æ—¶é—´åˆ†åŒº</strong>: é€‚åˆæ—¥å¿—ã€å†å²è®°å½•ç­‰æ—¶åºæ•°æ®</li>
<li><strong>å“ˆå¸Œåˆ†åŒº</strong>: é€‚åˆå¤šç§Ÿæˆ·ï¼Œæ•°æ®å‡åŒ€åˆ†å¸ƒ</li>
<li><strong>èŒƒå›´åˆ†åŒº</strong>: é€‚åˆæœ‰åºæ•°æ®ï¼Œå¦‚ ID èŒƒå›´</li>
<li><strong>åˆ—è¡¨åˆ†åŒº</strong>: é€‚åˆå›ºå®šç±»åˆ«ï¼Œå¦‚åœ°åŒºã€ç±»å‹</li>
</ul>
<p><strong>åˆ†åŒºçš„é™·é˜±:</strong></p>
<ul>
<li><strong>åˆ†åŒºè¿‡å¤š</strong>: ç®¡ç†å¤æ‚ï¼ŒæŸ¥è¯¢è®¡åˆ’å˜æ…¢</li>
<li><strong>è·¨åˆ†åŒºæŸ¥è¯¢</strong>: æ€§èƒ½å¯èƒ½ä¸å¦‚å•è¡¨</li>
<li><strong>åˆ†åŒºé”®é€‰æ‹©</strong>: é€‰æ‹©ä¸å½“ä¼šå¯¼è‡´æ•°æ®å€¾æ–œ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-34">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: åˆ†åŒºè¡¨çš„æŸ¥è¯¢æ€§èƒ½ä¸€å®šæ›´å¥½å—ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>åˆ†åŒºè£å‰ª</strong>: WHERE æ¡ä»¶åŒ…å«åˆ†åŒºé”®æ—¶æ€§èƒ½æå‡</li>
<li><strong>æ•°æ®é‡</strong>: æ•°æ®é‡è¶Šå¤§ï¼Œåˆ†åŒºä¼˜åŠ¿è¶Šæ˜æ˜¾</li>
<li><strong>æŸ¥è¯¢ç±»å‹</strong>: ç‚¹æŸ¥å’ŒèŒƒå›´æŸ¥å—ç›Šï¼Œè·¨åˆ†åŒºèšåˆå¯èƒ½å˜æ…¢</li>
<li><strong>åˆ†åŒºæ•°é‡</strong>: è¿‡å¤šåˆ†åŒºä¼šé™ä½æ€§èƒ½</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"åˆ†åŒºè¡¨çš„æ€§èƒ½ä¼˜åŠ¿å–å†³äºæŸ¥è¯¢æ¨¡å¼å’Œæ•°æ®é‡ã€‚å½“æŸ¥è¯¢æ¡ä»¶åŒ…å«åˆ†åŒºé”®æ—¶ï¼ŒPostgreSQL ä¼šè¿›è¡Œåˆ†åŒºè£å‰ªï¼Œåªæ‰«æç›¸å…³åˆ†åŒºï¼Œæ€§èƒ½å¤§å¹…æå‡ã€‚å¯¹äºåƒä¸‡çº§ä»¥ä¸Šçš„å¤§è¡¨ï¼Œåˆ†åŒºä¼˜åŠ¿æ˜æ˜¾ã€‚ä½†åˆ†åŒºä¸æ˜¯é“¶å¼¹ï¼šå¦‚æœæŸ¥è¯¢ç»å¸¸è·¨åˆ†åŒºï¼ˆå¦‚å…¨è¡¨èšåˆï¼‰ï¼Œæ€§èƒ½å¯èƒ½åè€Œä¸‹é™ï¼›åˆ†åŒºè¿‡å¤šä¼šå¢åŠ æŸ¥è¯¢è®¡åˆ’å¼€é”€ã€‚å› æ­¤ï¼Œåˆ†åŒºé”®çš„é€‰æ‹©è‡³å…³é‡è¦ï¼Œåº”è¯¥åŸºäºæœ€é¢‘ç¹çš„æŸ¥è¯¢æ¨¡å¼æ¥è®¾è®¡ã€‚"</p>
</blockquote>
<hr>
<h2 id="54-æŸ¥è¯¢ä¼˜åŒ–-1">5.4 æŸ¥è¯¢ä¼˜åŒ– </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-39">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>æŸ¥è¯¢ä¼˜åŒ–æ˜¯æ•°æ®åº“æ€§èƒ½çš„æ ¸å¿ƒï¼ŒSparkle é‡‡ç”¨å¤šç§ç­–ç•¥é¿å… <strong>N+1 é—®é¢˜</strong> å’Œä½æ•ˆæŸ¥è¯¢ï¼š</p>
<ul>
<li><strong>JOIN ä¼˜åŒ–</strong>: ä¸€æ¬¡æ€§æ‹‰å–å…³è”æ•°æ®</li>
<li><strong>è¦†ç›–ç´¢å¼•</strong>: é¿å…å›è¡¨</li>
<li><strong>æ‰¹é‡æ“ä½œ</strong>: å‡å°‘ç½‘ç»œå¾€è¿”</li>
<li><strong>æŸ¥è¯¢è®¡åˆ’åˆ†æ</strong>: EXPLAIN ANALYZE ä¼˜åŒ–</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-40">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>N+1 é—®é¢˜ç¤ºä¾‹ä¸ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># âŒ é”™è¯¯ç¤ºèŒƒï¼šN+1 é—®é¢˜</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_knowledge_graph_bad</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>  <span class="token comment"># 1æ¬¡æŸ¥è¯¢</span>
    nodes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">:</span>  <span class="token comment"># å‡è®¾æœ‰100ä¸ªèŠ‚ç‚¹</span>
        <span class="token comment"># Næ¬¡æŸ¥è¯¢ï¼</span>
        relations <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Relation<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>node_id<span class="token operator">=</span>node<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        nodes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">'node'</span><span class="token punctuation">:</span> node<span class="token punctuation">,</span>
            <span class="token string">'relations'</span><span class="token punctuation">:</span> relations
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> nodes
<span class="token comment"># æ€»è®¡ï¼š1 + 100 = 101æ¬¡æŸ¥è¯¢ï¼</span>

<span class="token comment"># âœ… ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šJOIN åˆå¹¶</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_knowledge_graph_joined</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ä½¿ç”¨ SQLAlchemy çš„ joinedload</span>
    <span class="token keyword keyword-from">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword keyword-import">import</span> joinedload
    
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>options<span class="token punctuation">(</span>
        joinedload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>nodes<span class="token punctuation">)</span><span class="token punctuation">.</span>joinedload<span class="token punctuation">(</span>Node<span class="token punctuation">.</span>relations<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
    
    <span class="token comment"># æ•°æ®å·²åœ¨å•æ¬¡æŸ¥è¯¢ä¸­åŠ è½½</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string">'node'</span><span class="token punctuation">:</span> node<span class="token punctuation">,</span>
        <span class="token string">'relations'</span><span class="token punctuation">:</span> node<span class="token punctuation">.</span>relations
    <span class="token punctuation">}</span> <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">]</span>
<span class="token comment"># æ€»è®¡ï¼š1æ¬¡æŸ¥è¯¢</span>

<span class="token comment"># âœ… ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šæ‰¹é‡æŸ¥è¯¢</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_knowledge_graph_batch</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
    node_ids <span class="token operator">=</span> <span class="token punctuation">[</span>node<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">]</span>
    
    <span class="token comment"># 1æ¬¡æ‰¹é‡æŸ¥è¯¢</span>
    relations <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Relation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
        Relation<span class="token punctuation">.</span>node_id<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>node_ids<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># å†…å­˜ä¸­å…³è”</span>
    relations_by_node <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-for">for</span> rel <span class="token keyword keyword-in">in</span> relations<span class="token punctuation">:</span>
        relations_by_node<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>rel<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>rel<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string">'node'</span><span class="token punctuation">:</span> node<span class="token punctuation">,</span>
        <span class="token string">'relations'</span><span class="token punctuation">:</span> relations_by_node<span class="token punctuation">.</span>get<span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword keyword-for">for</span> node <span class="token keyword keyword-in">in</span> user<span class="token punctuation">.</span>nodes<span class="token punctuation">]</span>
<span class="token comment"># æ€»è®¡ï¼š2æ¬¡æŸ¥è¯¢</span>

<span class="token comment"># âœ… ä¼˜åŒ–æ–¹æ¡ˆ3ï¼šä½¿ç”¨ GraphQL é£æ ¼çš„å­—æ®µé€‰æ‹©å™¨</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_data</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> fields<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    query <span class="token operator">=</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-if">if</span> <span class="token string">'nodes'</span> <span class="token keyword keyword-in">in</span> fields<span class="token punctuation">:</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span>options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>nodes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">'profile'</span> <span class="token keyword keyword-in">in</span> fields<span class="token punctuation">:</span>
        query <span class="token operator">=</span> query<span class="token punctuation">.</span>options<span class="token punctuation">(</span>joinedload<span class="token punctuation">(</span>User<span class="token punctuation">.</span>profile<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-return">return</span> query<span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
</code></pre><p><strong>SQL å±‚é¢çš„æŸ¥è¯¢ä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- ä¼˜åŒ–å‰ï¼šå¤šæ¬¡æŸ¥è¯¢</span>
<span class="token comment">-- æŸ¥è¯¢1: è·å–ç”¨æˆ·</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> users <span class="token keyword keyword-WHERE">WHERE</span> id <span class="token operator">=</span> <span class="token string">'123'</span><span class="token punctuation">;</span>

<span class="token comment">-- æŸ¥è¯¢2: è·å–ç”¨æˆ·çš„å­¦ä¹ è®°å½•ï¼ˆNæ¬¡ï¼‰</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records <span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> node_id <span class="token operator">=</span> <span class="token string">'node1'</span><span class="token punctuation">;</span>
<span class="token keyword keyword-SELECT">SELECT</span> <span class="token operator">*</span> <span class="token keyword keyword-FROM">FROM</span> study_records <span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span> <span class="token operator">AND</span> node_id <span class="token operator">=</span> <span class="token string">'node2'</span><span class="token punctuation">;</span>
<span class="token comment">-- ... Næ¬¡</span>

<span class="token comment">-- ä¼˜åŒ–åï¼šå•æ¬¡ JOIN æŸ¥è¯¢</span>
<span class="token keyword keyword-SELECT">SELECT</span> 
    u<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>study_minutes<span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>mastery_delta<span class="token punctuation">,</span>
    sr<span class="token punctuation">.</span>completed_at<span class="token punctuation">,</span>
    kn<span class="token punctuation">.</span>name <span class="token keyword keyword-as">as</span> node_name<span class="token punctuation">,</span>
    kn<span class="token punctuation">.</span>category
<span class="token keyword keyword-FROM">FROM</span> users u
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> study_records sr <span class="token keyword keyword-ON">ON</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> sr<span class="token punctuation">.</span>user_id
<span class="token keyword keyword-LEFT">LEFT</span> <span class="token keyword keyword-JOIN">JOIN</span> knowledge_nodes kn <span class="token keyword keyword-ON">ON</span> sr<span class="token punctuation">.</span>node_id <span class="token operator">=</span> kn<span class="token punctuation">.</span>id
<span class="token keyword keyword-WHERE">WHERE</span> u<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">'123'</span>
  <span class="token operator">AND</span> sr<span class="token punctuation">.</span>completed_at <span class="token operator">&gt;=</span> <span class="token keyword keyword-CURRENT_DATE">CURRENT_DATE</span> <span class="token operator">-</span> <span class="token keyword keyword-INTERVAL">INTERVAL</span> <span class="token string">'7 days'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> sr<span class="token punctuation">.</span>completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- ä½¿ç”¨è¦†ç›–ç´¢å¼•è¿›ä¸€æ­¥ä¼˜åŒ–</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_covering
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span>node_id<span class="token punctuation">,</span> study_minutes<span class="token punctuation">,</span> mastery_delta<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ä¼˜åŒ–åçš„æŸ¥è¯¢è®¡åˆ’</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> node_id<span class="token punctuation">,</span> mastery_delta
<span class="token keyword keyword-FROM">FROM</span> study_records
<span class="token keyword keyword-WHERE">WHERE</span> user_id <span class="token operator">=</span> <span class="token string">'123'</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> completed_at <span class="token keyword keyword-DESC">DESC</span>
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- ç»“æœï¼šIndex Scan using idx_study_records_covering</span>
<span class="token comment">-- æ— éœ€å›è¡¨ï¼Œæ€§èƒ½æå‡ 5-10 å€</span>
</code></pre><p><strong>æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># âŒ ä½æ•ˆçš„é€æ¡æ’å…¥</span>
<span class="token keyword keyword-for">for</span> record <span class="token keyword keyword-in">in</span> study_records<span class="token punctuation">:</span>
    <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
        <span class="token string">"INSERT INTO study_records (user_id, node_id, minutes) VALUES (?, ?, ?)"</span><span class="token punctuation">,</span>
        record<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> record<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span> record<span class="token punctuation">.</span>minutes
    <span class="token punctuation">)</span>
<span class="token comment"># æ‰§è¡Œ N æ¬¡ç½‘ç»œå¾€è¿”</span>

<span class="token comment"># âœ… é«˜æ•ˆçš„æ‰¹é‡æ’å…¥</span>
<span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute_many<span class="token punctuation">(</span>
    <span class="token string">"INSERT INTO study_records (user_id, node_id, minutes) VALUES (?, ?, ?)"</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>node_id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>minutes<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> r <span class="token keyword keyword-in">in</span> study_records<span class="token punctuation">]</span>
<span class="token punctuation">)</span>
<span class="token comment"># æ‰§è¡Œ 1 æ¬¡ç½‘ç»œå¾€è¿”</span>

<span class="token comment"># âœ… ä½¿ç”¨ COPY å‘½ä»¤ï¼ˆæœ€å¿«ï¼‰</span>
<span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
    COPY study_records (user_id, node_id, minutes) 
    FROM STDIN WITH CSV
"""</span><span class="token punctuation">,</span> csv_data<span class="token punctuation">)</span>
<span class="token comment"># æ¯” INSERT å¿« 10-20 å€</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-35">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>N+1 é—®é¢˜çš„æœ¬è´¨:</strong></p>
<ul>
<li><strong>ç½‘ç»œå¾€è¿”</strong>: æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦ç½‘ç»œ RTTï¼Œç´¯ç§¯å¼€é”€å·¨å¤§</li>
<li><strong>æ•°æ®åº“è´Ÿè½½</strong>: æ¯æ¡ SQL éƒ½éœ€è¦è§£æã€æ‰§è¡Œã€è¿”å›</li>
<li><strong>ä»£ç å¤æ‚åº¦</strong>: å¾ªç¯ä¸­çš„æŸ¥è¯¢éš¾ä»¥ç»´æŠ¤å’Œä¼˜åŒ–</li>
</ul>
<p><strong>è§£å†³ç­–ç•¥çš„æƒè¡¡:</strong></p>
<ol>
<li>
<p><strong>JOIN åˆå¹¶</strong>:</p>
<ul>
<li>âœ… ä¼˜ç‚¹: å•æ¬¡æŸ¥è¯¢ï¼Œä»£ç ç®€æ´</li>
<li>âŒ ç¼ºç‚¹: å¯èƒ½äº§ç”Ÿç¬›å¡å°”ç§¯ï¼Œæ•°æ®å†—ä½™</li>
</ul>
</li>
<li>
<p><strong>æ‰¹é‡æŸ¥è¯¢</strong>:</p>
<ul>
<li>âœ… ä¼˜ç‚¹: å‡å°‘æŸ¥è¯¢æ¬¡æ•°ï¼Œæ§åˆ¶æ•°æ®é‡</li>
<li>âŒ ç¼ºç‚¹: éœ€è¦å†…å­˜å…³è”ï¼Œä»£ç ç¨å¤æ‚</li>
</ul>
</li>
<li>
<p><strong>å­—æ®µé€‰æ‹©å™¨</strong>:</p>
<ul>
<li>âœ… ä¼˜ç‚¹: æŒ‰éœ€åŠ è½½ï¼Œæœ€çµæ´»</li>
<li>âŒ ç¼ºç‚¹: å®ç°å¤æ‚ï¼Œéœ€è¦å°è£…</li>
</ul>
</li>
</ol>
<p><strong>æŸ¥è¯¢ä¼˜åŒ–çš„å±‚æ¬¡:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>åº”ç”¨å±‚ (Python)
    â†“ ä¼˜åŒ–: æ‰¹é‡æŸ¥è¯¢ã€å­—æ®µé€‰æ‹©
ORM å±‚ (SQLAlchemy)
    â†“ ä¼˜åŒ–: joinedloadã€subqueryload
SQL å±‚ (PostgreSQL)
    â†“ ä¼˜åŒ–: ç´¢å¼•ã€åˆ†åŒºã€è¦†ç›–ç´¢å¼•
å­˜å‚¨å±‚ (ç£ç›˜)
    â†“ ä¼˜åŒ–: SSDã€RAIDã€å†…å­˜
</code></pre><h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-35">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•æ£€æµ‹å’Œè§£å†³ N+1 é—®é¢˜ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ£€æµ‹</strong>: æ…¢æŸ¥è¯¢æ—¥å¿—ã€APM å·¥å…·ã€æ‰‹åŠ¨è®¡æ•°</li>
<li><strong>è§£å†³</strong>: JOINã€æ‰¹é‡æŸ¥è¯¢ã€é¢„åŠ è½½</li>
<li><strong>é¢„é˜²</strong>: ä»£ç å®¡æŸ¥ã€æ€§èƒ½æµ‹è¯•ã€ORM æœ€ä½³å®è·µ</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æ£€æµ‹ N+1 é—®é¢˜æœ‰ä¸‰ç§æ–¹æ³•ï¼šç¬¬ä¸€ï¼ŒæŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå¦‚æœå‘ç°å¤§é‡ç›¸ä¼¼æŸ¥è¯¢ï¼Œå¯èƒ½æ˜¯ N+1ï¼›ç¬¬äºŒï¼Œä½¿ç”¨ APM å·¥å…·å¦‚ New Relicï¼Œå®ƒä¼šè‡ªåŠ¨æ ‡è®° N+1ï¼›ç¬¬ä¸‰ï¼Œæ‰‹åŠ¨åœ¨ä»£ç ä¸­è®¡æ•°æŸ¥è¯¢æ¬¡æ•°ã€‚è§£å†³æ–¹æ³•ï¼šå¯¹äº ORMï¼Œä½¿ç”¨ eager loadingï¼ˆå¦‚ SQLAlchemy çš„ joinedloadï¼‰ï¼›å¯¹äºå¤æ‚åœºæ™¯ï¼Œä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼›å¯¹äºåªè¯»åœºæ™¯ï¼Œä½¿ç”¨æ•°æ®åº“è§†å›¾ã€‚é¢„é˜²æ–¹é¢ï¼Œæˆ‘ä»¬åˆ¶å®šäº†ä»£ç è§„èŒƒï¼Œè¦æ±‚æ‰€æœ‰æ•°æ®åº“è®¿é—®å¿…é¡»é€šè¿‡å°è£…å¥½çš„ Repository å±‚ï¼Œå¹¶åœ¨ Code Review æ—¶ç‰¹åˆ«æ³¨æ„å¾ªç¯ä¸­çš„æ•°æ®åº“æ“ä½œã€‚"</p>
</blockquote>
<hr>
<h1 id="å…­-æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£-1">å…­ã€æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£ </h1>
<h2 id="61-çŸ¥è¯†æ˜Ÿå›¾-knowledge-galaxy-1">6.1 çŸ¥è¯†æ˜Ÿå›¾ (Knowledge Galaxy) </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-40">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>çŸ¥è¯†æ˜Ÿå›¾æ˜¯ Sparkle çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œé€šè¿‡ <strong>ç®—æ³•é©±åŠ¨</strong> å’Œ <strong>å›¾è®¡ç®—</strong> å®ç°ä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„ï¼š</p>
<ul>
<li><strong>æŒæ¡åº¦ç®—æ³•</strong>: å¤šå› å­åŠ æƒè®¡ç®—ï¼Œè¾¹é™…æ•ˆç”¨é€’å‡</li>
<li><strong>è‰¾å®¾æµ©æ–¯æ›²çº¿</strong>: é—´éš”é‡å¤ç®—æ³•ï¼Œç§‘å­¦å®‰æ’å¤ä¹ </li>
<li><strong>æ··åˆæœç´¢</strong>: å‘é‡ + å…³é”®è¯ + å›¾å…³ç³»</li>
<li><strong>çŸ¥è¯†å›¾è°±è‡ªç”Ÿé•¿</strong>: LLM è‡ªåŠ¨æ‹“å±•çŸ¥è¯†ç‚¹</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-41">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<p><strong>æŒæ¡åº¦ç®—æ³•ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/galaxy_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">GalaxyService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    çŸ¥è¯†æ˜Ÿå›¾æ ¸å¿ƒæœåŠ¡
    èŒè´£ï¼šèŠ‚ç‚¹ç®¡ç†ã€æŒæ¡åº¦è®¡ç®—ã€å…³ç³»ç»´æŠ¤ã€RAG æ£€ç´¢
    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db<span class="token punctuation">,</span> redis<span class="token punctuation">,</span> llm_service<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> db
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis
        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> llm_service

        <span class="token comment"># å¸¸é‡é…ç½®</span>
        self<span class="token punctuation">.</span>BASE_MASTERY_POINTS <span class="token operator">=</span> <span class="token number">5.0</span>
        self<span class="token punctuation">.</span>MAX_MASTERY <span class="token operator">=</span> <span class="token number">100.0</span>
        self<span class="token punctuation">.</span>MEMORY_HALF_LIFE_DAYS <span class="token operator">=</span> <span class="token number">7.0</span>
        self<span class="token punctuation">.</span>DECAY_THRESHOLD <span class="token operator">=</span> <span class="token number">10.0</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">spark_node</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                        study_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> SparkResult<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        ç‚¹äº®çŸ¥è¯†ç‚¹ - æ ¸å¿ƒå­¦ä¹ æµç¨‹
        """</span>
        <span class="token comment"># ========== ç¬¬1æ­¥ï¼šè·å–æˆ–åˆ›å»ºæŒæ¡åº¦çŠ¶æ€ ==========</span>
        status <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_or_create_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> node_id<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬2æ­¥ï¼šæŒæ¡åº¦ç®—æ³• (Mastery Algorithm) ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šå¤šå› å­æƒé‡ã€‚ä¸æ˜¯ç®€å•åŠ åˆ†ï¼Œè€Œæ˜¯æ ¹æ®ï¼šå­¦ä¹ æ—¶é•¿ã€èŠ‚ç‚¹é‡è¦åº¦ã€å­¦ä¹ æ¬¡æ•°ã€æ—¶é—´æ•ˆç‡ ç»¼åˆè®¡ç®—ã€‚</span>
        mastery_delta <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_mastery_delta<span class="token punctuation">(</span>
            study_minutes<span class="token punctuation">,</span>
            node<span class="token punctuation">.</span>importance_level<span class="token punctuation">,</span>
            status<span class="token punctuation">.</span>study_count
        <span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬3æ­¥ï¼šçŠ¶æ€æ›´æ–°ä¸è§£é” ==========</span>
        status<span class="token punctuation">.</span>mastery_score <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span>mastery_score <span class="token operator">+</span> mastery_delta<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
        status<span class="token punctuation">.</span>study_count <span class="token operator">+=</span> <span class="token number">1</span>
        status<span class="token punctuation">.</span>last_study_at <span class="token operator">=</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬4æ­¥ï¼šè‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’ ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šé—´éš”é‡å¤ (Spaced Repetition)ã€‚æ ¹æ® Ebbinghaus æ›²çº¿ï¼ŒåŠ¨æ€è®¡ç®—è¯¥çŸ¥è¯†ç‚¹çš„ä¸‹ä¸€æ¬¡å¤ä¹ æ—¶é—´ã€‚</span>
        <span class="token keyword keyword-if">if</span> status<span class="token punctuation">.</span>mastery_score <span class="token operator">&gt;=</span> <span class="token number">60</span><span class="token punctuation">:</span>
            status<span class="token punctuation">.</span>next_review_at <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_next_review<span class="token punctuation">(</span>
                status<span class="token punctuation">.</span>study_count<span class="token punctuation">,</span>
                status<span class="token punctuation">.</span>mastery_score
            <span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬5æ­¥ï¼šè§¦å‘è‡ªåŠ¨åŒ–å·¥ä½œæµ ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šå¼‚æ­¥æ‹“å±•ã€‚å¦‚æœå­¦ä¹ æ¬¡æ•°è¾¾æ ‡ï¼ˆå¦‚ 2 æ¬¡ï¼‰ï¼Œè§¦å‘ ExpansionWorker è¿›è¡ŒçŸ¥è¯†å›¾è°±è‡ªåŠ¨æ‹“æ‰‘ã€‚</span>
        <span class="token keyword keyword-if">if</span> status<span class="token punctuation">.</span>study_count <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_queue_expansion<span class="token punctuation">(</span>node_id<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> SparkResult<span class="token punctuation">(</span>
            mastery_delta<span class="token operator">=</span>mastery_delta<span class="token punctuation">,</span>
            new_mastery<span class="token operator">=</span>status<span class="token punctuation">.</span>mastery_score<span class="token punctuation">,</span>
            next_review<span class="token operator">=</span>status<span class="token punctuation">.</span>next_review_at
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_calculate_mastery_delta</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> study_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                                importance<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> study_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        æŒæ¡åº¦å¢é‡è®¡ç®—
        å…¬å¼ï¼šåŸºç¡€åˆ† Ã— é‡è¦åº¦ç³»æ•° Ã— æ¬¡æ•°è¡°å‡ Ã— æ—¶é—´ç³»æ•°
        """</span>
        <span class="token comment"># åŸºç¡€åˆ†ï¼šæ¯åˆ†é’Ÿå­¦ä¹ å¢åŠ  5 ç‚¹</span>
        base <span class="token operator">=</span> study_minutes <span class="token operator">*</span> self<span class="token punctuation">.</span>BASE_MASTERY_POINTS

        <span class="token comment"># é‡è¦åº¦ç³»æ•°ï¼š1-5 çº§ï¼Œæœ€é«˜ 2.0 å€</span>
        importance_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>importance <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.25</span>

        <span class="token comment"># æ¬¡æ•°è¡°å‡ï¼šå­¦ä¹ æ¬¡æ•°è¶Šå¤šï¼Œå¢é‡è¶Šå°</span>
        count_factor <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> study_count <span class="token operator">*</span> <span class="token number">0.3</span><span class="token punctuation">)</span>

        <span class="token comment"># æ—¶é—´ç³»æ•°ï¼šå­¦ä¹ æ—¶é—´è¶Šé•¿ï¼Œæ•ˆç‡è¶Šé«˜ï¼ˆä½†æœ‰ä¸Šé™ï¼‰</span>
        time_factor <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>log10<span class="token punctuation">(</span>study_minutes <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.2</span>

        delta <span class="token operator">=</span> base <span class="token operator">*</span> importance_factor <span class="token operator">*</span> count_factor <span class="token operator">*</span> time_factor

        <span class="token keyword keyword-return">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>delta<span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span>  <span class="token comment"># å•æ¬¡ä¸Šé™ 20 ç‚¹</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_calculate_next_review</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> study_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> mastery<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> datetime<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿è®¡ç®—å¤ä¹ æ—¶é—´
        åŸºäº Ebbinghaus forgetting curve
        """</span>
        <span class="token comment"># åŸºç¡€é—´éš”ï¼ˆå¤©ï¼‰</span>
        <span class="token keyword keyword-if">if</span> study_count <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword keyword-elif">elif</span> study_count <span class="token operator">&lt;=</span> <span class="token number">4</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">3</span>
        <span class="token keyword keyword-elif">elif</span> study_count <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">7</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            base_days <span class="token operator">=</span> <span class="token number">14</span>

        <span class="token comment"># æŒæ¡åº¦å½±å“ï¼šæŒæ¡åº¦è¶Šé«˜ï¼Œé—´éš”è¶Šé•¿</span>
        mastery_factor <span class="token operator">=</span> mastery <span class="token operator">/</span> <span class="token number">50.0</span>  <span class="token comment"># 0-2 å€</span>

        <span class="token comment"># éšæœºå› å­ï¼šé¿å…æ‰€æœ‰ç”¨æˆ·åŒæ—¶å¤ä¹ </span>
        random_factor <span class="token operator">=</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.8</span><span class="token punctuation">,</span> <span class="token number">1.2</span><span class="token punctuation">)</span>

        days <span class="token operator">=</span> base_days <span class="token operator">*</span> mastery_factor <span class="token operator">*</span> random_factor

        <span class="token keyword keyword-return">return</span> datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>days<span class="token punctuation">)</span>
</code></pre><p><strong>æ··åˆæœç´¢å®ç°ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">hybrid_search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                       vector_query<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                       limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>KnowledgeNode<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    RAG v2.0 æ··åˆæœç´¢
    ç»“åˆï¼šå‘é‡æœç´¢ + å…³é”®è¯æœç´¢ + ç”¨æˆ·çŠ¶æ€è¿‡æ»¤
    """</span>
    <span class="token comment"># 1. å‡†å¤‡æŸ¥è¯¢å‘é‡</span>
    query_embedding <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>get_embedding<span class="token punctuation">(</span>
        vector_query <span class="token keyword keyword-if">if</span> vector_query <span class="token keyword keyword-else">else</span> query
    <span class="token punctuation">)</span>

    <span class="token comment"># 2. å¹¶è¡Œæ‰§è¡Œå‘é‡æœç´¢å’Œå…³é”®è¯æœç´¢</span>
    vector_task <span class="token operator">=</span> self<span class="token punctuation">.</span>_vector_search<span class="token punctuation">(</span>query_embedding<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    keyword_task <span class="token operator">=</span> self<span class="token punctuation">.</span>_keyword_search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> limit <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>

    vector_results<span class="token punctuation">,</span> keyword_results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>
        vector_task<span class="token punctuation">,</span> keyword_task
    <span class="token punctuation">)</span>

    <span class="token comment"># 3. RRF (Reciprocal Rank Fusion) èåˆ</span>
    fused <span class="token operator">=</span> self<span class="token punctuation">.</span>_reciprocal_rank_fusion<span class="token punctuation">(</span>
        vector_results<span class="token punctuation">,</span>
        keyword_results<span class="token punctuation">,</span>
        weight_vector<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
        weight_keyword<span class="token operator">=</span><span class="token number">0.3</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 4. é‡æ’åºï¼ˆRe-rankingï¼‰</span>
    reranked <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_rerank<span class="token punctuation">(</span>query<span class="token punctuation">,</span> fused<span class="token punctuation">,</span> limit<span class="token punctuation">)</span>

    <span class="token comment"># 5. è·å–å®Œæ•´èŠ‚ç‚¹å¹¶è¿‡æ»¤</span>
    nodes <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_nodes_by_ids<span class="token punctuation">(</span><span class="token punctuation">[</span>r<span class="token punctuation">.</span>node_id <span class="token keyword keyword-for">for</span> r <span class="token keyword keyword-in">in</span> reranked<span class="token punctuation">]</span><span class="token punctuation">)</span>
    filtered <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_filter_by_user_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> nodes<span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> filtered

<span class="token keyword keyword-def">def</span> <span class="token function">_reciprocal_rank_fusion</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vector_results<span class="token punctuation">,</span> keyword_results<span class="token punctuation">,</span>
                           weight_vector<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> weight_keyword<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""RRF èåˆç®—æ³•"""</span>
    scores <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment"># å‘é‡ç»“æœ</span>
    <span class="token keyword keyword-for">for</span> rank<span class="token punctuation">,</span> result <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>vector_results<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        scores<span class="token punctuation">[</span>result<span class="token punctuation">.</span>node_id<span class="token punctuation">]</span> <span class="token operator">=</span> weight_vector <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rank <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># å…³é”®è¯ç»“æœ</span>
    <span class="token keyword keyword-for">for</span> rank<span class="token punctuation">,</span> result <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>keyword_results<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> result<span class="token punctuation">.</span>node_id <span class="token keyword keyword-in">in</span> scores<span class="token punctuation">:</span>
            scores<span class="token punctuation">[</span>result<span class="token punctuation">.</span>node_id<span class="token punctuation">]</span> <span class="token operator">+=</span> weight_keyword <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rank <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            scores<span class="token punctuation">[</span>result<span class="token punctuation">.</span>node_id<span class="token punctuation">]</span> <span class="token operator">=</span> weight_keyword <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>rank <span class="token operator">+</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># æ’åº</span>
    sorted_results <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>scores<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>FusedResult<span class="token punctuation">(</span>node_id<span class="token operator">=</span>k<span class="token punctuation">,</span> score<span class="token operator">=</span>v<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> k<span class="token punctuation">,</span> v <span class="token keyword keyword-in">in</span> sorted_results<span class="token punctuation">]</span>
</code></pre><p><strong>çŸ¥è¯†å›¾è°±è‡ªç”Ÿé•¿ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/expansion_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">ExpansionService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""LLM é©±åŠ¨çš„çŸ¥è¯†æ‹“å±•æœåŠ¡"""</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_expansion</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> node_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># ========== ç¬¬1æ­¥ï¼šLLM ç”Ÿæˆå…³è”å†…å®¹ ==========</span>
        <span class="token comment"># æ€æƒ³ï¼šè‡ªåŠ¨åŒ–æ‹“æ‰‘ã€‚è®© AI åˆ†æå½“å‰çŸ¥è¯†ç‚¹ï¼Œè‡ªåŠ¨ç”Ÿæˆå­çŸ¥è¯†ç‚¹å’Œç»ƒä¹ é¢˜ã€‚</span>
        expansion_result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_generate_expansion<span class="token punctuation">(</span>node<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬2æ­¥ï¼šåŠ¨æ€æ„å»ºå›¾å…³ç³» ==========</span>
        <span class="token keyword keyword-for">for</span> child <span class="token keyword keyword-in">in</span> expansion_result<span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token comment"># è‡ªåŠ¨åˆ›å»ºå­èŠ‚ç‚¹å¹¶å»ºç«‹ parent_id å…³è”</span>
            child_node <span class="token operator">=</span> KnowledgeNode<span class="token punctuation">(</span>parent_id<span class="token operator">=</span>node_id<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>child_node<span class="token punctuation">)</span>
            
            <span class="token comment"># ========== ç¬¬3æ­¥ï¼šå»ºç«‹è¯­ä¹‰è¾¹ (Edge) ==========</span>
            <span class="token comment"># æ€æƒ³ï¼šçŸ¥è¯†å›¾è°±æ„å»ºã€‚ä¸ä»…æœ‰çˆ¶å­å…³ç³»ï¼Œè¿˜é€šè¿‡ NodeRelations è®°å½•å…³è”å¼ºåº¦ã€‚</span>
            relation <span class="token operator">=</span> NodeRelations<span class="token punctuation">(</span>
                source_node_id<span class="token operator">=</span>node_id<span class="token punctuation">,</span>
                target_node_id<span class="token operator">=</span>child_node<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                relation_type<span class="token operator">=</span><span class="token string">'child'</span><span class="token punctuation">,</span>
                strength<span class="token operator">=</span>expansion_result<span class="token punctuation">[</span><span class="token string">'relevance_score'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>relation<span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-36">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>æŒæ¡åº¦ç®—æ³•çš„è®¾è®¡å“²å­¦:</strong></p>
<ul>
<li><strong>è¾¹é™…æ•ˆç”¨é€’å‡</strong>: å­¦å¾—è¶Šå¤šï¼Œå•æ¬¡æ”¶ç›Šè¶Šå°ï¼Œé¼“åŠ±æ¢ç´¢æ–°é¢†åŸŸ</li>
<li><strong>å¤šå› å­åŠ æƒ</strong>: ä¸åªçœ‹æ—¶é•¿ï¼Œè¿˜è¦çœ‹é‡è¦åº¦ã€æ¬¡æ•°ã€æ•ˆç‡</li>
<li><strong>å•æ¬¡ä¸Šé™</strong>: é˜²æ­¢åˆ·åˆ†ï¼Œä¿è¯å…¬å¹³æ€§</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ ¹æ®ç”¨æˆ·å†å²åŠ¨æ€è°ƒæ•´</li>
</ul>
<p><strong>è‰¾å®¾æµ©æ–¯ç®—æ³•çš„ç§‘å­¦æ€§:</strong></p>
<ul>
<li><strong>é—å¿˜æ›²çº¿</strong>: äººç±»è®°å¿†éšæ—¶é—´æŒ‡æ•°è¡°å‡</li>
<li><strong>é—´éš”é‡å¤</strong>: åœ¨é—å¿˜ä¸´ç•Œç‚¹å¤ä¹ ï¼Œå¼ºåŒ–è®°å¿†</li>
<li><strong>åŠ¨æ€è°ƒæ•´</strong>: æ ¹æ®æŒæ¡åº¦è°ƒæ•´é—´éš”ï¼Œè¶Šç†Ÿç»ƒé—´éš”è¶Šé•¿</li>
<li><strong>éšæœºå› å­</strong>: é¿å…æ‰€æœ‰ç”¨æˆ·åŒæ—¶å¤ä¹ ï¼Œé€ æˆç³»ç»Ÿå‹åŠ›</li>
</ul>
<p><strong>æ··åˆæœç´¢çš„ä¼˜åŠ¿:</strong></p>
<ul>
<li><strong>å¬å›ç‡</strong>: å‘é‡æœç´¢å¬å›è¯­ä¹‰ç›¸å…³å†…å®¹</li>
<li><strong>å‡†ç¡®ç‡</strong>: å…³é”®è¯æœç´¢ç¡®ä¿ç²¾ç¡®åŒ¹é…</li>
<li><strong>ç›¸å…³æ€§</strong>: RRF èåˆå»é™¤ç»å¯¹åˆ†å€¼å¹²æ‰°</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: ç”¨æˆ·çŠ¶æ€è¿‡æ»¤ï¼Œæ¨èåˆé€‚éš¾åº¦</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-36">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: æŒæ¡åº¦ç®—æ³•å¦‚ä½•é˜²æ­¢ç”¨æˆ·åˆ·åˆ†ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>å•æ¬¡ä¸Šé™</strong>: æ¯æ¬¡å­¦ä¹ æœ€å¤šå¢åŠ  20 ç‚¹</li>
<li><strong>æ¬¡æ•°è¡°å‡</strong>: å­¦ä¹ æ¬¡æ•°è¶Šå¤šï¼Œå•æ¬¡æ”¶ç›Šè¶Šå°</li>
<li><strong>æ—¶é—´æ•ˆç‡</strong>: çŸ­æ—¶é—´åˆ·é¢˜æ”¶ç›Šé€’å‡</li>
<li><strong>éšæœºå› å­</strong>: é¿å…ç”¨æˆ·åŒæ—¶åˆ·åŒä¸€çŸ¥è¯†ç‚¹</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è®¾è®¡äº†å¤šå±‚é˜²åˆ·åˆ†æœºåˆ¶ï¼šç¬¬ä¸€ï¼Œå•æ¬¡å­¦ä¹ æœ€å¤šå¢åŠ  20 ç‚¹ï¼Œå³ä½¿å­¦ä¹  100 åˆ†é’Ÿä¹Ÿä¸ä¼šè¶…è¿‡ä¸Šé™ï¼›ç¬¬äºŒï¼Œæ¬¡æ•°è¡°å‡å› å­ï¼Œç¬¬ 10 æ¬¡å­¦ä¹ çš„æ”¶ç›Šåªæœ‰ç¬¬ 1 æ¬¡çš„ 1/4ï¼›ç¬¬ä¸‰ï¼Œæ—¶é—´æ•ˆç‡å¯¹æ•°å‡½æ•°ï¼Œ1 åˆ†é’Ÿå’Œ 10 åˆ†é’Ÿçš„æ•ˆç‡å·®å¼‚å¾ˆå¤§ï¼Œä½† 10 åˆ†é’Ÿå’Œ 100 åˆ†é’Ÿå·®å¼‚å¾ˆå°ï¼›ç¬¬å››ï¼Œéšæœºå› å­ï¼Œé¿å…ç”¨æˆ·åœ¨ç‰¹å®šæ—¶é—´ç‚¹åˆ·åˆ†ã€‚è¿™äº›æœºåˆ¶å…±åŒä¿è¯äº†ç³»ç»Ÿçš„å…¬å¹³æ€§å’Œå­¦ä¹ è´¨é‡ã€‚"</p>
</blockquote>
<hr>
<h2 id="62-ä»»åŠ¡ç®¡ç†-1">6.2 ä»»åŠ¡ç®¡ç† </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-41">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ä»»åŠ¡ç®¡ç†æ˜¯ Sparkle çš„ <strong>å·¥ä½œæµå¼•æ“</strong>ï¼Œæ”¯æŒ 6 ç§ä»»åŠ¡ç±»å‹å’Œè·¨åŸŸè”åŠ¨ï¼š</p>
<ul>
<li><strong>6 ç§ç±»å‹</strong>: å­¦ä¹ ã€è®­ç»ƒã€çº é”™ã€åæ€ã€ç¤¾äº¤ã€è§„åˆ’</li>
<li><strong>çŠ¶æ€æµè½¬</strong>: å¾…åŠ â†’ è¿›è¡Œä¸­ â†’ å·²å®Œæˆ/å·²æ”¾å¼ƒ</li>
<li><strong>è·¨åŸŸè”åŠ¨</strong>: ä»»åŠ¡å®Œæˆ â†’ æŒæ¡åº¦æ›´æ–° â†’ çŸ¥è¯†æ‹“å±•</li>
<li><strong>æ™ºèƒ½å»ºè®®</strong>: åŸºäºç”¨æˆ·çŠ¶æ€ç”Ÿæˆä»»åŠ¡æ¨è</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-42">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/task_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">TaskService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä»»åŠ¡ç®¡ç†æœåŠ¡"""</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">create_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_data<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Task<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""åˆ›å»ºä»»åŠ¡"""</span>
        <span class="token comment"># 1. éªŒè¯ä»»åŠ¡ç±»å‹</span>
        <span class="token keyword keyword-if">if</span> task_data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>TASK_TYPES<span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Invalid task type: </span><span class="token interpolation"><span class="token punctuation">{</span>task_data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 2. å¦‚æœå…³è”çŸ¥è¯†ç‚¹ï¼Œæ£€æŸ¥è§£é”çŠ¶æ€</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">'knowledge_node_id'</span> <span class="token keyword keyword-in">in</span> task_data<span class="token punctuation">:</span>
            node_status <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_node_unlocked<span class="token punctuation">(</span>
                user_id<span class="token punctuation">,</span>
                task_data<span class="token punctuation">[</span><span class="token string">'knowledge_node_id'</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> node_status<span class="token punctuation">:</span>
                <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Knowledge node not unlocked"</span><span class="token punctuation">)</span>

        <span class="token comment"># 3. åˆ›å»ºä»»åŠ¡</span>
        task <span class="token operator">=</span> Task<span class="token punctuation">(</span>
            user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
            title<span class="token operator">=</span>task_data<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token builtin">type</span><span class="token operator">=</span>task_data<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            tags<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'tags'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            estimated_minutes<span class="token operator">=</span>task_data<span class="token punctuation">[</span><span class="token string">'estimated_minutes'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            difficulty<span class="token operator">=</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'difficulty'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            knowledge_node_id<span class="token operator">=</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'knowledge_node_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            auto_expand_enabled<span class="token operator">=</span>task_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'auto_expand'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 4. å¦‚æœæ˜¯å­¦ä¹ ä»»åŠ¡ï¼Œè‡ªåŠ¨å…³è”å†²åˆºè®¡åˆ’</span>
        <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">'LEARNING'</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_link_to_sprint_plan<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> task

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
                          actual_minutes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TaskExecutionResult<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰§è¡Œä»»åŠ¡"""</span>
        <span class="token comment"># 1. è·å–ä»»åŠ¡</span>
        task <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>Task<span class="token punctuation">,</span> task_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> task <span class="token keyword keyword-or">or</span> task<span class="token punctuation">.</span>user_id <span class="token operator">!=</span> user_id<span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Task not found"</span><span class="token punctuation">)</span>

        <span class="token comment"># 2. æ›´æ–°ä»»åŠ¡çŠ¶æ€</span>
        task<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'COMPLETED'</span>

        <span class="token comment"># 3. å¦‚æœå…³è”çŸ¥è¯†ç‚¹ï¼Œæ›´æ–°æŒæ¡åº¦</span>
        mastery_delta <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">:</span>
            galaxy_service <span class="token operator">=</span> GalaxyService<span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">,</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> galaxy_service<span class="token punctuation">.</span>spark_node<span class="token punctuation">(</span>
                user_id<span class="token punctuation">,</span>
                task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">,</span>
                actual_minutes
            <span class="token punctuation">)</span>
            mastery_delta <span class="token operator">=</span> result<span class="token punctuation">.</span>mastery_delta

        <span class="token comment"># 4. è®°å½•æ‰§è¡Œå†å²</span>
        execution <span class="token operator">=</span> TaskExecution<span class="token punctuation">(</span>
            task_id<span class="token operator">=</span>task_id<span class="token punctuation">,</span>
            actual_minutes<span class="token operator">=</span>actual_minutes<span class="token punctuation">,</span>
            mastery_delta<span class="token operator">=</span>mastery_delta
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>execution<span class="token punctuation">)</span>

        <span class="token comment"># 5. è‡ªåŠ¨æ‰©å±•ï¼ˆå¦‚æœå¯ç”¨ï¼‰</span>
        <span class="token keyword keyword-if">if</span> task<span class="token punctuation">.</span>auto_expand_enabled <span class="token keyword keyword-and">and</span> task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">:</span>
            expansion_service <span class="token operator">=</span> ExpansionService<span class="token punctuation">(</span>self<span class="token punctuation">.</span>db<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-await">await</span> expansion_service<span class="token punctuation">.</span>queue_expansion<span class="token punctuation">(</span>
                task<span class="token punctuation">.</span>knowledge_node_id<span class="token punctuation">,</span>
                priority<span class="token operator">=</span><span class="token number">3</span>
            <span class="token punctuation">)</span>

        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> TaskExecutionResult<span class="token punctuation">(</span>
            task<span class="token operator">=</span>task<span class="token punctuation">,</span>
            mastery_delta<span class="token operator">=</span>mastery_delta<span class="token punctuation">,</span>
            expansion_queued<span class="token operator">=</span>task<span class="token punctuation">.</span>auto_expand_enabled
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">suggest_tasks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> context<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ™ºèƒ½ä»»åŠ¡å»ºè®®"""</span>
        <span class="token comment"># 1. åˆ†æç”¨æˆ·å½“å‰çŠ¶æ€</span>
        progress <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_learning_progress<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>

        <span class="token comment"># 2. åŸºäºçŠ¶æ€ç”Ÿæˆå»ºè®®</span>
        suggestions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment"># 2.1 éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹</span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'review_needed'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"TRAINING"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"å¤ä¹  </span><span class="token interpolation"><span class="token punctuation">{</span>progress<span class="token punctuation">[</span><span class="token string">'review_needed'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> ä¸ªçŸ¥è¯†ç‚¹"</span></span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"high"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># 2.2 é”™é¢˜ä¿®å¤</span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'error_count'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"ERROR_FIX"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"ä¿®å¤ </span><span class="token interpolation"><span class="token punctuation">{</span>progress<span class="token punctuation">[</span><span class="token string">'error_count'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> ä¸ªé”™é¢˜"</span></span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"high"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># 2.3 æ–°çŸ¥è¯†ç‚¹å­¦ä¹ </span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'unlocked_nodes'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"LEARNING"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"å­¦ä¹ æ–°çŸ¥è¯†ç‚¹"</span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"medium"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># 2.4 åæ€æ€»ç»“</span>
        <span class="token keyword keyword-if">if</span> progress<span class="token punctuation">[</span><span class="token string">'study_count'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"REFLECTION"</span><span class="token punctuation">,</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"æœ¬å‘¨å­¦ä¹ æ€»ç»“"</span><span class="token punctuation">,</span>
                <span class="token string">"estimated_minutes"</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token punctuation">,</span>
                <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"low"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> suggestions
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-37">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ä»»åŠ¡ç±»å‹çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>å­¦ä¹ ä»»åŠ¡</strong>: æ–°çŸ¥è¯†ç‚¹å­¦ä¹ ï¼Œå…³è”æŒæ¡åº¦</li>
<li><strong>è®­ç»ƒä»»åŠ¡</strong>: å¤ä¹ å·²å­¦çŸ¥è¯†ï¼Œå·©å›ºè®°å¿†</li>
<li><strong>çº é”™ä»»åŠ¡</strong>: é’ˆå¯¹é”™é¢˜ï¼Œç²¾å‡†æå‡</li>
<li><strong>åæ€ä»»åŠ¡</strong>: æ€»ç»“å½’çº³ï¼Œå½¢æˆçŸ¥è¯†ä½“ç³»</li>
<li><strong>ç¤¾äº¤ä»»åŠ¡</strong>: ä¸ä»–äººäº’åŠ¨ï¼Œä¿ƒè¿›å­¦ä¹ </li>
<li><strong>è§„åˆ’ä»»åŠ¡</strong>: åˆ¶å®šè®¡åˆ’ï¼Œæ˜ç¡®ç›®æ ‡</li>
</ul>
<p><strong>è·¨åŸŸè”åŠ¨çš„å®ç°:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ä»»åŠ¡å®Œæˆ â†’ æŒæ¡åº¦æ›´æ–° â†’ çŸ¥è¯†æ‹“å±• â†’ æ–°ä»»åŠ¡ç”Ÿæˆ
    â†“            â†“            â†“            â†“
  Task        Galaxy       Expansion    Suggestion
</code></pre><ul>
<li><strong>äº‹ä»¶é©±åŠ¨</strong>: ä»»åŠ¡å®Œæˆè§¦å‘æŒæ¡åº¦æ›´æ–°</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>: çŸ¥è¯†æ‹“å±•æ”¾å…¥é˜Ÿåˆ—ï¼Œä¸é˜»å¡ä¸»æµç¨‹</li>
<li><strong>é—­ç¯åé¦ˆ</strong>: æ–°çŸ¥è¯†è‡ªåŠ¨è½¬åŒ–ä¸ºæ–°ä»»åŠ¡</li>
</ul>
<p><strong>æ™ºèƒ½å»ºè®®çš„ç®—æ³•:</strong></p>
<ul>
<li><strong>ä¼˜å…ˆçº§</strong>: åŸºäºç´§æ€¥ç¨‹åº¦å’Œé‡è¦æ€§</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ ¹æ®ç”¨æˆ·çŠ¶æ€å’Œå†å²</li>
<li><strong>å¤šæ ·æ€§</strong>: ä¸åŒç±»å‹ä»»åŠ¡ç»„åˆ</li>
<li><strong>å¯è¡Œæ€§</strong>: è€ƒè™‘ç”¨æˆ·æ—¶é—´å’Œèƒ½åŠ›</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-37">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ä»»åŠ¡ç³»ç»Ÿå¦‚ä½•ä¿è¯å»ºè®®çš„ä¸ªæ€§åŒ–ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç”¨æˆ·ç”»åƒ</strong>: å­¦ä¹ è¿›åº¦ã€æ´»è·ƒæ—¶é—´ã€åå¥½</li>
<li><strong>å†å²æ•°æ®</strong>: è¿‡å¾€ä»»åŠ¡å®Œæˆæƒ…å†µ</li>
<li><strong>å®æ—¶çŠ¶æ€</strong>: å½“å‰æŒæ¡åº¦ã€é”™é¢˜åˆ†å¸ƒ</li>
<li><strong>ç®—æ³•æ¨¡å‹</strong>: åŸºäºè§„åˆ™ + æœºå™¨å­¦ä¹ </li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬çš„ä»»åŠ¡å»ºè®®ç³»ç»Ÿæ˜¯å¤šç»´åº¦çš„ã€‚é¦–å…ˆï¼Œåˆ†æç”¨æˆ·ç”»åƒï¼ŒåŒ…æ‹¬å­¦ä¹ è¿›åº¦ã€æ´»è·ƒæ—¶é—´æ®µã€åå¥½ç±»å‹ï¼›å…¶æ¬¡ï¼ŒæŸ¥çœ‹å†å²æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·æ“…é•¿é€‰æ‹©å“ªç§ä»»åŠ¡ã€å®Œæˆç‡å¦‚ä½•ï¼›ç¬¬ä¸‰ï¼Œå®æ—¶çŠ¶æ€ï¼Œå¦‚å½“å‰éœ€è¦å¤ä¹ çš„çŸ¥è¯†ç‚¹æ•°é‡ã€é”™é¢˜åˆ†å¸ƒï¼›æœ€åï¼Œç»“åˆä¼˜å…ˆçº§ç®—æ³•ï¼Œç´§æ€¥ä¸”é‡è¦çš„ä»»åŠ¡ä¼˜å…ˆæ¨èã€‚æœªæ¥æˆ‘ä»¬ä¼šå¼•å…¥æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Œæ ¹æ®ç”¨æˆ·åé¦ˆä¸æ–­ä¼˜åŒ–æ¨èç­–ç•¥ã€‚"</p>
</blockquote>
<hr>
<h2 id="63-æ™ºèƒ½æ¨é€ç³»ç»Ÿ-1">6.3 æ™ºèƒ½æ¨é€ç³»ç»Ÿ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-42">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>æ™ºèƒ½æ¨é€ç³»ç»Ÿæ˜¯ Sparkle çš„ <strong>ç”¨æˆ·è§¦è¾¾å¼•æ“</strong>ï¼Œé‡‡ç”¨ <strong>Persona ç­–ç•¥</strong> å’Œ <strong>æ¼æ–—è¯„ä¼°</strong>ï¼š</p>
<ul>
<li><strong>Persona ç­–ç•¥</strong>: å†²åˆºæé†’ã€è®°å¿†å”¤é†’ã€æ²‰ç¡å”¤é†’</li>
<li><strong>é¢‘ç‡æ§åˆ¶</strong>: æ¯æ—¥ä¸Šé™ã€å»é‡æ£€æŸ¥</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ—¶åŒºã€æ´»è·ƒæ—¶æ®µã€åå¥½é…ç½®</li>
<li><strong>æ¼æ–—è¯„ä¼°</strong>: ç´§æ€¥ &gt; éœ€è¦ &gt; å…´è¶£</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-43">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/services/push_service.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">PushService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ™ºèƒ½æ¨é€æœåŠ¡"""</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">send_smart_push</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> PushResult<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ™ºèƒ½æ¨é€ä¸»æµç¨‹"""</span>
        
        <span class="token comment"># ========== ç¬¬1æ­¥ï¼šè·å–ç”¨æˆ·é…ç½®å’ŒçŠ¶æ€ ==========</span>
        pref <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get_preferences<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> pref<span class="token punctuation">.</span>enable_curiosity<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"æ¨é€å·²å…³é—­"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬2æ­¥ï¼šé¢‘ç‡æ§åˆ¶ ==========</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_frequency<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> pref<span class="token punctuation">.</span>daily_cap<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"è¾¾åˆ°æ¯æ—¥ä¸Šé™"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬3æ­¥ï¼šPersona ç­–ç•¥é€‰æ‹© ==========</span>
        persona <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_select_persona<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> pref<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬4æ­¥ï¼šå†…å®¹ç”Ÿæˆä¸å»é‡ ==========</span>
        content <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_generate_content<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> persona<span class="token punctuation">)</span>
        content_hash <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_is_duplicate<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> content_hash<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"å†…å®¹å·²æ¨é€"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬5æ­¥ï¼šæ—¶æœºåˆ¤æ–­ï¼ˆæ´»è·ƒæ—¶æ®µï¼‰ ==========</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_is_active_time<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> pref<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>skipped<span class="token operator">=</span><span class="token string">"éæ´»è·ƒæ—¶æ®µ"</span><span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬6æ­¥ï¼šå®é™…æ¨é€ ==========</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_send_push<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> content<span class="token punctuation">,</span> persona<span class="token punctuation">)</span>

        <span class="token comment"># ========== ç¬¬7æ­¥ï¼šè®°å½•å†å² ==========</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_record_push_history<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> content_hash<span class="token punctuation">,</span> persona<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> PushResult<span class="token punctuation">(</span>success<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> content<span class="token operator">=</span>content<span class="token punctuation">,</span> persona<span class="token operator">=</span>persona<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_select_persona</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pref<span class="token punctuation">:</span> PushPreferences<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Persona ç­–ç•¥é€‰æ‹©"""</span>
        
        <span class="token comment"># è·å–ç”¨æˆ·çŠ¶æ€</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_user_state<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        
        <span class="token comment"># æ¼æ–—è¯„ä¼°</span>
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'sprint_deadline'</span><span class="token punctuation">]</span> <span class="token keyword keyword-and">and</span> state<span class="token punctuation">[</span><span class="token string">'sprint_progress'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0.8</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"sprint_reminder"</span>  <span class="token comment"># å†²åˆºæé†’</span>
        
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'review_needed'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"memory_wakeup"</span>  <span class="token comment"># è®°å¿†å”¤é†’</span>
        
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'last_active_days'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">7</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"sleep_wakeup"</span>  <span class="token comment"># æ²‰ç¡å”¤é†’</span>
        
        <span class="token keyword keyword-if">if</span> state<span class="token punctuation">[</span><span class="token string">'unlocked_nodes'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"curiosity"</span>  <span class="token comment"># æ¿€å‘å…´è¶£</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token string">"general"</span>  <span class="token comment"># é€šç”¨æ¨é€</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_generate_content</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> persona<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""åŸºäº Persona ç”Ÿæˆæ¨é€å†…å®¹"""</span>
        
        templates <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"sprint_reminder"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸš€ å†²åˆºæé†’ï¼šä½ çš„ {sprint_name} è¿˜å‰© {days} å¤©ï¼Œå½“å‰è¿›åº¦ {progress}%ï¼"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸ’ª åŠ æ²¹ï¼ä»Šå¤©å®Œæˆ 3 ä¸ªä»»åŠ¡å³å¯è¾¾æˆæœ¬å‘¨ç›®æ ‡ï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"memory_wakeup"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸ§  è®°å¿†å”¤é†’ï¼šä½ æœ‰ {count} ä¸ªçŸ¥è¯†ç‚¹éœ€è¦å¤ä¹ äº†ï¼"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸ’¡ è‰¾å®¾æµ©æ–¯æ›²çº¿æ˜¾ç¤ºï¼Œç°åœ¨æ˜¯æœ€ä½³å¤ä¹ æ—¶æœºï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"sleep_wakeup"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸ‘‹ æƒ³ä½ äº†ï¼å·²ç» {days} å¤©æ²¡å­¦ä¹ äº†ï¼Œå›æ¥ç»§ç»­æ¢ç´¢çŸ¥è¯†æ˜Ÿå›¾å§ï¼"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸŒŸ æ–°ä¸Šçº¿äº† {new_feature}ï¼Œç­‰ä½ æ¥ä½“éªŒï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"curiosity"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"âœ¨ å¥½å¥‡å¿ƒï¼šä½ çŸ¥é“ {related_concept} å’Œ {current_topic} çš„å…³ç³»å—ï¼Ÿ"</span><span class="token punctuation">,</span>
                <span class="token string">"ğŸ¯ è§£é”æ–°çŸ¥è¯†ç‚¹ï¼Œæ‰©å±•ä½ çš„çŸ¥è¯†æ˜Ÿå›¾ï¼"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"general"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"ğŸ“š ä»Šæ—¥æ¨èï¼šå­¦ä¹  {recommended_node}ï¼Œé¢„è®¡ 20 åˆ†é’Ÿ"</span><span class="token punctuation">,</span>
                <span class="token string">"âš¡ å°è´´å£«ï¼šè¿ç»­å­¦ä¹  3 å¤©å¯è·å¾—åŒå€ç§¯åˆ†ï¼"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment"># å¡«å……æ¨¡æ¿å˜é‡</span>
        template <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>templates<span class="token punctuation">.</span>get<span class="token punctuation">(</span>persona<span class="token punctuation">,</span> templates<span class="token punctuation">[</span><span class="token string">"general"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        variables <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_template_variables<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        content <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>variables<span class="token punctuation">)</span>
        
        <span class="token keyword keyword-return">return</span> content

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_check_frequency</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> daily_cap<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""é¢‘ç‡æ§åˆ¶"""</span>
        today <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>date<span class="token punctuation">(</span><span class="token punctuation">)</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"push_count:</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span>today<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        count <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        
        <span class="token keyword keyword-if">if</span> count <span class="token keyword keyword-and">and</span> <span class="token builtin">int</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> daily_cap<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_is_active_time</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pref<span class="token punctuation">:</span> PushPreferences<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ´»è·ƒæ—¶æ®µåˆ¤æ–­"""</span>
        now <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span>pytz<span class="token punctuation">.</span>timezone<span class="token punctuation">(</span>pref<span class="token punctuation">.</span>timezone<span class="token punctuation">)</span><span class="token punctuation">)</span>
        current_time <span class="token operator">=</span> now<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-for">for</span> slot <span class="token keyword keyword-in">in</span> pref<span class="token punctuation">.</span>active_slots<span class="token punctuation">:</span>
            start <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>slot<span class="token punctuation">[</span><span class="token string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'%H:%M'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            end <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>slot<span class="token punctuation">[</span><span class="token string">'end'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'%H:%M'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword keyword-if">if</span> start <span class="token operator">&lt;=</span> current_time <span class="token operator">&lt;=</span> end<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-38">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>Persona ç­–ç•¥çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>å†²åˆºæé†’</strong>: é’ˆå¯¹æœ‰æ˜ç¡®ç›®æ ‡çš„ç”¨æˆ·ï¼Œå¼ºè°ƒç´§è¿«æ„Ÿ</li>
<li><strong>è®°å¿†å”¤é†’</strong>: é’ˆå¯¹éœ€è¦å¤ä¹ çš„ç”¨æˆ·ï¼Œå¼ºè°ƒç§‘å­¦æ€§</li>
<li><strong>æ²‰ç¡å”¤é†’</strong>: é’ˆå¯¹æµå¤±ç”¨æˆ·ï¼Œå¼ºè°ƒæ–°å¥‡æ„Ÿå’Œå½’å±æ„Ÿ</li>
<li><strong>æ¿€å‘å…´è¶£</strong>: é’ˆå¯¹æ–°æ‰‹ï¼Œå¼ºè°ƒæ¢ç´¢å’Œå‘ç°</li>
</ul>
<p><strong>æ¼æ–—è¯„ä¼°çš„é€»è¾‘:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ç´§æ€¥? â†’ éœ€è¦? â†’ å…´è¶£? â†’ é€šç”¨
  â†“       â†“       â†“       â†“
å†²åˆº    å¤ä¹     æ¢ç´¢    æ¨è
</code></pre><ul>
<li><strong>ä¼˜å…ˆçº§</strong>: ç´§æ€¥ä»»åŠ¡ &gt; éœ€è¦å¤ä¹  &gt; å…´è¶£æ¢ç´¢ &gt; é€šç”¨æ¨è</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ¯ä¸ªå±‚çº§éƒ½åŸºäºç”¨æˆ·çŠ¶æ€</li>
<li><strong>è¦†ç›–ç‡</strong>: ç¡®ä¿æ¯ä¸ªç”¨æˆ·éƒ½èƒ½æ”¶åˆ°åˆé€‚çš„æ¨é€</li>
</ul>
<p><strong>é¢‘ç‡æ§åˆ¶çš„ç­–ç•¥:</strong></p>
<ul>
<li><strong>æ¯æ—¥ä¸Šé™</strong>: é˜²æ­¢è¿‡åº¦æ‰“æ‰°</li>
<li><strong>å»é‡æ£€æŸ¥</strong>: é¿å…é‡å¤å†…å®¹</li>
<li><strong>æ´»è·ƒæ—¶æ®µ</strong>: åªåœ¨ç”¨æˆ·å¯èƒ½æ´»è·ƒæ—¶æ¨é€</li>
<li><strong>æ™ºèƒ½é™çº§</strong>: è¾¾åˆ°ä¸Šé™åè‡ªåŠ¨é™çº§ä¸ºé™é»˜æ¨é€</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-38">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•é¿å…æ¨é€ç³»ç»Ÿæ‰“æ‰°ç”¨æˆ·ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>é¢‘ç‡é™åˆ¶</strong>: æ¯æ—¥ä¸Šé™ï¼Œå¯é…ç½®</li>
<li><strong>æ´»è·ƒæ—¶æ®µ</strong>: åªåœ¨ç”¨æˆ·æ´»è·ƒæ—¶æ¨é€</li>
<li><strong>ç”¨æˆ·åå¥½</strong>: ç”¨æˆ·å¯å…³é—­æˆ–è°ƒæ•´é¢‘ç‡</li>
<li><strong>å†…å®¹è´¨é‡</strong>: æ¨é€å¿…é¡»æœ‰ä»·å€¼ï¼Œé¿å…çº¯è¥é”€</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬ä»å››ä¸ªå±‚é¢é¿å…æ‰“æ‰°ç”¨æˆ·ï¼šç¬¬ä¸€ï¼Œä¸¥æ ¼çš„é¢‘ç‡æ§åˆ¶ï¼Œæ¯æ—¥æ¨é€ä¸Šé™é»˜è®¤ 3 æ¡ï¼Œç”¨æˆ·å¯è°ƒæ•´ï¼›ç¬¬äºŒï¼Œæ´»è·ƒæ—¶æ®µåˆ¤æ–­ï¼Œåªåœ¨ç”¨æˆ·é€šå¸¸æ´»è·ƒçš„æ—¶é—´æ®µæ¨é€ï¼›ç¬¬ä¸‰ï¼Œç”¨æˆ·åå¥½ï¼Œç”¨æˆ·å¯ä»¥å®Œå…¨å…³é—­æ¨é€æˆ–åªæ¥æ”¶ç‰¹å®šç±»å‹ï¼›ç¬¬å››ï¼Œå†…å®¹è´¨é‡ï¼Œæ¯æ¡æ¨é€éƒ½å¿…é¡»æœ‰å®é™…ä»·å€¼ï¼Œå¦‚å¤ä¹ æé†’ã€è¿›åº¦æ›´æ–°ï¼Œç»ä¸å‘é€çº¯è¥é”€å†…å®¹ã€‚æˆ‘ä»¬è¿˜ä¼šç›‘æ§ç”¨æˆ·åé¦ˆï¼Œå¦‚æœæŸç±»æ¨é€çš„å¿½ç•¥ç‡è¿‡é«˜ï¼Œä¼šè‡ªåŠ¨è°ƒæ•´ç­–ç•¥ã€‚"</p>
</blockquote>
<hr>
<h1 id="ä¸ƒ-ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º-1">ä¸ƒã€ç”Ÿäº§çº§ç‰¹æ€§ä¸å¢å¼º </h1>
<h2 id="71-ç†”æ–­å™¨-circuit-breaker-1">7.1 ç†”æ–­å™¨ (Circuit Breaker) </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-43">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ç†”æ–­å™¨æ˜¯ <strong>ç³»ç»Ÿè‡ªä¿æŠ¤æœºåˆ¶</strong>ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼š</p>
<ul>
<li><strong>çŠ¶æ€æœº</strong>: CLOSED â†’ OPEN â†’ HALF_OPEN</li>
<li><strong>æ•…éšœæ£€æµ‹</strong>: é”™è¯¯ç‡ã€è¶…æ—¶ç‡</li>
<li><strong>å¿«é€Ÿå¤±è´¥</strong>: ç†”æ–­çŠ¶æ€ä¸‹ç›´æ¥æ‹’ç»è¯·æ±‚</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: å†·å´åå°è¯•æ¢å¤</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-44">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/circuit_breaker.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">CircuitBreaker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    ç†”æ–­å™¨æ¨¡å¼ï¼šç³»ç»Ÿè‡ªä¿æŠ¤çš„â€œä¿é™©ä¸â€
    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> failure_threshold<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> recovery_timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>failure_threshold <span class="token operator">=</span> failure_threshold  <span class="token comment"># é”™è¯¯é˜ˆå€¼</span>
        self<span class="token punctuation">.</span>recovery_timeout <span class="token operator">=</span> recovery_timeout    <span class="token comment"># æ¢å¤è¶…æ—¶</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis<span class="token punctuation">.</span>from_url<span class="token punctuation">(</span><span class="token string">"redis://localhost:6379"</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">can_execute</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œ"""</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_state_from_redis<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> state <span class="token operator">==</span> <span class="token string">"OPEN"</span><span class="token punctuation">:</span>
            <span class="token comment"># æ£€æŸ¥å†·å´æ—¶é—´æ˜¯å¦å·²è¿‡</span>
            <span class="token keyword keyword-if">if</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>last_failure_time <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>recovery_timeout<span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"HALF_OPEN"</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>  <span class="token comment"># æ‹’ç»è¯·æ±‚</span>

        <span class="token keyword keyword-return">return</span> <span class="token boolean">True</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">record_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•æˆåŠŸ"""</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_state<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"HALF_OPEN"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"CLOSED"</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_reset_failure_count<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">record_failure</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•å¤±è´¥"""</span>
        failure_count <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_increment_failure_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-if">if</span> failure_count <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>failure_threshold<span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_set_state<span class="token punctuation">(</span><span class="token string">"OPEN"</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>last_failure_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_get_state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è·å–å½“å‰çŠ¶æ€"""</span>
        state <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"circuit_breaker:state"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> state<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> state <span class="token keyword keyword-else">else</span> <span class="token string">"CLOSED"</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_set_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®¾ç½®çŠ¶æ€"""</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"circuit_breaker:state"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> state <span class="token operator">==</span> <span class="token string">"OPEN"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">"circuit_breaker:last_failure"</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_increment_failure_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""å¢åŠ å¤±è´¥è®¡æ•°"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">"circuit_breaker:failure_count"</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_reset_failure_count</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""é‡ç½®å¤±è´¥è®¡æ•°"""</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string">"circuit_breaker:failure_count"</span><span class="token punctuation">)</span>
</code></pre><p><strong>åœ¨ç¼–æ’å™¨ä¸­çš„ä½¿ç”¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ç¬¬2æ­¥ï¼šæœåŠ¡ç†”æ–­å™¨æ£€æŸ¥</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>can_execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"CIRCUIT_BREAKER_OPEN"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"ç³»ç»Ÿè¿‡è½½"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>

    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ... å¤„ç†é€»è¾‘ ...</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>record_success<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>record_failure<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-raise">raise</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-39">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç†”æ–­å™¨çš„çŠ¶æ€æœº:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>CLOSED (æ­£å¸¸)
    â†“ é”™è¯¯ç‡ &gt; é˜ˆå€¼
OPEN (ç†”æ–­)
    â†“ å†·å´æ—¶é—´ç»“æŸ
HALF_OPEN (åŠå¼€)
    â†“ æˆåŠŸ/å¤±è´¥
CLOSED (æ¢å¤) / OPEN (å†æ¬¡ç†”æ–­)
</code></pre><p><strong>ç†”æ–­å™¨çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>å¿«é€Ÿå¤±è´¥</strong>: é¿å…é•¿æ—¶é—´ç­‰å¾…ï¼Œå‡å°‘èµ„æºæ¶ˆè€—</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: é˜²æ­¢é—®é¢˜æ‰©æ•£åˆ°æ•´ä¸ªç³»ç»Ÿ</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: ç»™ä¸‹æ¸¸æœåŠ¡æ¢å¤æ—¶é—´</li>
<li><strong>é™çº§æç¤º</strong>: è¿”å›å‹å¥½é”™è¯¯ï¼Œè€Œéè¶…æ—¶æˆ–å´©æºƒ</li>
</ul>
<p><strong>ç†”æ–­å™¨çš„å‚æ•°è°ƒä¼˜:</strong></p>
<ul>
<li><strong>é”™è¯¯é˜ˆå€¼</strong>: å¤ªä½ä¼šé¢‘ç¹ç†”æ–­ï¼Œå¤ªé«˜å¤±å»ä¿æŠ¤ä½œç”¨</li>
<li><strong>å†·å´æ—¶é—´</strong>: å¤ªçŸ­æ— æ³•æ¢å¤ï¼Œå¤ªé•¿å½±å“å¯ç”¨æ€§</li>
<li><strong>åŠå¼€çŠ¶æ€</strong>: å…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•æ¢å¤æƒ…å†µ</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-39">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ç†”æ–­å™¨å’Œé™æµæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç›®çš„</strong>: ç†”æ–­ä¿æŠ¤ä¸‹æ¸¸ï¼Œé™æµä¿æŠ¤è‡ªèº«</li>
<li><strong>è§¦å‘æ¡ä»¶</strong>: ç†”æ–­åŸºäºé”™è¯¯ç‡ï¼Œé™æµåŸºäºè¯·æ±‚é‡</li>
<li><strong>ä½œç”¨å¯¹è±¡</strong>: ç†”æ–­é’ˆå¯¹ç‰¹å®šæœåŠ¡ï¼Œé™æµé’ˆå¯¹ç”¨æˆ·/IP</li>
<li><strong>æ¢å¤æœºåˆ¶</strong>: ç†”æ–­è‡ªåŠ¨æ¢å¤ï¼Œé™æµéœ€è¦ç­‰å¾…çª—å£é‡ç½®</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ç†”æ–­å™¨å’Œé™æµæ˜¯ä¸¤ç§ä¸åŒçš„ä¿æŠ¤æœºåˆ¶ã€‚ç†”æ–­å™¨ä¿æŠ¤çš„æ˜¯ä¸‹æ¸¸æœåŠ¡ï¼Œå½“æ£€æµ‹åˆ°ä¸‹æ¸¸æ•…éšœæ—¶è‡ªåŠ¨åˆ‡æ–­è°ƒç”¨ï¼Œé˜²æ­¢çº§è”æ•…éšœï¼ŒåŸºäºé”™è¯¯ç‡è§¦å‘ã€‚é™æµä¿æŠ¤çš„æ˜¯è‡ªèº«ç³»ç»Ÿï¼Œé˜²æ­¢è¢«è¿‡å¤šè¯·æ±‚å‹å®ï¼ŒåŸºäºè¯·æ±‚é‡è§¦å‘ã€‚åœ¨ Sparkle ä¸­ï¼Œç†”æ–­å™¨ç”¨äºä¿æŠ¤ LLM æœåŠ¡ï¼Œé™æµç”¨äºä¿æŠ¤ç½‘å…³å±‚ã€‚ä¸¤è€…å¯ä»¥é…åˆä½¿ç”¨ï¼šå…ˆé™æµé˜²æ­¢è¿‡è½½ï¼Œå¦‚æœä»ç„¶å‡ºé”™åˆ™ç†”æ–­ã€‚"</p>
</blockquote>
<hr>
<h2 id="72-å¹‚ç­‰æ€§ä¸å»é‡-1">7.2 å¹‚ç­‰æ€§ä¸å»é‡ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-44">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å¹‚ç­‰æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ <strong>åŸºçŸ³</strong>ï¼Œä¿è¯é‡å¤è¯·æ±‚ç»“æœä¸€è‡´ï¼š</p>
<ul>
<li><strong>è¯·æ±‚ ID</strong>: å‰ç«¯ç”Ÿæˆå”¯ä¸€ ID</li>
<li><strong>å»é‡å­˜å‚¨</strong>: Redis è®°å½•å·²å¤„ç†è¯·æ±‚</li>
<li><strong>TTL</strong>: è‡ªåŠ¨è¿‡æœŸï¼Œé¿å…å­˜å‚¨æ— é™å¢é•¿</li>
<li><strong>é˜²é‡è¯•å‰¯ä½œç”¨</strong>: é¿å…é‡å¤æ‰£è´¹ã€å†™åº“</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-45">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/message_tracker.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">MessageTracker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""æ¶ˆæ¯å»é‡ï¼šé˜²æ­¢é‡å¤å¤„ç†"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">,</span> ttl<span class="token operator">=</span><span class="token number">86400</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client
        self<span class="token punctuation">.</span>ttl <span class="token operator">=</span> ttl  <span class="token comment"># 24å°æ—¶è¿‡æœŸ</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">is_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ£€æŸ¥è¯·æ±‚æ˜¯å¦å·²å¤„ç†"""</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>key<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">mark_processed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ‡è®°è¯·æ±‚ä¸ºå·²å¤„ç†"""</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"processed:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ttl<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">is_duplicate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> content_hash<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ£€æŸ¥å†…å®¹æ˜¯å¦é‡å¤ï¼ˆç”¨äºæ¨é€å»é‡ï¼‰"""</span>
        key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"content_hash:</span><span class="token interpolation"><span class="token punctuation">{</span>content_hash<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token comment"># æ£€æŸ¥è¯¥å†…å®¹æ˜¯å¦åœ¨ 24 å°æ—¶å†…ç»™è¯¥ç”¨æˆ·æ¨é€è¿‡</span>
        user_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">:user:</span><span class="token interpolation"><span class="token punctuation">{</span>request_id<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>user_key<span class="token punctuation">)</span>
</code></pre><p><strong>åœ¨ç¼–æ’å™¨ä¸­çš„ä½¿ç”¨ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_stream</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> ChatRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ç¬¬1æ­¥ï¼šåˆ†å¸ƒå¼æ¶ˆæ¯å»é‡</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>is_processed<span class="token punctuation">(</span>request<span class="token punctuation">.</span>request_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"DUPLICATE_REQUEST"</span><span class="token punctuation">,</span> message<span class="token operator">=</span><span class="token string">"è¯·æ±‚å·²å¤„ç†"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>

    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># ... å¤„ç†é€»è¾‘ ...</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>mark_processed<span class="token punctuation">(</span>request<span class="token punctuation">.</span>request_id<span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
        <span class="token comment"># åªæœ‰æˆåŠŸå¤„ç†æ‰æ ‡è®°ï¼Œå¤±è´¥å¯ä»¥é‡è¯•</span>
        <span class="token keyword keyword-raise">raise</span>
</code></pre><p><strong>å‰ç«¯è¯·æ±‚ ID ç”Ÿæˆï¼š</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// mobile/lib/core/utils/request_id_generator.dart</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">RequestIdGenerator</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-static">static</span> <span class="token class-name">String</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-final">final</span> timestamp <span class="token operator">=</span> <span class="token class-name">DateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>millisecondsSinceEpoch<span class="token punctuation">;</span>
    <span class="token keyword keyword-final">final</span> random <span class="token operator">=</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-return">return</span> <span class="token string-literal"><span class="token string">'</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">userId</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">timestamp</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">$</span><span class="token expression">random</span></span><span class="token string">'</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-40">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å¹‚ç­‰æ€§çš„å¿…è¦æ€§:</strong></p>
<ul>
<li><strong>ç½‘ç»œä¸å¯é </strong>: è¯·æ±‚å¯èƒ½è¶…æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šé‡è¯•</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>: æ¶ˆæ¯å¯èƒ½è¢«é‡å¤æŠ•é€’</li>
<li><strong>è´Ÿè½½å‡è¡¡</strong>: è¯·æ±‚å¯èƒ½è¢«è½¬å‘åˆ°ä¸åŒå®ä¾‹</li>
<li><strong>ç”¨æˆ·è¡Œä¸º</strong>: ç”¨æˆ·å¯èƒ½é‡å¤ç‚¹å‡»æäº¤æŒ‰é’®</li>
</ul>
<p><strong>å»é‡ç­–ç•¥çš„é€‰æ‹©:</strong></p>
<ul>
<li><strong>è¯·æ±‚ ID å»é‡</strong>: é€‚åˆåˆ›å»ºç±»æ“ä½œï¼ˆåˆ›å»ºä»»åŠ¡ã€å‘é€æ¶ˆæ¯ï¼‰</li>
<li><strong>å†…å®¹å“ˆå¸Œå»é‡</strong>: é€‚åˆæ¨é€ç±»æ“ä½œï¼Œé¿å…é‡å¤å†…å®¹</li>
<li><strong>ä¸šåŠ¡é”®å»é‡</strong>: é€‚åˆç‰¹å®šä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚æ”¯ä»˜è®¢å•å·ï¼‰</li>
</ul>
<p><strong>TTL çš„è®¾è®¡:</strong></p>
<ul>
<li><strong>å¤ªçŸ­</strong>: å¯èƒ½é”™è¿‡é‡è¯•ï¼Œå¯¼è‡´é‡å¤å¤„ç†</li>
<li><strong>å¤ªé•¿</strong>: å ç”¨ Redis å†…å­˜</li>
<li><strong>å¹³è¡¡</strong>: 24 å°æ—¶é€šå¸¸è¶³å¤Ÿè¦†ç›–æ‰€æœ‰é‡è¯•åœºæ™¯</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-40">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¹‚ç­‰çš„åˆ›å»ºä»»åŠ¡æ¥å£ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>è¯·æ±‚ ID</strong>: å‰ç«¯ç”Ÿæˆå”¯ä¸€ ID</li>
<li><strong>å”¯ä¸€ç´¢å¼•</strong>: æ•°æ®åº“å±‚é¢ä¿è¯ä¸é‡å¤</li>
<li><strong>å»é‡æ£€æŸ¥</strong>: Redis å¿«é€Ÿæ£€æŸ¥</li>
<li><strong>äº‹åŠ¡ä¿è¯</strong>: æ•°æ®åº“æ“ä½œåŸå­æ€§</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"å¹‚ç­‰çš„åˆ›å»ºä»»åŠ¡æ¥å£éœ€è¦ä¸‰å±‚é˜²æŠ¤ï¼šç¬¬ä¸€ï¼Œå‰ç«¯ç”Ÿæˆå”¯ä¸€è¯·æ±‚ IDï¼Œä½œä¸ºå¹‚ç­‰é”®ï¼›ç¬¬äºŒï¼ŒRedis å¿«é€Ÿå»é‡ï¼Œå¦‚æœå·²å­˜åœ¨ç›´æ¥è¿”å›æˆåŠŸï¼›ç¬¬ä¸‰ï¼Œæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼Œå³ä½¿ Redis å¤±æ•ˆä¹Ÿèƒ½ä¿è¯ä¸é‡å¤ï¼›ç¬¬å››ï¼Œæ•´ä¸ªæ“ä½œåœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œä¿è¯åŸå­æ€§ã€‚è¿™æ ·å³ä½¿å®¢æˆ·ç«¯é‡å¤æäº¤ï¼Œç»“æœä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚"</p>
</blockquote>
<hr>
<h2 id="73-åˆ†å¸ƒå¼é”-1">7.3 åˆ†å¸ƒå¼é” </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-45">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>åˆ†å¸ƒå¼é”æ˜¯ <strong>å¤šæœºå¹¶å‘æ§åˆ¶</strong> çš„æ ¸å¿ƒï¼ŒåŸºäº Redis å®ç°ï¼š</p>
<ul>
<li><strong>åŸå­äº‰æŠ¢</strong>: SET NX EX æŒ‡ä»¤</li>
<li><strong>TTL é˜²æ­»é”</strong>: è‡ªåŠ¨è¿‡æœŸ</li>
<li><strong>é”ç»­æœŸ</strong>: é•¿ä»»åŠ¡è‡ªåŠ¨å»¶é•¿é”æ—¶é—´</li>
<li><strong>é˜²è¯¯åˆ </strong>: åªæœ‰æŒæœ‰é”çš„å®ä¾‹æ‰èƒ½é‡Šæ”¾</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-46">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/orchestration/distributed_lock.py</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">DistributedLock</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åŸºäº Redis çš„åˆ†å¸ƒå¼æ’ä»–é”"""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">acquire</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> timeout<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        è·å–é”
        - timeout: é”çš„è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
        """</span>
        <span class="token comment"># ä½¿ç”¨ SET NX EX åŸå­æŒ‡ä»¤</span>
        <span class="token comment"># NX: åªåœ¨ Key ä¸å­˜åœ¨æ—¶è®¾ç½®</span>
        <span class="token comment"># EX: è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰</span>
        acquired <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>
            lock_key<span class="token punctuation">,</span>
            value<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># éšæœºå€¼ï¼Œç”¨äºå®‰å…¨é‡Šæ”¾</span>
            nx<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            ex<span class="token operator">=</span>timeout
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> acquired <span class="token keyword keyword-is">is</span> <span class="token boolean">True</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">release</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> lock_value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        é‡Šæ”¾é”
        - ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§
        - åªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾
        """</span>
        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        if redis.call("GET", KEYS[1]) == ARGV[1] then
            return redis.call("DEL", KEYS[1])
        else
            return 0
        end
        """</span>
        
        result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> result <span class="token operator">==</span> <span class="token number">1</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">extend</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> lock_value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> additional_time<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        ç»­æœŸé”
        - ç”¨äºé•¿ä»»åŠ¡
        """</span>
        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        if redis.call("GET", KEYS[1]) == ARGV[1] then
            return redis.call("EXPIRE", KEYS[1], ARGV[2])
        else
            return 0
        end
        """</span>
        
        result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>
            script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> additional_time
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> result <span class="token operator">==</span> <span class="token number">1</span>

<span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">LockedSessionManager</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>lock <span class="token operator">=</span> DistributedLock<span class="token punctuation">(</span>redis_client<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_session</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        lock_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"session_lock:</span><span class="token interpolation"><span class="token punctuation">{</span>session_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        
        <span class="token comment"># è·å–é”</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> ConcurrentModificationError<span class="token punctuation">(</span><span class="token string">"Session is locked"</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token comment"># ç»­æœŸä»»åŠ¡ï¼ˆå¦‚æœéœ€è¦é•¿æ—¶é—´å¤„ç†ï¼‰</span>
            extend_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>_auto_extend<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            
            <span class="token comment"># æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span>
            result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_process_session_logic<span class="token punctuation">(</span>session_id<span class="token punctuation">)</span>
            
            extend_task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> result
            
        <span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
            <span class="token comment"># é‡Šæ”¾é”</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_auto_extend</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lock_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> lock_value<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è‡ªåŠ¨ç»­æœŸ"""</span>
        <span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>  <span class="token comment"># æ¯ 20 ç§’ç»­æœŸä¸€æ¬¡</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>lock<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-41">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>åˆ†å¸ƒå¼é”çš„å¿…è¦æ€§:</strong></p>
<ul>
<li><strong>å¹¶å‘å†²çª</strong>: å¤šä¸ª Worker åŒæ—¶ä¿®æ”¹åŒä¸€ç”¨æˆ·çŠ¶æ€</li>
<li><strong>æ•°æ®ä¸€è‡´æ€§</strong>: é˜²æ­¢è„è¯»ã€ä¸¢å¤±æ›´æ–°</li>
<li><strong>èµ„æºç«äº‰</strong>: é™åˆ¶åŒæ—¶å¤„ç†çš„ä¼šè¯æ•°</li>
</ul>
<p><strong>é”çš„å®ç°ç»†èŠ‚:</strong></p>
<ul>
<li><strong>åŸå­æ€§</strong>: SET NX EX æ˜¯åŸå­æ“ä½œï¼Œæ— ç«æ€æ¡ä»¶</li>
<li><strong>å®‰å…¨æ€§</strong>: éšæœºå€¼é˜²æ­¢è¯¯åˆ å…¶ä»–å®ä¾‹çš„é”</li>
<li><strong>å¯é æ€§</strong>: TTL é˜²æ­¢æ­»é”ï¼Œå³ä½¿æŒæœ‰è€…å´©æºƒä¹Ÿèƒ½è‡ªåŠ¨é‡Šæ”¾</li>
<li><strong>ç»­æœŸæœºåˆ¶</strong>: é•¿ä»»åŠ¡ä¸ä¼šå› é”è¿‡æœŸè€Œä¸­æ–­</li>
</ul>
<p><strong>é”çš„ç²’åº¦:</strong></p>
<ul>
<li><strong>ç²—ç²’åº¦</strong>: å…¨å±€é”ï¼Œå½±å“æ‰€æœ‰ç”¨æˆ·</li>
<li><strong>ç»†ç²’åº¦</strong>: ç”¨æˆ·çº§é”ï¼Œåªå½±å“å•ä¸ªç”¨æˆ·</li>
<li><strong>Sparkle</strong>: ä¼šè¯çº§é”ï¼Œå¹³è¡¡å¹¶å‘å’Œå®‰å…¨æ€§</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-41">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: Redis åˆ†å¸ƒå¼é”æœ‰ä»€ä¹ˆç¼ºé™·ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç¼ºé™·1</strong>: é”è¿‡æœŸåï¼Œä»»åŠ¡æœªå®Œæˆï¼Œå…¶ä»–å®ä¾‹è·å–é”</li>
<li><strong>ç¼ºé™·2</strong>: Redis ä¸»ä»åˆ‡æ¢å¯¼è‡´é”ä¸¢å¤±</li>
<li><strong>ç¼ºé™·3</strong>: æ—¶é’Ÿæ¼‚ç§»å¯¼è‡´é”æå‰è¿‡æœŸ</li>
<li><strong>è§£å†³</strong>: é”ç»­æœŸã€Redlock ç®—æ³•ã€ä¸šåŠ¡å¹‚ç­‰</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"Redis åˆ†å¸ƒå¼é”çš„ä¸»è¦ç¼ºé™·æ˜¯é”è¿‡æœŸé—®é¢˜ï¼šå¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”çš„ TTLï¼Œé”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå…¶ä»–å®ä¾‹å¯èƒ½è·å–é”å¹¶ä¿®æ”¹æ•°æ®ã€‚æˆ‘ä»¬é€šè¿‡é”ç»­æœŸæœºåˆ¶è§£å†³ï¼šå¯åŠ¨ä¸€ä¸ªåå°ä»»åŠ¡ï¼Œåœ¨é”è¿‡æœŸå‰è‡ªåŠ¨å»¶é•¿ã€‚å¯¹äºæç«¯æƒ…å†µï¼ˆå¦‚ Redis ä¸»ä»åˆ‡æ¢ï¼‰ï¼Œæˆ‘ä»¬ç»“åˆä¸šåŠ¡å¹‚ç­‰æ€§ä¿è¯ï¼šå³ä½¿é”å¤±æ•ˆï¼Œé‡å¤æ“ä½œçš„ç»“æœä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚å¯¹äºè¦æ±‚æé«˜ä¸€è‡´æ€§çš„åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘ Redlock ç®—æ³•ï¼Œä½†å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬çš„æ–¹æ¡ˆå·²è¶³å¤Ÿã€‚"</p>
</blockquote>
<hr>
<h2 id="74-ç›‘æ§ä¸å¯è§‚æµ‹æ€§-1">7.4 ç›‘æ§ä¸å¯è§‚æµ‹æ€§ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-46">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å¯è§‚æµ‹æ€§æ˜¯ç”Ÿäº§ç³»ç»Ÿçš„ <strong>çœ¼ç›</strong>ï¼Œé€šè¿‡ <strong>æŒ‡æ ‡ã€æ—¥å¿—ã€è¿½è¸ª</strong> å®ç°ï¼š</p>
<ul>
<li><strong>æŒ‡æ ‡ (Metrics)</strong>: é‡åŒ–ç³»ç»ŸçŠ¶æ€ï¼ˆQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡ï¼‰</li>
<li><strong>æ—¥å¿— (Logs)</strong>: è®°å½•äº‹ä»¶è¯¦æƒ…ï¼ˆJSON æ ¼å¼ï¼Œæœºå™¨å¯è¯»ï¼‰</li>
<li><strong>è¿½è¸ª (Tracing)</strong>: è¯·æ±‚å…¨é“¾è·¯è¿½è¸ª</li>
<li><strong>å‘Šè­¦ (Alerting)</strong>: ä¸»åŠ¨å‘ç°é—®é¢˜</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-47">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># backend/app/monitoring/metrics.py</span>

<span class="token keyword keyword-from">from</span> prometheus_client <span class="token keyword keyword-import">import</span> Counter<span class="token punctuation">,</span> Histogram<span class="token punctuation">,</span> Gauge<span class="token punctuation">,</span> start_http_server
<span class="token keyword keyword-import">import</span> time

<span class="token keyword keyword-class">class</span> <span class="token class-name">MetricsCollector</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Prometheus æŒ‡æ ‡æ”¶é›†å™¨"""</span>
    
    <span class="token comment"># 1. è®¡æ•°å™¨ (Counter): åªå¢ä¸å‡ï¼Œé€‚åˆæ€»é‡ç»Ÿè®¡</span>
    REQUEST_TOTAL <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        <span class="token string">'sparkle_requests_total'</span><span class="token punctuation">,</span>
        <span class="token string">'Total number of requests'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'service'</span><span class="token punctuation">,</span> <span class="token string">'endpoint'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 2. ç›´æ–¹å›¾ (Histogram): å»¶è¿Ÿåˆ†å¸ƒï¼Œæ”¯æŒåˆ†ä½æ•°</span>
    REQUEST_DURATION <span class="token operator">=</span> Histogram<span class="token punctuation">(</span>
        <span class="token string">'sparkle_request_duration_seconds'</span><span class="token punctuation">,</span>
        <span class="token string">'Request duration in seconds'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'service'</span><span class="token punctuation">,</span> <span class="token string">'endpoint'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        buckets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 3. ä»ªè¡¨ç›˜ (Gauge): å¯å¢å¯å‡ï¼Œé€‚åˆç¬æ—¶å€¼</span>
    ACTIVE_CONNECTIONS <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
        <span class="token string">'sparkle_active_connections'</span><span class="token punctuation">,</span>
        <span class="token string">'Number of active WebSocket connections'</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 4. ä¸šåŠ¡æŒ‡æ ‡</span>
    TOKEN_CONSUMPTION <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
        <span class="token string">'sparkle_token_consumption'</span><span class="token punctuation">,</span>
        <span class="token string">'Token consumption by model'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">'model'</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">]</span>  <span class="token comment"># type: prompt/completion</span>
    <span class="token punctuation">)</span>
    
    CACHE_HIT_RATE <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
        <span class="token string">'sparkle_cache_hit_rate'</span><span class="token punctuation">,</span>
        <span class="token string">'Semantic cache hit rate'</span>
    <span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">MonitoredService</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¸¦ç›‘æ§çš„æœåŠ¡åŸºç±»"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>service_name <span class="token operator">=</span> service_name
        self<span class="token punctuation">.</span>metrics <span class="token operator">=</span> MetricsCollector<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">record_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> endpoint<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> status<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> duration<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•è¯·æ±‚æŒ‡æ ‡"""</span>
        self<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>REQUEST_TOTAL<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
            service<span class="token operator">=</span>self<span class="token punctuation">.</span>service_name<span class="token punctuation">,</span>
            endpoint<span class="token operator">=</span>endpoint<span class="token punctuation">,</span>
            status<span class="token operator">=</span>status
        <span class="token punctuation">)</span><span class="token punctuation">.</span>inc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>REQUEST_DURATION<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
            service<span class="token operator">=</span>self<span class="token punctuation">.</span>service_name<span class="token punctuation">,</span>
            endpoint<span class="token operator">=</span>endpoint
        <span class="token punctuation">)</span><span class="token punctuation">.</span>observe<span class="token punctuation">(</span>duration<span class="token punctuation">)</span>

<span class="token comment"># ç»“æ„åŒ–æ—¥å¿—</span>
<span class="token keyword keyword-import">import</span> structlog
<span class="token keyword keyword-import">import</span> json

<span class="token keyword keyword-class">class</span> <span class="token class-name">StructuredLogger</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ç»“æ„åŒ–æ—¥å¿—å™¨"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> service_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>logger <span class="token operator">=</span> structlog<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span>service_name<span class="token punctuation">)</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">log_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•è¯·æ±‚æ—¥å¿—"""</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
            <span class="token string">"request_processed"</span><span class="token punctuation">,</span>
            request_id<span class="token operator">=</span>request_id<span class="token punctuation">,</span>
            user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
            timestamp<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">**</span>kwargs
        <span class="token punctuation">)</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">log_error</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> Exception<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•é”™è¯¯æ—¥å¿—"""</span>
        self<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>
            <span class="token string">"request_failed"</span><span class="token punctuation">,</span>
            request_id<span class="token operator">=</span>request_id<span class="token punctuation">,</span>
            error_type<span class="token operator">=</span><span class="token builtin">type</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">.</span>__name__<span class="token punctuation">,</span>
            error_message<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token operator">**</span>kwargs
        <span class="token punctuation">)</span>

<span class="token comment"># å¥åº·æ£€æŸ¥</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">HealthChecker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¥åº·æ£€æŸ¥å™¨"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db<span class="token punctuation">,</span> redis<span class="token punctuation">,</span> llm_service<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>db <span class="token operator">=</span> db
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis
        self<span class="token punctuation">.</span>llm_service <span class="token operator">=</span> llm_service
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">check_readiness</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""å°±ç»ªæ£€æŸ¥ï¼šæ˜¯å¦å¯ä»¥æ¥æ”¶æµé‡"""</span>
        checks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        
        <span class="token comment"># æ•°æ®åº“æ£€æŸ¥</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>db<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT 1"</span><span class="token punctuation">)</span>
            checks<span class="token punctuation">[</span><span class="token string">'database'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'healthy'</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            checks<span class="token punctuation">[</span><span class="token string">'database'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'unhealthy: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">'</span></span>
        
        <span class="token comment"># Redis æ£€æŸ¥</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>ping<span class="token punctuation">(</span><span class="token punctuation">)</span>
            checks<span class="token punctuation">[</span><span class="token string">'redis'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'healthy'</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            checks<span class="token punctuation">[</span><span class="token string">'redis'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'unhealthy: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">'</span></span>
        
        <span class="token comment"># é˜Ÿåˆ—é•¿åº¦æ£€æŸ¥</span>
        queue_length <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>llen<span class="token punctuation">(</span><span class="token string">"queue:summarization"</span><span class="token punctuation">)</span>
        checks<span class="token punctuation">[</span><span class="token string">'queue_length'</span><span class="token punctuation">]</span> <span class="token operator">=</span> queue_length
        checks<span class="token punctuation">[</span><span class="token string">'queue_healthy'</span><span class="token punctuation">]</span> <span class="token operator">=</span> queue_length <span class="token operator">&lt;</span> <span class="token number">500</span>
        
        <span class="token comment"># æ•´ä½“çŠ¶æ€</span>
        all_healthy <span class="token operator">=</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            v <span class="token operator">==</span> <span class="token string">'healthy'</span> <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token boolean">True</span>
            <span class="token keyword keyword-for">for</span> v <span class="token keyword keyword-in">in</span> checks<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'ready'</span> <span class="token keyword keyword-if">if</span> all_healthy <span class="token keyword keyword-else">else</span> <span class="token string">'degraded'</span><span class="token punctuation">,</span>
            <span class="token string">'checks'</span><span class="token punctuation">:</span> checks
        <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">check_liveness</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""å­˜æ´»æ£€æŸ¥ï¼šè¿›ç¨‹æ˜¯å¦åœ¨è¿è¡Œ"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">'status'</span><span class="token punctuation">:</span> <span class="token string">'alive'</span><span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-42">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç›‘æ§ä½“ç³»çš„å±‚æ¬¡:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ä¸šåŠ¡å±‚ (Business)
    â†“ ç”¨æˆ·æ»¡æ„åº¦ã€è½¬åŒ–ç‡
åº”ç”¨å±‚ (Application)
    â†“ QPSã€å»¶è¿Ÿã€é”™è¯¯ç‡
ç³»ç»Ÿå±‚ (System)
    â†“ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
åŸºç¡€è®¾æ–½å±‚ (Infrastructure)
    â†“ æœåŠ¡å™¨ã€ç½‘ç»œã€ç”µæº
</code></pre><p><strong>æŒ‡æ ‡ç±»å‹çš„é€‰æ‹©:</strong></p>
<ul>
<li><strong>Counter</strong>: æ€»é‡ç»Ÿè®¡ï¼Œåªå¢ä¸å‡ï¼ˆè¯·æ±‚æ€»æ•°ï¼‰</li>
<li><strong>Gauge</strong>: ç¬æ—¶å€¼ï¼ˆå¹¶å‘è¿æ¥æ•°ï¼‰</li>
<li><strong>Histogram</strong>: å»¶è¿Ÿåˆ†å¸ƒï¼ˆP50/P95/P99ï¼‰</li>
<li><strong>Summary</strong>: ç±»ä¼¼ Histogramï¼Œä½†å®¢æˆ·ç«¯è®¡ç®—åˆ†ä½æ•°</li>
</ul>
<p><strong>æ—¥å¿— vs æŒ‡æ ‡:</strong></p>
<ul>
<li><strong>æŒ‡æ ‡</strong>: é‡åŒ–ã€èšåˆã€å‘Šè­¦</li>
<li><strong>æ—¥å¿—</strong>: è¯¦æƒ…ã€è°ƒè¯•ã€å®¡è®¡</li>
<li><strong>é…åˆä½¿ç”¨</strong>: æŒ‡æ ‡å‘ç°é—®é¢˜ï¼Œæ—¥å¿—å®šä½é—®é¢˜</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-42">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„ç›‘æ§ä½“ç³»ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>é»„é‡‘æŒ‡æ ‡</strong>: RED (Rate, Error, Duration)</li>
<li><strong>ä¸šåŠ¡æŒ‡æ ‡</strong>: è½¬åŒ–ç‡ã€ç”¨æˆ·æ»¡æ„åº¦</li>
<li><strong>æ—¥å¿—ç»“æ„åŒ–</strong>: JSON æ ¼å¼ï¼Œä¾¿äºæŸ¥è¯¢</li>
<li><strong>å‘Šè­¦åˆ†çº§</strong>: P0/P1/P2/P3ï¼Œé¿å…å‘Šè­¦é£æš´</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"å®Œæ•´çš„ç›‘æ§ä½“ç³»éœ€è¦è¦†ç›–å››ä¸ªå±‚æ¬¡ï¼šç¬¬ä¸€ï¼Œé»„é‡‘æŒ‡æ ‡ï¼Œå³ REDï¼ˆRateã€Errorã€Durationï¼‰ï¼Œè¿™æ˜¯æ‰€æœ‰æœåŠ¡éƒ½å¿…é¡»ç›‘æ§çš„ï¼›ç¬¬äºŒï¼Œä¸šåŠ¡æŒ‡æ ‡ï¼Œå¦‚ä»»åŠ¡å®Œæˆç‡ã€ç”¨æˆ·æ´»è·ƒåº¦ï¼›ç¬¬ä¸‰ï¼Œç³»ç»ŸæŒ‡æ ‡ï¼Œå¦‚ CPUã€å†…å­˜ã€ç£ç›˜ï¼›ç¬¬å››ï¼Œæ—¥å¿—ï¼Œä½¿ç”¨ç»“æ„åŒ– JSON æ ¼å¼ï¼Œä¾¿äº ELK æ”¶é›†å’ŒæŸ¥è¯¢ã€‚å‘Šè­¦éœ€è¦åˆ†çº§ï¼ŒP0 çº§åˆ«ç«‹å³é€šçŸ¥ï¼ŒP1 çº§åˆ« 2 å°æ—¶å†…å¤„ç†ï¼Œé¿å…å‘Šè­¦ç–²åŠ³ã€‚æˆ‘ä»¬ä½¿ç”¨ Prometheus æ”¶é›†æŒ‡æ ‡ï¼ŒGrafana å±•ç¤ºï¼ŒLoki æ”¶é›†æ—¥å¿—ï¼ŒAlertmanager å¤„ç†å‘Šè­¦ã€‚"</p>
</blockquote>
<hr>
<h2 id="75-é”™è¯¯å¤„ç†ä¸é™çº§-1">7.5 é”™è¯¯å¤„ç†ä¸é™çº§ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-47">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>é”™è¯¯å¤„ç†æ˜¯ <strong>ç³»ç»ŸéŸ§æ€§</strong> çš„ä½“ç°ï¼Œé€šè¿‡ <strong>åˆ†çº§é™çº§</strong> ä¿è¯æ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<ul>
<li><strong>ä¼˜é›…é™çº§</strong>: æ ¸å¿ƒåŠŸèƒ½ä¿æŒï¼Œéæ ¸å¿ƒåŠŸèƒ½é™çº§</li>
<li><strong>è¶…æ—¶æ§åˆ¶</strong>: é˜²æ­¢èµ„æºè€—å°½</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: å•ç‚¹æ•…éšœä¸å½±å“å…¨å±€</li>
<li><strong>è‡ªæ„ˆèƒ½åŠ›</strong>: è‡ªåŠ¨æ¢å¤æœºåˆ¶</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-48">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># æ€æƒ³ï¼šæ¼æ–—æ¨¡å‹ã€‚æœ€å¼ºçš„ GraphRAG æŒ‚äº†ï¼Œå°±ç”¨å‘é‡æœç´¢ï¼›å‘é‡æŒ‚äº†ï¼Œå°±ç”¨å…³é”®è¯ï¼›å…¨æŒ‚äº†ï¼Œè¿”å›ç©ºã€‚</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_knowledge_with_fallback</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span> 
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> graph_rag<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token comment"># 1. æœ€ä¼˜é€‰</span>
    <span class="token keyword keyword-except">except</span> GraphRAGError<span class="token punctuation">:</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> simple_vector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token comment"># 2. å¤‡é€‰</span>
        <span class="token keyword keyword-except">except</span> VectorError<span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> keyword_search<span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token comment"># 3. å†å¤‡é€‰</span>
            <span class="token keyword keyword-except">except</span> SearchError<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment"># 4. æœ€ç»ˆé™çº§</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">GracefulDegrader</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä¼˜é›…é™çº§ç®¡ç†å™¨"""</span>
    
    DEGRADATION_LEVELS <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'normal'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'degraded'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># é™çº§ï¼šåªç”¨å‘é‡æœç´¢</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>   <span class="token comment"># é™çº§ï¼šç¦ç”¨å·¥å…·</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'critical'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'use_graph_rag'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'use_semantic_cache'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'max_history'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token string">'enable_tools'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
            <span class="token string">'fallback_to_template'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># é™çº§ï¼šä½¿ç”¨æ¨¡æ¿å›å¤</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_degradation_level</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ ¹æ®ç³»ç»ŸçŠ¶æ€è·å–é™çº§çº§åˆ«"""</span>
        <span class="token comment"># æ£€æŸ¥ä¸‹æ¸¸æœåŠ¡å¥åº·çŠ¶æ€</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_llm_health<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'critical'</span>
        
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_vector_db_health<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'degraded'</span>
        
        <span class="token comment"># æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½</span>
        cpu_load <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_get_cpu_load<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> cpu_load <span class="token operator">&gt;</span> <span class="token number">80</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">'degraded'</span>
        
        <span class="token keyword keyword-return">return</span> <span class="token string">'normal'</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">execute_with_degradation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰§è¡Œå‡½æ•°ï¼Œæ”¯æŒé™çº§"""</span>
        level <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get_degradation_level<span class="token punctuation">(</span><span class="token punctuation">)</span>
        config <span class="token operator">=</span> self<span class="token punctuation">.</span>DEGRADATION_LEVELS<span class="token punctuation">[</span>level<span class="token punctuation">]</span>
        
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> config<span class="token operator">=</span>config<span class="token punctuation">)</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> level <span class="token operator">==</span> <span class="token string">'normal'</span><span class="token punctuation">:</span>
                <span class="token comment"># å°è¯•é™çº§æ‰§è¡Œ</span>
                degraded_config <span class="token operator">=</span> self<span class="token punctuation">.</span>DEGRADATION_LEVELS<span class="token punctuation">[</span><span class="token string">'degraded'</span><span class="token punctuation">]</span>
                <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">,</span> config<span class="token operator">=</span>degraded_config<span class="token punctuation">)</span>
                <span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
                    <span class="token comment"># æœ€ç»ˆé™çº§</span>
                    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_fallback_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_fallback_response<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_fallback_response</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æœ€ç»ˆé™çº§ï¼šæ¨¡æ¿åŒ–å›å¤"""</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"ç³»ç»Ÿå½“å‰è´Ÿè½½è¾ƒé«˜ï¼Œæ­£åœ¨ä¸ºæ‚¨æ’é˜Ÿå¤„ç†..."</span><span class="token punctuation">,</span>
            <span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"queued"</span><span class="token punctuation">,</span>
            <span class="token string">"estimated_time"</span><span class="token punctuation">:</span> <span class="token string">"2-3åˆ†é’Ÿ"</span>
        <span class="token punctuation">}</span>

<span class="token comment"># è¶…æ—¶æ§åˆ¶</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">call_with_timeout</span><span class="token punctuation">(</span>coro<span class="token punctuation">,</span> timeout_seconds<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¸¦è¶…æ—¶çš„å¼‚æ­¥è°ƒç”¨"""</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. è®¾ç½®æ‰§è¡Œä¸Šé™</span>
        <span class="token comment"># æ€æƒ³ï¼šèµ„æºé˜²è…ã€‚é˜²æ­¢ç”±äºå¤–éƒ¨ APIï¼ˆå¦‚ LLMï¼‰å“åº”è¿‡æ…¢å¯¼è‡´è¯·æ±‚å †ç§¯ï¼Œæœ€ç»ˆè€—å°½æœåŠ¡å™¨åç¨‹æ± ã€‚</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>wait_for<span class="token punctuation">(</span>coro<span class="token punctuation">,</span> timeout<span class="token operator">=</span>timeout_seconds<span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> asyncio<span class="token punctuation">.</span>TimeoutError<span class="token punctuation">:</span>
        <span class="token comment"># 2. å¤±è´¥é™çº§</span>
        <span class="token keyword keyword-raise">raise</span> TimeoutError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Operation timed out after </span><span class="token interpolation"><span class="token punctuation">{</span>timeout_seconds<span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-43">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>é™çº§ç­–ç•¥çš„å±‚æ¬¡:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>æ­£å¸¸æ¨¡å¼
    â†“ è´Ÿè½½ &gt; 70%
é™çº§æ¨¡å¼ (ç¦ç”¨éæ ¸å¿ƒåŠŸèƒ½)
    â†“ è´Ÿè½½ &gt; 85% æˆ–ä¸‹æ¸¸æ•…éšœ
å…³é”®æ¨¡å¼ (ä»…ä¿ç•™æ ¸å¿ƒå›å¤)
    â†“ ç³»ç»Ÿå´©æºƒ
æ¨¡æ¿å›å¤ (å‘ŠçŸ¥ç”¨æˆ·ç³»ç»Ÿç¹å¿™)
</code></pre><p><strong>è¶…æ—¶æ§åˆ¶çš„é‡è¦æ€§:</strong></p>
<ul>
<li><strong>èµ„æºä¿æŠ¤</strong>: é˜²æ­¢æ…¢è¯·æ±‚è€—å°½è¿æ¥æ± </li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: å¿«é€Ÿå¤±è´¥ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…</li>
<li><strong>æ•…éšœéš”ç¦»</strong>: å•ä¸ªæ…¢è¯·æ±‚ä¸å½±å“å…¶ä»–è¯·æ±‚</li>
</ul>
<p><strong>è‡ªæ„ˆæœºåˆ¶:</strong></p>
<ul>
<li><strong>å¥åº·æ£€æŸ¥</strong>: å®šæœŸæ¢æµ‹ä¸‹æ¸¸æœåŠ¡</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: è´Ÿè½½é™ä½åè‡ªåŠ¨æ¢å¤</li>
<li><strong>æ‰‹åŠ¨å¹²é¢„</strong>: è¿ç»´å¯ä»¥å¼ºåˆ¶é™çº§æˆ–æ¢å¤</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-43">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: ç³»ç»Ÿè´Ÿè½½è¿‡é«˜æ—¶å¦‚ä½•ä¼˜é›…é™çº§ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>åˆ†çº§ç­–ç•¥</strong>: å®šä¹‰æ¸…æ™°çš„é™çº§çº§åˆ«</li>
<li><strong>è‡ªåŠ¨æ£€æµ‹</strong>: åŸºäº CPUã€å†…å­˜ã€ä¸‹æ¸¸å¥åº·çŠ¶æ€</li>
<li><strong>ç”¨æˆ·é€šçŸ¥</strong>: å‘ŠçŸ¥ç”¨æˆ·å½“å‰çŠ¶æ€å’Œé¢„æœŸç­‰å¾…æ—¶é—´</li>
<li><strong>æ ¸å¿ƒä¿è¯</strong>: å§‹ç»ˆä¿æŒåŸºæœ¬å›å¤èƒ½åŠ›</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬è®¾è®¡äº†ä¸‰çº§é™çº§ç­–ç•¥ã€‚æ­£å¸¸æ¨¡å¼ä¸‹æ‰€æœ‰åŠŸèƒ½å¯ç”¨ï¼›å½“ CPU è¶…è¿‡ 70% æˆ–å‘é‡æ•°æ®åº“ä¸å¯ç”¨æ—¶ï¼Œè¿›å…¥é™çº§æ¨¡å¼ï¼Œç¦ç”¨å·¥å…·è°ƒç”¨å’Œé•¿å†å²ï¼›å½“ CPU è¶…è¿‡ 85% æˆ– LLM ä¸å¯ç”¨æ—¶ï¼Œè¿›å…¥å…³é”®æ¨¡å¼ï¼Œåªä¿ç•™åŸºæœ¬å›å¤ï¼Œå¹¶æç¤ºç”¨æˆ·ç³»ç»Ÿç¹å¿™ã€‚é™çº§æ˜¯è‡ªåŠ¨çš„ï¼Œé€šè¿‡å¥åº·æ£€æŸ¥å’Œè´Ÿè½½ç›‘æ§å®æ—¶åˆ¤æ–­ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¼šç»™ç”¨æˆ·æ˜ç¡®çš„åé¦ˆï¼Œæ¯”å¦‚'ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜ï¼Œæ­£åœ¨æ’é˜Ÿå¤„ç†ï¼Œé¢„è®¡ 2-3 åˆ†é’Ÿ'ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·æ— ä¼‘æ­¢ç­‰å¾…ã€‚"</p>
</blockquote>
<hr>
<h1 id="å…«-å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª-1">å…«ã€å®Œæ•´è¯·æ±‚æµç¨‹è¿½è¸ª </h1>
<h2 id="81-ç«¯åˆ°ç«¯æ•°æ®æµ-1">8.1 ç«¯åˆ°ç«¯æ•°æ®æµ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-48">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å®Œæ•´è¯·æ±‚æµç¨‹æ˜¯ <strong>ç³»ç»Ÿè¡Œä¸ºçš„å…¨æ™¯å›¾</strong>ï¼Œä»ç”¨æˆ·è¾“å…¥åˆ°æœ€ç»ˆå“åº”ï¼š</p>
<ul>
<li><strong>ç§»åŠ¨ç«¯</strong>: ç”¨æˆ·è¾“å…¥ã€çŠ¶æ€ç®¡ç†ã€UI æ¸²æŸ“</li>
<li><strong>ç½‘å…³å±‚</strong>: è¿æ¥ç®¡ç†ã€è®¤è¯é™æµã€åè®®è½¬æ¢</li>
<li><strong>AI å¼•æ“</strong>: ç¼–æ’å¤„ç†ã€å·¥å…·è°ƒç”¨ã€LLM äº¤äº’</li>
<li><strong>æ•°æ®å±‚</strong>: æ•°æ®åº“æŸ¥è¯¢ã€ç¼“å­˜æ“ä½œã€é˜Ÿåˆ—å¤„ç†</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-49">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>ç”¨æˆ·è¾“å…¥: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
</code></pre><p><strong>é˜¶æ®µ 1: ç§»åŠ¨ç«¯å¤„ç†</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// 1. Flutter App - ç”¨æˆ·è¾“å…¥</span>
<span class="token class-name">ChatScreen</span><span class="token punctuation">.</span><span class="token function">onSubmitted</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span></span><span class="token punctuation">)</span>

<span class="token comment">// 2. Riverpod çŠ¶æ€æ›´æ–°</span>
<span class="token class-name">ChatNotifier</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span></span><span class="token punctuation">)</span>
  â†’ æ›´æ–° state<span class="token punctuation">.</span>isLoading <span class="token operator">=</span> <span class="token boolean">true</span>
  â†’ æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° messages åˆ—è¡¨

<span class="token comment">// 3. WebSocket æœåŠ¡å‘é€</span>
<span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
  message<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span></span><span class="token punctuation">,</span>
  userId<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"user_123"</span></span><span class="token punctuation">,</span>
  sessionId<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"sess_456"</span></span>
<span class="token punctuation">)</span>
  â†’ æ„å»º payload<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string-literal"><span class="token string">"message"</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"..."</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"session_id"</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"..."</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"user_id"</span></span><span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">"..."</span></span><span class="token punctuation">}</span>
  â†’ <span class="token class-name">WebSocketChannel</span> å‘é€ JSON
</code></pre><p><strong>é˜¶æ®µ 2: Go Gateway å¤„ç†</strong></p>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// 4. Go Gateway - WebSocket æ¥æ”¶</span>
<span class="token keyword keyword-func">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>ChatHandler<span class="token punctuation">)</span> <span class="token function">HandleWebSocket</span><span class="token punctuation">(</span>conn <span class="token operator">*</span>websocket<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> userID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¤è¯æ£€æŸ¥</span>
    <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span><span class="token function">authMiddleware</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        conn<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token number">4001</span><span class="token punctuation">,</span> <span class="token string">"Auth failed"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¶ˆæ¯å¾ªç¯</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> msg ChatMessage
        conn<span class="token punctuation">.</span><span class="token function">ReadJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span>  <span class="token comment">// æ¥æ”¶ {"message": "...", ...}</span>

        <span class="token comment">// é…é¢æ£€æŸ¥</span>
        <span class="token keyword keyword-if">if</span> <span class="token operator">!</span>h<span class="token punctuation">.</span>quotaService<span class="token punctuation">.</span><span class="token function">CheckQuota</span><span class="token punctuation">(</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>QuotaExceededResponse<span class="token punctuation">)</span>
            <span class="token keyword keyword-break">break</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5. è½¬å‘åˆ° gRPC</span>
        response<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span>grpcClient<span class="token punctuation">.</span><span class="token function">StreamChat</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pb<span class="token punctuation">.</span>ChatRequest<span class="token punctuation">{</span>
            UserId<span class="token punctuation">:</span>    userID<span class="token punctuation">,</span>
            SessionId<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>SessionID<span class="token punctuation">,</span>
            Message<span class="token punctuation">:</span>   msg<span class="token punctuation">.</span>Message<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">// 6. æµå¼è¿”å›</span>
        <span class="token keyword keyword-for">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> chunk <span class="token operator">:=</span> <span class="token keyword keyword-range">range</span> response <span class="token punctuation">{</span>
            conn<span class="token punctuation">.</span><span class="token function">WriteJSON</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>  <span class="token comment">// é€å—è¿”å›ç»™ Flutter</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>é˜¶æ®µ 3: Python gRPC æœåŠ¡</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># 7. gRPC æœåŠ¡ç«¯</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">AgentServiceImpl</span><span class="token punctuation">(</span>pb2_grpc<span class="token punctuation">.</span>AgentServiceServicer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">StreamChat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># è½¬å‘åˆ°ç¼–æ’å™¨</span>
        orchestrator <span class="token operator">=</span> ProductionChatOrchestrator<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> orchestrator<span class="token punctuation">.</span>process_stream<span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-yield">yield</span> pb2<span class="token punctuation">.</span>StreamResponse<span class="token punctuation">(</span>
                <span class="token builtin">type</span><span class="token operator">=</span>event<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">,</span>
                content<span class="token operator">=</span>event<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
                metadata<span class="token operator">=</span>event<span class="token punctuation">.</span>metadata
            <span class="token punctuation">)</span>
</code></pre><p><strong>é˜¶æ®µ 4: ç”Ÿäº§çº§ç¼–æ’å™¨æ ¸å¿ƒæµç¨‹</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># 8. ProductionChatOrchestrator.process_stream()</span>

<span class="token comment"># ========== ç¬¬1æ­¥ï¼šæ¶ˆæ¯å»é‡æ£€æŸ¥ ==========</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>message_tracker<span class="token punctuation">.</span>is_processed<span class="token punctuation">(</span><span class="token string">"req_789"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"DUPLICATE_REQUEST"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

<span class="token comment"># ========== ç¬¬2æ­¥ï¼šç†”æ–­å™¨æ£€æŸ¥ ==========</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>circuit_breaker<span class="token punctuation">.</span>can_execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"CIRCUIT_BREAKER_OPEN"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

<span class="token comment"># ========== ç¬¬3æ­¥ï¼šå¹¶å‘æ§åˆ¶ ==========</span>
<span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_track_session<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"RATE_LIMIT"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

<span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
    <span class="token comment"># ========== ç¬¬4æ­¥ï¼šè¯·æ±‚éªŒè¯ ==========</span>
    validation <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>validate_chat_request<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> validation<span class="token punctuation">.</span>is_valid<span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"VALIDATION_FAILED"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

    <span class="token comment"># ========== ç¬¬5æ­¥ï¼šå¹‚ç­‰æ€§æ£€æŸ¥ ==========</span>
    cached <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_check_idempotency<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> cached<span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> cached  <span class="token comment"># è¿”å›ç¼“å­˜</span>
        <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

    <span class="token comment"># ========== ç¬¬6æ­¥ï¼šåˆ†å¸ƒå¼é” ==========</span>
    lock_acquired <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_acquire_session_lock<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> lock_acquired<span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> ErrorEvent<span class="token punctuation">(</span>code<span class="token operator">=</span><span class="token string">"LOCK_FAILED"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>  <span class="token comment"># æµç¨‹ç»“æŸ</span>

    <span class="token comment"># ========== ç¬¬7æ­¥ï¼šæ„å»ºä¸Šä¸‹æ–‡ ==========</span>

    <span class="token comment"># 7.1 ç”¨æˆ·ä¸Šä¸‹æ–‡</span>
    user_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_build_user_context<span class="token punctuation">(</span><span class="token string">"user_123"</span><span class="token punctuation">)</span>
    <span class="token comment"># ç»“æœ: {</span>
    <span class="token comment">#   "user": {"id": "user_123", "nickname": "å¼ ä¸‰"},</span>
    <span class="token comment">#   "progress": {"total_nodes": 45, "avg_mastery": 65},</span>
    <span class="token comment">#   "active_sprint": {"title": "æœºå™¨å­¦ä¹ å…¥é—¨", "progress": 75}</span>
    <span class="token comment"># }</span>

    <span class="token comment"># 7.2 å¯¹è¯å†å²ï¼ˆä¸Šä¸‹æ–‡ä¿®å‰ªï¼‰</span>
    conversation_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>context_pruner<span class="token punctuation">.</span>get_pruned_history<span class="token punctuation">(</span>
        <span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"user_123"</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># ç»“æœ: {</span>
    <span class="token comment">#   "messages": [...],  # æœ€è¿‘10æ¡æˆ–å¸¦æ€»ç»“</span>
    <span class="token comment">#   "summary": "ç”¨æˆ·ä¹‹å‰è¯¢é—®è¿‡ç¥ç»ç½‘ç»œçš„åŸºç¡€æ¦‚å¿µ",</span>
    <span class="token comment">#   "summary_used": True</span>
    <span class="token comment"># }</span>

    <span class="token comment"># 7.3 çŸ¥è¯†æ£€ç´¢ï¼ˆGraphRAGï¼‰</span>
    knowledge_context <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_retrieve_knowledge<span class="token punctuation">(</span>
        <span class="token string">"user_123"</span><span class="token punctuation">,</span>
        <span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span><span class="token punctuation">,</span>
        conversation_context
    <span class="token punctuation">)</span>
    <span class="token comment"># ç»“æœ: {</span>
    <span class="token comment">#   "nodes": [</span>
    <span class="token comment">#     {"id": "node_100", "name": "æœºå™¨å­¦ä¹ ", "mastery": 0},</span>
    <span class="token comment">#     {"id": "node_101", "name": "ç›‘ç£å­¦ä¹ ", "mastery": 0},</span>
    <span class="token comment">#     {"id": "node_102", "name": "ç¥ç»ç½‘ç»œ", "mastery": 35}</span>
    <span class="token comment">#   ],</span>
    <span class="token comment">#   "relations": [...]</span>
    <span class="token comment"># }</span>

    <span class="token comment"># ========== ç¬¬8æ­¥ï¼šLLM è°ƒç”¨ + å·¥å…·æ‰§è¡Œ ==========</span>

    <span class="token comment"># 8.1 å‡†å¤‡å·¥å…·</span>
    tools <span class="token operator">=</span> tool_registry<span class="token punctuation">.</span>get_openai_tools_schema<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># å·¥å…·åˆ—è¡¨: [</span>
    <span class="token comment">#   {"name": "get_knowledge_node", ...},</span>
    <span class="token comment">#   {"name": "create_task", ...},</span>
    <span class="token comment">#   ...</span>
    <span class="token comment"># ]</span>

    <span class="token comment"># 8.2 æ„å»ºç³»ç»Ÿæç¤º</span>
    system_prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
    ä½ æ˜¯ä¸€ä¸ª AI å­¦ä¹ åŠ©æ‰‹ã€‚

    ç”¨æˆ·ä¿¡æ¯:
    </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>user_context<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    å¯¹è¯å†å²:
    </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>conversation_context<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    ç›¸å…³çŸ¥è¯†:
    </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>knowledge_context<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    å¯ç”¨å·¥å…·:
    </span><span class="token interpolation"><span class="token punctuation">{</span>tool_registry<span class="token punctuation">.</span>get_tools_description<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">

    è¦æ±‚:
    1. ç”¨ä¸­æ–‡å›ç­”
    2. è¯­è¨€äº²åˆ‡è‡ªç„¶
    3. é€‚å½“ä½¿ç”¨å·¥å…·
    """</span></span>

    <span class="token comment"># 8.3 æµå¼ LLM è°ƒç”¨</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-for">for</span> chunk <span class="token keyword keyword-in">in</span> llm_service<span class="token punctuation">.</span>chat_stream_with_tools<span class="token punctuation">(</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
        user_id<span class="token operator">=</span><span class="token string">"user_123"</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-yield">yield</span> chunk

    <span class="token comment"># ========== ç¬¬9æ­¥ï¼šå“åº”ç»„åˆ ==========</span>
    <span class="token comment"># å·²åœ¨ LLM æµå¼è¿”å›ä¸­å®Œæˆ</span>

    <span class="token comment"># ========== ç¬¬10æ­¥ï¼šç¼“å­˜ä¸æŒ‡æ ‡ ==========</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_cache_response<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">,</span> <span class="token string">"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_record_metrics<span class="token punctuation">(</span>request<span class="token punctuation">,</span> user_context<span class="token punctuation">)</span>

<span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
    <span class="token comment"># ========== ç¬¬11æ­¥ï¼šæ¸…ç†èµ„æº ==========</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_release_session_lock<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> <span class="token string">"req_789"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_track_session<span class="token punctuation">(</span><span class="token string">"sess_456"</span><span class="token punctuation">,</span> add<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre><p><strong>é˜¶æ®µ 5: è¿”å›ç§»åŠ¨ç«¯</strong></p>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// 12. Flutter - æ¥æ”¶æµå¼å“åº”</span>

<span class="token comment">// WebSocket æœåŠ¡æ¥æ”¶</span>
<span class="token class-name">WebSocketChatServiceV2</span><span class="token punctuation">.</span><span class="token function">_handleMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  â†’ è§£æä¸º <span class="token class-name">TextEvent</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"æœºå™¨å­¦ä¹ æ˜¯..."</span></span><span class="token punctuation">)</span>
  â†’ <span class="token class-name">StreamController</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>

<span class="token comment">// Riverpod ç›‘å¬</span>
<span class="token class-name">ChatNotifier</span><span class="token punctuation">.</span><span class="token function">_handleStreamEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  â†’ event<span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span>
      text<span class="token punctuation">:</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
          response<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response <span class="token operator">+</span> content<span class="token punctuation">,</span>
          isTyping<span class="token punctuation">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      done<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨</span>
        state <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">copyWith</span><span class="token punctuation">(</span>
          messages<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
            <span class="token class-name">ChatMessage</span><span class="token punctuation">(</span>
              role<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">'assistant'</span></span><span class="token punctuation">,</span>
              content<span class="token punctuation">:</span> state<span class="token punctuation">.</span>response<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          isLoading<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          isTyping<span class="token punctuation">:</span> <span class="token boolean">false</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

<span class="token comment">// UI æ›´æ–°</span>
<span class="token class-name">ChatScreen</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  â†’ <span class="token class-name">MessageBubble</span> æ˜¾ç¤º AI å›ç­”
  â†’ æ‰“å­—åŠ¨ç”»æ•ˆæœ
  â†’ å®ŒæˆçŠ¶æ€æ˜¾ç¤º
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-44">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç«¯åˆ°ç«¯æµç¨‹çš„è®¾è®¡åŸåˆ™:</strong></p>
<ul>
<li><strong>å¯è§‚æµ‹æ€§</strong>: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„æ—¥å¿—å’ŒæŒ‡æ ‡</li>
<li><strong>é”™è¯¯éš”ç¦»</strong>: ä»»ä½•é˜¶æ®µå¤±è´¥éƒ½æœ‰æ¸…æ™°çš„é™çº§ç­–ç•¥</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: å¼‚æ­¥å¤„ç†ã€æµå¼å“åº”ã€ç¼“å­˜ä¼˜åŒ–</li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: å®æ—¶åé¦ˆã€çŠ¶æ€æŒ‡ç¤ºã€å‹å¥½é”™è¯¯</li>
</ul>
<p><strong>æ—¶åºä¼˜åŒ–çš„å…³é”®ç‚¹:</strong></p>
<ul>
<li><strong>0-100ms</strong>: ç§»åŠ¨ç«¯å‘é€ + ç½‘å…³æ¥æ”¶éªŒè¯</li>
<li><strong>100-200ms</strong>: gRPC è½¬å‘ + Python ç¼–æ’å‡†å¤‡</li>
<li><strong>200-300ms</strong>: LLM ç”Ÿæˆå¼€å§‹ + çŠ¶æ€æ›´æ–°</li>
<li><strong>300-400ms</strong>: æµå¼è¿”å› + UI å®æ—¶æ¸²æŸ“</li>
</ul>
<p><strong>æ•°æ®æµçš„å®Œæ•´æ€§:</strong></p>
<ul>
<li><strong>è¯·æ±‚æ•°æ®</strong>: ç”¨æˆ·è¾“å…¥ã€ä¼šè¯ IDã€ç”¨æˆ· ID</li>
<li><strong>ä¸Šä¸‹æ–‡æ•°æ®</strong>: ç”¨æˆ·ç”»åƒã€å†å²è®°å½•ã€çŸ¥è¯†æ£€ç´¢</li>
<li><strong>æ§åˆ¶æ•°æ®</strong>: ç†”æ–­çŠ¶æ€ã€é™æµè®¡æ•°ã€é”ä¿¡æ¯</li>
<li><strong>å“åº”æ•°æ®</strong>: æ–‡æœ¬æµã€å·¥å…·è°ƒç”¨ã€çŠ¶æ€æ›´æ–°</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-44">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: æè¿°ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ä»ç§»åŠ¨ç«¯åˆ° AI å¼•æ“çš„æµç¨‹ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç§»åŠ¨ç«¯</strong>: WebSocket è¿æ¥ã€çŠ¶æ€ç®¡ç†ã€UI æ¸²æŸ“</li>
<li><strong>ç½‘å…³å±‚</strong>: è®¤è¯ã€é™æµã€åè®®è½¬æ¢ã€gRPC è½¬å‘</li>
<li><strong>AI å¼•æ“</strong>: 11 æ­¥å¤„ç†é“¾ã€å·¥å…·è°ƒç”¨ã€LLM äº¤äº’</li>
<li><strong>æ•°æ®å±‚</strong>: æ•°æ®åº“æŸ¥è¯¢ã€ç¼“å­˜ã€é˜Ÿåˆ—</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ä¸€ä¸ªå®Œæ•´è¯·æ±‚æµç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆï¼ŒFlutter é€šè¿‡ WebSocket å‘é€ JSON æ¶ˆæ¯ï¼ŒåŒæ—¶æ›´æ–°æœ¬åœ° UI çŠ¶æ€ä¸ºåŠ è½½ä¸­ã€‚Go Gateway æ¥æ”¶æ¶ˆæ¯ï¼Œè¿›è¡Œ JWT è®¤è¯å’Œé…é¢æ£€æŸ¥ï¼Œç„¶åé€šè¿‡ gRPC è½¬å‘ç»™ Python Agentã€‚Python Agent å¯åŠ¨ 11 æ­¥å¤„ç†é“¾ï¼šæ¶ˆæ¯å»é‡ã€ç†”æ–­æ£€æŸ¥ã€å¹¶å‘æ§åˆ¶ã€è¯·æ±‚éªŒè¯ã€å¹‚ç­‰æ£€æŸ¥ã€åˆ†å¸ƒå¼é”ã€æ„å»ºä¸Šä¸‹æ–‡ã€GraphRAG æ£€ç´¢ã€LLM è°ƒç”¨ã€æŒ‡æ ‡è®°å½•ã€èµ„æºæ¸…ç†ã€‚LLM æµå¼è¿”å›æ–‡æœ¬ï¼Œé€šè¿‡ gRPCã€WebSocket é€å—æ¨é€åˆ°ç§»åŠ¨ç«¯ï¼ŒFlutter å®æ—¶æ›´æ–° UIã€‚æ•´ä¸ªæµç¨‹é€šè¿‡ request_id å…¨é“¾è·¯è¿½è¸ªï¼Œä»»ä½•ç¯èŠ‚å‡ºé”™éƒ½æœ‰æ˜ç¡®çš„é™çº§ç­–ç•¥ã€‚"</p>
</blockquote>
<hr>
<h1 id="ä¹-æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ-1">ä¹ã€æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ </h1>
<h2 id="91-æ•°æ®åº“ä¼˜åŒ–-1">9.1 æ•°æ®åº“ä¼˜åŒ– </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-49">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>æ•°æ®åº“ä¼˜åŒ–æ˜¯ <strong>æ€§èƒ½åŸºçŸ³</strong>ï¼Œé€šè¿‡ <strong>å¤šç»´ç´¢å¼•</strong> å’Œ <strong>æŸ¥è¯¢ä¼˜åŒ–</strong> æå‡æ€§èƒ½ï¼š</p>
<ul>
<li><strong>å¤šç»´ç´¢å¼•</strong>: B-Tree + HNSW + BRIN</li>
<li><strong>æŸ¥è¯¢ä¼˜åŒ–</strong>: JOIN åˆå¹¶ï¼Œé¿å… N+1</li>
<li><strong>åˆ†åŒºç­–ç•¥</strong>: æ—¶é—´åˆ†ç‰‡ï¼Œæé«˜æ€§èƒ½</li>
<li><strong>è¿æ¥æ± </strong>: å¤ç”¨è¿æ¥ï¼Œå‡å°‘å¼€é”€</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-50">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="sql" class="language-sql sql"><code><span class="token comment">-- 1. å‘é‡æœç´¢ä¼˜åŒ–ï¼ˆHNSW ç´¢å¼•ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_knowledge_nodes_embedding_hnsw
<span class="token keyword keyword-ON">ON</span> knowledge_nodes
<span class="token keyword keyword-USING">USING</span> hnsw <span class="token punctuation">(</span>embedding vector_cosine_ops<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> ef_construction <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> ef_search <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•æ´»è·ƒæ•°æ®ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_user_node_status_active
<span class="token keyword keyword-ON">ON</span> user_node_status<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> mastery_score<span class="token punctuation">)</span>
<span class="token keyword keyword-WHERE">WHERE</span> mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_covering
<span class="token keyword keyword-ON">ON</span> study_records<span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> completed_at <span class="token keyword keyword-DESC">DESC</span><span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span>node_id<span class="token punctuation">,</span> mastery_delta<span class="token punctuation">,</span> study_minutes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 4. BRIN ç´¢å¼•ï¼ˆæ—¶é—´åºåˆ—ï¼‰</span>
<span class="token keyword keyword-CREATE">CREATE</span> <span class="token keyword keyword-INDEX">INDEX</span> idx_study_records_brin
<span class="token keyword keyword-ON">ON</span> study_records <span class="token keyword keyword-USING">USING</span> BRIN <span class="token punctuation">(</span>completed_at<span class="token punctuation">)</span>
<span class="token keyword keyword-WITH">WITH</span> <span class="token punctuation">(</span>pages_per_range <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 5. æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹</span>
<span class="token keyword keyword-EXPLAIN">EXPLAIN</span> <span class="token keyword keyword-ANALYZE">ANALYZE</span>
<span class="token keyword keyword-SELECT">SELECT</span> uns<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> kn<span class="token punctuation">.</span>name 
<span class="token keyword keyword-FROM">FROM</span> user_node_status uns
<span class="token keyword keyword-JOIN">JOIN</span> knowledge_nodes kn <span class="token keyword keyword-ON">ON</span> uns<span class="token punctuation">.</span>node_id <span class="token operator">=</span> kn<span class="token punctuation">.</span>id
<span class="token keyword keyword-WHERE">WHERE</span> uns<span class="token punctuation">.</span>user_id <span class="token operator">=</span> <span class="token string">'123'</span> 
  <span class="token operator">AND</span> uns<span class="token punctuation">.</span>mastery_score <span class="token operator">&lt;</span> <span class="token number">100</span>
<span class="token keyword keyword-ORDER">ORDER</span> <span class="token keyword keyword-BY">BY</span> uns<span class="token punctuation">.</span>next_review_at
<span class="token keyword keyword-LIMIT">LIMIT</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- ç»“æœï¼šIndex Scan using idx_user_node_status_active</span>
<span class="token comment">-- æ‰§è¡Œæ—¶é—´ï¼š8ms (ä¼˜åŒ–å‰ 45ms)</span>
</code></pre><p><strong>Python è¿æ¥æ± é…ç½®ï¼š</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> sqlalchemy <span class="token keyword keyword-import">import</span> create_engine
<span class="token keyword keyword-from">from</span> sqlalchemy<span class="token punctuation">.</span>pool <span class="token keyword keyword-import">import</span> QueuePool

engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>
    <span class="token string">"postgresql://user:pass@localhost/db"</span><span class="token punctuation">,</span>
    poolclass<span class="token operator">=</span>QueuePool<span class="token punctuation">,</span>
    pool_size<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span>           <span class="token comment"># å¸¸é©»è¿æ¥æ•°</span>
    max_overflow<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>        <span class="token comment"># ä¸´æ—¶è¿æ¥æ•°</span>
    pool_timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>        <span class="token comment"># è·å–è¿æ¥è¶…æ—¶</span>
    pool_recycle<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">,</span>      <span class="token comment"># è¿æ¥å›æ”¶æ—¶é—´</span>
    pool_pre_ping<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>     <span class="token comment"># å¥åº·æ£€æŸ¥</span>
    connect_args<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">'connect_timeout'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">'options'</span><span class="token punctuation">:</span> <span class="token string">'-c statement_timeout=30000'</span>  <span class="token comment"># 30ç§’æŸ¥è¯¢è¶…æ—¶</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># ç›‘æ§è¿æ¥æ± </span>
<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> <span class="token string">'checkout'</span><span class="token punctuation">)</span>
<span class="token keyword keyword-def">def</span> <span class="token function">on_checkout</span><span class="token punctuation">(</span>dbapi_con<span class="token punctuation">,</span> con_record<span class="token punctuation">,</span> con_proxy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    con_record<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'checkout_time'</span><span class="token punctuation">]</span> <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@event<span class="token punctuation">.</span>listens_for</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> <span class="token string">'checkin'</span><span class="token punctuation">)</span>
<span class="token keyword keyword-def">def</span> <span class="token function">on_checkin</span><span class="token punctuation">(</span>dbapi_con<span class="token punctuation">,</span> con_record<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">'checkout_time'</span> <span class="token keyword keyword-in">in</span> con_record<span class="token punctuation">.</span>info<span class="token punctuation">:</span>
        duration <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> con_record<span class="token punctuation">.</span>info<span class="token punctuation">[</span><span class="token string">'checkout_time'</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-if">if</span> duration <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Long connection held for </span><span class="token interpolation"><span class="token punctuation">{</span>duration<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-45">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>ç´¢å¼•ä¼˜åŒ–çš„å†³ç­–æ ‘:</strong></p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>æ•°æ®ç±»å‹?
â”œâ”€â”€ ç»“æ„åŒ–æ•°æ® (ID, æ—¶é—´, çŠ¶æ€)
â”‚   â”œâ”€â”€ ç­‰å€¼æŸ¥è¯¢ â†’ B-Tree
â”‚   â”œâ”€â”€ èŒƒå›´æŸ¥è¯¢ â†’ B-Tree
â”‚   â””â”€â”€ æ—¶é—´åºåˆ— â†’ BRIN
â”œâ”€â”€ åŠç»“æ„åŒ–æ•°æ® (JSON)
â”‚   â””â”€â”€ é”®å€¼æŸ¥è¯¢ â†’ GIN
â””â”€â”€ éç»“æ„åŒ–æ•°æ® (å‘é‡)
    â”œâ”€â”€ é«˜ç²¾åº¦ â†’ HNSW
    â””â”€â”€ é«˜é€Ÿåº¦ â†’ IVFFlat
</code></pre><p><strong>è¿æ¥æ± çš„é‡è¦æ€§:</strong></p>
<ul>
<li><strong>æ€§èƒ½</strong>: å¤ç”¨è¿æ¥ï¼Œé¿å…é¢‘ç¹å»ºç«‹/æ–­å¼€</li>
<li><strong>èµ„æºæ§åˆ¶</strong>: é™åˆ¶æœ€å¤§è¿æ¥æ•°ï¼Œé˜²æ­¢æ•°æ®åº“è¿‡è½½</li>
<li><strong>å¥åº·æ£€æŸ¥</strong>: è‡ªåŠ¨æ£€æµ‹å¤±æ•ˆè¿æ¥</li>
<li><strong>ç›‘æ§</strong>: è¿æ¥ä½¿ç”¨æƒ…å†µå¯è§†åŒ–</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-45">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•ä¼˜åŒ–ä¸€ä¸ªæ…¢æŸ¥è¯¢ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>EXPLAIN ANALYZE</strong>: åˆ†ææ‰§è¡Œè®¡åˆ’</li>
<li><strong>ç´¢å¼•ä¼˜åŒ–</strong>: æ·»åŠ ç¼ºå¤±ç´¢å¼•ï¼Œä¼˜åŒ–ç°æœ‰ç´¢å¼•</li>
<li><strong>æŸ¥è¯¢é‡å†™</strong>: é¿å… N+1ï¼Œä½¿ç”¨ JOIN</li>
<li><strong>å‚æ•°è°ƒä¼˜</strong>: è°ƒæ•´æ•°æ®åº“å‚æ•°</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ä¼˜åŒ–æ…¢æŸ¥è¯¢çš„æ­¥éª¤ï¼šé¦–å…ˆï¼Œä½¿ç”¨ EXPLAIN ANALYZE åˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œæ‰¾å‡ºå…¨è¡¨æ‰«ææˆ–ä½æ•ˆæ“ä½œï¼›å…¶æ¬¡ï¼Œæ£€æŸ¥æ˜¯å¦ç¼ºå°‘ç´¢å¼•ï¼Œæ·»åŠ åˆé€‚çš„ç´¢å¼•ï¼ˆB-Treeã€HNSW ç­‰ï¼‰ï¼›ç¬¬ä¸‰ï¼Œé‡å†™æŸ¥è¯¢ï¼Œé¿å… N+1 é—®é¢˜ï¼Œä½¿ç”¨ JOIN æˆ–æ‰¹é‡æŸ¥è¯¢ï¼›ç¬¬å››ï¼Œæ£€æŸ¥ç´¢å¼•æ˜¯å¦è¢«æ­£ç¡®ä½¿ç”¨ï¼Œé¿å…ç´¢å¼•å¤±æ•ˆï¼›æœ€åï¼Œå¦‚æœæ•°æ®é‡å·¨å¤§ï¼Œè€ƒè™‘åˆ†åŒºæˆ–åˆ†è¡¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ›¾å°†ä¸€ä¸ª 45ms çš„æŸ¥è¯¢ä¼˜åŒ–åˆ° 8msï¼Œé€šè¿‡æ·»åŠ éƒ¨åˆ†ç´¢å¼•å’Œä½¿ç”¨è¦†ç›–ç´¢å¼•ã€‚"</p>
</blockquote>
<hr>
<h2 id="92-å¹¶å‘æ§åˆ¶">9.2 å¹¶å‘æ§åˆ¶ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-50">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å¹¶å‘æ§åˆ¶æ˜¯ <strong>èµ„æºç®¡ç†</strong> çš„æ ¸å¿ƒï¼Œé˜²æ­¢èµ„æºè€—å°½ï¼š</p>
<ul>
<li><strong>åˆ†å¸ƒå¼ä¿¡å·é‡</strong>: å…¨å±€é™åˆ¶å¹¶å‘æ•°</li>
<li><strong>æµé‡æ§åˆ¶</strong>: é˜²æ­¢å•ç”¨æˆ·å æ»¡èµ„æº</li>
<li><strong>èµ„æºéš”ç¦»</strong>: å¤šç§Ÿæˆ·å…¬å¹³ç«äº‰</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-51">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">DistributedSemaphore</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åˆ†å¸ƒå¼ä¿¡å·é‡"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">,</span> key<span class="token punctuation">,</span> max_permits<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client
        self<span class="token punctuation">.</span>key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"semaphore:</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        self<span class="token punctuation">.</span>max_permits <span class="token operator">=</span> max_permits
        self<span class="token punctuation">.</span>timeout <span class="token operator">=</span> timeout

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">acquire</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è·å–ä¿¡å·é‡"""</span>
        lease_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        local key = KEYS[1]
        local max_permits = tonumber(ARGV[1])
        local timeout = tonumber(ARGV[2])
        local lease_id = ARGV[3]

        local current = redis.call('GET', key)
        if not current then
            current = 0
        else
            current = tonumber(current)
        end

        if current &lt; max_permits then
            redis.call('INCR', key)
            redis.call('SETEX', key .. ':lease:' .. lease_id, timeout, 1)
            return 1
        else
            return 0
        end
        """</span>

        acquired <span class="token operator">=</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>
            script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>max_permits<span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">,</span> lease_id
        <span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> acquired<span class="token punctuation">:</span>
            <span class="token comment"># å¯åŠ¨ç»­æœŸä»»åŠ¡</span>
            asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_renew_lease<span class="token punctuation">(</span>lease_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> lease_id
        
        <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_renew_lease</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lease_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è‡ªåŠ¨ç»­æœŸ"""</span>
        <span class="token keyword keyword-while">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>self<span class="token punctuation">.</span>timeout <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">)</span>
                key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>key<span class="token punctuation">}</span></span><span class="token string">:lease:</span><span class="token interpolation"><span class="token punctuation">{</span>lease_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>expire<span class="token punctuation">(</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-break">break</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">release</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lease_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""é‡Šæ”¾ä¿¡å·é‡"""</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> lease_id<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span>

        script <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
        local key = KEYS[1]
        local lease_id = ARGV[1]

        redis.call('DECR', key)
        redis.call('DEL', key .. ':lease:' .. lease_id)
        return 1
        """</span>

        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>key<span class="token punctuation">,</span> lease_id<span class="token punctuation">)</span>

<span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> request_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># å…¨å±€é™åˆ¶ 100 ä¸ªå¹¶å‘</span>
    global_sem <span class="token operator">=</span> DistributedSemaphore<span class="token punctuation">(</span>redis_client<span class="token punctuation">,</span> <span class="token string">"global_ai_processing"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
    
    <span class="token comment"># ç”¨æˆ·çº§é™åˆ¶ 5 ä¸ªå¹¶å‘</span>
    user_sem <span class="token operator">=</span> DistributedSemaphore<span class="token punctuation">(</span>redis_client<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"user_</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    
    <span class="token comment"># è·å–ä¸¤ä¸ªä¿¡å·é‡</span>
    global_lease <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> global_sem<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> global_lease<span class="token punctuation">:</span>
        <span class="token keyword keyword-raise">raise</span> RateLimitError<span class="token punctuation">(</span><span class="token string">"ç³»ç»Ÿè´Ÿè½½è¿‡é«˜"</span><span class="token punctuation">)</span>
    
    user_lease <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> user_sem<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> user_lease<span class="token punctuation">:</span>
        <span class="token keyword keyword-await">await</span> global_sem<span class="token punctuation">.</span>release<span class="token punctuation">(</span>global_lease<span class="token punctuation">)</span>
        <span class="token keyword keyword-raise">raise</span> RateLimitError<span class="token punctuation">(</span><span class="token string">"æ‚¨çš„è¯·æ±‚è¿‡å¤š"</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> process_ai_request<span class="token punctuation">(</span>request_data<span class="token punctuation">)</span>
    <span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-await">await</span> global_sem<span class="token punctuation">.</span>release<span class="token punctuation">(</span>global_lease<span class="token punctuation">)</span>
        <span class="token keyword keyword-await">await</span> user_sem<span class="token punctuation">.</span>release<span class="token punctuation">(</span>user_lease<span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-46">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å¹¶å‘æ§åˆ¶çš„å±‚æ¬¡:</strong></p>
<ul>
<li><strong>å…¨å±€çº§</strong>: ç³»ç»Ÿæ€»å®¹é‡é™åˆ¶</li>
<li><strong>ç”¨æˆ·çº§</strong>: é˜²æ­¢å•ä¸ªç”¨æˆ·å æ»¡èµ„æº</li>
<li><strong>IPçº§</strong>: é˜²æ­¢æ¶æ„æ”»å‡»</li>
<li><strong>æœåŠ¡çº§</strong>: ä¸‹æ¸¸æœåŠ¡å®¹é‡é™åˆ¶</li>
</ul>
<p><strong>ä¿¡å·é‡ vs é™æµ:</strong></p>
<ul>
<li><strong>ä¿¡å·é‡</strong>: é™åˆ¶å¹¶å‘æ‰§è¡Œæ•°é‡ï¼ˆåŒæ—¶è¿›è¡Œçš„ä»»åŠ¡æ•°ï¼‰</li>
<li><strong>é™æµ</strong>: é™åˆ¶å•ä½æ—¶é—´è¯·æ±‚é‡ï¼ˆQPSï¼‰</li>
<li><strong>é…åˆä½¿ç”¨</strong>: ä¿¡å·é‡é˜²æ­¢èµ„æºè€—å°½ï¼Œé™æµé˜²æ­¢è¯·æ±‚å †ç§¯</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-46">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•é˜²æ­¢å•ä¸ªç”¨æˆ·å æ»¡ç³»ç»Ÿèµ„æºï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>ç”¨æˆ·çº§é™æµ</strong>: é™åˆ¶ QPS</li>
<li><strong>ç”¨æˆ·çº§å¹¶å‘</strong>: é™åˆ¶åŒæ—¶è¯·æ±‚æ•°</li>
<li><strong>èµ„æºéš”ç¦»</strong>: å¤šç§Ÿæˆ·èµ„æºåˆ†é…</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>: å¼‚å¸¸è¡Œä¸ºæ£€æµ‹</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨å¤šå±‚é˜²æŠ¤ï¼šç¬¬ä¸€ï¼Œç”¨æˆ·çº§é™æµï¼Œé™åˆ¶æ¯ç§’è¯·æ±‚é‡ï¼›ç¬¬äºŒï¼Œç”¨æˆ·çº§å¹¶å‘æ§åˆ¶ï¼Œé™åˆ¶åŒæ—¶è¿›è¡Œçš„ä»»åŠ¡æ•°ï¼›ç¬¬ä¸‰ï¼Œèµ„æºéš”ç¦»ï¼Œé€šè¿‡ Redis é”®åç©ºé—´éš”ç¦»ä¸åŒç”¨æˆ·çš„æ•°æ®ï¼›ç¬¬å››ï¼Œç›‘æ§å‘Šè­¦ï¼Œæ£€æµ‹å¼‚å¸¸è¡Œä¸ºï¼ˆå¦‚è¯·æ±‚é‡çªå¢ï¼‰ã€‚è¿™äº›æªæ–½é…åˆä½¿ç”¨ï¼Œç¡®ä¿å•ä¸ªç”¨æˆ·çš„å¼‚å¸¸è¡Œä¸ºä¸ä¼šå½±å“å…¶ä»–ç”¨æˆ·ã€‚"</p>
</blockquote>
<hr>
<h2 id="93-ç¼“å­˜ç­–ç•¥">9.3 ç¼“å­˜ç­–ç•¥ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-51">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>ç¼“å­˜æ˜¯ <strong>æ€§èƒ½ä¼˜åŒ–</strong> çš„æ ¸å¿ƒï¼Œé€šè¿‡ <strong>å¤šçº§ç¼“å­˜</strong> å’Œ <strong>è¯­ä¹‰ç¼“å­˜</strong> æå‡æ€§èƒ½ï¼š</p>
<ul>
<li><strong>å¤šçº§ç¼“å­˜</strong>: L1 å†…å­˜ + L2 Redis</li>
<li><strong>è¯­ä¹‰ç¼“å­˜</strong>: å‘é‡ç›¸ä¼¼åº¦åŒ¹é…</li>
<li><strong>ç¼“å­˜å‡»ç©¿</strong>: äº’æ–¥é”é‡å»º</li>
<li><strong>ç¼“å­˜é›ªå´©</strong>: éšæœºè¿‡æœŸæ—¶é—´</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-52">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">MultiLevelCache</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""L1 (å†…å­˜) + L2 (Redis) åŒå±‚æ¶æ„"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">,</span> l1_ttl<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span> l2_ttl<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client
        self<span class="token punctuation">.</span>memory_cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># {key: (value, expire_time)}</span>
        self<span class="token punctuation">.</span>l1_ttl <span class="token operator">=</span> l1_ttl
        self<span class="token punctuation">.</span>l2_ttl <span class="token operator">=</span> l2_ttl
        self<span class="token punctuation">.</span>locks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># é˜²æ­¢ç¼“å­˜å‡»ç©¿</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># 1. L1 æŸ¥è¯¢ï¼ˆå¾®ç§’çº§ï¼‰</span>
        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> key <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>memory_cache<span class="token punctuation">:</span>
            value<span class="token punctuation">,</span> expire <span class="token operator">=</span> self<span class="token punctuation">.</span>memory_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword keyword-if">if</span> expire <span class="token operator">&gt;</span> now<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> value
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-del">del</span> self<span class="token punctuation">.</span>memory_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

        <span class="token comment"># 2. L2 æŸ¥è¯¢ï¼ˆæ¯«ç§’çº§ï¼‰</span>
        value <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"l2:</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> value<span class="token punctuation">:</span>
            <span class="token comment"># å›å¡« L1</span>
            self<span class="token punctuation">.</span>memory_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> now <span class="token operator">+</span> self<span class="token punctuation">.</span>l1_ttl<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>value<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Any<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># L1 è®¾ç½®</span>
        self<span class="token punctuation">.</span>memory_cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">,</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>l1_ttl<span class="token punctuation">)</span>

        <span class="token comment"># L2 è®¾ç½®</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f"l2:</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>l2_ttl<span class="token punctuation">,</span>
            pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_or_set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> func<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""ç¼“å­˜ç©¿é€ä¿æŠ¤"""</span>
        <span class="token comment"># å¿«é€Ÿè·¯å¾„</span>
        cached <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> cached <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> cached

        <span class="token comment"># ç¼“å­˜å‡»ç©¿ä¿æŠ¤ï¼ˆåˆ†å¸ƒå¼é”ï¼‰</span>
        lock_key <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"lock:</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        lock_acquired <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>
            lock_key<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> nx<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> ex<span class="token operator">=</span><span class="token number">10</span>
        <span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> lock_acquired<span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                <span class="token comment"># åŒé‡æ£€æŸ¥</span>
                cached <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                <span class="token keyword keyword-if">if</span> cached <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-return">return</span> cached

                <span class="token comment"># è®¡ç®—å¹¶ç¼“å­˜</span>
                value <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> value
            <span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>lock_key<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token comment"># ç­‰å¾…å…¶ä»–è¿›ç¨‹ç¼“å­˜</span>
            <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">)</span>

<span class="token comment"># è¯­ä¹‰ç¼“å­˜</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">SemanticCache</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰ç¼“å­˜"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> redis_client<span class="token punctuation">,</span> llm_service<span class="token punctuation">,</span> threshold<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>redis <span class="token operator">=</span> redis_client
        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> llm_service
        self<span class="token punctuation">.</span>threshold <span class="token operator">=</span> threshold

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æŸ¥æ‰¾è¯­ä¹‰ç›¸ä¼¼çš„ç¼“å­˜"""</span>
        query_embedding <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>get_embedding<span class="token punctuation">(</span>query<span class="token punctuation">)</span>

        cached <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>hgetall<span class="token punctuation">(</span><span class="token string">"semantic_cache:vectors"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> cached<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>

        similarities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-for">for</span> cached_query<span class="token punctuation">,</span> cached_vec_str <span class="token keyword keyword-in">in</span> cached<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            cached_vec <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>cached_vec_str<span class="token punctuation">)</span><span class="token punctuation">)</span>
            similarity <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>query_embedding<span class="token punctuation">,</span> cached_vec<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>
                np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>query_embedding<span class="token punctuation">)</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>cached_vec<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

            <span class="token keyword keyword-if">if</span> similarity <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>threshold<span class="token punctuation">:</span>
                similarities<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>similarity<span class="token punctuation">,</span> cached_query<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> similarities<span class="token punctuation">:</span>
            similarities<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            best_match <span class="token operator">=</span> similarities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            answer <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>hget<span class="token punctuation">(</span><span class="token string">"semantic_cache:answers"</span><span class="token punctuation">,</span> best_match<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> answer

        <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> answer<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""ç¼“å­˜é—®é¢˜å’Œç­”æ¡ˆ"""</span>
        query_vec <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>get_embedding<span class="token punctuation">(</span>query<span class="token punctuation">)</span>

        pipeline <span class="token operator">=</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>pipeline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        pipeline<span class="token punctuation">.</span>hset<span class="token punctuation">(</span><span class="token string">"semantic_cache:vectors"</span><span class="token punctuation">,</span> query<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>query_vec<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pipeline<span class="token punctuation">.</span>hset<span class="token punctuation">(</span><span class="token string">"semantic_cache:answers"</span><span class="token punctuation">,</span> query<span class="token punctuation">,</span> answer<span class="token punctuation">)</span>
        pipeline<span class="token punctuation">.</span>expire<span class="token punctuation">(</span><span class="token string">"semantic_cache:vectors"</span><span class="token punctuation">,</span> <span class="token number">86400</span><span class="token punctuation">)</span>
        pipeline<span class="token punctuation">.</span>expire<span class="token punctuation">(</span><span class="token string">"semantic_cache:answers"</span><span class="token punctuation">,</span> <span class="token number">86400</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-await">await</span> pipeline<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># ç¼“å­˜é›ªå´©é˜²æŠ¤</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">AvalancheProtector</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""é˜²æ­¢ç¼“å­˜é›ªå´©"""</span>
    
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">set_with_jitter</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> base_ttl<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ·»åŠ éšæœºæŠ–åŠ¨"""</span>
        jitter <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span> <span class="token operator">*</span> base_ttl
        ttl <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>base_ttl <span class="token operator">+</span> jitter<span class="token punctuation">)</span>

        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>setex<span class="token punctuation">(</span>key<span class="token punctuation">,</span> ttl<span class="token punctuation">,</span> pickle<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># è®°å½•ç›‘æ§</span>
        <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>zadd<span class="token punctuation">(</span>
            <span class="token string">"cache:ttl_distribution"</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>key<span class="token punctuation">:</span> ttl<span class="token punctuation">}</span>
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_batch_with_fallback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> keys<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ‰¹é‡è·å–ï¼Œæ”¯æŒé™çº§"""</span>
        values <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>mget<span class="token punctuation">(</span>keys<span class="token punctuation">)</span>
        missing_keys <span class="token operator">=</span> <span class="token punctuation">[</span>k <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> v <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> v <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">]</span>

        <span class="token keyword keyword-if">if</span> missing_keys<span class="token punctuation">:</span>
            <span class="token comment"># æ‰¹é‡åŠ è½½</span>
            loaded <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> loader<span class="token punctuation">(</span>missing_keys<span class="token punctuation">)</span>

            <span class="token comment"># å¹¶è¡Œè®¾ç½®ï¼ˆä¸ç­‰å¾…ï¼‰</span>
            <span class="token keyword keyword-for">for</span> key<span class="token punctuation">,</span> value <span class="token keyword keyword-in">in</span> loaded<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>
                    self<span class="token punctuation">.</span>set_with_jitter<span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>

            <span class="token comment"># åˆå¹¶ç»“æœ</span>
            result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> key <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-elif">elif</span> key <span class="token keyword keyword-in">in</span> loaded<span class="token punctuation">:</span>
                    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> loaded<span class="token punctuation">[</span>key<span class="token punctuation">]</span>

            <span class="token keyword keyword-return">return</span> result

        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span> pickle<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> k<span class="token punctuation">,</span> v <span class="token keyword keyword-in">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> values<span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> v<span class="token punctuation">}</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-47">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å¤šçº§ç¼“å­˜çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>æ€§èƒ½</strong>: L1 ç¼“å­˜æ‹¦æˆª 80% è¯·æ±‚ï¼Œå“åº”æ—¶é—´ä»æ¯«ç§’é™åˆ°å¾®ç§’</li>
<li><strong>æˆæœ¬</strong>: å‡å°‘ Redis ç½‘ç»œ IO å’Œ CPU å¼€é”€</li>
<li><strong>å¯é æ€§</strong>: Redis æ•…éšœæ—¶ L1 ä»å¯å·¥ä½œ</li>
</ul>
<p><strong>è¯­ä¹‰ç¼“å­˜çš„åˆ›æ–°:</strong></p>
<ul>
<li><strong>é—®é¢˜</strong>: ä¼ ç»Ÿç¼“å­˜åªèƒ½ç²¾ç¡®åŒ¹é…ï¼Œæ— æ³•å¤„ç†è¯­ä¹‰ç›¸ä¼¼çš„é—®é¢˜</li>
<li><strong>è§£å†³</strong>: å‘é‡ç›¸ä¼¼åº¦åŒ¹é…ï¼Œ"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ " å’Œ "æœºå™¨å­¦ä¹ æ˜¯ä»€ä¹ˆ" å…±äº«ç¼“å­˜</li>
<li><strong>ä»·å€¼</strong>: æå‡ç¼“å­˜å‘½ä¸­ç‡ï¼Œå‡å°‘ LLM è°ƒç”¨</li>
</ul>
<p><strong>ç¼“å­˜é˜²æŠ¤æœºåˆ¶:</strong></p>
<ul>
<li><strong>å‡»ç©¿</strong>: çƒ­ç‚¹ key è¿‡æœŸç¬é—´å¤§é‡è¯·æ±‚ï¼Œä½¿ç”¨äº’æ–¥é”é‡å»º</li>
<li><strong>é›ªå´©</strong>: å¤§é‡ key åŒæ—¶è¿‡æœŸï¼Œæ·»åŠ éšæœºæŠ–åŠ¨</li>
<li><strong>ç©¿é€</strong>: æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æˆ–ç¼“å­˜ç©ºå€¼</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-47">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•è®¾è®¡ä¸€ä¸ªé«˜å¯ç”¨çš„ç¼“å­˜ç³»ç»Ÿï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>å¤šçº§ç¼“å­˜</strong>: L1 + L2 + L3 (CDN)</li>
<li><strong>ç¼“å­˜ç­–ç•¥</strong>: è¯»å†™ç­–ç•¥ã€è¿‡æœŸç­–ç•¥ã€æ·˜æ±°ç­–ç•¥</li>
<li><strong>é˜²æŠ¤æœºåˆ¶</strong>: å‡»ç©¿ã€é›ªå´©ã€ç©¿é€é˜²æŠ¤</li>
<li><strong>ç›‘æ§å‘Šè­¦</strong>: å‘½ä¸­ç‡ã€å»¶è¿Ÿã€é”™è¯¯ç‡</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"é«˜å¯ç”¨ç¼“å­˜ç³»ç»Ÿéœ€è¦å¤šå±‚è®¾è®¡ï¼šç¬¬ä¸€ï¼Œå¤šçº§ç¼“å­˜ï¼ŒL1 å†…å­˜ï¼ˆå¾®ç§’çº§ï¼‰ã€L2 Redisï¼ˆæ¯«ç§’çº§ï¼‰ã€L3 æ•°æ®åº“ï¼ˆç§’çº§ï¼‰ï¼›ç¬¬äºŒï¼Œç¼“å­˜ç­–ç•¥ï¼Œè¯»æ“ä½œå…ˆæŸ¥ç¼“å­˜ï¼Œå†™æ“ä½œæ›´æ–°ç¼“å­˜å¹¶è®¾ç½®è¿‡æœŸï¼›ç¬¬ä¸‰ï¼Œé˜²æŠ¤æœºåˆ¶ï¼Œäº’æ–¥é”é˜²å‡»ç©¿ã€éšæœº TTL é˜²é›ªå´©ã€å¸ƒéš†è¿‡æ»¤å™¨é˜²ç©¿é€ï¼›ç¬¬å››ï¼Œç›‘æ§ï¼Œå®æ—¶ç›‘æ§å‘½ä¸­ç‡ï¼ˆç›®æ ‡ &gt; 80%ï¼‰ã€å»¶è¿Ÿã€é”™è¯¯ç‡ã€‚æˆ‘ä»¬è¿˜å®ç°äº†è¯­ä¹‰ç¼“å­˜ï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦æå‡å‘½ä¸­ç‡ 30%ã€‚"</p>
</blockquote>
<hr>
<h2 id="94-å¼‚æ­¥ä¼˜åŒ–">9.4 å¼‚æ­¥ä¼˜åŒ– </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-52">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>å¼‚æ­¥ä¼˜åŒ–æ˜¯ <strong>é«˜å¹¶å‘</strong> çš„åŸºç¡€ï¼Œé€šè¿‡ <strong>å¹¶å‘æ‰§è¡Œ</strong> å’Œ <strong>RAII æ¨¡å¼</strong> æå‡æ€§èƒ½ï¼š</p>
<ul>
<li><strong>å¹¶å‘æ‰§è¡Œ</strong>: asyncio.gather å¹¶è¡Œä»»åŠ¡</li>
<li><strong>é™æµå¹¶å‘</strong>: Semaphore æ§åˆ¶å¹¶å‘æ•°</li>
<li><strong>RAII æ¨¡å¼</strong>: è‡ªåŠ¨äº‹åŠ¡ç®¡ç†</li>
<li><strong>èµ„æºæ¸…ç†</strong>: finally å—ä¿è¯</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-53">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># ä¼˜åŒ–å‰ï¼šä¸²è¡Œæ‰§è¡Œ</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_concurrently_bad</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">:</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> req <span class="token keyword keyword-in">in</span> requests<span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> process_single<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> results
<span class="token comment"># æ€»è€—æ—¶ï¼šsum(æ¯ä¸ªè¯·æ±‚è€—æ—¶)</span>

<span class="token comment"># ä¼˜åŒ–åï¼šå¹¶å‘æ‰§è¡Œ</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_concurrently_good</span><span class="token punctuation">(</span>requests<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tasks <span class="token operator">=</span> <span class="token punctuation">[</span>process_single<span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> req <span class="token keyword keyword-in">in</span> requests<span class="token punctuation">]</span>
    results <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">,</span> return_exceptions<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> results
<span class="token comment"># æ€»è€—æ—¶ï¼šmax(æ¯ä¸ªè¯·æ±‚è€—æ—¶)</span>

<span class="token comment"># å¸¦é™æµçš„å¹¶å‘</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_with_semaphore</span><span class="token punctuation">(</span>requests<span class="token punctuation">,</span> max_concurrent<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    semaphore <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>Semaphore<span class="token punctuation">(</span>max_concurrent<span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">process_with_limit</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-with">with</span> semaphore<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> process_single<span class="token punctuation">(</span>req<span class="token punctuation">)</span>

    tasks <span class="token operator">=</span> <span class="token punctuation">[</span>process_with_limit<span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> req <span class="token keyword keyword-in">in</span> requests<span class="token punctuation">]</span>
    <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-await">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">)</span>

<span class="token comment"># RAII æ¨¡å¼ï¼šè‡ªåŠ¨äº‹åŠ¡ç®¡ç†</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">AsyncTransaction</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""è‡ªåŠ¨äº‹åŠ¡ç®¡ç†å™¨"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> db_session<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>session <span class="token operator">=</span> db_session
        self<span class="token punctuation">.</span>committed <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">__aenter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> self

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">__aexit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        è‡ªåŠ¨æäº¤æˆ–å›æ»š
        """</span>
        <span class="token keyword keyword-if">if</span> exc_type <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span> <span class="token keyword keyword-and">and</span> <span class="token keyword keyword-not">not</span> self<span class="token punctuation">.</span>committed<span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>committed <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword keyword-except">except</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-raise">raise</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token comment"># å‘ç”Ÿå¼‚å¸¸ï¼Œå›æ»š</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">commit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ˜¾å¼æäº¤"""</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> self<span class="token punctuation">.</span>committed<span class="token punctuation">:</span>
            <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>committed <span class="token operator">=</span> <span class="token boolean">True</span>

<span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">update_user_progress</span><span class="token punctuation">(</span>user_id<span class="token punctuation">,</span> node_id<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-with">with</span> AsyncTransaction<span class="token punctuation">(</span>db<span class="token punctuation">.</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
        user <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        user<span class="token punctuation">.</span>total_score <span class="token operator">+=</span> score

        record <span class="token operator">=</span> StudyRecord<span class="token punctuation">(</span>
            user_id<span class="token operator">=</span>user_id<span class="token punctuation">,</span>
            node_id<span class="token operator">=</span>node_id<span class="token punctuation">,</span>
            score<span class="token operator">=</span>score
        <span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>add<span class="token punctuation">(</span>record<span class="token punctuation">)</span>

        <span class="token comment"># è‡ªåŠ¨æäº¤ï¼Œå¼‚å¸¸è‡ªåŠ¨å›æ»š</span>

<span class="token comment"># èµ„æºç®¡ç†å™¨</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ResourceManager</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾çš„ç®¡ç†å™¨"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>resources <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">add</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> cleanup_func<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ³¨å†Œèµ„æºå’Œæ¸…ç†å‡½æ•°"""</span>
        self<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> cleanup_func<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">cleanup</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""æ¸…ç†æ‰€æœ‰èµ„æº"""</span>
        errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-for">for</span> resource<span class="token punctuation">,</span> cleanup <span class="token keyword keyword-in">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>resources<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> asyncio<span class="token punctuation">.</span>iscoroutinefunction<span class="token punctuation">(</span>cleanup<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword keyword-await">await</span> cleanup<span class="token punctuation">(</span>resource<span class="token punctuation">)</span>
                <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                    cleanup<span class="token punctuation">(</span>resource<span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span>e<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> errors<span class="token punctuation">:</span>
            <span class="token keyword keyword-raise">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Cleanup errors: </span><span class="token interpolation"><span class="token punctuation">{</span>errors<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">complex_operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    manager <span class="token operator">=</span> ResourceManager<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># è·å–èµ„æº</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"temp.txt"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span>
        manager<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> <span class="token keyword keyword-lambda">lambda</span> f<span class="token punctuation">:</span> f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        conn <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> acquire_db_connection<span class="token punctuation">(</span><span class="token punctuation">)</span>
        manager<span class="token punctuation">.</span>add<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token keyword keyword-lambda">lambda</span> c<span class="token punctuation">:</span> c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        cache_lock <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> acquire_lock<span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span>
        manager<span class="token punctuation">.</span>add<span class="token punctuation">(</span>cache_lock<span class="token punctuation">,</span> <span class="token keyword keyword-lambda">lambda</span> l<span class="token punctuation">:</span> l<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># æ‰§è¡Œæ“ä½œ</span>
        result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> perform_task<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">,</span> conn<span class="token punctuation">,</span> cache_lock<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> result

    <span class="token keyword keyword-finally">finally</span><span class="token punctuation">:</span>
        <span class="token comment"># ç¡®ä¿æ¸…ç†</span>
        <span class="token keyword keyword-await">await</span> manager<span class="token punctuation">.</span>cleanup<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-48">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>å¹¶å‘ vs å¹¶è¡Œ:</strong></p>
<ul>
<li><strong>å¹¶å‘</strong>: åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼ˆå•æ ¸åˆ‡æ¢ï¼‰</li>
<li><strong>å¹¶è¡Œ</strong>: åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼ˆå¤šæ ¸ï¼‰</li>
<li><strong>Sparkle</strong>: asyncio å®ç°å¹¶å‘ï¼Œé€‚åˆ IO å¯†é›†å‹</li>
</ul>
<p><strong>RAII æ¨¡å¼çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>èµ„æºå®‰å…¨</strong>: è‡ªåŠ¨é‡Šæ”¾ï¼Œé˜²æ­¢æ³„æ¼</li>
<li><strong>å¼‚å¸¸å®‰å…¨</strong>: å³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿèƒ½æ¸…ç†</li>
<li><strong>ä»£ç ç®€æ´</strong>: æ— éœ€æ‰‹åŠ¨ç®¡ç†èµ„æº</li>
</ul>
<p><strong>å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ:</strong></p>
<ul>
<li><strong>é¿å…é˜»å¡</strong>: ä¸è¦åœ¨åç¨‹ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ</li>
<li><strong>åˆç†å¹¶å‘</strong>: ä½¿ç”¨ Semaphore é˜²æ­¢è¿‡åº¦å¹¶å‘</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: ä½¿ç”¨ try/except å’Œ finally</li>
<li><strong>ç›‘æ§</strong>: è·Ÿè¸ªåç¨‹æ•°é‡å’Œæ‰§è¡Œæ—¶é—´</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-48">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: asyncio.gather å’Œæ‰‹åŠ¨å¾ªç¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>æ€§èƒ½</strong>: gather å¹¶å‘æ‰§è¡Œï¼Œå¾ªç¯ä¸²è¡Œ</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: gather æ”¯æŒ return_exceptions</li>
<li><strong>å¯è¯»æ€§</strong>: gather æ›´ç®€æ´</li>
<li><strong>æ§åˆ¶</strong>: Semaphore å¯ä»¥é™åˆ¶å¹¶å‘æ•°</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"asyncio.gather å’Œæ‰‹åŠ¨å¾ªç¯çš„æ ¸å¿ƒåŒºåˆ«æ˜¯å¹¶å‘æ€§ã€‚æ‰‹åŠ¨å¾ªç¯æ˜¯ä¸²è¡Œçš„ï¼Œæ€»è€—æ—¶æ˜¯æ‰€æœ‰ä»»åŠ¡è€—æ—¶ä¹‹å’Œï¼›gather æ˜¯å¹¶å‘çš„ï¼Œæ€»è€—æ—¶æ˜¯æœ€æ…¢ä»»åŠ¡çš„è€—æ—¶ã€‚æ­¤å¤–ï¼Œgather æ”¯æŒ return_exceptions å‚æ•°ï¼Œå¯ä»¥ç»Ÿä¸€å¤„ç†å¼‚å¸¸ï¼›è€Œæ‰‹åŠ¨å¾ªç¯éœ€è¦åœ¨æ¯ä¸ªä»»åŠ¡ä¸­å•ç‹¬å¤„ç†ã€‚å¯¹äºéœ€è¦é™åˆ¶å¹¶å‘æ•°çš„åœºæ™¯ï¼Œå¯ä»¥é…åˆ Semaphore ä½¿ç”¨ã€‚åœ¨ Sparkle ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¹¶å‘å¤„ç†æ‰¹é‡çŸ¥è¯†æ£€ç´¢ï¼Œæ€§èƒ½æå‡ 5-10 å€ã€‚"</p>
</blockquote>
<hr>
<h2 id="95-æ€§èƒ½æŒ‡æ ‡">9.5 æ€§èƒ½æŒ‡æ ‡ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-53">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<p>æ€§èƒ½æŒ‡æ ‡æ˜¯ <strong>ç³»ç»Ÿå¥åº·åº¦</strong> çš„é‡åŒ–ï¼Œé€šè¿‡ <strong>å¤šç»´åº¦ç›‘æ§</strong> å®ç°ï¼š</p>
<ul>
<li><strong>å»¶è¿Ÿ</strong>: P50/P95/P99 åˆ†ä½æ•°</li>
<li><strong>ååé‡</strong>: QPSã€å¹¶å‘è¿æ¥æ•°</li>
<li><strong>èµ„æº</strong>: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ</li>
<li><strong>ä¸šåŠ¡</strong>: ç¼“å­˜å‘½ä¸­ç‡ã€é”™è¯¯ç‡ã€æˆåŠŸç‡</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-54">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">LatencyTracker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å®æ—¶å»¶è¿ŸæŒ‡æ ‡è®¡ç®—"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> window_seconds<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>window <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>window_seconds <span class="token operator">=</span> window_seconds

    <span class="token keyword keyword-def">def</span> <span class="token function">record</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> latency_ms<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•å»¶è¿Ÿ"""</span>
        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>window<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> latency_ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># æ¸…ç†è¿‡æœŸæ•°æ®</span>
        <span class="token keyword keyword-while">while</span> self<span class="token punctuation">.</span>window <span class="token keyword keyword-and">and</span> now <span class="token operator">-</span> self<span class="token punctuation">.</span>window<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>window_seconds<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>window<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_percentiles</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è·å– P50/P95/P99"""</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> self<span class="token punctuation">.</span>window<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>

        latencies <span class="token operator">=</span> <span class="token punctuation">[</span>l <span class="token keyword keyword-for">for</span> _<span class="token punctuation">,</span> l <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>window<span class="token punctuation">]</span>
        latencies<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">'p50'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>latencies<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'p95'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>latencies<span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'p99'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>latencies<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'count'</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>latencies<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'avg'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>latencies<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

<span class="token keyword keyword-class">class</span> <span class="token class-name">QPSTracker</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å®æ—¶ QPS è¿½è¸ª"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>request_times <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>active_connections <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>max_concurrent <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">record_request</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®°å½•è¯·æ±‚"""</span>
        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>request_times<span class="token punctuation">.</span>append<span class="token punctuation">(</span>now<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>active_connections <span class="token operator">+=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>max_concurrent <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_concurrent<span class="token punctuation">,</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">finish_request</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è¯·æ±‚å®Œæˆ"""</span>
        self<span class="token punctuation">.</span>active_connections <span class="token operator">-=</span> <span class="token number">1</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_qps</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> window<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""è®¡ç®—æœ€è¿‘ window ç§’çš„ QPS"""</span>
        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># æ¸…ç†è¿‡æœŸ</span>
        <span class="token keyword keyword-while">while</span> self<span class="token punctuation">.</span>request_times <span class="token keyword keyword-and">and</span> now <span class="token operator">-</span> self<span class="token punctuation">.</span>request_times<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> window<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>request_times<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>request_times<span class="token punctuation">)</span> <span class="token operator">/</span> window

<span class="token keyword keyword-class">class</span> <span class="token class-name">BusinessMetrics</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""ä¸šåŠ¡æŒ‡æ ‡"""</span>
    
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cache_hits <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>cache_misses <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>total_requests <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>errors <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">record_cache_hit</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cache_hits <span class="token operator">+=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>total_requests <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">record_cache_miss</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cache_misses <span class="token operator">+=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>total_requests <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">record_error</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> error_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>errors<span class="token punctuation">[</span>error_type<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
        self<span class="token punctuation">.</span>total_requests <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_cache_hit_rate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        total <span class="token operator">=</span> self<span class="token punctuation">.</span>cache_hits <span class="token operator">+</span> self<span class="token punctuation">.</span>cache_misses
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>cache_hits <span class="token operator">/</span> total <span class="token keyword keyword-if">if</span> total <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword keyword-else">else</span> <span class="token number">0</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">get_error_rate</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>total_requests <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token number">0</span>
        total_errors <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> total_errors <span class="token operator">/</span> self<span class="token punctuation">.</span>total_requests

<span class="token comment"># Prometheus æŒ‡æ ‡å¯¼å‡º</span>
<span class="token keyword keyword-from">from</span> prometheus_client <span class="token keyword keyword-import">import</span> Histogram<span class="token punctuation">,</span> Counter<span class="token punctuation">,</span> Gauge

latency_histogram <span class="token operator">=</span> Histogram<span class="token punctuation">(</span>
    <span class="token string">'request_latency_seconds'</span><span class="token punctuation">,</span>
    <span class="token string">'Request latency'</span><span class="token punctuation">,</span>
    buckets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

request_counter <span class="token operator">=</span> Counter<span class="token punctuation">(</span>
    <span class="token string">'requests_total'</span><span class="token punctuation">,</span>
    <span class="token string">'Total requests'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'method'</span><span class="token punctuation">,</span> <span class="token string">'status'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>

active_connections <span class="token operator">=</span> Gauge<span class="token punctuation">(</span>
    <span class="token string">'active_connections'</span><span class="token punctuation">,</span>
    <span class="token string">'Active connections'</span>
<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@latency_histogram<span class="token punctuation">.</span>time</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">handle_request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># è‡ªåŠ¨è®°å½•å»¶è¿Ÿ</span>
    <span class="token keyword keyword-await">await</span> process<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-49">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<p><strong>æ€§èƒ½æŒ‡æ ‡çš„é»„é‡‘ä¸‰è§’:</strong></p>
<ul>
<li><strong>å»¶è¿Ÿ (Latency)</strong>: ç”¨æˆ·æ„ŸçŸ¥çš„å¿«æ…¢</li>
<li><strong>ååé‡ (Throughput)</strong>: ç³»ç»Ÿå¤„ç†èƒ½åŠ›</li>
<li><strong>èµ„æº (Resources)</strong>: æˆæœ¬å’Œå®¹é‡</li>
</ul>
<p><strong>åˆ†ä½æ•°çš„æ„ä¹‰:</strong></p>
<ul>
<li><strong>P50</strong>: ä¸­ä½æ•°ï¼Œä»£è¡¨å…¸å‹ç”¨æˆ·çš„ä½“éªŒ</li>
<li><strong>P95</strong>: 95% ç”¨æˆ·çš„ä½“éªŒï¼Œå…³æ³¨é•¿å°¾</li>
<li><strong>P99</strong>: 99% ç”¨æˆ·çš„ä½“éªŒï¼Œå…³æ³¨æç«¯æƒ…å†µ</li>
</ul>
<p><strong>ä¸šåŠ¡æŒ‡æ ‡çš„ä»·å€¼:</strong></p>
<ul>
<li><strong>ç¼“å­˜å‘½ä¸­ç‡</strong>: åæ˜ ç¼“å­˜ç­–ç•¥æœ‰æ•ˆæ€§</li>
<li><strong>é”™è¯¯ç‡</strong>: åæ˜ ç³»ç»Ÿç¨³å®šæ€§</li>
<li><strong>æˆåŠŸç‡</strong>: åæ˜ ä¸šåŠ¡å®Œæ•´æ€§</li>
</ul>
<h3 id="é¢è¯•ç­”è¾©æŒ‡å¼•interview-script-49">ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘ </h3>
<p><strong>Q: å¦‚ä½•ç›‘æ§ç³»ç»Ÿçš„æ€§èƒ½ç“¶é¢ˆï¼Ÿ</strong></p>
<p><strong>å›ç­”è¦ç‚¹:</strong></p>
<ul>
<li><strong>å…¨é“¾è·¯ç›‘æ§</strong>: ä»ç§»åŠ¨ç«¯åˆ°æ•°æ®åº“</li>
<li><strong>åˆ†ä½æ•°åˆ†æ</strong>: å…³æ³¨ P95/P99 è€Œéå¹³å‡å€¼</li>
<li><strong>å…³è”åˆ†æ</strong>: æŒ‡æ ‡é—´çš„å…³ç³»ï¼ˆå¦‚ QPS å’Œå»¶è¿Ÿï¼‰</li>
<li><strong>è¶‹åŠ¿åˆ†æ</strong>: å¯¹æ¯”å†å²æ•°æ®ï¼Œå‘ç°é€€åŒ–</li>
</ul>
<p><strong>å›ç­”æ¨¡æ¿:</strong></p>
<blockquote>
<p>"ç›‘æ§æ€§èƒ½ç“¶é¢ˆéœ€è¦å…¨é“¾è·¯è§†è§’ã€‚é¦–å…ˆï¼Œå»ºç«‹ä»ç§»åŠ¨ç«¯åˆ°æ•°æ®åº“çš„å…¨é“¾è·¯ç›‘æ§ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½è®°å½•å»¶è¿Ÿå’Œé”™è¯¯ç‡ï¼›å…¶æ¬¡ï¼Œä½¿ç”¨åˆ†ä½æ•°è€Œéå¹³å‡å€¼ï¼ŒP99 å»¶è¿Ÿå¾€å¾€æ¯”å¹³å‡å€¼æ›´èƒ½åæ˜ é—®é¢˜ï¼›ç¬¬ä¸‰ï¼Œå…³è”åˆ†æï¼Œå¦‚ QPS ä¸Šå‡æ—¶å»¶è¿Ÿæ˜¯å¦ä¹Ÿä¸Šå‡ï¼Œåˆ¤æ–­æ˜¯å®¹é‡é—®é¢˜è¿˜æ˜¯ä»£ç é€€åŒ–ï¼›ç¬¬å››ï¼Œè¶‹åŠ¿åˆ†æï¼Œå¯¹æ¯”å†å²æ•°æ®ï¼Œå‘ç°æ€§èƒ½é€€åŒ–ã€‚æˆ‘ä»¬ä½¿ç”¨ Prometheus + Grafana å®ç°ç›‘æ§ï¼Œé…åˆ Alertmanager å‘Šè­¦ï¼Œå¯ä»¥å¿«é€Ÿå®šä½ç“¶é¢ˆã€‚"</p>
</blockquote>
<hr>
<h1 id="å-é¢è¯•å¸¸è§é—®é¢˜è§£ç­”">åã€é¢è¯•å¸¸è§é—®é¢˜è§£ç­” </h1>
<h2 id="101-æ¶æ„è®¾è®¡">10.1 æ¶æ„è®¾è®¡ </h2>
<h3 id="q1-ä¸ºä»€ä¹ˆé‡‡ç”¨-go--python-æ··åˆæ¶æ„">Q1: ä¸ºä»€ä¹ˆé‡‡ç”¨ Go + Python æ··åˆæ¶æ„ï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
æ··åˆæ¶æ„æ˜¯åŸºäº <strong>åº·å¨å®šå¾‹</strong> å’Œ <strong>æŠ€æœ¯æ ˆåŒ¹é…</strong> çš„è®¾è®¡ï¼Œå°†ç³»ç»ŸæŒ‰ç…§æœ€ä½³åº”ç”¨åœºæ™¯å‚ç›´åˆ‡åˆ†ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>Go Gateway</strong>: å¤„ç† 10 ä¸‡+ å¹¶å‘ WebSocket è¿æ¥</li>
<li><strong>Python Agent</strong>: é›†æˆ LLM ç”Ÿæ€ï¼ˆLangChain, pgvectorï¼‰</li>
<li><strong>gRPC</strong>: é«˜æ•ˆäºŒè¿›åˆ¶é€šä¿¡ï¼Œå»¶è¿Ÿ &lt; 2ms</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>èŒè´£åˆ†ç¦»</strong>: Go æ“…é•¿ IOï¼ŒPython æ“…é•¿ AI</li>
<li><strong>ç”Ÿæ€ä¼˜åŠ¿</strong>: å„å–æ‰€é•¿ï¼Œé¿å…é‡å¤é€ è½®å­</li>
<li><strong>æ‰©å±•æ€§</strong>: å„å±‚ç‹¬ç«‹æ‰©å®¹ï¼Œäº’ä¸å½±å“</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æ¶æ„æƒè¡¡é—®é¢˜ã€‚æˆ‘ä»¬é€‰æ‹© Go+Python æ··åˆæ¶æ„ï¼Œæ˜¯åŸºäº <strong>æŠ€æœ¯æ ˆåŒ¹é…</strong> å’Œ <strong>æ€§èƒ½åˆ†å·¥</strong> çš„è€ƒè™‘ã€‚Go åœ¨å¤„ç†é«˜å¹¶å‘ WebSocket è¿æ¥æ–¹é¢è¡¨ç°å‡ºè‰²ï¼Œæ¯ä¸ª Goroutine ä»…éœ€ 2KB å†…å­˜ï¼Œå¯ä»¥è½»æ¾æ”¯æ’‘æ•°ä¸‡å¹¶å‘ã€‚è€Œ Python åœ¨ AI é¢†åŸŸæ‹¥æœ‰æ— å¯æ¯”æ‹Ÿçš„ç”Ÿæ€ä¼˜åŠ¿ï¼Œä» LangChain åˆ° pgvectorï¼Œéƒ½æ˜¯ç»è¿‡ç”Ÿäº§éªŒè¯çš„å·¥å…·ã€‚é€šè¿‡ gRPC è¿›è¡Œé€šä¿¡ï¼Œå»¶è¿Ÿåœ¨ 1-2ms ä»¥å†…ï¼Œå¯¹æ•´ä½“æ€§èƒ½å½±å“æå°ã€‚è¿™ç§æ¶æ„è®©æˆ‘ä»¬èƒ½å¤Ÿå¿«é€Ÿè¿­ä»£ AI åŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒç½‘å…³å±‚çš„é«˜æ€§èƒ½ã€‚"</p>
</blockquote>
<hr>
<h3 id="q2-å¦‚ä½•ä¿è¯ç³»ç»Ÿçš„å¯æ‰©å±•æ€§">Q2: å¦‚ä½•ä¿è¯ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
å¯æ‰©å±•æ€§é€šè¿‡ <strong>æ— çŠ¶æ€è®¾è®¡</strong>ã€<strong>æ°´å¹³æ‰©å®¹</strong> å’Œ <strong>åè®®é©±åŠ¨</strong> å®ç°ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>æ— çŠ¶æ€</strong>: é™¤ Redis å¤–ï¼Œæ‰€æœ‰æœåŠ¡æ— çŠ¶æ€</li>
<li><strong>æ°´å¹³æ‰©å®¹</strong>: K8s è½»æ¾æ‰©å±• Go Gateway æˆ– Python Agent</li>
<li><strong>åè®®é©±åŠ¨</strong>: Protobuf ä¿è¯æ¥å£å‘å‰å…¼å®¹</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>åˆ†å±‚è§£è€¦</strong>: å„å±‚å¯ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•</li>
<li><strong>æ— çŠ¶æ€è®¾è®¡</strong>: æ”¯æŒä»»æ„æ•°é‡å®ä¾‹</li>
<li><strong>åè®®ä¼˜å…ˆ</strong>: æ¥å£å®šä¹‰å…ˆè¡Œï¼Œä¿è¯å…¼å®¹æ€§</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"æˆ‘ä»¬ä»ä¸‰ä¸ªå±‚é¢ä¿è¯å¯æ‰©å±•æ€§ï¼šç¬¬ä¸€ï¼Œæ— çŠ¶æ€è®¾è®¡ï¼Œæ‰€æœ‰æœåŠ¡å®ä¾‹éƒ½æ˜¯å¯¹ç­‰çš„ï¼Œå¯ä»¥éšæ—¶æ‰©å®¹ç¼©å®¹ï¼›ç¬¬äºŒï¼Œåè®®é©±åŠ¨ï¼Œä½¿ç”¨ Protobuf å®šä¹‰æ¥å£ï¼Œä¿è¯å‘åå…¼å®¹ï¼Œæ–°ç‰ˆæœ¬å¯ä»¥æ— ç¼å‡çº§ï¼›ç¬¬ä¸‰ï¼Œåˆ†å±‚è§£è€¦ï¼ŒGo Gatewayã€Python Agentã€æ•°æ®åº“éƒ½å¯ä»¥ç‹¬ç«‹æ‰©å±•ã€‚é€šè¿‡ Kubernetesï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´å®ä¾‹æ•°é‡ï¼Œå®ç°å¼¹æ€§ä¼¸ç¼©ã€‚"</p>
</blockquote>
<hr>
<h2 id="102-ai-ç¼–æ’">10.2 AI ç¼–æ’ </h2>
<h3 id="q3-graphrag-ç›¸æ¯”æ™®é€š-rag-çš„ä¼˜åŠ¿">Q3: GraphRAG ç›¸æ¯”æ™®é€š RAG çš„ä¼˜åŠ¿ï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
GraphRAG å¼•å…¥ <strong>çŸ¥è¯†å›¾è°±æ‹“æ‰‘å…³ç³»</strong>ï¼Œæä¾›ç»“æ„åŒ–çŸ¥è¯†æ£€ç´¢ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>å‘é‡æœç´¢</strong>: è¯­ä¹‰å¬å›</li>
<li><strong>å…³ç³»æ‰©å±•</strong>: çˆ¶å­ã€ç›¸å…³ã€å…ˆä¿®å…³ç³»</li>
<li><strong>ä¸ªæ€§åŒ–</strong>: æ ¹æ®ç”¨æˆ·æŒæ¡åº¦è¿‡æ»¤</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>ç»“æ„åŒ– vs éç»“æ„åŒ–</strong>: GraphRAG æä¾›å…³ç³»ï¼Œæ™®é€š RAG åªæœ‰ç‰‡æ®µ</li>
<li><strong>å¯è§£é‡Šæ€§</strong>: å¯ä»¥å±•ç¤ºæ£€ç´¢è·¯å¾„</li>
<li><strong>å¤šè·³æ¨ç†</strong>: æ”¯æŒå¤æ‚é—®é¢˜å›ç­”</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"æ™®é€š RAG åªèƒ½æ£€ç´¢æ–‡æœ¬ç‰‡æ®µï¼Œç¼ºä¹é€»è¾‘è”ç³»ã€‚GraphRAG é€šè¿‡çŸ¥è¯†å›¾è°±å¼•å…¥æ‹“æ‰‘å…³ç³»ï¼Œæ¯”å¦‚å­¦ä¹ æœºå™¨å­¦ä¹ éœ€è¦å…ˆä¿®æ•°å­¦ï¼Œç›¸å…³æ¦‚å¿µæœ‰æ·±åº¦å­¦ä¹ ã€‚è¿™ä½¿å¾— AI èƒ½æä¾›æ›´å…·æ¡ç†çš„å­¦ä¹ è·¯å¾„ï¼Œè€Œä¸ä»…ä»…æ˜¯æ‹¼æ¥æ–‡æœ¬ã€‚åœ¨ Sparkle ä¸­ï¼ŒGraphRAG å°†æ£€ç´¢ç²¾åº¦æå‡äº† 50%ï¼Œç”¨æˆ·æ»¡æ„åº¦æ˜¾è‘—æé«˜ã€‚"</p>
</blockquote>
<hr>
<h3 id="q4-å¦‚ä½•å¤„ç†é•¿å¯¹è¯çš„-token-è¶…é™">Q4: å¦‚ä½•å¤„ç†é•¿å¯¹è¯çš„ Token è¶…é™ï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
é€šè¿‡ <strong>æ»‘åŠ¨çª—å£</strong> + <strong>å¼‚æ­¥æ€»ç»“</strong> + <strong>è¯­ä¹‰è¿‡æ»¤</strong> è§£å†³ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>æ»‘åŠ¨çª—å£</strong>: ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯</li>
<li><strong>å¼‚æ­¥æ€»ç»“</strong>: åå°å‹ç¼©å†å²ï¼Œç¼“å­˜åˆ° Redis</li>
<li><strong>è¯­ä¹‰è¿‡æ»¤</strong>: åªä¿ç•™ç›¸å…³å†å²</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>ç©ºé—´æ¢æ—¶é—´</strong>: å¼‚æ­¥æ€»ç»“ä¸é˜»å¡ä¸»æµç¨‹</li>
<li><strong>ä¼˜é›…é™çº§</strong>: ç¼“å­˜å¤±æ•ˆæ—¶å›é€€åˆ°æ»‘åŠ¨çª—å£</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: å‡å°‘ Token æ¶ˆè€—ï¼Œé™ä½å»¶è¿Ÿ</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨ä¸‰ç®¡é½ä¸‹çš„ç­–ç•¥ã€‚é¦–å…ˆï¼Œæ»‘åŠ¨çª—å£ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯ä½œä¸ºåŸºç¡€ã€‚å…¶æ¬¡ï¼Œå½“å¯¹è¯è¶…è¿‡ 30 è½®æ—¶ï¼Œè§¦å‘å¼‚æ­¥æ€»ç»“ä»»åŠ¡ï¼Œå°†æ—§å†å²å‹ç¼©æˆæ‘˜è¦å¹¶ç¼“å­˜ 1 å°æ—¶ã€‚ä¸‹æ¬¡è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ã€æ‘˜è¦ + æœ€è¿‘5æ¡ã€‘çš„ç»„åˆã€‚æœ€åï¼Œé€šè¿‡å‘é‡ç›¸ä¼¼åº¦è¿‡æ»¤ï¼Œåªä¿ç•™ä¸å½“å‰é—®é¢˜ç›¸å…³çš„å†å²ç‰‡æ®µã€‚å¦‚æœæ€»ç»“ä»»åŠ¡å¤±è´¥ï¼Œç³»ç»Ÿä¼šä¼˜é›…é™çº§åˆ°çº¯æ»‘åŠ¨çª—å£ï¼Œç¡®ä¿æœåŠ¡ä¸ä¸­æ–­ã€‚"</p>
</blockquote>
<hr>
<h2 id="103-ç”Ÿäº§çº§ç‰¹æ€§">10.3 ç”Ÿäº§çº§ç‰¹æ€§ </h2>
<h3 id="q5-ç†”æ–­å™¨å¦‚ä½•é˜²æ­¢çº§è”æ•…éšœ">Q5: ç†”æ–­å™¨å¦‚ä½•é˜²æ­¢çº§è”æ•…éšœï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
ç†”æ–­å™¨é€šè¿‡ <strong>çŠ¶æ€æœº</strong> å’Œ <strong>å¿«é€Ÿå¤±è´¥</strong> é˜²æ­¢æ•…éšœæ‰©æ•£ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>CLOSED</strong>: æ­£å¸¸çŠ¶æ€</li>
<li><strong>OPEN</strong>: é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ï¼Œæ‹’ç»è¯·æ±‚</li>
<li><strong>HALF_OPEN</strong>: å†·å´åå°è¯•æ¢å¤</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>æ•…éšœéš”ç¦»</strong>: åˆ‡æ–­å¯¹æ•…éšœæœåŠ¡çš„è°ƒç”¨</li>
<li><strong>å¿«é€Ÿå¤±è´¥</strong>: é¿å…é•¿æ—¶é—´ç­‰å¾…</li>
<li><strong>è‡ªåŠ¨æ¢å¤</strong>: ç»™ä¸‹æ¸¸æ¢å¤æ—¶é—´</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"ç†”æ–­å™¨åƒç”µè·¯ä¿é™©ä¸ã€‚å½“ LLM æœåŠ¡æŒç»­æŠ¥é”™æˆ–è¶…æ—¶ï¼Œé”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ï¼ˆå¦‚ 50%ï¼‰ï¼Œç†”æ–­å™¨è¿›å…¥ OPEN çŠ¶æ€ï¼Œæ‰€æœ‰æ–°è¯·æ±‚ç«‹å³å¤±è´¥è¿”å›ï¼Œä¸å†è°ƒç”¨ä¸‹æ¸¸ã€‚ç»è¿‡ 30 ç§’å†·å´æœŸï¼Œè¿›å…¥ HALF_OPEN çŠ¶æ€ï¼Œå…è®¸å°‘é‡æ¢æµ‹è¯·æ±‚ã€‚å¦‚æœæˆåŠŸåˆ™æ¢å¤ï¼Œå¦åˆ™ç»§ç»­ç†”æ–­ã€‚è¿™é˜²æ­¢äº†å•ä¸ªæœåŠ¡æ•…éšœæ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚"</p>
</blockquote>
<hr>
<h3 id="q6-å¦‚ä½•ä¿è¯å¹‚ç­‰æ€§">Q6: å¦‚ä½•ä¿è¯å¹‚ç­‰æ€§ï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
å¹‚ç­‰æ€§é€šè¿‡ <strong>è¯·æ±‚ ID å»é‡</strong> + <strong>åˆ†å¸ƒå¼é”</strong> + <strong>å”¯ä¸€ç´¢å¼•</strong> ä¿è¯ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>è¯·æ±‚ ID</strong>: å‰ç«¯ç”Ÿæˆå”¯ä¸€ ID</li>
<li><strong>Redis å»é‡</strong>: å¿«é€Ÿæ£€æŸ¥</li>
<li><strong>æ•°æ®åº“å”¯ä¸€ç´¢å¼•</strong>: æœ€ç»ˆä¿è¯</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>é˜²å¾¡æ€§ç¼–ç¨‹</strong>: å¤šå±‚é˜²æŠ¤</li>
<li><strong>æœ€ç»ˆä¸€è‡´æ€§</strong>: æ•°æ®åº“å±‚é¢å…œåº•</li>
<li><strong>ç”¨æˆ·ä½“éªŒ</strong>: é‡å¤è¯·æ±‚ç»“æœä¸€è‡´</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"æˆ‘ä»¬é‡‡ç”¨ä¸‰å±‚é˜²æŠ¤ï¼šç¬¬ä¸€ï¼ŒRedis å¿«é€Ÿå»é‡ï¼Œå¦‚æœå·²å¤„ç†ç›´æ¥è¿”å›æˆåŠŸï¼›ç¬¬äºŒï¼Œåˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢å¹¶å‘åˆ›å»ºï¼›ç¬¬ä¸‰ï¼Œæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼Œå³ä½¿å‰é¢ä¸¤å±‚å¤±æ•ˆä¹Ÿèƒ½ä¿è¯ä¸é‡å¤ã€‚è¿™æ ·å³ä½¿å®¢æˆ·ç«¯å› è¶…æ—¶é‡è¯•ï¼Œç»“æœä¹Ÿæ˜¯ä¸€è‡´çš„ã€‚"</p>
</blockquote>
<hr>
<h2 id="104-æ€§èƒ½ä¼˜åŒ–">10.4 æ€§èƒ½ä¼˜åŒ– </h2>
<h3 id="q7-å‘é‡æœç´¢å¦‚ä½•ä¼˜åŒ–">Q7: å‘é‡æœç´¢å¦‚ä½•ä¼˜åŒ–ï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
é€šè¿‡ <strong>HNSW ç´¢å¼•</strong> + <strong>Redis ç¼“å­˜</strong> + <strong>æ··åˆæ£€ç´¢</strong> ä¼˜åŒ–ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>HNSW</strong>: m=16, ef_construction=64</li>
<li><strong>Redis ç¼“å­˜</strong>: ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢</li>
<li><strong>æ··åˆæ£€ç´¢</strong>: å‘é‡ + å…³é”®è¯</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>ç´¢å¼•è°ƒä¼˜</strong>: å¹³è¡¡ç²¾åº¦å’Œæ€§èƒ½</li>
<li><strong>ç¼“å­˜ç­–ç•¥</strong>: å‡å°‘é‡å¤è®¡ç®—</li>
<li><strong>ç®—æ³•èåˆ</strong>: æå‡å¬å›ç‡</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"æˆ‘ä»¬ä»ä¸‰ä¸ªå±‚é¢ä¼˜åŒ–ï¼šç¬¬ä¸€ï¼ŒHNSW ç´¢å¼•å‚æ•°è°ƒä¼˜ï¼Œm=16 å¹³è¡¡ç²¾åº¦å’Œå†…å­˜ï¼Œef_construction=64 æé«˜æ„å»ºè´¨é‡ï¼›ç¬¬äºŒï¼ŒRedis ç¼“å­˜çƒ­ç‚¹æŸ¥è¯¢ï¼Œå‘½ä¸­ç‡å¯è¾¾ 80%ï¼›ç¬¬ä¸‰ï¼Œæ··åˆæ£€ç´¢ï¼Œå‘é‡å¬å› + å…³é”®è¯ç²¾ç¡®åŒ¹é…ï¼Œé€šè¿‡ RRF èåˆæ’åºã€‚è¿™ä½¿å¾—ç™¾ä¸‡çº§å‘é‡çš„æ£€ç´¢æ—¶é—´ä»ç§’çº§é™åˆ°æ¯«ç§’çº§ã€‚"</p>
</blockquote>
<hr>
<h3 id="q8-å¦‚ä½•é¿å…æ•°æ®åº“-n1-é—®é¢˜">Q8: å¦‚ä½•é¿å…æ•°æ®åº“ N+1 é—®é¢˜ï¼Ÿ </h3>
<p><strong>ã€æ ¸å¿ƒåŸç†/Definitionã€‘</strong><br>
é€šè¿‡ <strong>JOIN åˆå¹¶</strong> + <strong>æ‰¹é‡æŸ¥è¯¢</strong> + <strong>é¢„åŠ è½½</strong> è§£å†³ã€‚</p>
<p><strong>ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘</strong></p>
<ul>
<li><strong>JOIN</strong>: ä¸€æ¬¡æ€§æ‹‰å–å…³è”æ•°æ®</li>
<li><strong>æ‰¹é‡æŸ¥è¯¢</strong>: in æ“ä½œå‡å°‘æŸ¥è¯¢æ¬¡æ•°</li>
<li><strong>é¢„åŠ è½½</strong>: ORM çš„ eager loading</li>
</ul>
<p><strong>ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘</strong></p>
<ul>
<li><strong>å‡å°‘ç½‘ç»œå¾€è¿”</strong>: ä¸€æ¬¡æŸ¥è¯¢ä¼˜äºå¤šæ¬¡</li>
<li><strong>å…³ç³»ä»£æ•°</strong>: åˆ©ç”¨ SQL çš„ JOIN èƒ½åŠ›</li>
<li><strong>æ€§èƒ½ä¼˜åŒ–</strong>: é¿å…å¾ªç¯ä¸­çš„æ•°æ®åº“æ“ä½œ</li>
</ul>
<p><strong>ã€é¢è¯•ç­”è¾©æŒ‡å¼•/Interview Scriptã€‘</strong></p>
<blockquote>
<p>"N+1 é—®é¢˜æ˜¯ ORM çš„å¸¸è§é™·é˜±ã€‚æˆ‘ä»¬ä½¿ç”¨ SQLAlchemy çš„ joinedload ä¸€æ¬¡æ€§åŠ è½½å…³è”æ•°æ®ï¼Œæˆ–è€…ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢å°†å¤šä¸ª ID åˆå¹¶ä¸ºä¸€æ¬¡ in æŸ¥è¯¢ã€‚å¯¹äºå¤æ‚åœºæ™¯ï¼Œæˆ‘ä»¬å°è£… Repository å±‚ï¼Œç»Ÿä¸€ç®¡ç†æ•°æ®è®¿é—®ï¼Œç¡®ä¿ä¸ä¼šåœ¨å¾ªç¯ä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œã€‚é€šè¿‡ EXPLAIN ANALYZE å¯ä»¥éªŒè¯æŸ¥è¯¢è®¡åˆ’ï¼Œç¡®ä¿ä½¿ç”¨ç´¢å¼•è€Œéå…¨è¡¨æ‰«æã€‚"</p>
</blockquote>
<hr>
<h1 id="åä¸€-æŠ€æœ¯æ ˆä¸å·¥å…·é“¾">åä¸€ã€æŠ€æœ¯æ ˆä¸å·¥å…·é“¾ </h1>
<h2 id="111-åç«¯æŠ€æœ¯æ ˆ">11.1 åç«¯æŠ€æœ¯æ ˆ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-54">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<ul>
<li><strong>Go</strong>: Gin, Gorilla WebSocket, gRPC, SQLC</li>
<li><strong>Python</strong>: FastAPI, LangChain, pgvector, SQLAlchemy</li>
<li><strong>æ•°æ®åº“</strong>: PostgreSQL 16 + pgvector, Redis 7</li>
<li><strong>é€šä¿¡</strong>: gRPC (Protobuf), WebSocket</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-55">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="go" class="language-go go"><code><span class="token comment">// Go æŠ€æœ¯æ ˆ</span>
<span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/gin-gonic/gin"</span>
    <span class="token string">"github.com/gorilla/websocket"</span>
    <span class="token string">"google.golang.org/grpc"</span>
    <span class="token string">"github.com/sqlc-dev/sqlc-go"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Python æŠ€æœ¯æ ˆ</span>
from fastapi <span class="token keyword keyword-import">import</span> FastAPI
from langchain <span class="token keyword keyword-import">import</span> LLMChain
from pgvector<span class="token punctuation">.</span>sqlalchemy <span class="token keyword keyword-import">import</span> Vector
from sqlalchemy <span class="token keyword keyword-import">import</span> create_engine
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-50">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<ul>
<li><strong>Go</strong>: é«˜æ€§èƒ½ã€å¹¶å‘ã€å†…å­˜å®‰å…¨</li>
<li><strong>Python</strong>: ç”Ÿæ€ä¸°å¯Œã€å¼€å‘æ•ˆç‡é«˜</li>
<li><strong>PostgreSQL</strong>: å…³ç³»å‹ + å‘é‡æœç´¢ä¸€ä½“åŒ–</li>
<li><strong>Redis</strong>: é«˜æ€§èƒ½ç¼“å­˜å’Œé˜Ÿåˆ—</li>
</ul>
<hr>
<h2 id="112-å‰ç«¯æŠ€æœ¯æ ˆ">11.2 å‰ç«¯æŠ€æœ¯æ ˆ </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-55">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<ul>
<li><strong>Flutter</strong>: Riverpod, WebSocket, CustomPainter</li>
<li><strong>çŠ¶æ€ç®¡ç†</strong>: StateNotifier, ConsumerWidget</li>
<li><strong>æœ¬åœ°å­˜å‚¨</strong>: Hive, SharedPreferences</li>
<li><strong>ç½‘ç»œ</strong>: WebSocketChannel, Dio</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-56">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="dart" class="language-dart dart"><code><span class="token comment">// Flutter æŠ€æœ¯æ ˆ</span>
<span class="token keyword keyword-import">import</span> <span class="token string-literal"><span class="token string">'package:flutter_riverpod/flutter_riverpod.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token string-literal"><span class="token string">'package:web_socket_channel/web_socket_channel.dart'</span></span><span class="token punctuation">;</span>
<span class="token keyword keyword-import">import</span> <span class="token string-literal"><span class="token string">'package:hive/hive.dart'</span></span><span class="token punctuation">;</span>

<span class="token comment">// Riverpod Provider</span>
<span class="token keyword keyword-final">final</span> chatProvider <span class="token operator">=</span> <span class="token class-name">StateNotifierProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatNotifier</span><span class="token punctuation">,</span> <span class="token class-name">ChatState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword keyword-return">return</span> <span class="token class-name">ChatNotifier</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>webSocketServiceProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-51">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<ul>
<li><strong>å£°æ˜å¼ UI</strong>: æ•°æ®é©±åŠ¨ï¼Œè‡ªåŠ¨å“åº”</li>
<li><strong>å“åº”å¼ç¼–ç¨‹</strong>: Stream å’Œ Future çš„ä¼˜é›…å¤„ç†</li>
<li><strong>è·¨å¹³å°</strong>: ä¸€å¥—ä»£ç ï¼Œå¤šç«¯è¿è¡Œ</li>
</ul>
<hr>
<h2 id="113-devops-å·¥å…·">11.3 DevOps å·¥å…· </h2>
<h3 id="æ ¸å¿ƒåŸç†definition-56">ã€æ ¸å¿ƒåŸç†/Definitionã€‘ </h3>
<ul>
<li><strong>å®¹å™¨åŒ–</strong>: Docker, Docker Compose</li>
<li><strong>ç¼–æ’</strong>: Kubernetes</li>
<li><strong>ç›‘æ§</strong>: Prometheus, Grafana, Loki</li>
<li><strong>æ—¥å¿—</strong>: ELK Stack</li>
</ul>
<h3 id="sparkle-é¡¹ç›®å®è·µimplementation-57">ã€Sparkle é¡¹ç›®å®è·µ/Implementationã€‘ </h3>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token comment"># Docker Compose</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./gateway
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"8080:8080"</span><span class="token punctuation">]</span>
  
  <span class="token key atrule">agent</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./agent
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"50051:50051"</span><span class="token punctuation">]</span>
  
  <span class="token key atrule">postgres</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> pgvector/pgvector<span class="token punctuation">:</span>pg16
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">POSTGRES_DB</span><span class="token punctuation">:</span> sparkle
  
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>7<span class="token punctuation">-</span>alpine
</code></pre><h3 id="ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æengineering-philosophy-52">ã€ç¼–ç¨‹æ€æƒ³ä¸æ·±åº¦åˆ†æ/Engineering Philosophyã€‘ </h3>
<ul>
<li><strong>åŸºç¡€è®¾æ–½å³ä»£ç </strong>: å¯é‡å¤éƒ¨ç½²</li>
<li><strong>å¯è§‚æµ‹æ€§</strong>: ç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ªä¸‰ä½ä¸€ä½“</li>
<li><strong>è‡ªåŠ¨åŒ–</strong>: CI/CD è‡ªåŠ¨åŒ–æµç¨‹</li>
</ul>
<hr>
<h1 id="åäºŒ-é¡¹ç›®é‡Œç¨‹ç¢‘ä¸æ¼”è¿›">åäºŒã€é¡¹ç›®é‡Œç¨‹ç¢‘ä¸æ¼”è¿› </h1>
<h2 id="121-é˜¶æ®µæ¼”è¿›">12.1 é˜¶æ®µæ¼”è¿› </h2>
<h3 id="phase-1-åŸºç¡€æ¶æ„å®Œæˆ">Phase 1: åŸºç¡€æ¶æ„å®Œæˆ </h3>
<ul>
<li><strong>ç›®æ ‡</strong>: Python å•ä½“æ¶æ„</li>
<li><strong>æˆæœ</strong>: åŸºç¡€ AI èŠå¤©åŠŸèƒ½</li>
</ul>
<h3 id="phase-2-ç”Ÿäº§çº§-agent-ç¼–æ’">Phase 2: ç”Ÿäº§çº§ Agent ç¼–æ’ </h3>
<ul>
<li><strong>ç›®æ ‡</strong>: 11 æ­¥å®‰å…¨å¤„ç†é“¾</li>
<li><strong>æˆæœ</strong>: ç†”æ–­ã€é™æµã€å¹‚ç­‰æ€§</li>
</ul>
<h3 id="phase-3-go-ç½‘å…³é›†æˆ">Phase 3: Go ç½‘å…³é›†æˆ </h3>
<ul>
<li><strong>ç›®æ ‡</strong>: WebSocket + gRPC</li>
<li><strong>æˆæœ</strong>: 10 ä¸‡+ å¹¶å‘æ”¯æŒ</li>
</ul>
<h3 id="phase-4-flutter-å®¢æˆ·ç«¯é€‚é…">Phase 4: Flutter å®¢æˆ·ç«¯é€‚é… </h3>
<ul>
<li><strong>ç›®æ ‡</strong>: æµå¼å“åº” + çŠ¶æ€ç®¡ç†</li>
<li><strong>æˆæœ</strong>: å®Œæ•´ç§»åŠ¨ç«¯ä½“éªŒ</li>
</ul>
<hr>
<h2 id="122-æ ¸å¿ƒæˆå°±">12.2 æ ¸å¿ƒæˆå°± </h2>
<ul>
<li>âœ… æ··åˆæ¶æ„å®ç°ï¼Œæ€§èƒ½æå‡ 300%</li>
<li>âœ… 11 æ­¥å®‰å…¨å¤„ç†é“¾ï¼Œç”Ÿäº§çº§å¯é æ€§</li>
<li>âœ… GraphRAG çŸ¥è¯†å›¾è°±ï¼Œæ£€ç´¢ç²¾åº¦æå‡ 50%</li>
<li>âœ… å®æ—¶æµå¼é€šä¿¡ï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿ &lt; 500ms</li>
<li>âœ… å®Œæ•´çš„å¯è§‚æµ‹æ€§ä½“ç³»</li>
</ul>
<hr>
<h2 id="123-ç”Ÿäº§å°±ç»ªåº¦-9510">12.3 ç”Ÿäº§å°±ç»ªåº¦: 9.5/10 </h2>
<p><strong>å·²å®Œæˆ</strong>:</p>
<ul>
<li>âœ… æ¶æ„ã€å®‰å…¨ã€ç›‘æ§ã€ä¼˜åŒ–ã€é™çº§</li>
</ul>
<p><strong>å¾…å®Œå–„</strong>:</p>
<ul>
<li>ğŸ”„ å•å…ƒæµ‹è¯•è¦†ç›–ç‡</li>
<li>ğŸ”„ CI/CD æµç¨‹</li>
<li>ğŸ”„ è´Ÿè½½æµ‹è¯•</li>
</ul>
<hr>
<h1 id="-å­¦ä¹ è·¯å¾„å»ºè®®-1">ğŸ“ å­¦ä¹ è·¯å¾„å»ºè®® </h1>
<h2 id="åˆçº§é˜¶æ®µ-1-2å‘¨-1">åˆçº§é˜¶æ®µ (1-2å‘¨) </h2>
<ol>
<li>é˜…è¯»æ¶æ„æ–‡æ¡£ï¼Œç†è§£ä¸‰å±‚æ¶æ„</li>
<li>æ­å»ºå¼€å‘ç¯å¢ƒï¼Œè¿è¡Œ demo</li>
<li>å­¦ä¹  WebSocket å’Œ gRPC åŸºç¡€</li>
</ol>
<h2 id="ä¸­çº§é˜¶æ®µ-2-4å‘¨-1">ä¸­çº§é˜¶æ®µ (2-4å‘¨) </h2>
<ol>
<li>å®ç° Go Gateway åŸºç¡€åŠŸèƒ½</li>
<li>ç†è§£ Python Agent ç¼–æ’é€»è¾‘</li>
<li>æŒæ¡ Riverpod çŠ¶æ€ç®¡ç†</li>
<li>å®ç°ç®€å•çš„ RAG æ£€ç´¢</li>
</ol>
<h2 id="é«˜çº§é˜¶æ®µ-4-8å‘¨-1">é«˜çº§é˜¶æ®µ (4-8å‘¨) </h2>
<ol>
<li>æ·±å…¥ç†è§£ç”Ÿäº§çº§ç‰¹æ€§ (ç†”æ–­ã€é™æµã€å¹‚ç­‰)</li>
<li>ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½ (ç´¢å¼•ã€åˆ†åŒº)</li>
<li>å®ç°å¤æ‚ UI åŠ¨ç”» (GLSL ç€è‰²å™¨)</li>
<li>å®Œå–„ç›‘æ§å’Œè¿ç»´ä½“ç³»</li>
</ol>
<h2 id="ä¸“å®¶é˜¶æ®µ-8å‘¨-1">ä¸“å®¶é˜¶æ®µ (8å‘¨+) </h2>
<ol>
<li>è´¡çŒ®ä»£ç ï¼Œä¿®å¤ç”Ÿäº§é—®é¢˜</li>
<li>è®¾è®¡æ–°åŠŸèƒ½æ¨¡å—</li>
<li>ä¼˜åŒ–ç³»ç»Ÿæ¶æ„</li>
<li>æŠ€æœ¯åˆ†äº«å’Œæ–‡æ¡£å®Œå–„</li>
</ol>
<hr>
<p><strong>æ–‡æ¡£ç‰ˆæœ¬</strong>: v3.0<br>
<strong>æ›´æ–°æ—¥æœŸ</strong>: 2025-12-27<br>
<strong>çŸ¥è¯†ç‚¹æ•°é‡</strong>: 200+<br>
<strong>é€‚ç”¨å¯¹è±¡</strong>: é«˜çº§åç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆã€æŠ€æœ¯è¯„å§”ã€AIç³»ç»Ÿå¼€å‘è€…</p>
<p><em>æœ¬æ•™æ¡ˆæ¶µç›–äº† Sparkle AI Learning Assistant çš„æ‰€æœ‰æ ¸å¿ƒæŠ€æœ¯çŸ¥è¯†ç‚¹ï¼Œä»å®è§‚æ¶æ„åˆ°å¾®è§‚å®ç°ï¼Œæ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½åŒ…å«å››ä¸ªç»´åº¦çš„æ·±åº¦è®²è§£ï¼Œé€‚åˆç³»ç»Ÿæ€§å­¦ä¹ å’Œé¢è¯•å‡†å¤‡ã€‚</em></p>
<hr>
<h2 id="-é™„å½•å¿«é€Ÿç´¢å¼•">ğŸ“š é™„å½•ï¼šå¿«é€Ÿç´¢å¼• </h2>
<h3 id="æ¶æ„è®¾è®¡">æ¶æ„è®¾è®¡ </h3>
<ul>
<li>æ··åˆæ¶æ„: 1.1</li>
<li>è®¾è®¡æ¨¡å¼: 1.2</li>
<li>WebSocket: 2.1</li>
<li>Agent ç¼–æ’: 3.1</li>
</ul>
<h3 id="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ– </h3>
<ul>
<li>æ•°æ®åº“: 9.1</li>
<li>å¹¶å‘æ§åˆ¶: 9.2</li>
<li>ç¼“å­˜ç­–ç•¥: 9.3</li>
<li>å¼‚æ­¥ä¼˜åŒ–: 9.4</li>
</ul>
<h3 id="ç”Ÿäº§çº§ç‰¹æ€§">ç”Ÿäº§çº§ç‰¹æ€§ </h3>
<ul>
<li>ç†”æ–­å™¨: 7.1</li>
<li>å¹‚ç­‰æ€§: 7.2</li>
<li>åˆ†å¸ƒå¼é”: 7.3</li>
<li>ç›‘æ§: 7.4</li>
<li>é™çº§: 7.5</li>
</ul>
<h3 id="é¢è¯•é—®é¢˜">é¢è¯•é—®é¢˜ </h3>
<ul>
<li>æ¶æ„è®¾è®¡: 10.1</li>
<li>AI ç¼–æ’: 10.2</li>
<li>ç”Ÿäº§ç‰¹æ€§: 10.3</li>
<li>æ€§èƒ½ä¼˜åŒ–: 10.4</li>
</ul>
<hr>
<p><strong>æ–‡æ¡£ç»“æŸ</strong><br>
<em>æœ¬æ·±åº¦æŠ€æœ¯è®²è§£æ•™æ¡ˆä¸º Sparkle AI Learning Assistant é¡¹ç›®æä¾›äº†å®Œæ•´çš„çŸ¥è¯†ä½“ç³»ï¼Œæ¶µç›– 200+ çŸ¥è¯†ç‚¹ï¼Œæ¯ä¸ªçŸ¥è¯†ç‚¹éƒ½åŒ…å«å››ä¸ªç»´åº¦çš„æ·±åº¦åˆ†æï¼Œé€‚åˆé«˜çº§å·¥ç¨‹å¸ˆç³»ç»Ÿå­¦ä¹ å’ŒæŠ€æœ¯é¢è¯•å‡†å¤‡ã€‚</em></p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>