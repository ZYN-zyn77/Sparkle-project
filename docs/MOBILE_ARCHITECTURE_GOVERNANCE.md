# ç§»åŠ¨ç«¯æ¶æ„æ²»ç†çº¦å®š (Mobile Architecture Governance)

> **ç”Ÿæ•ˆæ—¥æœŸ**: 2026-01-04
> **é€‚ç”¨é˜¶æ®µ**: è€ƒå‰å†²åˆºæœŸ (ç°é˜¶æ®µ) åŠ æ¸è¿›å¼é‡æ„æœŸ
> **æ ¸å¿ƒåŸåˆ™**: **æ­¢è¡€ä¼˜äºæ‰‹æœ¯**ã€‚åœ¨ä¸å¼•å…¥å¤§è§„æ¨¡é‡æ„é£é™©çš„å‰æä¸‹ï¼Œéåˆ¶æ¶æ„è…åŒ–ã€‚

## 1. ä»£ç æ”¾ç½®è§„åˆ™ (Placement Rules)

æ‰€æœ‰æ–°å¢ä»£ç å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹å†³ç­–æ ‘ï¼š

1.  **æ˜¯å…¨æ–°çš„ä¸šåŠ¡æ¨¡å—å—ï¼Ÿ**
    *   **YES** $\rightarrow$ å¿…é¡»åœ¨ `lib/features/<module_name>` ä¸‹åˆ›å»ºã€‚ç¦æ­¢åœ¨ `lib/presentation` ä¸‹æ–°å»ºç›®å½•ã€‚
    *   **NO** (æ˜¯å¯¹æ—§æ¨¡å—çš„ä¿®æ”¹) $\rightarrow$ 
        *   å¦‚æœåªæ˜¯ä¿® Bug æˆ–å¾®è°ƒ $\rightarrow$ **ç•™åœ¨åŸåœ°** (lib/presentation)ã€‚
        *   å¦‚æœè¦é‡å†™é€»è¾‘æˆ–å¤§å¹…è¿­ä»£ $\rightarrow$ **é¡ºæ‰‹è¿ç§»** (Boy Scout Rule) åˆ° `lib/features`ã€‚

## 2. ç›®å½•èŒè´£å®šä¹‰ (Layer Definitions)

ä¸ºé˜²æ­¢ `Core` å’Œ `Shared` æˆä¸ºæ–°çš„åƒåœ¾åœºï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹å®šä¹‰ï¼š

| ç›®å½• | å…è®¸å­˜æ”¾çš„å†…å®¹ (Allow) | ç¦æ­¢å­˜æ”¾çš„å†…å®¹ (Forbid) |
| :--- | :--- | :--- |
| **`lib/core/`** | **ä¸šåŠ¡æ— å…³çš„åŸºç¡€è®¾æ–½**<br>- ç½‘ç»œå®¢æˆ·ç«¯ (Dio Wrapper)<br>- æœ¬åœ°å­˜å‚¨å°è£… (Hive Box)<br>- é€šç”¨ UI åŸå­ç»„ä»¶ (Buttons, Colors, Theme)<br>- æ—¥å¿—/é”™è¯¯å¤„ç†å·¥å…· | - ä»»ä½•åŒ…å« "User", "Task", "Chat" ç­‰ä¸šåŠ¡è¯æ±‡çš„ä»£ç <br>- ä¸šåŠ¡å®ä½“çš„ Model<br>- åŒ…å«ä¸šåŠ¡è·³è½¬é€»è¾‘çš„ Widget |
| `lib/shared/` | **è·¨ Feature çš„ç¨³å®šå¥‘çº¦**<br>- å…¨å±€å…±äº«å®ä½“ (AppUser, AuthState)<br>- è·¨åŸŸäº‹ä»¶å®šä¹‰ (EventBus)<br>- æå°‘æ•°è·¨æ¨¡å—é€šç”¨çš„ Value Objects | - åªè¢« 2 ä¸ª Feature ä¸´æ—¶å…±ç”¨çš„é€»è¾‘ (å®å¯é‡å¤ï¼Œå‹¿å¼ºè¡Œå…±äº«)<br>- é¢‘ç¹å˜æ›´çš„ä¸šåŠ¡é€»è¾‘<br>- å¤æ‚çš„ UI é¡µé¢ |
| `lib/features/` | **å‚ç›´ä¸šåŠ¡é—­ç¯**<br>- æ‰€æœ‰çš„ Page, Widget, Provider<br>- æ‰€æœ‰çš„ Repository å®ç°, DataSource<br>- æ‰€æœ‰çš„ Domain Entity, UseCase | - é€šç”¨å·¥å…·ç±»<br>- åº”è¯¥å±äº Core çš„åŸºç¡€è®¾æ–½ |

### 2.1 ç›®æ ‡ç›®å½•ç»“æ„ (Feature-First)

```text
lib/
â”œâ”€â”€ app/                  # åº”ç”¨é…ç½®å±‚
â”‚   â”œâ”€â”€ routes/           # è·¯ç”±æ³¨å†Œä¸­å¿ƒ (é˜¶æ®µå››è½åœ°)
â”‚   â”œâ”€â”€ di/               # ä¾èµ–æ³¨å…¥é…ç½®
â”‚   â””â”€â”€ main.dart         # åº”ç”¨å…¥å£
â”œâ”€â”€ core/                 # ä¸šåŠ¡æ— å…³åŸºç¡€è®¾æ–½
â”œâ”€â”€ shared/               # è·¨åŠŸèƒ½å¥‘çº¦ (entities/events/contracts)
â””â”€â”€ features/             # åŠŸèƒ½æ¨¡å— (å‚ç›´é—­ç¯)
```

## 3. è¾¹ç•Œå¼ºçº¦æŸ (Boundary Constraints)

ä¸ºäº†é˜²æ­¢â€œåˆ†æ•£çš„å¤§æ³¥çƒâ€ï¼Œäººå·¥ Code Review æ—¶å¿…é¡»æ£€æŸ¥ä»¥ä¸‹**ç¦æ­¢äº‹é¡¹**ï¼š

### ğŸš« ç¦æ­¢è·¨ Feature çš„ Data å±‚è®¿é—®
*   **é”™è¯¯**: `features/chat` ç›´æ¥ import `features/task/data/repositories/task_repository.dart`
*   **æ­£ç¡®**: `features/chat` é€šè¿‡ `domain` å±‚æ¥å£æˆ– `shared` ä¸­çš„å¥‘çº¦è¿›è¡Œäº¤äº’ã€‚

### ğŸš« ç¦æ­¢ UI å±‚ç›´æ¥ç©¿é€
*   **é”™è¯¯**: åœ¨ `Widget` ä¸­ç›´æ¥å®ä¾‹åŒ– `Repository` æˆ–ç›´æ¥è°ƒç”¨ API/Databaseã€‚
*   **æ­£ç¡®**: å¿…é¡»é€šè¿‡ `Provider` / `Controller` / `UseCase` è¿›è¡Œè°ƒç”¨ã€‚

### ğŸš« ç¦æ­¢è·¯ç”±å±‚ç”±äºç±»å‹ä¾èµ–è€Œå¯¼è‡´è€¦åˆ
*   **é”™è¯¯**: `GoRouter` é…ç½®ä¸­ï¼Œä¸ºäº†ä¼ å‚ç›´æ¥å¼•å…¥äº†å…·ä½“çš„ Feature Implementation Modelã€‚
*   **æ­£ç¡®**: è·¯ç”±ä¼ å‚ä»…ä½¿ç”¨ ID (String/Int) æˆ– `shared` ä¸­çš„åŸºç¡€ç±»å‹ã€‚

### âœ… Shared å¥‘çº¦ä½¿ç”¨è§„åˆ™
*   `shared/entities/`: ä»…æ”¾ç¨³å®šä¸”è·¨æ¨¡å—å¤ç”¨çš„å®ä½“ (å¦‚ TaskModel)ã€‚
*   `shared/contracts/`: ä»…å½“ä¸€ä¸ª Feature éœ€è¦è°ƒç”¨å¦ä¸€ä¸ª Feature çš„ä¸šåŠ¡èƒ½åŠ›æ—¶æ‰åˆ›å»ºæ¥å£å¥‘çº¦ã€‚
*   `shared/events/`: è·¨åŸŸäº‹ä»¶æ¨¡å‹ä¸äº‹ä»¶åå®šä¹‰ï¼Œé¿å… Feature ç›´æ¥ä¾èµ– Featureã€‚
*   **ç¦æ­¢**æŠŠåªè¢« 1~2 ä¸ªé¡µé¢ä¸´æ—¶å…±ç”¨çš„é€»è¾‘å¡è¿› `shared`ã€‚

## 4. è¿ç§»ç­–ç•¥ (Migration Strategy)

### ğŸ›‘ è€ƒå‰å†»ç»“æœŸ (Current)
*   **ä¸ä¸»åŠ¨è¿ç§»**ä»»ä½•ç°å­˜çš„ `lib/presentation` ä»£ç ã€‚
*   ä»…å¯¹**æ–°åŠŸèƒ½**æ‰§è¡Œ Feature-First è§„èŒƒã€‚
*   é›†ä¸­ç²¾åŠ›ä¿®å¤ P0 Bug (WebSocket, å´©æºƒ, å…³é”®UI)ã€‚

### ğŸš€ è€ƒåæ¸è¿›æœŸ (Post-Exam)
*   **è¯•é‡‘çŸ³ (Touchstone)**: ä¼˜å…ˆè¿ç§» **Task (ä»»åŠ¡)** æˆ– **Focus (ä¸“æ³¨)** æ¨¡å—ã€‚
    *   *éªŒè¯ç‚¹*: è·¯ç”±è§£è€¦ã€Provider ä½œç”¨åŸŸåˆ‡å‰²ã€Database ä¾èµ–åˆ†ç¦»ã€‚
*   **æ­¢æŸç‚¹ (Stop Loss)**:
    *   å¦‚æœè¿ç§»ä¸€ä¸ªæ¨¡å—å¯¼è‡´è¶…è¿‡ 3 ä¸ªæ— å…³æ–‡ä»¶æŠ¥é”™ $\rightarrow$ **ç«‹å³å›æ»š**ï¼Œé‡æ–°è¯„ä¼°ä¾èµ–ã€‚
    *   å¦‚æœè¿ç§»å¼•å…¥äº†æ–°çš„æ„å»ºé”™è¯¯ (build_runner) ä¸” 30åˆ†é’Ÿå†…æ— æ³•è§£å†³ $\rightarrow$ **å›æ»š**ã€‚

### âœ… é˜¶æ®µä¸€ (åŸºç¡€è®¾æ–½å‡†å¤‡) æ‰§è¡Œæ¸…å•
*   å»ºç«‹ `lib/shared/{entities,events,contracts}` ç›®å½•ç»“æ„ï¼Œå¹¶å°†è·¨æ¨¡å—å®ä½“è¿å…¥ã€‚
*   ä¸ºè·¨æ¨¡å—è°ƒç”¨å®šä¹‰ `shared/contracts/` æ¥å£ï¼Œæ¶ˆè´¹æ–¹ä»…ä¾èµ–æ¥å£ã€‚
*   æ–°å¢/ä¿®æ”¹ Feature æ—¶éµå¾ª â€œæ–°ä»£ç è¿› featuresï¼Œæ—§ä»£ç é¡ºæ‰‹è¿ç§»â€ã€‚
*   åœ¨ `docs/MOBILE_ARCHITECTURE_GOVERNANCE.md` å†…å›ºåŒ–ç»Ÿä¸€è§„åˆ™ä¸è¯„å®¡æ¸…å•ã€‚

### âœ… é˜¶æ®µäºŒ (è¯•ç‚¹æ¨¡å— Task) è¿ç§»æ¸…å•
*   å»ºç«‹ `lib/features/task/` çš„å®Œæ•´ç›®å½•æ ‘ (data/domain/presentation)ã€‚
*   å°† Task çš„ Repositoryã€Providerã€Screen é€æ­¥è¿å…¥æ¨¡å—å†…ã€‚
*   æ—§ Provider ä½œä¸ºä»£ç†ï¼Œå†…éƒ¨è½¬å‘è‡³æ–° Providerï¼Œä¿æŒå…¼å®¹ã€‚

### âœ… é˜¶æ®µå›› (è·¯ç”±è§£è€¦) çº¦å®š
*   å„ Feature æä¾›è‡ªå·±çš„ `routes.dart` å¹¶æš´éœ² `List<GoRoute>`ã€‚
*   `app/routes/` èšåˆå„æ¨¡å—è·¯ç”±ï¼Œä¸åœ¨å•æ–‡ä»¶ä¸­å †å ã€‚
*   è·¯ç”±ä¼ å‚åªå…è®¸ ID æˆ– `shared` ä¸­çš„åŸºç¡€ç±»å‹ã€‚

## 5. å…¬å…± API çº¦å®š (Barrel Export)

æœªæ¥æ¯ä¸ª Feature ç›®å½•ä¸‹åº”å»ºç«‹ `index.dart` æˆ– `<feature_name>.dart`ï¼Œä»…æš´éœ²å¤–éƒ¨å¯ç”¨çš„æ¥å£ï¼š

```dart
// lib/features/chat/chat.dart
export 'presentation/screens/chat_screen.dart'; // ä»…æš´éœ²é¡µé¢å…¥å£
export 'domain/entities/message.dart';          // ä»…æš´éœ²éœ€è¦çš„å®ä½“
// ç»ä¸æš´éœ² Repository å®ç°ç»†èŠ‚
```

```dart
// lib/features/task/task.dart
export 'presentation/screens/task_list_screen.dart';
export 'domain/entities/task.dart';
export 'domain/usecases/get_tasks.dart';
```
