# 任务管理模块 (Task Management) - 功能描述文档

## 模块概述

任务管理模块是Sparkle应用中负责任务全生命周期管理的核心模块。该模块支持任务的创建、更新、开始、完成、放弃等操作，并与知识星图、计划、推送等模块紧密集成，为用户提供结构化的学习任务管理功能。

## 后端实现 (TaskService)

### 核心功能

#### 1. 任务CRUD操作
- **get_by_id**: 根据ID获取任务并验证用户所有权
  - 验证用户与任务的关联关系
  - 返回任务详情信息

- **create**: 创建新任务
  - 接收TaskCreate对象
  - 设置初始状态为PENDING
  - 关联用户ID和可选的计划ID

- **update**: 更新任务信息
  - 支持部分更新
  - 只更新提供的字段
  - 保持其他字段不变

- **start**: 开始任务
  - 将任务状态更新为IN_PROGRESS
  - 记录开始时间

- **complete**: 完成任务
  - 将任务状态更新为COMPLETED
  - 记录完成时间和实际耗时
  - 支持添加用户笔记

- **abandon**: 放弃任务
  - 将任务状态更新为ABANDONED
  - 记录完成时间作为结束时间
  - 支持添加放弃原因

#### 2. 任务列表查询
- **get_multi**: 获取任务列表（支持过滤和分页）
  - 支持按状态过滤
  - 支持按任务类型过滤
  - 支持按计划ID过滤
  - 支持分页和排序
  - 返回任务列表和总数

### 任务数据模型

#### 任务类型 (TaskType)
- `learning`: 学习任务
- `training`: 训练任务
- `error_fix`: 错误修复任务
- `reflection`: 反思任务
- `social`: 社交任务
- `planning`: 规划任务

#### 任务状态 (TaskStatus)
- `PENDING`: 待处理
- `IN_PROGRESS`: 进行中
- `COMPLETED`: 已完成
- `ABANDONED`: 已放弃

### 任务属性
- **基础信息**: 标题、描述、类型、标签
- **时间管理**: 预估时长、实际时长、截止日期
- **难度评估**: 难度等级(1-5)、能量消耗(1-5)
- **优先级**: 优先级设置
- **关联**: 计划ID、知识点ID
- **AI辅助**: AI生成的指导内容
- **用户反馈**: 用户笔记

## 前端实现

### 主要组件
- **TaskListScreen**: 任务列表界面
  - 显示用户的所有任务
  - 支持按状态、类型筛选
  - 提供任务操作入口

- **TaskDetailScreen**: 任务详情界面
  - 显示任务详细信息
  - 提供任务操作按钮
  - 显示AI指导内容

- **TaskExecutionScreen**: 任务执行界面
  - 专注任务执行
  - 集成AI聊天面板
  - 跟踪执行进度

### 功能特性
- 任务状态可视化
- 进度跟踪
- AI辅助支持
- 时间记录

## API 接口

### 主要端点
- `GET /api/v1/tasks`: 获取任务列表
- `POST /api/v1/tasks`: 创建任务
- `GET /api/v1/tasks/{id}`: 获取任务详情
- `PUT /api/v1/tasks/{id}`: 更新任务
- `POST /api/v1/tasks/{id}/start`: 开始任务
- `POST /api/v1/tasks/{id}/complete`: 完成任务
- `POST /api/v1/tasks/{id}/abandon`: 放弃任务

## 数据模型

### 核心表结构
1. **tasks**: 任务表
   - id: 任务唯一标识
   - user_id: 所属用户ID
   - plan_id: 关联计划ID（可选）
   - title: 任务标题
   - type: 任务类型
   - tags: 任务标签列表
   - estimated_minutes: 预估时长（分钟）
   - difficulty: 难度等级 (1-5)
   - energy_cost: 能量消耗 (1-5)
   - guide_content: AI生成的指导内容
   - status: 任务状态
   - started_at: 开始时间
   - completed_at: 完成时间
   - actual_minutes: 实际耗时
   - user_note: 用户笔记
   - priority: 优先级
   - due_date: 截止日期
   - knowledge_node_id: 关联知识点ID
   - auto_expand_enabled: 自动拓展开关

### 查询参数模型 (TaskListQuery)
- page: 页码
- page_size: 每页数量
- status: 状态过滤
- type: 类型过滤
- plan_id: 计划ID过滤

## 关键业务流程

### 任务创建流程
1. 用户在前端输入任务信息
2. 前端验证输入数据
3. 调用创建API
4. 后端创建任务记录
5. 返回创建成功的任务信息

### 任务执行流程
1. 用户选择任务并点击开始
2. 更新任务状态为进行中
3. 用户执行任务
4. 用户完成任务时记录实际耗时
5. 更新任务状态为已完成
6. 触发相关模块（如知识星图点亮）

### 任务与知识点关联流程
1. 任务创建时自动关联知识点
2. 任务完成时触发知识点点亮
3. 更新用户知识掌握度
4. 记录学习历史

## 技术亮点

### 1. 状态管理
- 完整的任务状态流转
- 状态验证和权限控制

### 2. 灵活的过滤和分页
- 支持多维度过滤
- 高效的分页查询

### 3. 与AI集成
- AI生成任务指导内容
- 智能任务分类

### 4. 时间跟踪
- 预估与实际时间对比
- 时长记录和分析

## 模块关系

### 与知识星图模块的集成
- 任务与知识点的关联
- 任务完成触发知识点点亮
- 学习记录的自动更新

### 与计划模块的集成
- 任务可归属于特定计划
- 计划进度受任务完成情况影响
- 支持计划内任务管理

### 与推送模块的集成
- 未完成任务的提醒推送
- 任务相关的智能建议

### 与LLM模块的集成
- AI生成任务指导内容
- 智能任务建议

## 性能优化

### 1. 数据库优化
- 合理的索引策略
- 高效的查询语句

### 2. 分页机制
- 支持大数据量的任务列表
- 可配置的分页参数

### 3. 缓存策略
- 任务详情缓存
- 列表数据缓存

## 扩展性考虑

### 1. 模块化设计
- 服务层与控制器分离
- 易于扩展新功能

### 2. 可配置参数
- 分页大小可配置
- 状态流转规则可调整

### 3. 事件驱动架构
- 任务状态变更事件
- 便于与其他模块集成

## 用户体验设计

### 任务状态指示
- 不同状态的颜色标识
- 状态流转的可视化

### 操作便捷性
- 快速状态切换
- 批量操作支持

### 信息展示
- 任务关键信息突出显示
- 进度可视化
- 时间管理辅助
