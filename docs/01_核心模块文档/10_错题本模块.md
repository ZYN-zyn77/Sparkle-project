# 错题本模块 (Error Book Module)

## 1. 概述

错题本模块是 Sparkle 的核心学习反馈工具，旨在通过数字化用户的错误，利用 AI 深度诊断错误根因，并基于艾宾浩斯记忆规律（SM-2 算法）实现科学复习。

---

## 2. 核心功能

### 2.1 错题录入与 OCR 识别
- **多模态输入**: 支持文字输入、图片上传。
- **自动 OCR**: 后端集成 OCR 服务（Mock 实现或 GPT-4o Vision），自动提取题目文字及选项。
- **元数据绑定**: 自动或手动关联科目、章节及认知维度标签。

### 2.2 AI 智能诊断 (Deep Diagnosis)
- **根因分析**: 区分“概念混淆”、“计算失误”、“审题不清”、“知识盲区”、“方法错误”及“逻辑错误”。
- **RAG 关联**: 自动检索知识星图中的关联节点（Knowledge Linking）。
- **个性化建议**: 根据错误类型提供针对性的学习动作（如“复习节点 A”或“尝试类似题型 B”）。

### 2.3 科学复习调度 (SM-2 Algorithm)
- **间隔复习**: 采用经典的 SM-2 算法计算下次复习时间。
- **反馈闭环**: 
  - `Remembered` (掌握): 延长间隔。
  - `Fuzzy` (模糊): 轻微缩短间隔或保持。
  - `Forgotten` (忘记): 重置学习路径，缩短间隔。
- **随机抖动 (Jitter)**: 引入 ±10% 的时间抖动，平衡每日复习压力。

---

## 3. 技术架构

### 3.1 协议定义 (gRPC)
错题本采用 gRPC 进行高效通信，主要接口定义于 `proto/error_book.proto`:

- `CreateError`: 创建记录并触发异步分析。
- `AnalyzeError`: 重新触发 AI 分析流。
- `SubmitReview`: 提交复习反馈并更新掌握度。
- `GetTodayReviews`: 获取今日待复习清单。

### 3.2 服务流程
1. **客户端提交**: Flutter 发送 `CreateErrorRequest`。
2. **异步流水线**:
   - `Step 1`: OCR 提取。
   - `Step 2`: 基于向量检索 (pgvector) 匹配知识点。
   - `Step 3`: LLM 综合分析，生成 `ErrorAnalysisResult`。
   - `Step 4`: 写入数据库并发布 `ErrorCreated` 事件。
3. **数据同步**: Go Gateway 监听更新或通过 gRPC 返回结果。

---

## 4. 数据模型

### 4.1 ErrorRecord (错题记录)
- `question_text`: 题目正文。
- `question_image_url`: 题目原图。
- `mastery_level`: 0.0 ~ 1.0 的动态掌握度。
- `next_review_at`: 经 SM-2 计算后的下次复习时间。
- `latest_analysis`: JSONB 存储的 AI 诊断详情。

### 4.2 ErrorAnalysisResult (AI 诊断)
- `error_type`: 机器可读的错误分类。
- `root_cause`: 错误深度分析。
- `recommended_knowledge`: 推荐学习的知识点 ID 列表。

---

## 5. 后续规划
- **相似题推送**: 基于错题标签自动从题库抽取相似题。
- **班级错题分析**: 汇总社群内的高频错题，生成“小队避坑指南”。

---
*参考代码*: `backend/app/services/error_book_service.py` | `proto/error_book.proto`
