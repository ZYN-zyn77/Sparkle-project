# 知识星图模块 (Knowledge Galaxy) - 功能描述文档

## 模块概述

知识星图模块是 Sparkle 应用的核心功能模块，负责管理用户的知识学习进度、提供可视化的知识结构以及实现基于艾宾浩斯遗忘曲线的学习辅助。该模块通过"点亮星星"的隐喻，将知识点转化为可视化星图，让用户能够直观地看到自己的学习进度和知识结构。

## 后端实现 (GalaxyService)

### 核心功能

#### 1. 星图数据管理
- **get_galaxy_graph**: 获取用户的知识星图数据，包括节点、关系和用户状态
  - 支持按星域筛选
  - 支持是否包含未解锁节点的选项
  - 使用缓存机制优化性能 (TTL: 600秒)
  - 返回完整的星图数据结构

#### 2. 知识点点亮 (Spark)
- **spark_node**: 点亮/增强知识点，通常在任务完成时调用
  - 计算掌握度增量，基于学习时长和知识点重要性
  - 更新用户节点状态（掌握度、学习时长、学习次数等）
  - 记录学习历史
  - 生成动画事件用于前端展示
  - 在适当条件下触发LLM拓展

#### 3. 语义搜索
- **semantic_search**: 使用向量相似度搜索知识点
  - 基于pgvector的向量搜索功能
  - 支持按科目筛选
  - 返回相似度和用户状态信息
  - 结合关键词搜索作为降级策略

#### 4. 节点管理
- **create_node**: 创建新的知识节点
- **create_edge**: 创建节点间的关系
- **keyword_search**: 基于关键词的节点搜索

#### 5. 任务自动归类
- **auto_classify_task**: 根据任务标题自动匹配知识点
  - 使用向量匹配优先
  - 关键词匹配作为降级策略

### 掌握度计算机制

#### 基础计算公式
- 基础掌握度点数：5.0
- 时间系数：`min(study_minutes / 30.0, 2.0)` (30分钟为标准，最多2倍)
- 难度系数：`1 + (importance_level - 1) * 0.1` (重要性越高，增长越多)
- 最大掌握度：100.0

#### 掌握度等级
- 未点亮 (<0): 未解锁
- 微光 (1-29): 刚接触知识点
- 闪耀 (30-79): 有一定掌握
- 璀璨 (80-94): 掌握良好
- 精通 (95-100): 完全掌握

#### 复习时间计算
- 80分以上：14天后复习
- 60-79分：7天后复习
- 30-59分：3天后复习
- 30分以下：1天后复习

### LLM拓展集成
- 当节点学习次数达到2次时，自动将拓展请求加入队列
- 扩展服务会基于上下文生成相关知识点
- 通过SSE实时通知前端新节点信息

## 前端实现

### 主要组件
- **GalaxyScreen**: 知识星图主界面
  - 提供可视化星图展示
  - 支持缩放和拖拽操作
  - 显示用户学习进度和状态

### 视觉表现
- 不同的视觉状态表示不同的掌握度等级
- 支持节点交互和动画效果
- 实时反映学习进度变化

## API 接口

### 主要端点
- `GET /api/v1/galaxy/graph`: 获取星图数据
- `POST /api/v1/galaxy/node/{node_id}/spark`: 点亮知识点
- `POST /api/v1/galaxy/search`: 语义搜索
- `GET /api/v1/galaxy/review/suggestions`: 获取复习建议
- `POST /api/v1/galaxy/node/{node_id}/decay/pause`: 暂停遗忘衰减
- `GET /api/v1/galaxy/stats`: 获取统计信息
- `GET /api/v1/galaxy/events`: SSE事件流

## 数据模型

### 核心表结构
1. **knowledge_nodes**: 知识节点表
   - id: 节点唯一标识
   - name: 节点名称
   - description: 节点描述
   - subject_id: 关联科目
   - importance_level: 重要性等级 (1-5)
   - embedding: 向量嵌入 (用于语义搜索)

2. **user_node_status**: 用户节点状态表
   - user_id: 用户ID
   - node_id: 节点ID
   - mastery_score: 掌握度分数
   - total_study_minutes: 总学习时长
   - study_count: 学习次数
   - is_unlocked: 是否已解锁
   - next_review_at: 下次复习时间

3. **node_relations**: 节点关系表
   - source_node_id: 源节点ID
   - target_node_id: 目标节点ID
   - relation_type: 关系类型
   - strength: 关系强度

4. **study_records**: 学习记录表
   - user_id: 用户ID
   - node_id: 节点ID
   - study_minutes: 学习时长
   - mastery_delta: 掌握度变化

## 关键业务流程

### 点亮知识点流程
1. 用户完成相关任务
2. 前端调用spark API
3. 后端计算掌握度增量
4. 更新用户节点状态
5. 记录学习历史
6. 生成动画事件
7. 触发LLM拓展（如满足条件）
8. 通过SSE通知前端
9. 前端播放动画效果

### 语义搜索流程
1. 用户输入搜索关键词
2. 生成查询向量
3. 执行向量相似度搜索
4. 返回匹配的知识点列表
5. 包含用户状态信息

## 技术亮点

### 1. 缓存机制
- 使用缓存优化星图数据获取性能
- 智能缓存失效策略

### 2. 向量搜索
- 基于pgvector的高效向量相似度搜索
- 支持语义层面的知识点查找

### 3. 艾宾浩斯遗忘曲线
- 自动计算知识遗忘衰减
- 智能推荐复习节点

### 4. LLM集成
- 自动知识点拓展功能
- 基于学习上下文的智能推荐

## 模块关系

### 与LLM模块的集成
- 通过ExpansionService触发知识点拓展
- 为LLM提供用户学习上下文

### 与任务模块的集成
- 任务完成时触发知识点点亮
- 任务与知识点的自动关联

### 与推送模块的集成
- 提供复习建议数据
- 支持基于掌握度的推送策略

### 与计划模块的集成
- 计划执行过程中涉及知识点点亮
- 基于知识点掌握度调整计划

## 性能优化

### 1. 数据库优化
- 向量索引提升搜索性能
- 合理的索引策略

### 2. 缓存策略
- 星图数据缓存
- 智能缓存失效

### 3. API优化
- 分页和筛选机制
- 批量操作支持

## 扩展性考虑

### 1. 模块化设计
- 服务层与控制器分离
- 易于扩展新功能

### 2. 可配置参数
- 掌握度计算参数可配置
- 遗忘曲线参数可调整

### 3. 插件化架构
- LLM提供商可替换
- 搜索策略可扩展
