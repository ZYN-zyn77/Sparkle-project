# 用户管理模块 (User Management) - 功能描述文档

## 模块概述

用户管理模块是Sparkle应用的基础模块，负责用户认证、注册、信息管理等功能。该模块处理用户的身份验证、个性化设置以及与用户相关的各种配置，为整个应用提供用户上下文支持。

## 后端实现 (UserService)

### 当前实现状态

根据代码分析，用户管理模块的实现情况如下：
- 用户认证API已实现（auth.py）
- 用户模型定义完整
- JWT令牌处理机制已实现
- 但UserService文件可能未完全实现或功能有限

### 核心功能

#### 1. 用户认证
- **登录**: 验证用户凭据并生成JWT令牌
- **注册**: 创建新用户账户
- **令牌刷新**: JWT令牌刷新机制
- **密码重置**: 密码重置功能

#### 2. 用户信息管理
- **获取用户信息**: 获取当前用户详细信息
- **更新用户信息**: 更新用户个人资料
- **用户偏好设置**: 管理用户个性化配置

### 用户数据模型

#### 用户属性
- **基础信息**: 用户名、邮箱、昵称、头像
- **个性化设置**: 
  - 火焰等级 (flame_level): 1-10等级
  - 火焰亮度 (flame_brightness): 0-1范围
  - 深度偏好 (depth_preference): 0-1范围
  - 好奇心偏好 (curiosity_preference): 0-1范围
- **时间安排**: 碎片时间/日程偏好 (schedule_preferences)
- **账户状态**: 激活状态

### 认证机制

#### JWT令牌处理
- 使用python-jose进行JWT处理
- 令牌有效期管理
- 令牌刷新机制

#### 密码安全
- 使用Passlib进行密码哈希
- 安全的密码存储

## 前端实现

### 主要组件
- **AuthScreen**: 认证界面（登录/注册）
  - 提供用户登录功能
  - 提供新用户注册功能
  - 表单验证和错误处理

- **ProfileScreen**: 个人资料界面
  - 显示用户个人信息
  - 提供个人资料编辑功能
  - 显示用户学习统计数据

### 功能特性
- 用户认证状态管理
- 个人资料编辑
- 学习进度展示
- 偏好设置管理

## API 接口

### 主要端点
- `POST /api/v1/auth/login`: 用户登录
- `POST /api/v1/auth/register`: 用户注册
- `POST /api/v1/auth/refresh`: 令牌刷新
- `GET /api/v1/auth/me`: 获取当前用户信息
- `PUT /api/v1/auth/me`: 更新用户信息
- `POST /api/v1/auth/logout`: 用户登出

## 数据模型

### 核心表结构
1. **users**: 用户表
   - id: 用户唯一标识 (GUID)
   - username: 用户名
   - email: 邮箱
   - hashed_password: 哈希密码
   - nickname: 昵称
   - avatar_url: 头像URL
   - flame_level: 火焰等级 (1-10)
   - flame_brightness: 火焰亮度 (0-1)
   - depth_preference: 深度偏好 (0-1)
   - curiosity_preference: 好奇心偏好 (0-1)
   - schedule_preferences: 时间安排偏好 (JSON)
   - is_active: 是否激活

### 用户配置
- **火焰设置**: 等级和亮度控制
- **学习偏好**: 深度和好奇心偏好
- **时间管理**: 碎片时间安排偏好

## 关键业务流程

### 用户注册流程
1. 用户填写注册信息
2. 前端验证输入数据
3. 调用注册API
4. 后端验证并创建用户
5. 返回认证令牌
6. 前端保存令牌并跳转到主界面

### 用户登录流程
1. 用户输入登录凭据
2. 前端验证输入
3. 调用登录API
4. 后端验证凭据
5. 生成JWT令牌
6. 前端保存令牌并跳转到主界面

### 个人资料更新流程
1. 用户在个人资料页面编辑信息
2. 前端验证更改
3. 调用更新API
4. 后端更新用户信息
5. 前端更新本地状态

## 模块关系

### 与知识星图模块的集成
- 提供用户上下文
- 个性化星图展示
- 用户学习进度跟踪

### 与任务模块的集成
- 任务归属管理
- 用户任务统计

### 与计划模块的集成
- 计划归属管理
- 个性化计划设置

### 与推送模块的集成
- 推送偏好设置
- 个性化推送配置

## 技术亮点

### 1. 安全认证
- JWT令牌机制
- 密码哈希安全
- 令牌刷新策略

### 2. 个性化配置
- 多维度用户偏好
- 可配置的界面元素

### 3. 数据验证
- 输入数据验证
- 业务规则验证

## 配置参数

### 环境变量
- `SECRET_KEY`: JWT签名密钥
- `ACCESS_TOKEN_EXPIRE_MINUTES`: 访问令牌有效期

### 用户配置
- 火焰等级范围: 1-10
- 亮度范围: 0-1
- 偏好范围: 0-1

## 错误处理

### 认证错误
- 无效凭据处理
- 令牌过期处理
- 重复注册处理

### 数据验证错误
- 输入格式验证
- 业务规则验证

## 扩展性考虑

### 1. 社交认证
- 支持第三方登录
- OAuth集成准备

### 2. 多语言支持
- 国际化准备
- 本地化配置

### 3. 用户角色
- 权限系统扩展
- 角色管理预留

## 用户体验设计

### 认证流程
- 简洁的注册/登录界面
- 友好的错误提示
- 快速的验证反馈

### 个人资料管理
- 直观的配置界面
- 即时的偏好生效
- 个人数据保护

## 性能优化

### 1. 令牌管理
- 高效的JWT验证
- 令牌缓存策略

### 2. 数据加载
- 用户信息缓存
- 快速的认证状态检查
