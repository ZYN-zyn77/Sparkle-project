# 认知学习与编排引擎 (Cognitive & Orchestration Engine)

## 概述

Sparkle 的 AI 核心已从简单的请求-响应模式演进为一套复杂的“认知-编排”体系。该体系由 **Orchestration层**（负责执行流编排）和 **Learning层**（负责用户画像与策略优化）共同构成，实现了真正的个性化学习引导。

---

## 1. Orchestration 编排引擎

编排引擎位于 `backend/app/orchestration/`，是连接 LLM 与业务逻辑的桥梁。

### 核心组件

- **StatechartEngine (状态图引擎)**:
  - **路径**: `statechart_engine.py`
  - **核心机制**:
    - **层次化状态图 (State Graph)**: 支持嵌套图（Sub-graphs）和并行执行（Parallel Branches）。
    - **黑板模式 (Blackboard State)**: 共享的 `WorkflowState` 对象在节点间传递消息历史、上下文数据及追踪 ID。
    - **动态路由**: 支持 `add_conditional_edge`，允许根据 LLM 的输出或用户画像实时决定下一跳转节点。
    - **检查点机制 (Checkpointer)**: 在节点执行前自动保存状态，支持长会话中断后的精准恢复。
  - **优势**: 确保 AI 在长链路任务（如从错题诊断到知识点拆解再到巩固练习）中逻辑自洽，避免陷入死循环。

- **CollaborationWorkflows (协作工作流)**:
  - **路径**: `collaboration_workflows.py`
  - **定义**: 预定义的 Agent 协作模式，如 `TaskDecompositionWorkflow`（任务分解流）和 `ErrorDiagnosisWorkflow`（错题诊断流）。
  - **触发**: 编排器根据用户意图（Intent）动态选择最合适的流进行处理。

- **ContextPruner (上下文剪枝)**:
  - **路径**: `context_pruner.py`
  - **功能**: 自动清理对话历史中的冗余信息，保留关键实体和结论，确保不超出 LLM 的上下文窗口，并提升推理速度。

---

## 2. Learning 认知学习层

学习层位于 `backend/app/learning/`，负责将“通用 AI”转化为用户的“私人导师”。

### 核心技术：持久化贝叶斯学习器

- **实现**: `persistent_bayesian_learner.py`
- **数学模型**:
  - 利用贝叶斯推断对用户的学习信号进行建模。
  - 追踪维度：逻辑偏好、记忆强度、好奇心水平、语言习惯。
- **持久化**: 模型状态存储于 PostgreSQL 中，随用户交互不断进化，实现跨会话的认知对齐。

### 多维度画像

- **能力图谱**: 动态评估用户在不同学科维度的掌握度，不仅看结果，更看解题思路（由 `multi_dimensional_learner.py` 驱动）。
- **反馈闭环**: `auto_optimizer.py` 根据用户对 AI 建议的采纳率，自动调整后续响应的语调（Tone）和难度。

---

## 3. 工作流程示例

1. **接收输入**: 用户通过 WebSocket 发送“我不理解递归”。
2. **意图识别**: `StatechartEngine` 识别为 `EXPLORATION` 状态。
3. **策略选择**: 编排器调用 `CollaborationWorkflows` 中的 `ProgressiveExplorationWorkflow`。
4. **画像提取**: `BayesianLearner` 提取用户画像——“偏好直观类比，逻辑能力强”。
5. **Prompt 合成**: `Composer` 合成定制化的提示词：“用一个直观类比解释递归，基于用户已掌握的‘函数调用’概念”。
6. **流式响应**: 通过 gRPC 返回由用户画像增强的讲解内容。

---

## 4. 后续演进

- **跨学科关联**: 学习层将尝试发现用户在不同学科间的认知共性（如数学逻辑与编程逻辑的关联）。
- **情绪感知**: 引入实时情绪反馈，动态调整教学节奏。

---
*参考代码*: `backend/app/orchestration/` | `backend/app/learning/`
