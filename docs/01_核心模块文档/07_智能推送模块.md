# 智能推送模块 (Smart Push) - 功能描述文档

## 模块概述

智能推送模块是Sparkle应用中的个性化推送系统，基于多种策略为用户提供智能化、个性化的内容推送。该模块通过分析用户的学习行为、知识掌握情况、计划进度等因素，智能地推送相关内容，帮助用户保持学习动力和效率。

## 后端实现 (PushService)

### 核心功能

#### 1. 推送策略管理
- **process_all_users**: 处理所有用户的推送
  - 获取所有活跃用户及其推送偏好
  - 为每个用户执行推送处理逻辑

- **process_user_push**: 处理单个用户的推送
  - 检查用户是否在活跃时间范围内
  - 检查频率限制（每日上限和冷却时间）
  - 评估推送策略优先级
  - 生成并发送推送内容

#### 2. 推送策略实现
- **MemoryStrategy**: 记忆策略
  - 检测重要知识点的低掌握度
  - 基于艾宾浩斯遗忘曲线计算
  - 触发条件：掌握度<0.3且重要性>4

- **SprintStrategy**: 冲刺策略
  - 检测接近截止日期的冲刺计划
  - 触发条件：计划截止日期在72小时内

- **InactivityStrategy**: 不活跃策略
  - 检测长时间未活跃的用户
  - 触发条件：用户未活跃超过24小时

#### 3. 推送内容生成
- **generate_push_content**: 生成个性化推送内容
  - 基于用户偏好（教练型、动漫型等）
  - 根据触发类型生成相应内容
  - 返回结构化推送内容

### 推送策略架构

#### 策略基类 (PushStrategy)
- 定义策略接口
- 统一的触发条件检查
- 推送数据获取方法

#### 具体策略实现
1. **MemoryStrategy**: 记忆巩固策略
2. **SprintStrategy**: 冲刺提醒策略
3. **InactivityStrategy**: 激活唤醒策略

### 数据模型

#### 核心表结构
1. **push_preferences**: 推送偏好表
   - id: 偏好记录唯一标识
   - user_id: 用户ID
   - active_slots: 活跃时间槽 (JSON)
   - timezone: 时区设置
   - enable_curiosity: 是否启用好奇心推送
   - persona_type: 推送角色类型（教练/动漫等）
   - daily_cap: 每日推送上限
   - last_push_time: 最后推送时间
   - consecutive_ignores: 连续忽略次数

2. **push_histories**: 推送历史表
   - id: 历史记录唯一标识
   - user_id: 用户ID
   - trigger_type: 触发类型
   - content_hash: 内容哈希
   - status: 状态（已发送/已点击/已忽略等）

3. **notifications**: 通知表
   - id: 通知唯一标识
   - user_id: 用户ID
   - title: 通知标题
   - content: 通知内容
   - type: 通知类型
   - is_read: 是否已读
   - data: 关联数据 (JSON)

### 配置参数
- **推送频率**: 每15分钟执行一次
- **每日上限**: 可配置的推送次数限制
- **冷却时间**: 避免频繁推送的时间间隔

## 前端实现

### 功能特性
- 推送通知展示
- 通知中心管理
- 推送设置界面
- 个性化偏好配置

### 用户交互
- 推送通知点击处理
- 通知状态更新
- 推送反馈收集

## API 接口

### 主要端点
- `GET /api/v1/notifications`: 获取通知列表
- `PUT /api/v1/notifications/{id}/read`: 标记通知为已读
- `GET /api/v1/push/preferences`: 获取推送偏好
- `PUT /api/v1/push/preferences`: 更新推送偏好

## 关键业务流程

### 智能推送流程
1. 定时触发（每15分钟）
2. 获取所有活跃用户
3. 对每个用户执行推送评估
4. 检查时间范围和频率限制
5. 按优先级评估推送策略
6. 生成个性化推送内容
7. 发送推送并记录历史

### 推送策略评估流程
1. SprintStrategy (优先级最高)
2. MemoryStrategy (次优先级)
3. InactivityStrategy (最低优先级)
4. 选择最佳策略执行

### 推送内容生成流程
1. 确定触发策略类型
2. 获取用户偏好设置
3. 构建个性化提示词
4. 调用LLM生成内容
5. 解析并返回结构化内容

## 技术亮点

### 1. 多策略并行评估
- 并行评估多种推送策略
- 智能选择最优推送内容
- 避免重复推送

### 2. 个性化内容生成
- 基于用户偏好的角色类型
- 智能内容生成算法
- 结构化内容输出

### 3. 频率控制机制
- 每日推送上限控制
- 冷却时间避免骚扰
- 连续忽略处理

### 4. 时区感知
- 支持用户时区设置
- 智能时间范围控制
- 避免夜间推送

## 模块关系

### 与知识星图模块的集成
- 基于知识掌握度的推送
- 重要知识点复习提醒
- 遗忘曲线算法集成

### 与计划模块的集成
- 冲刺计划进度提醒
- 计划截止日期推送
- 计划相关任务提醒

### 与LLM模块的集成
- 推送内容的AI生成
- 个性化文案创作
- 智能内容适配

### 与用户模块的集成
- 用户偏好设置
- 个性化推送配置
- 用户活跃状态跟踪

## 性能优化

### 1. 批量处理
- 批量处理用户推送
- 高效的数据查询
- 减少数据库访问

### 2. 缓存策略
- 推送偏好缓存
- 频率限制缓存
- 内容生成缓存

### 3. 异步处理
- 非阻塞推送处理
- 异步内容生成
- 高效的任务调度

## 配置参数

### 系统配置
- 推送执行频率：每15分钟
- 冲刺计划提醒阈值：72小时内
- 记忆策略触发阈值：掌握度<0.3
- 不活跃策略阈值：24小时无活动

### 用户配置
- 活跃时间槽设置
- 每日推送上限
- 推送角色类型选择
- 好奇心推送开关

## 错误处理

### 异常处理机制
- 推送生成异常捕获
- 内容解析错误处理
- 数据库操作异常处理

### 降级策略
- 推送失败的重试机制
- 内容生成失败的默认内容
- 系统异常的快速恢复

## 扩展性考虑

### 1. 策略扩展
- 可插拔的推送策略
- 易于添加新的策略类型
- 策略配置化管理

### 2. 渠道扩展
- 多渠道推送支持
- 推送方式可扩展
- 平台特定推送适配

### 3. 个性化扩展
- 更多用户偏好维度
- 智能推送时机优化
- 个性化策略权重

## 用户体验设计

### 推送体验
- 个性化推送内容
- 恰当的推送时机
- 有用的推送信息

### 设置体验
- 直观的偏好设置
- 灵活的时间配置
- 清晰的频率控制

### 反馈机制
- 推送效果反馈
- 用户偏好调整
- 推送满意度评估
