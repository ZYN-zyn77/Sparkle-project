# Agent 全功能接入改进方案（面向“碎片时间与专注提升”）

> 目标：让 Agent 不只是“对话”，而是用户完成学习闭环的“行动中枢”，把酷炫的多 Agent 协作真正转化为**可感知的效率提升**。

---

## 1. 现状审查（脱节点）

1) **gRPC/WS 路径只有文本与状态**，缺少“工具结果与可视化组件”事件，导致任务/知识/计划无法在聊天中直接落地。
2) **Agent 用户上下文在 gRPC 路径中是占位符**，未包含任务、专注、计划、进度等核心信息，AI 很难做“下一步”推荐。
3) **多 Agent 协作与核心闭环脱钩**，协作结果难以落到“微任务/专注/行动卡片”。
4) **计划能力在产品层未接通**（API stub + 无工具），AI 无法真正创建冲刺/成长计划并衍生任务。
5) **碎片时间与专注增强缺少工具入口**，无法“给出可立即执行的 10-25 分钟任务”。

---

## 2. 用户感知目标（产品核心）

- **碎片时间变成可执行动作**：用户说“我只有 20 分钟”，AI 直接给出一个可开始的微任务卡片。
- **专注体验被 AI 直接驱动**：AI 能推荐“马上开始的专注冲刺”，并连接专注模式。
- **复杂任务即时拆解**：用户说“准备期末”，AI 不只建议，而是生成 3-5 个微任务并落库。
- **计划与任务联动**：AI 可创建冲刺/成长计划，随后生成对应任务卡片。
- **多 Agent 协作结果可见、可执行**：协作不是“展示”，而是直接形成行动卡片与任务清单。

---

## 3. 改造原则

1) **行动优先**：能调用工具就不只回答。
2) **微任务优先**：所有建议必须“可在 15-45 分钟完成”。
3) **专注闭环**：AI 给出的动作必须能进入专注模式或任务系统。
4) **结构化输出**：用工具返回组件数据，保证前端可视化落地。

---

## 4. 改造方案（全功能接入路径）

### 4.1 Agent Action Layer（统一动作层）
- 以工具调用为唯一出口：任务、计划、知识、专注建议全部通过工具结构化输出。
- 工具结果统一返回 `tool_result`（带 widget_data），前端统一渲染。

### 4.2 上下文升级（User + Focus + Next Actions）
- 补齐 AI 上下文：今日专注数据、待办任务、活跃计划、学习偏好。
- 让 Agent 能真正根据“当前状态”做建议，而不是凭空回答。

### 4.3 核心工具补齐
- **碎片时间工具**：根据可用时长推荐最合适的微任务。
- **任务拆解工具**：一键拆解复杂任务并创建微任务清单。
- **计划创建工具**：生成冲刺/成长计划卡片并可后续生成任务。
- **专注入口工具**：返回“可立即开始”的专注卡片。

### 4.4 多 Agent 协作落地
- 协作结果必须输出任务/计划/专注卡片，否则视为失败。
- 协作产出通过同一 Action Layer 进入产品闭环。

---

## 5. 具体实施清单

### Phase 1（当前迭代，必须完成）
- [ ] gRPC 流式新增 `tool_result` 事件，支持 widget 数据透传
- [ ] Agent 上下文补齐（专注数据 + 待办任务 + 计划）
- [ ] 新增工具：碎片时间推荐、任务拆解、计划创建
- [ ] 移动端支持 tool_result + widget 渲染

### Phase 2（下一迭代）
- [ ] 多 Agent 协作结果强制产出行动卡片
- [ ] 计划 → 任务自动生成与进度追踪
- [ ] 专注模式中 AI 实时指导（方法论提示）

---

## 6. 成功指标（用户感知）

- “从输入到生成可执行任务”的平均时间 < 3 秒
- “碎片时间推荐 → 进入专注模式”的转化率提升
- “复杂任务拆解后 24h 内的执行率”显著提升
- 用户反馈：AI 不只是回答问题，而是**帮我开始行动**

---

**结论**：本轮改造把多 Agent 的技术能力转化为用户“立即可执行”的体验，真正围绕核心目标：**碎片时间利用、专注增强、微任务落地**。
