# Sparkle å¤šæ™ºèƒ½ä½“ç³»ç»Ÿå…¨æ–¹ä½æ”¹è¿›æ–¹æ¡ˆ

> **é¡¹ç›®**ï¼šSparkle AI å­¦ä¹ åŠ©æ‰‹  
> **ç‰ˆæœ¬**ï¼šv2.0 - å¤šæ™ºèƒ½ä½“åä½œå¢å¼ºç‰ˆ  
> **æ—¥æœŸ**ï¼š2025-12-27  
> **ç›®æ ‡**ï¼šå°†å¤šAgentç³»ç»Ÿä»æŠ€æœ¯å±•ç¤ºå‡çº§ä¸ºå­¦ç”Ÿå­¦ä¹ çš„æ ¸å¿ƒä»·å€¼é©±åŠ¨å™¨

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### å½“å‰çŠ¶æ€åˆ†æ
**å·²æœ‰åŸºç¡€**ï¼š
- âœ… 4ä¸ªä¸“ä¸šAgentï¼ˆMath/Writing/Code/Scienceï¼‰+ Orchestratoråè°ƒå™¨
- âœ… å‰ç«¯UIç»„ä»¶ï¼ˆAgentå¤´åƒå †æ ˆã€æ¨ç†æ°”æ³¡ã€åä½œæ°”æ³¡ï¼‰
- âœ… ä¸ç°æœ‰orchestrationç³»ç»Ÿé›†æˆ

**å…³é”®é—®é¢˜**ï¼š
- âš ï¸ Agentèƒ½åŠ›ä¸å­¦ç”Ÿæ ¸å¿ƒå­¦ä¹ åœºæ™¯è„±èŠ‚
- âš ï¸ åä½œæµç¨‹ç®€å•ï¼Œç¼ºä¹çœŸæ­£ååŒ
- âš ï¸ å¯è§†åŒ–ä¸è¶³ï¼Œå­¦ä¹ ä»·å€¼æœ‰é™
- âš ï¸ æœªæ·±åº¦é›†æˆç”¨æˆ·æ•°æ®å’ŒçŸ¥è¯†å›¾è°±

### æ”¹è¿›æ ¸å¿ƒç†å¿µ
**ä»"AIå·¥å…·" â†’ "AIå­¦ä¹ å¯¼å¸ˆå›¢é˜Ÿ"**

**ç‹¬ç‰¹ä»·å€¼ä¸»å¼ **ï¼š
- ğŸ“ **ä¸“ä¸šå¯¼å¸ˆå›¢é˜Ÿ**ï¼š4ä½ä¸“å®¶ååŒæ•™å­¦
- ğŸ§  **å­¦ä¹ è¿‡ç¨‹é€æ˜**ï¼šå±•ç¤ºå®Œæ•´æ€è€ƒé“¾
- ğŸ“ˆ **ä¸ªæ€§åŒ–æˆé•¿**ï¼šåŸºäºçŸ¥è¯†å›¾è°±å’Œé—å¿˜æ›²çº¿
- ğŸ¤ **ä¸»åŠ¨åä½œ**ï¼šAIé—´è®¨è®ºäº§ç”Ÿæ·±åº¦æ´å¯Ÿ
- ğŸ“Š **å­¦ä¹ åˆ†æ**ï¼šå¯¹è¯å³è¯Šæ–­ï¼Œç”Ÿæˆè¡ŒåŠ¨è®¡åˆ’

---

## ğŸ¯ é˜¶æ®µä¸€ï¼šAgentèƒ½åŠ›é‡æ„

### 1.1 æ•™è‚²å¯¼å‘Agentè§’è‰²å®šä¹‰

#### æ–°å¢æ ¸å¿ƒAgent

```python
# backend/app/agents/study_planner_agent.py
class StudyPlannerAgent(BaseAgent):
    """å­¦ä¹ è§„åˆ’å¸ˆ - åŸºäºé—å¿˜æ›²çº¿å’Œè€ƒè¯•æ—¶é—´åˆ¶å®šè®¡åˆ’"""
    
    def __init__(self):
        super().__init__()
        self.role = AgentRole.STUDY_PLANNER
        self.name = "å­¦ä¹ è§„åˆ’å¸ˆ"
        self.description = "åŸºäºé—å¿˜æ›²çº¿å’Œè€ƒè¯•æ—¶é—´ï¼Œåˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’"
        self.capabilities = [
            "åˆ†æç”¨æˆ·çŸ¥è¯†æŒæ¡åº¦",
            "åŸºäºé—å¿˜æ›²çº¿å®‰æ’å¤ä¹ ",
            "åˆ¶å®šå†²åˆºè®¡åˆ’",
            "åŠ¨æ€è°ƒæ•´å­¦ä¹ è·¯å¾„",
            "è¯†åˆ«å­¦ä¹ ç“¶é¢ˆ"
        ]

    def can_handle(self, query: str) -> float:
        """è¯†åˆ«å­¦ä¹ è§„åˆ’ç›¸å…³æŸ¥è¯¢"""
        keywords = ["è®¡åˆ’", "å¤ä¹ ", "è€ƒè¯•", "å†²åˆº", "å®‰æ’", "æ—¶é—´è¡¨", "é—å¿˜"]
        return self._calculate_confidence(query, keywords, 0.4)

    async def process(self, context: AgentContext) -> AgentResponse:
        """ç”Ÿæˆä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’"""
        # 1. è·å–ç”¨æˆ·çŸ¥è¯†çŠ¶æ€
        knowledge_status = await self._get_knowledge_status(context.user_id)
        
        # 2. åˆ†æé—å¿˜æ›²çº¿
        forgetting_analysis = await self._analyze_forgetting_curve(context.user_id)
        
        # 3. ç”Ÿæˆä¼˜åŒ–è®¡åˆ’
        plan = await self._generate_study_plan(
            context.user_query,
            knowledge_status,
            forgetting_analysis
        )
        
        return self.format_response(
            text=plan.summary,
            reasoning=f"åŸºäºç”¨æˆ·æŒæ¡åº¦ {knowledge_status.overall_mastery:.1%}ï¼Œ"
                     f"é—å¿˜é£é™©ç‚¹: {len(forgotten_concepts)}ä¸ª",
            confidence=0.9,
            metadata={
                "plan": plan,
                "knowledge_status": knowledge_status,
                "forgetting_analysis": forgetting_analysis
            }
        )
```

```python
# backend/app/agents/problem_solver_agent.py
class ProblemSolverAgent(BaseAgent):
    """é—®é¢˜è§£å†³å¯¼å¸ˆ - è‹æ ¼æ‹‰åº•å¼æ•™å­¦æ³•"""
    
    def __init__(self):
        super().__init__()
        self.role = AgentRole.PROBLEM_SOLVER
        self.name = "é—®é¢˜è§£å†³å¯¼å¸ˆ"
        self.description = "é€šè¿‡å¼•å¯¼å¼æé—®å’ŒçŸ¥è¯†ç‚¹å…³è”ï¼Œå¸®åŠ©å­¦ç”Ÿæ·±å…¥ç†è§£"
        self.capabilities = [
            "å¼•å¯¼å¼é—®é¢˜åˆ†æ",
            "çŸ¥è¯†ç‚¹å…³è”æ•™å­¦",
            "é”™é¢˜æ¨¡å¼è¯†åˆ«",
            "ä¸¾ä¸€åä¸‰è®­ç»ƒ",
            "æ¦‚å¿µæ·±åº¦è§£æ"
        ]

    async def process(self, context: AgentContext) -> AgentResponse:
        """è‹æ ¼æ‹‰åº•å¼é—®é¢˜è§£å†³"""
        # 1. åˆ†æé—®é¢˜ç±»å‹å’Œéš¾åº¦
        problem_analysis = await self._analyze_problem(context.user_query)
        
        # 2. æ£€ç´¢ç›¸å…³çŸ¥è¯†ç‚¹
        knowledge_context = await self._retrieve_knowledge(
            context.user_id,
            problem_analysis.key_concepts
        )
        
        # 3. ç”Ÿæˆå¼•å¯¼å¼å›ç­”
        socratic_response = await self._generate_socratic_dialog(
            context.user_query,
            problem_analysis,
            knowledge_context
        )
        
        return self.format_response(
            text=socratic_response.main_answer,
            reasoning=socratic_response.thinking_process,
            confidence=0.95,
            metadata={
                "problem_type": problem_analysis.type,
                "difficulty": problem_analysis.difficulty,
                "related_concepts": knowledge_context.concepts,
                "socratic_questions": socratic_response.follow_up_questions
            }
        )
```

```python
# backend/app/agents/code_review_agent.py
class CodeReviewAgent(BaseAgent):
    """ä»£ç å®¡æŸ¥å¯¼å¸ˆ - æ•™å­¦å¼ä»£ç ä¼˜åŒ–"""
    
    def __init__(self):
        super().__init__()
        self.role = AgentRole.CODE_REVIEW
        self.name = "ä»£ç å®¡æŸ¥å¯¼å¸ˆ"
        self.description = "æä¾›ä»£ç è´¨é‡è¯„ä¼°å’Œæœ€ä½³å®è·µæ•™å­¦"
        self.capabilities = [
            "ä»£ç è´¨é‡è¯„ä¼°",
            "æœ€ä½³å®è·µæ•™å­¦",
            "æ€§èƒ½ä¼˜åŒ–æŒ‡å¯¼",
            "æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ",
            "æ¶æ„è®¾è®¡å»ºè®®"
        ]

    async def process(self, context: AgentContext) -> AgentResponse:
        """æ•™å­¦å¼ä»£ç å®¡æŸ¥"""
        # 1. ä»£ç é™æ€åˆ†æ
        analysis = await self._analyze_code(context.user_query)
        
        # 2. ç”Ÿæˆæ”¹è¿›å»ºè®®
        improvements = await self._generate_improvements(analysis)
        
        # 3. æ•™å­¦å¼è§£é‡Š
        educational_response = await self._explain_with_examples(
            improvements,
            context.user_id
        )
        
        return self.format_response(
            text=educational_response.code_review,
            reasoning=f"è¯†åˆ«åˆ° {len(analysis.issues)} ä¸ªé—®é¢˜ï¼Œ"
                     f"é‡ç‚¹æ”¹è¿›: {improvements.top_priority}",
            confidence=0.92,
            metadata={
                "code_quality_score": analysis.quality_score,
                "issues": analysis.issues,
                "improvements": improvements,
                "examples": educational_response.examples
            }
        )
```

```python
# backend/app/agents/essay_coach_agent.py
class EssayCoachAgent(BaseAgent):
    """å†™ä½œæ•™ç»ƒ - ç»“æ„åŒ–å†™ä½œæŒ‡å¯¼"""
    
    def __init__(self):
        super().__init__()
        self.role = AgentRole.ESSAY_COACH
        self.name = "å†™ä½œæ•™ç»ƒ"
        self.description = "æä¾›æ–‡ç« ç»“æ„åˆ†æå’Œå†™ä½œæŒ‡å¯¼"
        self.capabilities = [
            "æ–‡ç« ç»“æ„åˆ†æ",
            "è®ºç‚¹é€»è¾‘ä¼˜åŒ–",
            "å­¦æœ¯å†™ä½œè§„èŒƒ",
            "ä¸ªæ€§åŒ–é£æ ¼å»ºè®®",
            "è¯­æ³•æ¶¦è‰²"
        ]

    async def process(self, context: AgentContext) -> AgentResponse:
        """å†™ä½œæŒ‡å¯¼ä¸æ¶¦è‰²"""
        # 1. åˆ†æå†™ä½œç›®æ ‡å’Œå—ä¼—
        writing_context = await self._analyze_writing_context(context.user_query)
        
        # 2. ç»“æ„å’Œå†…å®¹åˆ†æ
        analysis = await self._analyze_structure(context.user_query)
        
        # 3. ç”Ÿæˆæ”¹è¿›å»ºè®®
        suggestions = await self._generate_writing_suggestions(analysis)
        
        return self.format_response(
            text=suggestions.revised_text,
            reasoning=f"ç»“æ„è¯„åˆ†: {analysis.structure_score}/10ï¼Œ"
                     f"é€»è¾‘è¿è´¯æ€§: {analysis.logic_score}/10",
            confidence=0.88,
            metadata={
                "structure_analysis": analysis,
                "writing_tips": suggestions.tips,
                "style_recommendations": suggestions.style
            }
        )
```

### 1.2 å¢å¼ºAgentä¸Šä¸‹æ–‡æ„ŸçŸ¥

```python
# backend/app/agents/base_agent.py (æ‰©å±•)
@dataclass
class EnhancedAgentContext:
    """å¢å¼ºç‰ˆAgentä¸Šä¸‹æ–‡ - åŒ…å«å®Œæ•´å­¦ä¹ æ•°æ®"""
    
    user_id: str
    session_id: str
    user_query: str
    conversation_history: List[Dict[str, Any]]
    
    # å­¦ä¹ æ•°æ®
    knowledge_map: Optional[KnowledgeGraph] = None
    mastery_levels: Optional[Dict[str, float]] = None
    forgetting_curve: Optional[Dict[str, Any]] = None
    
    # ä»»åŠ¡ä¸Šä¸‹æ–‡
    current_tasks: Optional[List[Dict[str, Any]]] = None
    exam_schedule: Optional[Dict[str, Any]] = None
    
    # è¡Œä¸ºåˆ†æ
    learning_patterns: Optional[Dict[str, Any]] = None
    common_mistakes: Optional[List[str]] = None
    
    # å‰åºAgentè¾“å‡º
    previous_agent_outputs: Optional[List[AgentResponse]] = None


class EnhancedBaseAgent(BaseAgent):
    """å¢å¼ºç‰ˆåŸºç±» - æ”¯æŒæ·±åº¦ä¸Šä¸‹æ–‡è®¿é—®"""
    
    def __init__(self):
        super().__init__()
        self.knowledge_service = None
        self.user_service = None
    
    async def get_enhanced_context(self, context: AgentContext) -> EnhancedAgentContext:
        """è·å–å¢å¼ºä¸Šä¸‹æ–‡"""
        if not self.knowledge_service:
            from app.services.knowledge_service import KnowledgeService
            from app.services.user_service import UserService
            self.knowledge_service = KnowledgeService()
            self.user_service = UserService()
        
        # å¹¶è¡Œè·å–æ•°æ®
        knowledge_map, mastery_levels, forgetting_curve = await asyncio.gather(
            self.knowledge_service.get_user_knowledge_graph(context.user_id),
            self.user_service.get_mastery_levels(context.user_id),
            self.user_service.get_forgetting_curve(context.user_id)
        )
        
        return EnhancedAgentContext(
            user_id=context.user_id,
            session_id=context.session_id,
            user_query=context.user_query,
            conversation_history=context.conversation_history,
            knowledge_map=knowledge_map,
            mastery_levels=mastery_levels,
            forgetting_curve=forgetting_curve,
            current_tasks=await self.user_service.get_current_tasks(context.user_id),
            exam_schedule=await self.user_service.get_exam_schedule(context.user_id),
            learning_patterns=await self.user_service.get_learning_patterns(context.user_id),
            common_mistakes=await self.user_service.get_common_mistakes(context.user_id),
            previous_agent_outputs=context.previous_agent_outputs
        )
```

---

## ğŸ¤ é˜¶æ®µäºŒï¼šæ™ºèƒ½åä½œæµç¨‹

### 2.1 é«˜çº§åä½œæ¨¡å¼å®ç°

#### æ¨¡å¼Aï¼šä»»åŠ¡åˆ†è§£åä½œ

```python
# backend/app/agents/collaboration_workflow.py
class TaskDecompositionWorkflow:
    """ä»»åŠ¡åˆ†è§£åä½œæ¨¡å¼"""
    
    def __init__(self, orchestrator):
        self.orchestrator = orchestrator
    
    async def execute(self, query: str, context: EnhancedAgentContext) -> CollaborationResult:
        """
        æ‰§è¡Œä»»åŠ¡åˆ†è§£åä½œ
        ä¾‹å¦‚: "å¸®æˆ‘å‡†å¤‡ä¸‹å‘¨çš„æœºå™¨å­¦ä¹ è€ƒè¯•"
        """
        
        # Step 1: StudyPlannerAgentåˆ†ææ•´ä½“æƒ…å†µ
        planner_response = await self.orchestrator.specialist_agents[0].process(context)
        
        # Step 2: æå–å…³é”®ä¿¡æ¯
        plan_metadata = planner_response.metadata.get("plan", {})
        timeline = plan_metadata.get("timeline", {})
        key_topics = plan_metadata.get("key_topics", [])
        
        # Step 3: å¹¶è¡Œè°ƒç”¨ä¸“ä¸šAgent
        tasks = []
        
        # æ•°å­¦ä¸“å®¶ï¼šç”Ÿæˆæ¦‚å¿µé¢˜
        math_context = EnhancedAgentContext(
            **{**context.__dict__, 
               "user_query": f"ç”Ÿæˆå…³äº{key_topics}çš„10é“æ ¸å¿ƒæ¦‚å¿µé¢˜"}
        )
        tasks.append(
            self.orchestrator.specialist_agents[1].process(math_context)
        )
        
        # ç¼–ç¨‹ä¸“å®¶ï¼šå‡†å¤‡å®æˆ˜é¡¹ç›®
        code_context = EnhancedAgentContext(
            **{**context.__dict__,
               "user_query": f"ä¸º{key_topics}è®¾è®¡3ä¸ªç¼–ç¨‹å®æˆ˜é¡¹ç›®"}
        )
        tasks.append(
            self.orchestrator.specialist_agents[2].process(code_context)
        )
        
        # å†™ä½œä¸“å®¶ï¼šåˆ›å»ºæ€»ç»“æ¨¡æ¿
        writing_context = EnhancedAgentContext(
            **{**context.__dict__,
               "user_query": f"ä¸º{key_topics}åˆ›å»ºçŸ¥è¯†ç‚¹æ€»ç»“æ¨¡æ¿"}
        )
        tasks.append(
            self.orchestrator.specialist_agents[3].process(writing_context)
        )
        
        # Step 4: å¹¶è¡Œæ‰§è¡Œ
        results = await asyncio.gather(*tasks)
        
        # Step 5: æ•´åˆç”Ÿæˆå®Œæ•´è®¡åˆ’
        integrated_plan = await self._integrate_plan(
            planner_response,
            results,
            timeline
        )
        
        return CollaborationResult(
            workflow_type="task_decomposition",
            participants=[agent.name for agent in self.orchestrator.specialist_agents],
            outputs=results,
            final_response=integrated_plan,
            metadata={
                "timeline": timeline,
                "key_topics": key_topics,
                "total_tasks": len(integrated_plan.tasks)
            }
        )
```

#### æ¨¡å¼Bï¼šæ¸è¿›å¼æ·±åº¦æ¢ç´¢

```python
class ProgressiveExplorationWorkflow:
    """æ¸è¿›å¼æ·±åº¦æ¢ç´¢æ¨¡å¼"""
    
    async def execute(self, query: str, context: EnhancedAgentContext) -> CollaborationResult:
        """
        æ‰§è¡Œæ¸è¿›å¼æ¢ç´¢
        ä¾‹å¦‚: "è§£é‡Šç¥ç»ç½‘ç»œçš„åå‘ä¼ æ’­"
        """
        
        conversation_history = []
        
        # Round 1: MathAgent - æ•°å­¦æ¨å¯¼
        math_response = await self.orchestrator.specialist_agents[1].process(context)
        conversation_history.append({
            "agent": "MathExpert",
            "content": math_response.response_text,
            "reasoning": math_response.reasoning
        })
        
        # Round 2: CodeAgent - ä»£ç å®ç°
        code_context = EnhancedAgentContext(
            **{**context.__dict__,
               "previous_agent_outputs": [math_response],
               "user_query": "åŸºäºä¸Šè¿°æ•°å­¦æ¨å¯¼ï¼Œæä¾›PyTorchä»£ç å®ç°"}
        )
        code_response = await self.orchestrator.specialist_agents[2].process(code_context)
        conversation_history.append({
            "agent": "CodeExpert",
            "content": code_response.response_text,
            "reasoning": code_response.reasoning
        })
        
        # Round 3: ScienceAgent - ç”Ÿç‰©å­¦ç±»æ¯”
        science_context = EnhancedAgentContext(
            **{**context.__dict__,
               "previous_agent_outputs": [math_response, code_response],
               "user_query": "ç”¨ç”Ÿç‰©å­¦æ¦‚å¿µç±»æ¯”è§£é‡Šåå‘ä¼ æ’­"}
        )
        science_response = await self.orchestrator.specialist_agents[4].process(science_context)
        conversation_history.append({
            "agent": "ScienceExpert",
            "content": science_response.response_text,
            "reasoning": science_response.reasoning
        })
        
        # Round 4: WritingAgent - å­¦ä¹ ç¬”è®°
        writing_context = EnhancedAgentContext(
            **{**context.__dict__,
               "previous_agent_outputs": [math_response, code_response, science_response],
               "user_query": "åŸºäºä»¥ä¸Šè§£é‡Šï¼Œç”Ÿæˆå­¦ä¹ ç¬”è®°å’Œè®°å¿†æŠ€å·§"}
        )
        writing_response = await self.orchestrator.specialist_agents[3].process(writing_context)
        
        # Round 5: StudyPlannerAgent - å¤ä¹ å®‰æ’
        planner_context = EnhancedAgentContext(
            **{**context.__dict__,
               "user_query": "ä¸ºè¿™ä¸ªçŸ¥è¯†ç‚¹å®‰æ’å¤ä¹ æ—¶é—´"}
        )
        planner_response = await self.orchestrator.specialist_agents[0].process(planner_context)
        
        return CollaborationResult(
            workflow_type="progressive_exploration",
            participants=["MathExpert", "CodeExpert", "ScienceExpert", "WritingExpert", "StudyPlanner"],
            outputs=[math_response, code_response, science_response, writing_response, planner_response],
            final_response=self._format_exploration_summary(conversation_history, planner_response),
            metadata={
                "exploration_depth": 5,
                "perspectives": len(conversation_history)
            }
        )
```

#### æ¨¡å¼Cï¼šé”™é¢˜è¯Šæ–­å¾ªç¯

```python
class ErrorDiagnosisWorkflow:
    """é”™é¢˜è¯Šæ–­åä½œæ¨¡å¼"""
    
    async def execute(self, query: str, context: EnhancedAgentContext) -> CollaborationResult:
        """
        æ‰§è¡Œé”™é¢˜è¯Šæ–­
        ä¾‹å¦‚: ç”¨æˆ·æäº¤ä¸€é“åšé”™çš„å¾®ç§¯åˆ†é¢˜
        """
        
        # Step 1: ProblemSolverAgentåˆ†æé”™è¯¯æ¨¡å¼
        solver_context = EnhancedAgentContext(
            **{**context.__dict__,
               "user_query": f"åˆ†æè¿™é“é¢˜çš„é”™è¯¯æ¨¡å¼: {query}"}
        )
        solver_response = await self.orchestrator.specialist_agents[1].process(solver_context)
        
        # Step 2: è¯†åˆ«è–„å¼±çŸ¥è¯†ç‚¹
        weak_points = solver_response.metadata.get("identified_weak_points", [])
        
        # Step 3: KnowledgeServiceå…³è”çŸ¥è¯†å›¾è°±
        from app.services.graph_knowledge_service import GraphKnowledgeService
        graph_service = GraphKnowledgeService()
        
        related_concepts = await graph_service.get_related_concepts(
            context.user_id,
            weak_points,
            depth=2
        )
        
        # Step 4: StudyPlannerAgentå®‰æ’é’ˆå¯¹æ€§å¤ä¹ 
        planner_context = EnhancedAgentContext(
            **{**context.__dict__,
               "user_query": f"ä¸ºè–„å¼±çŸ¥è¯†ç‚¹ {weak_points} å®‰æ’é’ˆå¯¹æ€§å¤ä¹ "}
        )
        planner_response = await self.orchestrator.specialist_agents[0].process(planner_context)
        
        # Step 5: Code/WritingAgentç”Ÿæˆç±»ä¼¼ç»ƒä¹ é¢˜
        practice_context = EnhancedAgentContext(
            **{**context.__dict__,
               "user_query": f"ç”Ÿæˆå…³äº {weak_points} çš„ç±»ä¼¼ç»ƒä¹ é¢˜"}
        )
        practice_response = await self.orchestrator.specialist_agents[2].process(practice_context)
        
        return CollaborationResult(
            workflow_type="error_diagnosis",
            participants=["ProblemSolver", "StudyPlanner", "PracticeGenerator"],
            outputs=[solver_response, planner_response, practice_response],
            final_response=self._format_diagnosis_report(
                solver_response,
                planner_response,
                practice_response,
                related_concepts
            ),
            metadata={
                "error_pattern": solver_response.metadata.get("error_pattern"),
                "weak_points": weak_points,
                "related_concepts": related_concepts,
                "practice_generated": True
            }
        )
```

### 2.2 Agenté—´å¯¹è¯æœºåˆ¶

```python
# backend/app/agents/orchestrator_agent.py (æ‰©å±•)
class EnhancedOrchestratorAgent(BaseAgent):
    """å¢å¼ºç‰ˆåè°ƒå™¨ - æ”¯æŒAgenté—´å¯¹è¯"""
    
    def __init__(self):
        super().__init__()
        self.specialist_agents = [
            StudyPlannerAgent(),
            ProblemSolverAgent(),
            CodeReviewAgent(),
            EssayCoachAgent(),
            # ä¿ç•™åŸæœ‰Agentä½œä¸ºfallback
            MathAgent(),
            WritingAgent(),
            ScienceAgent()
        ]
        self.collaboration_workflows = {
            "task_decomposition": TaskDecompositionWorkflow(self),
            "progressive_exploration": ProgressiveExplorationWorkflow(self),
            "error_diagnosis": ErrorDiagnosisWorkflow(self)
        }
    
    async def process(self, context: AgentContext) -> AgentResponse:
        """å¢å¼ºç‰ˆå¤„ç†æµç¨‹"""
        
        # 1. åˆ†ææŸ¥è¯¢ï¼Œé€‰æ‹©åä½œæ¨¡å¼
        workflow_type = await self._select_workflow_type(context.user_query)
        
        # 2. æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡
        enhanced_context = await self._build_enhanced_context(context)
        
        # 3. æ‰§è¡Œåä½œæµç¨‹
        if workflow_type in self.collaboration_workflows:
            result = await self.collaboration_workflows[workflow_type].execute(
                context.user_query,
                enhanced_context
            )
            return self._format_collaboration_response(result)
        else:
            # é™çº§åˆ°åŸæœ‰è·¯ç”±é€»è¾‘
            return await self._fallback_routing(context)
    
    async def _select_workflow_type(self, query: str) -> str:
        """æ™ºèƒ½é€‰æ‹©åä½œæ¨¡å¼"""
        
        # åŸºäºå…³é”®è¯å’Œæ„å›¾åˆ†æ
        patterns = {
            "task_decomposition": ["å‡†å¤‡", "è®¡åˆ’", "å¤ä¹ ", "è€ƒè¯•", "å†²åˆº", "å­¦ä¹ "],
            "progressive_exploration": ["è§£é‡Š", "ç†è§£", "è¯´æ˜", "å¦‚ä½•", "ä¸ºä»€ä¹ˆ"],
            "error_diagnosis": ["é”™é¢˜", "é”™è¯¯", "ä¸æ‡‚", "ä¸æ˜ç™½", "åšé”™äº†"]
        }
        
        scores = {}
        for workflow, keywords in patterns.items():
            scores[workflow] = sum(1 for kw in keywords if kw in query)
        
        # é€‰æ‹©æœ€é«˜åˆ†ï¼Œä½†éœ€è¦è¾¾åˆ°é˜ˆå€¼
        best_workflow = max(scores, key=scores.get)
        if scores[best_workflow] >= 2:
            return best_workflow
        
        return "default"
    
    def _format_collaboration_response(self, result: CollaborationResult) -> AgentResponse:
        """æ ¼å¼åŒ–åä½œç»“æœ"""
        
        # æ„å»ºå¯è§†åŒ–æ•°æ®
        visualization_data = {
            "workflow_type": result.workflow_type,
            "participants": result.participants,
            "steps": len(result.outputs),
            "metadata": result.metadata
        }
        
        # ç”Ÿæˆç»Ÿä¸€å“åº”
        unified_text = self._compose_unified_response(result)
        
        return AgentResponse(
            agent_role=self.role.value,
            agent_name="å¤šä¸“å®¶åä½œå›¢é˜Ÿ",
            response_text=unified_text,
            reasoning=f"é‡‡ç”¨{result.workflow_type}æ¨¡å¼ï¼Œ{len(result.participants)}ä½ä¸“å®¶å‚ä¸",
            confidence=0.9,
            metadata={
                "collaboration": True,
                "workflow": result.workflow_type,
                "participants": result.participants,
                "outputs": [o.__dict__ for o in result.outputs],
                "visualization": visualization_data
            }
        )
```

---

## ğŸ¨ é˜¶æ®µä¸‰ï¼šå¯è§†åŒ–ä½“éªŒå‡çº§

### 3.1 æ–°å¢ç§»åŠ¨ç«¯ç»„ä»¶

#### Agentåä½œæ—¶é—´çº¿

```dart
// mobile/lib/presentation/widgets/chat/agent_collaboration_timeline.dart
import 'package:flutter/material.dart';
import 'package:flutter_animate/flutter_animate.dart';

class AgentCollaborationTimeline extends StatefulWidget {
  final List<AgentStep> steps;
  final String workflowType;
  
  const AgentCollaborationTimeline({
    super.key,
    required this.steps,
    required this.workflowType,
  });

  @override
  State<AgentCollaborationTimeline> createState() => _AgentCollaborationTimelineState();
}

class _AgentCollaborationTimelineState extends State<AgentCollaborationTimeline> 
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  
  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: Duration(milliseconds: 500 * widget.steps.length),
    )..forward();
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            Colors.blue.shade50,
            Colors.purple.shade50,
          ],
        ),
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // æ ‡é¢˜æ 
          Row(
            children: [
              Icon(Icons.timeline, color: Colors.purple.shade700),
              const SizedBox(width: 8),
              Text(
                'åä½œæ—¶é—´çº¿',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: Colors.purple.shade700,
                ),
              ),
              const Spacer(),
              Chip(
                label: Text(widget.workflowType),
                backgroundColor: Colors.purple.shade100,
                labelStyle: TextStyle(
                  color: Colors.purple.shade700,
                  fontSize: 11,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          
          // æ—¶é—´çº¿
          ...widget.steps.asMap().entries.map((entry) {
            final index = entry.key;
            final step = entry.value;
            final isLast = index == widget.steps.length - 1;
            
            return AnimatedBuilder(
              animation: _controller,
              builder: (context, child) {
                final progress = (_controller.value * widget.steps.length - index)
                    .clamp(0.0, 1.0);
                
                return Opacity(
                  opacity: progress,
                  child: Transform.translate(
                    offset: Offset(0, (1 - progress) * 20),
                    child: child,
                  ),
                );
              },
              child: Container(
                margin: EdgeInsets.only(bottom: isLast ? 0 : 16),
                child: Row(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // æ—¶é—´ç‚¹
                    Container(
                      width: 32,
                      height: 32,
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        color: step.agentColor,
                        border: Border.all(color: Colors.white, width: 2),
                        boxShadow: [
                          BoxShadow(
                            color: step.agentColor.withOpacity(0.3),
                            blurRadius: 8,
                          ),
                        ],
                      ),
                      child: Icon(
                        step.agentIcon,
                        color: Colors.white,
                        size: 16,
                      ),
                    ).animate()
                        .scale(duration: 300.ms, curve: Curves.easeOut)
                        .then()
                        .animate(onPlay: (controller) => controller.repeat())
                        .shimmer(duration: 2.seconds, color: Colors.white24),
                    
                    const SizedBox(width: 12),
                    
                    // æ­¥éª¤å†…å®¹
                    Expanded(
                      child: Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.white,
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(
                            color: step.agentColor.withOpacity(0.3),
                          ),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withOpacity(0.05),
                              blurRadius: 4,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Text(
                                  step.agentName,
                                  style: TextStyle(
                                    fontWeight: FontWeight.bold,
                                    color: step.agentColor,
                                  ),
                                ),
                                const SizedBox(width: 8),
                                if (step.confidence != null)
                                  Container(
                                    padding: const EdgeInsets.symmetric(
                                      horizontal: 6,
                                      vertical: 2,
                                    ),
                                    decoration: BoxDecoration(
                                      color: step.agentColor.withOpacity(0.1),
                                      borderRadius: BorderRadius.circular(4),
                                    ),
                                    child: Text(
                                      '${(step.confidence! * 100).toStringAsFixed(0)}%',
                                      style: TextStyle(
                                        fontSize: 11,
                                        color: step.agentColor,
                                        fontWeight: FontWeight.w600,
                                      ),
                                    ),
                                  ),
                              ],
                            ),
                            const SizedBox(height: 6),
                            Text(
                              step.summary,
                              style: TextStyle(
                                fontSize: 13,
                                color: Colors.grey.shade700,
                              ),
                            ),
                            if (step.canExpand && step.details != null)
                              Padding(
                                padding: const EdgeInsets.only(top: 8),
                                child: ExpandableDetails(
                                  details: step.details!,
                                  agentColor: step.agentColor,
                                ),
                              ),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            );
          }).toList(),
        ],
      ),
    );
  }
}

// æ•°æ®æ¨¡å‹
class AgentStep {
  final String agentName;
  final String agentType;
  final IconData agentIcon;
  final Color agentColor;
  final String summary;
  final String? details;
  final double? confidence;
  final bool canExpand;
  
  AgentStep({
    required this.agentName,
    required this.agentType,
    required this.agentIcon,
    required this.agentColor,
    required this.summary,
    this.details,
    this.confidence,
    this.canExpand = true,
  });
}

// å¯å±•å¼€è¯¦æƒ…ç»„ä»¶
class ExpandableDetails extends StatefulWidget {
  final String details;
  final Color agentColor;
  
  const ExpandableDetails({
    super.key,
    required this.details,
    required this.agentColor,
  });

  @override
  State<ExpandableDetails> createState() => _ExpandableDetailsState();
}

class _ExpandableDetailsState extends State<ExpandableDetails> {
  bool _expanded = false;
  
  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        InkWell(
          onTap: () => setState(() => _expanded = !_expanded),
          child: Row(
            children: [
              Icon(
                _expanded ? Icons.keyboard_arrow_up : Icons.keyboard_arrow_down,
                size: 16,
                color: widget.agentColor,
              ),
              const SizedBox(width: 4),
              Text(
                _expanded ? 'æ”¶èµ·è¯¦æƒ…' : 'æŸ¥çœ‹æ¨ç†è¿‡ç¨‹',
                style: TextStyle(
                  fontSize: 12,
                  color: widget.agentColor,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
        ),
        if (_expanded)
          Container(
            margin: const EdgeInsets.only(top: 8),
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: widget.agentColor.withOpacity(0.05),
              borderRadius: BorderRadius.circular(6),
              border: Border.all(color: widget.agentColor.withOpacity(0.2)),
            ),
            child: Text(
              widget.details,
              style: TextStyle(
                fontSize: 12,
                color: Colors.grey.shade700,
                fontStyle: FontStyle.italic,
              ),
            ),
          ).animate()
              .slide(begin: const Offset(0, -0.2), duration: 200.ms)
              .fadeIn(duration: 200.ms),
      ],
    );
  }
}
```

#### æ€ç»´å¯¼å›¾ç”Ÿæˆå™¨

```dart
// mobile/lib/presentation/widgets/chat/mindmap_viewer.dart
import 'package:flutter/material.dart';
import 'package:graphview/graphview.dart';

class MindMapViewer extends StatefulWidget {
  final MindMapData data;
  
  const MindMapViewer({super.key, required this.data});

  @override
  State<MindMapViewer> createState() => _MindMapViewerState();
}

class _MindMapViewerState extends State<MindMapViewer> {
  final Graph _graph = Graph();
  final BuchheimWalkerConfiguration _builder = BuchheimWalkerConfiguration();
  
  @override
  void initState() {
    super.initState();
    _buildGraph();
    _configureLayout();
  }
  
  void _buildGraph() {
    // æ·»åŠ ä¸­å¿ƒèŠ‚ç‚¹
    final center = Node.Id(widget.data.centerTopic);
    _graph.addNode(center);
    
    // æ·»åŠ åˆ†æ”¯èŠ‚ç‚¹
    for (var branch in widget.data.branches) {
      final branchNode = Node.Id(branch.title);
      _graph.addEdge(center, branchNode);
      
      // æ·»åŠ å­èŠ‚ç‚¹
      for (var subtopic in branch.subtopics) {
        final subNode = Node.Id(subtopic);
        _graph.addEdge(branchNode, subNode);
      }
    }
  }
  
  void _configureLayout() {
    _builder
      ..siblingSeparation = 40
      ..levelSeparation = 80
      ..subtreeSeparation = 60
      ..orientation = BuchheimWalkerConfiguration.ORIENTATION_LEFT_RIGHT;
  }
  
  @override
  Widget build(BuildContext context) {
    return Container(
      height: 400,
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [Colors.blue.shade50, Colors.purple.shade50],
        ),
        borderRadius: BorderRadius.circular(12),
      ),
      child: InteractiveViewer(
        constrained: false,
        boundaryMargin: const EdgeInsets.all(100),
        minScale: 0.1,
        maxScale: 5.0,
        child: GraphView(
          graph: _graph,
          algorithm: BuchheimWalkerAlgorithm(
            _builder,
            TreeEdgeRenderer(_builder),
          ),
          builder: (Node node) {
            final data = node.key!.value as String;
            final isCenter = data == widget.data.centerTopic;
            
            return Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: isCenter ? Colors.purple.shade600 : Colors.white,
                borderRadius: BorderRadius.circular(20),
                border: Border.all(
                  color: isCenter ? Colors.purple.shade700 : Colors.purple.shade300,
                  width: 2,
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.1),
                    blurRadius: 4,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: Text(
                data,
                style: TextStyle(
                  color: isCenter ? Colors.white : Colors.purple.shade700,
                  fontWeight: isCenter ? FontWeight.bold : FontWeight.w600,
                  fontSize: isCenter ? 14 : 12,
                ),
              ),
            );
          },
        ),
      ),
    );
  }
}

// æ•°æ®æ¨¡å‹
class MindMapData {
  final String centerTopic;
  final List<Branch> branches;
  
  MindMapData({required this.centerTopic, required this.branches});
  
  factory MindMapData.fromCollaborationResult(CollaborationResult result) {
    // ä»åä½œç»“æœç”Ÿæˆæ€ç»´å¯¼å›¾æ•°æ®
    return MindMapData(
      centerTopic: result.metadata['main_topic'] ?? 'æ ¸å¿ƒæ¦‚å¿µ',
      branches: result.outputs.map((output) {
        return Branch(
          title: output.agentName,
          subtopics: output.metadata['related_concepts'] ?? [],
        );
      }).toList(),
    );
  }
}

class Branch {
  final String title;
  final List<String> subtopics;
  
  Branch({required this.title, required this.subtopics});
}
```

#### å­¦ä¹ è¿›åº¦é¢æ¿

```dart
// mobile/lib/presentation/widgets/chat/learning_progress_panel.dart
import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';

class LearningProgressPanel extends StatefulWidget {
  final LearningProgressData data;
  
  const LearningProgressPanel({super.key, required this.data});

  @override
  State<LearningProgressPanel> createState() => _LearningProgressPanelState();
}

class _LearningProgressPanelState extends State<LearningProgressPanel> {
  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 8,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // æ ‡é¢˜
          Row(
            children: [
              Icon(Icons.analytics, color: Colors.green.shade700),
              const SizedBox(width: 8),
              Text(
                'å­¦ä¹ è¿›åº¦è¿½è¸ª',
                style: TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                  color: Colors.green.shade700,
                ),
              ),
            ],
          ),
          const SizedBox(height: 16),
          
          // æŒæ¡åº¦å›¾è¡¨
          _buildMasteryChart(),
          const SizedBox(height: 16),
          
          // é—å¿˜æ›²çº¿
          _buildForgettingCurve(),
          const SizedBox(height: 16),
          
          // å¤ä¹ å»ºè®®
          _buildReviewSuggestions(),
        ],
      ),
    );
  }
  
  Widget _buildMasteryChart() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'çŸ¥è¯†ç‚¹æŒæ¡åº¦',
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: Colors.grey.shade700,
          ),
        ),
        const SizedBox(height: 8),
        SizedBox(
          height: 120,
          child: BarChart(
            BarChartData(
              alignment: BarChartAlignment.spaceAround,
              maxY: 100,
              barTouchData: BarTouchData(enabled: true),
              titlesData: FlTitlesData(
                bottomTitles: AxisTitles(
                  sideTitles: SideTitles(
                    showTitles: true,
                    getTitlesWidget: (value, meta) {
                      if (value.toInt() < widget.data.masteryLevels.length) {
                        return Text(
                          widget.data.masteryLevels[value.toInt()].concept,
                          style: const TextStyle(fontSize: 10),
                        );
                      }
                      return const Text('');
                    },
                  ),
                ),
                leftTitles: AxisTitles(
                  sideTitles: SideTitles(
                    showTitles: true,
                    interval: 20,
                    getTitlesWidget: (value, meta) => Text('${value.toInt()}%'),
                  ),
                ),
                topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
                rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
              ),
              gridData: const FlGridData(show: true, drawVerticalLine: false),
              borderData: FlBorderData(show: false),
              barGroups: widget.data.masteryLevels.asMap().entries.map((entry) {
                final color = _getMasteryColor(entry.value.level);
                return BarChartGroupData(
                  x: entry.key,
                  barRods: [
                    BarChartRodData(
                      toY: entry.value.level * 100,
                      color: color,
                      width: 16,
                      borderRadius: BorderRadius.circular(4),
                    ),
                  ],
                );
              }).toList(),
            ),
          ),
        ),
      ],
    );
  }
  
  Widget _buildForgettingCurve() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'é—å¿˜æ›²çº¿é¢„æµ‹',
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: Colors.grey.shade700,
          ),
        ),
        const SizedBox(height: 8),
        SizedBox(
          height: 100,
          child: LineChart(
            LineChartData(
              lineTouchData: LineTouchData(enabled: true),
              gridData: const FlGridData(show: true, drawVerticalLine: false),
              titlesData: FlTitlesData(
                bottomTitles: AxisTitles(
                  sideTitles: SideTitles(
                    showTitles: true,
                    getTitlesWidget: (value, meta) {
                      final days = ['ä»Š', 'æ˜', '3å¤©', '7å¤©', '14å¤©'];
                      return Text(days[value.toInt() % days.length]);
                    },
                  ),
                ),
                leftTitles: AxisTitles(
                  sideTitles: SideTitles(
                    showTitles: true,
                    interval: 25,
                    getTitlesWidget: (value, meta) => Text('${value.toInt()}%'),
                  ),
                ),
                topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
                rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
              ),
              borderData: FlBorderData(show: false),
              lineBarsData: [
                LineChartBarData(
                  spots: widget.data.forgettingCurve
                      .asMap()
                      .entries
                      .map((entry) => FlSpot(entry.key.toDouble(), entry.value))
                      .toList(),
                  isCurved: true,
                  color: Colors.orange.shade600,
                  barWidth: 3,
                  isStrokeCapRound: true,
                  dotData: const FlDotData(show: true),
                  belowBarData: BarAreaData(
                    show: true,
                    color: Colors.orange.shade100.withOpacity(0.3),
                  ),
                ),
              ],
            ),
          ),
        ),
      ],
    );
  }
  
  Widget _buildReviewSuggestions() {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.green.shade50,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.green.shade200),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.lightbulb_outline, color: Colors.green.shade700, size: 18),
              const SizedBox(width: 6),
              Text(
                'å¤ä¹ å»ºè®®',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.green.shade700,
                ),
              ),
            ],
          ),
          const SizedBox(height: 8),
          ...widget.data.reviewSuggestions.map((suggestion) {
            return Padding(
              padding: const EdgeInsets.only(bottom: 4),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('â€¢ ', style: TextStyle(fontWeight: FontWeight.bold)),
                  Expanded(
                    child: Text(
                      suggestion,
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.green.shade800,
                      ),
                    ),
                  ),
                ],
              ),
            );
          }),
        ],
      ),
    );
  }
  
  Color _getMasteryColor(double level) {
    if (level >= 0.8) return Colors.green.shade600;
    if (level >= 0.6) return Colors.blue.shade600;
    if (level >= 0.4) return Colors.orange.shade600;
    return Colors.red.shade600;
  }
}

// æ•°æ®æ¨¡å‹
class LearningProgressData {
  final List<MasteryLevel> masteryLevels;
  final List<double> forgettingCurve;
  final List<String> reviewSuggestions;
  
  LearningProgressData({
    required this.masteryLevels,
    required this.forgettingCurve,
    required this.reviewSuggestions,
  });
  
  factory LearningProgressData.fromCollaborationResult(CollaborationResult result) {
    return LearningProgressData(
      masteryLevels: result.metadata['mastery_levels'] ?? [],
      forgettingCurve: result.metadata['forgetting_curve'] ?? [],
      reviewSuggestions: result.metadata['review_suggestions'] ?? [],
    );
  }
}

class MasteryLevel {
  final String concept;
  final double level;
  
  MasteryLevel({required this.concept, required this.level});
}
```

### 3.2 äº¤äº’å¼å­¦ä¹ æ¨¡å¼åˆ‡æ¢å™¨

```dart
// mobile/lib/presentation/widgets/chat/learning_mode_switcher.dart
import 'package:flutter/material.dart';

enum LearningMode {
  socratic,    // è‹æ ¼æ‹‰åº•æ¨¡å¼ - å¼•å¯¼å¼æé—®
  collaborative, // åä½œæ¨¡å¼ - å¤šè§†è§’
  tutor,       // å¯¼å¸ˆæ¨¡å¼ - æ·±åº¦è·Ÿè¸ª
}

class LearningModeSwitcher extends StatefulWidget {
  final LearningMode currentMode;
  final ValueChanged<LearningMode> onModeChanged;
  
  const LearningModeSwitcher({
    super.key,
    required this.currentMode,
    required this.onModeChanged,
  });

  @override
  State<LearningModeSwitcher> createState() => _LearningModeSwitcherState();
}

class _LearningModeSwitcherState extends State<LearningModeSwitcher> {
  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: Colors.grey.shade100,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Row(
        children: [
          _buildModeButton(
            mode: LearningMode.socratic,
            icon: Icons.question_answer,
            label: 'è‹æ ¼æ‹‰åº•',
            color: Colors.blue,
            description: 'å¼•å¯¼å¼æé—®',
          ),
          const SizedBox(width: 8),
          _buildModeButton(
            mode: LearningMode.collaborative,
            icon: Icons.groups,
            label: 'åä½œ',
            color: Colors.purple,
            description: 'å¤šä¸“å®¶',
          ),
          const SizedBox(width: 8),
          _buildModeButton(
            mode: LearningMode.tutor,
            icon: Icons.school,
            label: 'å¯¼å¸ˆ',
            color: Colors.green,
            description: 'æ·±åº¦è·Ÿè¸ª',
          ),
        ],
      ),
    );
  }
  
  Widget _buildModeButton({
    required LearningMode mode,
    required IconData icon,
    required String label,
    required Color color,
    required String description,
  }) {
    final isSelected = widget.currentMode == mode;
    
    return Expanded(
      child: Material(
        color: Colors.transparent,
        child: InkWell(
          onTap: () => widget.onModeChanged(mode),
          borderRadius: BorderRadius.circular(8),
          child: AnimatedContainer(
            duration: const Duration(milliseconds: 200),
            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 4),
            decoration: BoxDecoration(
              color: isSelected ? color.withOpacity(0.15) : Colors.white,
              borderRadius: BorderRadius.circular(8),
              border: Border.all(
                color: isSelected ? color : Colors.grey.shade300,
                width: isSelected ? 2 : 1,
              ),
            ),
            child: Column(
              children: [
                Icon(
                  icon,
                  color: isSelected ? color : Colors.grey,
                  size: 20,
                ),
                const SizedBox(height: 4),
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 11,
                    fontWeight: isSelected ? FontWeight.bold : FontWeight.w500,
                    color: isSelected ? color : Colors.grey,
                  ),
                ),
                if (isSelected) ...[
                  const SizedBox(height: 2),
                  Text(
                    description,
                    style: TextStyle(
                      fontSize: 9,
                      color: color.withOpacity(0.7),
                    ),
                    textAlign: TextAlign.center,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ],
            ),
          ),
        ),
      ),
    );
  }
}
```

---

## ğŸ“Š é˜¶æ®µå››ï¼šæ·±åº¦ä¸ªæ€§åŒ–é›†æˆ

### 4.1 çŸ¥è¯†æ˜Ÿå›¾æ·±åº¦é›†æˆ

```python
# backend/app/services/graph_enhanced_agent.py
from app.services.graph_knowledge_service import GraphKnowledgeService
from app.services.knowledge_service import KnowledgeService

class GraphEnhancedAgent:
    """æ”¯æŒçŸ¥è¯†å›¾è°±æŸ¥è¯¢çš„å¢å¼ºç‰ˆAgent"""
    
    def __init__(self):
        self.graph_service = GraphKnowledgeService()
        self.knowledge_service = KnowledgeService()
    
    async def retrieve_relevant_knowledge(
        self, 
        query: str, 
        user_id: str,
        depth: int = 2
    ) -> Dict[str, Any]:
        """
        ä½¿ç”¨GraphRAGæ£€ç´¢ç›¸å…³çŸ¥è¯†ç‚¹
        è¿”å›ç»“æ„åŒ–çš„çŸ¥è¯†ä¸Šä¸‹æ–‡
        """
        
        # 1. å‘é‡æœç´¢ï¼šè¯­ä¹‰ç›¸å…³å†…å®¹
        vector_results = await self.knowledge_service.semantic_search(
            query=query,
            user_id=user_id,
            top_k=5
        )
        
        # 2. å›¾éå†ï¼šå‰ç½®çŸ¥è¯†ã€å…³è”æ¦‚å¿µ
        graph_results = await self.graph_service.graph_rag_search(
            query=query,
            user_id=user_id,
            depth=depth,
            top_k=5
        )
        
        # 3. ä¸ªæ€§åŒ–ï¼šç”¨æˆ·è–„å¼±ç‚¹ä¼˜å…ˆ
        user_weak_points = await self._get_user_weak_points(user_id)
        
        # 4. æ™ºèƒ½èåˆ
        integrated = await self._integrate_knowledge(
            vector_results,
            graph_results,
            user_weak_points
        )
        
        return {
            "prerequisites": integrated.prerequisites,  # éœ€è¦å…ˆæŒæ¡çš„çŸ¥è¯†
            "related_concepts": integrated.related,     # å…³è”æ¦‚å¿µ
            "user_weak_points": integrated.weak_points, # ç”¨æˆ·è–„å¼±ç‚¹
            "learning_path": integrated.path,           # å»ºè®®å­¦ä¹ è·¯å¾„
            "confidence": integrated.confidence_score   # ç½®ä¿¡åº¦
        }
    
    async def _get_user_weak_points(self, user_id: str) -> List[str]:
        """è·å–ç”¨æˆ·è–„å¼±çŸ¥è¯†ç‚¹"""
        mastery = await self.knowledge_service.get_mastery_levels(user_id)
        return [k for k, v in mastery.items() if v < 0.6]
    
    async def _integrate_knowledge(
        self,
        vector_results: List[Dict],
        graph_results: Dict,
        weak_points: List[str]
    ) -> IntegratedKnowledge:
        """æ™ºèƒ½èåˆå¤šæºçŸ¥è¯†"""
        
        # ä¼˜å…ˆçº§æ’åºï¼šè–„å¼±ç‚¹ > ç›´æ¥ç›¸å…³ > å…³è”çŸ¥è¯†
        all_concepts = []
        
        # æ·»åŠ è–„å¼±ç‚¹
        for wp in weak_points:
            if wp in graph_results.get('related_concepts', []):
                all_concepts.append(('weak_point', wp, 1.0))
        
        # æ·»åŠ å‘é‡æœç´¢ç»“æœ
        for result in vector_results:
            all_concepts.append(('vector', result['concept'], result['score']))
        
        # æ·»åŠ å›¾æœç´¢ç»“æœ
        for concept in graph_results.get('related_concepts', []):
            all_concepts.append(('graph', concept, 0.8))
        
        # å»é‡å¹¶æ’åº
        unique_concepts = {}
        for type_, concept, score in all_concepts:
            if concept not in unique_concepts or score > unique_concepts[concept][1]:
                unique_concepts[concept] = (type_, score)
        
        sorted_concepts = sorted(
            unique_concepts.items(),
            key=lambda x: x[1][1],
            reverse=True
        )
        
        return IntegratedKnowledge(
            prerequisites=graph_results.get('prerequisites', []),
            related=[c for c, _ in sorted_concepts[:5]],
            weak_points=weak_points,
            path=self._generate_learning_path([c for c, _ in sorted_concepts]),
            confidence_score=0.9
        )
    
    def _generate_learning_path(self, concepts: List[str]) -> List[Dict]:
        """ç”Ÿæˆå­¦ä¹ è·¯å¾„"""
        return [
            {
                "concept": concept,
                "estimated_time": "30åˆ†é’Ÿ",
                "prerequisites": [],
                "practice_needed": True
            }
            for concept in concepts[:3]
        ]
```

### 4.2 å­¦ä¹ æ¨¡å¼è¯†åˆ«ä¸ä¼˜åŒ–

```python
# backend/app/services/learning_pattern_analyzer.py
from datetime import datetime, timedelta
from collections import defaultdict

class LearningPatternAnalyzer:
    """åˆ†æç”¨æˆ·å­¦ä¹ æ¨¡å¼ï¼Œä¼˜åŒ–Agentç­–ç•¥"""
    
    async def analyze_patterns(self, user_id: str) -> LearningProfile:
        """ç”Ÿæˆç”¨æˆ·å­¦ä¹ ç”»åƒ"""
        
        # 1. æ—¶é—´æ¨¡å¼åˆ†æ
        time_pattern = await self._analyze_time_pattern(user_id)
        
        # 2. å†…å®¹åå¥½åˆ†æ
        content_preference = await self._analyze_content_preference(user_id)
        
        # 3. å­¦ä¹ æ•ˆæœåˆ†æ
        retention_rate = await self._calculate_retention_rate(user_id)
        
        # 4. å¸¸è§å›°æƒ‘ç‚¹
        confusion_points = await self._identify_confusion_points(user_id)
        
        # 5. å­¦ä¹ é€Ÿåº¦
        progress_velocity = await self._calculate_progress_velocity(user_id)
        
        return LearningProfile(
            user_id=user_id,
            best_learning_time=time_pattern.best_time,
            preferred_style=content_preference.style,
            retention_rate=retention_rate,
            common_confusion=confusion_points,
            progress_velocity=progress_velocity,
            recommendations=self._generate_recommendations(
                time_pattern,
                content_preference,
                retention_rate,
                confusion_points,
                progress_velocity
            )
        )
    
    async def _analyze_time_pattern(self, user_id: str) -> TimePattern:
        """åˆ†ææœ€ä½³å­¦ä¹ æ—¶æ®µ"""
        
        # ä»æ•°æ®åº“è·å–å­¦ä¹ è®°å½•
        sessions = await self._get_learning_sessions(user_id)
        
        # æŒ‰å°æ—¶ç»Ÿè®¡æˆåŠŸç‡å’Œä¸“æ³¨åº¦
        hourly_stats = defaultdict(list)
        for session in sessions:
            hour = session.start_time.hour
            hourly_stats[hour].append({
                'duration': session.duration,
                'completion_rate': session.completion_rate,
                'engagement': session.engagement_score
            })
        
        # æ‰¾å‡ºæœ€ä½³æ—¶æ®µ
        best_hour = max(
            hourly_stats.keys(),
            key=lambda h: sum(s['engagement'] for s in hourly_stats[h]) / len(hourly_stats[h])
        )
        
        return TimePattern(
            best_time=f"{best_hour}:00-{best_hour+1}:00",
            confidence=0.85
        )
    
    async def _analyze_content_preference(self, user_id: str) -> ContentPreference:
        """åˆ†æå†…å®¹åå¥½"""
        
        # ç»Ÿè®¡ä¸åŒAgentçš„äº¤äº’é¢‘ç‡å’Œæ»¡æ„åº¦
        agent_stats = await self._get_agent_interaction_stats(user_id)
        
        # è¯†åˆ«åå¥½æ¨¡å¼
        if agent_stats.get('CodeReviewAgent', {}).get('count', 0) > 10:
            style = "hands_on"  # åŠ¨æ‰‹å‹
        elif agent_stats.get('ProblemSolverAgent', {}).get('count', 0) > 10:
            style = "analytical"  # åˆ†æå‹
        else:
            style = "visual"  # è§†è§‰å‹
        
        return ContentPreference(style=style)
    
    async def _calculate_retention_rate(self, user_id: str) -> float:
        """è®¡ç®—çŸ¥è¯†ä¿ç•™ç‡"""
        
        # è·å–å¤ä¹ è®°å½•
        reviews = await self._get_review_history(user_id)
        
        if not reviews:
            return 0.75  # é»˜è®¤å€¼
        
        # è®¡ç®—é—å¿˜æ›²çº¿æ‹Ÿåˆåº¦
        retention_scores = []
        for review in reviews:
            days_since = (datetime.now() - review.first_seen).days
            expected_retention = self._forgetting_curve(days_since)
            actual_retention = review.current_mastery
            
            # æ¯”è¾ƒé¢„æœŸå’Œå®é™…
            score = 1 - abs(expected_retention - actual_retention)
            retention_scores.append(score)
        
        return sum(retention_scores) / len(retention_scores)
    
    def _forgetting_curve(self, days: int) -> float:
        """è‰¾å®¾æµ©æ–¯é—å¿˜æ›²çº¿"""
        # ç®€åŒ–ç‰ˆï¼šR = e^(-t/tau)
        # tau = 7å¤©ï¼ˆåŠè¡°æœŸï¼‰
        return 2.71828 ** (-days / 7)
    
    async def _identify_confusion_points(self, user_id: str) -> List[str]:
        """è¯†åˆ«å¸¸è§å›°æƒ‘ç‚¹"""
        
        # åˆ†æé”™é¢˜æ¨¡å¼
        errors = await self._get_error_patterns(user_id)
        
        # ç»Ÿè®¡é«˜é¢‘é”™è¯¯æ¦‚å¿µ
        concept_errors = defaultdict(int)
        for error in errors:
            for concept in error.concepts:
                concept_errors[concept] += 1
        
        # è¿”å›å‰3ä¸ªå›°æƒ‘ç‚¹
        return [
            concept for concept, count in 
            sorted(concept_errors.items(), key=lambda x: x[1], reverse=True)
        ][:3]
    
    async def _calculate_progress_velocity(self, user_id: str) -> str:
        """è®¡ç®—å­¦ä¹ é€Ÿåº¦"""
        
        # è·å–æœ€è¿‘ä¸€å‘¨çš„å­¦ä¹ æ•°æ®
        weekly_data = await self._get_weekly_progress(user_id)
        
        if not weekly_data:
            return "medium"
        
        # è®¡ç®—æŒæ¡åº¦æå‡é€Ÿåº¦
        mastery_gain = weekly_data[-1].mastery - weekly_data[0].mastery
        days = (weekly_data[-1].date - weekly_data[0].date).days
        
        if days == 0:
            return "medium"
        
        daily_gain = mastery_gain / days
        
        if daily_gain > 0.05:
            return "fast"
        elif daily_gain > 0.02:
            return "medium"
        else:
            return "slow"
    
    def _generate_recommendations(
        self,
        time_pattern: TimePattern,
        content_preference: ContentPreference,
        retention_rate: float,
        confusion_points: List[str],
        progress_velocity: str
    ) -> List[str]:
        """ç”Ÿæˆä¸ªæ€§åŒ–æ¨è"""
        
        recommendations = []
        
        # æ—¶é—´å»ºè®®
        recommendations.append(
            f"å»ºè®®åœ¨ {time_pattern.best_time} è¿›è¡Œå­¦ä¹ ï¼Œæ­¤æ—¶ä¸“æ³¨åº¦æœ€é«˜"
        )
        
        # å†…å®¹å»ºè®®
        if content_preference.style == "hands_on":
            recommendations.append("æ¨èå¤šä½¿ç”¨CodeReviewAgentè¿›è¡Œç¼–ç¨‹ç»ƒä¹ ")
        elif content_preference.style == "analytical":
            recommendations.append("æ¨èå¤šä½¿ç”¨ProblemSolverAgentè¿›è¡Œæ·±åº¦æ€è€ƒ")
        
        # å¤ä¹ å»ºè®®
        if retention_rate < 0.7:
            recommendations.append("çŸ¥è¯†ä¿ç•™ç‡è¾ƒä½ï¼Œå»ºè®®å¢åŠ å¤ä¹ é¢‘ç‡")
        
        # å›°æƒ‘ç‚¹å»ºè®®
        if confusion_points:
            recommendations.append(
                f"é‡ç‚¹æ”»å…‹: {', '.join(confusion_points[:2])}"
            )
        
        # è¿›åº¦å»ºè®®
        if progress_velocity == "fast":
            recommendations.append("å­¦ä¹ é€Ÿåº¦å¾ˆå¿«ï¼Œå¯ä»¥é€‚å½“å¢åŠ éš¾åº¦")
        elif progress_velocity == "slow":
            recommendations.append("å­¦ä¹ é€Ÿåº¦è¾ƒæ…¢ï¼Œå»ºè®®é™ä½éš¾åº¦ï¼Œå·©å›ºåŸºç¡€")
        
        return recommendations


# æ•°æ®æ¨¡å‹
@dataclass
class LearningProfile:
    user_id: str
    best_learning_time: str
    preferred_style: str
    retention_rate: float
    common_confusion: List[str]
    progress_velocity: str
    recommendations: List[str]

@dataclass
class TimePattern:
    best_time: str
    confidence: float

@dataclass
class ContentPreference:
    style: str  # "hands_on", "analytical", "visual"
```

### 4.3 åŠ¨æ€éš¾åº¦è°ƒèŠ‚

```python
# backend/app/agents/dynamic_difficulty_agent.py
class DynamicDifficultyAgent:
    """æ”¯æŒåŠ¨æ€éš¾åº¦è°ƒèŠ‚çš„Agent"""
    
    def __init__(self, base_agent: BaseAgent):
        self.base_agent = base_agent
        self.user_performance_cache = {}
    
    async def process_with_difficulty_adjustment(
        self, 
        context: AgentContext,
        target_difficulty: float = 0.6  # ç›®æ ‡éš¾åº¦ç³»æ•°
    ) -> AgentResponse:
        """æ ¹æ®ç”¨æˆ·è¡¨ç°åŠ¨æ€è°ƒæ•´éš¾åº¦"""
        
        # 1. è·å–ç”¨æˆ·å†å²è¡¨ç°
        performance = await self._get_user_performance(
            context.user_id,
            self.base_agent.role.value
        )
        
        # 2. è®¡ç®—å½“å‰éš¾åº¦ç³»æ•°
        current_difficulty = self._calculate_difficulty(
            performance,
            context.user_query
        )
        
        # 3. è°ƒæ•´æŸ¥è¯¢ä»¥åŒ¹é…ç›®æ ‡éš¾åº¦
        adjusted_query = await self._adjust_query_difficulty(
            context.user_query,
            current_difficulty,
            target_difficulty
        )
        
        # 4. è°ƒç”¨åŸºç¡€Agent
        adjusted_context = AgentContext(
            user_id=context.user_id,
            session_id=context.session_id,
            user_query=adjusted_query,
            conversation_history=context.conversation_history,
            knowledge_context=context.knowledge_context,
            user_preferences=context.user_preferences,
            previous_agent_outputs=context.previous_agent_outputs
        )
        
        response = await self.base_agent.process(adjusted_context)
        
        # 5. è®°å½•è¡¨ç°
        await self._record_performance(
            context.user_id,
            self.base_agent.role.value,
            response.confidence,
            target_difficulty
        )
        
        # 6. æ·»åŠ éš¾åº¦è¯´æ˜
        response.metadata = {
            **(response.metadata or {}),
            "difficulty_adjusted": {
                "from": current_difficulty,
                "to": target_difficulty,
                "reason": self._get_adjustment_reason(performance)
            }
        }
        
        return response
    
    def _calculate_difficulty(self, performance: Dict, query: str) -> float:
        """è®¡ç®—å½“å‰æŸ¥è¯¢éš¾åº¦"""
        
        # åŸºäºç”¨æˆ·å†å²è¡¨ç°
        if performance:
            avg_success_rate = performance.get('avg_success_rate', 0.5)
            # æˆåŠŸç‡é«˜ â†’ éš¾åº¦ä½
            base_difficulty = 1.0 - avg_success_rate
        else:
            base_difficulty = 0.5
        
        # åŸºäºæŸ¥è¯¢å¤æ‚åº¦
        complexity_bonus = self._analyze_query_complexity(query)
        
        return min(1.0, base_difficulty + complexity_bonus)
    
    async def _adjust_query_difficulty(
        self, 
        query: str, 
        current: float, 
        target: float
    ) -> str:
        """è°ƒæ•´æŸ¥è¯¢éš¾åº¦"""
        
        if abs(current - target) < 0.1:
            return query
        
        if target > current:
            # å¢åŠ éš¾åº¦
            return self._add_challenge(query)
        else:
            # é™ä½éš¾åº¦
            return self._simplify(query)
    
    def _add_challenge(self, query: str) -> str:
        """å¢åŠ æŒ‘æˆ˜æ€§"""
        enhancements = [
            "è¯·è¯¦ç»†è§£é‡Šæ¨ç†è¿‡ç¨‹",
            "æä¾›å¤šä¸ªè§£æ³•å¹¶æ¯”è¾ƒä¼˜åŠ£",
            "è®¨è®ºè¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸å¤„ç†",
            "è€ƒè™‘æ€§èƒ½ä¼˜åŒ–",
            "æ·»åŠ æµ‹è¯•ç”¨ä¾‹è®¾è®¡"
        ]
        return f"{query}\n\nè¿›é˜¶è¦æ±‚ï¼š{random.choice(enhancements)}"
    
    def _simplify(self, query: str) -> str:
        """ç®€åŒ–é—®é¢˜"""
        simplifications = [
            "è¯·ç”¨ç®€å•çš„è¯­è¨€è§£é‡Š",
            "æä¾›åŸºç¡€ç¤ºä¾‹",
            "åˆ†æ­¥éª¤è¯´æ˜",
            "ä½¿ç”¨ç±»æ¯”å¸®åŠ©ç†è§£",
            "å…³æ³¨æ ¸å¿ƒæ¦‚å¿µ"
        ]
        return f"{query}\n\nè¯·{random.choice(simplifications)}"
    
    def _get_adjustment_reason(self, performance: Dict) -> str:
        """è·å–è°ƒæ•´åŸå› """
        if not performance:
            return "é¦–æ¬¡ä½¿ç”¨ï¼Œé»˜è®¤éš¾åº¦"
        
        success_rate = performance.get('avg_success_rate', 0.5)
        
        if success_rate > 0.8:
            return "è¡¨ç°ä¼˜ç§€ï¼Œæå‡éš¾åº¦"
        elif success_rate > 0.6:
            return "è¡¨ç°è‰¯å¥½ï¼Œç»´æŒéš¾åº¦"
        elif success_rate > 0.4:
            return "è¡¨ç°ä¸€èˆ¬ï¼Œç•¥å¾®é™ä½éš¾åº¦"
        else:
            return "éœ€è¦æ›´å¤šç»ƒä¹ ï¼Œé™ä½éš¾åº¦"
```

---

## ğŸ”— é˜¶æ®µäº”ï¼šä¸ç°æœ‰ç³»ç»Ÿæ·±åº¦é›†æˆ

### 5.1 ä»»åŠ¡å¡ç³»ç»Ÿè”åŠ¨

```python
# backend/app/services/task_integration_service.py
class TaskIntegrationService:
    """å¤šAgentä¸ä»»åŠ¡å¡ç³»ç»Ÿé›†æˆ"""
    
    def __init__(self):
        self.task_service = TaskService()
        self.notification_service = NotificationService()
    
    async def create_tasks_from_collaboration(
        self,
        collaboration_result: CollaborationResult,
        user_id: str
    ) -> List[Dict]:
        """ä»åä½œç»“æœè‡ªåŠ¨ç”Ÿæˆä»»åŠ¡å¡"""
        
        tasks = []
        
        for output in collaboration_result.outputs:
            # æ£€æŸ¥æ˜¯å¦éœ€è¦è¡ŒåŠ¨
            if output.metadata.get('requires_action', False):
                task = await self._create_task_from_output(output, user_id)
                tasks.append(task)
        
        # å¦‚æœæ˜¯å­¦ä¹ è®¡åˆ’ï¼Œåˆ›å»ºç³»åˆ—ä»»åŠ¡
        if collaboration_result.workflow_type == "task_decomposition":
            await self._create_study_plan_tasks(
                collaboration_result,
                user_id,
                tasks
            )
        
        return tasks
    
    async def _create_task_from_output(
        self,
        output: AgentResponse,
        user_id: str
    ) -> Dict:
        """ä»å•ä¸ªAgentè¾“å‡ºåˆ›å»ºä»»åŠ¡"""
        
        # æå–ä»»åŠ¡ä¿¡æ¯
        task_info = output.metadata.get('task_info', {})
        
        task_data = {
            "user_id": user_id,
            "type": task_info.get('type', 'study'),
            "title": task_info.get('title', 'AIç”Ÿæˆä»»åŠ¡'),
            "description": output.response_text,
            "estimated_duration": task_info.get('duration', 30),
            "knowledge_points": output.metadata.get('related_concepts', []),
            "priority": task_info.get('priority', 'medium'),
            "source": "multi_agent_collaboration",
            "agent_metadata": {
                "agent_name": output.agent_name,
                "agent_type": output.agent_role,
                "confidence": output.confidence,
                "workflow_type": output.metadata.get('workflow_type')
            }
        }
        
        # åˆ›å»ºä»»åŠ¡
        created_task = await self.task_service.create_task(task_data)
        
        # å‘é€é€šçŸ¥
        await self.notification_service.send_task_created_notification(
            user_id=user_id,
            task=created_task
        )
        
        return created_task
    
    async def _create_study_plan_tasks(
        self,
        collaboration_result: CollaborationResult,
        user_id: str,
        existing_tasks: List[Dict]
    ):
        """ä¸ºå­¦ä¹ è®¡åˆ’åˆ›å»ºç³»åˆ—ä»»åŠ¡"""
        
        plan = collaboration_result.metadata.get('plan', {})
        timeline = plan.get('timeline', {})
        
        # æŒ‰æ—¶é—´åˆ†è§£ä»»åŠ¡
        for day, tasks in timeline.items():
            for task in tasks:
                task_data = {
                    "user_id": user_id,
                    "type": "study",
                    "title": task.get('title'),
                    "description": task.get('description'),
                    "scheduled_date": day,
                    "estimated_duration": task.get('duration', 45),
                    "knowledge_points": task.get('concepts', []),
                    "priority": "high",
                    "source": "study_plan",
                    "auto_reminder": True
                }
                
                await self.task_service.create_task(task_data)
        
        # åˆ›å»ºé‡Œç¨‹ç¢‘ä»»åŠ¡
        await self.task_service.create_milestone(
            user_id=user_id,
            title=f"å®Œæˆ {plan.get('topic', 'å­¦ä¹ è®¡åˆ’')}",
            target_date=plan.get('end_date'),
            linked_tasks=[t['id'] for t in existing_tasks]
        )
    
    async def update_task_from_feedback(
        self,
        task_id: str,
        user_feedback: str,
        performance_score: float
    ):
        """æ ¹æ®ç”¨æˆ·åé¦ˆæ›´æ–°ä»»åŠ¡"""
        
        # åˆ†æåé¦ˆ
        feedback_analysis = await self._analyze_feedback(user_feedback)
        
        # æ›´æ–°ä»»åŠ¡
        await self.task_service.update_task(
            task_id=task_id,
            updates={
                "status": "completed" if performance_score > 0.7 else "needs_review",
                "completion_notes": user_feedback,
                "performance_score": performance_score,
                "agent_insights": feedback_analysis
            }
        )
        
        # å¦‚æœéœ€è¦å¤ä¹ ï¼Œåˆ›å»ºè·Ÿè¿›ä»»åŠ¡
        if performance_score < 0.7:
            await self.task_service.create_task({
                "user_id": (await self.task_service.get_task(task_id)).user_id,
                "type": "review",
                "title": f"å¤ä¹ : {feedback_analysis.get('weak_concept', 'è–„å¼±çŸ¥è¯†ç‚¹')}",
                "description": f"åŸºäºä¹‹å‰çš„ç»ƒä¹ ï¼Œéœ€è¦åŠ å¼ºå¤ä¹ ",
                "parent_task": task_id,
                "priority": "high"
            })
```

### 5.2 æ¨é€ç³»ç»Ÿé›†æˆ

```python
# backend/app/services/intelligent_push_service.py
class IntelligentPushService:
    """åŸºäºå¤šAgentå¯¹è¯çš„æ™ºèƒ½æ¨é€"""
    
    def __init__(self):
        self.push_service = PushService()
        self.user_service = UserService()
    
    async def generate_push_from_collaboration(
        self,
        user_id: str,
        collaboration_result: CollaborationResult
    ) -> Dict:
        """ä»åä½œç»“æœç”Ÿæˆä¸ªæ€§åŒ–æ¨é€"""
        
        # 1. åˆ†æå¯¹è¯ä¸­æåˆ°çš„è–„å¼±çŸ¥è¯†ç‚¹
        weak_points = collaboration_result.metadata.get('weak_points', [])
        
        # 2. ç»“åˆé—å¿˜æ›²çº¿åˆ¤æ–­å¤ä¹ æ—¶æœº
        push_candidates = []
        
        for point in weak_points:
            if await self._should_review_now(user_id, point):
                push_candidates.append({
                    "type": "forgetting_reminder",
                    "concept": point,
                    "urgency": await self._calculate_urgency(user_id, point)
                })
        
        # 3. ç”Ÿæˆæ¨é€å†…å®¹
        if not push_candidates:
            return None
        
        # æŒ‰ç´§æ€¥ç¨‹åº¦æ’åº
        push_candidates.sort(key=lambda x: x['urgency'], reverse=True)
        top_push = push_candidates[0]
        
        # ç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹
        push_content = await self._generate_push_content(
            user_id,
            top_push,
            collaboration_result
        )
        
        # 4. å‘é€æ¨é€
        push_message = {
            "title": push_content['title'],
            "body": push_content['body'],
            "data": {
                "type": "study_reminder",
                "deep_link": f"/review/{top_push['concept']}",
                "concept": top_push['concept'],
                "session_id": collaboration_result.metadata.get('session_id')
            },
            "timing": "optimal"  # æ™ºèƒ½é€‰æ‹©å‘é€æ—¶é—´
        }
        
        await self.push_service.send_push(
            user_id=user_id,
            message=push_message
        )
        
        return push_message
    
    async def _should_review_now(self, user_id: str, concept: str) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥ç°åœ¨å¤ä¹ """
        
        # è·å–é—å¿˜æ›²çº¿æ•°æ®
        forgetting_data = await self.user_service.get_forgetting_curve(user_id)
        
        if concept not in forgetting_data:
            return False
        
        # è®¡ç®—å‰©ä½™ä¿ç•™ç‡
        days_since = forgetting_data[concept]['days_since_last']
        retention = 2.71828 ** (-days_since / 7)  # è‰¾å®¾æµ©æ–¯æ›²çº¿
        
        # å¦‚æœä¿ç•™ç‡ä½äºé˜ˆå€¼ï¼Œéœ€è¦å¤ä¹ 
        return retention < 0.6
    
    async def _calculate_urgency(self, user_id: str, concept: str) -> float:
        """è®¡ç®—å¤ä¹ ç´§æ€¥ç¨‹åº¦"""
        
        forgetting_data = await self.user_service.get_forgetting_curve(user_id)
        
        if concept not in forgetting_data:
            return 0.0
        
        days_since = forgetting_data[concept]['days_since_last']
        retention = 2.71828 ** (-days_since / 7)
        
        # ç´§æ€¥ç¨‹åº¦ = 1 - ä¿ç•™ç‡
        urgency = 1.0 - retention
        
        # å¦‚æœæœ‰è€ƒè¯•ä¸´è¿‘ï¼Œå¢åŠ ç´§æ€¥ç¨‹åº¦
        exam_schedule = await self.user_service.get_exam_schedule(user_id)
        if exam_schedule:
            days_to_exam = (exam_schedule['date'] - datetime.now()).days
            if days_to_exam < 7:
                urgency *= 1.5
        
        return min(1.0, urgency)
    
    async def _generate_push_content(
        self,
        user_id: str,
        push_data: Dict,
        collaboration_result: CollaborationResult
    ) -> Dict:
        """ç”Ÿæˆæ¨é€å†…å®¹"""
        
        concept = push_data['concept']
        urgency = push_data['urgency']
        
        # åŸºäºåä½œç»“æœç”Ÿæˆä¸Šä¸‹æ–‡
        context_summary = collaboration_result.final_response.text[:200]
        
        if push_data['type'] == "forgetting_reminder":
            if urgency > 0.7:
                return {
                    "title": f"âš ï¸ {concept} å³å°†é—å¿˜ï¼",
                    "body": f"æ ¹æ®ä»Šå¤©çš„å­¦ä¹ ï¼Œ{concept} éœ€è¦ç«‹å³å¤ä¹ ã€‚{context_summary}"
                }
            elif urgency > 0.4:
                return {
                    "title": f"ğŸ“š å¤ä¹ æé†’: {concept}",
                    "body": f"å»ºè®®èŠ±10åˆ†é’Ÿå¤ä¹  {concept}ï¼Œå·©å›ºè®°å¿†ã€‚"
                }
            else:
                return {
                    "title": f"ğŸ’¡ è®°å¾—å¤ä¹  {concept}",
                    "body": f"ä¿æŒå­¦ä¹ èŠ‚å¥ï¼Œå®šæœŸå¤ä¹ æ•ˆæœæ›´å¥½ã€‚"
                }
        
        return {
            "title": "å­¦ä¹ è¿›åº¦æ›´æ–°",
            "body": "æŸ¥çœ‹AIå¯¼å¸ˆå›¢é˜Ÿçš„æœ€æ–°å»ºè®®"
        }
```

### 5.3 ç¤¾ç¾¤å­¦ä¹ å¢å¼º

```python
# backend/app/services/community_enhancement_service.py
class CommunityEnhancementService:
    """ä¸ºç¤¾ç¾¤è®¨è®ºæä¾›AIè¾…åŠ©"""
    
    def __init__(self):
        self.orchestrator = EnhancedOrchestratorAgent()
        self.community_service = CommunityService()
    
    async def enhance_discussion(
        self,
        discussion_id: str,
        topic: str,
        participants: List[str]
    ) -> EnhancedDiscussion:
        """å¢å¼ºç¤¾ç¾¤è®¨è®ºè´¨é‡"""
        
        # 1. åˆ†æè®¨è®ºä¸»é¢˜
        analysis = await self._analyze_discussion_topic(topic, participants)
        
        # 2. è°ƒç”¨å¤šAgentç”Ÿæˆä¸åŒè§‚ç‚¹
        viewpoints = await self._generate_viewpoints(topic, participants)
        
        # 3. ç”Ÿæˆè®¨è®ºå¼•å¯¼é—®é¢˜
        discussion_questions = await self._generate_discussion_questions(
            topic,
            analysis.difficulty_level
        )
        
        # 4. æ€»ç»“å†å²è®¨è®ºè¦ç‚¹
        previous_summary = await self._summarize_previous_discussions(
            discussion_id,
            participants
        )
        
        # 5. ç”Ÿæˆåç»­å­¦ä¹ å»ºè®®
        learning_suggestions = await self._generate_learning_suggestions(
            topic,
            participants,
            analysis.weak_areas
        )
        
        return EnhancedDiscussion(
            discussion_id=discussion_id,
            topic=topic,
            viewpoints=viewpoints,
            discussion_questions=discussion_questions,
            previous_summary=previous_summary,
            learning_suggestions=learning_suggestions,
            metadata={
                "difficulty": analysis.difficulty_level,
                "participant_count": len(participants),
                "ai_generated": True
            }
        )
    
    async def _analyze_discussion_topic(self, topic: str, participants: List[str]) -> Dict:
        """åˆ†æè®¨è®ºä¸»é¢˜éš¾åº¦å’ŒèŒƒå›´"""
        
        # ä½¿ç”¨KnowledgeServiceåˆ†æä¸»é¢˜
        from app.services.knowledge_service import KnowledgeService
        ks = KnowledgeService()
        
        # è·å–ä¸»é¢˜ç›¸å…³çŸ¥è¯†ç‚¹
        related_concepts = await ks.get_related_concepts(topic)
        
        # åˆ†æéš¾åº¦
        difficulty = "beginner"
        if len(related_concepts) > 5:
            difficulty = "intermediate"
        if any(c.get('complexity', 0) > 0.8 for c in related_concepts):
            difficulty = "advanced"
        
        # è¯†åˆ«è–„å¼±é¢†åŸŸ
        weak_areas = []
        for participant in participants:
            user_weak = await self._get_user_weak_points(participant)
            weak_areas.extend(user_weak)
        
        return {
            "difficulty_level": difficulty,
            "related_concepts": related_concepts,
            "weak_areas": list(set(weak_areas))
        }
    
    async def _generate_viewpoints(self, topic: str, participants: List[str]) -> List[Dict]:
        """ç”Ÿæˆå¤šè§’åº¦è§‚ç‚¹"""
        
        # ä¸ºæ¯ä¸ªAgentç”Ÿæˆä¸€ä¸ªè§†è§’
        agent_types = [
            ("MathExpert", "æ•°å­¦è§’åº¦"),
            ("CodeExpert", "å®ç°è§’åº¦"),
            ("ScienceExpert", "ç§‘å­¦åŸç†"),
            ("WritingExpert", "è¡¨è¾¾è§’åº¦")
        ]
        
        viewpoints = []
        
        for agent_name, perspective in agent_types:
            # æ„å»ºAgentä¸Šä¸‹æ–‡
            context = AgentContext(
                user_id="community",
                session_id=f"community_{topic}",
                user_query=f"ä»{perspective}åˆ†æ: {topic}",
                conversation_history=[]
            )
            
            # è°ƒç”¨ç›¸åº”Agent
            response = await self.orchestrator.process(context)
            
            viewpoints.append({
                "agent": agent_name,
                "perspective": perspective,
                "content": response.response_text,
                "reasoning": response.reasoning
            })
        
        return viewpoints
    
    async def _generate_discussion_questions(
        self,
        topic: str,
        difficulty: str
    ) -> List[str]:
        """ç”Ÿæˆè®¨è®ºå¼•å¯¼é—®é¢˜"""
        
        base_questions = {
            "beginner": [
                f"{topic} çš„åŸºæœ¬æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ",
                f"åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šç”¨åˆ° {topic}ï¼Ÿ",
                f"å­¦ä¹  {topic} æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Ÿ"
            ],
            "intermediate": [
                f"{topic} æœ‰å“ªäº›å¸¸è§çš„åº”ç”¨åœºæ™¯ï¼Ÿ",
                f"ä½¿ç”¨ {topic} æ—¶éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ",
                f"å¦‚ä½•ä¼˜åŒ– {topic} çš„æ€§èƒ½ï¼Ÿ"
            ],
            "advanced": [
                f"{topic} çš„åº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ",
                f"å¦‚ä½•è®¾è®¡ {topic} çš„æµ‹è¯•ç”¨ä¾‹ï¼Ÿ",
                f"{topic} åœ¨å®é™…é¡¹ç›®ä¸­çš„æœ€ä½³å®è·µï¼Ÿ"
            ]
        }
        
        return base_questions.get(difficulty, base_questions["intermediate"])
    
    async def _summarize_previous_discussions(
        self,
        discussion_id: str,
        participants: List[str]
    ) -> Dict:
        """æ€»ç»“å†å²è®¨è®º"""
        
        # è·å–è®¨è®ºå†å²
        history = await self.community_service.get_discussion_history(
            discussion_id,
            limit=10
        )
        
        if not history:
            return {"summary": "è¿™æ˜¯è®¨è®ºçš„å¼€å§‹", "key_points": []}
        
        # æå–å…³é”®è§‚ç‚¹
        key_points = []
        for message in history:
            if message.get('ai_generated', False):
                continue
            
            # ç®€å•æå–è¦ç‚¹
            content = message.get('content', '')
            if len(content) > 20:
                key_points.append(content[:100])
        
        return {
            "summary": f"å·²æœ‰ {len(history)} æ¡è®¨è®ºï¼Œ{len(key_points)} ä¸ªå…³é”®è§‚ç‚¹",
            "key_points": key_points[:5]
        }
    
    async def _generate_learning_suggestions(
        self,
        topic: str,
        participants: List[str],
        weak_areas: List[str]
    ) -> List[Dict]:
        """ç”Ÿæˆåç»­å­¦ä¹ å»ºè®®"""
        
        suggestions = []
        
        # ä¸ºæ¯ä¸ªå‚ä¸è€…ç”Ÿæˆä¸ªæ€§åŒ–å»ºè®®
        for participant in participants:
            # è·å–ç”¨æˆ·å½“å‰ä»»åŠ¡
            tasks = await self.community_service.get_user_tasks(participant)
            
            # ç»“åˆè®¨è®ºä¸»é¢˜ç”Ÿæˆå»ºè®®
            suggestion = {
                "user_id": participant,
                "suggested_actions": [
                    {
                        "type": "study",
                        "title": f"æ·±å…¥å­¦ä¹  {topic}",
                        "priority": "high" if topic in weak_areas else "medium"
                    },
                    {
                        "type": "practice",
                        "title": f"å®Œæˆ {topic} ç›¸å…³ç»ƒä¹ ",
                        "priority": "medium"
                    }
                ],
                "estimated_time": "60åˆ†é’Ÿ",
                "deadline": "3å¤©å†…"
            }
            
            suggestions.append(suggestion)
        
        return suggestions
```

---

## ğŸ“± é˜¶æ®µå…­ï¼šç§»åŠ¨ç«¯UI/UXä¼˜åŒ–

### 6.1 æ–°å¢å±å¹•å®ç°

#### MultiAgentChatScreen - ä¸“ä¸šå¤šAgentå¯¹è¯ç•Œé¢

```dart
// mobile/lib/presentation/screens/chat/multi_agent_chat.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:sparkle/presentation/widgets/chat/agent_collaboration_timeline.dart';
import 'package:sparkle/presentation/widgets/chat/mindmap_viewer.dart';
import 'package:sparkle/presentation/widgets/chat/learning_progress_panel.dart';
import 'package:sparkle/presentation/widgets/chat/learning_mode_switcher.dart';
import 'package:sparkle/presentation/widgets/chat/chat_input.dart';
import 'package:sparkle/presentation/widgets/chat/chat_bubble.dart';

class MultiAgentChatScreen extends ConsumerStatefulWidget {
  final String? initialQuery;
  
  const MultiAgentChatScreen({super.key, this.initialQuery});

  @override
  ConsumerState<MultiAgentChatScreen> createState() => _MultiAgentChatScreenState();
}

class _MultiAgentChatScreenState extends ConsumerState<MultiAgentChatScreen> 
    with TickerProviderStateMixin {
  late TabController _tabController;
  LearningMode _currentMode = LearningMode.collaborative;
  bool _showSidebar = true;
  
  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    
    // å¦‚æœæœ‰åˆå§‹æŸ¥è¯¢ï¼Œè‡ªåŠ¨å‘é€
    if (widget.initialQuery != null) {
      WidgetsBinding.instance.addPostFrameCallback((_) {
        _sendInitialQuery();
      });
    }
  }
  
  void _sendInitialQuery() {
    // è°ƒç”¨Providerå‘é€æŸ¥è¯¢
    // ref.read(chatProvider.notifier).sendMessage(widget.initialQuery!);
  }
  
  void _onModeChanged(LearningMode mode) {
    setState(() {
      _currentMode = mode;
    });
    
    // é€šçŸ¥åç«¯åˆ‡æ¢æ¨¡å¼
    // ref.read(chatProvider.notifier).setLearningMode(mode);
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('AI å¯¼å¸ˆå›¢é˜Ÿ'),
        backgroundColor: Colors.purple.shade600,
        foregroundColor: Colors.white,
        actions: [
          IconButton(
            icon: Icon(_showSidebar ? Icons.view_sidebar : Icons.view_sidebar_outlined),
            onPressed: () => setState(() => _showSidebar = !_showSidebar),
          ),
          PopupMenuButton<String>(
            icon: const Icon(Icons.more_vert),
            itemBuilder: (context) => [
              const PopupMenuItem(value: 'history', child: Text('åä½œå†å²')),
              const PopupMenuItem(value: 'settings', child: Text('Agentè®¾ç½®')),
              const PopupMenuItem(value: 'export', child: Text('å¯¼å‡ºç¬”è®°')),
            ],
            onSelected: (value) {
              // å¤„ç†èœå•é€‰æ‹©
            },
          ),
        ],
        bottom: TabBar(
          controller: _tabController,
          tabs: const [
            Tab(text: 'å¯¹è¯'),
            Tab(text: 'æ€ç»´å¯¼å›¾'),
            Tab(text: 'è¿›åº¦'),
          ],
          indicatorColor: Colors.white,
          indicatorWeight: 3,
        ),
      ),
      body: Row(
        children: [
          // ä¸»å†…å®¹åŒº
          Expanded(
            child: Column(
              children: [
                // æ¨¡å¼åˆ‡æ¢å™¨
                Padding(
                  padding: const EdgeInsets.all(8.0),
                  child: LearningModeSwitcher(
                    currentMode: _currentMode,
                    onModeChanged: _onModeChanged,
                  ),
                ),
                
                // Tabè§†å›¾
                Expanded(
                  child: TabBarView(
                    controller: _tabController,
                    children: [
                      _buildChatView(),
                      _buildMindMapView(),
                      _buildProgressView(),
                    ],
                  ),
                ),
                
                // è¾“å…¥åŒº
                ChatInput(
                  onSend: (message) {
                    // å‘é€æ¶ˆæ¯
                    // ref.read(chatProvider.notifier).sendMessage(message);
                  },
                  placeholder: 'å‘AIå¯¼å¸ˆå›¢é˜Ÿæé—®...',
                  enabled: true,
                ),
              ],
            ),
          ),
          
          // ä¾§è¾¹æ ï¼ˆåä½œçŠ¶æ€ï¼‰
          if (_showSidebar)
            Container(
              width: 280,
              decoration: BoxDecoration(
                color: Colors.grey.shade50,
                border: Border(left: BorderSide(color: Colors.grey.shade300)),
              ),
              child: _buildSidebar(),
            ),
        ],
      ),
    );
  }
  
  Widget _buildChatView() {
    return Container(
      color: Colors.grey.shade100,
      child: Column(
        children: [
          // åä½œæ—¶é—´çº¿ï¼ˆå¯æŠ˜å ï¼‰
          Container(
            height: 200,
            padding: const EdgeInsets.all(8),
            child: AgentCollaborationTimeline(
              steps: [
                AgentStep(
                  agentName: 'å­¦ä¹ è§„åˆ’å¸ˆ',
                  agentType: 'planner',
                  agentIcon: Icons.calendar_today,
                  agentColor: Colors.blue.shade600,
                  summary: 'åˆ†æè€ƒè¯•å€’è®¡æ—¶7å¤©ï¼ŒæŒæ¡åº¦40%',
                  details: 'åŸºäºé—å¿˜æ›²çº¿ï¼Œå»ºè®®å‰3å¤©å¤ä¹ åŸºç¡€æ¦‚å¿µï¼Œå4å¤©è¿›è¡Œå®æˆ˜ç»ƒä¹ ',
                  confidence: 0.92,
                ),
                AgentStep(
                  agentName: 'æ•°å­¦ä¸“å®¶',
                  agentType: 'math',
                  agentIcon: Icons.functions,
                  agentColor: Colors.green.shade600,
                  summary: 'ç”Ÿæˆ10é“æ ¸å¿ƒæ¦‚å¿µé¢˜',
                  details: 'åŒ…å«çŸ©é˜µè¿ç®—ã€æ¢¯åº¦è®¡ç®—ã€æ¦‚ç‡æ¨å¯¼ç­‰å…³é”®çŸ¥è¯†ç‚¹',
                  confidence: 0.95,
                ),
                AgentStep(
                  agentName: 'ä»£ç å¯¼å¸ˆ',
                  agentType: 'code',
                  agentIcon: Icons.code,
                  agentColor: Colors.orange.shade600,
                  summary: 'è®¾è®¡3ä¸ªç¼–ç¨‹å®æˆ˜é¡¹ç›®',
                  details: 'ç¥ç»ç½‘ç»œå®ç°ã€ä¼˜åŒ–ç®—æ³•ã€æ•°æ®é¢„å¤„ç†',
                  confidence: 0.88,
                ),
              ],
              workflowType: 'ä»»åŠ¡åˆ†è§£',
            ),
          ),
          
          // èŠå¤©æ¶ˆæ¯åˆ—è¡¨
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.all(8),
              itemCount: 10, // å®é™…ä»providerè·å–
              itemBuilder: (context, index) {
                // æ ¹æ®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºä¸åŒç»„ä»¶
                if (index == 0) {
                  return MultiAgentCollaborationBubble(
                    contributions: [
                      AgentContribution(
                        agentName: 'æ•°å­¦ä¸“å®¶',
                        agentType: 'math',
                        reasoning: 'é€šè¿‡çŸ©é˜µåˆ†è§£ç®€åŒ–é—®é¢˜',
                        responseText: 'å»ºè®®ä½¿ç”¨SVDåˆ†è§£ï¼Œå°†çŸ©é˜µAåˆ†è§£ä¸ºUÎ£Váµ€',
                        agentColor: Colors.blue.shade600,
                        confidence: 0.95,
                      ),
                      AgentContribution(
                        agentName: 'ä»£ç å¯¼å¸ˆ',
                        agentType: 'code',
                        reasoning: 'æä¾›Pythonå®ç°',
                        responseText: '```python\nimport numpy as np\nU, S, Vt = np.linalg.svd(A)\n```',
                        agentColor: Colors.green.shade600,
                        confidence: 0.92,
                      ),
                    ],
                    summary: 'ç»¼åˆå»ºè®®ï¼šå…ˆç†è§£SVDæ•°å­¦åŸç†ï¼Œå†é€šè¿‡ä»£ç å®è·µåŠ æ·±ç†è§£',
                  );
                }
                
                return ChatBubble(
                  isUser: index % 2 == 1,
                  message: 'æµ‹è¯•æ¶ˆæ¯ $index',
                  timestamp: DateTime.now(),
                );
              },
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildMindMapView() {
    return Container(
      color: Colors.white,
      child: MindMapViewer(
        data: MindMapData(
          centerTopic: 'æœºå™¨å­¦ä¹ è€ƒè¯•',
          branches: [
            Branch(title: 'æ•°å­¦åŸºç¡€', subtopics: ['çº¿æ€§ä»£æ•°', 'æ¦‚ç‡è®º', 'ä¼˜åŒ–ç†è®º']),
            Branch(title: 'ç¼–ç¨‹å®è·µ', subtopics: ['PythonåŸºç¡€', 'NumPy', 'PyTorch']),
            Branch(title: 'æ ¸å¿ƒç®—æ³•', subtopics: ['å›å½’', 'åˆ†ç±»', 'èšç±»']),
          ],
        ),
      ),
    );
  }
  
  Widget _buildProgressView() {
    return Container(
      color: Colors.grey.shade50,
      padding: const EdgeInsets.all(16),
      child: LearningProgressPanel(
        data: LearningProgressData(
          masteryLevels: [
            MasteryLevel(concept: 'çº¿æ€§ä»£æ•°', level: 0.75),
            MasteryLevel(concept: 'æ¦‚ç‡è®º', level: 0.62),
            MasteryLevel(concept: 'ä¼˜åŒ–ç†è®º', level: 0.45),
          ],
          forgettingCurve: [1.0, 0.85, 0.72, 0.61, 0.52],
          reviewSuggestions: [
            'ä»Šå¤©å¤ä¹ ä¼˜åŒ–ç†è®ºï¼ŒæŒæ¡åº¦è¾ƒä½',
            '3å¤©åå¤ä¹ æ¦‚ç‡è®ºç›¸å…³æ¦‚å¿µ',
            '7å¤©åè¿›è¡Œç»¼åˆç»ƒä¹ ',
          ],
        ),
      ),
    );
  }
  
  Widget _buildSidebar() {
    return Column(
      children: [
        // AgentçŠ¶æ€
        Container(
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: Colors.purple.shade50,
            border: Border(bottom: BorderSide(color: Colors.purple.shade200)),
          ),
          child: Row(
            children: [
              Icon(Icons.groups, color: Colors.purple.shade700),
              const SizedBox(width: 8),
              Text(
                'åä½œçŠ¶æ€',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: Colors.purple.shade700,
                ),
              ),
            ],
          ),
        ),
        
        Expanded(
          child: ListView(
            padding: const EdgeInsets.all(8),
            children: [
              _buildAgentStatusCard(
                name: 'å­¦ä¹ è§„åˆ’å¸ˆ',
                status: 'æ´»è·ƒ',
                color: Colors.blue.shade600,
                progress: 0.9,
              ),
              _buildAgentStatusCard(
                name: 'æ•°å­¦ä¸“å®¶',
                status: 'æ€è€ƒä¸­',
                color: Colors.green.shade600,
                progress: 0.6,
              ),
              _buildAgentStatusCard(
                name: 'ä»£ç å¯¼å¸ˆ',
                status: 'ç­‰å¾…',
                color: Colors.orange.shade600,
                progress: 0.0,
              ),
              
              const SizedBox(height: 16),
              
              // å¿«æ·æ“ä½œ
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: Colors.grey.shade300),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'å¿«æ·æ“ä½œ',
                      style: TextStyle(
                        fontWeight: FontWeight.bold,
                        color: Colors.grey.shade700,
                      ),
                    ),
                    const SizedBox(height: 8),
                    _buildQuickActionButton(
                      icon: Icons.lightbulb_outline,
                      label: 'ç”Ÿæˆæ€ç»´å¯¼å›¾',
                      onTap: () {},
                    ),
                    _buildQuickActionButton(
                      icon: Icons.task_alt,
                      label: 'åˆ›å»ºå­¦ä¹ ä»»åŠ¡',
                      onTap: () {},
                    ),
                    _buildQuickActionButton(
                      icon: Icons.history,
                      label: 'æŸ¥çœ‹å†å²',
                      onTap: () {},
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }
  
  Widget _buildAgentStatusCard({
    required String name,
    required String status,
    required Color color,
    required double progress,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: color.withOpacity(0.3)),
        boxShadow: [
          BoxShadow(
            color: color.withOpacity(0.1),
            blurRadius: 4,
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                width: 8,
                height: 8,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: color,
                ),
              ),
              const SizedBox(width: 8),
              Text(
                name,
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: color,
                ),
              ),
              const Spacer(),
              Text(
                status,
                style: TextStyle(
                  fontSize: 11,
                  color: Colors.grey.shade600,
                ),
              ),
            ],
          ),
          if (progress > 0) ...[
            const SizedBox(height: 8),
            LinearProgressIndicator(
              value: progress,
              backgroundColor: color.withOpacity(0.2),
              valueColor: AlwaysStoppedAnimation(color),
              minHeight: 4,
            ),
          ],
        ],
      ),
    );
  }
  
  Widget _buildQuickActionButton({
    required IconData icon,
    required String label,
    required VoidCallback onTap,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(6),
      child: Container(
        margin: const EdgeInsets.only(top: 4),
        padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 12),
        decoration: BoxDecoration(
          color: Colors.grey.shade50,
          borderRadius: BorderRadius.circular(6),
        ),
        child: Row(
          children: [
            Icon(icon, size: 16, color: Colors.purple.shade600),
            const SizedBox(width: 8),
            Text(
              label,
              style: TextStyle(
                fontSize: 12,
                color: Colors.grey.shade700,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

#### AgentStudioScreen - Agenté…ç½®ä¸è®­ç»ƒ

```dart
// mobile/lib/presentation/screens/chat/agent_studio.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class AgentStudioScreen extends ConsumerStatefulWidget {
  const AgentStudioScreen({super.key});

  @override
  ConsumerState<AgentStudioScreen> createState() => _AgentStudioScreenState();
}

class _AgentStudioScreenState extends ConsumerState<AgentStudioScreen> 
    with SingleTickerProviderStateMixin {
  late TabController _tabController;
  
  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('AI å¯¼å¸ˆå·¥ä½œå®¤'),
        backgroundColor: Colors.indigo.shade600,
        foregroundColor: Colors.white,
        bottom: TabBar(
          controller: _tabController,
          tabs: const [
            Tab(text: 'åå¥½è®¾ç½®'),
            Tab(text: 'è®­ç»ƒæ•°æ®'),
            Tab(text: 'æ€§èƒ½åˆ†æ'),
          ],
          indicatorColor: Colors.white,
        ),
      ),
      body: TabBarView(
        controller: _tabController,
        children: [
          _buildPreferencesTab(),
          _buildTrainingTab(),
          _buildPerformanceTab(),
        ],
      ),
    );
  }
  
  Widget _buildPreferencesTab() {
    return ListView(
      padding: const EdgeInsets.all(16),
      children: [
        _buildPreferenceSection(
          title: 'å­¦ä¹ é£æ ¼',
          options: ['è§†è§‰å‹', 'å¬è§‰å‹', 'åŠ¨æ‰‹å‹', 'åˆ†æå‹'],
          selected: 'åŠ¨æ‰‹å‹',
          onChanged: (value) {},
        ),
        const SizedBox(height: 16),
        _buildPreferenceSection(
          title: 'éš¾åº¦åå¥½',
          options: ['åŸºç¡€', 'é€‚ä¸­', 'æŒ‘æˆ˜', 'æé™'],
          selected: 'é€‚ä¸­',
          onChanged: (value) {},
        ),
        const SizedBox(height: 16),
        _buildPreferenceSection(
          title: 'å“åº”é£æ ¼',
          options: ['ç®€æ´', 'è¯¦ç»†', 'å¼•å¯¼å¼', 'ç›´æ¥'],
          selected: 'å¼•å¯¼å¼',
          onChanged: (value) {},
        ),
        const SizedBox(height: 24),
        _buildAgentToggles(),
      ],
    );
  }
  
  Widget _buildPreferenceSection({
    required String title,
    required List<String> options,
    required String selected,
    required ValueChanged<String> onChanged,
  }) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 8,
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            title,
            style: const TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 12),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: options.map((option) {
              final isSelected = option == selected;
              return ChoiceChip(
                label: Text(option),
                selected: isSelected,
                onSelected: (selected) => onChanged(option),
                selectedColor: Colors.indigo.shade600,
                labelStyle: TextStyle(
                  color: isSelected ? Colors.white : Colors.black,
                ),
              );
            }).toList(),
          ),
        ],
      ),
    );
  }
  
  Widget _buildAgentToggles() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 8,
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'å¯ç”¨çš„Agent',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 12),
          _buildAgentToggle('å­¦ä¹ è§„åˆ’å¸ˆ', 'åŸºäºé—å¿˜æ›²çº¿åˆ¶å®šè®¡åˆ’', true, Colors.blue),
          _buildAgentToggle('é—®é¢˜è§£å†³å¯¼å¸ˆ', 'è‹æ ¼æ‹‰åº•å¼å¼•å¯¼', true, Colors.green),
          _buildAgentToggle('ä»£ç å®¡æŸ¥å¯¼å¸ˆ', 'æ•™å­¦å¼ä»£ç ä¼˜åŒ–', true, Colors.orange),
          _buildAgentToggle('å†™ä½œæ•™ç»ƒ', 'ç»“æ„åŒ–å†™ä½œæŒ‡å¯¼', true, Colors.purple),
        ],
      ),
    );
  }
  
  Widget _buildAgentToggle(
    String name,
    String description,
    bool enabled,
    Color color,
  ) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: enabled ? color.withOpacity(0.05) : Colors.grey.shade50,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(
          color: enabled ? color.withOpacity(0.3) : Colors.grey.shade300,
        ),
      ),
      child: Row(
        children: [
          Icon(
            enabled ? Icons.toggle_on : Icons.toggle_off,
            color: enabled ? color : Colors.grey,
            size: 32,
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  name,
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: enabled ? color : Colors.grey,
                  ),
                ),
                Text(
                  description,
                  style: TextStyle(
                    fontSize: 11,
                    color: Colors.grey.shade600,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildTrainingTab() {
    return ListView(
      padding: const EdgeInsets.all(16),
      children: [
        _buildTrainingCard(
          title: 'å­¦ä¹ å†å²',
          description: 'åŸºäºä½ è¿‡å»çš„å­¦ä¹ è®°å½•ä¼˜åŒ–æ¨è',
          progress: 0.75,
          status: 'å·²è®­ç»ƒ',
        ),
        _buildTrainingCard(
          title: 'çŸ¥è¯†å›¾è°±',
          description: 'æ„å»ºä¸ªäººçŸ¥è¯†ç½‘ç»œ',
          progress: 0.62,
          status: 'è¿›è¡Œä¸­',
        ),
        _buildTrainingCard(
          title: 'é—å¿˜æ›²çº¿',
          description: 'åˆ†æè®°å¿†æ¨¡å¼',
          progress: 0.89,
          status: 'å·²ä¼˜åŒ–',
        ),
        _buildTrainingCard(
          title: 'äº¤äº’åå¥½',
          description: 'å­¦ä¹ ä½ çš„æé—®å’Œåé¦ˆæ¨¡å¼',
          progress: 0.45,
          status: 'éœ€è¦æ›´å¤šæ•°æ®',
        ),
      ],
    );
  }
  
  Widget _buildTrainingCard({
    required String title,
    required String description,
    required double progress,
    required String status,
  }) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 8,
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: const TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      description,
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.grey.shade600,
                      ),
                    ),
                  ],
                ),
              ),
              Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: 8,
                  vertical: 4,
                ),
                decoration: BoxDecoration(
                  color: _getStatusColor(status).withOpacity(0.1),
                  borderRadius: BorderRadius.circular(6),
                ),
                child: Text(
                  status,
                  style: TextStyle(
                    fontSize: 11,
                    color: _getStatusColor(status),
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          LinearProgressIndicator(
            value: progress,
            backgroundColor: Colors.grey.shade200,
            valueColor: AlwaysStoppedAnimation(
              Colors.indigo.shade600,
            ),
            minHeight: 6,
            borderRadius: BorderRadius.circular(3),
          ),
          const SizedBox(height: 4),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                'è®­ç»ƒè¿›åº¦',
                style: TextStyle(
                  fontSize: 11,
                  color: Colors.grey.shade600,
                ),
              ),
              Text(
                '${(progress * 100).toStringAsFixed(0)}%',
                style: const TextStyle(
                  fontSize: 11,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
  
  Color _getStatusColor(String status) {
    switch (status) {
      case 'å·²è®­ç»ƒ':
      case 'å·²ä¼˜åŒ–':
        return Colors.green.shade600;
      case 'è¿›è¡Œä¸­':
        return Colors.blue.shade600;
      case 'éœ€è¦æ›´å¤šæ•°æ®':
        return Colors.orange.shade600;
      default:
        return Colors.grey.shade600;
    }
  }
  
  Widget _buildPerformanceTab() {
    return ListView(
      padding: const EdgeInsets.all(16),
      children: [
        _buildPerformanceMetrics(),
        const SizedBox(height: 16),
        _buildAgentEfficiency(),
        const SizedBox(height: 16),
        _buildLearningInsights(),
      ],
    );
  }
  
  Widget _buildPerformanceMetrics() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 8,
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'æ€§èƒ½æŒ‡æ ‡',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 16),
          Row(
            children: [
              Expanded(
                child: _buildMetricCard(
                  'å‡†ç¡®ç‡',
                  '92%',
                  Colors.green.shade600,
                ),
              ),
              const SizedBox(width: 8),
              Expanded(
                child: _buildMetricCard(
                  'å“åº”é€Ÿåº¦',
                  '1.2s',
                  Colors.blue.shade600,
                ),
              ),
              const SizedBox(width: 8),
              Expanded(
                child: _buildMetricCard(
                  'æ»¡æ„åº¦',
                  '4.6/5',
                  Colors.purple.shade600,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
  
  Widget _buildMetricCard(String label, String value, Color color) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: color.withOpacity(0.3)),
      ),
      child: Column(
        children: [
          Text(
            value,
            style: TextStyle(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: color,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            label,
            style: TextStyle(
              fontSize: 11,
              color: color,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }
  
  Widget _buildAgentEfficiency() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 8,
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'Agentæ•ˆç‡æ’å',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 12),
          _buildEfficiencyBar('å­¦ä¹ è§„åˆ’å¸ˆ', 0.92, Colors.blue),
          _buildEfficiencyBar('é—®é¢˜è§£å†³å¯¼å¸ˆ', 0.88, Colors.green),
          _buildEfficiencyBar('ä»£ç å®¡æŸ¥å¯¼å¸ˆ', 0.85, Colors.orange),
          _buildEfficiencyBar('å†™ä½œæ•™ç»ƒ', 0.79, Colors.purple),
        ],
      ),
    );
  }
  
  Widget _buildEfficiencyBar(String name, double efficiency, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(name, style: TextStyle(fontSize: 12, fontWeight: FontWeight.w600)),
              Text('${(efficiency * 100).toStringAsFixed(0)}%', style: const TextStyle(fontSize: 12)),
            ],
          ),
          const SizedBox(height: 4),
          LinearProgressIndicator(
            value: efficiency,
            backgroundColor: color.withOpacity(0.2),
            valueColor: AlwaysStoppedAnimation(color),
            minHeight: 6,
            borderRadius: BorderRadius.circular(3),
          ),
        ],
      ),
    );
  }
  
  Widget _buildLearningInsights() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.05),
            blurRadius: 8,
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'å­¦ä¹ æ´å¯Ÿ',
            style: TextStyle(
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 12),
          _buildInsightItem(
            Icons.access_time,
            'æœ€ä½³å­¦ä¹ æ—¶é—´',
            '20:00 - 22:00',
            Colors.blue,
          ),
          _buildInsightItem(
            Icons.lightbulb_outline,
            'æ¨èæ¨¡å¼',
            'åä½œæ¨¡å¼ï¼ˆå¤šè§†è§’ï¼‰',
            Colors.green,
          ),
          _buildInsightItem(
            Icons.warning_amber,
            'è–„å¼±ç¯èŠ‚',
            'ä¼˜åŒ–ç†è®ºã€æ¦‚ç‡æ¨å¯¼',
            Colors.orange,
          ),
          _buildInsightItem(
            Icons.trending_up,
            'è¿›æ­¥è¶‹åŠ¿',
            'æ¯å‘¨æå‡ 8%',
            Colors.purple,
          ),
        ],
      ),
    );
  }
  
  Widget _buildInsightItem(IconData icon, String title, String value, Color color) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: color.withOpacity(0.05),
        borderRadius: BorderRadius.circular(8),
      ),
      child: Row(
        children: [
          Icon(icon, color: color, size: 20),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey.shade700,
                  ),
                ),
                Text(
                  value,
                  style: TextStyle(
                    fontSize: 13,
                    fontWeight: FontWeight.bold,
                    color: color,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```

#### CollaborationHistoryScreen - åä½œå†å²å›é¡¾

```dart
// mobile/lib/presentation/screens/chat/collaboration_history.dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:intl/intl.dart';

class CollaborationHistoryScreen extends ConsumerStatefulWidget {
  const CollaborationHistoryScreen({super.key});

  @override
  ConsumerState<CollaborationHistoryScreen> createState() => _CollaborationHistoryScreenState();
}

class _CollaborationHistoryScreenState extends ConsumerState<CollaborationHistoryScreen> {
  final DateFormat _dateFormat = DateFormat('MM-dd HH:mm');
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('åä½œå†å²'),
        backgroundColor: Colors.teal.shade600,
        foregroundColor: Colors.white,
        actions: [
          IconButton(
            icon: const Icon(Icons.download),
            onPressed: () {
              // å¯¼å‡ºå­¦ä¹ æŠ¥å‘Š
            },
          ),
        ],
      ),
      body: ListView.builder(
        padding: const EdgeInsets.all(8),
        itemCount: 10,
        itemBuilder: (context, index) {
          return _buildHistoryCard(index);
        },
      ),
    );
  }
  
  Widget _buildHistoryCard(int index) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      child: Card(
        elevation: 2,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        child: InkWell(
          onTap: () => _showHistoryDetail(index),
          borderRadius: BorderRadius.circular(12),
          child: Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // æ ‡é¢˜å’Œæ—¶é—´
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Expanded(
                      child: Text(
                        'æœºå™¨å­¦ä¹ è€ƒè¯•å‡†å¤‡',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.bold,
                          color: Colors.teal.shade700,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                    Text(
                      _dateFormat.format(DateTime.now().subtract(Duration(days: index))),
                      style: TextStyle(
                        fontSize: 11,
                        color: Colors.grey.shade600,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                
                // Agentå‚ä¸
                Row(
                  children: [
                    _buildAgentAvatarStack(['math', 'code', 'writing']),
                    const SizedBox(width: 8),
                    Text(
                      '3ä½ä¸“å®¶åä½œ',
                      style: TextStyle(
                        fontSize: 12,
                        color: Colors.grey.shade700,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                
                // æ‘˜è¦
                Text(
                  'é€šè¿‡å¤šè§’åº¦åˆ†æï¼Œç”Ÿæˆäº†å®Œæ•´çš„å­¦ä¹ è®¡åˆ’å’Œå®æˆ˜é¡¹ç›®ï¼Œå¸®åŠ©ç†è§£æ ¸å¿ƒæ¦‚å¿µ...',
                  style: TextStyle(
                    fontSize: 13,
                    color: Colors.grey.shade600,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
                const SizedBox(height: 8),
                
                // æ ‡ç­¾
                Wrap(
                  spacing: 6,
                  runSpacing: 4,
                  children: [
                    _buildTag('ä»»åŠ¡åˆ†è§£', Colors.blue),
                    _buildTag('ç”Ÿæˆä»»åŠ¡', Colors.green),
                    _buildTag('å¤ä¹ è®¡åˆ’', Colors.orange),
                  ],
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
  
  Widget _buildAgentAvatarStack(List<String> agentTypes) {
    final colors = {
      'math': Colors.blue.shade600,
      'code': Colors.green.shade600,
      'writing': Colors.orange.shade600,
      'science': Colors.purple.shade600,
    };
    
    final icons = {
      'math': Icons.functions,
      'code': Icons.code,
      'writing': Icons.edit,
      'science': Icons.science,
    };
    
    return SizedBox(
      height: 32,
      width: 80,
      child: Stack(
        children: agentTypes.asMap().entries.map((entry) {
          final agentType = entry.value;
          final index = entry.key;
          
          return Positioned(
            left: index * 12,
            child: Container(
              width: 28,
              height: 28,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                color: colors[agentType] ?? Colors.grey,
                border: Border.all(color: Colors.white, width: 2),
                boxShadow: [
                  BoxShadow(
                    color: (colors[agentType] ?? Colors.grey).withOpacity(0.3),
                    blurRadius: 4,
                  ),
                ],
              ),
              child: Icon(
                icons[agentType] ?? Icons.person,
                color: Colors.white,
                size: 14,
              ),
            ),
          );
        }).toList(),
      ),
    );
  }
  
  Widget _buildTag(String label, Color color) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: color.withOpacity(0.3)),
      ),
      child: Text(
        label,
        style: TextStyle(
          fontSize: 11,
          color: color,
          fontWeight: FontWeight.w600,
        ),
      ),
    );
  }
  
  void _showHistoryDetail(int index) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) {
        return Container(
          height: MediaQuery.of(context).size.height * 0.85,
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.only(
              topLeft: Radius.circular(20),
              topRight: Radius.circular(20),
            ),
          ),
          child: Column(
            children: [
              Container(
                width: 40,
                height: 4,
                margin: const EdgeInsets.symmetric(vertical: 8),
                decoration: BoxDecoration(
                  color: Colors.grey.shade300,
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
              Padding(
                padding: const EdgeInsets.all(16),
                child: Row(
                  children: [
                    Icon(Icons.history, color: Colors.teal.shade600),
                    const SizedBox(width: 8),
                    Text(
                      'åä½œè¯¦æƒ…',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: Colors.teal.shade600,
                      ),
                    ),
                    const Spacer(),
                    IconButton(
                      icon: const Icon(Icons.close),
                      onPressed: () => Navigator.pop(context),
                    ),
                  ],
                ),
              ),
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.all(16),
                  children: [
                    _buildDetailSection(
                      'åä½œæµç¨‹',
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          _buildTimelineStep(1, 'å­¦ä¹ è§„åˆ’å¸ˆ', 'åˆ†æè€ƒè¯•å€’è®¡æ—¶å’ŒæŒæ¡åº¦', Colors.blue),
                          _buildTimelineStep(2, 'æ•°å­¦ä¸“å®¶', 'ç”Ÿæˆæ ¸å¿ƒæ¦‚å¿µé¢˜', Colors.green),
                          _buildTimelineStep(3, 'ä»£ç å¯¼å¸ˆ', 'è®¾è®¡ç¼–ç¨‹é¡¹ç›®', Colors.orange),
                          _buildTimelineStep(4, 'å†™ä½œæ•™ç»ƒ', 'åˆ›å»ºæ€»ç»“æ¨¡æ¿', Colors.purple),
                        ],
                      ),
                    ),
                    const SizedBox(height: 16),
                    _buildDetailSection(
                      'ç”Ÿæˆçš„ä»»åŠ¡',
                      Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          _buildTaskItem('å¤ä¹ çº¿æ€§ä»£æ•°', '30åˆ†é’Ÿ', 'ä»Šå¤©å†…'),
                          _buildTaskItem('å®ŒæˆçŸ©é˜µè¿ç®—ç»ƒä¹ ', '45åˆ†é’Ÿ', 'æ˜å¤©'),
                          _buildTaskItem('å®ç°SVDåˆ†è§£ä»£ç ', '60åˆ†é’Ÿ', 'åå¤©'),
                        ],
                      ),
                    ),
                    const SizedBox(height: 16),
                    _buildDetailSection(
                      'å­¦ä¹ å»ºè®®',
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.teal.shade50,
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(color: Colors.teal.shade200),
                        ),
                        child: Text(
                          'å»ºè®®æŒ‰ç…§æ•°å­¦â†’ä»£ç â†’ç†è®ºçš„é¡ºåºå­¦ä¹ ï¼Œæ¯ä¸ªçŸ¥è¯†ç‚¹é—´éš”1å¤©å¤ä¹ ï¼Œåˆ©ç”¨é—å¿˜æ›²çº¿ä¼˜åŒ–è®°å¿†æ•ˆæœã€‚',
                          style: TextStyle(
                            color: Colors.teal.shade800,
                            height: 1.5,
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    _buildDetailSection(
                      'å¯¼å‡ºé€‰é¡¹',
                      Row(
                        children: [
                          Expanded(
                            child: _buildExportButton(
                              'å¯¼å‡ºå­¦ä¹ ç¬”è®°',
                              Icons.note_add,
                              Colors.blue,
                              () {},
                            ),
                          ),
                          const SizedBox(width: 8),
                          Expanded(
                            child: _buildExportButton(
                              'ç”ŸæˆæŠ¥å‘Š',
                              Icons.assessment,
                              Colors.green,
                              () {},
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }
  
  Widget _buildDetailSection(String title, Widget content) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          title,
          style: const TextStyle(
            fontSize: 16,
            fontWeight: FontWeight.bold,
          ),
        ),
        const SizedBox(height: 8),
        content,
      ],
    );
  }
  
  Widget _buildTimelineStep(int step, String agent, String action, Color color) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      child: Row(
        children: [
          Container(
            width: 24,
            height: 24,
            decoration: BoxDecoration(
              shape: BoxShape.circle,
              color: color,
            ),
            child: Center(
              child: Text(
                step.toString(),
                style: const TextStyle(
                  color: Colors.white,
                  fontWeight: FontWeight.bold,
                  fontSize: 12,
                ),
              ),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  agent,
                  style: TextStyle(
                    fontWeight: FontWeight.bold,
                    color: color,
                  ),
                ),
                Text(
                  action,
                  style: TextStyle(
                    fontSize: 12,
                    color: Colors.grey.shade600,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildTaskItem(String title, String duration, String deadline) {
    return Container(
      margin: const EdgeInsets.only(bottom: 6),
      padding: const EdgeInsets.all(10),
      decoration: BoxDecoration(
        color: Colors.grey.shade50,
        borderRadius: BorderRadius.circular(6),
        border: Border.all(color: Colors.grey.shade300),
      ),
      child: Row(
        children: [
          Icon(Icons.task, size: 16, color: Colors.teal.shade600),
          const SizedBox(width: 8),
          Expanded(
            child: Text(
              title,
              style: const TextStyle(fontSize: 13),
            ),
          ),
          Text(
            '$duration | $deadline',
            style: TextStyle(
              fontSize: 11,
              color: Colors.grey.shade600,
            ),
          ),
        ],
      ),
    );
  }
  
  Widget _buildExportButton(String label, IconData icon, Color color, VoidCallback onTap) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(8),
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
        decoration: BoxDecoration(
          color: color.withOpacity(0.1),
          borderRadius: BorderRadius.circular(8),
          border: Border.all(color: color.withOpacity(0.3)),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 18, color: color),
            const SizedBox(width: 6),
            Text(
              label,
              style: TextStyle(
                fontSize: 12,
                fontWeight: FontWeight.w600,
                color: color,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 6.2 äº¤äº’ä¼˜åŒ–å¢å¼º

#### è¯­éŸ³è¾“å…¥æ”¯æŒ

```dart
// mobile/lib/presentation/widgets/chat/voice_input_button.dart
import 'package:flutter/material.dart';
import 'package:speech_to_text/speech_to_text.dart' as stt;

class VoiceInputButton extends StatefulWidget {
  final ValueChanged<String> onTranscript;
  
  const VoiceInputButton({super.key, required this.onTranscript});

  @override
  State<VoiceInputButton> createState() => _VoiceInputButtonState();
}

class _VoiceInputButtonState extends State<VoiceInputButton> 
    with SingleTickerProviderStateMixin {
  late stt.SpeechToText _speech;
  bool _isListening = false;
  String _lastWords = '';
  
  late AnimationController _animationController;
  
  @override
  void initState() {
    super.initState();
    _speech = stt.SpeechToText();
    _animationController = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 500),
    )..repeat(reverse: true);
  }
  
  @override
  void dispose() {
    _animationController.dispose();
    super.dispose();
  }
  
  void _startListening() async {
    if (!_isListening) {
      bool available = await _speech.initialize(
        onStatus: (status) => print('Status: $status'),
        onError: (error) => print('Error: $error'),
      );
      
      if (available) {
        setState(() => _isListening = true);
        _speech.listen(
          onResult: (result) {
            setState(() {
              _lastWords = result.recognizedWords;
            });
          },
          listenFor: const Duration(seconds: 30),
          pauseFor: const Duration(seconds: 5),
          partialResults: true,
          localeId: 'zh_CN',
        );
      }
    } else {
      _stopListening();
    }
  }
  
  void _stopListening() {
    _speech.stop();
    setState(() => _isListening = false);
    
    if (_lastWords.isNotEmpty) {
      widget.onTranscript(_lastWords);
      _lastWords = '';
    }
  }
  
  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _animationController,
      builder: (context, child) {
        return Container(
          width: 56,
          height: 56,
          decoration: BoxDecoration(
            shape: BoxShape.circle,
            color: _isListening ? Colors.red.shade600 : Colors.grey.shade200,
            boxShadow: _isListening
                ? [
                    BoxShadow(
                      color: Colors.red.shade200.withOpacity(0.5),
                      blurRadius: 20 * _animationController.value,
                      spreadRadius: 10 * _animationController.value,
                    ),
                  ]
                : [],
          ),
          child: IconButton(
            icon: Icon(
              _isListening ? Icons.mic : Icons.mic_none,
              color: _isListening ? Colors.white : Colors.grey.shade700,
            ),
            onPressed: _startListening,
            tooltip: _isListening ? 'åœæ­¢å½•éŸ³' : 'è¯­éŸ³è¾“å…¥',
          ),
        );
      },
    );
  }
}
```

#### æ‰‹åŠ¿æ§åˆ¶

```dart
// mobile/lib/presentation/widgets/chat/gesture_control_layer.dart
import 'package:flutter/material.dart';
import 'package:flutter/gestures.dart';

class GestureControlLayer extends StatefulWidget {
  final Widget child;
  final VoidCallback onSwipeLeft;
  final VoidCallback onSwipeRight;
  final VoidCallback onLongPress;
  
  const GestureControlLayer({
    super.key,
    required this.child,
    required this.onSwipeLeft,
    required this.onSwipeRight,
    required this.onLongPress,
  });

  @override
  State<GestureControlLayer> createState() => _GestureControlLayerState();
}

class _GestureControlLayerState extends State<GestureControlLayer> {
  Offset _startPosition = Offset.zero;
  bool _isLongPressing = false;
  
  @override
  Widget build(BuildContext context) {
    return GestureDetector(
      onHorizontalDragStart: (details) {
        _startPosition = details.globalPosition;
      },
      onHorizontalDragEnd: (details) {
        final delta = details.primaryVelocity ?? 0;
        
        if (delta < -500) {
          // å¿«é€Ÿå·¦æ»‘
          widget.onSwipeLeft();
          _showFeedback('åˆ‡æ¢Agent');
        } else if (delta > 500) {
          // å¿«é€Ÿå³æ»‘
          widget.onSwipeRight();
          _showFeedback('æŸ¥çœ‹æ¨ç†');
        }
      },
      onLongPressStart: (details) {
        setState(() => _isLongPressing = true);
        widget.onLongPress();
        _showFeedback('æ·±å…¥æ¢è®¨æ¨¡å¼');
      },
      onLongPressEnd: (details) {
        setState(() => _isLongPressing = false);
      },
      child: Stack(
        children: [
          widget.child,
          
          // æ‰‹åŠ¿æç¤º
          if (_isLongPressing)
            Positioned.fill(
              child: Container(
                color: Colors.black.withOpacity(0.3),
                child: Center(
                  child: Container(
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Column(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Icon(Icons.touch_app, size: 40, color: Colors.purple.shade600),
                        const SizedBox(height: 8),
                        Text(
                          'æ·±å…¥æ¢è®¨æ¨¡å¼',
                          style: TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.bold,
                            color: Colors.purple.shade600,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'æ¾å¼€ä»¥ç»§ç»­',
                          style: TextStyle(
                            fontSize: 12,
                            color: Colors.grey.shade600,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
        ],
      ),
    );
  }
  
  void _showFeedback(String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        duration: const Duration(seconds: 1),
        backgroundColor: Colors.purple.shade600,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(8),
        ),
      ),
    );
  }
}
```

#### ç¦»çº¿æ¨¡å¼æ”¯æŒ

```dart
// mobile/lib/core/services/offline_service.dart
import 'package:shared_preferences/shared_preferences.dart';
import 'package:hive/hive.dart';

class OfflineService {
  static const String _cacheBoxName = 'agent_cache';
  static const String _historyBoxName = 'collaboration_history';
  
  Future<void> init() async {
    // åˆå§‹åŒ–Hive
    if (!Hive.isBoxOpen(_cacheBoxName)) {
      await Hive.openBox(_cacheBoxName);
    }
    if (!Hive.isBoxOpen(_historyBoxName)) {
      await Hive.openBox(_historyBoxName);
    }
  }
  
  // ç¼“å­˜Agenté…ç½®
  Future<void> cacheAgentConfig(Map<String, dynamic> config) async {
    final box = Hive.box(_cacheBoxName);
    await box.put('agent_config', config);
  }
  
  Map<String, dynamic>? getCachedAgentConfig() {
    final box = Hive.box(_cacheBoxName);
    return box.get('agent_config');
  }
  
  // ç¼“å­˜åä½œå†å²
  Future<void> cacheCollaborationHistory(List<Map<String, dynamic>> history) async {
    final box = Hive.box(_historyBoxName);
    await box.put('history', history);
  }
  
  List<Map<String, dynamic>> getCachedCollaborationHistory() {
    final box = Hive.box(_historyBoxName);
    return List<Map<String, dynamic>>.from(box.get('history', defaultValue: []));
  }
  
  // ç¼“å­˜å¸¸ç”¨Agentæ¨¡å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
  Future<void> cacheAgentModels() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('agent_models_cached', true);
    await prefs.setInt('cache_timestamp', DateTime.now().millisecondsSinceEpoch);
  }
  
  Future<bool> isOfflineAvailable() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool('agent_models_cached') ?? false;
  }
  
  // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸï¼ˆ7å¤©ï¼‰
  Future<bool> isCacheValid() async {
    final prefs = await SharedPreferences.getInstance();
    final timestamp = prefs.getInt('cache_timestamp');
    if (timestamp == null) return false;
    
    final cacheTime = DateTime.fromMillisecondsSinceEpoch(timestamp);
    final now = DateTime.now();
    return now.difference(cacheTime).inDays < 7;
  }
  
  // æ¸…ç†è¿‡æœŸç¼“å­˜
  Future<void> cleanupExpiredCache() async {
    if (!(await isCacheValid())) {
      final box = Hive.box(_cacheBoxName);
      await box.clear();
      
      final prefs = await SharedPreferences.getInstance();
      await prefs.remove('agent_models_cached');
      await prefs.remove('cache_timestamp');
    }
  }
}

// ç¦»çº¿æ¨¡å¼UIç»„ä»¶
class OfflineModeIndicator extends StatelessWidget {
  const OfflineModeIndicator({super.key});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
      decoration: BoxDecoration(
        color: Colors.orange.shade100,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.orange.shade300),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(Icons.cloud_off, size: 16, color: Colors.orange.shade700),
          const SizedBox(width: 6),
          Text(
            'ç¦»çº¿æ¨¡å¼',
            style: TextStyle(
              fontSize: 12,
              fontWeight: FontWeight.w600,
              color: Colors.orange.shade700,
            ),
          ),
        ],
      ),
    );
  }
}
```

---

## ğŸ“… é˜¶æ®µä¸ƒï¼šå®æ–½è·¯çº¿å›¾

### Week 1-2: æ ¸å¿ƒAgenté‡æ„

#### åç«¯ä»»åŠ¡

**Day 1-2: ç¯å¢ƒå‡†å¤‡ä¸åŸºç¡€æ¶æ„**
```bash
# 1. åˆ›å»ºæ–°Agentç›®å½•ç»“æ„
mkdir -p backend/app/agents/{study_planner,problem_solver,code_review,essay_coach}

# 2. å®ç°å¢å¼ºç‰ˆåŸºç±»
# ä¿®æ”¹ backend/app/agents/base_agent.py
# æ·»åŠ  EnhancedAgentContext å’Œ EnhancedBaseAgent

# 3. åˆ›å»ºAgentæ³¨å†Œè¡¨æ›´æ–°
# ä¿®æ”¹ backend/app/agents/__init__.py
# æ·»åŠ æ–°Agentåˆ°æ³¨å†Œè¡¨
```

**Day 3-5: å®ç°StudyPlannerAgent**
```python
# backend/app/agents/study_planner_agent.py
# æ ¸å¿ƒåŠŸèƒ½ï¼š
# 1. è·å–ç”¨æˆ·çŸ¥è¯†çŠ¶æ€
# 2. åˆ†æé—å¿˜æ›²çº¿
# 3. ç”Ÿæˆä¼˜åŒ–è®¡åˆ’

# é›†æˆç‚¹ï¼š
# - KnowledgeService.get_user_knowledge_graph()
# - UserService.get_forgetting_curve()
# - UserService.get_exam_schedule()
```

**Day 6-8: å®ç°ProblemSolverAgent**
```python
# backend/app/agents/problem_solver_agent.py
# æ ¸å¿ƒåŠŸèƒ½ï¼š
# 1. é—®é¢˜ç±»å‹åˆ†æ
# 2. è‹æ ¼æ‹‰åº•å¼å¼•å¯¼
# 3. çŸ¥è¯†ç‚¹å…³è”

# é›†æˆç‚¹ï¼š
# - GraphKnowledgeService.graph_rag_search()
# - ç”Ÿæˆå¼•å¯¼å¼é—®é¢˜åºåˆ—
```

**Day 9-10: å®ç°CodeReviewAgentå’ŒEssayCoachAgent**
```python
# backend/app/agents/code_review_agent.py
# backend/app/agents/essay_coach_agent.py
# ä¸“æ³¨å„è‡ªé¢†åŸŸï¼Œæä¾›æ•™å­¦å¼åé¦ˆ
```

#### å‰ç«¯ä»»åŠ¡

**Day 1-5: UIç»„ä»¶å‡†å¤‡**
```dart
// 1. æ›´æ–°ç°æœ‰ç»„ä»¶æ”¯æŒæ–°Agentç±»å‹
// mobile/lib/presentation/widgets/chat/agent_avatar_stack.dart
// mobile/lib/presentation/widgets/chat/agent_reasoning_bubble.dart

// 2. åˆ›å»ºæ•°æ®æ¨¡å‹
// mobile/lib/data/models/agent_model.dart
class AgentModel {
  final String type;
  final String name;
  final IconData icon;
  final Color color;
  final String description;
  final List<String> capabilities;
}
```

**Day 6-10: é›†æˆæµ‹è¯•**
- è¿æ¥åç«¯æ–°Agentæ¥å£
- æµ‹è¯•ä¸Šä¸‹æ–‡ä¼ é€’
- éªŒè¯å“åº”æ ¼å¼

### Week 3-4: åä½œæµç¨‹å‡çº§

#### åç«¯ä»»åŠ¡

**Day 1-3: åä½œå·¥ä½œæµæ¡†æ¶**
```python
# backend/app/agents/collaboration_workflow.py
# å®ç°ä¸‰ç§åä½œæ¨¡å¼åŸºç±»
class BaseWorkflow:
    async def execute(self, query: str, context: EnhancedAgentContext) -> CollaborationResult:
        pass

class TaskDecompositionWorkflow(BaseWorkflow):
    # ä»»åŠ¡åˆ†è§£é€»è¾‘

class ProgressiveExplorationWorkflow(BaseWorkflow):
    # æ¸è¿›æ¢ç´¢é€»è¾‘

class ErrorDiagnosisWorkflow(BaseWorkflow):
    # é”™é¢˜è¯Šæ–­é€»è¾‘
```

**Day 4-6: å¢å¼ºOrchestrator**
```python
# backend/app/agents/orchestrator_agent.py
# ä¿®æ”¹ä¸»è¦æµç¨‹ï¼š
# 1. æ„å›¾è¯†åˆ« â†’ é€‰æ‹©å·¥ä½œæµ
# 2. æ„å»ºå¢å¼ºä¸Šä¸‹æ–‡
# 3. æ‰§è¡Œåä½œ
# 4. ç”Ÿæˆç»Ÿä¸€å“åº”
```

**Day 7-10: Agenté—´å¯¹è¯æœºåˆ¶**
```python
# å®ç°å¤šè½®å¯¹è¯æ”¯æŒ
# 1. å¯¹è¯å†å²ç®¡ç†
# 2. ä¸Šä¸‹æ–‡ä¼ é€’
# 3. å…±è¯†/åˆ†æ­§å¤„ç†
```

#### å‰ç«¯ä»»åŠ¡

**Day 1-7: åä½œå¯è§†åŒ–ç»„ä»¶**
```dart
// 1. Agentåä½œæ—¶é—´çº¿
// mobile/lib/presentation/widgets/chat/agent_collaboration_timeline.dart

// 2. æ€ç»´å¯¼å›¾ç”Ÿæˆå™¨
// mobile/lib/presentation/widgets/chat/mindmap_viewer.dart

// 3. å­¦ä¹ è¿›åº¦é¢æ¿
// mobile/lib/presentation/widgets/chat/learning_progress_panel.dart
```

**Day 8-10: çŠ¶æ€ç®¡ç†**
```dart
// åˆ›å»ºMultiAgentChatProvider
// ç®¡ç†ï¼š
// - åä½œçŠ¶æ€
// - Agentè¿›åº¦
// - å¯è§†åŒ–æ•°æ®
```

### Week 5-6: å¯è§†åŒ–ä½“éªŒå‡çº§

#### åç«¯ä»»åŠ¡

**Day 1-5: å¯è§†åŒ–æ•°æ®æ ¼å¼**
```python
# å®šä¹‰æ ‡å‡†å¯è§†åŒ–æ•°æ®ç»“æ„
@dataclass
class VisualizationData:
    timeline: List[AgentStep]
    mindmap: MindMapData
    progress: LearningProgressData
    
# åœ¨AgentResponseä¸­æ·»åŠ visualizationå­—æ®µ
```

**Day 6-10: æ€§èƒ½ä¼˜åŒ–**
```python
# 1. å¹¶è¡Œå¤„ç†ä¼˜åŒ–
# 2. ç¼“å­˜ç­–ç•¥
# 3. æµå¼å“åº”æ”¯æŒ
```

#### å‰ç«¯ä»»åŠ¡

**Day 1-10: å®Œæ•´UIå®ç°**
```dart
// 1. MultiAgentChatScreenä¸»ç•Œé¢
// 2. äº¤äº’å¼å­¦ä¹ æ¨¡å¼åˆ‡æ¢
// 3. æ‰‹åŠ¿æ§åˆ¶å±‚
// 4. è¯­éŸ³è¾“å…¥é›†æˆ
// 5. ç¦»çº¿æ¨¡å¼æ”¯æŒ
```

### Week 7-8: æ·±åº¦é›†æˆä¸æµ‹è¯•

#### ç³»ç»Ÿé›†æˆ

**ä»»åŠ¡å¡ç³»ç»Ÿ**
```python
# backend/app/services/task_integration_service.py
# å®ç°ï¼š
# 1. ä»åä½œç»“æœåˆ›å»ºä»»åŠ¡
# 2. å­¦ä¹ è®¡åˆ’ä»»åŠ¡åºåˆ—
# 3. åé¦ˆé©±åŠ¨çš„ä»»åŠ¡æ›´æ–°
```

**æ¨é€ç³»ç»Ÿ**
```python
# backend/app/services/intelligent_push_service.py
# å®ç°ï¼š
# 1. åŸºäºåä½œç»“æœçš„æ¨é€ç”Ÿæˆ
# 2. é—å¿˜æ›²çº¿æé†’
# 3. ä¸ªæ€§åŒ–æ—¶æœºé€‰æ‹©
```

**ç¤¾ç¾¤å¢å¼º**
```python
# backend/app/services/community_enhancement_service.py
# å®ç°ï¼š
# 1. è®¨è®ºä¸»é¢˜åˆ†æ
# 2. å¤šè§‚ç‚¹ç”Ÿæˆ
# 3. å­¦ä¹ å»ºè®®
```

#### æµ‹è¯•ç­–ç•¥

**å•å…ƒæµ‹è¯•**
```python
# æµ‹è¯•æ¯ä¸ªAgentçš„ç‹¬ç«‹åŠŸèƒ½
# æµ‹è¯•åä½œå·¥ä½œæµ
# æµ‹è¯•ä¸Šä¸‹æ–‡ä¼ é€’
```

**é›†æˆæµ‹è¯•**
```python
# æµ‹è¯•å®Œæ•´åä½œæµç¨‹
# æµ‹è¯•ä¸ä»»åŠ¡å¡ç³»ç»Ÿé›†æˆ
# æµ‹è¯•æ¨é€ç³»ç»Ÿé›†æˆ
```

**ç”¨æˆ·æµ‹è¯•**
```python
# A/Bæµ‹è¯•ï¼š
# - ä¼ ç»Ÿå•Agent vs å¤šAgent
# - ä¸åŒåä½œæ¨¡å¼æ•ˆæœ
# - ç”¨æˆ·æ»¡æ„åº¦è°ƒæŸ¥
```

---

## ğŸ¯ é¢„æœŸæˆæœä¸KPI

### ç”¨æˆ·ä½“éªŒæå‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æå‡å¹…åº¦ |
|------|------|------|----------|
| å¯¹è¯æ»¡æ„åº¦ | 3.8/5 | 4.5/5 | +18% |
| ä»»åŠ¡å®Œæˆç‡ | 62% | 85% | +37% |
| æ—¥å‡å¯¹è¯æ¬¡æ•° | 2.3 | 5.1 | +122% |
| 7æ—¥ç•™å­˜ç‡ | 45% | 68% | +51% |
| å¹³å‡å­¦ä¹ æ—¶é•¿ | 15åˆ†é’Ÿ | 28åˆ†é’Ÿ | +87% |

### ä¸šåŠ¡ä»·å€¼

**çŸ­æœŸï¼ˆ1ä¸ªæœˆï¼‰**
- ç”¨æˆ·æ´»è·ƒåº¦æå‡ 50%
- å¯¹è¯æ·±åº¦å¢åŠ  2å€
- ä»»åŠ¡åˆ›å»ºé‡æå‡ 3å€

**ä¸­æœŸï¼ˆ3ä¸ªæœˆï¼‰**
- ç”¨æˆ·ç•™å­˜ç‡æå‡è‡³ 70%
- NPSï¼ˆå‡€æ¨èå€¼ï¼‰è¾¾åˆ° 50+
- ç¤¾ç¾¤æ´»è·ƒåº¦æå‡ 2å€

**é•¿æœŸï¼ˆ6ä¸ªæœˆï¼‰**
- æˆä¸ºå¤§å­¦ç”Ÿé¦–é€‰AIå­¦ä¹ åŠ©æ‰‹
- å»ºç«‹æ•™è‚²AIé¢†åŸŸæ ‡æ†
- ä¸ºç«èµ›è·å¥–å¥ å®šåŸºç¡€

---

## ğŸ’¡ å…³é”®æˆåŠŸè¦ç´ 

### 1. æ•™è‚²å¯¼å‘ä¼˜å…ˆ
- âœ… æ‰€æœ‰Agentå›´ç»•"å¸®åŠ©å­¦ç”Ÿå­¦ä¹ "è®¾è®¡
- âœ… é¿å…è¿‡åº¦æŠ€æœ¯åŒ–ï¼Œæ³¨é‡æ•™å­¦æ•ˆæœ
- âœ… ç»“åˆé—å¿˜æ›²çº¿ã€æŒæ¡åº¦ç­‰æ•™è‚²ç†è®º

### 2. é€æ˜åº¦ä¸ä¿¡ä»»
- âœ… è®©ç”¨æˆ·çœ‹åˆ°AIçš„æ€è€ƒè¿‡ç¨‹
- âœ… æä¾›å¯éªŒè¯çš„æ¨ç†é“¾æ¡
- âœ… å»ºç«‹AIä¸ç”¨æˆ·çš„ä¿¡ä»»å…³ç³»

### 3. ä¸ªæ€§åŒ–æ·±åº¦
- âœ… æ·±åº¦é›†æˆç”¨æˆ·æ•°æ®
- âœ… åŠ¨æ€è°ƒæ•´éš¾åº¦å’Œç­–ç•¥
- âœ… å­¦ä¹ æ¨¡å¼æŒç»­ä¼˜åŒ–

### 4. æ€§èƒ½ä¸ä½“éªŒ
- âœ… å¤šAgentå¹¶è¡Œå¤„ç†ï¼Œç¡®ä¿å“åº”é€Ÿåº¦
- âœ… æµå¼ä¼ è¾“ï¼Œå®æ—¶åé¦ˆ
- âœ… ç¦»çº¿æ”¯æŒï¼Œæå‡å¯ç”¨æ€§

### 5. å¯æ‰©å±•æ€§
- âœ… æ¨¡å—åŒ–æ¶æ„ï¼Œæ˜“äºæ–°å¢Agent
- âœ… æ ‡å‡†åŒ–æ¥å£ï¼Œä¾¿äºç³»ç»Ÿé›†æˆ
- âœ… é…ç½®åŒ–ç­–ç•¥ï¼Œæ”¯æŒå¿«é€Ÿè¿­ä»£

---

## ğŸš€ ç«‹å³è¡ŒåŠ¨æ¸…å•

### æœ¬å‘¨å†…å®Œæˆï¼ˆP0ï¼‰

**åç«¯**
- [ ] å®¡æŸ¥ç°æœ‰Agentä»£ç ï¼Œè¯†åˆ«éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†
- [ ] å®šä¹‰EnhancedAgentContextæ•°æ®ç»“æ„
- [ ] åˆ›å»ºStudyPlannerAgentéª¨æ¶
- [ ] æ›´æ–°requirements.txtï¼Œæ·»åŠ å¿…è¦ä¾èµ–

**å‰ç«¯**
- [ ] å®¡æŸ¥ç°æœ‰UIç»„ä»¶ï¼Œåˆ—å‡ºéœ€è¦æ‰©å±•çš„éƒ¨åˆ†
- [ ] åˆ›å»ºAgentæ•°æ®æ¨¡å‹
- [ ] è®¾è®¡MultiAgentChatScreenè‰å›¾
- [ ] å‡†å¤‡Flutterå¼€å‘ç¯å¢ƒ

**æ–‡æ¡£**
- [ ] åˆ›å»ºè¯¦ç»†çš„æŠ€æœ¯è®¾è®¡æ–‡æ¡£
- [ ] å®šä¹‰APIæ¥å£è§„èŒƒ
- [ ] å‡†å¤‡æµ‹è¯•ç”¨ä¾‹

### ä¸‹å‘¨å®Œæˆï¼ˆP1ï¼‰

**åç«¯**
- [ ] å®ç°StudyPlannerAgentæ ¸å¿ƒé€»è¾‘
- [ ] å®ç°ProblemSolverAgentæ ¸å¿ƒé€»è¾‘
- [ ] å¢å¼ºOrchestratoræ”¯æŒåä½œæ¨¡å¼
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**å‰ç«¯**
- [ ] å®ç°AgentCollaborationTimeline
- [ ] å®ç°MindMapVieweråŸºç¡€ç‰ˆ
- [ ] åˆ›å»ºMultiAgentChatProvider
- [ ] é›†æˆæ–°Agentæ¥å£

---

## ğŸ“ éœ€è¦åè°ƒçš„èµ„æº

### æŠ€æœ¯èµ„æº
- **åç«¯å¼€å‘**ï¼šPython/Goå¼€å‘äººå‘˜ï¼ˆ2äººï¼‰
- **å‰ç«¯å¼€å‘**ï¼šFlutterå¼€å‘äººå‘˜ï¼ˆ1-2äººï¼‰
- **è®¾è®¡æ”¯æŒ**ï¼šUI/UXè®¾è®¡å¸ˆï¼ˆ1äººï¼‰
- **æµ‹è¯•èµ„æº**ï¼šQAå·¥ç¨‹å¸ˆï¼ˆ1äººï¼‰

### æ•°æ®èµ„æº
- **ç”¨æˆ·å­¦ä¹ æ•°æ®**ï¼šéœ€è¦è®¿é—®çŸ¥è¯†å›¾è°±ã€é—å¿˜æ›²çº¿æ•°æ®
- **ä»»åŠ¡å†å²**ï¼šéœ€è¦ä»»åŠ¡å¡ç³»ç»Ÿæ•°æ®æ¥å£
- **ç¤¾ç¾¤æ•°æ®**ï¼šéœ€è¦ç¤¾ç¾¤ç³»ç»ŸAPIæ”¯æŒ

### æ—¶é—´èµ„æº
- **å¼€å‘å‘¨æœŸ**ï¼š8å‘¨å®Œæ•´å‘¨æœŸ
- **æµ‹è¯•å‘¨æœŸ**ï¼š2å‘¨å¹¶è¡Œæµ‹è¯•
- **è¿­ä»£ä¼˜åŒ–**ï¼šæŒç»­è¿›è¡Œ

---

## ğŸ“Š é£é™©è¯„ä¼°ä¸åº”å¯¹

### é£é™©1ï¼šå¤šAgentå“åº”å»¶è¿Ÿ
**å½±å“**ï¼šç”¨æˆ·ä½“éªŒä¸‹é™
**åº”å¯¹**ï¼š
- å¹¶è¡Œå¤„ç†ä¼˜åŒ–
- æµå¼å“åº”
- ç¼“å­˜ç­–ç•¥

### é£é™©2ï¼šä¸Šä¸‹æ–‡ä¿¡æ¯è¿‡è½½
**å½±å“**ï¼šAgentå†³ç­–è´¨é‡ä¸‹é™
**åº”å¯¹**ï¼š
- ContextPrunerä¼˜åŒ–
- æ™ºèƒ½ä¸Šä¸‹æ–‡é€‰æ‹©
- åˆ†å±‚ä¸Šä¸‹æ–‡ç®¡ç†

### é£é™©3ï¼šç³»ç»Ÿé›†æˆå¤æ‚åº¦
**å½±å“**ï¼šå»¶æœŸé£é™©
**åº”å¯¹**ï¼š
- åˆ†é˜¶æ®µé›†æˆ
- å……åˆ†çš„å•å…ƒæµ‹è¯•
- ç°åº¦å‘å¸ƒç­–ç•¥

### é£é™©4ï¼šç”¨æˆ·æ¥å—åº¦ä¸ç¡®å®š
**å½±å“**ï¼šåŠŸèƒ½ä½¿ç”¨ç‡ä½
**åº”å¯¹**ï¼š
- A/Bæµ‹è¯•
- æ¸è¿›å¼åŠŸèƒ½å‘å¸ƒ
- ç”¨æˆ·æ•™è‚²å’Œå¼•å¯¼

---

## ğŸ‰ æˆåŠŸæ ‡å‡†

### åŠŸèƒ½å®Œæˆåº¦
- [ ] 4ä¸ªæ–°Agentå®Œæ•´å®ç°
- [ ] 3ç§åä½œæ¨¡å¼å¯ç”¨
- [ ] å‰ç«¯UIç»„ä»¶å®Œæ•´
- [ ] ä¸ç°æœ‰ç³»ç»Ÿé›†æˆå®Œæˆ

### è´¨é‡æ ‡å‡†
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ > 95%
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡ï¼ˆå“åº” < 2sï¼‰
- [ ] ç”¨æˆ·æ»¡æ„åº¦ > 4.0/5.0

### ä¸šåŠ¡æŒ‡æ ‡
- [ ] æ—¥æ´»ç”¨æˆ·æå‡ 50%
- [ ] å¯¹è¯æ·±åº¦æå‡ 2å€
- [ ] ä»»åŠ¡å®Œæˆç‡æå‡ 30%
- [ ] ç”¨æˆ·ç•™å­˜ç‡æå‡ 20%

---

## ğŸ“ æ€»ç»“

è¿™ä»½æ”¹è¿›æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯å°†Sparkleçš„å¤šAgentç³»ç»Ÿä»ä¸€ä¸ª**æŠ€æœ¯å±•ç¤ºåŠŸèƒ½**è½¬å˜ä¸º**å­¦ç”Ÿå­¦ä¹ çš„æ ¸å¿ƒä»·å€¼é©±åŠ¨å™¨**ã€‚

é€šè¿‡ï¼š
1. **æ•™è‚²å¯¼å‘çš„Agentèƒ½åŠ›é‡æ„**
2. **çœŸæ­£çš„å¤šAgentåä½œæµç¨‹**
3. **é€æ˜åŒ–çš„å­¦ä¹ è¿‡ç¨‹å¯è§†åŒ–**
4. **æ·±åº¦ä¸ªæ€§åŒ–é›†æˆ**
5. **æ— ç¼çš„ç³»ç»Ÿè”åŠ¨**

æˆ‘ä»¬èƒ½å¤Ÿä¸ºå¤§å­¦ç”Ÿæä¾›ä¸€ä¸ªå‰æ‰€æœªæœ‰çš„AIå­¦ä¹ ä½“éªŒï¼š**ä¸€ä¸ªç”±ä¸“ä¸šAIå¯¼å¸ˆç»„æˆçš„å›¢é˜Ÿï¼ŒååŒå·¥ä½œï¼Œé€æ˜æ€è€ƒï¼Œä¸ªæ€§åŒ–æŒ‡å¯¼ï¼ŒçœŸæ­£å¸®åŠ©å­¦ç”Ÿæå‡å­¦ä¹ æ•ˆç‡**ã€‚

è¿™ä¸ä»…ä»…æ˜¯æŠ€æœ¯çš„å‡çº§ï¼Œæ›´æ˜¯å­¦ä¹ æ–¹å¼çš„é©æ–°ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**æœ€åæ›´æ–°**ï¼š2025-12-27  
**ä½œè€…**ï¼šSparkle AI å›¢é˜Ÿ  
**çŠ¶æ€**ï¼šå¾…è¯„å®¡ä¸å®æ–½