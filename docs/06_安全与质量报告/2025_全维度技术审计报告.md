# Sparkle (星火) 项目全维度技术审计与改进报告 (2025版)

## 1. 核心综述 (Executive Summary)
Sparkle 项目是一个架构设计极具前瞻性的 AI 学习助手。项目成功结合了 **Go (高性能网关/并发处理)** 与 **Python (LLM 编排/RAG 逻辑)** 的优势，并配合 **Flutter** 实现了高质量的多端体验。
*   **当前评估**: 技术栈选型非常现代，核心业务（如多 Agent 协作、语义缓存、上下文剪裁）已具备 P0 级稳定性。
*   **核心改进方向**: 提升跨语言协议的一致性管理、增强 AI 回答的量化评测体系、完善 CI/CD 的静态质量闸门。

---

## 2. 深度架构审查 (Architecture Deep-Dive)

### 2.1 混合架构与通信
*   **优势**: 采用 gRPC 进行后端通信，确保了跨语言调用的强类型约束。Go Gateway 实现了高效的 WebSocket 状态维护。
*   **改进建议**:
    *   **Protocol Management**: 目前使用 `Makefile` 手动触发 `proto-gen`。建议引入 **Buf** (buf.build) 进行 Protobuf 的版本控制、Linter 和 Breaking Change 检测。
    *   **Load Balancing**: 随着 Python 实例增加，需在 Go Gateway 端实现 gRPC 客户端负载均衡（目前的 `AGENT_ADDRESS` 多为单点配置）。

### 2.2 数据持久化与缓存
*   **优势**: 使用 **pgvector** 进行向量检索，配合 Redis 缓存 LLM 响应，极大地降低了 Token 成本和响应时延。
*   **改进建议**:
    *   **Vector Indexing**: 确保 `knowledge_nodes` 表在大数据量下建立了 `HNSW` 索引（而非默认的线性扫描）。
    *   **Hot-Cold Data Separation**: 随着用户增长，`chat_messages` 表需考虑按月分表或冷热分离，避免大表查询性能下降。

---

## 3. 后端细节审查 (Go & Python)

### 3.1 Python AI Engine (FastAPI)
*   **代码质量**: 
    *   **清理 Lifespan**: `app/main.py` 中同时混用 `lifespan` 和 `on_event("startup")`。根据 FastAPI 最新规范，应完全迁移至 `lifespan` 以确保资源的确定性释放。
    *   **依赖管理**: 建议从 `requirements.txt` 迁移至 **uv** 或 **Poetry**。`uv` 能极大地缩短容器构建时间并提供严格的 Lockfile。
*   **安全性**:
    *   **日志脱敏**: `loguru` 配置需增加拦截器，自动屏蔽日志中的 JWT Token 或 LLM 原始 API Key。

### 3.2 Go Gateway (Gin)
*   **并发处理**: WebSocket 消息处理中，建议引入 `sync.Pool` 缓存高频申请的 `Message` 对象，降低 GC 压力。
*   **错误模型**: 目前 Go 与 Python 之间的错误码尚未完全对齐。建议定义一套标准的业务错误码（Business Error Code），在 gRPC 的 `Trailing Metadata` 中传递。

---

## 4. 移动端审查 (Flutter)

### 4.1 状态管理与渲染
*   **优势**: Riverpod 2.x 的响应式驱动非常成熟。Custom Shaders 的使用使 Galaxy View 具备了独特的视觉竞争力。
*   **改进建议**:
    *   **Shader Performance**: 针对低端设备（如 Android 入门机型），需在 `GalaxyPainter` 中增加降级逻辑，减少 GPU 计算负载。
    *   **Memory Management**: 检查图片和 Lottie 资源的缓存策略，确保在页面销毁时及时调用 `dispose()`。

---

## 5. AI 与 RAG 系统专项

*   **现状**: 已实现 `ContextPruner` (P0) 和 `TokenTracker` (P1)。
*   **改进方向**:
    *   **RAG 评测**: 引入 **Ragas** 评测框架。目前缺乏对知识库检索准确率（Faithfulness/Relevance）的量化指标。
    *   **GraphRAG 增强**: 当前图谱关联较为初级，建议引入 **NetworkX** 在 Python 端进行二阶关联路径搜索，以提供更深度的知识解释。

---

## 6. 质量、安全与 CI/CD

### 6.1 CI/CD 增强
*   **现状**: 仅覆盖后端测试。
*   **改进项**:
    *   **Flutter CI**: 增加 `flutter test` 和 `flutter analyze` 步骤。
    *   **Security Scan**: 在 CI 中加入 `gitleaks` (扫描泄露密钥) 和 `bandit` (Python 安全扫描)。
    *   **Static Analysis**: 加入 `ruff check --fix` 以保持 Python 代码风格高度统一。

### 6.2 观测性 (Observability)
*   **现状**: 已集成 Prometheus/Tempo/Loki。
*   **改进建议**: 针对 LLM 调用，在 Grafana 中建立专门的 **Cost Dashboard**，基于 `TokenTracker` 的数据实时监控各用户的消费分布。

---

## 7. 改进路线图 (Improvement Roadmap)

| 阶段 | 目标 | 核心任务 |
| :--- | :--- | :--- |
| **Phase 1 (短期)** | **稳定性与质量** | 迁移 Lifespan、引入 Buf 管理 Proto、补齐 Flutter CI |
| **Phase 2 (中期)** | **AI 效能优化** | 建立 Ragas 评测、实现 Vector HNSW 索引、增强语义缓存命中率 |
| **Phase 3 (长期)** | **规模化与安全** | 实现分布式 gRPC 负载均衡、引入 Secrets 管理服务、全链路成本追踪 |

---
**审计人**: Sparkle Agent
**日期**: 2025年12月28日
