# Sparkle ç”Ÿäº§éƒ¨ç½²æŒ‡å—

> **ç‰ˆæœ¬**: v1.0
> **çŠ¶æ€**: Production Ready
> **æœ€åæ›´æ–°**: 2025-12-27

---

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### âœ… éƒ¨ç½²å‰æ£€æŸ¥

- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ
- [ ] æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- [ ] Redis æœåŠ¡å¯ç”¨
- [ ] SSL è¯ä¹¦å·²é…ç½®
- [ ] ç›‘æ§ç³»ç»Ÿå·²å°±ç»ª
- [ ] å¤‡ä»½ç­–ç•¥å·²åˆ¶å®š
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡

---

## ğŸ”§ ç¯å¢ƒé…ç½®

### 1. æ ¸å¿ƒç¯å¢ƒå˜é‡

åˆ›å»º `.env.production` æ–‡ä»¶ï¼š

```bash
# ==================== æ ¸å¿ƒé…ç½® ====================
APP_NAME=Sparkle
APP_VERSION=0.3.0
DEBUG=false

# ==================== ç½‘ç»œé…ç½® ====================
GRPC_PORT=50051
HTTP_PORT=8000
GATEWAY_PORT=8080
BACKEND_CORS_ORIGINS=["https://your-domain.com"]

# ==================== æ•°æ®åº“é…ç½® ====================
DATABASE_URL=postgresql://user:password@host:5432/sparkle
DB_POOL_SIZE=20
DB_MAX_OVERFLOW=30

# ==================== Redis é…ç½® ====================
REDIS_URL=redis://localhost:6379/0
REDIS_POOL_SIZE=50

# ==================== LLM é…ç½® ====================
LLM_PROVIDER=deepseek
LLM_API_BASE_URL=https://api.deepseek.com/v1
LLM_API_KEY=sk-xxx
LLM_MODEL_NAME=deepseek-chat
LLM_TIMEOUT=60

# ==================== å®‰å…¨é…ç½® ====================
SECRET_KEY=your-very-long-secret-key-min-32-chars
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440

# ==================== æ€§èƒ½é…ç½® ====================
MAX_CONCURRENT_SESSIONS=100
CIRCUIT_BREAKER_THRESHOLD=5
CIRCUIT_BREAKER_TIMEOUT=60
DAILY_QUOTA=100000

# ==================== æ—¥å¿—é…ç½® ====================
LOG_LEVEL=INFO
LOG_FORMAT=json
LOG_FILE=/var/log/sparkle/app.log

# ==================== ç›‘æ§é…ç½® ====================
ENABLE_METRICS=true
ENABLE_TRACING=true
```

### 2. é…ç½®éªŒè¯

```bash
cd backend
python -m app.config_production
```

---

## ğŸ³ Docker éƒ¨ç½²

### 1. Docker Compose é…ç½®

```yaml
# docker-compose.production.yml
version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: sparkle
      POSTGRES_USER: sparkle
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sparkle"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Python gRPC Server
  grpc-server:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://sparkle:${DB_PASSWORD}@postgres:5432/sparkle
      - REDIS_URL=redis://redis:6379/0
      - ${ENV_FILE}
    command: python grpc_server.py
    ports:
      - "50051:50051"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # Go Gateway
  gateway:
    build:
      context: ./backend/gateway
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://sparkle:${DB_PASSWORD}@postgres:5432/sparkle
      - REDIS_URL=redis://redis:6379/0
      - AGENT_ADDRESS=grpc-server:50051
      - ${ENV_FILE}
    ports:
      - "8080:8080"
    depends_on:
      - grpc-server
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # Python Backend (REST API)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=postgresql://sparkle:${DB_PASSWORD}@postgres:5432/sparkle
      - REDIS_URL=redis://redis:6379/0
      - ${ENV_FILE}
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  # Grafana
  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    ports:
      - "3000:3000"
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:
```

### 2. éƒ¨ç½²å‘½ä»¤

```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export ENV_FILE=.env.production
export DB_PASSWORD=your_secure_password
export GRAFANA_PASSWORD=your_grafana_password

# 2. æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.production.yml up -d --build

# 3. æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.production.yml logs -f

# 4. æ£€æŸ¥çŠ¶æ€
docker-compose -f docker-compose.production.yml ps
```

---

## ğŸš€ Systemd éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

### 1. Python gRPC Server

```ini
# /etc/systemd/system/sparkle-grpc.service
[Unit]
Description=Sparkle gRPC Server
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=sparkle
Group=sparkle
WorkingDirectory=/opt/sparkle/backend
Environment=PATH=/opt/sparkle/backend/venv/bin
Environment=DATABASE_URL=postgresql://sparkle:password@localhost:5432/sparkle
Environment=REDIS_URL=redis://localhost:6379/0
EnvironmentFile=/opt/sparkle/.env.production
ExecStart=/opt/sparkle/backend/venv/bin/python grpc_server.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 2. Go Gateway

```ini
# /etc/systemd/system/sparkle-gateway.service
[Unit]
Description=Sparkle Go Gateway
After=network.target sparkle-grpc.service

[Service]
Type=simple
User=sparkle
Group=sparkle
WorkingDirectory=/opt/sparkle/backend/gateway
EnvironmentFile=/opt/sparkle/.env.production
ExecStart=/opt/sparkle/backend/gateway/bin/gateway
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

### 3. å¯åŠ¨æœåŠ¡

```bash
sudo systemctl daemon-reload
sudo systemctl enable sparkle-grpc sparkle-gateway
sudo systemctl start sparkle-grpc sparkle-gateway

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status sparkle-grpc
sudo systemctl status sparkle-gateway

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u sparkle-grpc -f
sudo journalctl -u sparkle-gateway -f
```

---

## ğŸ“Š ç›‘æ§é…ç½®

### 1. Prometheus é…ç½®

```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'sparkle-backend'
    static_configs:
      - targets: ['backend:8000']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'sparkle-gateway'
    static_configs:
      - targets: ['gateway:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s

  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:5432']
    scrape_interval: 30s

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']
    scrape_interval: 15s
```

### 2. å‘Šè­¦è§„åˆ™

```yaml
# monitoring/alert_rules.yml
groups:
  - name: sparkle_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"

      - alert: CircuitBreakerOpen
        expr: chat_orchestrator_circuit_breaker == 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Circuit breaker is open"

      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes > 2 * 1024 * 1024 * 1024
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Memory usage exceeds 2GB"

      - alert: QueueBacklog
        expr: redis_queue_length > 500
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Queue backlog detected"
```

---

## ğŸ” å¥åº·æ£€æŸ¥

### 1. API ç«¯ç‚¹

```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl https://api.your-domain.com/api/v1/health

# è¯¦ç»†å¥åº·æ£€æŸ¥
curl https://api.your-domain.com/api/v1/health/detailed

# å°±ç»ªæ£€æŸ¥ï¼ˆK8sï¼‰
curl https://api.your-domain.com/api/v1/health/ready

# å­˜æ´»æ£€æŸ¥ï¼ˆK8sï¼‰
curl https://api.your-domain.com/api/v1/health/live

# é˜Ÿåˆ—çŠ¶æ€
curl https://api.your-domain.com/api/v1/health/queue/status

# Prometheus æŒ‡æ ‡
curl https://api.your-domain.com/api/v1/health/metrics
```

### 2. ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# health-check.sh

URL="https://api.your-domain.com/api/v1/health"
ALERT_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK"

while true; do
    RESPONSE=$(curl -s -w "\n%{http_code}" $URL)
    HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
    BODY=$(echo "$RESPONSE" | sed '$d')

    if [ "$HTTP_CODE" != "200" ]; then
        curl -X POST $ALERT_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d "{\"text\":\"ğŸš¨ Health check failed: $HTTP_CODE\"}"
    fi

    sleep 60
done
```

---

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### 1. Nginx åå‘ä»£ç†

```nginx
# /etc/nginx/sites-available/sparkle
server {
    listen 80;
    server_name api.your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.your-domain.com;

    # SSL é…ç½®
    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # WebSocket æ”¯æŒ
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # Gateway (WebSocket + API)
    location /ws/chat {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    location /api/v1 {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Python Backend (Direct access if needed)
    location /docs {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
    }

    location /uploads {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
    }

    # Health check endpoint
    location /health {
        access_log off;
        proxy_pass http://localhost:8080/api/v1/health;
        proxy_set_header Host $host;
    }
}
```

### 2. é˜²ç«å¢™è§„åˆ™

```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw allow 5432/tcp  # PostgreSQL (internal only)
ufw allow 6379/tcp  # Redis (internal only)
ufw enable
```

---

## ğŸ“ˆ æ€§èƒ½è°ƒä¼˜

### 1. PostgreSQL è°ƒä¼˜

```conf
# /etc/postgresql/16/main/postgresql.conf

# è¿æ¥è®¾ç½®
max_connections = 200
shared_buffers = 2GB
effective_cache_size = 6GB

# æ—¥å¿—
log_min_duration_statement = 500
log_checkpoints = on
log_connections = on
log_disconnections = on

# è‡ªåŠ¨æ¸…ç†
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 15s
```

### 2. Redis è°ƒä¼˜

```conf
# /etc/redis/redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
tcp-keepalive 300
timeout 300
```

### 3. ç³»ç»Ÿè°ƒä¼˜

```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# TCP è°ƒä¼˜
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 2048" >> /etc/sysctl.conf
sysctl -p
```

---

## ğŸ”„ éƒ¨ç½²æµç¨‹

### 1. è“ç»¿éƒ¨ç½²

```bash
# 1. éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°ç»¿è‰²ç¯å¢ƒ
docker-compose -f docker-compose.green.yml up -d

# 2. å¥åº·æ£€æŸ¥
./health-check.sh green

# 3. æµé‡åˆ‡æ¢ï¼ˆNginxï¼‰
# ä¿®æ”¹ Nginx é…ç½®ï¼Œå°†æµé‡ä»è“è‰²åˆ‡æ¢åˆ°ç»¿è‰²

# 4. ç›‘æ§æŒ‡æ ‡
# è§‚å¯Ÿ 15-30 åˆ†é’Ÿï¼Œç¡®è®¤æ— å¼‚å¸¸

# 5. ä¿ç•™è“è‰²ç¯å¢ƒä½œä¸ºå›æ»šå¤‡ä»½
```

### 2. å›æ»šæµç¨‹

```bash
# å¦‚æœå‘ç°é—®é¢˜ï¼Œç«‹å³å›æ»š
# 1. åˆ‡æ¢æµé‡å›è“è‰²ç¯å¢ƒ
sudo nginx -s reload

# 2. åœæ­¢ç»¿è‰²ç¯å¢ƒ
docker-compose -f docker-compose.green.yml down

# 3. åˆ†æé—®é¢˜
docker-compose -f docker-compose.green.yml logs > rollback_analysis.log
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### 1. å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| æ•°æ®åº“è¿æ¥å¤±è´¥ | å¯†ç é”™è¯¯/ç½‘ç»œä¸é€š | æ£€æŸ¥ DATABASE_URL å’Œç½‘ç»œ |
| Redis è¿æ¥å¤±è´¥ | Redis æœªå¯åŠ¨ | `systemctl start redis` |
| gRPC è¶…æ—¶ | Python æœåŠ¡å´©æºƒ | æ£€æŸ¥æ—¥å¿—ï¼Œé‡å¯æœåŠ¡ |
| ç†”æ–­å™¨å¼€å¯ | å¤±è´¥ç‡è¿‡é«˜ | æ£€æŸ¥ä¸‹æ¸¸æœåŠ¡ï¼Œç­‰å¾…è‡ªåŠ¨æ¢å¤ |
| é«˜å†…å­˜ä½¿ç”¨ | å†…å­˜æ³„æ¼ | é‡å¯æœåŠ¡ï¼Œæ£€æŸ¥ä»£ç  |

### 2. æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
journalctl -u sparkle-grpc -n 100 | grep ERROR

# å®æ—¶ç›‘æ§
tail -f /var/log/sparkle/app.log | jq .

# æ€§èƒ½åˆ†æ
python -m cProfile -o profile.stats grpc_server.py
```

---

## ğŸ“ è¿ç»´è”ç³»

- **ç´§æ€¥æ”¯æŒ**: ops@your-domain.com
- **æŠ€æœ¯æ–‡æ¡£**: https://docs.your-domain.com
- **ç›‘æ§é¢æ¿**: https://grafana.your-domain.com
- **æ—¥å¿—ç³»ç»Ÿ**: https://logs.your-domain.com

---

## ğŸ“ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ | ä½œè€… |
|------|------|------|------|
| 1.0 | 2025-12-27 | åˆå§‹ç”Ÿäº§éƒ¨ç½²æŒ‡å— | Claude Code |
