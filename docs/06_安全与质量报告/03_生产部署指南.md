# Sparkle ç”Ÿäº§éƒ¨ç½²æŒ‡å—

> **ç‰ˆæœ¬**: v1.1.0
> **æ¶æ„**: æ··åˆå¾®æœåŠ¡ (Flutter + Go Gateway + Python Engine)
> **æœ€åæ›´æ–°**: 2026-01-10

---

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### âœ… éƒ¨ç½²å‰æ£€æŸ¥

- [ ] **åŸºç¡€è®¾æ–½**: PostgreSQL (å¸¦ pgvector), Redis, MinIO/S3 å·²å°±ç»ª
- [ ] **ä»£ç ç‰ˆæœ¬**: ç¡®ä¿ Go Gateway å’Œ Python Engine ä»£ç ç‰ˆæœ¬ä¸€è‡´
- [ ] **æ•°æ®åº“**: Schema å·²åŒæ­¥ (`make sync-db`)ï¼Œå‘é‡ç´¢å¼•å·²åˆ›å»º
- [ ] **å¯†é’¥**: `JWT_SECRET` å’Œ `INTERNAL_API_KEY` å·²ç”Ÿæˆä¸”ä¸€è‡´
- [ ] **ç½‘ç»œ**: åŸŸå SSL è¯ä¹¦å·²é…ç½®ï¼Œé˜²ç«å¢™ç«¯å£å·²å¼€æ”¾ (443, 80)

---

## ğŸ”§ ç¯å¢ƒé…ç½®

### 1. æ ¸å¿ƒç¯å¢ƒå˜é‡ (.env.production)

```bash
# ==================== åŸºç¡€ä¿¡æ¯ ====================
ENVIRONMENT=production
TZ=Asia/Shanghai
LOG_LEVEL=info

# ==================== æ•°æ®åº“ & ç¼“å­˜ ====================
# ä½¿ç”¨è¿æ¥æ± æ¨¡å¼ (PgBouncer) æ¨èç«¯å£ 6432
DATABASE_URL=postgres://sparkle_user:strong_password@db_host:5432/sparkle
REDIS_URL=redis://:redis_password@redis_host:6379/0

# ==================== å†…éƒ¨é€šä¿¡å®‰å…¨ ====================
# ç”¨äº Gateway <-> Python Engine ä¹‹é—´çš„äº’ä¿¡
INTERNAL_API_KEY=sk_internal_super_secure_random_key_min_32_chars

# ==================== Python AI Engine ====================
PORT=8000
GRPC_PORT=50051
OPENAI_API_KEY=sk-xxx
# Celery Broker/Backend (é€šå¸¸å¤ç”¨ Redis)
CELERY_BROKER_URL=redis://:redis_password@redis_host:6379/1
CELERY_RESULT_BACKEND=redis://:redis_password@redis_host:6379/2

# ==================== Go Gateway ====================
GATEWAY_PORT=8080
JWT_SECRET=jwt_secret_key_min_32_chars_random
# å…è®¸çš„ WebSocket æ¥æº (é˜²è·¨ç«™åŠ«æŒ)
ALLOWED_ORIGINS=https://app.sparkle.com,https://admin.sparkle.com
# ä»£ç†æŒ‡å‘ Python Engine
AGENT_ADDRESS=python_engine_host:50051
BACKEND_URL=http://python_engine_host:8000

# ==================== æ–‡ä»¶å­˜å‚¨ (MinIO/S3) ====================
MINIO_ENDPOINT=s3.amazonaws.com
MINIO_ACCESS_KEY=your_access_key
MINIO_SECRET_KEY=your_secret_key
MINIO_BUCKET=sparkle-prod
MINIO_USE_SSL=true
```

---

## ğŸ³ Docker Swarm / Compose éƒ¨ç½²

### 1. docker-compose.prod.yml

```yaml
version: '3.8'

services:
  # 1. åŸºç¡€è®¾æ–½ (è‹¥ä½¿ç”¨äº‘æœåŠ¡å¯ç§»é™¤)
  db:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: sparkle_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: sparkle
    volumes:
      - pg_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 4G

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data

  # 2. Python AI Engine (Core Logic)
  ai_engine:
    image: sparkle/ai-engine:latest
    build: 
      context: ./backend
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
    depends_on:
      - db
      - redis

  # 3. Go Gateway (High Concurrency Entry)
  gateway:
    image: sparkle/gateway:latest
    build:
      context: ./backend/gateway
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
      - AGENT_ADDRESS=ai_engine:50051
      - BACKEND_URL=http://ai_engine:8000
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    ports:
      - "8080:8080"
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    depends_on:
      - ai_engine

  # 4. Celery Workers (Async Tasks)
  celery_worker:
    image: sparkle/ai-engine:latest
    command: celery -A app.core.celery_app worker -l info -c 4
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - INTERNAL_API_KEY=${INTERNAL_API_KEY}
    deploy:
      replicas: 2

  celery_beat:
    image: sparkle/ai-engine:latest
    command: celery -A app.core.celery_app beat -l info
    deploy:
      replicas: 1

volumes:
  pg_data:
  redis_data:
```

### 2. éƒ¨ç½²æ“ä½œ

```bash
# 1. æ„å»ºé•œåƒ
docker compose -f docker-compose.prod.yml build

# 2. å¯åŠ¨æœåŠ¡
docker compose -f docker-compose.prod.yml up -d

# 3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
docker compose -f docker-compose.prod.yml exec ai_engine alembic upgrade head
```

---

## ğŸ”„ è“ç»¿å‘å¸ƒä¸è¿æ¥æ’ç©º (Compose)

### 1. è“ç»¿åˆ‡æµåŸåˆ™

- **å…ˆç»¿ååˆ‡**: å…ˆå¯åŠ¨æ–°é¢œè‰²å¹¶å®Œæˆå¥åº·æ£€æŸ¥ä¸ smokeï¼Œå†åˆ‡æµ
- **è¿æ¥æ’ç©º**: åˆ‡æµåæ—§é¢œè‰²åªâ€œæ‹’æ–°ä¸è¸¢æ—§â€ï¼Œä¿ç•™ 30â€“120s é€€åœºçª—å£
- **çŠ¶æ€å¤–ç½®**: WebSocket/æµå¼ä¼šè¯çŠ¶æ€å¿…é¡»åœ¨ Redis/DB ä¸­ï¼ŒGateway ä¿æŒæ— çŠ¶æ€

### 2. æ¨èæµç¨‹ï¼ˆè„šæœ¬åŒ–ï¼‰

```bash
# å¿…éœ€ç¯å¢ƒå˜é‡
export IMAGE_TAG=sha-<commit>
export GATEWAY_IMAGE=ghcr.io/<org>/sparkle-gateway
export BACKEND_IMAGE=ghcr.io/<org>/sparkle-backend

# å¯é€‰å‚æ•°
export DRAIN_SECONDS=90
export OBSERVE_SECONDS=180
export SMOKE_URLS="/api/v1/health"

./scripts/deploy-prod.sh
```

### 3. åŠ¨æ€åˆ‡æµæœºåˆ¶

- `nginx/upstream.conf` ç”±è„šæœ¬ç”Ÿæˆï¼Œåˆ‡æµé€šè¿‡ `nginx -s reload` ç”Ÿæ•ˆ
- åˆ‡æµåä¿ç•™æ—§é¢œè‰²è¿è¡Œè‡³æ’ç©ºçª—å£ç»“æŸï¼Œå†åœæ­¢æ—§å®¹å™¨

### 4. WebSocket/æµå¼è¯·æ±‚æ³¨æ„äº‹é¡¹

- **åˆ‡æµæœŸé—´æ—§è¿æ¥å¯æŒç»­**ï¼Œæ–°è¿æ¥ç»Ÿä¸€è¿›å…¥æ–°é¢œè‰²
- ä¸å»ºè®®åœ¨åˆ‡æµä¸­é‡å¯ Nginx å®¹å™¨ï¼Œä½¿ç”¨ `reload` ä¿æŒè¿æ¥ç¨³å®š

---

## ğŸ§¾ æ•°æ®åº“è¿ç§»å¥‘çº¦ (Migration Contract)

æ¯ä¸ªæ–° Alembic è¿ç§»å¿…é¡»åŒ…å«å¥‘çº¦å—ï¼Œç”¨äºå®¡æ ¸ä¸å›æ»šå†³ç­–ï¼š

```python
# Migration Contract:
#   type: reversible|forward_only|destructive
#   rollback_plan: "alembic downgrade -1" | "forward_fix_only"
#   verification_query: "SELECT 1;"
#   backfill_plan: "n/a"
#   owner: "team-name"
#   ticket: "n/a"
```

### ç±»å‹è¯´æ˜

- **reversible**: å¯å®‰å…¨å›æ»šï¼Œå¿…é¡»æä¾› `rollback_plan`
- **forward_only**: åªèƒ½å‰å‘ä¿®å¤ï¼Œå¿…é¡»å†™æ˜ `rollback_plan` è¯´æ˜
- **destructive**: ç ´åæ€§å˜æ›´ï¼Œå¿…é¡»é™„å¸¦ `rollback_plan` ä¸ `verification_query`

### CI æ ¡éªŒ

PR ä¸­å˜æ›´çš„ migration æ–‡ä»¶ä¼šè§¦å‘å¥‘çº¦æ ¡éªŒï¼Œç¼ºå¤±ä¼šç›´æ¥å¤±è´¥ã€‚

---

## ğŸ›¡ï¸ å®‰å…¨åŠ å›º (Security Hardening)

### 1. å†…éƒ¨ API é‰´æƒ (P0)

Go Gateway å’Œ Python Engine ä¹‹é—´çš„ REST API è°ƒç”¨å¿…é¡»æºå¸¦ `X-Internal-API-Key` å¤´ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç»•è¿‡ç½‘å…³ç›´æ¥æ”»å‡» Python æœåŠ¡ï¼ˆè™½ç„¶åœ¨ Docker ç½‘ç»œå†…éƒ¨ï¼Œä½†è¿™æ˜¯çºµæ·±é˜²å¾¡çš„ä¸€ç¯ï¼‰ã€‚

**éªŒè¯**:
ç¡®ä¿ `.env.production` ä¸­ `INTERNAL_API_KEY` è®¾ç½®ä¸ºå¼ºéšæœºå­—ç¬¦ä¸²ã€‚

### 2. WebSocket æ¥æºæ£€æŸ¥ (P1)

Go Gateway ä¼šæ ¡éªŒ HTTP Header ä¸­çš„ `Origin`ã€‚
åœ¨ `.env.production` ä¸­é…ç½® `ALLOWED_ORIGINS`:

```bash
ALLOWED_ORIGINS=https://sparkle.your-domain.com
```

### 3. gRPC TLS (å¯é€‰ä½†æ¨è)

å¦‚æœ Gateway å’Œ Engine è·¨ä¸»æœºéƒ¨ç½²ï¼Œå¿…é¡»å¯ç”¨ gRPC TLSã€‚

```bash
AGENT_TLS_ENABLED=true
AGENT_TLS_CA_CERT=/etc/certs/ca.pem
```

---

## ğŸ“Š è¿ç»´ç›‘æ§ (Ops)

### 1. å…³é”®æŒ‡æ ‡ (Prometheus)

-   **Gateway**:
    -   `websocket_connections_active`: å½“å‰åœ¨çº¿è¿æ¥æ•°
    -   `http_request_duration_seconds`: API å»¶è¿Ÿ
-   **AI Engine**:
    -   `grpc_server_handled_total`: gRPC è°ƒç”¨æ¬¡æ•°
    -   `celery_task_latency`: å¼‚æ­¥ä»»åŠ¡æ’é˜Ÿå»¶è¿Ÿ

### 2. æ—¥å¿—åˆ†æ (Loki/ELK)

å…³æ³¨ä»¥ä¸‹å…³é”®å­—:
-   `level=error`
-   `panic`
-   `connection refused`
-   `CircuitBreakerOpen` (ç†”æ–­å™¨å¼€å¯)

---

## ğŸ”„ å¤‡ä»½ä¸æ¢å¤

### 1. æ•°æ®åº“å¤‡ä»½

ä½¿ç”¨ `pg_dump` æ¯å¤©å¤‡ä»½ï¼š

```bash
docker exec -t sparkle_db pg_dump -U postgres sparkle | gzip > /backups/sparkle_$(date +%Y%m%d).sql.gz
```

### 2. æ¢å¤

```bash
gunzip < /backups/sparkle_20260110.sql.gz | docker exec -i sparkle_db psql -U postgres sparkle
```

---

## ğŸš¨ ç´§æ€¥å›æ»š

å¦‚æœæ–°ç‰ˆæœ¬éƒ¨ç½²å¤±è´¥ï¼š

1.  **ä¿®æ”¹ Image Tag**: åœ¨ `docker-compose.prod.yml` ä¸­æ”¹å›ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬ tagã€‚
2.  **é‡å¯æœåŠ¡**: `docker compose up -d`
3.  **æ•°æ®åº“å›æ»š** (å¦‚æœæ¶‰åŠ):
    ```bash
    docker exec -it ai_engine alembic downgrade -1
    ```

---

*æ–‡æ¡£ç»´æŠ¤è€…: DevOps Team*
